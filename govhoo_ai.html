<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#000000">
  <meta name="color-scheme" content="dark">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 rx=%2220%22 fill=%22%23000000%22/><text y=%2250%%22 x=%2250%%22 font-size=%2265%22 font-family=%22'JetBrains Mono', monospace%22 font-weight=%22700%22 fill=%22%23426a5a%22 text-anchor=%22middle%22 dominant-baseline=%22central%22>>_</text></svg>">
  <title>Govhoo - Federal Awards Visualization</title>
  <meta name="title" content="Govhoo - Federal Awards Visualization">
  <meta name="description" content="Free Federal Sales Intelligence Strategic Planning. Follow the money with live USASpending data analysis.">
  <meta name="keywords" content="federal sales, usaspending search, government contracts, defense contracts, federal jobs, expiring contracts, federal territory planning, incumbent search">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://govhoo.com/">
  <meta property="og:title" content="Govhoo | Follow the Money">
  <meta property="og:description" content="Federal contract intelligence with live USASpending data.">
  <meta property="og:image" content="https://govhoo.com/social.png">
  <meta property="twitter:card" content="summary_large_image">
  <meta property="twitter:title" content="Govhoo | Federal Awards Visualization">
  <meta property="twitter:description" content="Federal contract intelligence with live USASpending data.">
  <link rel="canonical" href="https://govhoo.com/">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://kit.fontawesome.com/8ef6ca8a5d.js" crossorigin="anonymous"></script>
  <link rel="preconnect" href="https://api.usaspending.gov">
  <link rel="dns-prefetch" href="https://api.usaspending.gov">
  <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js" as="script">
  <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/d3-sankey/0.12.3/d3-sankey.min.js" as="script">
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-T343V4RFHV"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-T343V4RFHV');
  </script>
<style>
:root {
  /* SURFACES - Warm, Deep Charcoal (Less "Electronic", more "Ink") */
  --bg-app: #0E1111;      /* Deepest Black-Green */
  --bg-card: #1C2320;     /* Lifted from #161B18 — visible against page bg */
  --bg-input: #1E2724;
  --bg-elevated: #232D29;

  /* TEXT - Softened contrast to reduce eye strain */
  --text-primary: #E8E6E1; /* Parchment White (Not harsh #FFF) */
  --text-muted: #A3B2AC;   /* Lifted from #8F9E98 — readable in daylight */
  --text-subtle: #5A6660;  /* Deep Graphite */
  --link: #7DAF9C;         /* Muted Teal link color */

  /* ACCENT - "Antique Fern" */
  --accent: #4A7A67;       
  --accent-dark: #365C4C;
  --accent-light: #7DAF9C; 
  --accent-dim: rgba(74, 122, 103, 0.15);

  /* FUNCTIONAL COLORS - The key to "Relaxing" */
  --success: #78A890; /* Sage instead of Green */
  --warning: #D1Bfa7; /* Sand instead of Yellow */
  --danger: #B87E7E;  /* Faded Rose instead of Red */
  --info: #7E9CB8;    /* Steel Blue instead of Blue */

  /* BORDERS */
  --border: rgba(143, 158, 152, 0.22);
  --border-hover: rgba(143, 158, 152, 0.35);
  
  /* SIZING */
  --safe-top: env(safe-area-inset-top, 20px);
  --safe-bottom: env(safe-area-inset-bottom, 20px);
}
/* =========================================
   2. GLOBAL RESET & SCROLLBAR
   ========================================= */
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

body {
  margin: 0; padding: 0;
  font-family: 'JetBrains Mono', monospace;
  background: var(--bg-app);
  color: var(--text-primary);
  min-height: 100vh;
  overflow-x: hidden;
  width: 100%;
}

/* Custom Scrollbar - Muted Slate Thumb */
::-webkit-scrollbar { width: 6px; height: 6px; }
/* =========================================
   3. GLOBAL UTILITIES & ANIMATIONS
   ========================================= */
.view-section { display: none; }
.view-section.active { display: block; animation: fadeIn 0.5s ease; }

.loader {
  position: fixed; inset: 0; z-index: 300;
  background: rgba(14, 18, 17, 0.95);
  display: none; flex-direction: column; align-items: center; justify-content: center;
}

.spinner {
  width: 40px; height: 40px;
  border: 2px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin { to { transform: rotate(360deg); } }
@keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
@keyframes panelSlideUp { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
@keyframes subtlePulse { 
  0%, 100% { box-shadow: 0 0 0 0 rgba(66, 106, 90, 0); }
  50% { box-shadow: 0 0 0 4px rgba(66, 106, 90, 0.08); }
}

/* Stagger Animations for Intelligence Panels */

/* Text Truncation Helpers */
.buyer-name, .vendor-name, .geo-state-name {
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 180px;
}

/* =========================================
   4. INPUTS & BUTTONS (UNIFIED SYSTEM)
   ========================================= */
.main-input, .mini-search, .modal-select, select, textarea {
  width: 100%;
  background: var(--bg-input) !important;
  border: 1px solid var(--border) !important;
  color: #F1EEE9 !important;
  padding: 1.25rem 1rem;
  font-size: 1.1rem;
  border-radius: 4px;
  font-family: 'JetBrains Mono', monospace;
  transition: border-color 0.2s;
  -webkit-appearance: none;
}

.main-input:focus, .mini-search:focus {
  outline: none; 
  border-color: var(--accent) !important; 
  background: #222; 
}

.btn-row { display: flex; gap: 0.75rem; margin-top: 1rem; }

/* PRIMARY ACTIONS (Solid Fern) */
#searchBtn {
  flex: 1;
  padding: 1rem;
  font-weight: 700;
  border: 1px solid var(--accent) !important;
  background: var(--accent) !important;
  color: #F1EEE9 !important;
  border-radius: 4px;
  font-size: 0.9rem;
  cursor: pointer;
  text-transform: uppercase;
  letter-spacing: 1px;
  display: flex; align-items: center; justify-content: center; gap: 0.5rem;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2) !important;
  transition: all 0.2s ease;
  font-family: 'JetBrains Mono', monospace;
}

.btn-primary:hover:hover, #searchBtn:hover {
  background: var(--accent-dark) !important;
  border-color: var(--accent-dark) !important;
  transform: translateY(-1px);
  opacity: 1;
}

/* SECONDARY ACTIONS (Transparent Chalk Outline) */
.btn-secondary, .btn-secondary:hover {
  background: rgba(251, 247, 245, 0.08) !important;
  border-color: var(--text-primary) !important;
  color: #F1EEE9 !important;
  opacity: 1;
}
/* Update this block to include the new class */

.action-btn {
  background: var(--bg-input); color: var(--accent);
  text-decoration: none; padding: 0.5rem 1rem;
  border-radius: 4px; font-size: 0.8rem; font-weight: 600;
  border: 1px solid var(--border); display: flex; align-items: center; gap: 6px;
}
.action-btn:hover { border-color: var(--accent); background: var(--accent-dim); }

.input-clear {
  position: absolute; 
  right: 12px; 
  top: 50%; 
  transform: translateY(-50%); /* This pulls it up to the true center */
  background: none; 
  border: none; 
  color: var(--text-muted);
  font-size: 1.25rem; 
  cursor: pointer; 
  display: none; 
  padding: 4px 8px; 
  z-index: 215;
  line-height: 1; /* Keeps the character itself from shifting */
  display: flex;
  align-items: center;
  justify-content: center;
}

.input-clear:hover { 
  color: var(--accent) !important;
  opacity: 1;
  transform: translateY(-50%) scale(1.1); /* Keeps it centered while giving a tiny 'pop' */
  transition: all 0.15s ease;
}
.input-clear.visible { 
  display: flex; /* Changed from block to flex to support centering */
}

/* =========================================
   5. HERO VIEW
   ========================================= */
.hero-view {
  position: fixed; inset: 0; z-index: 200;
  display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
  padding: 2rem; padding-top: max(8vh, var(--safe-top));
  transition: transform 0.5s cubic-bezier(0.16, 1, 0.3, 1);
  overflow-y: auto;
}
.hero-view.slide-up { transform: translateY(-100%); }
.hero-view.hidden { display: none; }

.terminal-logo {
  font-family: 'JetBrains Mono', monospace;
  font-size: 2.5rem; font-weight: 700; margin-bottom: 0.5rem;
  color: #F1EEE9; letter-spacing: -1px; text-align: center;
}
.terminal-logo span { color: var(--accent-light); }

.hero-subtitle {
  margin-bottom: 2rem; text-align: center;
  font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; color: var(--text-muted);
}
.search-box-container { position: relative; z-index: 210; width: 100%; max-width: 500px; margin-top: 1.5rem; }

/* =========================================
   6. AUTOCOMPLETE
   ========================================= */
.autocomplete-wrapper { position: relative; }
.autocomplete-dropdown {
  position: absolute; top: 100%; left: 0; right: 0; z-index: 220;
  background: var(--bg-card); border: 1px solid var(--border);
  border-top: none; border-radius: 0 0 4px 4px;
  max-height: 320px; overflow-y: auto; display: none;
}
.autocomplete-dropdown.active { display: block; }
.autocomplete-section { padding: 0.5rem 0; border-bottom: 1px solid var(--border); }
.autocomplete-section:last-child { border-bottom: none; }
.autocomplete-section-label {
  padding: 0.25rem 1rem; font-size: 0.65rem; color: var(--text-muted);
  text-transform: uppercase; letter-spacing: 1px; font-family: 'JetBrains Mono', monospace;
}
.autocomplete-item {
  padding: 0.6rem 1rem; cursor: pointer; display: flex; align-items: center; gap: 0.75rem;
  font-size: 0.9rem; color: var(--text-primary); transition: background 0.1s;
}
.autocomplete-item:hover, .autocomplete-item.selected { background: rgba(255, 255, 255, 0.05); }
.autocomplete-item i { color: var(--text-muted); width: 16px; text-align: center; font-size: 0.8rem; }
.autocomplete-item-text { flex: 1; min-width: 0; }
.autocomplete-item-main { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.autocomplete-item-sub { font-size: 0.7rem; color: var(--text-muted); margin-top: 2px; }
.autocomplete-empty { padding: 1rem; text-align: center; color: var(--text-muted); font-size: 0.85rem; }

/* =========================================
   7. APP HEADER
   ========================================= */
.app-header {
  position: sticky; top: 0; z-index: 100;
  background: rgba(14, 18, 17, 0.95); backdrop-filter: blur(10px);
  padding: 0.6rem 1rem; padding-top: max(0.6rem, var(--safe-top));
  border-bottom: 1px solid var(--border);
  display: flex; justify-content: space-between; align-items: center; gap: 0.75rem; overflow: hidden;
}
.header-left { display: flex; align-items: center; gap: 0.75rem; flex: 1; min-width: 0; }
.logo-btn { font-family: 'JetBrains Mono'; font-weight: 700; font-size: 1.1rem; color: #F1EEE9; cursor: pointer; flex-shrink: 0; padding: 0.25rem; }
.logo-btn:hover { color: var(--accent); }
.logo-btn span { color: var(--accent); }

.mini-search {
  background: var(--bg-input); border: 1px solid var(--border); color: #F1EEE9;
  padding: 0.5rem 1rem; border-radius: 4px; font-size: 0.9rem; flex: 1; min-width: 0; width: 100%;
}
.mini-search-wrapper { flex: 1; min-width: 0; overflow: hidden; }
.header-actions { display: flex; gap: 0.4rem; flex-shrink: 0; align-items: center; }
/* Base icon button — same behavior, neutral ink */
.icon-btn {
  background: var(--accent);
  border: none;
  color: #F1EEE9;

  width: 34px;
  height: 34px;
  border-radius: 50%;

  display: flex;
  align-items: center;
  justify-content: center;

  cursor: pointer;
  font-size: 14px;
  font-family: 'JetBrains Mono', monospace;

  transition: opacity 0.15s ease, transform 0.15s ease;
}

.icon-btn:hover {
  opacity: 0.82;
  transform: scale(1.08);
  color: #F1EEE9;
}

.icon-btn.active {
  background: var(--accent-light);
  color: #F1EEE9;
}

/* Share – Spidey Blue (Matte Cyan) */
.icon-btn-share {
  background: #5B7C99 !important; 
}
.icon-btn-share:hover {
  background: #6C8DAA !important; 
  transform: translateY(-1px);
}

/* Details / Slack – Spidey Blue (A/C/E 8th Av) */
.icon-btn-slack {
  background: #5B7C99 !important; 
}
.icon-btn-slack:hover {
  background: #6C8DAA !important;
  transform: translateY(-1px);
}

/* CSV – Fern Green (IRT Lexington) */
.icon-btn-csv {
  background: #466D5C !important; 
}
.icon-btn-csv:hover {
  background: #577E6D !important;
  transform: translateY(-1px);
}

/* =========================================
   8. DASHBOARD LAYOUT & HEADERS
   ========================================= */
.dashboard-container {
  padding: 1rem; padding-bottom: calc(2rem + var(--safe-bottom));
  max-width: 1400px; margin: 0 auto; display: none; width: 100%;
}
.dashboard-container.active { display: block; animation: fadeIn 0.8s forwards; }

.mode-toggle { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; background: var(--bg-card); padding: 0.5rem; border-radius: 4px; border: 1px solid var(--border); }
.mode-btn {
  flex: 1; padding: 0.75rem; background: transparent; border: none;
  color: var(--text-muted); font-family: 'JetBrains Mono'; font-size: 0.85rem;
  cursor: pointer; border-radius: 4px; transition: all 0.2s;
  display: flex; align-items: center; justify-content: center; gap: 0.5rem;
}
.mode-btn.active { background: #839E8E; color: #0a0e0d; font-weight: 700; }
.mode-btn:hover:not(.active) { color: var(--text-primary); }

/* Section Headers */
.section-header {
  display: flex; align-items: center; justify-content: space-between; gap: 0.5rem;
  margin: 2rem 0 1rem 0; border-bottom: 1px solid var(--border);
  padding-bottom: 0.5rem; flex-wrap: wrap;
}
.section-title-group { display: flex; align-items: center; gap: 0.5rem; }
.section-title {
  font-family: 'JetBrains Mono', monospace; font-size: 0.9rem; font-weight: 700 !important;
  color: #F1EEE9 !important; text-transform: uppercase; letter-spacing: 2px;
}
.section-subtitle { font-size: 0.75rem; color: var(--text-primary); opacity: 0.65; font-style: italic; }

/* Subway Route Bullets — MTA-inspired colored circles with FA icons inside */
.sub-bullet {
  display: inline-flex; align-items: center; justify-content: center;
  width: 34px; height: 34px; border-radius: 50%;
  background: var(--accent); color: #F1EEE9;
  font-size: 15px; flex-shrink: 0; line-height: 1;
}
.sub-bullet.sm { width: 34px; height: 34px; font-size: 15px; }
.sub-bullet.lg { width: 34px; height: 34px; font-size: 15px; }
.sub-bullet.xl { width: 34px; height: 34px; font-size: 15px; }
.sub-bullet i { line-height: 1; }

/* =========================================
   9. WIDGETS, CARDS & STATS
   ========================================= */
.stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem; }

.stat-item {
  background: var(--bg-card); padding: 1rem; border-radius: 4px;
  border: 1px solid var(--border) !important; text-align: center;
}
.stat-label { font-size: 0.7rem; color: var(--text-primary); opacity: 0.65; text-transform: uppercase; margin-bottom: 0.5rem; }
.stat-val, #stat-vol, #stat-agencies, #stat-count, #stat-vendors {
  font-size: 1.25rem; font-weight: 700 !important; font-family: 'JetBrains Mono';
  color: #F1EEE9 !important; text-shadow: 0 0 1px rgba(251, 247, 245, 0.2);
}
.stat-sub { font-size: 0.7rem; color: var(--success); margin-top: 4px; }
.stat-sub.neutral { color: var(--text-primary); opacity: 0.65; }
.stat-item-action:hover { background: var(--accent-dim); border-color: var(--accent) !important; }

/* Charts */
.chart-wrapper {
  background: var(--bg-card); border: 1px solid var(--border) !important;
  border-radius: 4px; padding: 1rem; width: 100%; overflow-x: auto; overflow-y: visible;
}
.chart-container { width: 100%; min-height: 500px; height: auto; display: block; }

/* Feed / Deal Cards */
.feed-grid { display: flex; flex-direction: column; gap: 1rem; }
.explainer-highlight {
  background: #466D5C;
  padding: 1px 3px;
  border-radius: 2px;
  font-style: normal;
  color: var(--text-primary);
}
.deal-card {
  background: var(--bg-card); border: 1px solid var(--border) !important;
  border-radius: 4px; padding: 1.25rem; transition: transform 0.1s;
}
.deal-card:active { transform: scale(0.99); }
#feedGrid .deal-card:nth-child(n+4) { opacity: 0.7; }
#feedGrid .deal-card:nth-child(n+4):hover { opacity: 1; }

.deal-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem; }
.deal-agency {
  font-size: 0.75rem; color: var(--text-muted); font-weight: 600;
  text-transform: uppercase; background: rgba(255, 255, 255, 0.05); padding: 2px 6px; border-radius: 4px;
}
.deal-amount {
  font-family: 'JetBrains Mono', monospace; color: #F1EEE9 !important;
  font-weight: 700; font-size: 1rem;
}
.deal-desc { font-size: 1rem; font-weight: 600; margin-bottom: 0.5rem; line-height: 1.4; color: white; }
.deal-vendor { font-size: 0.85rem; color: var(--info); margin-bottom: 0.75rem; font-family: 'JetBrains Mono', monospace; }
.deal-meta { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem; }
.deal-footer { display: flex; justify-content: space-between; align-items: center; padding-top: 1rem; border-top: 1px solid #222; }
.deal-date { font-size: 0.75rem; color: var(--text-primary); opacity: 0.65; }

/* Tags & Badges */
.meta-tag {
  font-size: 0.65rem; font-family: 'JetBrains Mono', monospace; padding: 3px 8px;
  border-radius: 3px; background: rgba(251, 247, 245, 0.05) !important;
  color: var(--text-muted) !important; border: 1px solid var(--border) !important;
}
.meta-tag.psc { background: rgba(143, 182, 208, 0.15); border-color: rgba(143, 182, 208, 0.3); color: #8FB6D0; }
.meta-tag.naics { background: rgba(180, 143, 208, 0.15); border-color: rgba(180, 143, 208, 0.3); color: #B48FD0; }
.meta-tag.mission-gap { font-weight: 600; }
.meta-tag.mission-gap.high { background: rgba(251, 128, 114, 0.15); border-color: var(--danger) !important; color: var(--danger) !important; }
.meta-tag.mission-gap.medium { background: rgba(253, 216, 53, 0.15); border-color: var(--warning) !important; color: var(--warning) !important; }
.meta-tag.mission-gap.low { background: rgba(255, 255, 255, 0.05); border-color: var(--border); color: var(--text-muted); }

.time-badge { font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; color: var(--text-muted); border: 1px solid var(--border); padding: 4px 8px; border-radius: 4px; }
/* Mission Gap Controls */
.mission-gap-signals { font-size: 0.7rem; color: var(--text-muted); margin-top: 6px; font-style: italic; }
.mission-gap-filter { display: flex; align-items: center; gap: 0.5rem; }
.mission-gap-toggle {
  display: inline-flex; align-items: center; justify-content: center; gap: 0.4rem;
  padding: 0 12px; height: 34px; min-width: 34px;
  background: #E07A5F !important; border: none !important; border-radius: 34px;
  font-size: 0.7rem; font-family: 'JetBrains Mono', monospace; color: #F1EEE9 !important;
  font-weight: 700; cursor: pointer; transition: opacity 0.15s, transform 0.15s;
  white-space: nowrap;
}
.mission-gap-toggle:hover { opacity: 0.82; transform: scale(1.04); color: #F1EEE9 !important; }
.mission-gap-toggle.active { background: #A7A9AC !important; color: #F1EEE9 !important; opacity: 1; }
.mission-gap-toggle i { font-size: 0.65rem; color: #F1EEE9 !important; }

/* Buyers List */
.buyer-list { display: flex; flex-direction: column; gap: 0; width: 100%; }
.buyer-item {
  display: flex; align-items: center; gap: 0.85rem; padding: 0.75rem 0;
  border-bottom: 1px solid rgba(255, 255, 255, 0.05); width: 100%;
}
.buyer-item:last-child { border-bottom: none; }
.buyer-rank {
  width: 34px; height: 34px; background: var(--accent) !important;
  color: #F1EEE9 !important; border-radius: 50%; display: flex; align-items: center;
  justify-content: center; font-family: 'JetBrains Mono', monospace;
  font-size: 15px !important; font-weight: 700; flex-shrink: 0; border: none !important;
}
.buyer-info { flex: 1; min-width: 0; }
.buyer-name { font-size: 0.95rem; color: var(--text-primary); font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.buyer-stats { font-size: 0.7rem; color: var(--text-muted); margin-top: 2px; }
.buyer-amount { text-align: right; flex-shrink: 0; }
.buyer-spend {
  font-family: 'JetBrains Mono', monospace; font-size: 1.15rem; font-weight: 700;
  color: #F1EEE9 !important; white-space: nowrap; line-height: 1.2;
}
.trend-pill {
  padding: 2px 6px; border-radius: 2px; font-size: 0.7rem; font-weight: 700;
  white-space: nowrap; display: inline-flex; align-items: center; gap: 2px;
}
.trend-up { color: var(--success); background: rgba(66, 106, 90, 0.1); }
.trend-down { color: var(--danger); background: rgba(251, 128, 114, 0.1); }

/* Methodology */
.methodology-card {
  background: var(--bg-card); border: 1px solid var(--border) !important;
  border-radius: 4px; padding: 1.5rem; display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem;
}
.method-item { padding-bottom: 1rem; border-bottom: 1px solid var(--border); }
.method-item:nth-last-child(-n+2) { border-bottom: none; padding-bottom: 0; }
.method-title {
  font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; font-weight: 700;
  color: var(--accent); margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;
}
.method-title i { font-size: 0.75rem; opacity: 0.7; }
.method-desc { font-size: 0.8rem; color: var(--text-muted); line-height: 1.5; }
.method-desc code {
  background: rgba(255, 255, 255, 0.1); padding: 2px 6px; border-radius: 3px;
  font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; color: var(--text-primary);
}
.method-desc strong { color: var(--text-primary); }

.geo-states-grid {
  display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 0.5rem;
  max-height: 300px; overflow-y: auto; width: 100%;
}
.geo-state-item {
  display: flex; align-items: center; justify-content: space-between; gap: 0.5rem;
  padding: 0.5rem 0.75rem; background: rgba(255, 255, 255, 0.02); border-radius: 4px; font-size: 0.8rem;
}
.geo-state-name {
  color: var(--text-primary); font-weight: 600; font-size: 0.85rem;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1; min-width: 0;
}
.geo-state-amount { color: var(--accent); font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; font-weight: 700; flex-shrink: 0; }

/* Analysis Panel */
/* Subagency & Drill Down */
.drill-breadcrumb {
  display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1rem;
  background: var(--accent-dim); border: 1px solid var(--border);
  border-radius: 4px; margin-bottom: 1rem; font-family: 'JetBrains Mono', monospace;
  font-size: 0.8rem; overflow-x: auto; white-space: nowrap;
}
.breadcrumb-item.active {
  background: var(--accent-dim); color: var(--accent);
  border: 1px solid var(--accent); cursor: default;
}
.breadcrumb-separator { color: var(--text-subtle); font-size: 0.8rem; font-weight: 700; }
.breadcrumb-icon { font-size: 0.75rem; }
.drill-hint {
  display: flex; align-items: center; justify-content: center; gap: 0.5rem;
  padding: 0.5rem; background: rgba(212, 196, 168, 0.05); border: 1px dashed var(--border);
  border-radius: 4px; margin-top: 0.5rem; font-size: 0.75rem; color: var(--text-muted);
}
.drill-hint i { color: var(--accent); }

.subagency-panel {
  background: var(--bg-card); border: 1px solid var(--border) !important;
  border-radius: 4px; margin-top: 1.5rem; overflow: hidden;
}
.subagency-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 1rem; background: var(--accent-dim); border-bottom: 1px solid var(--border);
}
.subagency-header-left { display: flex; align-items: center; gap: 0.75rem; }
.subagency-header-icon {
  width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;
  background: var(--accent-dim); border: 1px solid var(--accent); border-radius: 4px; color: var(--accent);
}
.subagency-header-text h3 { margin: 0; font-family: 'JetBrains Mono', monospace; font-size: 0.9rem; color: var(--text-primary); font-weight: 600; }
.subagency-header-text span { font-size: 0.75rem; color: var(--text-muted); }
.subagency-stats { display: flex; gap: 1.5rem; font-family: 'JetBrains Mono', monospace; }
.subagency-stat { text-align: right; }
.subagency-stat-val { font-size: 1rem; font-weight: 700; color: var(--accent); }
.subagency-stat-label { font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase; }

.subagency-list { max-height: 400px; overflow-y: auto; }
.subagency-item {
  display: flex; align-items: center; justify-content: space-between;
  padding: 1rem; border-bottom: 1px solid var(--border); cursor: pointer; transition: all 0.15s;
}
.subagency-item:hover { background: rgba(255, 255, 255, 0.02); }
.subagency-item:last-child { border-bottom: none; }
.subagency-item-left { display: flex; align-items: center; gap: 1rem; flex: 1; min-width: 0; }
.subagency-rank {
  width: 34px; height: 34px; display: flex; align-items: center; justify-content: center;
  background: var(--accent) !important; color: #F1EEE9 !important; border-radius: 50%;
  font-family: 'JetBrains Mono', monospace; font-size: 15px !important; font-weight: 700; flex-shrink: 0; border: none !important;
}
.subagency-info { flex: 1; min-width: 0; }
.subagency-name { font-size: 0.95rem; color: var(--text-primary); font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.subagency-contracts { font-size: 0.75rem; color: var(--text-muted); margin-top: 2px; }
.subagency-item-right { display: flex; align-items: center; gap: 1rem; flex-shrink: 0; }
.subagency-bar-container { width: 120px; height: 8px; background: rgba(255, 255, 255, 0.05); border-radius: 4px; overflow: hidden; }
.subagency-bar { height: 100%; background: var(--accent-dim); border-radius: 4px; transition: width 0.3s ease; }
.subagency-amount {
  font-family: 'JetBrains Mono', monospace; font-size: 1.1rem; font-weight: 700;
  color: #F1EEE9 !important; min-width: 90px; text-align: right;
}
.subagency-drill-icon { color: var(--text-muted); font-size: 0.8rem; opacity: 0; transition: all 0.15s; }
.subagency-item:hover .subagency-drill-icon { opacity: 1; color: var(--accent); transform: translateX(2px); }
.strategic-narrative-card {
  background: var(--bg-card); border-left: 4px solid var(--accent);
  padding: 1.25rem; margin: 1.5rem 0; font-size: 0.9rem; line-height: 1.6;
}

/* Job Intel Panel specific */
#searchJobPanel { overflow: hidden; max-width: 100%; box-sizing: border-box; }
.job-intel-panel {
  background: var(--bg-card); border: 1px solid var(--border) !important;
  border-radius: 6px; padding: 1rem; overflow: hidden;
}

/* Job Links — Spidey Blue for external actions */
.job-link {
  font-size: 0.65rem; color: #5B7C99; text-decoration: none;
  display: inline-flex; align-items: center; gap: 3px; padding: 2px 6px;
  border-radius: 3px; background: rgba(91,124,153,0.1);
  border: 1px solid rgba(91,124,153,0.2); transition: all 0.15s;
}
.job-link:hover {
  background: rgba(91,124,153,0.2); border-color: rgba(91,124,153,0.4); color: #F2E8CF;
}
.job-link i { font-size: 0.6rem; }

/* Shared design system for Prime Reach + Top Agencies panels */
.reach-row {
  display: flex; align-items: flex-start; justify-content: space-between;
  padding: 0.55rem 0.35rem; gap: 0.5rem; cursor: pointer;
  border-bottom: 1px solid rgba(255,255,255,0.07);
  border-radius: 4px; transition: background 0.15s;
}
.reach-row:hover { background: rgba(255,255,255,0.06); }
.reach-row:last-child { border-bottom: none; }
.reach-name {
  font-size: 0.8rem; font-weight: 600; color: var(--text-primary);
  text-decoration: underline; text-decoration-color: rgba(255,255,255,0.15);
  text-underline-offset: 2px;
}
.reach-row:hover .reach-name { text-decoration-color: var(--accent); color: var(--accent); }
.reach-badge {
  font-family: 'JetBrains Mono', monospace; font-size: 0.55rem;
  padding: 0.1rem 0.35rem; background: rgba(119,141,169,0.12);
  color: #778DA9; border-radius: 3px; white-space: nowrap;
}
.reach-badge.accent { background: rgba(74,122,103,0.15); color: var(--accent-light); }
.reach-meta { font-size: 0.6rem; color: var(--text-muted); margin-top: 0.15rem; line-height: 1.4; }
.reach-amount {
  font-family: 'JetBrains Mono', monospace; font-size: 0.8rem;
  font-weight: 600; color: #F2E8CF;
}
.reach-count { font-family: 'JetBrains Mono', monospace; font-size: 0.55rem; color: #778DA9; }
.reach-overflow { font-size: 0.55rem; color: var(--text-muted); text-align: center; margin-top: 0.35rem; }

/* Panel container design system — uniform chunky cards */
.data-panel {
  background: var(--bg-card); border: 1px solid var(--border);
  border-radius: 10px; margin-bottom: 0.75rem; overflow: hidden;
}
.data-panel-header {
  display: flex; align-items: baseline; justify-content: space-between;
  padding: 0.65rem 1rem 0.35rem;
  border-bottom: 1px solid rgba(255,255,255,0.08);
}
.data-panel-title {
  font-family: 'JetBrains Mono', monospace; font-size: 0.6rem;
  color: var(--accent-light); text-transform: uppercase;
  letter-spacing: 1.5px; font-weight: 600;
}
.data-panel-subtitle {
  font-family: 'JetBrains Mono', monospace; font-size: 0.45rem;
  color: var(--text-muted);
}
.data-panel-body { padding: 0.35rem 1rem 0.75rem; }

/* Skills Demand */
.skills-demand {
  margin-top: 1rem; padding: 1rem; background: var(--bg-card);
  border: 1px solid var(--border); border-radius: 4px;
}
.skills-header {
  font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; color: var(--accent);
  text-transform: uppercase; letter-spacing: 1px; margin-bottom: 0.75rem;
  display: flex; align-items: center; gap: 0.5rem;
}
.skill-bar-container { margin-bottom: 0.5rem; }
.skill-bar-label { display: flex; justify-content: space-between; font-size: 0.75rem; margin-bottom: 4px; }
.skill-bar-name { color: var(--text-primary); font-weight: 600; font-size: 0.85rem; }
.skill-bar-pct { color: #F1EEE9 !important; font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; font-weight: 700; }
.skill-bar {
  height: 8px; background: rgba(255, 255, 255, 0.05) !important;
  border-radius: 4px; overflow: hidden; position: relative;
}
.skill-bar-fill {
  height: 100%; background: var(--accent); border-radius: 4px;
  transition: width 0.4s ease-out; min-width: 2px;
}

/* Compact Lists */

/* Intelligence Banner */


/* =========================================
   10. MODALS & OVERLAYS (MONOCHROMATIC GREEN)
   ========================================= */

/* --- Base Modal Container --- */


/* --- Unified Modal Content Card --- */


/* Max Widths */

/* --- Modal Header --- */


/* Force header bullets to green */

/* Close Button (Muted until hover) */


/* --- Modal Body & Footer --- */


.modal-footer-buttons { display: flex; gap: 0.75rem; align-items: center; }
.modal-footer-secondary { display: flex; gap: 0.5rem; }

/* Modal Buttons */

/* Primary = Green */

/* Cancel/Secondary = Muted Glass */
/* --- Vendor List & Toggles --- */
.vendor-list-item {
  display: flex; align-items: center; justify-content: space-between;
  padding: 0.75rem 1rem; 
  border: 1px solid var(--border);
  border-radius: 4px; margin-bottom: 0.5rem; 
  background: rgba(255,255,255,0.01);
  transition: all 0.2s;
}
.vendor-list-item:hover {
  background: rgba(255, 255, 255, 0.03); 
  border-color: var(--accent-light);
}

.toggle-switch {
  position: relative; width: 44px; height: 24px; 
  background: #2a2a2a; /* Dark gray off state */
  border-radius: 12px; cursor: pointer; transition: background 0.3s;
}
.toggle-switch.active { background: var(--accent) !important; } /* Green on state */

.toggle-slider {
  position: absolute; top: 3px; left: 3px; width: 18px; height: 18px;
  background: #F1EEE9; border-radius: 50%; transition: transform 0.3s;
  box-shadow: 0 1px 3px rgba(0,0,0,0.3);
}
.toggle-switch.active .toggle-slider { transform: translateX(20px); }

/* --- CONVERSATION STARTERS (The "Blue" Fix) --- */



/* Convo Toggles - Green Active State */

/* --- PIPELINE BUILDER (The "Yellow" Fix) --- */

/* --- Info/Success Banners --- */
/* Replaces the "Beige" and "Red" boxes */

/* =========================================
   11. FOOTER & MISC
   ========================================= */
.hero-footer { width: 100%; max-width: 1200px; margin: 3rem auto 0 auto; padding-top: 2rem; }
.dashboard-container .hero-footer { margin: 4rem auto 0 auto; padding-bottom: 2rem; animation: fadeIn 1s forwards; }
.dashboard-container .hero-footer .footer-grid { gap: 2rem; }
.footer-grid { display: grid; grid-template-columns: 1fr; gap: 2rem; }
@media (min-width: 768px) {
  .footer-grid { grid-template-columns: 1fr 1fr 1fr; gap: 2rem; }
  .footer-section { border-bottom: none; padding-bottom: 0; }
}
.footer-section { padding-bottom: 1.5rem; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
.footer-section:last-child { border-bottom: none; padding-bottom: 0; }
.footer-label {
  font-family: 'JetBrains Mono', monospace; font-size: 0.65rem; font-weight: 700;
  text-transform: uppercase; letter-spacing: 1px; color: var(--accent); margin-bottom: 0.75rem;
}
.footer-text { overflow: hidden; font-size: 0.8rem; line-height: 1.6; color: var(--text-primary); opacity: 0.65; margin-bottom: 0.75rem; }
.footer-text:last-child { margin-bottom: 0; }
.footer-link {
  font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; color: var(--link);
  text-decoration: none; text-transform: uppercase; letter-spacing: 0.5px;
  font-weight: 700; padding-bottom: 2px; border-bottom: 1px solid var(--accent); transition: opacity 0.2s ease;
}
.footer-link:hover { opacity: 0.7; }
.use-cases { display: flex; flex-direction: column; gap: 1rem; }
.use-case { padding: 0.875rem; background: rgba(255, 255, 255, 0.02); border-left: 2px solid var(--accent); }
.use-case-title {
  font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; font-weight: 700;
  color: var(--text-primary); margin-bottom: 0.375rem; text-transform: uppercase; letter-spacing: 0.5px;
}
.use-case-desc { font-size: 0.75rem; color: var(--text-muted); line-height: 1.5; }
.pro-tip-box {
  font-family: 'JetBrains Mono', monospace; background: rgba(212, 196, 168, 0.08);
  border: 1px solid var(--accent); border-radius: 4px; padding: 0.75rem; margin-top: 1rem;
}
.pro-tip-label {
  font-size: 0.6rem; font-weight: 700; color: var(--accent);
  text-transform: uppercase; letter-spacing: 1px; margin-bottom: 0.5rem;
}
.pro-tip-code {
  font-size: 0.75rem; color: var(--text-primary); background: rgba(0, 0, 0, 0.3);
  padding: 0.375rem 0.5rem; border-radius: 2px; display: inline-block; margin-top: 0.25rem;
}
.tip-bio-img { width: 48px; height: 48px; border-radius: 50%; filter: grayscale(1) contrast(1.1); flex-shrink: 0; float: left; margin-right: 12px; margin-bottom: 4px; }
.disclaimer-text {
  margin-top: 1.5rem; padding: 1rem; font-size: 0.7rem; color: var(--text-muted);
  border-top: 1px solid var(--border); line-height: 1.4; font-style: italic;
}

/* Steps List (Subway Line Bullets) */

.sankey-loaded { animation: subtlePulse 2s ease-in-out 1; }
.modal-step-label {
  font-size: 0.85rem; color: var(--accent); font-weight: 700; margin-bottom: 1rem;
  text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; gap: 0.5rem;
}
.modal-step-section { padding: 1.5rem; border-bottom: 1px solid var(--border); background: rgba(255, 255, 255, 0.02); }
.modal-step-section:last-child { border-bottom: none; }
.modal-form-label { display: block; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.5rem; font-weight: 600; }
.modal-step-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
.modal-body-section { padding: 1.5rem; }
.modal-select { padding: 0.6rem; font-size: 0.9rem; background: var(--bg-app); }
@keyframes modalSlideIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
.modal-animate-in { animation: modalSlideIn 0.3s ease-out forwards; }
.action-bar-label {
  font-family: "JetBrains Mono", monospace; font-size: 0.6rem; font-weight: 700;
  text-transform: uppercase; letter-spacing: 2px; color: var(--accent-light) !important;
  opacity: 0.6; margin-bottom: 0.75rem; width: 100%; display: flex; align-items: center; gap: 0.5rem;
}
.action-bar-label::after { content: ""; flex: 1; height: 1px; background: var(--border); }

/* =========================================
   13. MEDIA QUERIES (RESPONSIVE)
   ========================================= */
@media (max-width: 900px) {
  .chart-wrapper { overflow-x: scroll !important; -webkit-overflow-scrolling: touch; }
}

@media (max-width: 768px) {
  .methodology-card { grid-template-columns: 1fr; }
  .subagency-bar-container { display: none; }
  .subagency-stats { flex-direction: column; gap: 0.5rem; }
  .subagency-stat { text-align: left; }
  .stats-row { grid-template-columns: 1fr !important; gap: 0.75rem !important; }
  .stat-item {
    display: flex !important; justify-content: space-between !important;
    align-items: center !important; padding: 1rem !important; text-align: left !important;
  }
  .stat-label { margin-bottom: 0 !important; }
  .stat-item-action { grid-column: span 1 !important; }
  #forecastModeView div[style*="display: grid"] { grid-template-columns: 1fr !important; gap: 1rem !important; width: 100% !important; overflow: hidden !important; }
  .dashboard-container {
    width: 100% !important; max-width: 100% !important; padding-left: 1rem !important;
    padding-right: 1rem !important; overflow-x: hidden !important;
  }
  .analysis-panel, .analysis-panel-body, .buyer-list { width: 100% !important; max-width: 100% !important; }
  .job-intel-panel > div { grid-template-columns: 1fr !important; }
  .geo-states-grid { grid-template-columns: 1fr !important; }
  .btn-row { flex-direction: column; }
  .chart-container { min-width: auto; width: 100%; }
  .chart-wrapper { padding: 0 !important; border: none !important; }
  .sankey-panel { padding: 0.5rem !important; }
  .reach-row { padding: 0.7rem 0.5rem; } /* Larger touch targets on mobile */
  .reach-name { font-size: 0.75rem; }
  .reach-amount { font-size: 0.75rem; }
  .data-panel { border-radius: 8px; margin-bottom: 0.6rem; }
  .data-panel-header { padding: 0.55rem 0.75rem 0.3rem; }
  .data-panel-title { font-size: 0.55rem; }
  .data-panel-body { padding: 0.25rem 0.75rem 0.6rem; }
}

@media (max-width: 600px) {
  .mode-toggle { flex-direction: column; }
  .app-header { gap: 0.5rem; padding: 0.5rem 0.75rem; }
  .header-left { gap: 0.5rem; }
  .mini-search { max-width: none; padding: 0.5rem 0.6rem; font-size: 0.8rem; }
  .logo-btn { font-size: 0.85rem; }
  .icon-btn { width: 30px; height: 30px; font-size: 12px; }
  .logo-btn { font-size: 0.9rem; }
  .header-actions { gap: 0.35rem; }
  .modal-footer-buttons { flex-direction: column; width: 100%; gap: 0.5rem; }
  .modal-footer-secondary { width: 100%; gap: 0.5rem; }
  .step-grid { grid-template-columns: 1fr !important; }
  .modal-step-grid { grid-template-columns: 1fr !important; }
  .buyer-spend { font-size: 1rem; }
  .buyer-amount { min-width: 75px; }
  .subagency-amount { font-size: 0.95rem; min-width: 70px; }
  .job-links { gap: 4px; }
  .job-link { font-size: 0.6rem; padding: 2px 4px; }
  .buyer-rank { width: 34px; height: 34px; font-size: 15px !important; }
  .subagency-rank { width: 34px; height: 34px; font-size: 15px !important; }
  .sub-bullet, .sub-bullet.sm, .sub-bullet.lg, .sub-bullet.xl { width: 34px; height: 34px; font-size: 15px; }
  .icon-btn { width: 34px; height: 34px; font-size: 15px; }
}
/* FORCE FOOTER STEPS TO JETBRAINS MONO */

/* Ensure the number inside the circle uses JetBrains Mono */

/* Ensure any bold text inside the step is also JetBrains Mono */
/* Sharp Chalk Overrides for Metadata */
.deal-amount, 
  font-family: 'JetBrains Mono', monospace !important;
  color: #F1EEE9 !important; /* Pure Chalk White */
  letter-spacing: -0.5px;
}

.deal-date, 
.mission-gap-signals, 
.vendor-stats {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.65rem !important;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: var(--text-primary) !important;
  opacity: 0.5; /* Dusty Chalk look */
}

/* Refined Open Award Button - Secondary Outline Style */
.deal-footer .action-btn {
  background: transparent !important;
  border: 1px solid rgba(251, 247, 245, 0.3) !important; /* Muted Chalk Outline */
  color: var(--text-primary) !important;
  text-transform: uppercase;
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.65rem !important;
  font-weight: 700;
  letter-spacing: 0.5px;
  padding: 0.5rem 0.75rem;
  transition: all 0.2s ease;
}

.deal-footer .action-btn:hover {
  background: rgba(251, 247, 245, 0.08) !important; /* Subtle Glow */
  border-color: var(--text-primary) !important;
  color: #F1EEE9 !important;
}
/* Tighten up the Search Box Cohesion */
#heroView .search-box-container {
  display: flex;
  flex-direction: column;
  gap: 12px; /* Uniform gap between input and button */
}

#heroView .main-input {
  height: 56px; /* Explicit height to match button heft */
  border-radius: 6px !important; /* Slightly softer corners */
}

#searchBtn {
  height: 56px;
  border-radius: 6px !important;
  font-weight: 800 !important; /* Make it more authoritative */
  letter-spacing: 2px;
}

/* Unified Sankey header surface */
.sankey-header,
.prime-sankey-header,
.subcontract-sankey-header {
  background: var(--bg-card);
  color: var(--text-primary);

  border-bottom: 1px solid var(--border);
  padding: 0.75rem 1rem;

  font-weight: 600;
  letter-spacing: 0.2px;
}
/* =========================================
   Compact drill/breadcrumb bar
   Keeps your current HTML; just tightens it
   ========================================= */

/* Outer bar */
.drill-controls-bar{
  padding: 0.5rem 0.75rem;
  border-radius: 8px;
  background: rgba(255,255,255,0.02);
  border: 1px solid var(--border);
}

/* Breadcrumb container */
.drill-breadcrumb{
  gap: 0.35rem !important;
}

/* Each breadcrumb chip */
.breadcrumb-item{
  padding: 0.25rem 0.5rem;
  border-radius: 6px;
  border: 1px solid var(--border);
  background: transparent;
  color: var(--text-muted);
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.72rem;
  line-height: 1.1;
  display: inline-flex;
  align-items: center;
  gap: 0.35rem;
  cursor: pointer;
  transition: opacity 0.15s ease, transform 0.15s ease;
}

/* Icon inside breadcrumb */
.breadcrumb-icon{
  font-size: 0.72rem;
  opacity: 0.75;
}

/* Hover: tiny lift, no shadow */
.breadcrumb-item:hover{
  opacity: 0.92;
  transform: scale(1.02);
  color: var(--text-primary);
}

/* Drill level badge (Level 1, etc.) */
.drill-level-indicator{
  padding: 0.2rem 0.5rem;
  border-radius: 999px;
  border: 1px solid var(--border);
  background: rgba(255,255,255,0.015);
  color: var(--text-muted);
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.70rem;
  line-height: 1.1;
  display: inline-flex;
  align-items: center;
  gap: 0.35rem;
}

/* Filter badge */
.filter-badge{
  padding: 0.2rem 0.55rem;
  border-radius: 999px;
  border: 1px solid rgba(66,106,90,0.45);
  background: rgba(66,106,90,0.10);
  color: var(--text-primary);
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.70rem;
  line-height: 1.1;
  display: inline-flex;
  align-items: center;
  gap: 0.35rem;
  cursor: pointer;
  transition: opacity 0.15s ease, transform 0.15s ease;
}

.filter-badge:hover{
  opacity: 0.92;
  transform: scale(1.02);
}

/* Reduce spacing between left and right groups inside the bar */
#drillControlsBar > div{
  gap: 0.5rem !important;
}

/* Optional: if the bar feels tall due to wrapped lines */
@media (max-width: 520px){
  .drill-controls-bar{
    padding: 0.5rem 0.6rem;
  }
  .breadcrumb-item{
    font-size: 0.70rem;
    padding: 0.22rem 0.45rem;
  }
}
/* Hide redundant drill badges (logic stays intact) */
#drillLevelBadge,
#filterBadge {
  display: none !important;
}
/* 1. SOFTEN THE SEARCH BOX */
.main-input, .mini-search {
  border-radius: 8px; /* Softer corners */
  background: var(--bg-input) !important;
  border: 1px solid var(--border) !important;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2); /* Deep shadow, not harsh */
}
/* 2. RELAX THE "QUICK START" CHIPS */
/* Makes them look like paper tickets */
#heroView a[href^="?q="] {
  background: rgba(255, 255, 255, 0.03) !important;
  border: 1px solid var(--border) !important;
  color: var(--text-muted) !important;
  border-radius: 20px !important; /* Pill shape is friendlier */
  padding: 6px 16px !important;
  font-size: 0.75rem;
  letter-spacing: 0.5px;
}
#heroView a[href^="?q="]:hover {
  background: var(--accent-dim) !important;
  color: var(--accent-light) !important;
  border-color: var(--accent) !important;
  transform: translateY(-1px);
}

/* 3. MUTED SUBWAY BULLETS */
/* Instead of hardcoded orange/blue, use the palette variables */
.sub-bullet.blue { background: var(--info); }
.sub-bullet.orange { background: var(--warning); color: var(--bg-app); } /* Dark text on light background for contrast */
.sub-bullet.red { background: var(--danger); }
.sub-bullet.purple { background: #9B8EA9; } 

/* 4. CARD STYLING - "Matte" finish */
.deal-card, .stat-item, .analysis-panel {
  background: var(--bg-card);
  border: 1px solid var(--border) !important;
  box-shadow: 0 2px 8px rgba(0,0,0,0.15); /* Subtle depth */
}

/* 5. TEXT HIERARCHY */
/* Ensure big numbers don't dazzle the eyes */

/* 6. TAGS - Pastel Chalk look */
.meta-tag {
  border-radius: 4px;
  font-weight: 600;
  border: 1px solid transparent;
}
.meta-tag.psc { 
  background: rgba(126, 156, 184, 0.15); 
  color: var(--info); 
}
.meta-tag.naics { 
  background: rgba(155, 142, 169, 0.15); 
  color: #9B8EA9; 
}
/* =========================================
   MOBILE MODAL FIXES (Add to end of CSS)
   ========================================= */
@media (max-width: 768px) {
  
  /* 1. Tighten the outer container padding */
  /* Was 2rem, which is too wide for iPhone. Reduces wasted edge space. */

  /* Allows them to fit on screen without being forced 100% height if not needed */

  /* 3. FIX: COPY SUCCESS MODAL (Stop it from being huge) */
  /* This specific ID override prevents the success message from filling the screen */

  

  /* 5. Shrink large titles on mobile */
}
@media (max-width: 768px) {
  /* Prevent iOS zoom on focus */
  input, select, textarea {
    font-size: 16px !important; 
  }
}
/* Custom "Midnight" Scrollbars */
::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}
::-webkit-scrollbar-track {
  background: var(--bg-app); 
}
::-webkit-scrollbar-thumb {
  background: var(--bg-elevated); 
  border: 1px solid var(--border);
  border-radius: 4px;
}
::-webkit-scrollbar-thumb:hover {
  background: var(--accent-dim); 
}
/* Remove border from Sankey containers to make them 'float' */
#sankey, #sankey-sub, .sankey-container, .chart-wrapper {
  border: none !important;
  box-shadow: none !important;
  background: transparent !important;
}

/* If the SVG itself has a border class */
svg {
  border: none !important;
  outline: none !important;
}
/* Override: Copy Buttons -> Spidey Blue */

/* Step icons for Getting Started section */
.steps-list li {
  position: relative; padding-left: 3rem; margin-bottom: 1.25rem;
  font-size: 0.85rem; color: var(--text-primary); line-height: 1.5;
}
.steps-list li::before {
  content: counter(step-counter); counter-increment: step-counter;
  position: absolute; left: 0; top: 0;
  width: 28px; height: 28px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 13px; font-weight: 700; font-family: 'JetBrains Mono', monospace;
}
.steps-list li strong { color: var(--accent-light); }
.steps-list { counter-reset: step-counter; }

/* Step 1: Explore - Spidey Blue */
.steps-list li:nth-child(1)::before {
  background-color: #5B7C99 !important;
  color: #F1EEE9 !important;
  box-shadow: 0 0 0 2px #0E1111;
}

/* Step 2: Follow - Villain Purple */
.steps-list li:nth-child(2)::before {
  background-color: #7B6D8D !important;
  color: #F1EEE9 !important;
  box-shadow: 0 0 0 2px #0E1111;
}

/* Step 3: Connect - Advertisement Orange */
.steps-list li:nth-child(3)::before {
  background-color: #E07A5F !important;
  color: #F1EEE9 !important;
  box-shadow: 0 0 0 2px #0E1111;
}

.footer-copyright { font-family: 'JetBrains Mono', monospace; font-size: 0.65rem; color: var(--text); letter-spacing: 0.5px; margin-top: 1rem; text-align: center; } 

/* =========================================
   BUBBLE CHART - Market Landscape
   ========================================= */
#bubbleChartPanel {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 0.75rem;
  margin-bottom: 1.5rem;
  overflow: hidden;
}
#bubbleChartPanel .bubble-header {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.6rem;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 1.5px;
  margin-bottom: 0.5rem;
}
#bubbleChartContainer {
  width: 100%;
  min-height: 420px;
  position: relative;
}
#bubbleChartContainer svg {
  width: 100%;
  height: 100%;
  display: block;
}
#subBubbleContainer svg {
  width: 100%;
  height: 100%;
  display: block;
}
.bubble-node {
  cursor: pointer;
  transition: opacity 0.15s ease;
}
.bubble-node:hover {
  opacity: 0.85 !important;
}
.bubble-label {
  font-family: 'JetBrains Mono', monospace;
  fill: #F1EEE9;
  pointer-events: none;
  text-anchor: middle;
  dominant-baseline: central;
}
.bubble-amount-label {
  font-family: 'JetBrains Mono', monospace;
  fill: rgba(241, 238, 233, 0.7);
  pointer-events: none;
  text-anchor: middle;
}
.bubble-tooltip {
  position: absolute;
  background: rgba(22, 27, 24, 0.95);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 0.75rem 1rem;
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.75rem;
  color: var(--text-primary);
  pointer-events: none;
  z-index: 50;
  white-space: nowrap;
  backdrop-filter: blur(8px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.4);
  opacity: 0;
  transition: opacity 0.15s ease;
}
.bubble-tooltip.visible { opacity: 1; }
.bubble-tooltip-name { font-weight: 700; color: #F1EEE9; margin-bottom: 4px; }
.bubble-tooltip-amount { color: var(--accent-light); font-size: 0.85rem; font-weight: 700; }
.bubble-tooltip-meta { color: var(--text-muted); font-size: 0.65rem; margin-top: 4px; }
.bubble-toggle-row {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 1rem;
}
.bubble-toggle-btn {
  padding: 0.35rem 0.75rem;
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.65rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  border: 1px solid var(--border);
  border-radius: 4px;
  background: transparent;
  color: var(--text-muted);
  cursor: pointer;
  transition: all 0.15s ease;
}
.bubble-toggle-btn.active {
  background: var(--accent);
  border-color: var(--accent);
  color: #F1EEE9;
}
.bubble-toggle-btn:hover:not(.active) {
  border-color: var(--accent);
  color: var(--accent-light);
}

@media (max-width: 600px) {
  #bubbleChartContainer { min-height: 320px; }
}

/* Bubble Breadcrumb */
.bubble-bc-item {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 0.2rem 0.5rem;
  border-radius: 4px;
  color: var(--text-muted);
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.7rem;
  cursor: pointer;
  transition: all 0.15s ease;
  white-space: nowrap;
}
.bubble-bc-item:hover { color: var(--accent-light); background: rgba(255,255,255,0.05); }
.bubble-bc-item.active { color: #F1EEE9; font-weight: 700; cursor: default; }
.bubble-bc-item.active:hover { background: transparent; }
.bubble-bc-sep { color: var(--text-subtle); font-size: 0.55rem; }

/* =========================================
   PRESENTATION MODE (Screenshot-friendly)
   ========================================= */
.presentation-mode #sankeyPanel,
.presentation-mode #bubbleChartPanel,
.presentation-mode #subcontractingPanel,
.presentation-mode #subBubblePanel {
  background: #FFFFFF !important;
  border-color: #E0E0E0 !important;
}

/* Text colors */
.presentation-mode #sankeyPanel *,
.presentation-mode #bubbleChartPanel *,
.presentation-mode #subcontractingPanel *,
.presentation-mode #subBubblePanel * {
  --text-primary: #1A1A1A;
  --text-muted: #666666;
  --text-subtle: #999999;
  --border: rgba(0, 0, 0, 0.12);
}

/* Hero numbers + stat values (all use --text-primary now, handled by the * override above) */
/* Explicit override for inline styles that won't inherit CSS custom properties */
.presentation-mode #stat-vol,
.presentation-mode #bubble-stat-vol,
.presentation-mode #sub-stat-vol,
.presentation-mode #sub-bubble-stat-vol,
.presentation-mode #stat-agencies,
.presentation-mode #stat-count,
.presentation-mode #stat-vendors,
.presentation-mode #bubble-stat-agencies,
.presentation-mode #bubble-stat-count,
.presentation-mode #bubble-stat-vendors,
.presentation-mode #bubble-stat-entities,
.presentation-mode #sub-stat-primes,
.presentation-mode #sub-stat-subs,
.presentation-mode #sub-stat-count,
.presentation-mode #sub-bubble-stat-primes,
.presentation-mode #sub-bubble-stat-subs,
.presentation-mode #sub-bubble-stat-records,
.presentation-mode #sub-bubble-stat-shown {
  color: #1A1A1A !important;
}

/* Subtitle / label text */
.presentation-mode #sankeySubtitle,
.presentation-mode #bubbleChartSubtitle,
.presentation-mode #subBubbleSubtitle,
.presentation-mode .bubble-header {
  color: #666 !important;
}

/* Stat label text */
.presentation-mode #sankeyPanel span[style*="text-transform: uppercase"],
.presentation-mode #bubbleChartPanel span[style*="text-transform: uppercase"],
.presentation-mode #subcontractingPanel span[style*="text-transform: uppercase"],
.presentation-mode #subBubblePanel span[style*="text-transform: uppercase"] {
  color: #888 !important;
}

/* Divider lines inside chart panels */
.presentation-mode #sankeyPanel div[style*="border-left"],
.presentation-mode #bubbleChartPanel div[style*="border-left"],
.presentation-mode #subcontractingPanel div[style*="border-left"],
.presentation-mode #subBubblePanel div[style*="border-left"] {
  border-color: #E0E0E0 !important;
}

.presentation-mode #sankeyPanel div[style*="border-top"],
.presentation-mode #bubbleChartPanel div[style*="border-top"],
.presentation-mode #subcontractingPanel div[style*="border-top"],
.presentation-mode #subBubblePanel div[style*="border-top"] {
  border-color: #E0E0E0 !important;
}

/* Footer text in chart panels */
.presentation-mode #sankeyPanel > div:last-child,
.presentation-mode #bubbleChartPanel > div:last-child,
.presentation-mode #subBubblePanel > div:last-child {
  color: #999 !important;
}

/* Bubble chart text labels */
.presentation-mode .bubble-label { fill: #1A1A1A !important; }
.presentation-mode .bubble-amount-label { fill: rgba(26, 26, 26, 0.65) !important; }

/* Bubble breadcrumbs */
.presentation-mode .bubble-bc-item { color: #666; }
.presentation-mode .bubble-bc-item:hover { color: var(--accent); background: rgba(0,0,0,0.05); }
.presentation-mode .bubble-bc-item.active { color: #1A1A1A; }
.presentation-mode .bubble-bc-sep { color: #CCC; }
.presentation-mode #bubbleBreadcrumb,
.presentation-mode #subBubbleBreadcrumb {
  background: rgba(0,0,0,0.03) !important;
  border-color: #E0E0E0 !important;
}

/* Bubble tooltip */
.presentation-mode .bubble-tooltip {
  background: rgba(255, 255, 255, 0.96) !important;
  border-color: #DDD !important;
  color: #1A1A1A !important;
  box-shadow: 0 4px 16px rgba(0,0,0,0.12);
}
.presentation-mode .bubble-tooltip-name { color: #1A1A1A !important; }
.presentation-mode .bubble-tooltip-amount { color: var(--accent) !important; }
.presentation-mode .bubble-tooltip-meta { color: #666 !important; }

/* Toggle buttons inside chart panels */
.presentation-mode .bubble-toggle-btn {
  border-color: #DDD !important;
  color: #888 !important;
}
.presentation-mode .bubble-toggle-btn.active {
  background: var(--accent) !important;
  border-color: var(--accent) !important;
  color: #FFF !important;
}
.presentation-mode .bubble-toggle-btn:hover:not(.active) {
  border-color: var(--accent) !important;
  color: var(--accent) !important;
}

/* Screenshot Mode – Advertisement Orange (IND 6th Av) */
.icon-btn-pres {
  background: #E07A5F !important;
  color: #F1EEE9 !important;
}
.icon-btn-pres:hover {
  background: #F18B70 !important;
  transform: translateY(-1px);
}
.icon-btn-pres.active {
  background: #F18B70 !important;
  color: #F1EEE9 !important;
}
/* ==========================================================================
   AI ACTION PLAN PANEL & SMART FRICTION
   ========================================================================== */
.ai-action-panel {
    background: #111111; /* Deep dark background */
    border: 1px solid #426a5a; /* Muted accent green */
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 24px;
    display: none; /* Hidden until triggered */
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
    position: relative;
}

.ai-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px dashed #333333;
    padding-bottom: 12px;
    margin-bottom: 16px;
}

.ai-header h3 {
    margin: 0;
    font-family: 'JetBrains Mono', monospace;
    font-size: 14px;
    color: #8fbc8f; /* Bright accent green */
    text-transform: uppercase;
    letter-spacing: 1px;
}

/* Smart Friction Popover */
.smart-friction-popover {
    position: absolute;
    top: 100%;
    right: 0;
    margin-top: 8px;
    background: #1A1A1A;
    border: 1px solid #426a5a;
    border-radius: 8px;
    padding: 16px;
    width: 340px;
    z-index: 100;
    box-shadow: 0 10px 40px rgba(0,0,0,0.8);
    display: none;
}

.smart-friction-popover.active { 
    display: block; 
    animation: fadeInDown 0.2s ease-out; 
}

@keyframes fadeInDown {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

.sf-label {
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
    color: #A0A0A0;
    text-transform: uppercase;
    margin-bottom: 10px;
    display: block;
    letter-spacing: 0.5px;
}

.sf-radio-group {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-bottom: 20px;
}

.sf-radio-label {
    font-size: 13px;
    color: #F1EEE9;
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    padding: 8px;
    border-radius: 4px;
    background: #222222;
    border: 1px solid #333;
    transition: all 0.2s;
}

.sf-radio-label:hover {
    background: #2a2a2a;
    border-color: #426a5a;
}

.sf-input {
    width: 100%;
    padding: 10px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 13px;
    background: #000000;
    border: 1px solid #333333;
    color: #F1EEE9;
    border-radius: 4px;
    margin-bottom: 16px;
}

.sf-input:focus {
    outline: none;
    border-color: #8fbc8f;
}

/* AI Skeleton Loader */
.skeleton-loader {
    animation: skeletonPulse 1.5s infinite ease-in-out;
}

.skeleton-line {
    height: 14px;
    background: #222222;
    border-radius: 4px;
    margin-bottom: 12px;
}

@keyframes skeletonPulse {
    0% { opacity: 0.4; }
    50% { opacity: 0.8; }
    100% { opacity: 0.4; }
}

/* AI Results Formatting */
.ai-result-section { margin-bottom: 20px; }
.ai-result-title { 
    font-size: 11px; 
    color: #A0A0A0; 
    text-transform: uppercase; 
    margin-bottom: 8px; 
    font-family: 'JetBrains Mono', monospace;
    letter-spacing: 1px;
}
.ai-result-content { 
    font-size: 14px; 
    color: #F1EEE9; 
    line-height: 1.6; 
}
.ai-result-content ul {
    padding-left: 20px;
    margin: 0;
}
.ai-result-content li { 
    margin-bottom: 8px; 
}
.ai-internal-ask {
    background: #1a1a00;
    border-left: 3px solid #d4a84b; /* Gold warning accent */
    padding: 12px 16px;
    border-radius: 0 4px 4px 0;
    font-style: italic;
}
</style>
</head>
<body>

<div id="heroView" class="hero-view">
  <div class="terminal-logo"><span style="color: var(--accent);">>_</span>Govhoo</div>
  <p class="hero-subtitle" style="padding-left: 1.25em;">Follow the Money. For Free.</p>
  
  <div class="search-box-container">
  <input type="text" id="mainSearchInput" class="main-input" placeholder="Try: CLOUD, 541512 AND AIR FORCE, or DA10 AND AIR FORCE" autocomplete="off" style="text-transform: uppercase;">
  <button class="input-clear" onclick="document.getElementById('mainSearchInput').value=''; document.getElementById('mainSearchInput').focus();" aria-label="Clear search">×</button>
    <div class="btn-row">
      <button id="searchBtn" class="btn-primary" data-action="search" style="flex: none; width: 100%; background-color: var(--accent); color: #F1EEE9;">
        SEARCH
      </button>
    </div>
  </div>
  <div style="width: 100%; max-width: 500px; margin-top: 0.75rem; text-align: center; font-size: 0.65rem; color: var(--text-muted); opacity: 0.7; font-family: 'JetBrains Mono', monospace; line-height: 1.5;">
    <span style="color: var(--accent);">TIP:</span> Use <strong>AND</strong> to narrow results <span style="opacity: 0.5;">·</span> <span style="opacity: 0.8;">541512 AND Air Force</span> <span style="opacity: 0.5;">·</span> <span style="opacity: 0.8;">DA10 AND Air Force</span> <span style="opacity: 0.5;">·</span> Use <strong>,</strong> to combine <span style="opacity: 0.5;">·</span> <span style="opacity: 0.8;">Cloud, Cyber</span>
  </div>
  <div style="width: 100%; max-width: 500px; margin-top: 1.5rem;">
    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: center;">
      <a href="?q=Cloud" style="text-decoration: none; padding: 0.4rem 0.75rem; border: 1px solid var(--border); border-radius: 4px; font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; color: var(--text-muted); transition: all 0.15s; background: rgba(255,255,255,0.02);" onmouseover="this.style.borderColor='var(--accent)';this.style.color='var(--accent)';this.style.background='var(--accent-dim)'" onmouseout="this.style.borderColor='var(--border)';this.style.color='var(--text-muted)';this.style.background='rgba(255,255,255,0.02)'">Cloud</a>
      <a href="?q=R499+AND+AIR+FORCE" style="text-decoration: none; padding: 0.4rem 0.75rem; border: 1px solid var(--border); border-radius: 4px; font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; color: var(--text-muted); transition: all 0.15s; background: rgba(255,255,255,0.02);" onmouseover="this.style.borderColor='var(--accent)';this.style.color='var(--accent)';this.style.background='var(--accent-dim)'" onmouseout="this.style.borderColor='var(--border)';this.style.color='var(--text-muted)';this.style.background='rgba(255,255,255,0.02)'">R499 AND Air Force</a>
      <a href="?q=NVIDIA" style="text-decoration: none; padding: 0.4rem 0.75rem; border: 1px solid var(--border); border-radius: 4px; font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; color: var(--text-muted); transition: all 0.15s; background: rgba(255,255,255,0.02);" onmouseover="this.style.borderColor='var(--accent)';this.style.color='var(--accent)';this.style.background='var(--accent-dim)'" onmouseout="this.style.borderColor='var(--border)';this.style.color='var(--text-muted)';this.style.background='rgba(255,255,255,0.02)'">NVIDIA</a>
      <a href="?q=Cloud,+Cyber" style="text-decoration: none; padding: 0.4rem 0.75rem; border: 1px solid var(--border); border-radius: 4px; font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; color: var(--text-muted); transition: all 0.15s; background: rgba(255,255,255,0.02);" onmouseover="this.style.borderColor='var(--accent)';this.style.color='var(--accent)';this.style.background='var(--accent-dim)'" onmouseout="this.style.borderColor='var(--border)';this.style.color='var(--text-muted)';this.style.background='rgba(255,255,255,0.02)'">Cloud, Cyber</a>
    </div>
  </div>
<footer class="hero-footer">
  <div class="footer-grid">

    <!-- GETTING STARTED -->
    <div class="footer-section">
      <div class="footer-label mono text-xs accent upper">Getting Started</div>

      <div style="margin-bottom: 1rem;">
        <ol class="steps-list" style="list-style: none; padding-left: 0;">

          <li style="margin-bottom: 1rem;">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
              <strong style="color: var(--text-primary);">Search Anything</strong>
            </div>
            <div style="font-size: 0.75rem; color: var(--text-primary); opacity: 0.7; line-height: 1.5;">
              Type a keyword, company, NAICS code, or agency. Use <strong style="color: var(--accent-light);">AND</strong> to narrow — <em>541512 AND Air Force</em>. Use a <strong style="color: var(--accent-light);">,</strong> to broaden — <em>Cloud, Cyber</em>. Shorthand like <em>DHS</em>, <em>VA</em>, <em>DISA</em> works everywhere.
            </div>
          </li>

          <li style="margin-bottom: 1rem;">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
              <strong style="color: var(--text-primary);">Follow the Money</strong>
            </div>
            <div style="font-size: 0.75rem; color: var(--text-primary); opacity: 0.7; line-height: 1.5;">
              The Sankey shows how dollars flow from agencies to primes. Click any bar to drill in. Below it, the NAICS breakdown shows which codes dominate — click one to narrow your search. Use vehicle pills to filter by contract vehicle.
            </div>
          </li>

          <li style="margin-bottom: 0;">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
              <strong style="color: var(--text-primary);">Find Partners & Competitors</strong>
            </div>
            <div style="font-size: 0.75rem; color: var(--text-primary); opacity: 0.7; line-height: 1.5;">
              Switch to the Sub view to see prime→sub relationships. The Prime Reach panel shows which primes have the broadest agency coverage. Click any vendor's <em>Footprint</em> link to see their entire federal portfolio.
            </div>
          </li>

        </ol>
      </div>
    </div>

    <!-- WHY GOVHOO -->
    <div class="footer-section">
      <div class="footer-label mono text-xs accent upper">Why Govhoo</div>

      <div class="use-cases">

        <div class="use-case">
          <div class="use-case-title">
            Size a Market in Seconds
          </div>
          <div class="use-case-desc">
            See total spend, top agencies, dominant vendors, and which NAICS codes carry the most investment — instantly.
          </div>
        </div>

        <div class="use-case">
          <div class="use-case-title">
            Find the Right Primes
          </div>
          <div class="use-case-desc">
            See which primes are active across multiple agencies in your market. One partner, broader reach.
          </div>
        </div>

        <div class="use-case">
          <div class="use-case-title">
            Scout the Competition
          </div>
          <div class="use-case-desc">
            Click any vendor's Footprint to see their entire federal portfolio across every agency and market.
          </div>
        </div>

      </div>
    </div>

<!-- BUILT BY -->
<div class="footer-section">
  <div class="footer-label mono text-xs accent upper">Built by a Sales Guy</div>

  <p class="footer-text">
  <img src="https://govhoo.com/images/oldmark.jpg" alt="Mark Flournoy" class="tip-bio-img">
  Hi, I’m Mark, a retired federal sales guy, former COTR, and Marine. At AWS, F5, and Red Hat, I spent hours every month digging through USASpending data, SAM.gov listings, and industry days just to understand where the government was actually investing and who really controlled the workshare.
  <br><br>
  I built Govhoo to make that part simple. Govhoo isn’t trying to replace GovWin or BGOV. It’s a directional tool. It shows sustained government investment so teams can align efforts and resources and move forward with confidence. And it’s free to use.
  <br><br>
  If you want help applying this to your territory planning, or a resourcing discussion with leadership, I’m happy to talk it through. You can also find me on
  <a href="https://www.linkedin.com/in/markflournoy/" target="_blank" class="footer-link">
    LinkedIn
  </a>.
</p>

  <div style="padding: 1rem; margin-top: 1.2rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px;">
    <div style="font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; font-weight: 700; color: #F1EEE9; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 0.5rem;">
      Need a Second Set of Eyes?
    </div>
    <div style="font-size: 0.7rem; color: var(--text-primary); opacity: 0.7; line-height: 1.4; margin-bottom: 1rem;">
      If you’re deciding where to focus next or need to sanity-check a market, let’s spend 30 minutes walking through the data together.
    </div>
    <a href="https://calendly.com/markflournoy/govhoo" target="_blank" style="text-decoration:none;">
      <button class="btn-primary" style="width: 100%; padding: 0.6rem; font-size: 0.75rem; justify-content: center;">
         Book a working session
      </button>
    </a>
  </div>
</div>
  </div>
  <div class="footer-bottom">
    <div class="footer-copyright">© 2026 <span style="color: #5f8055;">>_</span>GOVHOO.COM — DATA VIA USASPENDING.GOV</div>
  </div>
</footer>
</div>

<div id="appView" style="display:none;">
  <header class="app-header">
    <div class="header-left">
      <span class="logo-btn" data-action="showHero" title="Back to home"><span style="color: var(--accent);">>_</span>Govhoo</span>
      <div class="mini-search-wrapper">
        <input type="text" id="miniSearch" class="mini-search" placeholder="Search keywords, companies, NAICS, agencies..." style="text-transform: uppercase;">
      </div>
    </div>
    <div class="header-actions">
      <button class="icon-btn icon-btn-slack" data-action="shareBrief" title="Share Link">
        <i class="fa-regular fa-paper-plane"></i>
      </button>
      <button class="icon-btn icon-btn-csv" title="Download CSV" data-action="exportCSV">
        <i class="fas fa-arrow-down"></i>
      </button>
      <button class="icon-btn icon-btn-pres" id="presToggleBtn" onclick="App.togglePresentationMode()" title="Light Mode">
        <i class="fas fa-rainbow"></i>
      </button>
    </div>
  </header>

  <div id="dashboardContainer" class="dashboard-container">
    
    <div id="searchModeView" class="view-section active">
      
      <!-- Drill Navigation Controls -->
      <div id="drillControlsBar" class="drill-controls-bar" style="display: none; margin-bottom: 1rem; padding: 0.75rem 1rem; background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 6px; overflow: hidden;">
        <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 0.5rem;">
          <div id="drillBreadcrumb" class="drill-breadcrumb" style="display: flex; margin: 0; flex-wrap: wrap; min-width: 0;">
            <div class="breadcrumb-item" data-action="resetDrill">
              
              <span>All Agencies</span>
            </div>
          </div>
          <div style="display: flex; align-items: center; gap: 0.5rem;">
            <span id="drillLevelBadge" class="drill-level-indicator">
              
              <span id="drillLevelText">Level 1</span>
            </span>
            <div id="filterBadge" class="filter-badge" data-action="clearFilter">
              <span id="filterName">FILTER</span> 
            </div>
          </div>
        </div>
      </div>

      <!-- Agency Award Flow Sankey -->
      <div id="sankeyPanel" class="sankey-panel" style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 1.25rem; margin-bottom: 1rem; overflow: hidden;">
        
        <div style="margin-bottom: 1rem;">
          <div id="sankeySubtitle" style="font-family: 'JetBrains Mono', monospace; font-size: 0.6rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 0.5rem;">Top 100 Active Contracts · Obligated Value</div>
          <div style="display: flex; align-items: baseline; gap: 1.5rem; flex-wrap: wrap;">
            <div id="stat-vol" style="font-family: 'JetBrains Mono', monospace; font-size: clamp(1.75rem, 5vw, 2.5rem); font-weight: 800; color: var(--text-primary); line-height: 1;">-</div>
            <div id="searchStatsCompact" style="display: flex; gap: 1.25rem; align-items: baseline; flex-wrap: wrap; margin-left: 0.5rem; padding-left: 1.5rem; border-left: 1px solid var(--border);">
              <div style="display: flex; align-items: baseline; gap: 0.35rem;">
                <span id="stat-agencies" style="font-family: 'JetBrains Mono', monospace; font-size: 1rem; font-weight: 700; color: var(--text-primary);">-</span>
                <span style="font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase;">Agencies</span>
              </div>
              <div style="display: flex; align-items: baseline; gap: 0.35rem;">
                <span id="stat-count" style="font-family: 'JetBrains Mono', monospace; font-size: 1rem; font-weight: 700; color: var(--text-primary);">-</span>
                <span style="font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase;">Contracts</span>
              </div>
              <div style="display: flex; align-items: baseline; gap: 0.35rem;">
                <span id="stat-vendors" style="font-family: 'JetBrains Mono', monospace; font-size: 1rem; font-weight: 700; color: var(--text-primary);">-</span>
                <span style="font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase;">Vendors</span>
              </div>
            </div>
          </div>
        </div>

        <div class="chart-wrapper" style="border: none; padding: 0; background: transparent; overflow-x: auto; overflow-y: visible;">
          <div id="chartContainer" class="chart-container"></div>
        </div>
        <div style="display: flex; align-items: center; justify-content: space-between; margin-top: 1rem; padding-top: 0.75rem; border-top: 1px solid var(--border); font-size: 0.65rem; color: var(--text-muted);">
          <span id="marketHealth" style="font-family: 'JetBrains Mono', monospace;"></span>
          <span style="font-family: 'JetBrains Mono', monospace;"><span style="color: var(--accent);">>_</span>Govhoo.com</span>
        </div>
      </div>
<div id="aiIntelligenceBanner" style="background: rgba(66, 106, 90, 0.1); border: 1px solid #426a5a; border-radius: 6px; padding: 12px 20px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; transition: all 0.3s;">
    <div>
        <h4 style="margin: 0; color: #8fbc8f; font-family: 'JetBrains Mono', monospace; font-size: 13px;">
            <i class="fas fa-brain"></i> AI Analysis
        </h4>
        <p style="margin: 4px 0 0 0; color: #A0A0A0; font-size: 12px;">
            Synthesize raw contract descriptions, buying patterns, and major players for this search.
        </p>
    </div>
    <button id="triggerAiPlanBtn" onclick="App.runAiActionPlan()" style="background: #8fbc8f; color: #000; border: none; padding: 8px 16px; border-radius: 4px; font-family: 'JetBrains Mono', monospace; font-weight: 700; font-size: 12px; cursor: pointer; white-space: nowrap;">
        Fetch Brief
    </button>
</div>

<div id="aiActionPanel" class="ai-action-panel" style="display: none;">
    <div class="ai-header">
        <h3><i class="fas fa-brain"></i> Account Intelligence Brief</h3>
        <button id="copyAiBtn" onclick="App.copyAiPlan()" style="display: none; background: transparent; border: 1px solid #555; color: #ccc; padding: 6px 12px; border-radius: 4px; font-family: 'JetBrains Mono', monospace; font-size: 11px; cursor: pointer;">
            <i class="fas fa-copy"></i> Copy Brief
        </button>
    </div>
    <div id="aiContentContainer"></div>
</div>
      <!-- 1. Bubble Chart — visual market sizing, mobile-readable -->
      <div id="bubbleChartPanel" style="display: none;">
        
        <div style="margin-bottom: 1rem;">
          <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 0.5rem;">
            <div id="bubbleChartSubtitle" style="font-family: 'JetBrains Mono', monospace; font-size: 0.6rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1.5px;">Top Active Vendors & Agencies · Lifetime Funded Value</div>
            <div class="bubble-toggle-row" style="margin-bottom: 0;" id="bubbleToggleRow">
              <button class="bubble-toggle-btn active" onclick="App.setBubbleMode('vendors')" id="bubbleToggleVendors">Vendors</button>
              <button class="bubble-toggle-btn" onclick="App.setBubbleMode('agencies')" id="bubbleToggleAgencies">Agencies</button>
              <button class="bubble-toggle-btn" onclick="App.setBubbleMode('subagencies')" id="bubbleToggleSubAgencies" style="display:none;">Sub-Agencies</button>
              <span style="border-left: 1px solid var(--border); height: 1.2rem; margin: 0 0.25rem;"></span>
              <button class="bubble-toggle-btn active" onclick="App.setBubbleChartType('bubbles')" id="chartTypeBubbles">Bubbles</button>
              <button class="bubble-toggle-btn" onclick="App.setBubbleChartType('treemap')" id="chartTypeTreemap">Treemap</button>
            </div>
          </div>
          <div style="display: flex; align-items: baseline; gap: 1.5rem; flex-wrap: wrap;">
            <div id="bubble-stat-vol" style="font-family: 'JetBrains Mono', monospace; font-size: clamp(1.75rem, 5vw, 2.5rem); font-weight: 800; color: var(--text-primary); line-height: 1;">-</div>
            <div style="display: flex; gap: 1.25rem; align-items: baseline; flex-wrap: wrap; margin-left: 0.5rem; padding-left: 1.5rem; border-left: 1px solid var(--border);">
              <div style="display: flex; align-items: baseline; gap: 0.35rem;">
                <span id="bubble-stat-agencies" style="font-family: 'JetBrains Mono', monospace; font-size: 1rem; font-weight: 700; color: var(--text-primary);">-</span>
                <span style="font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase;">Agencies</span>
              </div>
              <div style="display: flex; align-items: baseline; gap: 0.35rem;">
                <span id="bubble-stat-count" style="font-family: 'JetBrains Mono', monospace; font-size: 1rem; font-weight: 700; color: var(--text-primary);">-</span>
                <span style="font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase;">Contracts</span>
              </div>
              <div style="display: flex; align-items: baseline; gap: 0.35rem;">
                <span id="bubble-stat-vendors" style="font-family: 'JetBrains Mono', monospace; font-size: 1rem; font-weight: 700; color: var(--text-primary);">-</span>
                <span style="font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase;">Vendors</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Bubble breadcrumb (mirrors and syncs with the Sankey breadcrumb) -->
        <div id="bubbleBreadcrumb" style="display:none; margin-bottom: 0.75rem; padding: 0.5rem 0.75rem; background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 6px; font-size: 0.7rem; overflow-x: auto;">
          <div id="bubbleBreadcrumbInner" style="display: flex; align-items: center; gap: 0.35rem; flex-wrap: wrap;"></div>
        </div>
        <div id="bubbleChartContainer">
          <div class="bubble-tooltip" id="bubbleTooltip"></div>
        </div>
        <div style="display: flex; align-items: center; justify-content: space-between; margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid var(--border); font-size: 0.6rem; color: var(--text-muted);">
          <span> Size = total award value · Click to drill down · Toggle Treemap for market share view</span>
          <span style="font-family: 'JetBrains Mono', monospace;"><span style="color: var(--accent);">>_</span>Govhoo.com</span>
        </div>
      </div>
      
      <div id="drillHint" class="drill-hint" style="display:none;">
        
        <span>Click an <strong>agency bar</strong> to drill into sub-agencies</span>
      </div>

      <!-- 2. NAICS Breakdown — click any row to narrow search -->
      <div id="naicsPanel" class="data-panel" style="display: none;">
        <div class="data-panel-header">
          <span class="data-panel-title">NAICS Breakdown</span>
          <span class="data-panel-subtitle">click any row to search</span>
        </div>
        <div class="data-panel-body" id="naicsMixBody"></div>
      </div>

      <!-- 3. Prime Reach — who to partner with, ranked by agency diversity -->
      <div id="teamingPanel" class="data-panel" style="display: none;">
        <div class="data-panel-header">
          <span class="data-panel-title">Prime Reach</span>
          <span class="data-panel-subtitle">ranked by agency diversity</span>
        </div>
        <div class="data-panel-body" id="teamingList"></div>
      </div>

      <!-- 4. Vehicle Filter Pills — only shows if vehicles exist -->
      <div id="vehicleFilterBar" style="display: none; margin-bottom: 0.75rem; padding: 0.5rem 0.75rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px;">
        <div style="display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
          <span style="font-family: 'JetBrains Mono', monospace; font-size: 0.5rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1.5px; flex-shrink: 0;">Vehicles</span>
          <div id="vehiclePills" style="display: flex; gap: 0.35rem; flex-wrap: wrap;"></div>
        </div>
      </div>

      <!-- 5. Sidebar grid: Agencies, Locations, Key Terms -->
      <!-- 5. Top Agencies — who's buying, with drill and LinkedIn links -->
      <div id="searchJobPanel" style="margin: 0 0 0.75rem 0; padding: 0; position: relative;">
        <div id="agencyReachPanel" class="data-panel" style="display: none;">
          <div class="data-panel-header">
            <span class="data-panel-title">Top Agencies</span>
            <span class="data-panel-subtitle">click to drill · ranked by spend</span>
          </div>
          <div class="data-panel-body" id="searchTopBuyersBody"></div>
        </div>
      </div>

<!-- 6. Explainer — context for those who want it -->
<div id="primeExplainerBox" style="background: linear-gradient(135deg, rgba(99,102,241,0.08), rgba(99,102,241,0.03)); border: 1px solid rgba(99,102,241,0.2); border-radius: 8px; padding: 1rem 1.25rem; margin-bottom: 1rem; display: none;">
  <div style="display: flex; align-items: flex-start; gap: 0.75rem;">
    <div style="flex: 1; font-size: 0.75rem; color: var(--text-muted); line-height: 1.6;">
      <strong style="color: var(--text-primary); font-size: 0.8rem;">What you're looking at</strong><br>
      Live federal award data from USASpending.gov. Every contract shown had funding activity in the past 12 months. Dollar values are <strong style="color: var(--text-primary);">Total Obligations to Date</strong> — the government's cumulative commitment over the life of the contract.<br><br>
      <strong style="color: var(--text-primary);">The panels</strong><br>
      <strong style="color: var(--accent);">Sankey</strong> — how dollars flow from agencies to primes. Click any bar to drill in.
      <strong style="color: var(--accent);">Bubble Chart</strong> — visual market sizing. Toggle between vendors and agencies.
      <strong style="color: var(--accent);">NAICS</strong> — top codes by value with lead vendor and buying agency. Click any row to narrow your search.
      <strong style="color: var(--accent);">Prime Reach</strong> — top primes ranked by agency diversity. Click any name to search their full portfolio.
      <strong style="color: var(--accent);">Top Agencies</strong> — who's buying, with top vendor at each. Click to drill into sub-agencies.
      <strong style="color: var(--accent);">Vehicles</strong> — filter the entire view to a single contract vehicle.<br><br>
      <strong style="color: var(--text-primary);">Search tips</strong><br>
      <em class="explainer-highlight">Use AND with codes: <strong>541512 AND Air Force</strong>. Commas broaden: <strong>Cloud, Cyber</strong>. Switch to Sub view to see prime→sub flow.</em>
    </div>
  </div>
</div>

      <!-- 7. Expiring Contracts -->
      <div id="recompetesList" style="margin-bottom: 1.5rem;"></div>

      <!-- Commit Board — scored opportunity list -->

      <!-- Next Search suggestions -->

      <div class="section-header">
        <div class="section-title-group">
          <span class="section-title">Recent Awards</span>
        </div>
      </div>
      <div id="feedGrid" class="feed-grid"></div>

      <div id="subawardWrapper" style="display: none;">      
        <div style="margin-top: 1.5rem;">
          <div id="subcontractingPanel" style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 0.75rem; overflow: hidden;">
            <div id="subcontractingStats" style="margin-bottom: 1rem;">
  <div id="subSankeySubtitle" style="font-family: 'JetBrains Mono', monospace; font-size: 0.6rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 0.5rem;">Top 100 Subcontracts · Individual Transaction Value</div>
  <div style="display: flex; align-items: baseline; gap: 1.5rem; flex-wrap: wrap;">
    <div id="sub-stat-vol" style="font-family: 'JetBrains Mono', monospace; font-size: clamp(1.75rem, 5vw, 2.5rem); font-weight: 800; color: var(--text-primary); line-height: 1;">-</div>
    
    <div style="display: flex; gap: 1.25rem; align-items: baseline; flex-wrap: wrap; margin-left: 0.5rem; padding-left: 1.5rem; border-left: 1px solid var(--border);">
      <div style="display: flex; align-items: baseline; gap: 0.35rem;">
        <span id="sub-stat-primes" style="font-family: 'JetBrains Mono', monospace; font-size: 1rem; font-weight: 700; color: var(--text-primary);">-</span>
        <span style="font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase;">Primes</span>
      </div>
      <div style="display: flex; align-items: baseline; gap: 0.35rem;">
        <span id="sub-stat-subs" style="font-family: 'JetBrains Mono', monospace; font-size: 1rem; font-weight: 700; color: var(--text-primary);">-</span>
        <span style="font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase;">Subs</span>
      </div>
      <div style="display: flex; align-items: baseline; gap: 0.35rem;">
        <span id="sub-stat-count" style="font-family: 'JetBrains Mono', monospace; font-size: 1rem; font-weight: 700; color: var(--text-primary);">-</span>
        <span style="font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase;">Contracts</span>
      </div>
    </div>
  </div>
</div>
            <div class="chart-wrapper" style="border: none; padding: 0; background: transparent; overflow-x: auto; overflow-y: visible;">
              <div id="subcontractingBody" style="min-height: 350px;"></div>
            </div>
          </div>
        </div>

        <!-- 1. Sub Bubble Chart -->
        <div id="subBubblePanel" style="display: none; margin-top: 1rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 1.25rem; overflow: hidden;">
          <div style="margin-bottom: 1rem;">
            <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 0.5rem;">
              <div id="subBubbleSubtitle" style="font-family: 'JetBrains Mono', monospace; font-size: 0.6rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1.5px;">Top Primes & Subcontractors · Individual Transaction Value</div>
              <div class="bubble-toggle-row" style="margin-bottom: 0;">
                <button class="bubble-toggle-btn active" onclick="App.setSubBubbleMode('primes')" id="subBubbleTogglePrimes">Primes</button>
                <button class="bubble-toggle-btn" onclick="App.setSubBubbleMode('subs')" id="subBubbleToggleSubs">Subs</button>
                <span style="border-left: 1px solid var(--border); height: 1.2rem; margin: 0 0.25rem;"></span>
                <button class="bubble-toggle-btn active" onclick="App.setSubBubbleChartType('bubbles')" id="subChartTypeBubbles">Bubbles</button>
                <button class="bubble-toggle-btn" onclick="App.setSubBubbleChartType('treemap')" id="subChartTypeTreemap">Treemap</button>
              </div>
            </div>
            <div style="display: flex; align-items: baseline; gap: 1.5rem; flex-wrap: wrap;">
              <div id="sub-bubble-stat-vol" style="font-family: 'JetBrains Mono', monospace; font-size: clamp(1.75rem, 5vw, 2.5rem); font-weight: 800; color: var(--text-primary); line-height: 1;">-</div>
              <div style="display: flex; gap: 1.25rem; align-items: baseline; flex-wrap: wrap; margin-left: 0.5rem; padding-left: 1.5rem; border-left: 1px solid var(--border);">
                <div style="display: flex; align-items: baseline; gap: 0.35rem;">
                  <span id="sub-bubble-stat-primes" style="font-family: 'JetBrains Mono', monospace; font-size: 1rem; font-weight: 700; color: var(--text-primary);">-</span>
                  <span style="font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase;">Primes</span>
                </div>
                <div style="display: flex; align-items: baseline; gap: 0.35rem;">
                  <span id="sub-bubble-stat-subs" style="font-family: 'JetBrains Mono', monospace; font-size: 1rem; font-weight: 700; color: var(--text-primary);">-</span>
                  <span style="font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase;">Subs</span>
                </div>
                <div style="display: flex; align-items: baseline; gap: 0.35rem;">
                  <span id="sub-bubble-stat-records" style="font-family: 'JetBrains Mono', monospace; font-size: 1rem; font-weight: 700; color: var(--text-primary);">-</span>
                  <span style="font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase;">Contracts</span>
                </div>
              </div>
            </div>
          </div>
          <div id="subBubbleBreadcrumb" style="display:none; margin-bottom: 0.75rem; padding: 0.5rem 0.75rem; background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 6px; font-size: 0.7rem; overflow-x: auto;">
            <div id="subBubbleBreadcrumbInner" style="display: flex; align-items: center; gap: 0.35rem; flex-wrap: wrap;"></div>
          </div>
          <div id="subBubbleContainer" style="width: 100%; min-height: 380px; position: relative;">
            <div class="bubble-tooltip" id="subBubbleTooltip"></div>
          </div>
          <div style="display: flex; align-items: center; justify-content: space-between; margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid var(--border); font-size: 0.6rem; color: var(--text-muted);">
            <span> Bubble size = subaward value · Click to drill</span>
            <span style="font-family: 'JetBrains Mono', monospace;"><span style="color: var(--accent);">>_</span>Govhoo.com</span>
          </div>
        </div>

        <!-- 2. Top Primes (in sub view) — reach-style panel -->
        <div id="subPrimesPanel" class="data-panel" style="display: none; margin-top: 0.75rem;">
          <div class="data-panel-header">
            <span class="data-panel-title">Top Primes</span>
            <span class="data-panel-subtitle">by sub value awarded</span>
          </div>
          <div class="data-panel-body" id="searchTopPrimesBody"></div>
        </div>

        <!-- 3. Top Subs — reach-style panel -->
        <div id="subSubsPanel" class="data-panel" style="display: none; margin-top: 0.75rem;">
          <div class="data-panel-header">
            <span class="data-panel-title">Top Subs</span>
            <span class="data-panel-subtitle">by sub value received</span>
          </div>
          <div class="data-panel-body" id="searchTopSubsBody"></div>
        </div>

        <!-- 4. Sub Explainer -->
        <div id="subExplainerBox" style="background: linear-gradient(135deg, rgba(99,102,241,0.08), rgba(99,102,241,0.03)); border: 1px solid rgba(99,102,241,0.2); border-radius: 8px; padding: 1rem 1.25rem; margin-top: 0.75rem; display: none;">
          <div style="display: flex; align-items: flex-start; gap: 0.75rem;">
            <div style="flex: 1; font-size: 0.75rem; color: var(--text-muted); line-height: 1.6;">
              <strong style="color: var(--text-primary); font-size: 0.8rem;">What you're looking at</strong><br>
              Subcontracting activity from the past 12 months. Dollar amounts are <strong style="color: var(--text-primary);">individual transaction values</strong>, not cumulative obligations.<br><br>
              <strong style="color: var(--text-primary);">The panels</strong><br>
              <strong style="color: var(--accent);">Sankey</strong> — how sub dollars flow from agencies through primes to subs. Click any bar to filter.
              <strong style="color: var(--accent);">Bubble Chart</strong> — visual market sizing. Toggle between primes and subs.
              <strong style="color: var(--accent);">Top Primes</strong> — who's awarding the most sub work, with their top subs. Click any name to search their portfolio.
              <strong style="color: var(--accent);">Top Subs</strong> — who's receiving sub work, with the primes they work under.<br><br>
              <strong style="color: var(--text-primary);">Search tips</strong><br>
              <em class="explainer-highlight">Click any vendor name to search their full federal footprint. Use the People/Jobs/News links to find contacts and openings.</em>
              <span id="subAndNote" style="display:none;"><br><br>
              <em class="explainer-highlight"><strong style="color: var(--text-primary);">AND searches:</strong> Subcontract data shows the broader market. The USASpending subaward API does not support AND filtering. Use the Prime view for precise AND-filtered totals.</em>
              </span>
            </div>
          </div>
        </div>

        <!-- 5. Sub Cards -->
        <div id="subFeedWrapper" style="display: none; margin-top: 1rem;">
          <div class="section-header">
            <div class="section-title-group">
              <span class="section-title">Recent Subcontracts</span>
            </div>
          </div>
          <div id="subFeedGrid" class="feed-grid"></div>
        </div>

      </div>

    </div> </div>
</div>
<div id="loader" class="loader">
  <div class="spinner"></div>
  <p id="loaderText" style="margin-top:1rem; font-family:'JetBrains Mono'; color:var(--accent);">RETRIEVING DATA...</p>
  <p id="loaderSubtext" style="color:var(--text-subtle); font-size:0.8rem; margin-top:0.5rem;"></p>
</div>



<script>
// ============================================================
// GOVHOO APPLICATION — Module Index
//
//   Utils ........................ Formatting, query parsing, filters
//   ModalUtils .................. Modal open/close/focus trap
//   VehicleDetector ............. GWAC/IDIQ/Vehicle pattern detection
//   VendorRelationships ......... Vendor tagging (mine/partner/competitor)
//   Autocomplete ................ Search autocomplete for agencies/vendors
//   API ......................... USASpending.gov API client
//   ForecastEngine .............. Spending analysis & recompete detection
//   KnownVendors ................ VAR/Prime classification database
//   JobLinks .................... LinkedIn/USAJobs URL generators
//   SkillsExtractor ............. Award description keyword extraction
//   App ......................... Core application state & rendering
//   Bubble/Treemap Charts ....... D3 visualization renderers
//   Presentation Mode ........... Light-theme screenshot toggle
// ============================================================

// ========================================
// SECTION 1: CONSTANTS & CONFIG
// ========================================
const US_STATES = {
  'AL':'Alabama','AK':'Alaska','AZ':'Arizona','AR':'Arkansas','CA':'California',
  'CO':'Colorado','CT':'Connecticut','DE':'Delaware','FL':'Florida','GA':'Georgia',
  'HI':'Hawaii','ID':'Idaho','IL':'Illinois','IN':'Indiana','IA':'Iowa',
  'KS':'Kansas','KY':'Kentucky','LA':'Louisiana','ME':'Maine','MD':'Maryland',
  'MA':'Massachusetts','MI':'Michigan','MN':'Minnesota','MS':'Mississippi','MO':'Missouri',
  'MT':'Montana','NE':'Nebraska','NV':'Nevada','NH':'New Hampshire','NJ':'New Jersey',
  'NM':'New Mexico','NY':'New York','NC':'North Carolina','ND':'North Dakota','OH':'Ohio',
  'OK':'Oklahoma','OR':'Oregon','PA':'Pennsylvania','RI':'Rhode Island','SC':'South Carolina',
  'SD':'South Dakota','TN':'Tennessee','TX':'Texas','UT':'Utah','VT':'Vermont',
  'VA':'Virginia','WA':'Washington','WV':'West Virginia','WI':'Wisconsin','WY':'Wyoming',
  'DC':'Washington DC','PR':'Puerto Rico','GU':'Guam','VI':'Virgin Islands'
};

// ========================================
// SECTION 2: LIBRARY LOADER (Smart Preloading)
// ========================================
const LibLoader = {
  d3Loaded: false,
  loading: { d3: null },
  
  async loadD3() {
    if (this.d3Loaded && window.d3 && window.d3.sankey) return Promise.resolve();
    if (this.loading.d3) return this.loading.d3;
    
    this.loading.d3 = new Promise((resolve, reject) => {
      const script1 = document.createElement('script');
      script1.src = 'https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js';
      script1.onload = () => {
        const script2 = document.createElement('script');
        script2.src = 'https://cdnjs.cloudflare.com/ajax/libs/d3-sankey/0.12.3/d3-sankey.min.js';
        script2.onload = () => { this.d3Loaded = true; resolve(); };
        script2.onerror = reject;
        document.head.appendChild(script2);
      };
      script1.onerror = reject;
      document.head.appendChild(script1);
    });
    return this.loading.d3;
  },
  
async ensureAll() {
    // Only wait for D3 since Chart.js is removed
    await this.loadD3();
  },
  
  // Preload during idle time - runs after page load for instant first search
  preloadWhenIdle() {
    if ('requestIdleCallback' in window) {
      requestIdleCallback(() => this.ensureAll(), { timeout: 2000 });
    } else {
      setTimeout(() => this.ensureAll(), 100);
    }
  }
};

// ========================================
// SECTION 3: UTILITIES
// ========================================
const Utils = {
  copyDealToClipboard(idx, btn) {
    const c = App.searchData.active[idx];
    if (!c) return;
    const internalId = c['generated_internal_id'];
    let url = '';
    if (internalId) url = `https://www.usaspending.gov/award/${internalId}`;
    const vehicle = VehicleDetector.detect(c['Award ID']);
    const setAside = VehicleDetector.getSetAsideLabel(c['Type of Set Aside']);
    const contractType = Utils.getContractTypeTag(c['Contract Award Type']);
    const text = [
      `Agency: ${c['Awarding Agency'] || 'N/A'}`,
      c['Awarding Sub Agency'] && c['Awarding Sub Agency'] !== c['Awarding Agency'] ? `Sub-Agency: ${c['Awarding Sub Agency']}` : null,
      `Vendor: ${c['Recipient Name'] || 'N/A'}`,
      `Obligated: ${Utils.money(c['Award Amount'])}`,
      
      `Description: ${(c['Description'] || 'N/A').substring(0, 200)}`,
      `Start: ${c['Start Date'] || 'N/A'}`,
      `End: ${c['End Date'] || 'N/A'}`,
      c['Award ID'] ? `Award ID: ${c['Award ID']}` : null,
      c['Last Modified Date'] ? `Last Modified: ${c['Last Modified Date']}` : null,
      contractType ? `Type: ${contractType.full}` : null,
      vehicle ? `Vehicle: ${vehicle.vehicle}` : null,
      setAside ? `Set-Aside: ${setAside}` : null,
      c['NAICS Code'] ? `NAICS: ${c['NAICS Code']} - ${c['NAICS Description'] || ''}` : null,
      c['PSC Code'] ? `PSC: ${c['PSC Code']} - ${c['PSC Description'] || ''}` : null,
      url ? `Link: ${url}` : null
    ].filter(Boolean).join('\n');
    navigator.clipboard.writeText(text).then(() => {
      if (btn) { btn.innerHTML = ''; btn.style.color = 'var(--accent)'; setTimeout(() => { btn.innerHTML = ''; btn.style.color = ''; }, 1500); }
    });
  },
  copySubDealToClipboard(dataStr, btn) {
    try {
      const s = JSON.parse(decodeURIComponent(dataStr));
      const url = s.prime_award_generated_internal_id ? `https://www.usaspending.gov/award/${s.prime_award_generated_internal_id}` : '';
      const text = [
        `Type: Subcontract`,
        `Agency: ${s['Awarding Agency'] || 'N/A'}`,
        `Prime: ${s['Prime Recipient Name'] || 'N/A'}`,
        `Subcontractor: ${s['Sub-Awardee Name'] || 'N/A'}`,
        `Amount: ${Utils.money(parseFloat(s['Sub-Award Amount']) || 0)}`,
        `Date: ${s['Sub-Award Date'] || 'N/A'}`,
        url ? `Prime Award: ${url}` : null
      ].filter(Boolean).join('\n');
      navigator.clipboard.writeText(text).then(() => {
        if (btn) { btn.innerHTML = ''; btn.style.color = 'var(--accent)'; setTimeout(() => { btn.innerHTML = ''; btn.style.color = ''; }, 1500); }
      });
    } catch(e) { console.error('Copy failed', e); }
  },
  copyRecompeteToClipboard(btn, agency, subAgency, vendor, amount, desc, start, end, awardId, psc, pscDesc, naics, naicsDesc, setAside, url) {
    const vehicle = VehicleDetector.detect(awardId);
    const setAsideLabel = VehicleDetector.getSetAsideLabel(setAside);
    const text = [
      `EXPIRING CONTRACT`,
      `Agency: ${agency || 'N/A'}`,
      subAgency && subAgency !== agency ? `Sub-Agency: ${subAgency}` : null,
      `Incumbent: ${vendor || 'N/A'}`,
      `Amount: ${amount}`,
      `Description: ${desc || 'N/A'}`,
      `Start: ${start || 'N/A'}`,
      `Expires: ${end || 'N/A'}`,
      awardId ? `Award ID: ${awardId}` : null,
      vehicle ? `Vehicle: ${vehicle.vehicle}` : null,
      setAsideLabel ? `Set-Aside: ${setAsideLabel}` : null,
      naics ? `NAICS: ${naics} - ${naicsDesc || ''}` : null,
      psc ? `PSC: ${psc} - ${pscDesc || ''}` : null,
      url ? `Link: ${url}` : null
    ].filter(Boolean).join('\n');
    navigator.clipboard.writeText(text).then(() => {
      if (btn) { btn.innerHTML = ''; btn.style.color = 'var(--accent)'; setTimeout(() => { btn.innerHTML = ''; btn.style.color = ''; }, 1500); }
    });
  },
  money: n => {
    if (!n && n !== 0) return '-';
    if(n >= 1e9) return '$' + (n/1e9).toFixed(1) + 'B';
    if(n >= 1e6) return '$' + (n/1e6).toFixed(1) + 'M';
    if(n >= 1e3) return '$' + (n/1e3).toFixed(0) + 'K';
    return '$' + Math.round(n).toLocaleString();
  },
  trunc: (s, l) => (s && s.length > l) ? s.substring(0,l)+'...' : (s || 'No Description'),
  date: s => s ? new Date(s).toLocaleDateString() : '—',
  formatDateISO: date => date.toISOString().split('T')[0],
  
  getCurrentFY: () => {
    const now = new Date();
    // Federal FY starts Oct 1 (Month 9)
    return now.getMonth() >= 9 ? now.getFullYear() + 1 : now.getFullYear();
  },

  getCurrentQuarter: () => {
    const m = new Date().getMonth(); // 0-11
    if (m >= 9) return 1;
    if (m <= 2) return 2;
    if (m <= 5) return 3;
    return 4;
  },
  
getColor: (() => {
  const palette = [
    '#466D5C', // 1. Gotham Green (The Hero - Base)
    '#7B6D8D', // 2. Villain Purple (Button Color - Promoted to top spot)
    '#5B7C99', // 3. Spidey Blue (Button Color - Promoted)
    '#E07A5F', // 4. Advertisement Orange (Button Color - Promoted)
    '#D98895', // 5. POW! Pink (Faded Magenta)
    '#3D405B', // 6. Inker's Navy (Dark Anchor)
    '#F2E8CF', // 3. Newsprint (The perfect Off-White/Cream paper)
    '#81B29A', // 8. Kryptonite Mist (Soft Green)
    '#778DA9', // 9. Blue-Grey Shadow (Halftone shading)
    '#606C38'  // 10. Army Surplus (Drab Olive)
  ];

  const assigned = new Map();
  let nextIdx = 0;

  const fn = name => {
    // Safety Check
    if (!name) return '#4A4A4A';

    // "Unknowns" get "Ink Stain" (Deep Charcoal)
    if (name.includes('Other') || name.includes('Unknown')) return '#353A40';
    
    if (!assigned.has(name)) assigned.set(name, nextIdx++);
    return palette[assigned.get(name) % palette.length];
  };

  fn.reset = () => { assigned.clear(); nextIdx = 0; };
  return fn;
})(),
queryAliases: {
  // Big Tech & Defense Primes
  'aws': 'Amazon',
  'gcp': 'Google Cloud',
  'msft': 'Microsoft',
  'ibm': 'International Business Machines',
  'hp': 'Hewlett Packard',
  'hpe': 'Hewlett Packard Enterprise',
  'dell': 'Dell Technologies',
  'gd': 'General Dynamics',
  'gdit': 'General Dynamics Information Technology',
  'lmco': 'Lockheed Martin',
  'ngc': 'Northrop Grumman',
  'bah': 'Booz Allen Hamilton',
  'saic': 'Science Applications International',
  
  // Cabinet Departments
  'dod': 'Department of Defense',
  'doj': 'Department of Justice',
  'dhs': 'Department of Homeland Security',
  'hhs': 'Health and Human Services',
  'dot': 'Department of Transportation',
  'doe': 'Department of Energy',
  'doi': 'Department of the Interior',
  'dol': 'Department of Labor',
  'doc': 'Department of Commerce',
  'dos': 'Department of State',
  'ed': 'Department of Education',
  'hud': 'Housing and Urban Development',
  'usda': 'Department of Agriculture',
  'va': 'Veterans Affairs',
  
  // Defense & Intel
  'army': 'Department of the Army',
  'navy': 'Department of the Navy',
  'usaf': 'Department of the Air Force',
  'ussf': 'Space Force',
  'usmc': 'Marine Corps',
  'cia': 'Central Intelligence Agency',
  'nsa': 'National Security Agency',
  'nga': 'National Geospatial-Intelligence Agency',
  'nro': 'National Reconnaissance Office',
  'dia': 'Defense Intelligence Agency',
  'disa': 'Defense Information Systems Agency',
  'darpa': 'Defense Advanced Research Projects Agency',
  'dcsa': 'Defense Counterintelligence and Security Agency',
  'dla': 'Defense Logistics Agency',
  'mda': 'Missile Defense Agency',
  'socom': 'Special Operations Command',
  'cybercom': 'Cyber Command',
  'stratcom': 'Strategic Command',
  'transcom': 'Transportation Command',
  'centcom': 'Central Command',
  'eucom': 'European Command',
  'indopacom': 'Indo-Pacific Command',
  'northcom': 'Northern Command',
  'southcom': 'Southern Command',
  'africom': 'Africa Command',
  
  // Major Agencies
  'gsa': 'General Services Administration',
  'nasa': 'National Aeronautics and Space Administration',
  'fbi': 'Federal Bureau of Investigation',
  'dea': 'Drug Enforcement Administration',
  'atf': 'Bureau of Alcohol Tobacco Firearms and Explosives',
  'usps': 'Postal Service',
  'irs': 'Internal Revenue Service',
  'epa': 'Environmental Protection Agency',
  'fda': 'Food and Drug Administration',
  'cdc': 'Centers for Disease Control and Prevention',
  'nih': 'National Institutes of Health',
  'cms': 'Centers for Medicare and Medicaid Services',
  'ssa': 'Social Security Administration',
  'opm': 'Office of Personnel Management',
  'sba': 'Small Business Administration',
  'fema': 'Federal Emergency Management Agency',
  'tsa': 'Transportation Security Administration',
  'cbp': 'Customs and Border Protection',
  'ice': 'Immigration and Customs Enforcement',
  'uscis': 'Citizenship and Immigration Services',
  'usss': 'Secret Service',
  'cisa': 'Cybersecurity and Infrastructure Security Agency',
  'faa': 'Federal Aviation Administration',
  'fhwa': 'Federal Highway Administration',
  'fra': 'Federal Railroad Administration',
  'fta': 'Federal Transit Administration',
  'noaa': 'National Oceanic and Atmospheric Administration',
  'nist': 'National Institute of Standards and Technology',
  'census': 'Census Bureau',
  'ita': 'International Trade Administration',
  'blm': 'Bureau of Land Management',
  'nps': 'National Park Service',
  'usfs': 'Forest Service',
  'fws': 'Fish and Wildlife Service',
  'usgs': 'Geological Survey',
  'bia': 'Bureau of Indian Affairs',
  'boem': 'Bureau of Ocean Energy Management',
  'bor': 'Bureau of Reclamation',
  'ferc': 'Federal Energy Regulatory Commission',
  'nnsa': 'National Nuclear Security Administration',
  'sec': 'Securities and Exchange Commission',
  'ftc': 'Federal Trade Commission',
  'fcc': 'Federal Communications Commission',
  'nlrb': 'National Labor Relations Board',
  'eeoc': 'Equal Employment Opportunity Commission',
  'gao': 'Government Accountability Office',
  'omb': 'Office of Management and Budget',
  'cbo': 'Congressional Budget Office',
  'nara': 'National Archives and Records Administration',
  'pbgc': 'Pension Benefit Guaranty Corporation',
  'usaid': 'Agency for International Development',
  'amtrak': 'Amtrak',
  'fdic': 'Federal Deposit Insurance Corporation',
  'ncua': 'National Credit Union Administration',
  'cfpb': 'Consumer Financial Protection Bureau',
  'exim': 'Export-Import Bank'
},
normalizeQuery(query) {
  const lower = query.toLowerCase().trim();
  return this.queryAliases[lower] || query;
},
  missionGapRisk(award) {
    const endDate = new Date(award['End Date']);
    const daysUntil = Math.ceil((endDate - new Date()) / (1000 * 60 * 60 * 24));

    const amt = parseFloat(award['Award Amount']) || 0;

    const desc = (award['Description'] || '').toLowerCase();
    const pscDesc = (award['PSC Description'] || '').toLowerCase();
    const naicsDesc = (award['NAICS Description'] || '').toLowerCase();
    const psc = (award['PSC Code'] || '').toUpperCase();

    // Ongoing support signals - tune this list over time
    const supportTerms = [
      'operations', 'o&m', 'maintenance', 'sustainment', 'help desk', 'service desk',
      'support services', 'managed services', 'hosting', 'cloud', 'network',
      'cyber', 'security', 'monitoring', 'soc', 'continuity', 'backup', 'dr', 'patch',
      'infrastructure', 'enterprise', 'mission', 'critical', '24/7', 'production'
    ];

    const text = `${desc} ${pscDesc} ${naicsDesc}`;
    const supportHits = supportTerms.filter(t => text.includes(t));
    const looksOperational = supportHits.length >= 2;

    // PSC shortcuts - common federal service families
    // D = IT/Data Processing, R = Professional Services, J = Maintenance/Repair
    const servicePscPrefixes = ['D', 'R', 'J'];
    const isServicePsc = servicePscPrefixes.includes(psc.slice(0, 1));

    // Risk logic
    if (daysUntil <= 180 && (looksOperational || isServicePsc) && amt >= 250000) {
      return { level: 'high', daysUntil, reasons: supportHits.slice(0, 4) };
    }
    if (daysUntil <= 365 && (looksOperational || isServicePsc) && amt >= 100000) {
      return { level: 'medium', daysUntil, reasons: supportHits.slice(0, 3) };
    }
    return { level: 'low', daysUntil, reasons: supportHits.slice(0, 2) };
  },
  
  // Normalize API response field names from elasticsearch_lookups.py keys to display names.
  // The spending_by_award endpoint returns data keyed by contracts_mapping field names.
  // base_mapping uses snake_case: 'naics_code', 'psc_code', 'psc_description', etc.
  // The rest of the app uses display names: 'NAICS Code', 'PSC Code', etc.
  // This normalizer is the SINGLE translation point.
  normalizeAwardFields(awards) {
    const fieldMap = {
      'naics_code': 'NAICS Code',
      'naics_description': 'NAICS Description',
      'psc_code': 'PSC Code',
      'psc_description': 'PSC Description',
      'pop_city_name': 'Place of Performance City',
      'pop_state_code': 'Place of Performance State',
    };
    return awards.map(a => {
      const normalized = { ...a };
      for (const [apiKey, displayKey] of Object.entries(fieldMap)) {
        if (apiKey in a) {
          normalized[displayKey] = a[apiKey];
          // Keep original key too for backward compat
        }
      }
      return normalized;
    });
  },

  // Filter out completed/closeout contracts from API results.
  // The time_period filter matches any contract with an action_date in the window,
  // including $0 closeout mods on massive old contracts. This removes those ghosts.
  // Uses Last Modified Date (base_mapping: last_modified_date) as secondary recency signal.
  filterActiveContracts(awards) {
    const now = new Date();
    const grace = new Date();
    grace.setDate(grace.getDate() - 90);
    const recentMod = new Date();
    recentMod.setDate(recentMod.getDate() - 30);
    return awards.filter(a => {
      const endStr = a['End Date'];
      if (!endStr) return true;
      const end = new Date(endStr);
      if (isNaN(end.getTime())) return true;
      if (end > now) return true; // Still active
      // Ended recently — check if substantial or recently modified (extension/follow-on signal)
      if (end > grace) {
        if ((parseFloat(a['Award Amount']) || 0) > 10000) return true;
        // Recently modified past-end contract = likely extension in progress
        const modStr = a['Last Modified Date'];
        if (modStr) { const mod = new Date(modStr); if (!isNaN(mod.getTime()) && mod > recentMod) return true; }
        return false;
      }
      return false; // Ended 90+ days ago = closeout artifact
    });
  },

  // Contract type labels from lookups.py contract_type_mapping
  getContractTypeTag(typeDesc) {
    if (!typeDesc) return null;
    const t = typeDesc.toLowerCase();
    if (t.includes('definitive')) return { short: 'DEF', full: 'Definitive Contract' };
    if (t.includes('delivery')) return { short: 'DO', full: 'Delivery Order' };
    if (t.includes('purchase')) return { short: 'PO', full: 'Purchase Order' };
    if (t.includes('bpa call')) return { short: 'BPA', full: 'BPA Call' };
    if (t.includes('blanket')) return { short: 'BPA', full: 'Blanket Purchase Agreement' };
    if (t.includes('indefinite')) return { short: 'IDC', full: typeDesc };
    if (t.includes('gwac')) return { short: 'GWAC', full: typeDesc };
    return { short: typeDesc.substring(0, 4).toUpperCase(), full: typeDesc };
  },

  // Consolidated search term parser - eliminates duplication across API methods
  parseSearchTerms(keywords) {
    const pscPattern = /^[A-Z]{1,2}\d{1,3}$|^\d{1,2}[A-Z]\d{0,2}$/i;
    const naicsPattern = /^\d{6}$/; // NAICS codes are exactly 6 digits
    
    // AND operator: + or uppercase AND only (lowercase "and" stays in the phrase, e.g. "command and control")
    const hasAndOperator = keywords.includes('+') || /\bAND\b/.test(keywords);
    
    // Strip legal suffixes BEFORE comma-split so "FOUR POINTS TECHNOLOGY, LLC" doesn't become two terms
    const cleaned = keywords
      .replace(/,?\s*(L\.?L\.?C\.?|INC\.?|CORP\.?|CORPORATION|INCORPORATED|COMPANY|CO\.?|LTD\.?|L\.?P\.?|P\.?C\.?|P\.?L\.?L\.?C\.?)\.?(?=\s*,|\s*$|\s+AND\b|\s*\+)/gi, '')
      .replace(/,\s*$/, '')
      .trim();
    
    const terms = cleaned.split(',').map(s => s.trim()).filter(s => s.length > 0);
    const pscCodes = terms.filter(t => pscPattern.test(t)).map(t => t.toUpperCase());
    const naicsCodes = terms.filter(t => naicsPattern.test(t));
    const keywordTerms = terms.filter(t => !pscPattern.test(t) && !naicsPattern.test(t));
    
    // Parse AND groups: "Air Force + Cloud" or "Air Force AND Cloud"
    let andGroups = [];
    if (hasAndOperator) {
      keywordTerms.forEach(term => {
        const parts = term.split(/\+|\bAND\b/).map(s => s.trim()).filter(s => s.length > 0);
        if (parts.length > 1) {
          // Expand aliases on each part (e.g. "DHS" -> "Department of Homeland Security")
          const expanded = parts.map(p => Utils.normalizeQuery(p));
          andGroups.push(expanded);
        }
      });
    }
    
    return { pscCodes, naicsCodes, keywordTerms, allTerms: terms, andGroups };
  },
  
  // Build filters for API calls - consolidates filter building logic
  buildFilters(keywords, timePeriods) {
    const { pscCodes, naicsCodes, keywordTerms, andGroups } = this.parseSearchTerms(keywords);
    const filters = { time_period: timePeriods, award_type_codes: API.CONTRACT_TYPES };
    
    // If AND query with codes, build combined filter
    if (andGroups.length > 0) {
      const group = andGroups[0];
      const pscPat = /^[A-Z]{1,2}\d{1,3}$|^\d{1,2}[A-Z]\d{0,2}$/i;
      const naicsPat = /^\d{6}$/;
      const kws = [];
      group.forEach(term => {
        if (naicsPat.test(term)) { filters.naics_codes = filters.naics_codes || []; filters.naics_codes.push(term); }
        else if (pscPat.test(term)) { filters.psc_codes = filters.psc_codes || []; filters.psc_codes.push(term.toUpperCase()); }
        else kws.push(term);
      });
      if (kws.length > 0) filters.keywords = kws;
      return filters;
    }
    
    if (pscCodes.length > 0) filters.psc_codes = pscCodes;
    if (naicsCodes.length > 0) filters.naics_codes = naicsCodes;
    if (keywordTerms.length > 0) filters.keywords = keywordTerms;
    if (!filters.psc_codes && !filters.naics_codes && !filters.keywords) filters.keywords = [keywords];
    return filters;
  }
};

// ==================== MODAL UTILITIES ====================
const ModalUtils = {
  activeModal: null,
  previousFocus: null,
  _boundKeydown: null,
  _boundClick: null,

  open(modalId) {
    const modal = document.getElementById(modalId);
    if (!modal) return;

    // 1. Safety: If another modal is open, close it first to prevent overlap
    if (this.activeModal && this.activeModal !== modal) {
      this.close();
    }

    // 2. Store trigger element to restore focus later
    this.previousFocus = document.activeElement;

    // 3. Lock Body Scroll (Prevents background scrolling while modal is open)
    document.body.style.overflow = 'hidden';

    // 4. Activate Modal
    // We use requestAnimationFrame to ensure the CSS transition triggers beautifully
    requestAnimationFrame(() => {
      modal.classList.add('active');
    });

    this.activeModal = modal;

    // 5. Smart Focus
    // We focus the first input, but use preventScroll to stop the page jumping on mobile
    const focusable = modal.querySelector('input, select, textarea, button:not(.modal-close)');
    if (focusable) {
      // Small delay ensures the modal is visible before we try to focus
      setTimeout(() => {
        focusable.focus({ preventScroll: true });
      }, 50);
    }

    // 6. Bind Events
    this._boundKeydown = this.handleKeydown.bind(this);
    this._boundClick = this.handleClick.bind(this);

    document.addEventListener('keydown', this._boundKeydown);
    modal.addEventListener('click', this._boundClick);
  },

  close() {
    if (!this.activeModal) return;

    const modal = this.activeModal;

    // 1. Deactivate
    modal.classList.remove('active');

    // 2. Unlock Body Scroll
    document.body.style.overflow = '';

    // 3. Cleanup Events
    document.removeEventListener('keydown', this._boundKeydown);
    modal.removeEventListener('click', this._boundClick);

    // 4. Restore Focus to the button that opened the modal
    if (this.previousFocus && typeof this.previousFocus.focus === 'function') {
      this.previousFocus.focus({ preventScroll: true });
    }

    // Reset state
    this.activeModal = null;
    this.previousFocus = null;
  },

  // Centralized Click Handler
  // Handles both Backdrop clicks AND "Close/Cancel" buttons automatically
  handleClick(e) {
    // 1. Backdrop Click (Close if clicking outside content)
    if (e.target === this.activeModal) {
      this.close();
      return;
    }

    // 2. Auto-Close for any element with these classes
    // This saves you from writing manual onclick="" handlers for every X button
    if (e.target.closest('.modal-close') || e.target.closest('.modal-btn-cancel')) {
      this.close();
    }
  },

  handleKeydown(e) {
    // 1. ESC to Close
    if (e.key === 'Escape') {
      this.close();
      return;
    }

    // 2. Focus Trap (Keeps Tab cycle inside the modal)
    if (e.key === 'Tab' && this.activeModal) {
      const focusables = this.activeModal.querySelectorAll(
        'button:not([disabled]), input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"])'
      );
      
      if (focusables.length === 0) return;

      const first = focusables[0];
      const last = focusables[focusables.length - 1];

      // Shift+Tab on first element -> wrap to last
      if (e.shiftKey && document.activeElement === first) {
        e.preventDefault();
        last.focus();
      } 
      // Tab on last element -> wrap to first
      else if (!e.shiftKey && document.activeElement === last) {
        e.preventDefault();
        first.focus();
      }
    }
  }
};
// ==================== AUTOCOMPLETE ====================
const VehicleDetector = {
  // GWAC/IDIQ/Vehicle detection from Award ID (PIID) prefixes
  patterns: [
    { prefix: /^GS-35F/i, vehicle: 'GSA Schedule', short: 'GSA' },
    { prefix: /^GS-00F/i, vehicle: 'GSA Schedule', short: 'GSA' },
    { prefix: /^GS-07F/i, vehicle: 'GSA Schedule', short: 'GSA' },
    { prefix: /^GS-\d{2}F/i, vehicle: 'GSA Schedule', short: 'GSA' },
    { prefix: /^47Q[A-Z]{2}A/i, vehicle: 'OASIS+', short: 'OASIS+' },
    { prefix: /^47QTCA/i, vehicle: 'OASIS', short: 'OASIS' },
    { prefix: /^47QTCK/i, vehicle: 'OASIS SB', short: 'OASIS SB' },
    { prefix: /^GS-06F/i, vehicle: 'ALLIANT 2', short: 'ALLIANT' },
    { prefix: /^HC102[89]/i, vehicle: 'CIO-SP3', short: 'CIO-SP3' },
    { prefix: /^HC1013/i, vehicle: 'CIO-SP4', short: 'CIO-SP4' },
    { prefix: /^W15QKN/i, vehicle: 'Army ITES', short: 'ITES' },
    { prefix: /^W52P1J/i, vehicle: 'Army CHESS', short: 'CHESS' },
    { prefix: /^FA870[12]/i, vehicle: 'NETCENTS', short: 'NETCENTS' },
    { prefix: /^N0017[89]/i, vehicle: 'SeaPort', short: 'SEAPORT' },
    { prefix: /^N00189/i, vehicle: 'SeaPort-NxG', short: 'SEAPORT' },
    { prefix: /^47QFCA/i, vehicle: '8(a) STARS III', short: 'STARS III' },
    { prefix: /^47QFSA/i, vehicle: '8(a) STARS III', short: 'STARS III' },
    { prefix: /^HHSN/i, vehicle: 'NIH CIO-SP', short: 'NIH' },
    { prefix: /^75N98/i, vehicle: 'NIH NITAAC', short: 'NITAAC' },
    { prefix: /^VA118/i, vehicle: 'VA T4NG', short: 'T4NG' },
    { prefix: /^36C10X/i, vehicle: 'VA VETS 2', short: 'VETS 2' },
  ],
  
  detect(awardId) {
    if (!awardId) return null;
    for (const p of this.patterns) {
      if (p.prefix.test(awardId)) return p;
    }
    return null;
  },
  
  // Set-aside code to human-readable label
  setAsideLabels: {
    'SBA': '8(a)', '8A': '8(a)', '8AN': '8(a)',
    'HZC': 'HUBZone', 'HZS': 'HUBZone',
    'WOSB': 'WOSB', 'EDWOSB': 'EDWOSB',
    'SDVOSBC': 'SDVOSB', 'SDVOSBS': 'SDVOSB',
    'SBP': 'Small Biz', 'SMP': 'Small Biz',
    'VSA': 'VOSB', 'VSB': 'VOSB',
    'HS2': 'HUBZone SB', 'HS3': 'HUBZone/8(a)',
    'ISBEE': 'Econ. Disadv.', 'IEE': 'Econ. Disadv.',
  },
  
  getSetAsideLabel(code) {
    if (!code) return null;
    return this.setAsideLabels[code] || (code.length <= 10 ? code : null);
  }
};

const VendorRelationships = {
  // States: null (unset), 'mine', 'partner', 'competitor'
  _map: {},
  
  get(vendorName) {
    return this._map[vendorName.toUpperCase()] || null;
  },
  
  cycle(vendorName) {
    const key = vendorName.toUpperCase();
    const states = [null, 'mine', 'partner', 'competitor'];
    const current = this._map[key] || null;
    const idx = states.indexOf(current);
    const next = states[(idx + 1) % states.length];
    if (next) this._map[key] = next;
    else delete this._map[key];
    return next;
  },
  
  getIcon(state) {
    if (state === 'mine') return { icon: 'fas fa-building', color: 'var(--accent)', label: 'My Company', bg: 'rgba(95,128,85,0.15)' };
    if (state === 'partner') return { icon: 'fas fa-handshake', color: 'var(--info)', label: 'Partner', bg: 'rgba(141,160,203,0.15)' };
    if (state === 'competitor') return { icon: 'fas fa-crosshairs', color: '#A64438', label: 'Competitor', bg: 'rgba(166,68,56,0.15)' };
    return { icon: 'fas fa-tag', color: 'var(--text-muted)', label: 'Tag vendor', bg: 'transparent' };
  },
  
  // Get all tagged vendors grouped by relationship
  getTagged() {
    const result = { mine: [], partner: [], competitor: [] };
    Object.entries(this._map).forEach(([name, rel]) => {
      if (result[rel]) result[rel].push(name);
    });
    return result;
  }
};

const Autocomplete = {
  activeInput: null,
  dropdown: null,
  debounceTimer: null,
  selectedIndex: -1,
  results: { agencies: [], recipients: [] },
  
init(inputId) {
  const input = document.getElementById(inputId);
  if (!input) return;
  
  // Wrap input if not already wrapped
  if (!input.parentElement.classList.contains('autocomplete-wrapper')) {
    const wrapper = document.createElement('div');
    wrapper.className = 'autocomplete-wrapper';
    input.parentNode.insertBefore(wrapper, input);
    wrapper.appendChild(input);
  }
  
  // Create dropdown
  const dropdown = document.createElement('div');
  dropdown.className = 'autocomplete-dropdown';
  dropdown.id = `${inputId}-dropdown`;
  input.parentElement.appendChild(dropdown);
  
  // Event listeners
  input.addEventListener('input', (e) => this.handleInput(e, inputId));
  input.addEventListener('keydown', (e) => this.handleKeydown(e, inputId));
  input.addEventListener('focus', (e) => this.handleFocus(e, inputId));
  input.addEventListener('blur', () => setTimeout(() => this.hide(inputId), 200));
},
  
  handleInput(e, inputId) {
    const query = e.target.value.trim();
    clearTimeout(this.debounceTimer);
    
    if (query.length < 2) {
      this.hide(inputId);
      return;
    }
    
    this.debounceTimer = setTimeout(() => this.search(query, inputId), 250);
  },
  
  handleFocus(e, inputId) {
    const query = e.target.value.trim();
    if (query.length >= 2 && this.hasResults()) {
      this.show(inputId);
    }
  },
  
  handleKeydown(e, inputId) {
    const dropdown = document.getElementById(`${inputId}-dropdown`);
    if (!dropdown || !dropdown.classList.contains('active')) {
      if (e.key === 'ArrowDown' && e.target.value.length >= 2) {
        this.search(e.target.value.trim(), inputId);
      }
      return;
    }
    
    const items = dropdown.querySelectorAll('.autocomplete-item');
    
    if (e.key === 'ArrowDown') {
      e.preventDefault();
      this.selectedIndex = Math.min(this.selectedIndex + 1, items.length - 1);
      this.updateSelection(items);
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      this.selectedIndex = Math.max(this.selectedIndex - 1, 0);
      this.updateSelection(items);
    } else if (e.key === 'Enter' && this.selectedIndex >= 0) {
      e.preventDefault();
      items[this.selectedIndex]?.click();
    } else if (e.key === 'Escape') {
      this.hide(inputId);
    }
  },
  
  updateSelection(items) {
    items.forEach((item, i) => {
      item.classList.toggle('selected', i === this.selectedIndex);
    });
    items[this.selectedIndex]?.scrollIntoView({ block: 'nearest' });
  },
  
  async search(query, inputId) {
    try {
      const [agencies, recipients] = await Promise.all([
        API.autocompleteAgency(query),
        API.autocompleteRecipient(query)
      ]);
      
      this.results = { agencies, recipients };
      this.selectedIndex = -1;
      this.render(inputId);
    } catch (e) {
      console.error('Autocomplete error:', e);
    }
  },
  
  hasResults() {
    return this.results.agencies.length > 0 || 
           this.results.recipients.length > 0;
  },
  
  render(inputId) {
    const dropdown = document.getElementById(`${inputId}-dropdown`);
    if (!dropdown) return;
    
    const { agencies, recipients } = this.results;
    
    if (!this.hasResults()) {
      dropdown.innerHTML = '<div class="autocomplete-empty">No matches found</div>';
      this.show(inputId);
      return;
    }
    
    let html = '';
    
    if (agencies.length > 0) {
      html += `<div class="autocomplete-section">
        <div class="autocomplete-section-label mono muted upper"> Agencies</div>
        ${agencies.slice(0, 5).map(a => `
          <div class="autocomplete-item" data-type="agency" data-value="${this.escapeHtml(a.subtier_agency?.name || a.toptier_agency?.name || '')}">
            
            <div class="autocomplete-item-text">
              <div class="autocomplete-item-main truncate">${this.escapeHtml(a.subtier_agency?.name || a.toptier_agency?.name || 'Unknown')}</div>
              ${a.toptier_agency?.name && a.subtier_agency?.name ? `<div class="autocomplete-item-sub muted">${this.escapeHtml(a.toptier_agency.name)}</div>` : ''}
            </div>
          </div>
        `).join('')}
      </div>`;
    }
    
    if (recipients.length > 0) {
      html += `<div class="autocomplete-section">
        <div class="autocomplete-section-label mono muted upper"> Vendors & Keywords</div>
        ${recipients.slice(0, 5).map(r => `
          <div class="autocomplete-item" data-type="recipient" data-value="${this.escapeHtml(r.recipient_name || '')}">
            
            <div class="autocomplete-item-text">
              <div class="autocomplete-item-main truncate">${this.escapeHtml(r.recipient_name || 'Unknown')}</div>
              ${r.uei ? `<div class="autocomplete-item-sub muted">UEI: ${r.uei}</div>` : ''}
            </div>
          </div>
        `).join('')}
      </div>`;
    }
    
    dropdown.innerHTML = html;
    
    // Add click handlers
    dropdown.querySelectorAll('.autocomplete-item').forEach(item => {
      item.addEventListener('click', () => {
        const input = document.getElementById(inputId);
        if (input) {
          input.value = item.dataset.value;
          input.focus();
        }
        this.hide(inputId);
      });
    });
    
    this.show(inputId);
  },
  
  show(inputId) {
    const dropdown = document.getElementById(`${inputId}-dropdown`);
    if (dropdown) dropdown.classList.add('active');
  },
  
  hide(inputId) {
    const dropdown = document.getElementById(`${inputId}-dropdown`);
    if (dropdown) dropdown.classList.remove('active');
    this.selectedIndex = -1;
  },
  
  escapeHtml(str) {
    if (!str) return '';
    return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
  }
};

// ==================== API ====================
const API = {
  baseUrl: 'https://api.usaspending.gov/api/v2',

  // lookups.py contract_type_mapping: A=BPA Call, B=Purchase Order, C=Delivery Order, D=Definitive Contract
  CONTRACT_TYPES: ['A', 'B', 'C', 'D'],

  // All ES-backed fields — no enrichment needed. Returns at scale.
  AWARD_FIELDS: [
    'Award ID', 'Recipient Name', 'Recipient UEI',
    'Awarding Agency', 'Awarding Sub Agency', 'Funding Agency', 'Funding Sub Agency',
    'Award Amount', 'Total Outlays',
    'Description', 'generated_internal_id',
    'Start Date', 'End Date', 'Last Modified Date',
    'Contract Award Type', 'Type Set Aside', 'Extent Competed',
    'naics_code', 'naics_description', 'psc_code', 'psc_description',
    'parent_award_id',                          // Vehicle detection (SEWP, STARS, etc.)
    'recipient_parent_name',                    // Parent company rollup
    'potential_total_value_of_award',           // Contract ceiling → burn rate
    'number_of_offers_received'                 // Actual bidder count on cards
  ],
  
  // Search Mode API
  async searchAwards(keywords) {
    const today = new Date();
    const oneYearAgo = new Date();
    oneYearAgo.setFullYear(today.getFullYear() - 1);
    
    const period = {
      start_date: Utils.formatDateISO(oneYearAgo),
      end_date: Utils.formatDateISO(today)
    };
    
    const { pscCodes, naicsCodes, keywordTerms, andGroups } = Utils.parseSearchTerms(keywords);
    
    // AND search: hybrid approach
    if (andGroups.length > 0) {
      const group = andGroups[0];
      const pscPat = /^[A-Z]{1,2}\d{1,3}$|^\d{1,2}[A-Z]\d{0,2}$/i;
      const naicsPat = /^\d{6}$/;
      const codes = [];
      const kws = [];
      group.forEach(term => {
        if (naicsPat.test(term)) codes.push({ type: 'naics', value: term });
        else if (pscPat.test(term)) codes.push({ type: 'psc', value: term.toUpperCase() });
        else kws.push(term);
      });
      
      if (codes.length > 0) {
        const filters = { time_period: [period], award_type_codes: this.CONTRACT_TYPES };
        codes.forEach(c => {
          if (c.type === 'naics') { filters.naics_codes = filters.naics_codes || []; filters.naics_codes.push(c.value); }
          else { filters.psc_codes = filters.psc_codes || []; filters.psc_codes.push(c.value); }
        });
        if (kws.length > 0) filters.keywords = kws;
        const res = await fetch(`${this.baseUrl}/search/spending_by_award/`, {
          method: 'POST', headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ filters, fields: this.AWARD_FIELDS, limit: 100, sort: 'Award Amount', order: 'desc' })
        });
        return Utils.filterActiveContracts(Utils.normalizeAwardFields((await res.json()).results || []));
      } else {
        const andPromises = kws.map(term => {
          const filters = { time_period: [period], award_type_codes: this.CONTRACT_TYPES, keywords: [term] };
          return fetch(`${this.baseUrl}/search/spending_by_award/`, {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ filters, fields: this.AWARD_FIELDS, limit: 100, sort: 'Award Amount', order: 'desc' })
          }).then(res => res.json());
        });
        const andResults = await Promise.all(andPromises);
        const pool = new Map();
        andResults.forEach(json => {
          if (json.results) json.results.forEach(a => { if (!pool.has(a['Award ID'])) pool.set(a['Award ID'], a); });
        });
        const filtered = [];
        pool.forEach(award => {
          const haystack = [
            award['Recipient Name'], award['Awarding Agency'], award['Awarding Sub Agency'],
            award['Description'], award['NAICS Description'], award['PSC Description'], award['Award ID']
          ].filter(Boolean).join(' ').toLowerCase();
          if (kws.every(term => haystack.includes(term.toLowerCase()))) filtered.push(award);
        });
        return Utils.filterActiveContracts(Utils.normalizeAwardFields(filtered.sort((a,b) => b['Award Amount'] - a['Award Amount'])));
      }
    }
    
    // Collapse OR search: USASpending filters treat arrays as native OR.
    // Instead of N calls (one per term), group by type and send at most 3 calls.
    const groups = {};
    [...pscCodes.map(t => ({ type: 'psc', value: t })),
     ...naicsCodes.map(t => ({ type: 'naics', value: t })),
     ...keywordTerms.map(t => ({ type: 'keyword', value: t }))
    ].forEach(({ type, value }) => {
      if (!groups[type]) groups[type] = [];
      groups[type].push(value);
    });

    const fetchPromises = Object.entries(groups).map(([type, values]) => {
      const filters = { time_period: [period], award_type_codes: this.CONTRACT_TYPES };
      if (type === 'psc') filters.psc_codes = values;
      else if (type === 'naics') filters.naics_codes = values;
      else filters.keywords = values;
      return fetch(`${this.baseUrl}/search/spending_by_award/`, {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ filters, fields: this.AWARD_FIELDS, limit: 100, sort: 'Award Amount', order: 'desc' })
      }).then(res => res.json());
    });
    
    const results = await Promise.all(fetchPromises);
    let combined = [];
    results.forEach(json => { if(json.results) combined = combined.concat(json.results); });
    const unique = new Map();
    combined.forEach(item => { if(!unique.has(item['Award ID'])) unique.set(item['Award ID'], item); });
    
    return Utils.filterActiveContracts(Utils.normalizeAwardFields(Array.from(unique.values()).sort((a,b) => b['Award Amount'] - a['Award Amount'])));
  },
  
  // Forecast Mode APIs

  // Native sub-agency metrics from spending_by_category/awarding_subagency (sub_agency.py)
  // Returns REAL obligation totals per sub-agency — not derived from top-100 results.
  // Only called on agency drill-down, not on every search.
  async getSubAgencyData(keywords, agencyName) {
    const curFY = Utils.getCurrentFY();
    const filters = Utils.buildFilters(keywords, [{ start_date: `${curFY - 1}-10-01`, end_date: `${curFY}-09-30` }]);
    if (agencyName) filters.agencies = [{ type: 'awarding', tier: 'toptier', name: agencyName }];
    const res = await fetch(`${this.baseUrl}/search/spending_by_category/awarding_subagency`, {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ category: 'awarding_subagency', filters, limit: 50 })
    });
    return (await res.json()).results || [];
  },

  // getAwardsForForecast REMOVED — searchAwards now fetches AWARD_FIELDS.
  // getSBShare REMOVED — audience is senior federal BD, they know their vehicle landscape.


  async autocompleteAgency(searchText) {
    if (!searchText || searchText.length < 2) return [];
    const res = await fetch(`${this.baseUrl}/autocomplete/awarding_agency/`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ search_text: searchText, limit: 8 })
    });
    return (await res.json()).results || [];
  },
  
  // Fetch contracting offices for a sub-agency
  async fetchOfficesForSubAgency(subAgencyName) {
    try {
      const res = await fetch(`${this.baseUrl}/autocomplete/awarding_agency_office/`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ search_text: subAgencyName, limit: 50 })
      });
      const data = await res.json();
      // Extract offices from the response - structure has subtier_agency with offices array
      const offices = [];
      if (data.results) {
        data.results.forEach(result => {
          // Check if this is a subtier_agency match
          if (result.subtier_agency && result.subtier_agency.name === subAgencyName && result.subtier_agency.offices) {
            result.subtier_agency.offices.forEach(office => {
              offices.push({ code: office.code, name: office.name });
            });
          }
          // Also check toptier_agency offices
          if (result.toptier_agency && result.toptier_agency.offices) {
            result.toptier_agency.offices.forEach(office => {
              offices.push({ code: office.code, name: office.name });
            });
          }
          // Direct office match
          if (result.office) {
            offices.push({ code: result.office.code, name: result.office.name });
          }
        });
      }
      return offices;
    } catch (e) {
      console.error('Error fetching offices:', e);
      return [];
    }
  },

  async autocompleteRecipient(searchText) {
    if (!searchText || searchText.length < 2) return [];
    const res = await fetch(`${this.baseUrl}/autocomplete/recipient/`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ search_text: searchText, limit: 8 })
    });
    return (await res.json()).results || [];
  },

  // ==================== SPENDING BY GEOGRAPHY ====================

  // ==================== SUBAWARDS ====================
  async getSubawards(keywords) {
    const today = new Date();
    const oneYearAgo = new Date();
    oneYearAgo.setFullYear(today.getFullYear() - 1);
    
    const timePeriod = [{
      start_date: Utils.formatDateISO(oneYearAgo),
      end_date: Utils.formatDateISO(today)
    }];
    
    // Use buildFilters which handles AND, PSC, NAICS, and keywords
    const filters = Utils.buildFilters(keywords, timePeriod);
    
    const res = await fetch(`${this.baseUrl}/search/spending_by_award/`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        subawards: true,
        filters,
        fields: [
          'Sub-Award ID', 'Sub-Awardee Name', 'Sub-Award Amount', 
          'Prime Award ID', 'Prime Recipient Name', 'Sub-Award Date',
          'Awarding Agency', 'Awarding Sub Agency',
          'prime_award_generated_internal_id'
        ],
        limit: 100,
        sort: 'Sub-Award Amount',
        order: 'desc'
      })
    });
    return (await res.json()).results || [];
  }
};

// ==================== GEOGRAPHY MAP ====================

// ==================== EXPIRING CONTRACTS DETECTION ====================
const ForecastEngine = {
  detectRecompetes(awards) {
    const now = new Date();
    const twoYears = new Date(); twoYears.setFullYear(now.getFullYear()+2);
    return awards
      .filter(a => {
        const end = new Date(a['End Date']);
        return end > now && end < twoYears && a['Award Amount'] > 50000;
      })
      .sort((a, b) => new Date(a['End Date']) - new Date(b['End Date']))
      .slice(0, 15);
  }
};

// ==================== KNOWN VENDORS DATABASE ====================
const KnownVendors = {
  // Known VARs/Resellers
  vars: new Set([
    'CARAHSOFT TECHNOLOGY CORP', 'CARAHSOFT TECHNOLOGY CORPORATION',
    'CDW GOVERNMENT LLC', 'CDW-G',
    'SHI INTERNATIONAL CORP', 'SHI GOVERNMENT SOLUTIONS',
    'INSIGHT PUBLIC SECTOR INC', 'INSIGHT DIRECT USA INC',
    'GOVPLACE, LLC', 'GOVPLACE LLC',
    'IMMIX GROUP INC', 'IMMIXGROUP INC',
    'DLT SOLUTIONS LLC', 'DLT SOLUTIONS',
    'THUNDERCAT TECHNOLOGY, LLC', 'THUNDERCAT TECHNOLOGY LLC',
    'WORLD WIDE TECHNOLOGY LLC', 'WWT GOVERNMENT SERVICES',
    'PRESIDIO NETWORKED SOLUTIONS', 'PRESIDIO GOVERNMENT SOLUTIONS',
    'CONNECTION', 'PC CONNECTION', 'PCMG INC',
    'EN POINTE TECHNOLOGIES',
    'STERLING COMPUTERS CORPORATION', 'STERLING COMPUTERS',
    'MERLIN INTERNATIONAL', 'RED RIVER TECHNOLOGY',
    'MYTHICS INC', 'MYTHICS LLC',
    'FOUR POINTS TECHNOLOGY', 'FOUR POINTS TECHNOLOGY LLC',
    'SILOTECH GROUP INC', 'DECISIVE COMMUNICATIONS INC',
    'FCN INC', 'FCN, INC.',
    'SOFTCHOICE CORPORATION', 'SOFTCHOICE',
    'TRACE3', 'OPTIV SECURITY INC', 'OPTIV SECURITY',
    'FEDSTORE CORPORATION', 'FEDSTORE',
    'GOVSMART INC', 'GOVSMART, INC.',
    'NEW TECH SOLUTIONS', 'NEW TECH SOLUTIONS, INC.',
    'PANAMERICA COMPUTERS', 'PANAMERICA COMPUTERS, INC.',
    'SOFTWARE INFORMATION RESOURCE CORP',
    'ACCESSAGILITY LLC', 'BLUE TECH INC', 'BLUE TECH INC.',
    'DH TECHNOLOGIES', 'DH TECHNOLOGIES, INC.',
    'IT1 SOURCE LLC',
    'ENTERPRISE TECHNOLOGY SOLUTIONS', 'ENTERPRISE TECHNOLOGY SOLUTIONS, INC.',
    'DISTRIBUTED TECHNOLOGY GROUP LLC', 'ARCHITECHTURE SOLUTIONS LLC',
    'ADVANCED COMPUTER CONCEPTS', 'ADVANCED COMPUTER CONCEPTS, INC.',
    '4 STAR TECHNOLOGIES', '4 STAR TECHNOLOGIES, INC.',
    'THREE WIRE SYSTEMS', 'THREE WIRE SYSTEMS, LLC',
    'C & C INTERNATIONAL COMPUTERS'
  ]),

  // Known Large Primes/System Integrators
  primes: new Set([
    'BOOZ ALLEN HAMILTON', 'BOOZ ALLEN HAMILTON INC',
    'GENERAL DYNAMICS INFORMATION TECHNOLOGY', 'GENERAL DYNAMICS IT', 'GDIT',
    'LEIDOS INC', 'LEIDOS HOLDINGS', 'LEIDOS',
    'SAIC', 'SCIENCE APPLICATIONS INTERNATIONAL',
    'NORTHROP GRUMMAN', 'RAYTHEON',
    'LOCKHEED MARTIN', 'LOCKHEED MARTIN CORPORATION',
    'BAE SYSTEMS', 'L3HARRIS TECHNOLOGIES',
    'CACI INTERNATIONAL', 'CACI INC',
    'MANTECH INTERNATIONAL', 'MANTECH',
    'PERATON INC', 'PERATON',
    'ACCENTURE FEDERAL SERVICES', 'ACCENTURE',
    'DELOITTE CONSULTING', 'DELOITTE',
    'IBM CORPORATION', 'IBM', 'KPMG',
    'CGI FEDERAL', 'CGI TECHNOLOGIES',
    'MAXIMUS INC', 'MAXIMUS FEDERAL',
    'ICF INTERNATIONAL', 'ICF INC',
    'SERCO INC', 'SERCO',
    'PAE INCORPORATED', 'AMENTUM',
    'JACOBS TECHNOLOGY', 'KBR INC'
  ]),

  // Classify a vendor name
  classify(vendorName) {
    const upper = vendorName.toUpperCase().trim();
    
    // Check exact matches first
    if (this.vars.has(upper)) return 'var';
    if (this.primes.has(upper)) return 'prime';
    
    // Check partial matches
    for (const known of this.vars) {
      if (upper.includes(known) || known.includes(upper)) return 'var';
    }
    for (const known of this.primes) {
      if (upper.includes(known) || known.includes(upper)) return 'prime';
    }
    
    // Pattern-based detection for likely VARs
    const varPatterns = [
      /\b(TECHNOLOGY|TECHNOLOGIES)\s*(CORP|LLC|INC)/i,
      /\b(COMPUTERS?|COMPUTING)\s*(CORP|LLC|INC)/i,
      /\bSOLUTIONS?\s*(CORP|LLC|INC)/i,
      /\bGOV(PLACE|SMART|STORE)/i,
      /\bFEDERAL\s*(SOLUTIONS|TECHNOLOGY)/i
    ];
    
    for (const pattern of varPatterns) {
      if (pattern.test(upper)) return 'likely_var';
    }
    
    return 'unknown';
  }
};

// ==================== JOB SEEKER UTILITIES ====================
const JobLinks = {
  // Known parent company names - if vendor starts with these, just use the parent name
  knownBrands: [
    'KBR', 'SAIC', 'CACI', 'LEIDOS', 'SERCO', 'AECOM', 'JACOBS', 'PARSONS', 
    'MAXIMUS', 'ICF', 'CGI', 'IBM', 'DELL', 'HP', 'CISCO', 'ORACLE', 'GOOGLE',
    'AMAZON WEB', 'MICROSOFT', 'ACCENTURE FEDERAL', 'DELOITTE', 'KPMG', 'PWC', 'EY',
    'PERATON', 'AMENTUM', 'MANTECH', 'BAE SYSTEMS', 'RAYTHEON', 'BOEING', 'AIRBUS',
    'HONEYWELL', 'HARRIS', 'TEXTRON', 'VERIZON', 'ATT', 'AT&T', 'SPRINT',
    'PALANTIR', 'ANDURIL', 'CROWDSTRIKE', 'SPLUNK', 'VMWARE', 'SALESFORCE',
    'SERVICENOW', 'SNOWFLAKE', 'DATABRICKS', 'ELASTIC', 'GITLAB', 'ATLASSIAN'
  ],
  
  // Multi-word brand names that need OR with abbreviation
  brandAliases: {
    'BOOZ ALLEN': 'BAH',
    'GENERAL DYNAMICS': 'GDIT',
    'NORTHROP GRUMMAN': 'NGC',
    'LOCKHEED MARTIN': 'LMCO',
    'L3HARRIS': 'L3 HARRIS',
    'L3 HARRIS': 'L3HARRIS',
    'WORLD WIDE TECHNOLOGY': 'WWT',
    'RED HAT': 'REDHAT',
    'PALO ALTO': 'PANW'
  },

  // Shared logic for cleaning vendor names
  cleanVendorName(vendorName) {
    let cleanName = vendorName
      .replace(/,?\s*(LLC|INC|CORP|CORPORATION|INCORPORATED|L\.L\.C\.|L\.P\.|LP|LTD|LIMITED|CO\.)\.?\s*$/gi, '')
      .replace(/\s+/g, ' ')
      .trim();
    
    const upperName = cleanName.toUpperCase();
    
    // Check if it starts with a known single-word brand
    for (const brand of this.knownBrands) {
      if (upperName === brand || upperName.startsWith(brand + ' ')) {
        return brand;
      }
    }
    
    // Check for known multi-word brand aliases
    for (const [brand, alias] of Object.entries(this.brandAliases)) {
      if (upperName.startsWith(brand)) {
        return brand;
      }
    }
    
    return cleanName;
  },

  // Generate LinkedIn job search URL
  getLinkedInUrl(vendorName) {
    const cleanName = this.cleanVendorName(vendorName);
    return `https://www.linkedin.com/jobs/search/?keywords=${encodeURIComponent(cleanName)}&f_C=`;
  },
  
  // Generate LinkedIn people search URL - finds contacts at a company
  getLinkedInPeopleUrl(vendorName, roleKeywords = '') {
    const cleanName = this.cleanVendorName(vendorName);
    let searchQuery = roleKeywords ? `"${cleanName}" ${roleKeywords}` : cleanName;
    return `https://www.linkedin.com/search/results/people/?keywords=${encodeURIComponent(searchQuery)}&origin=GLOBAL_SEARCH_HEADER`;
  },
  // Generate LinkedIn content/news search URL
getLinkedInNewsUrl(searchTerm) {
  const cleanName = typeof searchTerm === 'string' ? this.cleanVendorName(searchTerm) : searchTerm;
  return `https://www.linkedin.com/search/results/content/?keywords=${encodeURIComponent(cleanName)}`;
}
};
const SkillsExtractor = {
  // Stopwords and boilerplate terms to ignore
  _stop: new Set([
    'the','and','for','that','this','with','from','are','was','were','will','has','have','had',
    'not','but','all','can','her','his','its','our','they','been','each','which','their','said',
    'use','may','than','other','into','some','could','them','only','then','also','over','such',
    'after','before','these','more','would','about','between','through','under','being','during',
    'services','service','support','provide','providing','provides','provided','including','include',
    'includes','based','related','various','shall','must','per','using','used','non','new','work',
    'contract','contractor','government','agency','federal','award','acquisition','task','order',
    'option','period','base','year','years','fiscal','fy24','fy25','fy23','fy22','fy26',
    'igf','igt','igf::ot::igf','igf::ct::igf','continued','continue','exercise','modification',
    'inc','llc','corp','ltd','company','group','systems','solutions','technologies',
    'total','amount','funded','funding','obligated','estimated','approximately','pursuant',
    'addition','additional','added','update','updated','existing','current','ensure',
    'management','operations','operational','program','project','specific','require',
    'required','requirements','department','office','national','center','united','states',
    'necessary','needed','resources','within','without','above','below','following','general',
    'activities','activity','efforts','effort','performance','mission','critical','executive'
  ]),

  // Extract the most frequent meaningful terms from award text
  extract(awards) {
    const phraseCounts = {};  // phrase -> number of awards containing it
    const phraseExamples = {};
    const total = awards.length;
    if (!total) return [];

    awards.forEach(award => {
      const desc = (award['Description'] || '').toLowerCase();
      const psc = (award['PSC Description'] || '').toLowerCase();
      const naics = (award['NAICS Description'] || '').toLowerCase();
      const text = `${desc} ${psc} ${naics}`;

      // Tokenize: strip colons first (kills IGF::OT::IGF), then keep alphanumeric and hyphens
      const words = text.replace(/:+/g, ' ').replace(/[^a-z0-9\-]+/g, ' ').split(/\s+/).filter(w => w.length > 2 && !this._stop.has(w));

      // Collect unique bigrams and trigrams from this award
      const seen = new Set();

      // Meaningful single words (only longer domain-specific ones, 8+ chars to avoid generic noise)
      words.forEach(w => {
        if (w.length >= 8 && !this._stop.has(w)) {
          seen.add(w);
        }
      });

      // Bigrams
      for (let i = 0; i < words.length - 1; i++) {
        const bg = `${words[i]} ${words[i+1]}`;
        if (!this._stop.has(words[i]) && !this._stop.has(words[i+1])) {
          seen.add(bg);
        }
      }

      // Trigrams
      for (let i = 0; i < words.length - 2; i++) {
        const tg = `${words[i]} ${words[i+1]} ${words[i+2]}`;
        if (!this._stop.has(words[i]) && !this._stop.has(words[i+2])) {
          seen.add(tg);
        }
      }

      seen.forEach(phrase => {
        phraseCounts[phrase] = (phraseCounts[phrase] || 0) + 1;
        if (!phraseExamples[phrase]) {
          phraseExamples[phrase] = (award['Description'] || '').substring(0, 100);
        }
      });
    });

    // Require phrase to appear in at least 2 awards or 5% of results (whichever is lower)
    const minCount = Math.max(2, Math.ceil(total * 0.03));

    // Score: prefer multi-word phrases, penalize very short single words
    let candidates = Object.entries(phraseCounts)
      .filter(([phrase, count]) => count >= Math.min(minCount, 2))
      .map(([phrase, count]) => {
        const wordCount = phrase.split(' ').length;
        // Boost multi-word phrases so "jet engine maintenance" beats "maintenance"
        const boost = wordCount >= 3 ? 1.5 : wordCount === 2 ? 1.2 : 1.0;
        return { phrase, count, score: count * boost };
      })
      .sort((a, b) => b.score - a.score);

    // Deduplicate: if a longer phrase contains a shorter one with similar count, drop the shorter
    const results = [];
    const used = new Set();
    for (const c of candidates) {
      if (results.length >= 5) break;
      // Check if this phrase is a substring of an already-selected longer phrase
      let dominated = false;
      for (const r of results) {
        if (r.phrase.includes(c.phrase) || c.phrase.includes(r.phrase)) {
          // Keep the one with higher count, skip the other
          if (c.count <= r.count * 1.3) { dominated = true; break; }
        }
      }
      if (dominated) continue;
      results.push(c);
    }

    // Titlecase the phrases for display
    const titleCase = s => s.replace(/\b\w/g, c => c.toUpperCase());

    return results.map(r => ({
      skill: r.phrase.toUpperCase(),
      count: r.count,
      percentage: Math.round((r.count / total) * 100),
      example: phraseExamples[r.phrase] || ''
    }));
  }
};

// ==================== APP CORE ====================
// ==================== SIGNAL ENGINE ====================
// Computes directional signals from ES search data. No enrichment calls.
// IMPORTANT: Data is top 100 by obligation. Signals describe where the MONEY is,
// not the full market. Framing reflects this honestly.

const App = {
  mode: 'search', 
  currentQuery: '',
  searchData: { raw: [], active: [], filter: null, loaded: false },
  forecastData: { spending: null, agencies: null, awards: null, analysis: null, loaded: false },
  drillState: { level: 0, path: [], currentAgency: null, currentSubAgency: null },
  subawardDrillState: { level: 0, path: [], filter: null, filterType: null },
  activeFeedSource: 'prime', // 'prime' or 'sub' - tracks which Sankey the user is interacting with
  onlyHighMissionGap: false,

// =======================================================================
  // ⚡ AI ACCOUNT INTELLIGENCE BRIEF (Data Analyst Persona)
  // =======================================================================
  AI_ENDPOINT: 'https://76unm1rlj0.execute-api.us-east-1.amazonaws.com/default/grumpy2', 

  async runAiActionPlan() {

  const banner = document.getElementById('aiIntelligenceBanner');
  const panel = document.getElementById('aiActionPanel');
  const content = document.getElementById('aiContentContainer');
  const btn = document.getElementById('triggerAiPlanBtn');
  const copyBtn = document.getElementById('copyAiBtn');

  if (!App.searchData || !App.searchData.active || App.searchData.active.length === 0) {
      alert("Please run a search first to gather account data.");
      return;
  }

  if (banner) banner.style.display = 'none';
  panel.style.display = 'block';
  panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
  copyBtn.style.display = 'none';

  btn.innerHTML = 'Synthesizing...';
  btn.disabled = true;

  content.innerHTML = `...loading skeleton...`;

  const summaryPayload = PromptPackageGenerator.buildPackage(
      App.searchData.active,
      App.forecastData?.analysis
  );

  try {

      const res = await fetch(App.AI_ENDPOINT, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
              request_type: 'govhoo_action_plan',
              market_data: summaryPayload,
              objective: 'Account Intelligence'
          })
      });

      if (!res.ok) throw new Error(`Gateway Error: ${res.status}`);

      const data = await res.json();
      if (data.error) throw new Error(data.error);

      const strategicText = data.strategic_read;
      if (!strategicText) throw new Error("Invalid AI response format.");

      let renderedHtml;

      if (window.marked) {
          renderedHtml = marked.parse(strategicText);
      } else {
          const escape = (str) =>
              str.replace(/[&<>"']/g, m =>
                  ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;' }[m])
              );

          renderedHtml = `
              <pre style="white-space: pre-wrap; font-family: 'JetBrains Mono', monospace;">
              ${escape(strategicText)}
              </pre>
          `;
      }

      content.innerHTML = `
          <div class="ai-result-section strategic-read">
              ${renderedHtml}
          </div>
      `;

      content.dataset.rawPlan = strategicText;
      copyBtn.style.display = 'inline-block';

  } catch (e) {

      console.error("AI Error:", e);

      const safeMessage = (e.message || "Unknown error")
          .replace(/[&<>"']/g, m =>
              ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;' }[m])
          );

      content.innerHTML = `
          <div style="color: #ff6b6b; font-size: 13px;">
              Briefing failed: ${safeMessage}
          </div>
      `;

  } finally {

      btn.innerHTML = 'Unlock Brief';
      btn.disabled = false;
  }
},
  init() {

    
    // Initialize Autocomplete
    Autocomplete.init('mainSearchInput');
    Autocomplete.init('miniSearch');
    
    // Setup Event Delegation for all data-action handlers
    this.setupEventDelegation();
    
    // Legacy event listeners for inputs
document.getElementById('mainSearchInput').addEventListener('keypress', e => { if(e.key === 'Enter') App.runSearch(); });
document.getElementById('miniSearch').addEventListener('keypress', e => { if(e.key === 'Enter') { document.getElementById('mainSearchInput').value = e.target.value; App.runSearch(e.target.value); } });

// Select all text on focus for easy replacement
document.getElementById('mainSearchInput').addEventListener('focus', function() { this.select(); });
document.getElementById('miniSearch').addEventListener('focus', function() { this.select(); });

// Show/hide clear button for main search only
function setupClearButton(inputId, buttonClass) {
  const input = document.getElementById(inputId);
  const btn = document.querySelector('.' + buttonClass);
  if (!input || !btn) return;
  
  // Move button inside the autocomplete wrapper
  const wrapper = input.closest('.autocomplete-wrapper');
  if (wrapper && btn.parentNode !== wrapper) {
    wrapper.appendChild(btn);
  }
  
  const toggle = () => btn.classList.toggle('visible', input.value.length > 0);
  input.addEventListener('input', toggle);
  input.addEventListener('change', toggle);
  toggle();
}
setupClearButton('mainSearchInput', 'input-clear');

    let resizeTimer;
    window.addEventListener('resize', () => { 
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(() => { 
        // Skip expensive re-renders if a modal is covering the screen
        
        
        if(App.mode === 'search' && App.searchData?.active?.length > 0) {
          App.renderSankey(); 
        }
        // Always try to re-render subaward Sankey if data exists and wrapper is visible
        const subawardWrapper = document.getElementById('subawardWrapper');
        if(App.forecastData?.subawards && subawardWrapper && subawardWrapper.style.display !== 'none') {
          App.renderSubawardSankey(App.forecastData.subawards);
        }
      }, 250); 
    });

    // Preload visualization libraries during idle time
    LibLoader.preloadWhenIdle();

    const params = new URLSearchParams(window.location.search);
    const q = params.get('q');
    const mode = params.get('mode');

    if (q) {
      document.getElementById('mainSearchInput').value = q;
      App.runSearch(q);
    }
  },
  
  // Event Delegation - handles all data-action clicks
  setupEventDelegation() {
    document.addEventListener('click', (e) => {
      const target = e.target.closest('[data-action]');
      if (!target) return;
      
      const action = target.dataset.action;
      const actions = {
        'search': () => this.runSearch(),
        'forecast': () => this.runForecast(),
        'showHero': () => this.showHero(),
        'resetDrill': () => this.resetDrill(),
        'clearFilter': () => this.resetDrill(),
        'shareLink': () => this.shareLink(target),
        'shareBrief': () => this.shareBrief(target),
        'exportCSV': () => this.exportCSV(target),
        'resetSubawardDrill': () => this.resetSubawardDrill(),
      };
      
      if (actions[action]) {
        e.preventDefault();
        actions[action]();
      }
    });
  },

  showHero() {
    document.getElementById('appView').style.display = 'none';
    const hero = document.getElementById('heroView'); hero.style.display = 'flex'; hero.classList.remove('hidden');
    setTimeout(() => hero.classList.remove('slide-up'), 10);
  },

  setMode() {
    App.mode = 'search';
    document.getElementById('searchModeView')?.classList.add('active');
  },


  // --- Search Mode ---
  async runSearch(val) {
    let query = val || document.getElementById('mainSearchInput').value; if(!query) return;
	query = Utils.normalizeQuery(query.toUpperCase());
  document.getElementById('mainSearchInput').value = query;
  document.title = `Govhoo | ${query.toUpperCase()}`;
    if(query !== App.currentQuery) { App.searchData = { raw: [], active: [], filter: null, loaded: false }; App.forecastData = { loaded: false }; App.searchGeoData = null; App.resetDrill(); App.subawardDrillState = { level: 0, path: [], filter: null, filterType: null }; }
    App.currentQuery = query; App.mode = 'search'; App.showLoader('SCANNING ' + query.toUpperCase(), 'Pulling live awards from USASpending.gov');
    try {
      // Ensure D3 is loaded for Sankey (preloaded during idle, so usually instant)
      await LibLoader.loadD3();
      App.searchData.raw = await API.searchAwards(query); App.searchData.active = App.searchData.raw; App.searchData.loaded = true;
      App.transitionToApp(); App.setMode('search'); App.updateSearchDashboard(); requestAnimationFrame(() => { App.renderSankey(); App.renderVehiclePills(); App.renderPrimeReach(); });
      // Background data enrichment — coordinated, rate-limited, with data-ready signal.
      // Each call fires sequentially to respect API rate limits, but the orchestrator
      // ensures renderStrategyTools only fires once ALL dependencies are ready.
      this.loadBackgroundData(query);
    } catch(e) { console.error(e); alert("Error retrieving data."); } finally { App.hideLoader(); }
  },

  async loadBackgroundData(query) {
    // Expiring contracts — computed from existing search data, no API call
    this.loadForecastInBackground(query);

    // Background API call: subs only
    try {
      await this.loadSubcontractingData(query);
    } catch(e) { console.warn('Background data failure:', e); }
  },

  // Background forecast loading — runs after search, populates strategy tools + spending chart + recompetes
  // OPTIMIZATION: Reuses searchData.raw from searchAwards() instead of making a duplicate
  // getAwardsForForecast call. searchAwards now fetches AWARD_FIELDS which includes
  // 'Potential Total Value of Award' — the only field forecast previously needed separately.
  async loadForecastInBackground(query) {
    // Expiring contracts detection — uses searchData.raw directly, no extra API calls needed
    if (!query) return;
    const awards = App.searchData.raw || [];
    const recompetes = ForecastEngine.detectRecompetes(awards);
    App.forecastData = {
      analysis: { recompetes },
      subawards: App.forecastData?.subawards || null,
      loaded: true
    };
    App.renderStrategyTools();
  },

  // Render strategy tools, spending chart, expiring stat, and recompetes into search view
  renderStrategyTools() {
    // Forecast-dependent items: GTM, Pipeline, Recompetes
    const analysis = App.forecastData && App.forecastData.analysis;
    if (!analysis) return;

    // Show GTM Plan + Pipeline Builder buttons in action bar

    // Determine drill-filtered recompetes
    const allRecompetes = analysis.recompetes || [];
    const drill = App.drillState || {};
    let filteredRecompetes = allRecompetes;
    if (drill.level >= 1 && drill.currentAgency) {
      filteredRecompetes = allRecompetes.filter(r => r['Awarding Agency'] === drill.currentAgency);
      if (drill.level >= 2 && drill.currentSubAgency) {
        filteredRecompetes = filteredRecompetes.filter(r => r['Awarding Sub Agency'] === drill.currentSubAgency);
      }
    }

    // Render recompetes (filtered)
    this.renderRecompetes(filteredRecompetes);
  },

  // Re-fetch or re-use spending data based on drill state
  updateSearchDashboard() {
    const data = App.searchData.active;
    const totalObligations = data.reduce((acc, c) => acc + (c['Award Amount']||0), 0);
    document.getElementById('stat-vol').innerText = Utils.money(totalObligations);
    document.getElementById('stat-count').innerText = data.length;
    document.getElementById('stat-vendors').innerText = new Set(data.map(c => c['Recipient Name'])).size;
    document.getElementById('stat-agencies').innerText = new Set(data.map(c => c['Awarding Agency'])).size;

    // #5 Mod recency — market health signal
    const healthEl = document.getElementById('marketHealth');
    if (healthEl) {
      const now = new Date();
      const d90 = new Date(); d90.setDate(d90.getDate() - 90);
      let recent = 0;
      data.forEach(c => {
        const mod = c['Last Modified Date'] ? new Date(c['Last Modified Date']) : null;
        if (mod && !isNaN(mod.getTime()) && mod > d90) recent++;
      });
      if (recent > 0) {
        const pct = Math.round(recent / data.length * 100);
        const signal = pct > 70 ? 'Active — programs are funded and moving' 
          : pct > 40 ? 'Moderate — some programs active, some dormant' 
          : 'Low activity — most contracts idle';
        healthEl.innerHTML = `<strong style="color:${pct > 70 ? 'var(--accent)' : pct > 40 ? 'var(--warning, #FDD835)' : 'var(--text-muted)'};">${pct}%</strong> of contracts modified in last 90 days · ${signal}`;
      } else {
        healthEl.innerHTML = '';
      }
    }

    App.renderFeed(); App.updateDrillUI();

    // Compute and render directional signals
    
    // Update Job Seeker Panels (dynamically based on active/filtered data)
	App.renderSearchTopBuyers(data);
    App.renderNaicsMix(data);
    
    // Render Bubble Chart
    App.renderBubbleChart();
    
    // Refresh strategy tools (spending chart from search data, recompetes if forecast loaded)
    App.renderStrategyTools();
    
    // Enable Conversation Starters button
    // Update sankey subtitle with query context
    const subEl = document.getElementById('sankeySubtitle');
    if (subEl && App.currentQuery) {
      subEl.textContent = '"' + App.currentQuery.toUpperCase() + '" · TOP 100 ACTIVE CONTRACTS · LIFETIME FUNDED VALUE';
    }
    
    // Show data explainer boxes
    const primeExpl = document.getElementById('primeExplainerBox');
    if (primeExpl) primeExpl.style.display = 'block';
    const subExpl = document.getElementById('subExplainerBox');
    if (subExpl) subExpl.style.display = 'block';
    
    // Show AND note in sub explainer if AND query is active
    const subAndNote = document.getElementById('subAndNote');
    if (subAndNote) {
      const { andGroups } = Utils.parseSearchTerms(App.currentQuery || '');
      subAndNote.style.display = andGroups.length > 0 ? 'inline' : 'none';
    }
    
    // Add loaded animation to sankey
    const sankeyEl = document.getElementById('sankeyPanel');
    if (sankeyEl) sankeyEl.classList.add('sankey-loaded');
    
  },

  // --- Drill Down Logic ---
  resetDrill() { 
    App.drillState = { level: 0, path: [], currentAgency: null, currentSubAgency: null }; 
    App.searchData.filter = null; 
    App.searchData.active = App.searchData.raw;
    App.nativeSubAgencyData = null;
    App.activeFeedSource = 'prime';
    App.activeVehicleFilter = null;
    App.bubbleMode = 'auto';
    const officesPanel = document.getElementById('officesPanel');
    if (officesPanel) officesPanel.style.display = 'none'; 
    App.updateSearchDashboard(); 
    App.renderSankey(); 
  },

  // === COMPETITIVE FOOTPRINT ===
  // Run a fresh search for a specific vendor — see their entire federal portfolio
  viewFootprint(vendorName) {
    const clean = Utils.cleanVendorName ? Utils.cleanVendorName(vendorName) : vendorName.replace(/,?\s*(L\.?L\.?C\.?|INC\.?|CORP\.?|CORPORATION|INCORPORATED|COMPANY|CO\.?|LTD\.?|L\.?P\.?|P\.?C\.?|P\.?L\.?L\.?C\.?)\.?\s*$/gi, '').trim();
    if (!clean || clean.length < 2) return;
    document.getElementById('mainSearchInput').value = clean;
    document.getElementById('miniSearch').value = clean;
    App.runSearch(clean);
  },

  // === VEHICLE FILTER ===
  // Filter the entire view to show only task orders on a specific vehicle
  activeVehicleFilter: null,

  filterByVehicle(parentId, label) {
    if (App.activeVehicleFilter === parentId) {
      this.clearVehicleFilter();
      return;
    }
    App.activeVehicleFilter = parentId;
    App.searchData.active = App.searchData.raw.filter(c => c['parent_award_id'] === parentId);
    App.searchData.filter = label;
    App.activeFeedSource = 'prime';
    App.updateSearchDashboard();
    App.renderSankey();
    App.renderVehiclePills(); // Re-render to show active state
  },

  clearVehicleFilter() {
    App.activeVehicleFilter = null;
    App.searchData.filter = null;
    App.searchData.active = App.searchData.raw;
    App.activeFeedSource = 'prime';
    App.updateSearchDashboard();
    App.renderSankey();
    App.renderVehiclePills();
  },

  renderVehiclePills() {
    const bar = document.getElementById('vehicleFilterBar');
    const container = document.getElementById('vehiclePills');
    if (!bar || !container) return;

    const data = App.searchData.raw || [];
    const vehicles = {};

    data.forEach(c => {
      const pid = c['parent_award_id'];
      if (!pid || pid === 'NONE') return;
      const label = VehicleDetector.detectVehicle(pid)?.short || pid;
      if (!vehicles[pid]) vehicles[pid] = { pid, label, count: 0, amount: 0 };
      vehicles[pid].count++;
      vehicles[pid].amount += parseFloat(c['Award Amount']) || 0;
    });

    const sorted = Object.values(vehicles).sort((a, b) => b.amount - a.amount);

    // Only show if there are vehicles with 2+ orders
    const meaningful = sorted.filter(v => v.count >= 2);
    if (meaningful.length === 0) {
      bar.style.display = 'none';
      return;
    }

    bar.style.display = 'block';
    const top = meaningful.slice(0, 8);
    const active = App.activeVehicleFilter;

    container.innerHTML = top.map(v => {
      const isActive = active === v.pid;
      return `<button onclick="App.filterByVehicle('${v.pid.replace(/'/g, "\\'")}', '${v.label.replace(/'/g, "\\'")}')"
        style="padding: 0.2rem 0.5rem; font-family: 'JetBrains Mono', monospace; font-size: 0.6rem;
        background: ${isActive ? 'var(--accent)' : 'rgba(255,255,255,0.07)'}; 
        color: ${isActive ? '#000' : 'var(--text-muted)'};
        border: 1px solid ${isActive ? 'var(--accent)' : 'var(--border)'}; border-radius: 4px; 
        cursor: pointer; transition: all 0.15s; white-space: nowrap;"
        title="${v.pid} · ${v.count} orders · ${Utils.money(v.amount)}">${v.label} <span style="opacity:0.6">${v.count}</span></button>`;
    }).join('') + (active ? `<button onclick="App.clearVehicleFilter()" 
      style="padding: 0.2rem 0.5rem; font-family: 'JetBrains Mono', monospace; font-size: 0.6rem;
      background: rgba(239,83,80,0.15); color: var(--danger); border: 1px solid rgba(239,83,80,0.3); 
      border-radius: 4px; cursor: pointer;">Clear</button>` : '');
  },

  // === PRIME REACH ===
  // Primes ranked by agency breadth — "who gives you the most reach?"
  // Built from prime search data, not subawards. No extra API call.
  renderPrimeReach() {
    const panel = document.getElementById('teamingPanel');
    const list = document.getElementById('teamingList');
    if (!panel || !list) return;

    const data = App.searchData.raw || [];
    if (data.length === 0) { panel.style.display = 'none'; return; }

    // Map each vendor to their agencies and sub-agencies
    const vendorMap = {};
    data.forEach(c => {
      const vendor = c['Recipient Name'] || 'Unknown';
      const agency = c['Awarding Agency'] || '';
      const subAgency = c['Awarding Sub Agency'] || '';
      const amt = parseFloat(c['Award Amount']) || 0;

      if (!vendorMap[vendor]) vendorMap[vendor] = { name: vendor, agencies: {}, subAgencies: new Set(), totalAmt: 0, count: 0 };
      vendorMap[vendor].totalAmt += amt;
      vendorMap[vendor].count++;
      if (agency) {
        if (!vendorMap[vendor].agencies[agency]) vendorMap[vendor].agencies[agency] = 0;
        vendorMap[vendor].agencies[agency] += amt;
      }
      if (subAgency) vendorMap[vendor].subAgencies.add(subAgency);
    });

    // Top 5 primes by spend — sorted by agency diversity first, then spend
    const ranked = Object.values(vendorMap)
      .sort((a, b) => Object.keys(b.agencies).length - Object.keys(a.agencies).length || b.totalAmt - a.totalAmt)
      .slice(0, 5);

    if (ranked.length === 0) { panel.style.display = 'none'; return; }

    panel.style.display = 'block';
    const esc = (s) => s.replace(/'/g, "\\'").replace(/"/g, '&quot;');

    list.innerHTML = ranked.map(v => {
      const agencyCount = Object.keys(v.agencies).length;
      const subCount = v.subAgencies.size;
      const topAgencies = Object.entries(v.agencies)
        .sort((a, b) => b[1] - a[1])
        .map(([name]) => name.replace(/^Department of (the )?/i, '').replace(/^Office of (the )?/i, ''));

      return `<div class="reach-row" onclick="App.viewFootprint('${esc(v.name)}')" title="Search ${v.name}'s full federal portfolio">
        <div style="min-width: 0; flex: 1;">
          <div style="display: flex; align-items: center; gap: 0.4rem; flex-wrap: wrap;">
            <span class="reach-name">${Utils.trunc(v.name, 28)}</span>
            <span class="reach-badge accent">${agencyCount} ${agencyCount === 1 ? 'agency' : 'agencies'}</span>
            ${subCount > agencyCount ? `<span class="reach-badge">${subCount} offices</span>` : ''}
          </div>
          <div class="reach-meta">
            ${topAgencies.slice(0, 3).map(a => Utils.trunc(a, 20)).join(' · ')}${topAgencies.length > 3 ? ` +${topAgencies.length - 3}` : ''}
          </div>
          <div class="job-links" style="margin-top: 0.25rem;" onclick="event.stopPropagation();">
            <a href="${JobLinks.getLinkedInPeopleUrl(v.name)}" target="_blank" class="job-link"> People</a>
            <a href="${JobLinks.getLinkedInUrl(v.name)}" target="_blank" class="job-link"> Jobs</a>
            <a href="${JobLinks.getLinkedInNewsUrl(v.name)}" target="_blank" class="job-link"> News</a>
          </div>
        </div>
        <div style="text-align: right; flex-shrink: 0;">
          <div class="reach-amount">${Utils.money(v.totalAmt)}</div>
          <div class="reach-count">${v.count} awards</div>
        </div>
      </div>`;
    }).join('');
  },
  
  updateDrillUI() {
  const bc = document.getElementById('drillBreadcrumb'); 
  const hint = document.getElementById('drillHint'); 
  const lvl = document.getElementById('drillLevelBadge');
  const levelText = document.getElementById('drillLevelText');
  const officesPanel = document.getElementById('officesPanel');
  const drillControlsBar = document.getElementById('drillControlsBar');
  const filterBadge = document.getElementById('filterBadge');

  if (App.drillState.level === 0) {
    if (drillControlsBar) drillControlsBar.style.display = 'none';
    hint.style.display = 'none'; 
    const _sp = document.getElementById('subagencyPanel'); if(_sp) _sp.style.display = 'none';
    if (officesPanel) officesPanel.style.display = 'none';
    if (filterBadge) filterBadge.style.display = 'none';
  } else {
    if (drillControlsBar) drillControlsBar.style.display = 'block';
    bc.style.display = 'flex'; 
    lvl.style.display = 'inline-flex';
    if (filterBadge && App.searchData.filter) {
      filterBadge.style.display = 'inline-flex';
      document.getElementById('filterName').innerText = Utils.trunc(App.searchData.filter, 20);
    } else if (filterBadge) {
      filterBadge.style.display = 'none';
    }
    
    // Set appropriate badge text
    if (App.drillState.level === 1) levelText.innerText = 'Agency View';
    else if (App.drillState.level === 2) levelText.innerText = 'Sub-Agency View';
    else if (App.drillState.level === 3) levelText.innerText = 'Vendor Perspective';

    let html = `<div class="breadcrumb-item" data-action="resetDrill"><span>All Agencies</span></div>`;
    
    App.drillState.path.forEach((p, i) => {
      const isLast = i === App.drillState.path.length - 1;
      const action = isLast ? '' : `App.drillToLevel(${i + 1})`;
      html += `
        <span class="breadcrumb-separator"></span>
        <div class="breadcrumb-item ${isLast ? 'active' : ''}" onclick="${action}">
          <span>${Utils.trunc(p.name, 25)}</span>
        </div>`;
    });
    bc.innerHTML = html; 

    if (App.drillState.level === 1) { 
      hint.innerHTML = `<span>Click a <strong>sub-agency</strong> or <strong>vendor</strong> to refine</span>`; 
      App.renderSubAgencyPanel();
      if (officesPanel) officesPanel.style.display = 'none';
    } else if (App.drillState.level === 2) {
      App.renderSubAgencyPanel();
      if (officesPanel) officesPanel.style.display = 'none';
      hint.innerHTML = `<span>Viewing <strong>sub-agency</strong> breakdown</span>`; 
    } else { 
      const _sp = document.getElementById('subagencyPanel'); if(_sp) _sp.style.display = 'none';
      if (officesPanel) officesPanel.style.display = 'none';
      hint.innerHTML = `<span>Viewing filtered breakdown</span>`; 
    }
  }
},

  renderSubAgencyPanel() {
    // Sub-agency display now handled by Top Agency Buyers panel
  },

  drillToAgency(name) {
  App.drillState = { 
    level: 1, 
    currentAgency: name, 
    currentSubAgency: null, 
    path: [{type: 'agency', name: name}] 
  };
  App.searchData.active = App.searchData.raw.filter(d => d['Awarding Agency'] === name);
  App.searchData.filter = name;
  App.activeFeedSource = 'prime';
  if (App.bubbleMode !== 'vendors' && App.bubbleMode !== 'agencies') App.bubbleMode = 'auto';
  App.updateSearchDashboard();
  App.renderSankey();
  // Fetch native sub-agency data for accurate obligation totals (non-blocking)
  if (App.currentQuery) {
    API.getSubAgencyData(App.currentQuery, name).then(data => {
      if (data && data.length > 0 && App.drillState.currentAgency === name) {
        App.nativeSubAgencyData = data;
        App.renderSearchTopBuyers(App.searchData.active);
      }
    }).catch(e => console.warn('Native sub-agency fetch failed:', e));
  }
},

drillToSubAgency(name) {
  App.drillState.level = 2;
  App.drillState.currentSubAgency = name;
  // Re-build path from the current agency and new sub-agency
  App.drillState.path = [
    {type: 'agency', name: App.drillState.currentAgency}, 
    {type: 'sub', name: name}
  ];
  // Filter from raw
  App.searchData.active = App.searchData.raw.filter(d => 
    d['Awarding Agency'] === App.drillState.currentAgency && 
    d['Awarding Sub Agency'] === name
  );
  App.searchData.filter = name;
  App.activeFeedSource = 'prime'; // Switch feed back to prime awards
  if (App.bubbleMode !== 'vendors' && App.bubbleMode !== 'agencies') App.bubbleMode = 'auto';
  App.updateSearchDashboard();
  App.renderSankey();
},

  // Load offices for sub-agency
  async loadOfficesForSubAgency(subAgencyName) {
    const panel = document.getElementById('officesPanel');
    const list = document.getElementById('officesList');
    
    // Show loading state
    panel.style.display = 'block';
    document.getElementById('officesSubAgencyName').innerText = Utils.trunc(subAgencyName, 40);
    list.innerHTML = '<div style="text-align:center; padding:1rem; color:var(--text-muted);"> Loading offices...</div>';
    
    try {
      const offices = await API.fetchOfficesForSubAgency(subAgencyName);
      
      if (offices.length === 0) {
        list.innerHTML = '<div style="text-align:center; padding:1rem; color:var(--text-muted);">No contracting offices found for this sub-agency</div>';
        document.getElementById('officesCount').innerText = '0';
        document.getElementById('officesTotalAmount').innerText = '$0';
        return;
      }
      
      // Deduplicate offices by code
      const uniqueOffices = [];
      const seenCodes = new Set();
      offices.forEach(o => {
        if (!seenCodes.has(o.code)) {
          seenCodes.add(o.code);
          uniqueOffices.push(o);
        }
      });
      
      document.getElementById('officesCount').innerText = uniqueOffices.length;
      document.getElementById('officesTotalAmount').innerText = Utils.money(App.searchData.active.reduce((s, c) => s + (c['Award Amount'] || 0), 0));
      
      list.innerHTML = uniqueOffices.slice(0, 15).map((office, i) => `
        <div class="subagency-item" style="cursor: default;">
          <div class="subagency-item-left">
            <div class="subagency-rank ${i < 3 ? 'top-3' : ''}">${i + 1}</div>
            <div class="subagency-info">
              <div class="subagency-name">${Autocomplete.escapeHtml(office.name)}</div>
              <div class="subagency-contracts" style="font-family: 'JetBrains Mono', monospace; font-size: 0.7rem;">${Autocomplete.escapeHtml(office.code || 'N/A')}</div>
            </div>
          </div>
          <div class="subagency-item-right">
            
          </div>
        </div>
      `).join('');
      
    } catch (e) {
      console.error('Error loading offices:', e);
      list.innerHTML = '<div style="text-align:center; padding:1rem; color:var(--text-muted);">Error loading offices</div>';
    }
  },
  drillToLevel(lvl) { 
  // Always restore full data before re-applying a level-specific filter
  App.searchData.active = App.searchData.raw;

  if (lvl === 0) {
    App.resetDrill();
  } else if (lvl === 1) {
    App.drillToAgency(App.drillState.path[0].name); 
  } else if (lvl === 2) {
    App.drillToSubAgency(App.drillState.path[1].name);
  }
},
  drillDown(name) {
  const data = App.searchData.raw;
  
  // 1. Identify the entity type from the master dataset
  const agencyMatch = data.find(d => d['Awarding Agency'] === name);
  const subAgencyMatch = data.find(d => d['Awarding Sub Agency'] === name);
  const vendorMatch = data.find(d => d['Recipient Name'] === name);

  // 2. Clear previous specific filters to avoid "No Data" conflicts
  App.searchData.active = data;

  if (agencyMatch && !subAgencyMatch) {
    // It's a top-tier agency: Clean drill to Level 1
    App.drillToAgency(name);
  } 
  else if (subAgencyMatch) {
    // If it's a sub-agency (or both), we must ensure the parent context is set
    // to prevent "No Description" breadcrumbs.
    const parentName = subAgencyMatch['Awarding Agency'];
    App.drillState.currentAgency = parentName; 
    App.drillToSubAgency(name);
  } 
  else if (vendorMatch) {
    // Vendor Perspective (Level 3)
    if (App.drillState.level === 3) {
      App.drillState.path.pop(); // Replace vendor if already in vendor view
    }
    
    App.drillState.level = 3; 
    App.drillState.path.push({ type: 'vendor', name: name });
    App.searchData.filter = `Vendor: ${name}`;
    App.activeFeedSource = 'prime'; // Switch feed back to prime awards
    
    // Filter specifically for this vendor across all agencies
    App.searchData.active = data.filter(d => d['Recipient Name'] === name);
    
    App.updateSearchDashboard();
    App.renderSankey();
  }
},
  clearFilter() { App.drillState.level > 0 ? App.resetDrill() : (App.searchData.filter = null, App.searchData.active = App.searchData.raw, App.activeFeedSource = 'prime', App.updateSearchDashboard(), App.renderSankey()); },

renderSankey() {
  const container = document.getElementById('chartContainer'); 
  container.innerHTML = '';
  
  const data = App.searchData.active; 
  if(!data || data.length === 0) { 
    container.innerHTML = '<div style="text-align:center; padding:4rem; color:var(--text-subtle)">No data available for this view.</div>'; 
    return; 
  }
  
  // 1. DATA AGGREGATION (Kept your exact logic)
  const isLvl0 = App.drillState.level === 0;
  const flowMap = {}; 

  data.forEach(d => { 
    if(d['Award Amount'] > 0) {
      // Logic: Agency -> Vendor (Level 0) OR SubAgency -> Vendor (Level 1)
      const source = (isLvl0 ? d['Awarding Agency'] : d['Awarding Sub Agency']) || d['Awarding Agency'] || 'Unknown Agency';
      const target = d['Recipient Name'] || 'Unknown Vendor';
      const key = source + "|||" + target;
      
      flowMap[key] = (flowMap[key] || 0) + d['Award Amount']; 
    }
  });

  const allFlows = Object.entries(flowMap).sort((a,b) => b[1] - a[1]); 
  const limit = App.drillState.level > 0 ? 50 : 25;
  const topFlows = allFlows.slice(0, limit); 
  const tailFlows = allFlows.slice(limit);
  
  const nodesSet = new Set(); 
  const links = [];
  
  topFlows.forEach(([k,v]) => { 
    const [s,t] = k.split("|||"); 
    nodesSet.add(s); 
    nodesSet.add(t); 
    links.push({source:s, target:t, value:v}); 
  });

  // "Other" Category Logic
  if(tailFlows.length > 0) { 
    const aggs = {}; 
    tailFlows.forEach(([k,v]) => { 
      const [s] = k.split("|||"); 
      if(nodesSet.has(s)) aggs[s] = (aggs[s] || 0) + v; 
    }); 
    Object.entries(aggs).forEach(([s,v]) => { 
      const n = `Other (${tailFlows.length} Vendors)`; 
      nodesSet.add(n); 
      links.push({source:s, target:n, value:v}); 
    }); 
  }
  
  const nodes = Array.from(nodesSet).map(n => ({name:n})); 
  const nodeMap = new Map(nodes.map((n,i) => [n.name, i]));
  const d3Links = links.map(l => ({source:nodeMap.get(l.source), target:nodeMap.get(l.target), value:l.value}));
  
  // 2. SETUP SVG (Dynamic Width)
  const w = ((container.parentElement ? container.parentElement.offsetWidth : container.offsetWidth) || 800) - 2; 
  // Dynamic Height: Grows with data
  const h = Math.max(500, nodes.length * 28);
  
  const svg = d3.select(container)
    .append("svg")
    .attr("id", "sankeySvg")
    .attr("viewBox",`0 0 ${w} ${h}`)
    .attr("preserveAspectRatio","xMidYMid meet")
    .style("width","100%")
    .style("height","auto")
    .style("display","block");

  const sankey = d3.sankey()
    .nodeId(d => d.index)
    .nodeWidth(20)
    .nodePadding(20)
    .extent([[1,1],[w-1,h-6]]);

  const {nodes:gn, links:gl} = sankey({
    nodes:nodes.map(d=>Object.assign({},d)), 
    links:d3Links.map(d=>Object.assign({},d))
  });
  
  // 3. COLOR & GRADIENTS
  Utils.getColor.reset();
  const defs = svg.append("defs");

  gl.forEach((l, i) => {
    // Unique ID per link to avoid conflicts
    const gradientId = "prime-grad-" + i;
    
    const g = defs.append("linearGradient")
      .attr("id", gradientId)
      .attr("gradientUnits", "userSpaceOnUse")
      .attr("x1", l.source.x1)
      .attr("x2", l.target.x0);

    // Source Color
    g.append("stop")
      .attr("offset", "0%")
      .attr("stop-color", Utils.getColor(l.source.name));

    // Target Color
    g.append("stop")
      .attr("offset", "100%")
      .attr("stop-color", Utils.getColor(l.target.name));
  });

  // 4. LINKS (The Visual Upgrade)
  const linkGroup = svg.append("g").attr("fill", "none");

  const linkPaths = linkGroup
    .selectAll("path")
    .data(gl)
    .join("path")
    .attr("d", d3.sankeyLinkHorizontal())
    .attr("stroke", (d, i) => "url(#prime-grad-" + i + ")")
    .attr("stroke-width", d => Math.max(1, d.width))
    .attr("stroke-opacity", 0.4) // Lower opacity for the "Vintage" feel
    .attr("stroke-linecap", "butt") // Round caps = Better flow
    .attr("fill", "none") // Prevent artifacts
    .style("transition", "stroke-opacity 0.2s");

  // Interaction: Brighten on hover
  linkPaths
    .on("mouseover", function () {
      d3.select(this).attr("stroke-opacity", 0.8);
    })
    .on("mouseout", function () {
      d3.select(this).attr("stroke-opacity", 0.4);
    })
    .append("title")
    .text(d => `${d.source.name} → ${d.target.name}\n${Utils.money(d.value)}`);

  // 5. NODES & LABELS
  // Helper: Is this node clickable?
  const isDrillable = n => {
    if (!n || n.startsWith('Other') || n.includes('Unknown') || n === 'No Description') return false;
    // Check against raw data to see if it's a valid entity
    return App.searchData.raw.some(d => 
      d['Awarding Agency'] === n || 
      d['Awarding Sub Agency'] === n || 
      d['Recipient Name'] === n
    );
  };

  // Helper: Is this the currently active filter?
  const isActiveDrill = n => {
    if (App.drillState.level === 0) return false;
    const lastStep = App.drillState.path[App.drillState.path.length - 1];
    return lastStep && lastStep.name === n;
  };

  svg.append("g").selectAll("rect").data(gn).join("rect")
     .attr("x", d => d.x0).attr("y", d => d.y0)
     .attr("height", d => Math.max(1, d.y1 - d.y0))
     .attr("width", d => d.x1 - d.x0)
     .attr("fill", d => Utils.getColor(d.name))
     .attr("opacity", d => isActiveDrill(d.name) ? 1 : 0.8)
     .attr("stroke", d => isActiveDrill(d.name) ? "#F1EEE9" : "none")
     .attr("stroke-width", d => isActiveDrill(d.name) ? 0 : 0)
     .style("cursor", d => isDrillable(d.name) ? "pointer" : "default")
     .on("click", (e, d) => { 
       if (!isDrillable(d.name)) return;
       
       if (isActiveDrill(d.name)) {
         // Drill OUT
         if (App.drillState.level <= 1) {
           App.resetDrill();
         } else {
           App.drillToLevel(App.drillState.level - 1);
         }
       } else {
         // Drill IN
         App.drillDown(d.name); 
       }
     })
     .on("mouseover", function(e, d) {
       if (!isDrillable(d.name)) return;
       d3.select(this).attr("opacity", 1);
     })
     .on("mouseout", function(e, d) {
       d3.select(this).attr("opacity", isActiveDrill(d.name) ? 1 : 0.8);
     })
     .append("title").text(d => {
       if (!isDrillable(d.name)) return `${d.name}\n${Utils.money(d.value)}`;
       const action = isActiveDrill(d.name) ? '← Click to drill out' : 'Click to drill down →';
       return `${d.name}\n${Utils.money(d.value)}\n${action}`;
     });

// Render Labels
  const isNarrow = w < 600; // Detect mobile width
  svg.append("g")
    .selectAll("text")
    .data(gn)
    .join("text")
    .attr("x", d => (d.x0 < w / 2 ? d.x1 + 6 : d.x0 - 6))
    .attr("y", d => (d.y1 + d.y0) / 2)
    .attr("dy", d => {
      if (d.y1 - d.y0 > 30) {
        return d.x0 < w / 2 ? "-0.5em" : "1.1em"; 
      }
      return "0.35em"; 
    })
    .attr("text-anchor", d => (d.x0 < w / 2 ? "start" : "end"))
    .text(d => Utils.trunc(d.name, isNarrow ? 25 : 40)) // Tighter truncation on mobile
    .style("font-size", "11px")
    .style("font-weight", d => (d.y1 - d.y0 > 30) ? "700" : "400") // Bold the major players
    .style("fill", App.presentationMode ? "#1A1A1A" : "#F1EEE9")
    .style("pointer-events", "none");
},
  renderFeed(showAll) {
    const div = document.getElementById('feedGrid');
    
    // Always render prime awards in the main feed
    const data = App.searchData.active;
    if(data.length === 0) { div.innerHTML = '<div style="text-align:center; padding:2rem; color:var(--text-subtle)">No contracts found.</div>'; return; }
    
    const INITIAL_COUNT = 3;
    const displayData = showAll ? data : data.slice(0, INITIAL_COUNT);
    const hasMore = !showAll && data.length > INITIAL_COUNT;
    
    const cards = displayData.map((c, idx) => {
      const internalId = c['generated_internal_id'];
      let url = '#';
      if (internalId) url = `https://www.usaspending.gov/award/${internalId}`;
      else if (c['Award ID']) url = `https://www.usaspending.gov/search/?hash=&filters=${encodeURIComponent(JSON.stringify({keyword: c['Award ID']}))}`;
      
      let metaTags = '';
      const contractType = Utils.getContractTypeTag(c['Contract Award Type']);
      if (contractType) metaTags += `<span class="meta-tag" style="background:rgba(141,160,203,0.15);border-color:rgba(141,160,203,0.3);color:var(--info);" title="${contractType.full}">${contractType.short}</span>`;
      if (c['NAICS Code']) metaTags += `<span class="meta-tag naics" title="${Autocomplete.escapeHtml(c['NAICS Description'] || '')}">NAICS: ${Autocomplete.escapeHtml(c['NAICS Code'])}</span>`;
      if (c['PSC Code']) metaTags += `<span class="meta-tag psc" title="${Autocomplete.escapeHtml(c['PSC Description'] || '')}">PSC: ${Autocomplete.escapeHtml(c['PSC Code'])}</span>`;
      const vehicle = VehicleDetector.detect(c['Award ID']);
      if (vehicle) metaTags += `<span class="meta-tag" style="background:rgba(95,128,85,0.15);border-color:rgba(95,128,85,0.3);color:var(--accent);" title="${vehicle.vehicle}">${vehicle.short}</span>`;
      // Set-aside: from ES search 'Type Set Aside' (all awards) or enrichment fallback
      const setAsideCode = c['Type Set Aside'];
      const setAside = VehicleDetector.getSetAsideLabel(setAsideCode);
      if (setAside) metaTags += `<span class="meta-tag" style="background:rgba(229,192,123,0.15);border-color:rgba(229,192,123,0.3);color:var(--accent);" title="Set-Aside: ${setAside}">${setAside}</span>`;

      // Number of offers — real competition signal
      const offers = parseInt(c['number_of_offers_received']);
      if (offers && offers > 0) metaTags += `<span class="meta-tag" style="background:rgba(255,255,255,0.05);border-color:var(--border);color:var(--text-muted);" title="Number of offers received">${offers} offer${offers > 1 ? 's' : ''}</span>`;
      
      const subAgency = c['Awarding Sub Agency'];
      const agencyDisplay = subAgency && subAgency !== c['Awarding Agency'] 
        ? `${Utils.trunc(c['Awarding Agency'], 20)} → ${Utils.trunc(subAgency, 20)}` 
        : Utils.trunc(c['Awarding Agency'], 35);
      
      const vendorNameRaw = c['Recipient Name'] || 'Unknown Vendor';
      const vendorName = Autocomplete.escapeHtml(vendorNameRaw);
      const desc = Autocomplete.escapeHtml(Utils.trunc(c['Description'], 100));
      const agencyDisplaySafe = Autocomplete.escapeHtml(agencyDisplay);
const linkedInUrl = JobLinks.getLinkedInUrl(vendorNameRaw);
const linkedInPeopleUrl = JobLinks.getLinkedInPeopleUrl(vendorNameRaw);
const linkedInNewsUrl = JobLinks.getLinkedInNewsUrl(vendorNameRaw);
return `<div class="deal-card">
    <div class="deal-header"><span class="deal-agency">${agencyDisplaySafe}</span><span class="deal-amount">${Utils.money(c['Award Amount'])}<span style="font-size:0.55rem;opacity:0.5;margin-left:0.25rem;">obligated</span></span></div>
    ${(() => {
      const obligated = parseFloat(c['Award Amount']) || 0;
      if (obligated <= 0) return '';
      
      // Ceiling from detail endpoint enrichment (top 10 awards)
      const ceiling = parseFloat(c['potential_total_value_of_award']) || 0;
      if (ceiling <= obligated) return '';
      
      const burnPct = Math.min((obligated / ceiling) * 100, 100);
      return `<div class="skill-bar-container" style="margin:0.35rem 0 0.15rem;">
        <div class="skill-bar-label">
          <span class="skill-bar-name">${burnPct.toFixed(0)}% burned</span>
          <span class="skill-bar-pct">${Utils.money(obligated)} of ${Utils.money(ceiling)}</span>
        </div>
        <div class="skill-bar">
          <div class="skill-bar-fill" style="width: ${burnPct}%"></div>
        </div>
      </div>`;
    })()}
    <div class="deal-desc">${desc}</div>
    <div class="deal-vendor">${vendorName} <a href="${linkedInPeopleUrl}" target="_blank" class="job-link" style="margin-left:6px;" title="Find contacts at this company"> People</a> <a href="${linkedInUrl}" target="_blank" class="job-link" title="Search jobs at this company"> Jobs</a> <a href="${linkedInNewsUrl}" target="_blank" class="job-link" title="LinkedIn posts about this company"> News</a></div>
    ${metaTags ? `<div class="deal-meta">${metaTags}</div>` : ''}
    <div class="deal-footer"><span class="deal-date">Start: ${Utils.date(c['Start Date'])}${c['End Date'] ? ' → ' + Utils.date(c['End Date']) : ''}${c['Last Modified Date'] ? ` <span style="opacity:0.5;font-size:0.6rem;" title="Last government action on this contract">· mod ${Utils.date(c['Last Modified Date'])}</span>` : ''}</span><div style="display:flex;gap:0.5rem;align-items:center;"><button onclick="Utils.copyDealToClipboard(${idx}, this)" class="action-btn" style="font-size:0.7rem; padding:0.35rem 0.6rem; cursor:pointer; background:transparent;" title="Copy for CRM"></button><a href="${url}" target="_blank" class="action-btn">VIEW </a></div></div>
  </div>`;
}).join('');

    const showMoreBtn = hasMore ? `<button onclick="App.renderFeed(true)" style="width: 100%; padding: 0.875rem; background: var(--bg-card); border: 1px dashed var(--border); border-radius: 4px; color: var(--accent); font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; cursor: pointer; transition: all 0.2s; text-transform: uppercase; letter-spacing: 1px;" onmouseover="this.style.borderColor='var(--accent)';this.style.background='var(--accent-dim)'" onmouseout="this.style.borderColor='var(--border)';this.style.background='var(--bg-card)'">Show All ${data.length} Contracts</button>` : '';

    div.innerHTML = cards + showMoreBtn;
},

  // Render subaward data in the feed
  renderSubawardFeed(targetDiv, showAll) {
    const div = targetDiv || document.getElementById('subFeedGrid');
    const wrapper = document.getElementById('subFeedWrapper');
    if (!div) return;
    
    let subawards = App.forecastData.subawards || [];
    const drill = App.subawardDrillState;
    
    // Apply drill filter if active (path-based)
    if (drill.level > 0 && drill.path && drill.path.length > 0) {
      drill.path.forEach(step => {
        if (step.type === 'agency') subawards = subawards.filter(s => (s['Awarding Agency'] || 'Unknown Agency') === step.name);
        else if (step.type === 'subagency') subawards = subawards.filter(s => (s['Awarding Sub Agency'] || 'Unknown Sub Agency') === step.name);
        else if (step.type === 'prime') subawards = subawards.filter(s => (s['Prime Recipient Name'] || 'Unknown Prime') === step.name);
        else if (step.type === 'sub') subawards = subawards.filter(s => (s['Sub-Awardee Name'] || 'Unknown Sub') === step.name);
      });
    }
    
    if (subawards.length === 0) {
      div.innerHTML = '<div style="text-align:center; padding:2rem; color:var(--text-subtle)">No subcontracts found.</div>';
      if (wrapper) wrapper.style.display = 'none';
      return;
    }
    
    // Show the sub feed wrapper
    if (wrapper) wrapper.style.display = 'block';
    
    // Sort by amount descending
    subawards = [...subawards].sort((a, b) => (parseFloat(b['Sub-Award Amount']) || 0) - (parseFloat(a['Sub-Award Amount']) || 0));
    
    const INITIAL_COUNT = 3;
    const displayData = showAll ? subawards.slice(0, 50) : subawards.slice(0, INITIAL_COUNT);
    const hasMore = !showAll && subawards.length > INITIAL_COUNT;
    
    const cards = displayData.map(s => {
      const prime = s['Prime Recipient Name'] || 'Unknown Prime';
      const sub = s['Sub-Awardee Name'] || 'Unknown Sub';
      const amount = parseFloat(s['Sub-Award Amount']) || 0;
      const date = s['Sub-Award Date'];
      const agency = s['Awarding Agency'] || s['Awarding Sub Agency'] || '';
      const primeAwardInternalId = s['prime_award_generated_internal_id'] || '';
      
      let usaSpendingUrl = '';
      if (primeAwardInternalId) {
        usaSpendingUrl = `https://www.usaspending.gov/award/${primeAwardInternalId}`;
      }
      
      const primeShort = Autocomplete.escapeHtml(Utils.trunc(prime, 25));
      const subShort = Autocomplete.escapeHtml(Utils.trunc(sub, 25));
      const linkedInPrimeUrl = JobLinks.getLinkedInPeopleUrl(prime);
      const linkedInSubUrl = JobLinks.getLinkedInPeopleUrl(sub);
      
      // Encode minimal data for copy button
      const copyData = encodeURIComponent(JSON.stringify({
        'Awarding Agency': agency, 'Prime Recipient Name': prime, 'Sub-Awardee Name': sub,
        'Sub-Award Amount': s['Sub-Award Amount'], 'Sub-Award Date': date,
        'prime_award_generated_internal_id': primeAwardInternalId
      }));
      
      return `<div class="deal-card" style="border-left-color: var(--accent);">
        <div class="deal-header">
          <span class="deal-agency" style="color: var(--accent);">SUBCONTRACT</span>
          <span class="deal-amount">${Utils.money(amount)}</span>
        </div>
        <div class="deal-desc" style="font-size: 0.8rem;">
          <strong>${primeShort}</strong>  <strong>${subShort}</strong>
        </div>
        <div class="deal-vendor" style="font-size: 0.75rem; color: var(--text-muted);">
          ${agency ? `Agency: ${Autocomplete.escapeHtml(Utils.trunc(agency, 30))}` : ''}
        </div>
        <div class="deal-footer">
          <span class="deal-date">${date ? Utils.date(date) : 'Date N/A'}</span>
          <div style="display: flex; gap: 0.5rem; align-items: center;">
            <button onclick="Utils.copySubDealToClipboard('${copyData}', this)" class="action-btn" style="font-size:0.65rem; padding:0.25rem 0.5rem; cursor:pointer; background:transparent;" title="Copy for CRM"></button>
            <a href="${linkedInPrimeUrl}" target="_blank" class="job-link" title="Find contacts at prime"> Prime</a>
            <a href="${linkedInSubUrl}" target="_blank" class="job-link" title="Find contacts at sub"> Sub</a>
            ${usaSpendingUrl ? `<a href="${usaSpendingUrl}" target="_blank" class="action-btn" style="font-size: 0.65rem; padding: 0.25rem 0.5rem;">VIEW </a>` : ''}
          </div>
        </div>
      </div>`;
    }).join('');

    const showMoreBtn = hasMore ? `<button onclick="App.renderSubawardFeed(null, true)" style="width: 100%; padding: 0.875rem; background: var(--bg-card); border: 1px dashed var(--border); border-radius: 4px; color: var(--accent); font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; cursor: pointer; transition: all 0.2s; text-transform: uppercase; letter-spacing: 1px;" onmouseover="this.style.borderColor='var(--accent)';this.style.background='rgba(229,192,123,0.08)'" onmouseout="this.style.borderColor='var(--border)';this.style.background='var(--bg-card)'">Show All ${Math.min(subawards.length, 50)} Subcontracts</button>` : '';

    div.innerHTML = cards + showMoreBtn;
  },
// --- Search View: Top Buyers with LinkedIn Links ---
renderSearchTopBuyers(data) {
  const body = document.getElementById('searchTopBuyersBody');
  const panel = document.getElementById('agencyReachPanel');
  if (!body) return;
  
  if (!data || data.length === 0) {
    if (panel) panel.style.display = 'none';
    return;
  }
  if (panel) panel.style.display = 'block';
  
  const drill = App.drillState || {};
  const isDrilled = drill.level >= 1 && drill.currentAgency;
  const esc = (s) => s.replace(/'/g, "\\'").replace(/"/g, '&quot;');

  if (isDrilled) {
    const native = App.nativeSubAgencyData;
    let sorted;
    if (native && native.length > 0) {
      sorted = native.map(d => ({ name: d.name || 'Unknown', spend: d.amount || 0, count: d.count || 0 }))
        .sort((a, b) => b.spend - a.spend);
    } else {
      const subMap = {};
      data.forEach(a => {
        const sub = a['Awarding Sub Agency'] || a['Awarding Agency'] || 'Unknown';
        if (!subMap[sub]) subMap[sub] = { name: sub, spend: 0, count: 0 };
        subMap[sub].spend += parseFloat(a['Award Amount']) || 0;
        subMap[sub].count++;
      });
      sorted = Object.values(subMap).sort((a, b) => b.spend - a.spend);
    }
    const top = sorted.slice(0, 5);
    
    body.innerHTML = top.map(s => {
      return `<div class="reach-row" onclick="App.drillToSubAgency('${esc(s.name)}')">
        <div style="min-width: 0; flex: 1;">
          <div style="display: flex; align-items: center; gap: 0.4rem; flex-wrap: wrap;">
            <span class="reach-name">${Utils.trunc(s.name, 28)}</span>
            <span class="reach-badge">${s.count} awards</span>
          </div>
          <div class="job-links" style="margin-top: 0.25rem;" onclick="event.stopPropagation();">
            <a href="${JobLinks.getLinkedInPeopleUrl(s.name)}" target="_blank" class="job-link"> People</a>
            <a href="${JobLinks.getLinkedInUrl(s.name)}" target="_blank" class="job-link"> Jobs</a>
            <a href="${JobLinks.getLinkedInNewsUrl(s.name)}" target="_blank" class="job-link"> News</a>
          </div>
        </div>
        <div style="text-align: right; flex-shrink: 0;">
          <div class="reach-amount">${Utils.money(s.spend)}</div>
          <div class="reach-count">${s.count} awards</div>
        </div>
      </div>`;
    }).join('') + (sorted.length > 5 ? `<div class="reach-overflow">+${sorted.length - 5} more offices</div>` : '');
  } else {
    const agencyMap = {};
    data.forEach(a => {
      const agency = a['Awarding Agency'] || 'Unknown';
      const sub = a['Awarding Sub Agency'] || '';
      const vendor = a['Recipient Name'] || '';
      const amt = parseFloat(a['Award Amount']) || 0;
      if (!agencyMap[agency]) agencyMap[agency] = { name: agency, spend: 0, count: 0, subs: new Set(), vendors: {} };
      agencyMap[agency].spend += amt;
      agencyMap[agency].count++;
      if (sub) agencyMap[agency].subs.add(sub);
      if (vendor) {
        if (!agencyMap[agency].vendors[vendor]) agencyMap[agency].vendors[vendor] = 0;
        agencyMap[agency].vendors[vendor] += amt;
      }
    });
    
    const sorted = Object.values(agencyMap).sort((a, b) => b.spend - a.spend);
    const top = sorted.slice(0, 5);
    const agencyShort = (name) => name.replace(/^Department of (the )?/i, '').replace(/^Office of (the )?/i, '');

    body.innerHTML = top.map(a => {
      const subCount = a.subs.size;
      const topVendor = Object.entries(a.vendors).sort((x, y) => y[1] - x[1])[0];

      return `<div class="reach-row" onclick="App.drillToAgency('${esc(a.name)}')">
        <div style="min-width: 0; flex: 1;">
          <div style="display: flex; align-items: center; gap: 0.4rem; flex-wrap: wrap;">
            <span class="reach-name">${Utils.trunc(agencyShort(a.name), 28)}</span>
            ${subCount > 1 ? `<span class="reach-badge accent">${subCount} offices</span>` : ''}
            <span class="reach-badge">${a.count} awards</span>
          </div>
          <div class="reach-meta">
            ${topVendor ? `${Utils.trunc(topVendor[0], 22)} leads` : ''}
          </div>
          <div class="job-links" style="margin-top: 0.25rem;" onclick="event.stopPropagation();">
            <a href="${JobLinks.getLinkedInPeopleUrl(a.name)}" target="_blank" class="job-link"> People</a>
            <a href="${JobLinks.getLinkedInUrl(a.name)}" target="_blank" class="job-link"> Jobs</a>
            <a href="${JobLinks.getLinkedInNewsUrl(a.name)}" target="_blank" class="job-link"> News</a>
          </div>
        </div>
        <div style="text-align: right; flex-shrink: 0;">
          <div class="reach-amount">${Utils.money(a.spend)}</div>
          <div class="reach-count">${a.count} awards</div>
        </div>
      </div>`;
    }).join('') + (sorted.length > 5 ? `<div class="reach-overflow">+${sorted.length - 5} more agencies</div>` : '');
  }
},


  // --- Search View: Top Primes with LinkedIn Links ---
  renderSearchTopPrimes(subawards) {
    const body = document.getElementById('searchTopPrimesBody');
    const panel = document.getElementById('subPrimesPanel');
    if (!body) return;
    
    if (!subawards || subawards.length === 0) {
      if (panel) panel.style.display = 'none';
      return;
    }
    
    let filtered = subawards;
    const drill = App.subawardDrillState;
    if (drill.level > 0 && drill.path && drill.path.length > 0) {
      drill.path.forEach(step => {
        if (step.type === 'agency') filtered = filtered.filter(s => (s['Awarding Agency'] || 'Unknown Agency') === step.name);
        else if (step.type === 'subagency') filtered = filtered.filter(s => (s['Awarding Sub Agency'] || 'Unknown Sub Agency') === step.name);
        else if (step.type === 'prime') filtered = filtered.filter(s => (s['Prime Recipient Name'] || 'Unknown Prime') === step.name);
        else if (step.type === 'sub') filtered = filtered.filter(s => (s['Sub-Awardee Name'] || 'Unknown Sub') === step.name);
      });
    }
    
    const primeMap = {};
    filtered.forEach(sub => {
      const prime = sub['Prime Recipient Name'] || 'Unknown';
      const subName = sub['Sub-Awardee Name'] || '';
      const amt = parseFloat(sub['Sub-Award Amount']) || 0;
      if (!primeMap[prime]) primeMap[prime] = { name: prime, spend: 0, count: 0, subs: {} };
      primeMap[prime].spend += amt;
      primeMap[prime].count++;
      if (subName) {
        if (!primeMap[prime].subs[subName]) primeMap[prime].subs[subName] = 0;
        primeMap[prime].subs[subName] += amt;
      }
    });
    
    const sorted = Object.values(primeMap).sort((a, b) => b.spend - a.spend);
    const top = sorted.slice(0, 5);
    if (top.length === 0) { if (panel) panel.style.display = 'none'; return; }
    if (panel) panel.style.display = 'block';

    const esc = (s) => s.replace(/'/g, "\\'").replace(/"/g, '&quot;');
    body.innerHTML = top.map(p => {
      const subCount = Object.keys(p.subs).length;
      const topSubs = Object.entries(p.subs).sort((a, b) => b[1] - a[1]).map(([n]) => Utils.trunc(n, 20));

      return `<div class="reach-row" onclick="App.viewFootprint('${esc(p.name)}')" title="Search ${p.name} portfolio">
        <div style="min-width: 0; flex: 1;">
          <div style="display: flex; align-items: center; gap: 0.4rem; flex-wrap: wrap;">
            <span class="reach-name">${Utils.trunc(p.name, 28)}</span>
            <span class="reach-badge accent">${subCount} subs</span>
            <span class="reach-badge">${p.count} awards</span>
          </div>
          <div class="reach-meta">
            ${topSubs.slice(0, 3).join(' · ')}${topSubs.length > 3 ? ` +${topSubs.length - 3}` : ''}
          </div>
          <div class="job-links" style="margin-top: 0.25rem;" onclick="event.stopPropagation();">
            <a href="${JobLinks.getLinkedInPeopleUrl(p.name)}" target="_blank" class="job-link"> People</a>
            <a href="${JobLinks.getLinkedInUrl(p.name)}" target="_blank" class="job-link"> Jobs</a>
            <a href="${JobLinks.getLinkedInNewsUrl(p.name)}" target="_blank" class="job-link"> News</a>
          </div>
        </div>
        <div style="text-align: right; flex-shrink: 0;">
          <div class="reach-amount">${Utils.money(p.spend)}</div>
          <div class="reach-count">${p.count} subs</div>
        </div>
      </div>`;
    }).join('') + (sorted.length > 5 ? `<div class="reach-overflow">+${sorted.length - 5} more primes</div>` : '');
  },

  // --- Search View: Top Subs with LinkedIn Links ---
  renderSearchTopSubs(subawards) {
    const body = document.getElementById('searchTopSubsBody');
    const panel = document.getElementById('subSubsPanel');
    if (!body) return;
    
    if (!subawards || subawards.length === 0) {
      if (panel) panel.style.display = 'none';
      return;
    }
    
    let filtered = subawards;
    const drill = App.subawardDrillState;
    if (drill.level > 0 && drill.path && drill.path.length > 0) {
      drill.path.forEach(step => {
        if (step.type === 'agency') filtered = filtered.filter(s => (s['Awarding Agency'] || 'Unknown Agency') === step.name);
        else if (step.type === 'subagency') filtered = filtered.filter(s => (s['Awarding Sub Agency'] || 'Unknown Sub Agency') === step.name);
        else if (step.type === 'prime') filtered = filtered.filter(s => (s['Prime Recipient Name'] || 'Unknown Prime') === step.name);
        else if (step.type === 'sub') filtered = filtered.filter(s => (s['Sub-Awardee Name'] || 'Unknown Sub') === step.name);
      });
    }
    
    const subMap = {};
    filtered.forEach(sub => {
      const subName = sub['Sub-Awardee Name'] || 'Unknown';
      const prime = sub['Prime Recipient Name'] || '';
      const amt = parseFloat(sub['Sub-Award Amount']) || 0;
      if (!subMap[subName]) subMap[subName] = { name: subName, spend: 0, count: 0, primes: {} };
      subMap[subName].spend += amt;
      subMap[subName].count++;
      if (prime) {
        if (!subMap[subName].primes[prime]) subMap[subName].primes[prime] = 0;
        subMap[subName].primes[prime] += amt;
      }
    });
    
    const sorted = Object.values(subMap).sort((a, b) => b.spend - a.spend);
    const top = sorted.slice(0, 5);
    if (top.length === 0) { if (panel) panel.style.display = 'none'; return; }
    if (panel) panel.style.display = 'block';

    const esc = (s) => s.replace(/'/g, "\\'").replace(/"/g, '&quot;');
    body.innerHTML = top.map(s => {
      const primeCount = Object.keys(s.primes).length;
      const topPrimes = Object.entries(s.primes).sort((a, b) => b[1] - a[1]).map(([n]) => Utils.trunc(n, 20));

      return `<div class="reach-row" onclick="App.viewFootprint('${esc(s.name)}')" title="Search ${s.name} portfolio">
        <div style="min-width: 0; flex: 1;">
          <div style="display: flex; align-items: center; gap: 0.4rem; flex-wrap: wrap;">
            <span class="reach-name">${Utils.trunc(s.name, 28)}</span>
            <span class="reach-badge accent">${primeCount} ${primeCount === 1 ? 'prime' : 'primes'}</span>
            <span class="reach-badge">${s.count} awards</span>
          </div>
          <div class="reach-meta">
            ${topPrimes.slice(0, 3).join(' · ')}${topPrimes.length > 3 ? ` +${topPrimes.length - 3}` : ''}
          </div>
          <div class="job-links" style="margin-top: 0.25rem;" onclick="event.stopPropagation();">
            <a href="${JobLinks.getLinkedInPeopleUrl(s.name)}" target="_blank" class="job-link"> People</a>
            <a href="${JobLinks.getLinkedInUrl(s.name)}" target="_blank" class="job-link"> Jobs</a>
            <a href="${JobLinks.getLinkedInNewsUrl(s.name)}" target="_blank" class="job-link"> News</a>
          </div>
        </div>
        <div style="text-align: right; flex-shrink: 0;">
          <div class="reach-amount">${Utils.money(s.spend)}</div>
          <div class="reach-count">${s.count} subs</div>
        </div>
      </div>`;
    }).join('') + (sorted.length > 5 ? `<div class="reach-overflow">+${sorted.length - 5} more subs</div>` : '');
  },


  // --- NAICS Mix: Top codes by dollar value, clickable for drill or search ---
  renderNaicsMix(data) {
    const panel = document.getElementById('naicsPanel');
    const body = document.getElementById('naicsMixBody');
    if (!body || !panel) return;
    if (!data || data.length === 0) { panel.style.display = 'none'; return; }

    const buckets = {};
    let totalAmt = 0;
    data.forEach(c => {
      const code = c['NAICS Code'] || c['naics_code'];
      if (!code) return;
      const desc = c['NAICS Description'] || c['naics_description'] || '';
      const amt = parseFloat(c['Award Amount']) || 0;
      const vendor = c['Recipient Name'] || '';
      const agency = c['Awarding Agency'] || '';
      const offers = parseInt(c['number_of_offers_received']) || 0;

      if (!buckets[code]) buckets[code] = { code, desc, count: 0, amount: 0, vendors: {}, agencies: {}, offersTotal: 0, offersCount: 0 };
      buckets[code].count++;
      buckets[code].amount += amt;
      totalAmt += amt;

      // Track vendors by spend
      if (vendor) {
        if (!buckets[code].vendors[vendor]) buckets[code].vendors[vendor] = 0;
        buckets[code].vendors[vendor] += amt;
      }
      // Track agencies by spend
      if (agency) {
        if (!buckets[code].agencies[agency]) buckets[code].agencies[agency] = 0;
        buckets[code].agencies[agency] += amt;
      }
      // Track offers
      if (offers > 0) { buckets[code].offersTotal += offers; buckets[code].offersCount++; }
    });

    const sorted = Object.values(buckets).sort((a, b) => b.amount - a.amount).slice(0, 5);
    if (sorted.length === 0) { panel.style.display = 'none'; return; }

    panel.style.display = 'block';
    const maxAmt = sorted[0].amount;
    const q = App.currentQuery || '';
    const esc = (s) => s.replace(/'/g, "\\'");

    body.innerHTML = `<div style="display: flex; flex-direction: column; gap: 0.15rem;">
      ${sorted.map(s => {
        const pct = totalAmt > 0 ? ((s.amount / totalAmt) * 100).toFixed(0) : 0;

        // Top vendor and agency for this NAICS
        const topVendor = Object.entries(s.vendors).sort((a, b) => b[1] - a[1])[0];
        const topAgency = Object.entries(s.agencies).sort((a, b) => b[1] - a[1])[0];
        const avgOffers = s.offersCount > 0 ? (s.offersTotal / s.offersCount).toFixed(1) : null;
        const agencyShort = topAgency ? topAgency[0].replace(/^Department of (the )?/i, '').replace(/^Office of (the )?/i, '') : '';

        const searchAction = q && !/^\d{6}$/.test(q.trim())
          ? `App.runSearch('${esc(q)} AND ${s.code}')`
          : `App.runSearch('${s.code}')`;

        return `<div class="reach-row" onclick="${searchAction}">
          <div style="min-width: 0; flex: 1;">
            <div style="display: flex; align-items: center; gap: 0.5rem;">
              <span style="font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; font-weight: 700; color: #F2E8CF; flex-shrink: 0; min-width: 52px;">${s.code}</span>
              <div style="flex: 1; min-width: 0;">
                <div style="height: 6px; background: rgba(255,255,255,0.07); border-radius: 3px; overflow: hidden;">
                  <div style="height: 100%; width: ${(s.amount / maxAmt) * 100}%; background: var(--accent); border-radius: 3px; opacity: 0.85;"></div>
                </div>
              </div>
              <span class="reach-badge accent">${s.count} contracts</span>
            </div>
            <div class="reach-meta" style="padding-left: 0;">
              ${Utils.trunc(s.desc, 35)}${topVendor ? ` · ${Utils.trunc(topVendor[0], 18)} leads` : ''}${topAgency ? ` · ${Utils.trunc(agencyShort, 18)} buys` : ''}${avgOffers ? ` · ${avgOffers} avg offers` : ''}
            </div>
          </div>
          <div style="text-align: right; flex-shrink: 0;">
            <div class="reach-amount">${Utils.money(s.amount)}</div>
            <div class="reach-count">${pct}%</div>
          </div>
        </div>`;
      }).join('')}
    </div>`;
  },


// --- Forecast Mode ---


  async loadSubcontractingData(query) {
    const body = document.getElementById('subcontractingBody');
    const statsEl = document.getElementById('subcontractingStats');
    if (!body) return;
    
    body.innerHTML = `<div style="text-align:center; padding:2rem; color:var(--text-muted);"> Loading subaward flow...</div>`;
    
    // Timeout wrapper — show fallback if API takes longer than 15 seconds
    const timeout = setTimeout(() => {
      if (body.querySelector('.fa-spinner')) {
        body.innerHTML = `<div style="text-align:center; padding:1rem; color:var(--text-muted); font-size:0.85rem;">
           Subaward data is taking too long to load.
          <br><a href="#" onclick="App.loadSubcontractingData('${query.replace(/'/g, "\\'")}'); return false;" style="color:var(--accent); text-decoration:underline; font-size:0.8rem;">Retry</a>
        </div>`;
      }
    }, 15000);
    
    try {
      const subawards = await API.getSubawards(query);
      clearTimeout(timeout);
      App.forecastData.subawards = subawards; // Store for later use
      this.renderSubawardSankey(subawards);
      
      // Render Top Primes and Subs cards
      this.renderSearchTopPrimes(subawards);
      this.renderSearchTopSubs(subawards);
      
      // Render the separate subaward feed
      this.renderSubawardFeed();
      
      // Render subaward bubble chart
      App.renderSubBubbleChart();

      // Teaming partner discovery — find subs working with multiple primes
    } catch (e) {
      clearTimeout(timeout);
      console.error(e);
      body.innerHTML = `<div style="text-align:center; padding:1rem; color:var(--text-muted); font-size:0.85rem;">
         Unable to load subaward data.
        <br><a href="#" onclick="App.loadSubcontractingData('${query.replace(/'/g, "\\'")}'); return false;" style="color:var(--accent); text-decoration:underline; font-size:0.8rem;">Retry</a>
      </div>`;
    }
  },

  renderSubawardSankey(subawards) {
    const wrapper = document.getElementById('subawardWrapper');
    const body = document.getElementById('subcontractingBody');
    const statsEl = document.getElementById('subcontractingStats');
    const legendEl = document.getElementById('subcontractingLegend');
    
    if (!wrapper || !body) return;
    
    // 1. Hide the old legend (we use dynamic vintage colors now)
    if (legendEl) legendEl.style.display = 'none';

    // 2. CHECK DATA EXISTENCE
    if (!subawards || subawards.length === 0) {
      wrapper.style.display = 'none';
      if (statsEl) {
        const volEl = document.getElementById('sub-stat-vol');
        if (volEl) volEl.innerText = '-';
      }
      return;
    }

    // Data exists: Reveal the wrapper and sub convo panel
    wrapper.style.display = 'block';
    
    // Update sub sankey subtitle with query context
    const subSankeySubEl = document.getElementById('subSankeySubtitle');
    if (subSankeySubEl && App.currentQuery) {
      subSankeySubEl.textContent = '"' + App.currentQuery.toUpperCase() + '" · TOP 100 SUBCONTRACTS · INDIVIDUAL TRANSACTION VALUE';
    }
    
    // --- Apply Drill Filter ---
    let filteredSubawards = subawards;
    const drill = App.subawardDrillState;
    
    if (drill.level > 0 && drill.path.length > 0) {
      drill.path.forEach(step => {
        if (step.type === 'agency') {
          filteredSubawards = filteredSubawards.filter(sub => 
            (sub['Awarding Agency'] || 'Unknown Agency') === step.name
          );
        } else if (step.type === 'subagency') {
          filteredSubawards = filteredSubawards.filter(sub => 
            (sub['Awarding Sub Agency'] || 'Unknown Sub Agency') === step.name
          );
        } else if (step.type === 'prime') {
          filteredSubawards = filteredSubawards.filter(sub => 
            (sub['Prime Recipient Name'] || 'Unknown Prime') === step.name
          );
        } else if (step.type === 'sub') {
          filteredSubawards = filteredSubawards.filter(sub => 
            (sub['Sub-Awardee Name'] || 'Unknown Sub') === step.name
          );
        }
      });
      // Keep filter/filterType for backward compat with feed/topPrimes/topSubs
      drill.filter = drill.path[drill.path.length - 1].name;
      drill.filterType = drill.path[drill.path.length - 1].type;
    }
    
    // --- Data Processing ---
    // Determine the left-side source based on drill level
    const flowMap = {};
    let totalValue = 0;
    
    // Determine what the 3 columns should be based on drill depth
    const drillHasAgency = drill.path.some(p => p.type === 'agency');
    const drillHasSubAgency = drill.path.some(p => p.type === 'subagency');
    
    filteredSubawards.forEach(sub => {
      const agency = sub['Awarding Agency'] || 'Unknown Agency';
      const subAgency = sub['Awarding Sub Agency'] || agency;
      const prime = sub['Prime Recipient Name'] || 'Unknown Prime';
      const subName = sub['Sub-Awardee Name'] || 'Unknown Sub';
      const amount = parseFloat(sub['Sub-Award Amount']) || 0;
      
      if (amount > 0) {
        // Determine left column based on drill state
        let leftCol;
        if (!drillHasAgency) {
          // Level 0: Agency → Prime → Sub
          leftCol = agency;
        } else if (!drillHasSubAgency) {
          // Level 1 (agency drilled): SubAgency → Prime → Sub
          leftCol = subAgency;
        } else {
          // Level 2+ (subagency drilled): Prime → Sub (2-column)
          leftCol = prime;
        }
        
        if (drillHasAgency && !drillHasSubAgency) {
          // SubAgency → Prime → Sub (3-column)
          const key1 = `${leftCol}|||${prime}`;
          flowMap[key1] = (flowMap[key1] || 0) + amount;
          const key2 = `${prime}|||${subName}`;
          flowMap[key2] = (flowMap[key2] || 0) + amount;
        } else if (drillHasSubAgency) {
          // Prime → Sub (2-column, subagency already filtered)
          const key = `${prime}|||${subName}`;
          flowMap[key] = (flowMap[key] || 0) + amount;
        } else {
          // Agency → Prime → Sub (default 3-column)
          const key1 = `${agency}|||${prime}`;
          flowMap[key1] = (flowMap[key1] || 0) + amount;
          const key2 = `${prime}|||${subName}`;
          flowMap[key2] = (flowMap[key2] || 0) + amount;
        }
        
        totalValue += amount;
      }
    });
    
    // Update hero stats
    if (statsEl) {
      const volEl = document.getElementById('sub-stat-vol');
      const primesEl = document.getElementById('sub-stat-primes');
      const subsEl = document.getElementById('sub-stat-subs');
      const countEl = document.getElementById('sub-stat-count');
      const uniquePrimes = new Set(filteredSubawards.map(s => s['Prime Recipient Name'] || 'Unknown')).size;
      const uniqueSubs = new Set(filteredSubawards.map(s => s['Sub-Awardee Name'] || 'Unknown')).size;
      if (volEl) volEl.innerText = Utils.money(totalValue);
      if (primesEl) primesEl.innerText = uniquePrimes;
      if (subsEl) subsEl.innerText = uniqueSubs;
      if (countEl) countEl.innerText = filteredSubawards.length;
    }
    
    const allFlows = Object.entries(flowMap).sort((a, b) => b[1] - a[1]);
    const topFlows = allFlows.slice(0, 40);
    
    const nodesSet = new Set();
    const links = [];
    
    topFlows.forEach(([key, value]) => {
      const [source, target] = key.split('|||');
      nodesSet.add(source);
      nodesSet.add(target);
      links.push({ source, target, value });
    });
    
    if (links.length === 0) {
      wrapper.style.display = 'none';
      return;
    }

    const nodes = Array.from(nodesSet).map(name => ({ name }));
    const nodeMap = new Map(nodes.map((n, i) => [n.name, i]));
    const d3Links = links.map(l => ({
      source: nodeMap.get(l.source),
      target: nodeMap.get(l.target),
      value: l.value
    }));
    
    // --- Rendering ---
    // Build breadcrumb HTML for multi-level drill state
    let breadcrumbHtml = '';
    if (drill.level > 0 && drill.path.length > 0) {
      const typeIcons = { agency: 'fa-landmark', subagency: 'fa-sitemap', prime: 'fa-building', sub: 'fa-handshake' };
      const typeLabels = { agency: 'Agency', subagency: 'Sub-Agency', prime: 'Prime', sub: 'Sub' };
      
      let crumbs = `<div class="breadcrumb-item" onclick="App.resetSubawardDrill()" style="cursor:pointer;">
        
        <span>All Subawards</span>
      </div>`;
      
      drill.path.forEach((step, idx) => {
        const isLast = idx === drill.path.length - 1;
        const icon = typeIcons[step.type] || 'fa-circle';
        crumbs += `<span class="breadcrumb-separator"></span>`;
        if (isLast) {
          crumbs += `<div class="breadcrumb-item active">
            
            <span>${Utils.trunc(step.name, 30)}</span>
            <span style="font-size:0.65rem; color:var(--text-muted); margin-left:6px;">(${typeLabels[step.type] || step.type})</span>
          </div>`;
        } else {
          crumbs += `<div class="breadcrumb-item" onclick="App.drillSubawardToLevel(${idx})" style="cursor:pointer;">
            
            <span>${Utils.trunc(step.name, 25)}</span>
          </div>`;
        }
      });
      
      breadcrumbHtml = `<div class="drill-breadcrumb" style="display: flex; margin-bottom: 0.75rem;">${crumbs}</div>`;
    }
    
    body.innerHTML = `
      ${breadcrumbHtml}
      <div id="subawardDrillHint" class="drill-hint" style="margin-bottom: 0.5rem; ${drill.level > 0 ? 'display:none;' : ''}">
        
        <span>Click any bar to drill down · click the active bar to drill back up</span>
      </div>
      <svg id="subawardSankeySvg"></svg>
    `;
    
    // Match prime Sankey exactly: measure from parent (chart-wrapper) 
    const w = ((body.parentElement ? body.parentElement.offsetWidth : body.offsetWidth) || 800) - 2;
    const h = Math.max(350, nodes.length * 20);
    
    const svg = d3.select('#subawardSankeySvg')
      .attr('viewBox', `0 0 ${w} ${h}`)
      .attr('preserveAspectRatio', 'xMidYMid meet')
      .style('width', '100%')
      .style('height', 'auto')
      .style('display', 'block');
    
    const sankey = d3.sankey()
      .nodeId(d => d.index)
      .nodeWidth(20)
      .nodePadding(20)
      .extent([[1, 1], [w - 1, h - 6]]);
    
    const { nodes: sankeyNodes, links: sankeyLinks } = sankey({
      nodes: nodes.map(d => Object.assign({}, d)),
      links: d3Links.map(d => Object.assign({}, d))
    });
    
    // Determine node types for drill behavior
    const primeNames = new Set(filteredSubawards.map(s => s['Prime Recipient Name'] || 'Unknown Prime'));
    const subNames = new Set(filteredSubawards.map(s => s['Sub-Awardee Name'] || 'Unknown Sub'));
    const agencyNames = new Set(filteredSubawards.map(s => s['Awarding Agency'] || 'Unknown Agency'));
    const subAgencyNames = new Set(filteredSubawards.map(s => s['Awarding Sub Agency'] || s['Awarding Agency'] || 'Unknown Agency'));
    
    sankeyNodes.forEach(node => {
      // Determine type based on what column the node appears in within the current view
      if (drillHasAgency && !drillHasSubAgency && subAgencyNames.has(node.name) && !primeNames.has(node.name)) {
        node.nodeType = 'subagency';
      } else if (!drillHasAgency && agencyNames.has(node.name) && !primeNames.has(node.name)) {
        node.nodeType = 'agency';
      } else if (primeNames.has(node.name) && !subNames.has(node.name)) {
        node.nodeType = 'prime';
      } else if (subNames.has(node.name)) {
        node.nodeType = 'sub';
      } else if (primeNames.has(node.name)) {
        node.nodeType = 'prime';
      } else {
        node.nodeType = 'sub';
      }
    });
    
    // 3. GRADIENTS
    Utils.getColor.reset();
    const defs = svg.append('defs');
    sankeyLinks.forEach((l, i) => {
      const colorSource = Utils.getColor(l.source.name);
      const colorTarget = Utils.getColor(l.target.name);
      
      const gradient = defs.append('linearGradient')
        .attr('id', `sub-gradient-${i}`)
        .attr('gradientUnits', 'userSpaceOnUse')
        .attr('x1', l.source.x1)
        .attr('x2', l.target.x0);
      
      gradient.append('stop').attr('offset', '0%').attr('stop-color', colorSource);
      gradient.append('stop').attr('offset', '100%').attr('stop-color', colorTarget);
    });
    
    // 4. LINKS
    svg.append('g')
      .attr('fill', 'none')
      .selectAll('path')
      .data(sankeyLinks)
      .join('path')
      .attr('d', d3.sankeyLinkHorizontal())
      .attr('stroke', (d, i) => `url(#sub-gradient-${i})`)
      .attr('stroke-width', d => Math.max(1, d.width))
      .attr('stroke-opacity', 0.4)
      .on('mouseover', function() { d3.select(this).attr('stroke-opacity', 0.8); })
      .on('mouseout', function() { d3.select(this).attr('stroke-opacity', 0.4); })
      .append('title')
      .text(d => `${d.source.name} → ${d.target.name}\n${Utils.money(d.value)}`);
    
    // 5. NODES (with click handler for drill-down / drill-out)
    const isCurrentFilter = (name) => {
      return drill.path.length > 0 && drill.path[drill.path.length - 1].name === name;
    };
    
    svg.append('g')
      .selectAll('rect')
      .data(sankeyNodes)
      .join('rect')
      .attr('x', d => d.x0)
      .attr('y', d => d.y0)
      .attr('height', d => Math.max(1, d.y1 - d.y0))
      .attr('width', d => d.x1 - d.x0)
      .attr('fill', d => Utils.getColor(d.name))
      .attr('opacity', d => isCurrentFilter(d.name) ? 1 : 0.8)
      .attr('stroke', d => isCurrentFilter(d.name) ? '#F1EEE9' : 'none')
      .attr('stroke-width', d => isCurrentFilter(d.name) ? 0 : 0)
      .style('cursor', d => d.name.startsWith('Other') ? 'default' : 'pointer')
      .on('click', function(event, d) {
        if (d.name.startsWith('Other') || d.name.includes('Unknown')) return;
        
        // If clicking the current active filter → drill OUT (go up one level)
        if (isCurrentFilter(d.name)) {
          if (drill.path.length <= 1) {
            App.resetSubawardDrill();
          } else {
            App.drillSubawardToLevel(drill.path.length - 2);
          }
        } else {
          // Drill IN
          App.drillSubaward(d.name, d.nodeType);
        }
      })
      .on('mouseover', function(event, d) { 
        d3.select(this).attr('opacity', 1);
        if (isCurrentFilter(d.name)) {
          d3.select(this).attr('stroke', 'var(--danger)').attr('stroke-width', 0);
        }
      })
      .on('mouseout', function(event, d) { 
        d3.select(this).attr('opacity', isCurrentFilter(d.name) ? 1 : 0.8);
        d3.select(this).attr('stroke', isCurrentFilter(d.name) ? '#F1EEE9' : 'none')
          .attr('stroke-width', isCurrentFilter(d.name) ? 0 : 0);
      })
      .append('title')
      .text(d => {
        const action = isCurrentFilter(d.name) ? '← Click to drill out' : 'Click to drill down →';
        return `${d.name}\n${Utils.money(d.value)}\n${d.name.startsWith('Other') ? '' : action}`;
      });
    
// Render Labels
  const isNarrow = w < 600; // Detect mobile width
  svg.append("g")
    .selectAll("text")
    .data(sankeyNodes)
    .join("text")
    .attr("x", d => (d.x0 < w / 2 ? d.x1 + 6 : d.x0 - 6))
    .attr("y", d => (d.y1 + d.y0) / 2)
    .attr("dy", d => {
      if (d.y1 - d.y0 > 30) {
        return d.x0 < w / 2 ? "-0.5em" : "1.1em"; 
      }
      return "0.35em"; 
    })
    .attr("text-anchor", d => (d.x0 < w / 2 ? "start" : "end"))
    .text(d => Utils.trunc(d.name, isNarrow ? 25 : 40)) // Tighter truncation on mobile
    .style("font-size", "11px")
    .style("font-weight", d => (d.y1 - d.y0 > 30) ? "700" : "400") // Bold the major players
    .style("fill", App.presentationMode ? "#1A1A1A" : "#F1EEE9")
    .style("pointer-events", "none");
},
  // Subaward drill-down handler - multi-level path support
  drillSubaward(name, nodeType) {
    const drill = App.subawardDrillState;
    
    // Push onto path
    drill.path.push({ type: nodeType, name: name });
    drill.level = drill.path.length;
    drill.filter = name;
    drill.filterType = nodeType;
    
    App.activeFeedSource = 'sub';
    
    // Re-render with filter applied — preserve scroll position to avoid jarring jump
    if (App.forecastData.subawards) {
      const scrollY = window.scrollY;
      App.renderSubawardSankey(App.forecastData.subawards);
      App.renderSearchTopPrimes(App.forecastData.subawards);
      App.renderSearchTopSubs(App.forecastData.subawards);
      App.renderSubawardFeed();
      App.renderSubBubbleChart();
      requestAnimationFrame(() => window.scrollTo(0, scrollY));
    }
  },
  
  // Navigate to a specific level in subaward drill path
  drillSubawardToLevel(idx) {
    const drill = App.subawardDrillState;
    if (idx < 0) {
      App.resetSubawardDrill();
      return;
    }
    drill.path = drill.path.slice(0, idx + 1);
    drill.level = drill.path.length;
    if (drill.path.length > 0) {
      drill.filter = drill.path[drill.path.length - 1].name;
      drill.filterType = drill.path[drill.path.length - 1].type;
    } else {
      drill.filter = null;
      drill.filterType = null;
    }
    
    App.activeFeedSource = 'sub';
    
    if (App.forecastData.subawards) {
      const scrollY = window.scrollY;
      App.renderSubawardSankey(App.forecastData.subawards);
      App.renderSearchTopPrimes(App.forecastData.subawards);
      App.renderSearchTopSubs(App.forecastData.subawards);
      App.renderSubawardFeed();
      App.renderSubBubbleChart();
      requestAnimationFrame(() => window.scrollTo(0, scrollY));
    }
  },

  // Reset subaward drill
  resetSubawardDrill() {
    App.subawardDrillState = { level: 0, path: [], filter: null, filterType: null };
    App.activeFeedSource = 'sub'; // Stay on subaward view but unfiltered
    
    if (App.forecastData.subawards) {
      const scrollY = window.scrollY;
      App.renderSubawardSankey(App.forecastData.subawards);
      App.renderSearchTopPrimes(App.forecastData.subawards);
      App.renderSearchTopSubs(App.forecastData.subawards);
      App.renderSubawardFeed();
      App.renderSubBubbleChart();
      requestAnimationFrame(() => window.scrollTo(0, scrollY));
    }
  },

  renderTopBuyers(awards) {
    const body = document.getElementById('topBuyersBody');
    if (!body) return;
    
    // Group by agency
    const agencyMap = {};
    awards.forEach(a => {
      const agency = a['Awarding Agency'] || 'Unknown';
      if (!agencyMap[agency]) {
        agencyMap[agency] = { name: agency, spend: 0, count: 0 };
      }
      agencyMap[agency].spend += parseFloat(a['Award Amount']) || 0;
      agencyMap[agency].count++;
    });
    
    const sorted = Object.values(agencyMap).sort((a, b) => b.spend - a.spend);
    const total = sorted.reduce((s, a) => s + a.spend, 0);
    
    if (sorted.length === 0) {
      body.innerHTML = `<div style="text-align:center; color:var(--text-muted); padding:1rem;">No agency data available</div>`;
      return;
    }
    
    const topAgencies = sorted.slice(0, 8);
    
    body.innerHTML = `
      <div class="buyer-list">
        ${topAgencies.map((a, i) => {
          const share = total > 0 ? (a.spend / total * 100) : 0;
          return `
          <div class="buyer-item">
            <div class="buyer-rank">${i + 1}</div>
            <div class="buyer-info">
              <div class="buyer-name">${Utils.trunc(a.name, 30)}</div>
              <div class="buyer-stats">${a.count} awards · ${share.toFixed(0)}%</div>
            </div>
            <div class="buyer-amount">
              <div class="buyer-spend">${Utils.money(a.spend)}</div>
            </div>
          </div>`;
        }).join('')}
      </div>
      ${sorted.length > 8 ? `<div style="text-align:center; color:var(--text-muted); font-size:0.75rem; margin-top:0.75rem;">+${sorted.length - 8} more agencies</div>` : ''}
    `;
  },

  renderTopWinners(awards) {
    const body = document.getElementById('topWinnersBody');
    if (!body) return;
    
    // Group by vendor
    const vendorMap = {};
    awards.forEach(a => {
      const vendor = a['Recipient Name'] || 'Unknown';
      if (!vendorMap[vendor]) {
        vendorMap[vendor] = { name: vendor, spend: 0, count: 0, agencies: new Set() };
      }
      vendorMap[vendor].spend += parseFloat(a['Award Amount']) || 0;
      vendorMap[vendor].count++;
      vendorMap[vendor].agencies.add(a['Awarding Agency'] || 'Unknown');
    });
    
    const sorted = Object.values(vendorMap)
      .map(v => ({ ...v, agencies: v.agencies.size }))
      .sort((a, b) => b.spend - a.spend);
    const total = sorted.reduce((s, v) => s + v.spend, 0);
    
    if (sorted.length === 0) {
      body.innerHTML = `<div style="text-align:center; color:var(--text-muted); padding:1rem;">No vendor data available</div>`;
      return;
    }
    
    const topVendors = sorted.slice(0, 8);
    
    body.innerHTML = `
      <div class="buyer-list">
        ${topVendors.map((v, i) => {
          const share = total > 0 ? (v.spend / total * 100) : 0;
          
          return `
          <div class="buyer-item">
            <div class="buyer-rank">${i + 1}</div>
            <div class="buyer-info">
              <div class="buyer-name">${Utils.trunc(v.name, 26)}</div>
              <div class="buyer-stats">${v.count} awards · ${v.agencies} ${v.agencies === 1 ? 'agency' : 'agencies'}</div>
            </div>
            <div class="buyer-amount">
              <div class="buyer-spend">${Utils.money(v.spend)}</div>
            </div>
          </div>`;
        }).join('')}
      </div>
      ${sorted.length > 8 ? `<div style="text-align:center; color:var(--text-muted); font-size:0.75rem; margin-top:0.75rem;">+${sorted.length - 8} more vendors</div>` : ''}
    `;
  },

renderRecompetes(recompetes, showAll = false) {
  const container = document.getElementById('recompetesList');
  if (!container) return;
  
  if (!recompetes || recompetes.length === 0) {
    container.innerHTML = '';
    return;
  }
  
  // 1. Mission Gap Risk Calculation
  const withRisk = recompetes.map(r => ({
    ...r,
    risk: Utils.missionGapRisk(r)
  }));
  
  // 2. Metrics Calculation
  const totalRecompeteValue = withRisk.reduce((sum, r) => sum + (parseFloat(r['Award Amount']) || 0), 0);
  const highRiskContracts = withRisk.filter(r => r.risk.level === 'high');
  const highRiskValue = highRiskContracts.reduce((sum, r) => sum + (parseFloat(r['Award Amount']) || 0), 0);
  
  // 3. User-Defined Filtering
  const filtered = App.onlyHighMissionGap 
    ? withRisk.filter(r => r.risk.level === 'high')
    : withRisk;

  // 4. LOAD MORE LOGIC: Limit to 5 unless 'showAll' is true
  const INITIAL_COUNT = 3;
  const displayData = showAll ? filtered : filtered.slice(0, INITIAL_COUNT);
  const hasMore = !showAll && filtered.length > INITIAL_COUNT;
  
  // 5. Subtitle Logic
  let subtitleText = `${Utils.money(totalRecompeteValue)} in ${recompetes.length} contracts expiring within 24 months`;
  if (highRiskContracts.length > 0) {
    subtitleText += ` · <span style="color:var(--danger); font-weight:600;">${highRiskContracts.length} high-risk (${Utils.money(highRiskValue)})</span>`;
  }
  
  // 6. Header
  let html = `
    <div class="section-header">
      <div class="section-title-group">
        <span class="section-title">Expiring Contracts</span>
      </div>
      <div class="mission-gap-filter">
        <span class="section-subtitle">${subtitleText}</span>
        ${highRiskContracts.length > 0 ? `
          <button class="mission-gap-toggle ${App.onlyHighMissionGap ? 'active' : ''}"
        onclick="App.toggleMissionGapFilter()"
        title="Show only contracts with high mission continuity risk">
  
</button>
        ` : ''}
      </div>
    </div>`;
    
  if (filtered.length === 0) {
    html += `<div style="text-align:center; padding:2rem; color:var(--text-muted);">No contracts match the current filter. <a href="#" onclick="App.toggleMissionGapFilter(); return false;" style="color:var(--accent); margin-left:0.5rem;">Show all</a></div>`;
  } else {
    // Recompete card list (timeline chart removed — cards are what matters)

    // Map only the displayData (the limited set)
    html += displayData.map(r => {
      if (!r['End Date']) return '';
      
      const internalId = r['generated_internal_id'];
      const awardUrl = internalId 
        ? `https://www.usaspending.gov/award/${internalId}`
        : (r['Award ID'] ? `https://www.usaspending.gov/search/?hash=&filters=${encodeURIComponent(JSON.stringify({keyword: r['Award ID']}))}` : null);
      
      const endDate = new Date(r['End Date']);
      const m = endDate.getMonth();
      const y = endDate.getFullYear();
      const fy = m >= 9 ? y + 1 : y;
      let q = 1;
      if (m >= 0 && m <= 2) q = 2;
      else if (m >= 3 && m <= 5) q = 3;
      else if (m >= 6 && m <= 8) q = 4;
      const fiscalPeriod = `FY${String(fy).slice(-2)} Q${q}`;

      const today = new Date();
      const daysUntil = Math.ceil((endDate - today) / (1000 * 60 * 60 * 24));
      const urgency = daysUntil < 180 ? 'urgent' : daysUntil < 365 ? 'soon' : 'later';
      
      const risk = r.risk;
      const riskLabel = risk.level === 'high' ? 'Mission Gap: High' : risk.level === 'medium' ? 'Mission Gap: Medium' : 'Mission Gap: Low';
      const esc = str => Autocomplete.escapeHtml(str);
      
      return `
      <div class="deal-card" style="margin-bottom:1rem; ${risk.level === 'high' ? 'border-left: 3px solid var(--danger);' : risk.level === 'medium' ? 'border-left: 3px solid #FDD835;' : ''}">
        <div class="deal-header">
          <span class="deal-agency">${esc(Utils.trunc(r['Awarding Agency'], 40))}</span>
          <span class="deal-amount">${Utils.money(r['Award Amount'])}</span>
        </div>
        <div class="deal-desc">${esc(Utils.trunc(r['Description'], 100))}</div>
        <div class="deal-meta">
          <span class="meta-tag" style="color:var(--accent); border-color:var(--accent);">${fiscalPeriod}</span>
          <span class="meta-tag mission-gap ${risk.level}">${riskLabel}</span>
          ${r['PSC Code'] ? `<span class="meta-tag psc">PSC: ${esc(r['PSC Code'])}</span>` : ''}
        </div>
        ${risk.reasons.length > 0 && risk.level !== 'low' ? `<div class="mission-gap-signals">Signals: ${esc(risk.reasons.join(', '))}</div>` : ''}
        <div class="deal-footer">
          <div>
            <div style="font-size:0.8rem; color:${urgency === 'urgent' ? 'var(--danger)' : urgency === 'soon' ? '#FDD835' : 'var(--text-muted)'}">
              Expires: ${Utils.date(r['End Date'])} (${daysUntil} days)
            </div>
            <div style="font-size:0.75rem; color:var(--text-subtle)">Incumbent: ${esc(Utils.trunc(r['Recipient Name'], 35))}</div>
          </div>
          <div style="display:flex;gap:0.5rem;align-items:center;">
            <button onclick="Utils.copyRecompeteToClipboard(this, '${esc(r['Awarding Agency'] || '')}', '${esc(r['Awarding Sub Agency'] || '')}', '${esc(r['Recipient Name'] || '')}', '${Utils.money(r['Award Amount'])}', '${esc(Utils.trunc(r['Description'] || '', 200))}', '${r['Start Date'] || ''}', '${r['End Date'] || ''}', '${esc(r['Award ID'] || '')}', '${esc(r['PSC Code'] || '')}', '${esc(r['PSC Description'] || '')}', '${esc(r['NAICS Code'] || '')}', '${esc(r['NAICS Description'] || '')}', '${r['Type of Set Aside'] || ''}', '${awardUrl || ''}')" class="action-btn"></button>
            ${awardUrl ? `<a href="${awardUrl}" target="_blank" class="action-btn">VIEW</a>` : ''}
          </div>
        </div>
      </div>`;
    }).join('');
    
    // 8. Add the "Show All" button if there are more items
    if (hasMore) {
      html += `
        <button onclick="App.renderRecompetes(App.forecastData.analysis.recompetes, true)" style="width: 100%; padding: 0.875rem; background: var(--bg-card); border: 1px dashed var(--border); border-radius: 4px; color: var(--accent); font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; cursor: pointer; transition: all 0.2s; text-transform: uppercase; letter-spacing: 1px;" onmouseover="this.style.borderColor='var(--accent)';this.style.background='var(--accent-dim)'" onmouseout="this.style.borderColor='var(--border)';this.style.background='var(--bg-card)'">
          Show All ${filtered.length} Expiring Contracts
        </button>`;
    }
  }
  
  container.innerHTML = html;
},
  toggleMissionGapFilter() {
    App.onlyHighMissionGap = !App.onlyHighMissionGap;
    // Re-render with current recompetes data
    if (App.forecastData.analysis && App.forecastData.analysis.recompetes) {
      this.renderRecompetes(App.forecastData.analysis.recompetes);
    }
  },

// --- Helpers ---
  exportCSV(btn) {
    const data = App.mode === 'search' ? App.searchData.active : ([]);
    
    // IF NO DATA: Flash Red (Error)
    if (!data.length) {
      if (btn) {
        const originalHtml = btn.innerHTML;
        btn.style.color = 'var(--danger)';
        btn.style.borderColor = 'var(--danger)';
        btn.innerHTML = ''; 
        setTimeout(() => {
          btn.style.color = '';
          btn.style.borderColor = '';
          btn.innerHTML = originalHtml;
        }, 2000);
      }
      return;
    }
    
    // Updated Headers with Fiscal Period
    const headers = ['Fiscal Period', 'Recipient', 'Agency', 'Sub-Agency', 'Total Obligations', 'Description', 'Start Date', 'End Date', 'Award ID', 'Award Link'];
    
    const rows = data.map(c => {
      // Logic for FY26 Q1 shorthand
      let fiscalPeriod = 'N/A';
      if (c['Start Date']) {
        const d = new Date(c['Start Date']);
        const m = d.getMonth(); 
        const y = d.getFullYear();
        const fy = m >= 9 ? y + 1 : y;
        let q;
        if (m >= 9) q = 1;        // Oct-Nov-Dec = Q1
        else if (m <= 2) q = 2;   // Jan-Feb-Mar = Q2
        else if (m <= 5) q = 3;   // Apr-May-Jun = Q3
        else q = 4;               // Jul-Aug-Sep = Q4
        fiscalPeriod = `FY${String(fy).slice(-2)} Q${q}`;
      }

      const internalId = c['generated_internal_id']; 
      let awardUrl = '';
      if (internalId) awardUrl = `https://www.usaspending.gov/award/${internalId}`;
      else if (c['Award ID']) awardUrl = `https://www.usaspending.gov/search/?hash=&filters=${encodeURIComponent(JSON.stringify({keyword: c['Award ID']}))}`;
      
      return [
        `"${fiscalPeriod}"`,
        `"${(c['Recipient Name'] || '').replace(/"/g, '""')}"`, 
        `"${(c['Awarding Agency'] || '').replace(/"/g, '""')}"`, 
        `"${(c['Awarding Sub Agency'] || '').replace(/"/g, '""')}"`, 
        c['Award Amount'] || 0, 
        `"${(c['Description'] || '').replace(/"/g, '""')}"`, 
        c['Start Date'] || '', 
        c['End Date'] || '', 
        c['Award ID'] || '', 
        awardUrl
      ];
    });
    
    const csvContent = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a"); 
    link.setAttribute("href", url); 
    link.setAttribute("download", `govhoo_${App.mode}_${App.currentQuery}.csv`);
    document.body.appendChild(link); link.click(); document.body.removeChild(link);

    // SUCCESS: Flash Green
    if (btn) {
      const originalHtml = btn.innerHTML;
      btn.style.color = 'var(--success)';
      btn.style.borderColor = 'var(--success)';
      btn.innerHTML = ''; 
      setTimeout(() => {
        btn.style.color = '';
        btn.style.borderColor = '';
        btn.innerHTML = originalHtml;
      }, 2000);
    }
  },
  
  showLoader(text, subtext) { document.getElementById('loaderText').innerText = text; document.getElementById('loaderSubtext').innerText = subtext || ''; document.getElementById('loader').style.display = 'flex'; },
  hideLoader() { document.getElementById('loader').style.display = 'none'; },
  transitionToApp() {
    const hero = document.getElementById('heroView'); 
    hero.classList.add('slide-up');
    document.getElementById('appView').style.display = 'block'; 
    document.getElementById('miniSearch').value = App.currentQuery;
    document.getElementById('dashboardContainer').classList.add('active'); 
    const dashContainer = document.getElementById('dashboardContainer');
    if (!dashContainer.querySelector('.hero-footer')) {
      const heroFooter = hero.querySelector('.hero-footer');
      if (heroFooter) {
        const footerClone = heroFooter.cloneNode(true);
        // Remove the ID to prevent duplicates (if you add IDs later)
        footerClone.removeAttribute('id'); 
        dashContainer.appendChild(footerClone);
      }
    }

    setTimeout(() => { 
      hero.style.display = 'none'; 
      hero.classList.add('hidden'); 
    }, 500);
  },
  
  shareLink(btn) {
    const url = new URL(window.location); url.searchParams.set('q', App.currentQuery); url.searchParams.set('mode', App.mode);
    navigator.clipboard.writeText(url.toString()).then(() => {
      if (btn) {
        const originalHtml = btn.innerHTML;
        btn.style.color = 'var(--success)';
        btn.style.borderColor = 'var(--success)';
        btn.innerHTML = '';
        setTimeout(() => {
          btn.style.color = '';
          btn.style.borderColor = '';
          btn.innerHTML = originalHtml;
        }, 2000);
      }
    });
  },

  shareBrief(btn) {
    const data = App.searchData.active;
    const query = App.currentQuery || 'Unknown';
    const totalValue = data.reduce((sum, c) => sum + (parseFloat(c['Award Amount']) || 0), 0);
    const agencies = new Set(data.map(c => c['Awarding Agency']).filter(Boolean));
    const vendors = new Set(data.map(c => c['Recipient Name']).filter(Boolean));
    
    // Count expiring contracts (within 90 days)
    const now = new Date();
    const d90 = new Date(now.getTime() + 90 * 24 * 60 * 60 * 1000);
    let expiringCount = 0, expiringValue = 0;
    data.forEach(c => {
      if (c['End Date']) {
        const end = new Date(c['End Date']);
        if (end >= now && end <= d90) { expiringCount++; expiringValue += parseFloat(c['Award Amount']) || 0; }
      }
    });
    
    // Build the brief
    const url = new URL(window.location);
    url.searchParams.set('q', query);
    url.searchParams.set('mode', App.mode);
    
    let brief = `🔍️ Govhoo Search: "${query}"\n`;
    brief += `💰 ${Utils.money(totalValue)} across ${agencies.size} agencies, ${vendors.size} vendors\n`;
    if (expiringCount > 0) brief += `🔥 ${expiringCount} contracts expiring in 90 days (${Utils.money(expiringValue)})\n`;
    
    // Subaward intel if available
    if (App.forecastData?.subawards?.length) {
      const subTotal = App.forecastData.subawards.reduce((s, r) => s + (parseFloat(r['Sub-Award Amount']) || 0), 0);
      brief += `💸 ${App.forecastData.subawards.length} subcontracts tracked (${Utils.money(subTotal)})\n`;
    }
    
    brief += `👉 ${url.toString()}`;
    
    navigator.clipboard.writeText(brief).then(() => {
      if (btn) {
        const originalHtml = btn.innerHTML;
        btn.style.color = 'var(--success)';
        btn.style.borderColor = 'var(--success)';
        btn.innerHTML = '';
        setTimeout(() => {
          btn.style.color = '';
          btn.style.borderColor = '';
          btn.innerHTML = originalHtml;
        }, 2000);
      }
    });
  }
};

const PromptPackageGenerator = {
  calculateMetrics(data, analysis) {
    const totalValue = data.reduce((sum, r) => sum + (parseFloat(r['Award Amount']) || 0), 0);
    const contractCount = data.length;
    const avgDealSize = contractCount > 0 ? totalValue / contractCount : 0;
    const amounts = data.map(r => parseFloat(r['Award Amount']) || 0).filter(a => a > 0).sort((a, b) => a - b);
    // Proper median calculation: average middle two values for even-length arrays
    let medianDealSize = 0;
    if (amounts.length > 0) {
      const mid = Math.floor(amounts.length / 2);
      medianDealSize = amounts.length % 2 !== 0 
        ? amounts[mid] 
        : (amounts[mid - 1] + amounts[mid]) / 2;
    }
    const largeDeals = amounts.filter(a => a >= 1000000).length;
    const midDeals = amounts.filter(a => a >= 100000 && a < 1000000).length;
    const smallDeals = amounts.filter(a => a < 100000).length;
    
    const now = new Date();
    const expiringContracts = data.filter(c => {
      const endDate = new Date(c['End Date']);
      const monthsOut = (endDate - now) / (1000 * 60 * 60 * 24 * 30);
      return monthsOut > 0 && monthsOut <= 18;
    });
    const expiringValue = expiringContracts.reduce((s, c) => s + (parseFloat(c['Award Amount']) || 0), 0);
    
    return {
      totalValue, contractCount, avgDealSize, medianDealSize,
      largeDeals, midDeals, smallDeals,
      expiringValue, expiringCount: expiringContracts.length
    };
  },

  buildVendorIntel(data) {
    const vendorMap = {};
    const now = new Date();
    
    data.forEach(r => {
      const v = r['Recipient Name'] || 'Unknown';
      if (!vendorMap[v]) vendorMap[v] = { 
        spend: 0, count: 0, agencies: new Set(), contracts: [], expiring: 0
      };
      const amt = parseFloat(r['Award Amount']) || 0;
      vendorMap[v].spend += amt;
      vendorMap[v].count++;
      vendorMap[v].agencies.add(r['Awarding Agency']);
      vendorMap[v].contracts.push(r);
      
      const endDate = new Date(r['End Date']);
      const monthsOut = (endDate - now) / (1000 * 60 * 60 * 24 * 30);
      if (monthsOut > 0 && monthsOut <= 18) {
        vendorMap[v].expiring += amt;
      }
    });
    
    const totalSpend = Object.values(vendorMap).reduce((s, v) => s + v.spend, 0);
    
    return Object.entries(vendorMap)
      .map(([name, d]) => ({
        name, spend: d.spend,
        share: totalSpend > 0 ? ((d.spend / totalSpend) * 100) : 0,
        contracts: d.count, agencies: d.agencies.size,
        expiring: d.expiring, avgDeal: d.count > 0 ? d.spend / d.count : 0,
        isChannel: false
      }))
      .sort((a, b) => b.spend - a.spend);
  },

  buildAgencyIntel(data) {
    const agencyMap = {};
    const now = new Date();
    data.forEach(r => {
      const ag = r['Awarding Agency'] || 'Unknown';
      const sub = r['Awarding Sub Agency'] || 'Unknown';
      if (!agencyMap[ag]) agencyMap[ag] = { spend: 0, count: 0, subs: {}, vendors: {}, vehicles: new Set(), setAsides: new Set(), contractTypes: new Set(), expiring: 0, expiringCount: 0 };
      
      const amt = parseFloat(r['Award Amount']) || 0;
      agencyMap[ag].spend += amt;
      agencyMap[ag].count++;
      
      if (!agencyMap[ag].subs[sub]) agencyMap[ag].subs[sub] = { spend: 0, count: 0, vendors: {} };
      agencyMap[ag].subs[sub].spend += amt;
      agencyMap[ag].subs[sub].count++;
      
      const v = r['Recipient Name'] || 'Unknown';
      if (!agencyMap[ag].vendors[v]) agencyMap[ag].vendors[v] = 0;
      agencyMap[ag].vendors[v] += amt;
      if (!agencyMap[ag].subs[sub].vendors[v]) agencyMap[ag].subs[sub].vendors[v] = 0;
      agencyMap[ag].subs[sub].vendors[v] += amt;
      
      // Vehicle & set-aside tracking
      const vehicle = VehicleDetector.detect(r['Award ID']);
      if (vehicle) agencyMap[ag].vehicles.add(vehicle.short);
      const sa = VehicleDetector.getSetAsideLabel(r['Type of Set Aside']);
      if (sa) agencyMap[ag].setAsides.add(sa);
      const ct = Utils.getContractTypeTag(r['Contract Award Type']);
      if (ct) agencyMap[ag].contractTypes.add(ct.short);
      
      // Expiring
      const endDate = new Date(r['End Date']);
      const monthsOut = (endDate - now) / (1000 * 60 * 60 * 24 * 30);
      if (monthsOut > 0 && monthsOut <= 18) {
        agencyMap[ag].expiring += amt;
        agencyMap[ag].expiringCount++;
      }
    });
    
    const totalSpend = Object.values(agencyMap).reduce((s, a) => s + a.spend, 0);
    
    return Object.entries(agencyMap)
      .map(([name, d]) => {
        const topVendors = Object.entries(d.vendors).sort((a, b) => b[1] - a[1]).slice(0, 5).map(([v, s]) => ({ name: v, spend: s, share: d.spend > 0 ? ((s / d.spend) * 100) : 0 }));
        const topSubs = Object.entries(d.subs).sort((a, b) => b[1].spend - a[1].spend).slice(0, 5).map(([s, info]) => {
          const subTopVendor = Object.entries(info.vendors).sort((a, b) => b[1] - a[1])[0];
          return { name: s, spend: info.spend, count: info.count, topVendor: subTopVendor ? subTopVendor[0] : 'Unknown' };
        });
          
        return {
          name, spend: d.spend,
          share: totalSpend > 0 ? ((d.spend / totalSpend) * 100) : 0,
          contracts: d.count, topVendors, topSubs,
          incumbent: topVendors[0]?.name || 'Unknown',
          vehicles: [...d.vehicles],
          contractTypes: [...d.contractTypes],
          setAsides: [...d.setAsides],
          expiring: d.expiring,
          expiringCount: d.expiringCount
        };
      })
      .sort((a, b) => b.spend - a.spend);
  },

  generatePrompt(extracted, config) {
    const mf = v => Utils.money(v);
    const pct = v => (v && !isNaN(v)) ? v.toFixed(1) + '%' : '0.0%';
    const query = extracted.query.toUpperCase();
    const fyShorthand = `FY${String(Utils.getCurrentFY()).slice(-2)}`;
    const fyFull = Utils.getCurrentFY();

    const competitors = extracted.vendors.filter(v => !v.isChannel);
    const channels = extracted.vendors.filter(v => v.isChannel);
    const agencies = extracted.agencies.slice(0, 6);
    const metrics = extracted.metrics;
    
    // Vendor relationship tags from user
    const tagged = VendorRelationships.getTagged();
    const hasRelTags = tagged.mine.length || tagged.partner.length || tagged.competitor.length;
    
    const analysis = extracted.analysis || {};
    const recompeteVal = metrics.expiringValue;
    
    // Collect all vehicles and set-asides across agencies
    const allVehicles = [...new Set(agencies.flatMap(a => a.vehicles || []))];
    const allSetAsides = [...new Set(agencies.flatMap(a => a.setAsides || []))];
    
    // Build sub-agency detail table
    const subAgencyRows = agencies.flatMap(a => 
      (a.topSubs || []).map(s => `| ${a.name} | ${s.name} | ${mf(s.spend)} | ${s.count} | ${s.topVendor} |`)
    ).slice(0, 15);
    
    // Build expiring contract summary from recompetes if available
    const recompetes = analysis.recompetes || [];
    const recompeteRows = recompetes.slice(0, 10).map(r => {
      const endDate = r['End Date'] ? new Date(r['End Date']) : null;
      const daysOut = endDate ? Math.ceil((endDate - new Date()) / (1000*60*60*24)) : 0;
      const risk = Utils.missionGapRisk ? Utils.missionGapRisk(r) : { level: 'unknown' };
      return `| ${(r['Awarding Sub Agency'] || r['Awarding Agency'] || 'Unknown').substring(0, 30)} | ${(r['Recipient Name'] || 'Unknown').substring(0, 25)} | ${mf(r['Award Amount'])} | ${Utils.date(r['End Date'])} | ${daysOut}d | ${risk.level || '—'} |`;
    });

    return `
<SYSTEM_INSTRUCTIONS_INTERNAL>
- ROLE: Senior Federal Sales Director at a Tier-1 CSP/Defense Prime.
- DATA INTEGRITY: Use ONLY the provided data below. Every table, vendor, and dollar figure comes from live USASpending.gov awards.
- CLOSED UNIVERSE: Do not hallucinate outside companies, placeholder vendors, or market stats.
- ACTIONABILITY: Every recommendation must tie to a specific agency, vendor, vehicle, or contract from the data.
- START RESPONSE IMMEDIATELY with the # Title. Do not include meta-commentary.
</SYSTEM_INSTRUCTIONS_INTERNAL>

# Federal Go-To-Market Plan: ${query}

**Scope**: Fiscal Year ${fyFull} (${fyShorthand}). Total addressable: ${mf(metrics.totalValue)} across ${metrics.contractCount} contracts.
**Median Deal**: ${mf(metrics.medianDealSize)} · **Expiring Value**: ${mf(recompeteVal)} across ${metrics.expiringCount} expiring contracts.
${allVehicles.length > 0 ? `**Active Vehicles**: ${allVehicles.join(', ')}` : ''}
${allSetAsides.length > 0 ? `**Set-Aside Types**: ${allSetAsides.join(', ')}` : ''}
${hasRelTags ? `
**User's Vendor Relationships** (use these to personalize ALL recommendations):
${tagged.mine.length ? `- MY COMPANY: ${tagged.mine.join(', ')}` : ''}
${tagged.partner.length ? `- PARTNERS: ${tagged.partner.join(', ')}` : ''}
${tagged.competitor.length ? `- COMPETITORS: ${tagged.competitor.join(', ')}` : ''}
` : ''}

---

## EXECUTIVE SUMMARY
One high-density paragraph stating the ${fyShorthand} target revenue range (calculated as a percentage of the ${mf(recompeteVal)} expiring contract value), primary competitive risk, top 3 accounts by priority, and the recommended go-to-market motion (direct, partner-led, or hybrid). ${hasRelTags ? 'Frame the summary around displacing COMPETITORS and leveraging PARTNERS.' : ''}

## MARKET DYNAMICS
Four sentences explaining how revenue flows in the ${query} market. Specifically address: incumbency lock-in, contract vehicle gatekeeping, and the role of set-aside requirements (${allSetAsides.length > 0 ? allSetAsides.join(', ') : 'none identified'}) in shaping capture strategy.

## SUB-AGENCY ACCOUNT MAP
This is the granular view. These are the buying offices — the people your users met at conferences like AFCEA West.

| Parent Agency | Sub-Agency / Command | Spend | Contracts | Top Incumbent |
|---|---|---:|---:|---|
${subAgencyRows.length > 0 ? subAgencyRows.join('\n') : '> No sub-agency data available.'}

For each sub-agency above:
- Identify the specific incumbent vulnerability (single-vendor dependency, expiring contracts, set-aside mismatch)
- Recommend whether to pursue direct or through a partner, and name the specific partner from the data
- Assign priority (Tier 1 = pursue now, Tier 2 = develop, Tier 3 = monitor)

## COMPETITIVE LANDSCAPE
| Vendor | Spend | Market Share | Contracts | Agencies | Expiring | Dominance Risk |
|---|---:|---:|---:|---:|---:|---|
${competitors.slice(0,8).map(c => {
  const dominance = c.share > 40 ? 'HIGH — single-vendor lock' : c.share > 20 ? 'MEDIUM — strong position' : 'LOW — fragmented';
  const rel = VendorRelationships.get(c.name);
  const tag = rel === 'mine' ? ' MY CO' : rel === 'partner' ? ' PARTNER' : rel === 'competitor' ? ' TARGET' : '';
  return `| ${c.name}${tag} | ${mf(c.spend)} | ${pct(c.share)} | ${c.contracts} | ${c.agencies} | ${mf(c.expiring)} | ${dominance} |`;
}).join('\n')}

Analysis requirements:
* For each vendor with >20% share: identify their specific lock-in mechanism and the conditions under which they can be displaced
* For vendors with high expiring values: these contracts are ending — watch for follow-on solicitations — recommend specific displacement actions
* ${hasRelTags && tagged.competitor.length ? `Specifically detail how to displace ${tagged.competitor.join(' and ')} using data above` : 'Identify the top 2 displacement targets'}

## CHANNEL & PARTNER LANDSCAPE
${channels.length === 0 ? '> No channel partners identified. Mark vendors as channel partners in the vendor relationship tags to populate this section.' : `
| Partner | Spend | Share | Contracts | Agencies | Expiring |
|---|---:|---:|---:|---:|---:|
${channels.slice(0,6).map(c =>
`| ${c.name} | ${mf(c.spend)} | ${pct(c.share)} | ${c.contracts} | ${c.agencies} | ${mf(c.expiring)} |`
).join('\n')}

For each partner above: where do they provide "speed to contract" via established vehicles? Which sub-agencies above should be pursued through each partner vs. direct?`}

## CONTRACT VEHICLE STRATEGY
${allVehicles.length > 0 || allSetAsides.length > 0 ? `### Contract Vehicle & Capture Posture
${allVehicles.length > 0 ? `Active vehicles in this market: **${allVehicles.join(', ')}**.` : ''}
${allSetAsides.length > 0 ? `Vehicle-detected set-asides: **${allSetAsides.join(', ')}**.` : ''}

For each vehicle above:
- Which agencies/sub-agencies are buying through it?
- Which incumbents hold positions that could serve as teaming partners?
- What is the path to contract for a new entrant vs. an existing position holder?` : `No specific contract vehicles detected in award IDs. Recommend the most likely vehicles needed for market entry based on the agencies and deal sizes above (e.g., GSA Schedule, OASIS+, SeaPort-NxG, CIO-SP4).`}

## EXPIRING CONTRACTS — IMMEDIATE PIPELINE
${recompeteRows.length > 0 ? `These contracts are expiring within 24 months. For context on incumbent and agency relationships only — end of PoP does not guarantee a follow-on solicitation.

| Sub-Agency | Incumbent | Value | End Date | Days Out | Mission Risk |
|---|---|---:|---|---:|---|
${recompeteRows.join('\n')}

For the top 5 expiring contracts:
- Is the incumbent likely to be sole-sourced or will this be competed?
- What is the recommended capture action (bid direct, team, or monitor)?
- What is the 30/60/90 day action plan for each?` : `> No expiring contracts detected in current data window. Consider expanding search timeframe.`}

## PARTNER-TO-INCUMBENT ATTACK MAP
Map the most logical displacement paths using the agency, vehicle, and partner data above.

| Target Incumbent | Sub-Agency | Vehicle | Vulnerability | Recommended Path | Why Now |
|---|---|---|---|---|---|
${competitors.slice(0,4).map((comp, i) => {
  const partner = channels.length > 0 ? channels[i % channels.length].name : 'DIRECT';
  const vehicle = allVehicles.length > 0 ? allVehicles[i % allVehicles.length] : 'TBD';
  return `| ${comp.name} | ${agencies[i % agencies.length]?.topSubs?.[0]?.name || 'Primary'} | ${vehicle} | ${mf(comp.expiring)} expiring | ${partner} | Recompete window |`;
}).join('\n')}

## PIPELINE TARGETS
Based on the data:
- **Contracts ending within 24 months**: ${mf(recompeteVal)} (${metrics.expiringCount} contracts)
- **Median deal size**: ${mf(metrics.medianDealSize)}
- **Deal mix**: ${metrics.largeDeals} large ($1M+), ${metrics.midDeals} mid ($100K-$1M), ${metrics.smallDeals} small (<$100K)

Calculate a realistic ${fyShorthand} revenue target as a range (conservative/moderate/aggressive) based on win rates of 15%/25%/35% against expiring contract value. State the required number of active pursuits to hit each target.

## GO-TO-MARKET MOTION
State clearly whether execution is Partner-Led, Direct-Led, or Hybrid. Base this on:
- Vehicle access (do you hold the vehicles above or need a partner?)
- Set-aside requirements (do contracts require SB teaming?)
- Incumbent concentration (are there openings or is the market locked?)

## NEXT 30 DAYS: EXECUTION SPRINT
| Day | Action | Owner | Deliverable | Kill/Go Gate |
|---|---|---|---|---|
| 1-5 | | BD Lead | | |
| 6-15 | | Capture Mgr | | |
| 16-25 | | BD + Technical | | |
| 26-30 | | BD Lead | Pipeline Review | Kill/No-Go |

Fill this table with specific actions tied to the sub-agencies, incumbents, and vehicles from the data above. Every action must reference a real entity from this plan.

## RISKS AND MITIGATION
| Risk | Likelihood | Impact | Mitigation |
|---|---|---|---|
| Vehicle lock-out | | | |
| Incumbent protest | | | |
| Set-aside mismatch | | | |
| Funding uncertainty | | | |
| Partner dependency | | | |

## APPENDIX: DATA SOURCES
All data sourced from USASpending.gov via Govhoo.com. Search query: "${query}". ${metrics.contractCount} contracts analyzed across ${agencies.length} agencies. Generated ${new Date().toISOString().split('T')[0]}.`;
  },
  
  buildPackage(data, analysis, config = {}) {
    const metrics = this.calculateMetrics(data, analysis);
    const vendors = this.buildVendorIntel(data);
    const agencies = this.buildAgencyIntel(data);
    
    return this.generatePrompt({
      query: App.currentQuery,
      metrics,
      vendors,
      agencies,
      analysis // Pass this through even if null
    }, config);
  },

  downloadPackage(promptText) {
    const blob = new Blob([promptText], { type: 'text/plain;charset=utf-8' });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    const fy = Utils.getCurrentFY();
    link.download = `Territory_Plan_FY${fy}_${App.currentQuery.replace(/\s+/g, '_')}.txt`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }
};



// ==================== BUBBLE CHART (Drill-Synced) ====================
App.bubbleMode = 'auto'; // 'auto' = follows drill state, or manual override

App.bubbleChartType = 'bubbles';

App.setBubbleChartType = function(type) {
  App.bubbleChartType = type;
  document.getElementById('chartTypeBubbles').classList.toggle('active', type === 'bubbles');
  document.getElementById('chartTypeTreemap').classList.toggle('active', type === 'treemap');
  App.renderBubbleChart();
};

App.setBubbleMode = function(mode) {
  App.bubbleMode = mode;
  // Update toggle buttons
  document.getElementById('bubbleToggleVendors').classList.toggle('active', mode === 'vendors');
  document.getElementById('bubbleToggleAgencies').classList.toggle('active', mode === 'agencies');
  document.getElementById('bubbleToggleSubAgencies').classList.toggle('active', mode === 'subagencies');
  App.renderBubbleChart();
};

// Determine the effective bubble view based on drill state + manual override
App.getEffectiveBubbleMode = function() {
  if (App.bubbleMode !== 'auto') return App.bubbleMode;
  const drill = App.drillState || {};
  if (drill.level === 0) return 'vendors';
  if (drill.level === 1) return 'subagencies';
  return 'vendors';
};

// Update bubble toggle buttons to reflect current drill context
App.updateBubbleToggles = function() {
  const drill = App.drillState || {};
  const vendorsBtn = document.getElementById('bubbleToggleVendors');
  const agenciesBtn = document.getElementById('bubbleToggleAgencies');
  const subAgenciesBtn = document.getElementById('bubbleToggleSubAgencies');
  
  // Show sub-agencies toggle only when drilled into an agency
  if (subAgenciesBtn) {
    subAgenciesBtn.style.display = drill.level >= 1 ? 'inline-block' : 'none';
  }
  
  // Determine effective mode
  const effective = App.getEffectiveBubbleMode();
  
  vendorsBtn.classList.toggle('active', effective === 'vendors');
  agenciesBtn.classList.toggle('active', effective === 'agencies');
  if (subAgenciesBtn) subAgenciesBtn.classList.toggle('active', effective === 'subagencies');
  
  // Update subtitle
  const subtitle = document.getElementById('bubbleChartSubtitle');
  if (subtitle) {
    const modeLabels = {
      'agencies': 'Top Active Agencies · Lifetime Funded Value',
      'subagencies': 'Top Active Sub-Agencies · Lifetime Funded Value',
      'vendors': 'Top Active Vendors · Lifetime Funded Value'
    };
    subtitle.textContent = modeLabels[effective] || 'Top Active Vendors & Agencies · Lifetime Funded Value';
  }
};

// Render bubble breadcrumb (synced with Sankey drill state)
App.renderBubbleBreadcrumb = function() {
  const bc = document.getElementById('bubbleBreadcrumb');
  const inner = document.getElementById('bubbleBreadcrumbInner');
  if (!bc || !inner) return;
  
  const drill = App.drillState || {};
  
  if (drill.level === 0) {
    bc.style.display = 'none';
    return;
  }
  
  bc.style.display = 'block';
  
  let html = `<div class="bubble-bc-item" onclick="App.resetDrill()"> All</div>`;
  
  if (drill.path && drill.path.length > 0) {
    drill.path.forEach((step, i) => {
      const isLast = i === drill.path.length - 1;
      const icon = step.type === 'agency' ? 'fa-landmark' : step.type === 'sub' ? 'fa-sitemap' : 'fa-building';
      const clickAction = isLast ? '' : `onclick="App.drillToLevel(${i + 1})"`;
      html += `<span class="bubble-bc-sep"></span>`;
      html += `<div class="bubble-bc-item ${isLast ? 'active' : ''}" ${clickAction}> ${Utils.trunc(step.name, 30)}</div>`;
    });
  }
  
  inner.innerHTML = html;
};

App.renderBubbleChart = function() {
  const container = document.getElementById('bubbleChartContainer');
  const panel = document.getElementById('bubbleChartPanel');
  if (!container || !panel) return;
  
  const data = App.searchData.active;
  if (!data || data.length === 0) {
    panel.style.display = 'none';
    return;
  }
  
  panel.style.display = 'block';
  
  // Update toggles and breadcrumb to reflect drill state
  App.updateBubbleToggles();
  App.renderBubbleBreadcrumb();
  
  const drill = App.drillState || {};
  const effective = App.getEffectiveBubbleMode();
  
  // Aggregate data based on effective mode
  const entityMap = {};
  let totalSpend = 0;
  
  data.forEach(award => {
    let key;
    if (effective === 'agencies') {
      key = award['Awarding Agency'] || 'Unknown';
    } else if (effective === 'subagencies') {
      key = award['Awarding Sub Agency'] || award['Awarding Agency'] || 'Unknown';
    } else {
      key = award['Recipient Name'] || 'Unknown';
    }
    const amount = parseFloat(award['Award Amount']) || 0;
    
    if (!entityMap[key]) {
      entityMap[key] = { 
        name: key, 
        spend: 0, 
        count: 0,
        agencies: new Set(),
        subAgencies: new Set(),
        vendors: new Set(),
        // Track the parent agency for sub-agency bubbles
        parentAgency: null
      };
    }
    entityMap[key].spend += amount;
    entityMap[key].count++;
    entityMap[key].agencies.add(award['Awarding Agency'] || 'Unknown');
    entityMap[key].subAgencies.add(award['Awarding Sub Agency'] || '');
    entityMap[key].vendors.add(award['Recipient Name'] || 'Unknown');
    if (effective === 'subagencies') {
      entityMap[key].parentAgency = award['Awarding Agency'] || 'Unknown';
    }
    totalSpend += amount;
  });
  
  // Convert to array and sort
  let entities = Object.values(entityMap)
    .filter(e => e.spend > 0)
    .sort((a, b) => b.spend - a.spend)
    .slice(0, 50);
  
  if (entities.length === 0) {
    panel.style.display = 'none';
    return;
  }
  
  // Convert Sets to counts
  entities.forEach(e => {
    e.agencyCount = e.agencies ? e.agencies.size : 0;
    e.subAgencyCount = e.subAgencies ? e.subAgencies.size : 0;
    e.vendorCount = e.vendors ? e.vendors.size : 0;
    delete e.agencies;
    delete e.subAgencies;
    delete e.vendors;
  });
  
  // --- Update header stats ---
  const uniqueAgencies = new Set(data.map(a => a['Awarding Agency'])).size;
  const uniqueVendors = new Set(data.map(a => a['Recipient Name'])).size;
  const volEl = document.getElementById('bubble-stat-vol');
  const agEl = document.getElementById('bubble-stat-agencies');
  const ctEl = document.getElementById('bubble-stat-count');
  const vnEl = document.getElementById('bubble-stat-vendors');
  const enEl = document.getElementById('bubble-stat-entities');
  const enLabelEl = document.getElementById('bubble-stat-entities-label');
  const subtitleEl = document.getElementById('bubbleChartSubtitle');
  
  if (volEl) volEl.innerText = Utils.money(totalSpend);
  if (agEl) agEl.innerText = uniqueAgencies;
  if (ctEl) ctEl.innerText = data.length;
  if (vnEl) vnEl.innerText = uniqueVendors;
  if (enEl) enEl.innerText = entities.length;
  if (subtitleEl) {
    const query = App.currentQuery ? '"' + App.currentQuery.toUpperCase() + '" · ' : '';
    const modeLabel = { agencies: 'Agencies', subagencies: 'Sub-Agencies', vendors: 'Vendors' };
    subtitleEl.textContent = query + 'Top Active ' + (modeLabel[effective] || 'Vendors') + ' · Lifetime Funded Value';
  }
  
  // Clear previous
  const tooltip = document.getElementById('bubbleTooltip');
  container.querySelectorAll('svg').forEach(s => s.remove());
  
  // Dimensions
  const rect = container.getBoundingClientRect();
  const w = Math.max(rect.width || 600, 300);
  const h = Math.max(420, Math.min(w * 0.7, 600));
  
  // Color palette — Govhoo vintage chalk tones
  const bubbleColors = [
    '#466D5C', '#7B6D8D', '#5B7C99', '#E07A5F',
    '#D98895', '#3D405B', '#F2E8CF', '#81B29A',
    '#778DA9', '#606C38'
];

  // Shared tooltip + click handler builder
  function attachInteractions(selection) {
    selection
      .on('mouseover', function(event, d) {
        const entity = d.data || d;
        const share = totalSpend > 0 ? ((entity.spend / totalSpend) * 100).toFixed(1) : '0';
        let metaText;
        if (effective === 'agencies') {
          metaText = `${entity.count} awards · ${entity.vendorCount} vendors · ${share}%`;
        } else if (effective === 'subagencies') {
          metaText = `${entity.count} awards · ${entity.vendorCount} vendors · ${share}%`;
        } else {
          metaText = `${entity.count} awards · ${entity.agencyCount} agencies · ${share}%`;
        }
        let drillHint = '';
        if (effective === 'agencies') drillHint = '<div style="color:var(--accent);font-size:0.6rem;margin-top:3px;">Click to drill into sub-agencies →</div>';
        else if (effective === 'subagencies') drillHint = '<div style="color:var(--accent);font-size:0.6rem;margin-top:3px;">Click to drill into vendors →</div>';
        else if (effective === 'vendors' && drill.level < 3) drillHint = '<div style="color:var(--accent);font-size:0.6rem;margin-top:3px;">Click to focus on this vendor →</div>';
        tooltip.innerHTML = `
          <div class="bubble-tooltip-name">${entity.name}</div>
          <div class="bubble-tooltip-amount">${Utils.money(entity.spend)}</div>
          <div class="bubble-tooltip-meta">${metaText}</div>
          ${drillHint}
        `;
        tooltip.classList.add('visible');
      })
      .on('mousemove', function(event) {
        const containerRect = container.getBoundingClientRect();
        let tx = event.clientX - containerRect.left + 15;
        let ty = event.clientY - containerRect.top - 10;
        if (tx + 260 > w) tx -= 280;
        if (ty + 90 > h) ty -= 100;
        tooltip.style.left = tx + 'px';
        tooltip.style.top = ty + 'px';
      })
      .on('mouseout', function() {
        tooltip.classList.remove('visible');
      })
      .on('click', function(event, d) {
        const entity = d.data || d;
        tooltip.classList.remove('visible');
        if (effective === 'agencies') {
          App.bubbleMode = 'auto';
          App.drillToAgency(entity.name);
        } else if (effective === 'subagencies') {
          App.bubbleMode = 'auto';
          App.drillToSubAgency(entity.name);
        } else {
          App.drillDown(entity.name);
        }
      });
  }

  // Create SVG
  const svg = d3.select(container)
    .append('svg')
    .attr('width', w)
    .attr('height', h)
    .attr('viewBox', `0 0 ${w} ${h}`);

  // ============ TREEMAP ============
  if (App.bubbleChartType === 'treemap') {
    const hierarchy = d3.hierarchy({ children: entities })
      .sum(d => d.spend)
      .sort((a, b) => b.value - a.value);

    d3.treemap()
      .size([w, h])
      .paddingInner(2)
      .paddingOuter(3)
      .round(true)(hierarchy);

    const cells = svg.selectAll('.treemap-cell')
      .data(hierarchy.leaves())
      .join('g')
      .attr('class', 'treemap-cell')
      .attr('transform', d => `translate(${d.x0},${d.y0})`);

    // Clip path per cell to contain text
    cells.append('clipPath')
      .attr('id', (d, i) => `tm-clip-${i}`)
      .append('rect')
      .attr('width', d => Math.max(0, d.x1 - d.x0))
      .attr('height', d => Math.max(0, d.y1 - d.y0))
      .attr('rx', 3);

    cells.append('rect')
      .attr('width', d => Math.max(0, d.x1 - d.x0))
      .attr('height', d => Math.max(0, d.y1 - d.y0))
      .attr('fill', (d, i) => bubbleColors[i % bubbleColors.length])
      .attr('opacity', 0.85)
      .attr('rx', 3)
      .attr('stroke', 'rgba(241, 238, 233, 0.08)')
      .attr('stroke-width', 1);

    // Text group clipped to cell bounds
    const textGroup = cells.append('g')
      .attr('clip-path', (d, i) => `url(#tm-clip-${i})`);

    // Word-wrap helper: splits name into lines that fit cell width at given font size
    function wrapName(name, cellW, fontSize) {
      const charW = fontSize * 0.58;
      const padW = cellW - 12; // 6px padding each side
      const maxCharsPerLine = Math.floor(padW / charW);
      if (maxCharsPerLine < 3) return [];
      const words = name.split(/\s+/);
      const lines = [];
      let current = '';
      words.forEach(word => {
        const test = current ? current + ' ' + word : word;
        if (test.length <= maxCharsPerLine) {
          current = test;
        } else {
          if (current) lines.push(current);
          current = word.length > maxCharsPerLine ? word.slice(0, maxCharsPerLine - 1) + '…' : word;
        }
      });
      if (current) lines.push(current);
      return lines;
    }

    // Compute optimal font size that fits name + amount inside cell
    function computeLayout(d) {
      const cellW = d.x1 - d.x0;
      const cellH = d.y1 - d.y0;
      const name = d.data.name;
      const amount = Utils.money(d.data.spend);

      // Try font sizes from large to small
      for (let fs = Math.min(cellW / 5, cellH / 3, 22); fs >= 7; fs -= 0.5) {
        const nameLines = wrapName(name, cellW, fs);
        const amountFs = fs * 0.85;
        const lineH = fs * 1.25;
        const amountH = amountFs * 1.3;
        const totalH = nameLines.length * lineH + amountH + 8; // 8px gap
        if (totalH < cellH - 8 && nameLines.length > 0 && nameLines.length <= 4) {
          return { nameLines, fontSize: fs, amountFs, lineH, totalH };
        }
      }
      // Fallback: single truncated line at minimum size
      const fs = 7;
      const charW = fs * 0.58;
      const maxC = Math.floor((cellW - 12) / charW);
      return { nameLines: [Utils.trunc(name, Math.max(maxC, 3))], fontSize: fs, amountFs: 6, lineH: fs * 1.25, totalH: fs * 2.5 + 8 };
    }

    // Render name + amount with word wrap
    textGroup.each(function(d) {
      const cellW = d.x1 - d.x0;
      const cellH = d.y1 - d.y0;
      if (cellW < 40 || cellH < 25) return;

      const g = d3.select(this);
      const layout = computeLayout(d);
      const startY = (cellH - layout.totalH) / 2 + layout.fontSize;

      // Name lines
      layout.nameLines.forEach((line, i) => {
        g.append('text')
          .attr('class', 'bubble-label')
          .attr('x', cellW / 2)
          .attr('y', startY + i * layout.lineH)
          .attr('font-size', layout.fontSize + 'px')
          .attr('font-weight', '700')
          .text(line);
      });

      // Dollar amount below name
      if (cellH > 40) {
        g.append('text')
          .attr('class', 'bubble-amount-label')
          .attr('x', cellW / 2)
          .attr('y', startY + layout.nameLines.length * layout.lineH + 4)
          .attr('font-size', layout.amountFs + 'px')
          .attr('font-weight', '800')
          .attr('fill', 'rgba(241, 238, 233, 0.9)')
          .text(Utils.money(d.data.spend));
      }
    });

    attachInteractions(cells);

    // Entrance animation
    cells.selectAll('rect')
      .attr('opacity', 0)
      .transition()
      .duration(500)
      .delay((d, i) => i * 12)
      .ease(d3.easeCubicOut)
      .attr('opacity', 0.85);

    cells.selectAll('text')
      .attr('opacity', 0)
      .transition()
      .duration(400)
      .delay((d, i) => 200 + i * 12)
      .attr('opacity', 1);

    return;
  }

  // ============ BUBBLE PACK ============
  const hierarchy = d3.hierarchy({ children: entities })
    .sum(d => d.spend)
    .sort((a, b) => b.value - a.value);
  
  const pack = d3.pack()
    .size([w, h])
    .padding(1.5);
  
  const root = pack(hierarchy);

  // Nodes
  const nodes = svg.selectAll('.bubble-node')
    .data(root.leaves())
    .join('g')
    .attr('class', 'bubble-node')
    .attr('transform', d => `translate(${d.x},${d.y})`);
  
  // Circles
  nodes.append('circle')
    .attr('r', d => d.r)
    .attr('fill', (d, i) => bubbleColors[i % bubbleColors.length])
    .attr('opacity', 0.85)
    .attr('stroke', 'rgba(241, 238, 233, 0.1)')
    .attr('stroke-width', 1);
  
  // Word-wrap for circles: fits name + amount inside bubble diameter
  function wrapInCircle(name, r, fontSize) {
    const charW = fontSize * 0.58;
    const maxW = r * 1.6; // usable width inside circle
    const maxCharsPerLine = Math.floor(maxW / charW);
    if (maxCharsPerLine < 3) return [];
    const words = name.split(/\s+/);
    const lines = [];
    let current = '';
    words.forEach(word => {
      const test = current ? current + ' ' + word : word;
      if (test.length <= maxCharsPerLine) {
        current = test;
      } else {
        if (current) lines.push(current);
        current = word.length > maxCharsPerLine ? word.slice(0, maxCharsPerLine - 1) + '…' : word;
      }
    });
    if (current) lines.push(current);
    return lines;
  }

  function computeBubbleLayout(d) {
    const r = d.r;
    const name = d.data.name;
    for (let fs = Math.min(r / 2.5, 20); fs >= 7; fs -= 0.5) {
      const nameLines = wrapInCircle(name, r, fs);
      const amountFs = fs * 0.85;
      const lineH = fs * 1.2;
      const totalH = nameLines.length * lineH + amountFs * 1.3 + 4;
      if (totalH < r * 1.6 && nameLines.length > 0 && nameLines.length <= 3) {
        return { nameLines, fontSize: fs, amountFs, lineH, totalH };
      }
    }
    return null;
  }

  // Render name + amount with word wrap inside circles
  nodes.each(function(d) {
    if (d.r < 25) return;
    const g = d3.select(this);
    const layout = computeBubbleLayout(d);
    if (!layout) return;

    const startY = -(layout.totalH / 2) + layout.fontSize * 0.8;

    layout.nameLines.forEach((line, i) => {
      g.append('text')
        .attr('class', 'bubble-label')
        .attr('y', startY + i * layout.lineH)
        .attr('font-size', layout.fontSize + 'px')
        .attr('font-weight', '700')
        .text(line);
    });

    if (d.r > 35) {
      g.append('text')
        .attr('class', 'bubble-amount-label')
        .attr('y', startY + layout.nameLines.length * layout.lineH + 4)
        .attr('font-size', layout.amountFs + 'px')
        .attr('font-weight', '800')
        .attr('fill', 'rgba(241, 238, 233, 0.9)')
        .text(Utils.money(d.data.spend));
    }
  });
  
  // Tooltip interactions
  attachInteractions(nodes);
  
  // Entrance animation
  nodes.selectAll('circle')
    .attr('r', 0)
    .transition()
    .duration(600)
    .delay((d, i) => i * 15)
    .ease(d3.easeCubicOut)
    .attr('r', d => d.r);
  
  nodes.selectAll('text')
    .attr('opacity', 0)
    .transition()
    .duration(400)
    .delay((d, i) => 300 + i * 15)
    .attr('opacity', 1);
};

// ==================== SUBAWARD BUBBLE CHART ====================
App.subBubbleMode = 'primes';

App.subBubbleChartType = 'bubbles';

App.setSubBubbleChartType = function(type) {
  App.subBubbleChartType = type;
  document.getElementById('subChartTypeBubbles').classList.toggle('active', type === 'bubbles');
  document.getElementById('subChartTypeTreemap').classList.toggle('active', type === 'treemap');
  App.renderSubBubbleChart();
};

App.setSubBubbleMode = function(mode) {
  App.subBubbleMode = mode;
  document.getElementById('subBubbleTogglePrimes').classList.toggle('active', mode === 'primes');
  document.getElementById('subBubbleToggleSubs').classList.toggle('active', mode === 'subs');
  App.renderSubBubbleChart();
};

App.renderSubBubbleBreadcrumb = function() {
  const bc = document.getElementById('subBubbleBreadcrumb');
  const inner = document.getElementById('subBubbleBreadcrumbInner');
  if (!bc || !inner) return;
  
  const drill = App.subawardDrillState || {};
  if (!drill.level || drill.level === 0) {
    bc.style.display = 'none';
    return;
  }
  
  bc.style.display = 'block';
  const typeIcons = { agency: 'fa-landmark', subagency: 'fa-sitemap', prime: 'fa-building', sub: 'fa-handshake' };
  
  let html = `<div class="bubble-bc-item" onclick="App.resetSubawardDrill()"> All Subawards</div>`;
  
  if (drill.path && drill.path.length > 0) {
    drill.path.forEach((step, i) => {
      const isLast = i === drill.path.length - 1;
      const icon = typeIcons[step.type] || 'fa-circle';
      const clickAction = isLast ? '' : `onclick="App.drillSubawardToLevel(${i})"`;
      html += `<span class="bubble-bc-sep"></span>`;
      html += `<div class="bubble-bc-item ${isLast ? 'active' : ''}" ${clickAction}> ${Utils.trunc(step.name, 30)}</div>`;
    });
  }
  
  inner.innerHTML = html;
};

App.renderSubBubbleChart = function() {
  const container = document.getElementById('subBubbleContainer');
  const panel = document.getElementById('subBubblePanel');
  if (!container || !panel) return;
  
  const subawards = App.forecastData?.subawards;
  if (!subawards || subawards.length === 0) {
    panel.style.display = 'none';
    return;
  }
  
  // Apply subaward drill filter (same logic as renderSubawardSankey)
  let filtered = subawards;
  const drill = App.subawardDrillState || {};
  
  if (drill.level > 0 && drill.path && drill.path.length > 0) {
    drill.path.forEach(step => {
      if (step.type === 'agency') filtered = filtered.filter(s => (s['Awarding Agency'] || 'Unknown Agency') === step.name);
      else if (step.type === 'subagency') filtered = filtered.filter(s => (s['Awarding Sub Agency'] || 'Unknown Sub Agency') === step.name);
      else if (step.type === 'prime') filtered = filtered.filter(s => (s['Prime Recipient Name'] || 'Unknown Prime') === step.name);
      else if (step.type === 'sub') filtered = filtered.filter(s => (s['Sub-Awardee Name'] || 'Unknown Sub') === step.name);
    });
  }
  
  if (filtered.length === 0) {
    panel.style.display = 'none';
    return;
  }
  
  panel.style.display = 'block';
  App.renderSubBubbleBreadcrumb();
  
  const mode = App.subBubbleMode || 'primes';
  
  // Aggregate
  const entityMap = {};
  let totalSpend = 0;
  const allPrimes = new Set();
  const allSubs = new Set();
  
  filtered.forEach(sub => {
    const prime = sub['Prime Recipient Name'] || 'Unknown Prime';
    const subName = sub['Sub-Awardee Name'] || 'Unknown Sub';
    const amount = parseFloat(sub['Sub-Award Amount']) || 0;
    const key = mode === 'primes' ? prime : subName;
    
    allPrimes.add(prime);
    allSubs.add(subName);
    
    if (!entityMap[key]) {
      entityMap[key] = { name: key, spend: 0, count: 0, partners: new Set() };
    }
    entityMap[key].spend += amount;
    entityMap[key].count++;
    entityMap[key].partners.add(mode === 'primes' ? subName : prime);
    totalSpend += amount;
  });
  
  let entities = Object.values(entityMap)
    .filter(e => e.spend > 0)
    .sort((a, b) => b.spend - a.spend)
    .slice(0, 40);
  
  if (entities.length === 0) { panel.style.display = 'none'; return; }
  
  entities.forEach(e => {
    e.partnerCount = e.partners ? e.partners.size : 0;
    delete e.partners;
  });
  
  // Update stats
  const subtitle = document.getElementById('subBubbleSubtitle');
  if (subtitle) {
    const query = App.currentQuery ? '"' + App.currentQuery.toUpperCase() + '" · ' : '';
    subtitle.textContent = query + 'Top ' + (mode === 'primes' ? 'Primes' : 'Subcontractors') + ' · Individual Transaction Value';
  }
  const els = {
    vol: document.getElementById('sub-bubble-stat-vol'),
    primes: document.getElementById('sub-bubble-stat-primes'),
    subs: document.getElementById('sub-bubble-stat-subs'),
    records: document.getElementById('sub-bubble-stat-records')
  };
  if (els.vol) els.vol.innerText = Utils.money(totalSpend);
  if (els.primes) els.primes.innerText = allPrimes.size;
  if (els.subs) els.subs.innerText = allSubs.size;
  if (els.records) els.records.innerText = filtered.length;
  
  // Clear previous
  const tooltip = document.getElementById('subBubbleTooltip');
  container.querySelectorAll('svg').forEach(s => s.remove());
  
  // Dimensions
  const rect = container.getBoundingClientRect();
  const w = Math.max(rect.width || 600, 300);
  const h = Math.max(380, Math.min(w * 0.65, 550));
  
  const bubbleColors = [
    '#466D5C', '#7B6D8D', '#5B7C99', '#E07A5F',
    '#D98895', '#3D405B', '#F2E8CF', '#81B29A',
    '#778DA9', '#606C38'
];

  // Shared tooltip + click
  function attachSubInteractions(selection) {
    selection
      .on('mouseover', function(event, d) {
        const e = d.data || d;
        const share = totalSpend > 0 ? ((e.spend / totalSpend) * 100).toFixed(1) : '0';
        const partnerLabel = mode === 'primes' ? 'subs' : 'primes';
        tooltip.innerHTML = `
          <div class="bubble-tooltip-name">${e.name}</div>
          <div class="bubble-tooltip-amount">${Utils.money(e.spend)}</div>
          <div class="bubble-tooltip-meta">${e.count} subawards · ${e.partnerCount} ${partnerLabel} · ${share}%</div>
          <div style="color:var(--accent);font-size:0.6rem;margin-top:3px;">Click to drill →</div>
        `;
        tooltip.classList.add('visible');
      })
      .on('mousemove', function(event) {
        const cr = container.getBoundingClientRect();
        let tx = event.clientX - cr.left + 15;
        let ty = event.clientY - cr.top - 10;
        if (tx + 260 > w) tx -= 280;
        if (ty + 90 > h) ty -= 100;
        tooltip.style.left = tx + 'px';
        tooltip.style.top = ty + 'px';
      })
      .on('mouseout', function() { tooltip.classList.remove('visible'); })
      .on('click', function(event, d) {
        tooltip.classList.remove('visible');
        const e = d.data || d;
        const nodeType = mode === 'primes' ? 'prime' : 'sub';
        App.drillSubaward(e.name, nodeType);
      });
  }

  const svg = d3.select(container)
    .append('svg')
    .attr('width', w)
    .attr('height', h)
    .attr('viewBox', `0 0 ${w} ${h}`);

  // ============ SUB TREEMAP ============
  if (App.subBubbleChartType === 'treemap') {
    const hierarchy = d3.hierarchy({ children: entities })
      .sum(d => d.spend)
      .sort((a, b) => b.value - a.value);

    d3.treemap()
      .size([w, h])
      .paddingInner(2)
      .paddingOuter(3)
      .round(true)(hierarchy);

    const cells = svg.selectAll('.treemap-cell')
      .data(hierarchy.leaves())
      .join('g')
      .attr('class', 'treemap-cell')
      .attr('transform', d => `translate(${d.x0},${d.y0})`);

    cells.append('clipPath')
      .attr('id', (d, i) => `stm-clip-${i}`)
      .append('rect')
      .attr('width', d => Math.max(0, d.x1 - d.x0))
      .attr('height', d => Math.max(0, d.y1 - d.y0))
      .attr('rx', 3);

    cells.append('rect')
      .attr('width', d => Math.max(0, d.x1 - d.x0))
      .attr('height', d => Math.max(0, d.y1 - d.y0))
      .attr('fill', (d, i) => bubbleColors[i % bubbleColors.length])
      .attr('opacity', 0.85)
      .attr('rx', 3)
      .attr('stroke', 'rgba(241, 238, 233, 0.08)')
      .attr('stroke-width', 1);

    const textGroup = cells.append('g')
      .attr('clip-path', (d, i) => `url(#stm-clip-${i})`);

    function wrapNameSub(name, cellW, fontSize) {
      const charW = fontSize * 0.58;
      const padW = cellW - 12;
      const maxCharsPerLine = Math.floor(padW / charW);
      if (maxCharsPerLine < 3) return [];
      const words = name.split(/\s+/);
      const lines = [];
      let current = '';
      words.forEach(word => {
        const test = current ? current + ' ' + word : word;
        if (test.length <= maxCharsPerLine) {
          current = test;
        } else {
          if (current) lines.push(current);
          current = word.length > maxCharsPerLine ? word.slice(0, maxCharsPerLine - 1) + '…' : word;
        }
      });
      if (current) lines.push(current);
      return lines;
    }

    function computeSubTreeLayout(d) {
      const cellW = d.x1 - d.x0;
      const cellH = d.y1 - d.y0;
      const name = d.data.name;
      for (let fs = Math.min(cellW / 5, cellH / 3, 22); fs >= 7; fs -= 0.5) {
        const nameLines = wrapNameSub(name, cellW, fs);
        const amountFs = fs * 0.85;
        const lineH = fs * 1.25;
        const totalH = nameLines.length * lineH + amountFs * 1.3 + 8;
        if (totalH < cellH - 8 && nameLines.length > 0 && nameLines.length <= 4) {
          return { nameLines, fontSize: fs, amountFs, lineH, totalH };
        }
      }
      const fs = 7;
      const charW = fs * 0.58;
      const maxC = Math.floor((cellW - 12) / charW);
      return { nameLines: [Utils.trunc(d.data.name, Math.max(maxC, 3))], fontSize: fs, amountFs: 6, lineH: fs * 1.25, totalH: fs * 2.5 + 8 };
    }

    textGroup.each(function(d) {
      const cellW = d.x1 - d.x0;
      const cellH = d.y1 - d.y0;
      if (cellW < 40 || cellH < 25) return;
      const g = d3.select(this);
      const layout = computeSubTreeLayout(d);
      const startY = (cellH - layout.totalH) / 2 + layout.fontSize;
      layout.nameLines.forEach((line, i) => {
        g.append('text')
          .attr('class', 'bubble-label')
          .attr('x', cellW / 2)
          .attr('y', startY + i * layout.lineH)
          .attr('font-size', layout.fontSize + 'px')
          .attr('font-weight', '700')
          .text(line);
      });
      if (cellH > 40) {
        g.append('text')
          .attr('class', 'bubble-amount-label')
          .attr('x', cellW / 2)
          .attr('y', startY + layout.nameLines.length * layout.lineH + 4)
          .attr('font-size', layout.amountFs + 'px')
          .attr('font-weight', '800')
          .attr('fill', 'rgba(241, 238, 233, 0.9)')
          .text(Utils.money(d.data.spend));
      }
    });

    attachSubInteractions(cells);

    cells.selectAll('rect')
      .attr('opacity', 0).transition().duration(500).delay((d, i) => i * 12)
      .ease(d3.easeCubicOut).attr('opacity', 0.85);
    cells.selectAll('text')
      .attr('opacity', 0).transition().duration(400).delay((d, i) => 200 + i * 12)
      .attr('opacity', 1);
    return;
  }

  // ============ SUB BUBBLE PACK ============
  const hierarchy = d3.hierarchy({ children: entities })
    .sum(d => d.spend)
    .sort((a, b) => b.value - a.value);
  
  const pack = d3.pack().size([w, h]).padding(1.5);
  const root = pack(hierarchy);

  const nodes = svg.selectAll('.bubble-node')
    .data(root.leaves())
    .join('g')
    .attr('class', 'bubble-node')
    .attr('transform', d => `translate(${d.x},${d.y})`);
  
  nodes.append('circle')
    .attr('r', d => d.r)
    .attr('fill', (d, i) => bubbleColors[i % bubbleColors.length])
    .attr('opacity', 0.85)
    .attr('stroke', 'rgba(241, 238, 233, 0.1)')
    .attr('stroke-width', 1);
  
  // Word-wrap for circles
  function wrapInCircleSub(name, r, fontSize) {
    const charW = fontSize * 0.58;
    const maxW = r * 1.6;
    const maxCharsPerLine = Math.floor(maxW / charW);
    if (maxCharsPerLine < 3) return [];
    const words = name.split(/\s+/);
    const lines = [];
    let current = '';
    words.forEach(word => {
      const test = current ? current + ' ' + word : word;
      if (test.length <= maxCharsPerLine) {
        current = test;
      } else {
        if (current) lines.push(current);
        current = word.length > maxCharsPerLine ? word.slice(0, maxCharsPerLine - 1) + '…' : word;
      }
    });
    if (current) lines.push(current);
    return lines;
  }

  function computeSubBubbleLayout(d) {
    const r = d.r;
    const name = d.data.name;
    for (let fs = Math.min(r / 2.5, 20); fs >= 7; fs -= 0.5) {
      const nameLines = wrapInCircleSub(name, r, fs);
      const amountFs = fs * 0.85;
      const lineH = fs * 1.2;
      const totalH = nameLines.length * lineH + amountFs * 1.3 + 4;
      if (totalH < r * 1.6 && nameLines.length > 0 && nameLines.length <= 3) {
        return { nameLines, fontSize: fs, amountFs, lineH, totalH };
      }
    }
    return null;
  }

  nodes.each(function(d) {
    if (d.r < 25) return;
    const g = d3.select(this);
    const layout = computeSubBubbleLayout(d);
    if (!layout) return;
    const startY = -(layout.totalH / 2) + layout.fontSize * 0.8;
    layout.nameLines.forEach((line, i) => {
      g.append('text')
        .attr('class', 'bubble-label')
        .attr('y', startY + i * layout.lineH)
        .attr('font-size', layout.fontSize + 'px')
        .attr('font-weight', '700')
        .text(line);
    });
    if (d.r > 35) {
      g.append('text')
        .attr('class', 'bubble-amount-label')
        .attr('y', startY + layout.nameLines.length * layout.lineH + 4)
        .attr('font-size', layout.amountFs + 'px')
        .attr('font-weight', '800')
        .attr('fill', 'rgba(241, 238, 233, 0.9)')
        .text(Utils.money(d.data.spend));
    }
  });

  attachSubInteractions(nodes);
  
  // Entrance animation
  nodes.selectAll('circle')
    .attr('r', 0).transition().duration(600).delay((d, i) => i * 15)
    .ease(d3.easeCubicOut).attr('r', d => d.r);
  nodes.selectAll('text')
    .attr('opacity', 0).transition().duration(400).delay((d, i) => 300 + i * 15)
    .attr('opacity', 1);
};

// ==================== PRESENTATION MODE ====================
App.presentationMode = false;

App.togglePresentationMode = function() {
  App.presentationMode = !App.presentationMode;
  const wrapper = document.getElementById('searchModeView');
  const btn = document.getElementById('presToggleBtn');
  
  if (App.presentationMode) {
    wrapper.classList.add('presentation-mode');
    btn.classList.add('active');
    btn.innerHTML = '';
  } else {
    wrapper.classList.remove('presentation-mode');
    btn.classList.remove('active');
    btn.innerHTML = '<i class="fas fa-rainbow"></i>';
  }
  
  // Re-render charts so D3 inline fills respect the mode
  const textColor = App.presentationMode ? '#1A1A1A' : '#F1EEE9';
  
  // Prime Sankey labels
  d3.select('#chartContainer').selectAll('text').style('fill', textColor);
  // Subaward Sankey labels
  d3.select('#subcontractingBody').selectAll('text').style('fill', textColor);
  
  // Bubble charts re-render cleanly via CSS class overrides (no inline fill)
  // but re-render to be safe
  App.renderBubbleChart();
  if (App.forecastData?.subawards) App.renderSubBubbleChart();
};

App.init();
</script>
</body>
</html>