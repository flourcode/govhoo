<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#000000">
  <title>Govhoo - Contract Intelligence</title>
  
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  
<style>
:root {
  --bg-app: #000000;
  --bg-card: #121212; 
  --bg-input: #1a1a1a;
  --border: #333333;
  --text-primary: #e6e6e6;
  --text-secondary: #a1a1a6; /* Added for compatibility */
  --text-muted: #888888;
  
  /* Vintage/Elegant Terminal Theme */
  --accent: #D4C4A8; /* Muted Parchment Gold */
  --accent-dim: rgba(212, 196, 168, 0.1);
  --link: #8DA0CB;   /* Soft Blue for links */
  --success: #66C2A5; /* Muted Teal */
  --danger: #FB8072;  /* Muted Red */
  
  /* Vintage Palette for Charts/Quarters */
  --q1-color: #958BB6; /* Muted Lavender */
  --q2-color: #6F8A74; /* Sage Green */
  --q3-color: #8FB6D0; /* Dusty Blue */
  --q4-color: #C27E5C; /* Terracotta */

  --safe-top: env(safe-area-inset-top, 20px);
  --safe-bottom: env(safe-area-inset-bottom, 20px);
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

body {
  margin: 0;
  padding: 0;
  font-family: 'Inter', sans-serif;
  background: var(--bg-app);
  color: var(--text-primary);
  min-height: 100vh;
  overflow-x: hidden;
}

/* --- Hero Section (Search) --- */
.hero-view {
  position: fixed;
  inset: 0;
  z-index: 200; 
  background: radial-gradient(circle at 50% 30%, #1a1a1a 0%, #000 70%);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start; /* Top align */
  padding: 2rem;
  padding-top: max(15vh, var(--safe-top)); 
  transition: transform 0.5s cubic-bezier(0.16, 1, 0.3, 1);
  overflow-y: auto; 
}

.hero-view.slide-up { transform: translateY(-100%); }
.hero-view.hidden { display: none; }

.terminal-logo {
  font-family: 'JetBrains Mono', monospace;
  font-size: 2.5rem;
  font-weight: 700;
  margin-bottom: 0.5rem;
  color: var(--text-primary);
  letter-spacing: -1px;
  text-align: center;
}
.terminal-logo span { color: var(--accent); }

.search-box-container {
  position: relative;
  z-index: 210; 
  width: 100%;
  max-width: 500px;
  margin-top: 2rem;
}

.main-input {
  width: 100%;
  background: var(--bg-input);
  border: 1px solid var(--border);
  padding: 1.25rem 1rem;
  font-size: 1.1rem;
  color: white;
  border-radius: 4px;
  font-family: 'Inter', sans-serif;
  transition: border-color 0.2s;
  -webkit-appearance: none;
}
.main-input:focus { outline: none; border-color: var(--accent); background: #222; }

.btn-primary {
  width: 100%;
  margin-top: 1rem;
  padding: 1rem;
  background: var(--accent);
  color: #000;
  font-weight: 700;
  border: none;
  border-radius: 4px;
  font-size: 1rem;
  cursor: pointer;
  text-transform: uppercase;
  letter-spacing: 1px;
}
.btn-primary:hover { opacity: 0.9; }

/* --- Search Tips --- */
.search-tips {
  margin-top: 1.5rem;
  width: 100%;
  max-width: 500px;
  background: rgba(255, 255, 255, 0.03);
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 1rem;
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.75rem;
  color: var(--text-muted);
  text-align: left;
  margin-bottom: 2rem; 
}

.tip-header {
  color: var(--accent);
  font-weight: 700;
  margin-bottom: 0.75rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.tip-row {
  display: flex;
  align-items: flex-start;
  gap: 0.75rem;
  margin-bottom: 0.6rem;
  line-height: 1.4;
}
.cmd-hl {
  color: var(--text-primary);
  background: rgba(255, 255, 255, 0.1);
  padding: 2px 6px;
  border-radius: 2px;
  white-space: nowrap;
}

/* --- App Layout --- */
.app-header {
  position: sticky;
  top: 0;
  z-index: 100;
  background: rgba(0,0,0,0.95);
  backdrop-filter: blur(10px);
  padding: 0.75rem 1rem;
  padding-top: max(0.75rem, var(--safe-top));
  border-bottom: 1px solid var(--border);
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 1rem;
}

.header-left { display: flex; align-items: center; gap: 1rem; flex: 1; min-width: 0; }

.logo-btn {
  font-family: 'JetBrains Mono';
  font-weight: 700;
  color: white;
  cursor: pointer;
  transition: opacity 0.2s;
  flex-shrink: 0;
  white-space: nowrap;
}
.logo-btn:hover { color: var(--accent); }

.mini-search {
  background: var(--bg-input);
  border: 1px solid var(--border);
  color: white;
  padding: 0.5rem 1rem;
  border-radius: 4px;
  font-size: 0.9rem;
  width: auto;
  flex: 1;
  min-width: 0; 
}
.mini-search:focus { outline: none; border-color: var(--accent); }

.header-actions { display: flex; gap: 0.5rem; flex-shrink: 0; }
.icon-btn {
  background: var(--bg-input);
  border: 1px solid var(--border);
  color: var(--text-muted);
  width: 36px;
  height: 36px;
  border-radius: 4px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s;
}
.icon-btn:hover { border-color: var(--accent); color: var(--accent); }

/* --- Dashboard Content --- */
.dashboard-container {
  padding: 1rem;
  padding-bottom: calc(2rem + var(--safe-bottom));
  max-width: 1400px; 
  margin: 0 auto;
  display: none;
}
.dashboard-container.active { display: block; animation: fadeIn 0.8s forwards; }
@keyframes fadeIn { to { opacity: 1; } }

/* Stats Bar */
.stats-row {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 1rem;
  margin-bottom: 1.5rem;
}
.stat-item {
  background: var(--bg-card);
  padding: 1rem;
  border-radius: 4px;
  border: 1px solid var(--border);
  text-align: center;
  transition: transform 0.2s;
}
.stat-item:hover { transform: translateY(-2px); border-color: var(--border); }
.stat-label { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.5rem; letter-spacing: 0.5px; }
.stat-val { font-size: 1.25rem; font-weight: 700; font-family: 'JetBrains Mono', monospace; color: white; }
.stat-sub { font-size: 0.7rem; color: var(--success); margin-top: 4px; }
.stat-sub.neutral { color: var(--text-muted); }

/* Tabs */
.tabs-container { margin-bottom: 2rem; overflow-x: auto; -webkit-overflow-scrolling: touch; }
.tabs { display: flex; gap: 0.5rem; min-width: max-content; }
.tab-btn {
  background: transparent;
  color: var(--text-muted);
  border: 1px solid var(--border);
  padding: 0.5rem 1rem;
  border-radius: 4px;
  font-size: 0.8rem;
  font-family: 'JetBrains Mono', monospace;
  cursor: pointer;
  transition: all 0.2s;
  text-transform: uppercase;
}
.tab-btn:hover { border-color: var(--accent); color: var(--text-primary); }
.tab-btn.active { background: var(--accent-dim); color: var(--accent); border-color: var(--accent); }

/* Section Headers */
.section-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 0.5rem;
  margin: 2rem 0 1rem 0;
  border-bottom: 1px solid var(--border);
  padding-bottom: 0.5rem;
}
.section-title-group { display: flex; align-items: center; gap: 0.5rem; }
.section-title {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.9rem;
  font-weight: 700;
  color: var(--accent);
  text-transform: uppercase;
  letter-spacing: 1px;
}

/* Charts */
.chart-wrapper {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 1rem;
  width: 100%;
  margin-bottom: 1.5rem;
  position: relative;
  height: 350px;
}

/* Forecast Table */
.forecast-table-wrapper {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 4px;
  overflow-x: auto;
}
.forecast-table {
  width: 100%;
  border-collapse: collapse;
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.8rem;
}
.forecast-table th {
  text-align: left;
  padding: 1rem;
  color: var(--text-muted);
  border-bottom: 1px solid var(--border);
  font-weight: 700;
  text-transform: uppercase;
}
.forecast-table td {
  padding: 1rem;
  border-bottom: 1px solid var(--border);
  color: var(--text-primary);
}
.forecast-table tr:last-child td { border-bottom: none; }
.trend-pill {
  display: inline-flex; align-items: center; gap: 4px;
  padding: 2px 6px; border-radius: 2px;
  font-size: 0.7rem; font-weight: 700;
}
.trend-up { color: var(--success); background: rgba(102, 194, 165, 0.1); }
.trend-down { color: var(--danger); background: rgba(251, 128, 114, 0.1); }
.trend-flat { color: var(--text-muted); background: rgba(255,255,255,0.05); }

/* Deal/Agency Cards (Lists) */
.list-grid { display: flex; flex-direction: column; gap: 1rem; }
.deal-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 1.25rem;
  transition: transform 0.1s;
}
.deal-card:hover { border-color: var(--border-light); }
.deal-card:active { transform: scale(0.99); }

.deal-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem; }
.deal-agency { 
  font-size: 0.75rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase;
  background: rgba(255,255,255,0.05); padding: 2px 6px; border-radius: 4px;
}
.deal-amount { font-family: 'JetBrains Mono', monospace; color: var(--accent); font-weight: 700; font-size: 1rem; }
.deal-desc { font-size: 0.95rem; font-weight: 500; margin-bottom: 0.5rem; line-height: 1.4; color: white; }
.deal-vendor { font-size: 0.85rem; color: var(--link); margin-bottom: 0.75rem; font-family: 'JetBrains Mono', monospace; }

.deal-meta { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem; }
.meta-tag {
  font-size: 0.65rem; font-family: 'JetBrains Mono', monospace;
  padding: 3px 8px; border-radius: 2px;
  background: rgba(255,255,255,0.05); color: var(--text-muted); border: 1px solid var(--border);
}

/* Insight Cards */
.insight-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 2rem; }
.insight-card {
  background: var(--bg-card); border: 1px solid var(--border); padding: 1rem; border-radius: 4px;
}
.insight-label { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.5rem; }
.insight-val { font-size: 1.1rem; color: var(--text-primary); font-weight: 700; font-family: 'JetBrains Mono'; margin-bottom: 0.25rem;}
.insight-desc { font-size: 0.75rem; color: var(--text-muted); }

/* Breadcrumb */
.breadcrumb {
  display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;
  font-size: 0.8rem; font-family: 'JetBrains Mono'; color: var(--text-muted);
}
.breadcrumb-btn { 
  background: none; border: none; color: var(--accent); cursor: pointer; padding: 0; font-family: inherit;
}
.breadcrumb-btn:hover { text-decoration: underline; }

/* Loader */
.loader {
  position: fixed; inset: 0; z-index: 300;
  background: rgba(0,0,0,0.9);
  display: none; flex-direction: column; align-items: center; justify-content: center;
}
.spinner {
  width: 40px; height: 40px; border: 2px solid #333; border-top-color: var(--accent);
  border-radius: 50%; animation: spin 0.8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }
.loader-text { margin-top: 1rem; font-family: 'JetBrains Mono'; color: var(--accent); font-size: 0.9rem; }
.loader-sub { margin-top: 0.5rem; color: var(--text-muted); font-size: 0.8rem; }

/* Mobile */
@media (max-width: 768px) {
  .stats-row { grid-template-columns: repeat(2, 1fr); }
  .insight-grid { grid-template-columns: 1fr; }
  .chart-wrapper { height: 250px; }
  .header-actions { display: none; }
}
@media (max-width: 480px) {
  .stats-row { grid-template-columns: 1fr; }
}
</style>
</head>
<body>

<div id="heroView" class="hero-view">
  <div class="terminal-logo"><span>>_</span> Govhoo</div>
  <p style="color:var(--text-muted); margin-bottom: 2rem; text-align:center;">Turn hindsight into foresight.</p>
  
  <div class="search-box-container">
    <input type="text" id="mainSearchInput" class="main-input" placeholder="Search Keywords (e.g. AWS, Cyber)" autocomplete="off">
    <button id="searchBtn" class="btn-primary">GENERATE FORECAST</button>
  </div>

  <div class="search-tips">
    <div class="tip-header"><i class="fas fa-terminal"></i> SEARCH_TIPS</div>
    <div class="tip-row"><span class="cmd-hl">cloud computing</span> <span>Searches award descriptions & industries.</span></div>
    <div class="tip-row"><span class="cmd-hl">Amazon</span> <span>Find forecast for specific vendor.</span></div>
    <div class="tip-row"><span class="cmd-hl">Forecast</span> <span>Uses 3-year historical baseline + seasonality.</span></div>
    <div class="tip-row"><span class="cmd-hl" style="opacity:0.7">Source</span> <span style="opacity:0.7">Data sourced from USASpending.gov</span></div>
  </div>
</div>

<div id="appView">
  <header class="app-header">
    <div class="header-left">
      <div class="logo-btn" onclick="UI.showHero()">Govhoo</div>
      <input type="text" id="miniSearch" class="mini-search" placeholder="New Search...">
    </div>
    <div class="header-actions">
      <button class="icon-btn" id="exportBtn" title="Export CSV"><i class="fas fa-download"></i></button>
      <button class="icon-btn" id="shareBtn" title="Share"><i class="fas fa-share-alt"></i></button>
    </div>
  </header>

  <div id="dashboardContainer" class="dashboard-container">
    
    <div class="stats-row">
      <div class="stat-item">
        <div class="stat-label">Total Spend (3Y)</div>
        <div class="stat-val" id="stat-total">-</div>
        <div class="stat-sub neutral" id="stat-period">Analyzing...</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">Avg. Quarterly</div>
        <div class="stat-val" id="stat-avg">-</div>
        <div class="stat-sub neutral">Baseline</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">Peak Quarter</div>
        <div class="stat-val" id="stat-peak">-</div>
        <div class="stat-sub" id="stat-peak-sub">-</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">Top Agency</div>
        <div class="stat-val" id="stat-agency" style="font-size: 1rem; overflow:hidden; text-overflow:ellipsis;">-</div>
        <div class="stat-sub neutral" id="stat-agency-sub">-</div>
      </div>
    </div>

    <div class="tabs-container">
      <div class="tabs">
        <button class="tab-btn active" data-tab="forecast">Forecast</button>
        <button class="tab-btn" data-tab="trends">Historical Trends</button>
        <button class="tab-btn" data-tab="agencies">By Agency</button>
        <button class="tab-btn" data-tab="recipients">Top Contractors</button>
        <button class="tab-btn" data-tab="awards">All Contracts</button>
      </div>
    </div>

    <div class="breadcrumb" id="breadcrumb" style="display: none;">
      <button class="breadcrumb-btn" id="breadcrumbBack"><i class="fas fa-arrow-left"></i> Back</button>
      <span style="color:#444">/</span>
      <span id="breadcrumbCurrent" style="color:white"></span>
    </div>

    <div id="view-forecast" class="view-section">
      <div class="section-header">
        <div class="section-title-group">
          <i class="fas fa-chart-line" style="color:var(--accent)"></i>
          <span class="section-title">Spending Forecast</span>
        </div>
      </div>

      <div id="marketInsightsSection" class="insight-grid" style="display:none"></div>

      <div class="forecast-table-wrapper">
        <table class="forecast-table">
          <thead>
            <tr>
              <th>Period</th>
              <th>Predicted Spend</th>
              <th>Hist. Avg</th>
              <th>Trend</th>
              <th>Confidence</th>
            </tr>
          </thead>
          <tbody id="forecastTableBody"></tbody>
        </table>
      </div>

      <div id="recompetesSection" style="margin-top: 2rem; display:none;"></div>
    </div>

    <div id="view-trends" class="view-section" style="display:none">
      <div class="section-header">
        <div class="section-title-group">
          <i class="fas fa-chart-bar" style="color:var(--accent)"></i>
          <span class="section-title">Quarterly History</span>
        </div>
      </div>
      <div class="chart-wrapper">
        <canvas id="spendingChart"></canvas>
      </div>
      <p style="text-align:center; font-size:0.75rem; color:#666; margin-top:0.5rem;">
        <i class="fas fa-mouse-pointer"></i> Click bars to see contracts for that quarter
      </p>
    </div>

    <div id="view-list" class="view-section" style="display:none">
      <div class="section-header">
        <div class="section-title-group">
          <i class="fas fa-list-ul" style="color:var(--accent)"></i>
          <span class="section-title" id="listTitle">Results</span>
        </div>
      </div>
      <div id="listGrid" class="list-grid"></div>
    </div>

  </div>
</div>

<div id="loader" class="loader">
  <div class="spinner"></div>
  <div class="loader-text">ANALYZING FEDERAL DATA...</div>
  <div class="loader-sub" id="loadingSubtext">Fetching historical records</div>
</div>

<script>
// --- VINTAGE COLORS ---
const vintageColors = {
  q1: '#958BB6', // Lavender
  q2: '#6F8A74', // Sage
  q3: '#8FB6D0', // Blue
  q4: '#C27E5C'  // Terracotta
};

// ===== UTILS =====
const Utils = {
  money: n => {
    if(n >= 1e9) return '$' + (n/1e9).toFixed(1) + 'B';
    if(n >= 1e6) return '$' + (n/1e6).toFixed(1) + 'M';
    if(n >= 1e3) return '$' + (n/1e3).toFixed(0) + 'K';
    return '$' + Math.round(n).toLocaleString();
  },
  formatMoneyFull: n => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits:0 }).format(n),
  date: s => s ? new Date(s).toLocaleDateString() : '—',
  truncate: (s, l) => (s && s.length > l) ? s.substring(0,l)+'...' : (s || 'No Description'),
  getCurrentFY: () => {
    const now = new Date();
    return now.getMonth() >= 9 ? now.getFullYear() + 1 : now.getFullYear();
  },
  getCurrentQ: () => {
    const m = new Date().getMonth();
    if (m >= 9) return 1;
    if (m <= 2) return 2;
    if (m <= 5) return 3;
    return 4;
  },
  getQuarterDates: (fy, q) => {
    const map = {
      1: { start_date: `${fy-1}-10-01`, end_date: `${fy-1}-12-31` },
      2: { start_date: `${fy}-01-01`, end_date: `${fy}-03-31` },
      3: { start_date: `${fy}-04-01`, end_date: `${fy}-06-30` },
      4: { start_date: `${fy}-07-01`, end_date: `${fy}-09-30` }
    };
    return map[q];
  }
};

// ===== STATE & API =====
const AppState = {
  currentKeywords: '',
  yearsBack: 3,
  spendingData: [],
  agencyData: [],
  recipientData: [],
  awardsData: [],
  forecastData: null,
  chart: null,
  drilldownContext: null
};

const API = {
  base: 'https://api.usaspending.gov/api/v2',
  
  async getSpendingOverTime(kw) {
    const curFY = Utils.getCurrentFY();
    const periods = [];
    for(let fy = curFY - AppState.yearsBack; fy <= curFY; fy++) {
      periods.push({ start_date: `${fy-1}-10-01`, end_date: `${fy}-09-30` });
    }
    const res = await fetch(`${this.base}/search/spending_over_time/`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        group: 'quarter',
        filters: { keywords: [kw], time_period: periods, award_type_codes: ['A','B','C','D'] }
      })
    });
    return (await res.json()).results || [];
  },

  async getAgencyBreakdown(kw) {
    const curFY = Utils.getCurrentFY();
    const periods = [{ start_date: `${curFY-AppState.yearsBack-1}-10-01`, end_date: `${curFY}-09-30` }];
    const res = await fetch(`${this.base}/search/spending_by_category/awarding_agency`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        category: 'awarding_agency',
        filters: { keywords: [kw], time_period: periods, award_type_codes: ['A','B','C','D'] },
        limit: 20
      })
    });
    return (await res.json()).results || [];
  },

  async getRecipients(kw) {
    const curFY = Utils.getCurrentFY();
    const periods = [{ start_date: `${curFY-AppState.yearsBack-1}-10-01`, end_date: `${curFY}-09-30` }];
    const res = await fetch(`${this.base}/search/spending_by_category/recipient`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        category: 'recipient',
        filters: { keywords: [kw], time_period: periods, award_type_codes: ['A','B','C','D'] },
        limit: 20
      })
    });
    return (await res.json()).results || [];
  },

  async getAwards(kw, options={}) {
    const curFY = Utils.getCurrentFY();
    let periods = [];
    
    if (options.fiscalYear && options.quarter) {
      periods.push(Utils.getQuarterDates(options.fiscalYear, options.quarter));
    } else {
      periods.push({ start_date: `${curFY-AppState.yearsBack-1}-10-01`, end_date: `${curFY}-09-30` });
    }

    const filters = {
      keywords: [kw],
      time_period: periods,
      award_type_codes: ['A','B','C','D']
    };
    if (options.agencyName) {
      filters.agencies = [{ type: 'awarding', tier: 'toptier', name: options.agencyName }];
    }

    const res = await fetch(`${this.base}/search/spending_by_award/`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        filters: filters,
        fields: ['Award ID','Recipient Name','Description','Start Date','End Date','Award Amount','Awarding Agency','generated_internal_id'],
        limit: options.limit || 50,
        sort: options.sort || 'Award Amount',
        order: 'desc',
        page: 1
      })
    });
    return (await res.json()).results || [];
  }
};

// ===== FORECAST ENGINE (Simplified for this view) =====
const ForecastEngine = {
  analyze(spendingData, awardsData) {
    // 1. Organize by Quarter (1-4)
    const byQuarter = { 1:[], 2:[], 3:[], 4:[] };
    let totalSpend = 0;
    
    spendingData.forEach(d => {
      const q = parseInt(d.time_period.quarter);
      const amt = d.aggregated_amount || 0;
      if(q && amt > 0) {
        byQuarter[q].push(amt);
        totalSpend += amt;
      }
    });

    // 2. Calculate Seasonal Multipliers
    const avgs = {};
    let globalAvg = 0;
    let totalQ = 0;
    
    for(let q=1; q<=4; q++) {
      if(byQuarter[q].length) {
        avgs[q] = byQuarter[q].reduce((a,b)=>a+b,0) / byQuarter[q].length;
        globalAvg += avgs[q];
        totalQ++;
      } else {
        avgs[q] = 0;
      }
    }
    globalAvg = globalAvg / (totalQ || 1);
    
    // 3. Detect Recompetes (Contracts ending soon)
    const now = new Date();
    const twoYears = new Date(); twoYears.setFullYear(now.getFullYear()+2);
    
    const recompetes = awardsData.filter(a => {
      const end = new Date(a['End Date']);
      return end > now && end < twoYears && a['Award Amount'] > 50000;
    }).sort((a,b) => b['Award Amount'] - a['Award Amount']);

    // 4. Build Forecast
    const forecasts = [];
    const curFY = Utils.getCurrentFY();
    const curQ = Utils.getCurrentQ();

    for(let q=curQ; q<=4; q++) {
      const histAvg = avgs[q] || globalAvg;
      const seasonalIndex = globalAvg > 0 ? histAvg / globalAvg : 1;
      
      // Simple logic: Base forecast is historical avg
      // Add upcoming recompete value for that quarter? (Approximation)
      
      forecasts.push({
        fy: curFY,
        q: q,
        histAvg: histAvg,
        forecast: histAvg * 1.05, // Assumed 5% growth
        confidence: byQuarter[q].length > 1 ? 'High' : 'Low'
      });
    }

    return {
      forecasts,
      recompetes: recompetes.slice(0, 10), // Top 10
      totalSpend,
      avgs
    };
  }
};

// ===== UI LOGIC =====
const UI = {
  showHero: () => {
    document.getElementById('heroView').classList.remove('hidden', 'slide-up');
    document.getElementById('dashboardContainer').classList.remove('active');
    document.getElementById('appView').style.display = 'none';
  },

  performSearch: async (val) => {
    const kw = val || document.getElementById('mainSearchInput').value;
    if(!kw) return;
    
    AppState.currentKeywords = kw;
    
    // Transition
    document.getElementById('heroView').classList.add('slide-up');
    document.getElementById('appView').style.display = 'block';
    document.getElementById('miniSearch').value = kw;
    setTimeout(() => document.getElementById('heroView').classList.add('hidden'), 500);

    // Loader
    const loader = document.getElementById('loader');
    loader.style.display = 'flex';
    document.getElementById('loadingSubtext').innerText = "Fetching historical spending...";

    try {
      // Parallel Fetch
      const [spending, agencies, recipients, rawAwards] = await Promise.all([
        API.getSpendingOverTime(kw),
        API.getAgencyBreakdown(kw),
        API.getRecipients(kw),
        API.getAwards(kw, { limit: 100, sort: 'End Date' }) // For recompetes
      ]);

      AppState.spendingData = spending;
      AppState.agencyData = agencies;
      AppState.recipientData = recipients;
      AppState.awardsData = rawAwards;

      // Analysis
      AppState.forecastData = ForecastEngine.analyze(spending, rawAwards);

      // Render
      UI.renderStats();
      UI.renderForecast();
      UI.renderChart();
      UI.switchTab('forecast');
      
      document.getElementById('dashboardContainer').classList.add('active');
    } catch(e) {
      console.error(e);
      alert("Error fetching data");
    } finally {
      loader.style.display = 'none';
    }
  },

  renderStats: () => {
    const d = AppState.forecastData;
    const topAgency = AppState.agencyData[0];
    
    document.getElementById('stat-total').innerText = Utils.money(d.totalSpend);
    document.getElementById('stat-period').innerText = `${AppState.yearsBack} Year Analysis`;
    
    // Peak Quarter
    let peakQ = 0, peakVal = 0;
    for(const [q, val] of Object.entries(d.avgs)) {
      if(val > peakVal) { peakVal = val; peakQ = q; }
    }
    document.getElementById('stat-peak').innerText = `Q${peakQ || '-'}`;
    document.getElementById('stat-peak-sub').innerText = peakQ ? 'Highest Avg Spend' : '-';
    
    // Avg
    const avg = d.totalSpend / (AppState.spendingData.length || 1);
    document.getElementById('stat-avg').innerText = Utils.money(avg);

    // Agency
    if(topAgency) {
      document.getElementById('stat-agency').innerText = topAgency.name;
      const pct = (topAgency.amount / d.totalSpend * 100).toFixed(0);
      document.getElementById('stat-agency-sub').innerText = `${pct}% of Total`;
    }
  },

  renderForecast: () => {
    const tbody = document.getElementById('forecastTableBody');
    tbody.innerHTML = '';
    
    AppState.forecastData.forecasts.forEach(f => {
      const diff = ((f.forecast - f.histAvg) / f.histAvg * 100).toFixed(0);
      const trendClass = diff > 0 ? 'trend-up' : 'trend-down';
      const trendIcon = diff > 0 ? '▲' : '▼';
      
      tbody.innerHTML += `
        <tr>
          <td><span style="color:var(--text-primary); font-weight:700">FY${f.fy} Q${f.q}</span></td>
          <td style="color:var(--accent); font-weight:700">${Utils.money(f.forecast)}</td>
          <td>${Utils.money(f.histAvg)}</td>
          <td><span class="trend-pill ${trendClass}">${trendIcon} ${Math.abs(diff)}%</span></td>
          <td style="color:${f.confidence==='High'?'var(--success)':'var(--text-muted)'}">${f.confidence}</td>
        </tr>
      `;
    });

    // Market Insights (Recompetes)
    const recDiv = document.getElementById('recompetesSection');
    const recs = AppState.forecastData.recompetes;
    
    if(recs.length) {
      recDiv.style.display = 'block';
      let html = `
        <div class="section-header">
          <span class="section-title" style="color:var(--danger)">Top Recompete Opportunities</span>
        </div>
        <div class="list-grid">
      `;
      
      recs.forEach(r => {
        const endDate = new Date(r['End Date']);
        // Est procurement start (6 mo before)
        const procDate = new Date(endDate); procDate.setMonth(endDate.getMonth()-6);
        const procQ = Math.floor((procDate.getMonth() + 3) / 3); // Crude Q calc
        const fy = procDate.getMonth() >= 9 ? procDate.getFullYear()+1 : procDate.getFullYear();
        
        html += `
          <div class="deal-card">
            <div class="deal-header">
              <span class="deal-agency">${Utils.truncate(r['Awarding Agency'], 30)}</span>
              <span class="deal-amount" style="color:var(--danger)">${Utils.money(r['Award Amount'])}</span>
            </div>
            <div class="deal-desc">${Utils.truncate(r['Description'], 80)}</div>
            <div class="deal-vendor">${r['Recipient Name']}</div>
            <div class="deal-meta">
              <span class="meta-tag">Ends: ${Utils.date(r['End Date'])}</span>
              <span class="meta-tag" style="border-color:var(--danger); color:var(--danger)">Est. RFP: FY${fy} Q${Math.ceil((procDate.getMonth()+1)/3)}</span>
            </div>
          </div>
        `;
      });
      recDiv.innerHTML = html + '</div>';
    }
  },

  renderChart: () => {
    const ctx = document.getElementById('spendingChart').getContext('2d');
    
    // Group by FY
    const byFY = {};
    AppState.spendingData.forEach(d => {
      const fy = d.time_period.fiscal_year;
      const q = d.time_period.quarter;
      if(!byFY[fy]) byFY[fy] = {1:0, 2:0, 3:0, 4:0};
      byFY[fy][q] = (byFY[fy][q]||0) + d.aggregated_amount;
    });

    const years = Object.keys(byFY).sort();
    
    if(AppState.chart) AppState.chart.destroy();

    AppState.chart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: years.map(y => `FY${y}`),
        datasets: [
          { label: 'Q1', data: years.map(y=>byFY[y][1]), backgroundColor: vintageColors.q1 },
          { label: 'Q2', data: years.map(y=>byFY[y][2]), backgroundColor: vintageColors.q2 },
          { label: 'Q3', data: years.map(y=>byFY[y][3]), backgroundColor: vintageColors.q3 },
          { label: 'Q4', data: years.map(y=>byFY[y][4]), backgroundColor: vintageColors.q4 }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { labels: { color: '#888', font:{family:'JetBrains Mono'} } } },
        scales: {
          x: { grid:{display:false}, ticks:{color:'#888', font:{family:'JetBrains Mono'}} },
          y: { grid:{color:'#333'}, ticks:{color:'#888', callback: v=>Utils.money(v)} }
        },
        onClick: (evt, els) => {
          if(els.length) {
            const idx = els[0].index;
            const dsIdx = els[0].datasetIndex;
            const fy = years[idx];
            const q = dsIdx + 1;
            UI.drillDown({ fiscalYear: fy, quarter: q });
          }
        }
      }
    });
  },

  switchTab: (tab) => {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
    
    document.getElementById('view-forecast').style.display = 'none';
    document.getElementById('view-trends').style.display = 'none';
    document.getElementById('view-list').style.display = 'none';

    if(tab === 'forecast') document.getElementById('view-forecast').style.display = 'block';
    else if(tab === 'trends') document.getElementById('view-trends').style.display = 'block';
    else {
      // List Views
      document.getElementById('view-list').style.display = 'block';
      UI.renderList(tab);
    }
  },

  renderList: (type) => {
    const container = document.getElementById('listGrid');
    const title = document.getElementById('listTitle');
    container.innerHTML = '';
    
    let data = [];
    if(type === 'agencies') {
      title.innerText = 'Top Agencies';
      data = AppState.agencyData.map(a => ({
        header: a.name,
        amount: a.amount,
        sub: 'Agency',
        desc: ''
      }));
    } else if(type === 'recipients') {
      title.innerText = 'Top Contractors';
      data = AppState.recipientData.map(r => ({
        header: r.name,
        amount: r.amount,
        sub: 'Contractor',
        desc: ''
      }));
    } else if(type === 'awards') {
      title.innerText = 'Recent Awards';
      // If we don't have awards loaded (only did raw dump for analysis), fetch more
      if(!AppState.awardsData.length) API.getAwards(AppState.currentKeywords).then(res => {
        AppState.awardsData = res;
        UI.renderList('awards');
      });
      data = AppState.awardsData.map(a => ({
        header: a['Recipient Name'],
        amount: a['Award Amount'],
        sub: a['Awarding Agency'],
        desc: a['Description'],
        meta: `${Utils.date(a['Start Date'])}`
      }));
    }

    // Render Cards
    data.forEach(item => {
      container.innerHTML += `
        <div class="deal-card">
          <div class="deal-header">
            <span class="deal-agency">${Utils.truncate(item.sub, 35)}</span>
            <span class="deal-amount">${Utils.money(item.amount)}</span>
          </div>
          ${item.desc ? `<div class="deal-desc">${Utils.truncate(item.desc, 100)}</div>` : ''}
          <div class="deal-vendor">${item.header}</div>
          ${item.meta ? `<div class="deal-meta"><span class="meta-tag">${item.meta}</span></div>` : ''}
        </div>
      `;
    });
  },

  drillDown: async (ctx) => {
    const crumb = document.getElementById('breadcrumb');
    crumb.style.display = 'flex';
    document.getElementById('breadcrumbCurrent').innerText = `FY${ctx.fiscalYear} Q${ctx.quarter}`;
    
    UI.switchTab('awards');
    
    // Fetch specific awards
    const loader = document.getElementById('loader');
    loader.style.display = 'flex';
    document.getElementById('loadingSubtext').innerText = "Fetching specific contracts...";
    
    try {
      const res = await API.getAwards(AppState.currentKeywords, ctx);
      AppState.awardsData = res;
      UI.renderList('awards');
    } finally {
      loader.style.display = 'none';
    }
  }
};

// Events
document.getElementById('searchBtn').onclick = () => UI.performSearch();
document.getElementById('mainSearchInput').addEventListener('keypress', e => e.key==='Enter' && UI.performSearch());
document.getElementById('miniSearch').addEventListener('keypress', e => {
  if(e.key==='Enter') UI.performSearch(e.target.value);
});

document.querySelectorAll('.tab-btn').forEach(b => b.onclick = (e) => UI.switchTab(e.target.dataset.tab));
document.getElementById('breadcrumbBack').onclick = () => {
  document.getElementById('breadcrumb').style.display = 'none';
  UI.switchTab('trends');
};

</script>
</body>
</html>