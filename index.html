<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="theme-color" content="#000000">
  <meta name="color-scheme" content="dark">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 400 400'><rect width='400' height='400' rx='80' fill='%230E1111'/><text x='200' y='215' text-anchor='middle' dominant-baseline='central' font-family='Google Sans Flex, sans-serif' font-weight='600' fill='%23C0C8C4' font-size='220'>G.</text></svg>">
  <title>Govhoo - Federal Market Intelligence</title>
  <meta name="title" content="Govhoo - Federal Market Intelligence">
  <meta name="description" content="Free Federal Sales Intelligence Strategic Planning. Follow the money with live USASpending data analysis.">
  <meta name="keywords" content="federal sales, usaspending search, government contracts, defense contracts, federal jobs, expiring contracts, federal territory planning, incumbent search">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://govhoo.com/">
  <meta property="og:title" content="Govhoo | Follow the Money">
  <meta property="og:description" content="Federal contract intelligence with live USASpending data.">
  <meta property="og:image" content="https://govhoo.com/social.png">
  <meta property="twitter:card" content="summary_large_image">
  <meta property="twitter:title" content="Govhoo | Federal Awards Visualization">
  <meta property="twitter:description" content="Federal contract intelligence with live USASpending data.">
  <link rel="canonical" href="https://govhoo.com/">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Google+Sans+Flex:opsz,wght@6..144,1..1000&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/solid.min.css" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/fontawesome.min.css" crossorigin="anonymous">
  <link rel="preconnect" href="https://api.usaspending.gov">
  <link rel="dns-prefetch" href="https://api.usaspending.gov">
  <!-- D3 loaded on-demand by LibLoader -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" defer></script>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-T343V4RFHV"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-T343V4RFHV');
  </script>
<style>
:root {
  /* SURFACES */
  --bg-app: #0E1111;
  --bg-card: #1C2320;
  --bg-input: #1E2724;
  --bg-elevated: #232D29;

  /* TEXT */
  --text-primary: #F0EDE8;
  --text-secondary: #C0C8C4;
  --text-tertiary: #8A9691;
  --link: #D0D6D3;

  /* MONEY — the only chromatic anchor */
  --money: #C0C8C4;
  --money-strong: #A8B5B0;
  --money-dim: rgba(192, 200, 196, 0.12);
  --money-ink: #0E1111;

  /* Aliases (backward compat) */
  --brand: var(--money);
  --brand-hover: var(--money-strong);
  --brand-dim: var(--money-dim);
  --brand-text: var(--money-ink);
  --accent: var(--money);
  --accent-light: #D0D6D3;
  --accent-dim: var(--money-dim);

  /* FUNCTIONAL COLORS — DO NOT USE FOR BRAND, CTA, OR EMPHASIS */
  --success: #A8B5B0;
  --warning: #DACCB6;
  --danger: #CC8F8F;
  --info: #93B1CC;

  /* BORDERS */
  --border: rgba(143, 158, 152, 0.22);
  --border-hover: rgba(143, 158, 152, 0.35);

  /* RADIUS SYSTEM — 3 values + pill */
  --radius-sm: 4px;
  --radius-md: 8px;
  --radius-lg: 16px;
  --radius-pill: 9999px;

  /* TYPE SCALE — 6 steps + hero */
  --text-xs: 0.6875rem;  /* 11px — minimum legible for mobile metadata */
  --text-sm: 0.75rem;
  --text-base: 0.875rem;
  --text-lg: 1rem;
  --text-xl: 1.125rem;
  --text-hero: clamp(1.75rem, 5vw, 2.5rem);

  /* SPACING */
  --section-gap: 1.25rem;

  /* SIZING */
  --safe-top: env(safe-area-inset-top, 20px);
  --safe-bottom: env(safe-area-inset-bottom, 20px);
}

/* =========================================
   2. GLOBAL RESET & SCROLLBAR
   ========================================= */
* { 
  box-sizing: border-box; 
  -webkit-tap-highlight-color: transparent; 
}

html { scroll-behavior: smooth; }

body {
  margin: 0; 
  padding: 0;
  font-family: 'Google Sans Flex', sans-serif;
  background: var(--bg-app);
  color: var(--text-primary);
  min-height: 100vh;
  overflow-x: hidden;
  width: 100%;
}

/* Custom "Midnight" Scrollbars */
::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}
::-webkit-scrollbar-track {
  background: var(--bg-app); 
}
::-webkit-scrollbar-thumb {
  background: var(--bg-elevated); 
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
}
::-webkit-scrollbar-thumb:hover {
  background: var(--accent-dim); 
}

/* =========================================
   3. GLOBAL UTILITIES & ANIMATIONS
   ========================================= */
.view-section { display: none; }
.view-section.active { display: block; animation: fadeIn 0.5s ease; }

.loader {
  position: fixed; inset: 0; z-index: 300;
  background: rgba(14, 18, 17, 0.92);
  backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px);
  display: none; flex-direction: column; align-items: center; justify-content: center;
}

.spinner {
  width: 40px; height: 40px;
  border: 2px solid var(--border);
  border-top-color: var(--brand);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin { to { transform: rotate(360deg); } }
@keyframes loaderSlide { 0% { left: -40%; } 100% { left: 100%; } }
@keyframes skeletonPulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

/* Skeleton loading state — panels pulse while data loads */
.skeleton-loading .stat-hero,
.skeleton-loading .stat-value {
  animation: skeletonPulse 1.5s ease-in-out infinite;
  color: var(--text-tertiary) !important;
}
.skeleton-loading .chart-container,
.skeleton-loading .chart-wrapper {
  position: relative;
  min-height: 200px;
}
.skeleton-loading .chart-container::after {
  content: '';
  position: absolute;
  inset: 0;
  background: linear-gradient(90deg, transparent 0%, rgba(192, 200, 196, 0.05) 50%, transparent 100%);
  background-size: 200% 100%;
  animation: skeletonShimmer 1.8s ease-in-out infinite;
  border-radius: var(--radius-md);
  pointer-events: none;
}
@keyframes skeletonShimmer {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}

/* Mini loading indicator in the header search bar */
.mini-search.is-loading {
  background-image: linear-gradient(90deg, transparent, rgba(192, 200, 196, 0.12), transparent);
  background-size: 200% 100%;
  animation: skeletonShimmer 1.5s ease-in-out infinite;
}
@keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
@keyframes cardSlideUp { 
  from { opacity: 0; transform: translateY(12px); } 
  to { opacity: 1; transform: translateY(0); } 
}
@keyframes subtlePulse { 
  0%, 100% { box-shadow: 0 0 0 0 rgba(192, 200, 196, 0); }
  50% { box-shadow: 0 0 0 4px rgba(192, 200, 196, 0.06); }
}

/* Staggered card entrance */
.deal-card-animate {
  animation: cardSlideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) both;
}
/* =========================================
   4. INPUTS & BUTTONS (UNIFIED SYSTEM)
   ========================================= */
.main-input, .mini-search, select, textarea {
  width: 100%;
  background: var(--bg-input);
  border: 1px solid var(--border);
  color: var(--text-primary);
  padding: 1.25rem 1rem;
  font-size: var(--text-xl);
  border-radius: var(--radius-md);
  font-family: 'Google Sans Flex', sans-serif;
  transition: border-color 0.2s;
  -webkit-appearance: none;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

.main-input:focus, .mini-search:focus {
  outline: none; 
  border-color: var(--accent); 
  background: var(--bg-input); 
}

.btn-row { display: flex; gap: 0.75rem; margin-top: 1rem; }

/* PRIMARY ACTIONS (Color of Money) */
.btn-primary, #searchBtn {
  flex: 1;
  padding: 1rem;
  font-weight: 700;
  border: 1px solid var(--brand);
  background: var(--brand);
  color: var(--brand-text);
  border-radius: var(--radius-sm);
  font-size: var(--text-base);
  cursor: pointer;
  text-transform: uppercase;
  letter-spacing: 1px;
  display: flex; align-items: center; justify-content: center; gap: 0.5rem;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  transition: all 0.2s ease;
  font-family: 'Google Sans Flex', sans-serif;
}

.btn-primary:hover, #searchBtn:hover {
  background: var(--brand-hover);
  border-color: var(--brand-hover);
  transform: translateY(-1px);
  opacity: 1;
}

.action-btn {
  background: var(--bg-input); 
  color: var(--accent);
  text-decoration: none; 
  padding: 0.5rem 1rem;
  border-radius: var(--radius-sm); 
  font-size: var(--text-sm); 
  font-weight: 600;
  border: 1px solid var(--border); 
  display: flex; 
  align-items: center; 
  gap: 6px;
}
.action-btn:hover { border-color: var(--border-hover); background: rgba(255,255,255,0.04); }

.input-clear {
  position: absolute; 
  right: 12px; 
  top: 50%; 
  transform: translateY(-50%);
  background: none; 
  border: none; 
  color: var(--text-secondary);
  font-size: var(--text-xl); 
  cursor: pointer; 
  display: none; 
  padding: 4px 8px; 
  z-index: 215;
  line-height: 1;
  align-items: center;
  justify-content: center;
}

.input-clear:hover { 
  color: var(--accent) !important;
  opacity: 1;
  transform: translateY(-50%) scale(1.1);
  transition: all 0.15s ease;
}
.input-clear.visible { 
  display: flex;
}

/* =========================================
   5. HERO VIEW
   ========================================= */
.hero-view {
  position: fixed; inset: 0; z-index: 200;
  display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
  padding: 2rem; padding-top: max(8vh, var(--safe-top));
  transition: transform 0.5s cubic-bezier(0.16, 1, 0.3, 1);
  overflow-y: auto;
}
.hero-view.slide-up { transform: translateY(-100%); }
.hero-view.hidden { display: none; }

.terminal-logo {
  font-size: 36px; font-weight: 500; margin-bottom: 0.5rem;
  color: var(--text-primary); text-align: center;
  display: flex; align-items: baseline; justify-content: center;
}
.terminal-logo .logo-gt {
  font-family: 'Google Sans Flex', sans-serif;
  font-size: 40px; font-weight: 500;
  color: var(--accent-light);
  line-height: 1;
  display: none;
}
.terminal-logo .logo-us {
  font-family: 'Google Sans Flex', sans-serif;
  font-size: 36px; font-weight: 500;
  color: var(--accent-light);
  margin-left: -4px;
  line-height: 1;
  display: none;
}
.terminal-logo .logo-name {
  font-family: 'Google Sans Flex', sans-serif;
  font-size: 36px; font-weight: 600;
  color: #C0C8C4;
  margin-left: 0;
  line-height: 1;
}

.hero-subtitle {
  margin-bottom: 2rem; text-align: center;
  font-family: 'Google Sans Flex', sans-serif; font-size: var(--text-base); color: var(--text-primary);
}
.search-box-container { position: relative; z-index: 210; width: 100%; max-width: 500px; margin-top: 1.5rem; }

/* Tighten up the Search Box Cohesion */
#heroView .search-box-container {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

#heroView .main-input {
  height: 56px;
  border-radius: var(--radius-md) !important;
}

#searchBtn {
  height: 56px;
  border-radius: var(--radius-md) !important;
  font-weight: 800 !important;
  letter-spacing: 2px;
}

/* Quick Start chips */
#heroView a[href^="?q="] {
  background: rgba(255, 255, 255, 0.03) !important;
  border: 1px solid var(--border) !important;
  color: var(--text-secondary) !important;
  border-radius: var(--radius-pill) !important;
  padding: 6px 16px !important;
  font-size: var(--text-sm);
  letter-spacing: 0.5px;
}
#heroView a[href^="?q="]:hover {
  background: var(--accent-dim) !important;
  color: var(--text-primary) !important;
  border-color: var(--accent) !important;
  transform: translateY(-1px);
}

/* =========================================
   7. APP HEADER
   ========================================= */
.app-header {
  position: sticky; top: 0; z-index: 100;
  background: rgba(14, 18, 17, 0.95); backdrop-filter: blur(10px);
  padding: 0.6rem 1rem; padding-top: max(0.6rem, var(--safe-top));
  border-bottom: 1px solid var(--border);
  display: flex; justify-content: space-between; align-items: center; gap: 0.75rem; overflow: hidden;
}
.header-left { display: flex; align-items: center; gap: 0.75rem; flex: 1; min-width: 0; }
.logo-btn {
  display: inline-flex; align-items: baseline;
  font-size: var(--text-xl); cursor: pointer; flex-shrink: 0; padding: 0.25rem;
}
.logo-btn .logo-home-icon { display: none; } /* Hidden on desktop */
.logo-btn:hover .logo-name { color: var(--text-primary); }
.logo-btn .logo-gt {
  font-family: 'Google Sans Flex', sans-serif;
  font-weight: 500; color: var(--accent-light);
  font-size: 1.25em;
  line-height: 1;
  display: none;
}
.logo-btn .logo-us {
  font-family: 'Google Sans Flex', sans-serif;
  font-weight: 500; color: var(--accent-light);
  margin-left: -2px; line-height: 1;
  display: none;
}
.logo-btn .logo-name {
  font-family: 'Google Sans Flex', sans-serif;
  font-weight: 600; color: #C0C8C4;
  margin-left: 0px; line-height: 1;
  transition: color 0.15s ease;
}

.mini-search {
  background: var(--bg-input); border: 1px solid var(--border); color: var(--text-primary);
  padding: 0.5rem 1rem; border-radius: var(--radius-sm); font-size: var(--text-base); flex: 1; min-width: 0; width: 100%;
}
.mini-search-wrapper { flex: 1; min-width: 0; overflow: hidden; }
.header-actions { display: flex; gap: 0.4rem; flex-shrink: 0; align-items: center; }

/* Base icon button */
.icon-btn {
  background: var(--brand);
  border: none;
  color: var(--brand-text);
  width: 34px;
  height: 34px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-size: var(--text-base);
  font-family: 'Google Sans Flex', sans-serif;
  transition: opacity 0.15s ease, transform 0.15s ease;
}

.icon-btn:hover {
  opacity: 0.82;
  transform: scale(1.08);
  color: var(--brand-text);
}

.icon-btn.active {
  background: var(--brand-hover);
  color: var(--brand-text);
}

/* Action buttons — neutral, not branded */
.icon-btn-slack, .icon-btn-csv, .icon-btn-pres {
  background: var(--bg-input) !important; border: none !important; color: var(--money) !important;
}
.icon-btn-slack:hover, .icon-btn-csv:hover, .icon-btn-pres:hover {
  background: var(--money-dim) !important; border: none !important; opacity: 0.85;
}
.icon-btn-pres.active { background: var(--money-dim) !important; border: none !important; color: var(--money) !important; }

/* =========================================
   8. DASHBOARD LAYOUT & HEADERS
   ========================================= */
.dashboard-container {
  padding: 1rem; padding-bottom: calc(2rem + var(--safe-bottom));
  max-width: 100%; margin: 0 auto; display: none; width: 100%;
}
@media (min-width: 1400px) {
  .dashboard-container { padding-left: 2.5rem; padding-right: 2.5rem; }
}
@media (min-width: 1800px) {
  .dashboard-container { padding-left: 4rem; padding-right: 4rem; }
}
.dashboard-container.active { display: block; animation: fadeIn 0.8s forwards; }

/* Section Headers */
.section-header {
  display: flex; align-items: center; justify-content: space-between; gap: 0.5rem;
  margin: var(--section-gap) 0; border-bottom: 1px solid var(--border);
  padding-bottom: 0.5rem; flex-wrap: wrap;
}
.section-title-group { display: flex; align-items: center; gap: 0.5rem; }
.section-title {
  font-family: 'Google Sans Flex', sans-serif; font-size: var(--text-base); font-weight: 700 !important;
  color: var(--text-primary) !important; text-transform: uppercase; letter-spacing: 2px;
}
.section-subtitle { font-size: var(--text-sm); color: var(--text-secondary); }

/* =========================================
   9. WIDGETS, CARDS & STATS
   ========================================= */

/* Charts */
.chart-wrapper {
  background: transparent !important; border: none !important;
  border-radius: var(--radius-sm); padding: 1rem; width: 100%; overflow-x: auto; overflow-y: visible;
  box-shadow: none !important;
}
.chart-container { width: 100%; min-height: 500px; height: auto; display: block; }

svg { border: none !important; outline: none !important; }

/* Feed / Deal Cards */
.feed-grid { display: flex; flex-direction: column; gap: var(--section-gap); }
.explainer-highlight {
  background: none;
    color: var(--text-primary);
    padding: 0;
    border-radius: 0;
    font-weight: 600;
    /* This ensures the highlight background wraps nicely across multiple lines */
    box-decoration-break: clone;
    -webkit-box-decoration-break: clone;
}

.show-more-btn {
  width: 100%; padding: 0.875rem; background: var(--bg-card); border: 1px dashed var(--border);
  border-radius: var(--radius-sm); color: var(--accent); font-family: 'Google Sans Flex', sans-serif;
  font-size: var(--text-sm); cursor: pointer; transition: all 0.2s; text-transform: uppercase; letter-spacing: 1px;
}
.show-more-btn:hover { border-color: var(--accent); background: var(--accent-dim); }

.deal-card {
  background: var(--bg-card); border: 1px solid var(--border) !important;
  border-radius: var(--radius-md); padding: 1.25rem; transition: transform 0.1s;
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}
.deal-card:active { transform: scale(0.99); }
#feedGrid .deal-card:nth-child(n+4) { opacity: 0.9; }
#feedGrid .deal-card:nth-child(n+4):hover { opacity: 1; }
#feedGrid .deal-card.deal-card-animate:nth-child(n+4) { animation: cardSlideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) both; opacity: 0.9; }

.deal-header { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 0.35rem; }
.deal-agency {
  font-size: var(--text-xs); color: var(--text-tertiary); font-weight: 500;
  text-transform: none;
}
.deal-amount {
  font-family: 'Google Sans Flex', sans-serif !important; color: var(--money) !important;
  font-weight: 700; font-size: var(--text-xl); letter-spacing: -0.5px; white-space: nowrap;
}
.deal-desc { font-size: var(--text-sm); font-weight: 400; margin-bottom: 0.5rem; line-height: 1.5; color: var(--text-secondary); text-transform: lowercase; }
.deal-desc::first-letter { text-transform: uppercase; }
.deal-vendor { font-size: var(--text-sm); color: var(--text-secondary); margin-bottom: 0.5rem; font-family: 'Google Sans Flex', sans-serif; font-weight: 500; }
.deal-meta { display: flex; flex-wrap: wrap; gap: 0.35rem; margin-bottom: 0.5rem; }
.deal-footer { display: flex; justify-content: space-between; align-items: center; padding-top: 0.6rem; border-top: 1px solid var(--border); margin-top: 0.25rem; }

/* Sharp Chalk Overrides for Metadata */
.deal-date, 
.mission-gap-signals {
  font-family: 'Google Sans Flex', sans-serif;
  font-size: var(--text-sm);
  text-transform: none;
  letter-spacing: 0;
  color: var(--text-secondary);
}

/* Refined Open Award Button */
.deal-footer .action-btn {
  background: transparent !important;
  border: 1px solid rgba(251, 247, 245, 0.3) !important;
  color: var(--text-primary) !important;
  text-transform: uppercase;
  font-family: 'Google Sans Flex', sans-serif;
  font-size: var(--text-xs) !important;
  font-weight: 700;
  letter-spacing: 0.5px;
  padding: 0.5rem 0.75rem;
  transition: all 0.2s ease;
}

.deal-footer .action-btn:hover {
  background: rgba(251, 247, 245, 0.08) !important;
  border-color: var(--text-primary) !important;
  color: var(--text-primary) !important;
}

/* Tags & Badges */
.meta-tag {
  font-size: var(--text-xs); font-family: 'Google Sans Flex', sans-serif; padding: 3px 8px;
  border-radius: var(--radius-sm); background: rgba(251, 247, 245, 0.05) !important;
  color: var(--text-secondary) !important; border: 1px solid transparent !important;
  font-weight: 600;
}
.meta-tag.psc { background: rgba(255, 255, 255, 0.04) !important; border-color: var(--border) !important; color: var(--text-secondary) !important; }
.meta-tag.naics { background: rgba(255, 255, 255, 0.04) !important; border-color: var(--border) !important; color: var(--text-secondary) !important; }
.meta-tag.mission-gap { font-weight: 600; }
.meta-tag.mission-gap.high { background: rgba(255,255,255,0.04) !important; border-color: var(--danger) !important; color: var(--danger) !important; }
.meta-tag.mission-gap.medium { background: rgba(255,255,255,0.04) !important; border-color: var(--warning) !important; color: var(--warning) !important; }
.meta-tag.mission-gap.low { background: rgba(255, 255, 255, 0.05) !important; border-color: var(--border) !important; color: var(--text-secondary) !important; }

/* Mission Gap Controls */
.mission-gap-filter { display: flex; align-items: center; gap: 0.5rem; }
.mission-gap-toggle {
  display: inline-flex; align-items: center; justify-content: center; gap: 0.4rem;
  padding: 0 12px; height: 34px; min-width: 34px;
  background: var(--bg-input) !important; border: 1px solid var(--border) !important; border-radius: var(--radius-pill);
  font-size: var(--text-sm); font-family: 'Google Sans Flex', sans-serif; color: var(--text-primary) !important;
  font-weight: 700; cursor: pointer; transition: opacity 0.15s, transform 0.15s;
  white-space: nowrap;
}
.mission-gap-toggle:hover { opacity: 0.95; transform: scale(1.04); color: var(--text-primary) !important; }
.mission-gap-toggle.active { background: #A7A9AC !important; color: var(--text-primary) !important; opacity: 1; }
.mission-gap-toggle i { font-size: var(--text-xs); color: var(--text-primary) !important; }

/* Job Intel Panel specific */
#searchJobPanel { overflow: hidden; max-width: 100%; box-sizing: border-box; }
#searchJobPanel .data-panel { margin-bottom: 0; }
.job-intel-panel {
  background: var(--bg-card); border: 1px solid var(--border) !important;
  border-radius: var(--radius-md); padding: 1rem; overflow: hidden;
}

/* Job Links */
.job-link {
  font-size: var(--text-xs); color: var(--text-secondary); text-decoration: none;
  display: inline-flex; align-items: center; gap: 3px; padding: 2px 6px;
  border-radius: var(--radius-sm); background: rgba(255,255,255,0.03);
  border: 1px solid var(--border); transition: opacity 0.15s ease;
}
.job-link:hover {
  opacity: 0.85; color: var(--text-primary); background: rgba(255,255,255,0.05);
}
.job-link i { font-size: var(--text-xs); }

/* Shared design system for Prime Reach + Top Agencies panels */
.reach-row {
  display: flex; align-items: flex-start; justify-content: space-between;
  padding: 0.55rem 0.35rem; gap: 0.5rem; cursor: pointer;
  border-bottom: 1px solid rgba(255,255,255,0.07);
  border-radius: var(--radius-sm); transition: background 0.15s;
}
.reach-row:hover { background: rgba(255,255,255,0.06); }
.reach-row:last-child { border-bottom: none; }
.reach-name {
  font-size: var(--text-sm); font-weight: 600; color: var(--text-primary);
}
.reach-row:hover .reach-name { color: var(--text-primary); }
.reach-badge {
  font-family: 'Google Sans Flex', sans-serif; font-size: var(--text-xs);
  padding: 0; background: none;
  color: var(--text-tertiary); white-space: nowrap;
}
.reach-badge.accent { background: rgba(192,200,196,0.10); color: var(--text-secondary); }
.reach-meta { font-size: var(--text-xs); color: var(--text-secondary); margin-top: 0.15rem; line-height: 1.4; }
.reach-amount {
  font-family: 'Google Sans Flex', sans-serif; font-size: var(--text-sm);
  font-weight: 600; color: var(--money);
}
.reach-count { font-family: 'Google Sans Flex', sans-serif; font-size: var(--text-xs); color: var(--text-tertiary); }
.reach-overflow { font-size: var(--text-xs); color: var(--text-secondary); text-align: center; margin-top: 0.35rem; }

/* Panel container design system */
.data-panel {
  background: var(--bg-card); border: 1px solid var(--border);
  border-radius: var(--radius-md); margin-bottom: var(--section-gap); overflow: hidden;
}
.data-panel-header {
  display: flex; align-items: baseline; justify-content: space-between;
  padding: 0.65rem 1rem 0.35rem;
  border-bottom: 1px solid rgba(255,255,255,0.08);
}
.data-panel-title {
  font-family: 'Google Sans Flex', sans-serif; font-size: var(--text-xs);
  color: var(--text-secondary); text-transform: uppercase;
  letter-spacing: 1.5px; font-weight: 600;
}
.data-panel-subtitle {
  font-family: 'Google Sans Flex', sans-serif; font-size: var(--text-xs);
  color: var(--text-secondary);
}
.data-panel-body { padding: 0.35rem 1rem 0.75rem; }

/* Subagency & Drill Down */
.drill-controls-bar {
  padding: 0.5rem 0.75rem;
  border-radius: var(--radius-md);
  background: rgba(255,255,255,0.02);
  border: 1px solid var(--border);
}

.drill-breadcrumb {
  display: flex; align-items: center; gap: 0.35rem !important; padding: 0.75rem 1rem;
  background: var(--accent-dim); border: 1px solid var(--border);
  border-radius: var(--radius-sm); margin-bottom: var(--section-gap); font-family: 'Google Sans Flex', sans-serif;
  font-size: var(--text-sm); overflow-x: auto; white-space: nowrap;
}

.breadcrumb-item {
  padding: 0.25rem 0.5rem;
  border-radius: var(--radius-md);
  border: 1px solid var(--border);
  background: transparent;
  color: var(--text-secondary);
  font-family: 'Google Sans Flex', sans-serif;
  font-size: var(--text-sm);
  line-height: 1.1;
  display: inline-flex;
  align-items: center;
  gap: 0.35rem;
  cursor: pointer;
  transition: opacity 0.15s ease, transform 0.15s ease;
}

.breadcrumb-item:hover {
  opacity: 0.92;
  transform: scale(1.02);
  color: var(--text-primary);
}

.breadcrumb-item.active {
  background: rgba(192,200,196,0.08); color: var(--text-primary);
  border: 1px solid var(--border-hover); cursor: default;
}

.breadcrumb-separator { color: var(--text-tertiary); font-size: var(--text-sm); font-weight: 700; }
.drill-hint {
  display: flex; align-items: center; justify-content: center; gap: 0.5rem;
  padding: 0.5rem; background: rgba(212, 196, 168, 0.05); border: 1px dashed var(--border);
  border-radius: var(--radius-sm); margin-top: 0.5rem; font-size: var(--text-sm); color: var(--text-secondary);
}
.drill-hint i { color: var(--accent); }

#drillControlsBar > div { gap: 0.5rem !important; }

/* =========================================
   10. BUBBLE CHART - Market Landscape
   ========================================= */
#bubbleChartPanel {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  padding: 0.75rem;
  margin-bottom: var(--section-gap);
  overflow: hidden;
}
#bubbleChartPanel .bubble-header {
  font-family: 'Google Sans Flex', sans-serif;
  font-size: var(--text-xs);
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 1.5px;
  margin-bottom: 0.5rem;
}
#bubbleChartContainer, #subBubbleContainer {
  width: 100%;
  position: relative;
}
#bubbleChartContainer { min-height: 420px; }
#bubbleChartContainer svg, #subBubbleContainer svg {
  width: 100%;
  height: 100%;
  display: block;
}
.bubble-node {
  cursor: pointer;
  transition: opacity 0.15s ease;
}
.bubble-node:hover { opacity: 0.95 !important; }
.bubble-label {
  font-family: 'Google Sans Flex', sans-serif;
  fill: #F1EEE9;
  pointer-events: none;
  text-anchor: middle;
  dominant-baseline: central;
}
.bubble-amount-label {
  font-family: 'Google Sans Flex', sans-serif;
  fill: rgba(241, 238, 233, 0.7);
  pointer-events: none;
  text-anchor: middle;
}
.bubble-tooltip {
  position: absolute;
  background: rgba(22, 27, 24, 0.95);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  padding: 0.75rem 1rem;
  font-family: 'Google Sans Flex', sans-serif;
  font-size: var(--text-sm);
  color: var(--text-primary);
  pointer-events: none;
  z-index: 50;
  white-space: nowrap;
  backdrop-filter: blur(8px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.4);
  opacity: 0;
  transition: opacity 0.15s ease;
}
.bubble-tooltip.visible { opacity: 1; }
.bubble-tooltip-name { font-weight: 700; color: var(--text-primary); margin-bottom: 4px; }
.bubble-tooltip-amount { color: var(--text-primary); font-size: var(--text-base); font-weight: 700; }
.bubble-tooltip-meta { color: var(--text-secondary); font-size: var(--text-xs); margin-top: 4px; }

.bubble-toggle-row { display: flex; gap: 0.35rem; margin-bottom: 1rem; flex-wrap: wrap; align-items: center; }
.toggle-sep { border-left: 1px solid var(--border); height: 1.2rem; margin: 0 0.15rem; }
.bubble-toggle-btn {
  padding: 0.35rem 0.75rem;
  font-family: 'Google Sans Flex', sans-serif;
  font-size: var(--text-xs);
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  background: transparent;
  color: var(--text-secondary);
  cursor: pointer;
  transition: all 0.15s ease;
  white-space: nowrap;
}
.bubble-toggle-btn.active { background: var(--brand); border-color: var(--brand); color: var(--brand-text); }
.bubble-toggle-btn:hover:not(.active) { border-color: var(--brand); color: var(--brand); }

.bubble-bc-item {
  display: inline-flex; align-items: center; gap: 4px; padding: 0.2rem 0.5rem;
  border-radius: var(--radius-sm); color: var(--text-secondary); font-family: 'Google Sans Flex', sans-serif;
  font-size: var(--text-sm); cursor: pointer; transition: all 0.15s ease; white-space: nowrap;
}
.bubble-bc-item:hover { color: var(--accent); background: rgba(255,255,255,0.05); }
.bubble-bc-item.active { color: var(--text-primary); font-weight: 700; cursor: default; }
.bubble-bc-item.active:hover { background: transparent; }
.bubble-bc-sep { color: var(--text-tertiary); font-size: var(--text-xs); }

/* =========================================
   11. FOOTER & MISC
   ========================================= */
.hero-footer { width: 100%; max-width: 100%; margin: 3rem auto 0 auto; padding-top: 2rem; }
.dashboard-container .hero-footer { margin: 4rem auto 0 auto; padding-bottom: 2rem; animation: fadeIn 1s forwards; }
.dashboard-container .hero-footer .footer-grid { gap: 2rem; }
.footer-grid { display: grid; grid-template-columns: 1fr; gap: 2rem; }
@media (min-width: 768px) {
  .footer-grid { grid-template-columns: 1fr 1fr 1fr; gap: 2rem; }
  .footer-section { border-bottom: none; padding-bottom: 0; }
}
.footer-section { padding-bottom: 1.5rem; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
.footer-section:last-child { border-bottom: none; padding-bottom: 0; }
.footer-label {
  font-family: 'Google Sans Flex', sans-serif; font-size: var(--text-xs); font-weight: 700;
  text-transform: uppercase; letter-spacing: 1px; color: var(--text-secondary); margin-bottom: 0.75rem;
}
.footer-text { overflow: hidden; font-size: var(--text-sm); line-height: 1.6; color: var(--text-primary); opacity: 0.95; margin-bottom: 0.75rem; }
.footer-text:last-child { margin-bottom: 0; }
.footer-link {
  font-family: 'Google Sans Flex', sans-serif; font-size: var(--text-sm); color: var(--link);
  text-decoration: none; text-transform: uppercase; letter-spacing: 0.5px;
  font-weight: 700; padding-bottom: 2px; border-bottom: 1px solid var(--accent); transition: opacity 0.2s ease;
}
.footer-link:hover { opacity: 0.9; }
.use-cases { display: flex; flex-direction: column; gap: 1rem; }
.use-case { padding: 0.875rem; background: rgba(255, 255, 255, 0.02); border-left: 2px solid var(--border-hover); }
.use-case-title {
  font-family: 'Google Sans Flex', sans-serif; font-size: var(--text-sm); font-weight: 700;
  color: var(--text-primary); margin-bottom: 0.375rem; text-transform: uppercase; letter-spacing: 0.5px;
}
.use-case-desc { font-size: var(--text-sm); color: var(--text-primary); line-height: 1.5; }
.tip-bio-img { width: 48px; height: 48px; border-radius: 50%; filter: grayscale(1) contrast(1.1); flex-shrink: 0; float: left; margin-right: 12px; margin-bottom: 4px; }

/* Sankey drill crossfade */
#chartContainer {
  transition: opacity 0.15s ease;
}
#chartContainer.sankey-fade-out {
  opacity: 0;
}
#chartContainer.sankey-fade-in {
  animation: sankeyFadeIn 0.25s ease forwards;
}
@keyframes sankeyFadeIn {
  from { opacity: 0; transform: translateY(4px); }
  to { opacity: 1; transform: translateY(0); }
}

.sankey-loaded { animation: subtlePulse 2s ease-in-out 1; }

.footer-copyright { 
  font-family: 'Google Sans Flex', sans-serif; font-size: var(--text-xs); color: var(--text-tertiary); 
  letter-spacing: 0.5px; margin-top: 1rem; text-align: center; 
} 

/* Step icons for Getting Started section */
.steps-list li {
  position: relative; padding-left: 3rem; margin-bottom: 1.25rem;
  font-size: var(--text-base); color: var(--text-primary); line-height: 1.5;
}
.steps-list li::before {
  content: counter(step-counter); counter-increment: step-counter;
  position: absolute; left: 0; top: 0;
  width: 28px; height: 28px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: var(--text-base); font-weight: 700; font-family: 'Google Sans Flex', sans-serif;
}
.steps-list li strong { color: var(--text-primary); font-weight: 700; }
.steps-list { counter-reset: step-counter; }

/* Steps — monochrome money */
.steps-list li:nth-child(1)::before { background-color: var(--money) !important; color: var(--money-ink) !important; box-shadow: 0 0 0 2px #0E1111; }
.steps-list li:nth-child(2)::before { background-color: var(--money-strong) !important; color: var(--money-ink) !important; box-shadow: 0 0 0 2px #0E1111; }
.steps-list li:nth-child(3)::before { background-color: var(--text-tertiary) !important; color: var(--money-ink) !important; box-shadow: 0 0 0 2px #0E1111; }


/* =========================================
   12. PRESENTATION MODE (Screenshot-friendly)
   ========================================= */
/* Respect reduced motion preference */
@media (prefers-reduced-motion: reduce) {
  *, *::before, *::after {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
  }
  html { scroll-behavior: auto !important; }
  .skeleton-loading .stat-hero,
  .skeleton-loading .stat-value { animation: none !important; opacity: 0.5 !important; }
  .skeleton-loading .chart-container::after { animation: none !important; }
  .mini-search.is-loading { animation: none !important; }
  .toast { animation: none !important; opacity: 1 !important; }
  #chartContainer.sankey-fade-in { animation: none !important; opacity: 1 !important; }
}

.presentation-mode #sankeyPanel,
.presentation-mode #bubbleChartPanel,
.presentation-mode #subcontractingPanel,
.presentation-mode #subBubblePanel {
  background: #FFFFFF !important;
  border-color: #E0E0E0 !important;
}

/* Text colors */
.presentation-mode #sankeyPanel *,
.presentation-mode #bubbleChartPanel *,
.presentation-mode #subcontractingPanel *,
.presentation-mode #subBubblePanel * {
  --text-primary: #1A1A1A;
  --text-secondary: #555555;
  --text-tertiary: #6B6B6B;
  --border: rgba(0, 0, 0, 0.12);
}

/* Explicit override for inline styles */
.presentation-mode #stat-vol,
.presentation-mode #bubble-stat-vol,
.presentation-mode #sub-stat-vol,
.presentation-mode #sub-bubble-stat-vol,
.presentation-mode #stat-agencies,
.presentation-mode #stat-count,
.presentation-mode #stat-vendors,
.presentation-mode #bubble-stat-agencies,
.presentation-mode #bubble-stat-count,
.presentation-mode #bubble-stat-vendors,
.presentation-mode #bubble-stat-entities,
.presentation-mode #sub-stat-primes,
.presentation-mode #sub-stat-subs,
.presentation-mode #sub-stat-count,
.presentation-mode #sub-bubble-stat-primes,
.presentation-mode #sub-bubble-stat-subs,
.presentation-mode #sub-bubble-stat-records,
.presentation-mode #sub-bubble-stat-shown {
  color: #1A1A1A !important;
}

/* Subtitle / label text */
.presentation-mode #sankeySubtitle,
.presentation-mode #bubbleChartSubtitle,
.presentation-mode #subBubbleSubtitle,
.presentation-mode .bubble-header { color: var(--text-secondary) !important; }

/* Stat label text */
.presentation-mode #sankeyPanel .stat-label,
.presentation-mode #bubbleChartPanel .stat-label,
.presentation-mode #subcontractingPanel .stat-label,
.presentation-mode #subBubblePanel .stat-label { color: var(--text-secondary) !important; }

/* Divider lines inside chart panels */
.presentation-mode #sankeyPanel div[style*="border-left"],
.presentation-mode #bubbleChartPanel div[style*="border-left"],
.presentation-mode #subcontractingPanel div[style*="border-left"],
.presentation-mode #subBubblePanel div[style*="border-left"] { border-color: #E0E0E0 !important; }

.presentation-mode #sankeyPanel .panel-footer,
.presentation-mode #bubbleChartPanel .panel-footer,
.presentation-mode #subcontractingPanel div[style*="border-top"],
.presentation-mode #subBubblePanel .panel-footer { border-color: #E0E0E0 !important; }

/* Footer text in chart panels */
.presentation-mode #sankeyPanel > div:last-child,
.presentation-mode #bubbleChartPanel > div:last-child,
.presentation-mode #subBubblePanel > div:last-child { color: var(--text-tertiary) !important; }

/* Bubble chart text labels */
.presentation-mode .bubble-label { fill: #1A1A1A !important; }
.presentation-mode .bubble-amount-label { fill: rgba(26, 26, 26, 0.65) !important; }

/* Bubble breadcrumbs */
.presentation-mode .bubble-bc-item { color: var(--text-secondary); }
.presentation-mode .bubble-bc-item:hover { color: var(--accent); background: rgba(0,0,0,0.05); }
.presentation-mode .bubble-bc-item.active { color: #1A1A1A; }
.presentation-mode .bubble-bc-sep { color: var(--text-tertiary); }
.presentation-mode #bubbleBreadcrumb,
.presentation-mode #subBubbleBreadcrumb { background: rgba(0,0,0,0.03) !important; border-color: #E0E0E0 !important; }

/* Bubble tooltip */
.presentation-mode .bubble-tooltip { background: rgba(255, 255, 255, 0.96) !important; border-color: #DDD !important; color: #1A1A1A !important; box-shadow: 0 4px 16px rgba(0,0,0,0.12); }
.presentation-mode .bubble-tooltip-name { color: #1A1A1A !important; }
.presentation-mode .bubble-tooltip-amount { color: #1A1A1A !important; }
.presentation-mode .bubble-tooltip-meta { color: var(--text-secondary) !important; }

/* Toggle buttons inside chart panels */
.presentation-mode .bubble-toggle-btn { border-color: #DDD !important; color: var(--text-secondary) !important; }
.presentation-mode .bubble-toggle-btn.active { background: rgba(0,0,0,0.06) !important; border-color: rgba(0,0,0,0.25) !important; color: #1A1A1A !important; }
.presentation-mode .bubble-toggle-btn:hover:not(.active) { border-color: rgba(0,0,0,0.25) !important; color: #1A1A1A !important; }

/* =========================================
   13. AI INTELLIGENCE BANNER & PANEL
   ========================================= */
.ai-banner {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-left: 3px solid var(--brand);
    border-radius: var(--radius-md);
    padding: 1rem 1.25rem;
    margin-bottom: var(--section-gap);
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.25);
}

.ai-banner-wrapper {
    flex: 1;
    min-width: 0;
    display: flow-root; /* CRITICAL FIX: Ensures container wraps floated avatar perfectly */
}

.ai-avatar-float {
    float: left; /* Forces text to wrap beautifully around the image */
    width: 60px; 
    height: 60px; 
    object-fit: contain; 
    margin-right: 14px;
    margin-bottom: 4px;
}

.ai-banner-title {
    margin: 0 0 4px 0;
    color: var(--text-primary);
    font-size: var(--text-lg);
    text-transform: uppercase;
    letter-spacing: 1px;
    font-weight: 800;
    line-height: 1.2;
    padding-top: 4px; /* Aligns title with the top of the rounded avatar */
}

.ai-banner-desc {
    margin: 0;
    color: var(--text-primary);
    font-size: var(--text-base);
    line-height: 1.4;
    opacity: 0.9;
}

.btn-ai {
    background: var(--brand) !important; 
    color: var(--brand-text) !important; 
    border: none !important;
    border-radius: var(--radius-md);
    cursor: pointer;
    font-family: 'Google Sans Flex', sans-serif;
    font-weight: 800;
    padding: 0.6rem 1.2rem;
    transition: all 0.15s ease;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
    flex-shrink: 0;
    white-space: nowrap;
}

.btn-ai:hover {
    background: var(--brand-hover) !important;
    transform: translateY(-1px);
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.25) !important;
}

/* The Results Panel - Standalone Card Style */
.ai-action-panel {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius-md); 
    padding: 1.5rem;
    margin-bottom: var(--section-gap);
    display: none;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
    position: relative;
    scroll-margin-top: 90px;
}

.ai-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid var(--border);
    padding-bottom: 1rem;
    margin-bottom: 1.25rem;
}

.ai-header h3 {
    margin: 0;
    color: var(--text-primary);
    font-size: var(--text-lg);
    text-transform: uppercase;
    letter-spacing: 1px;
    font-weight: 800;
}
    
.ai-result-content {
    font-size: var(--text-base);
    color: var(--text-primary);
    line-height: 1.6;
}

/* Style Arti's Markdown Output */
.strategic-read h1, 
.strategic-read h2, 
.strategic-read h3 {
    color: var(--text-primary);
    margin-top: 1.75rem;
    margin-bottom: 0.5rem;
    font-size: var(--text-sm);
    text-transform: uppercase;
    letter-spacing: 1.5px;
    font-family: 'Google Sans Flex', sans-serif;
    border-bottom: 1px solid rgba(192, 200, 196, 0.18);
    padding-bottom: 0.4rem;
}

.strategic-read h1:first-child, 
.strategic-read h2:first-child { margin-top: 0; }
.strategic-read h4 {
    color: var(--text-primary);
    font-size: var(--text-sm);
    margin-top: 1.25rem;
    margin-bottom: 0.35rem;
    font-weight: 700;
}
.strategic-read p {
    margin-bottom: 0.85rem;
    color: var(--text-secondary);
    line-height: 1.7;
}
.strategic-read > p:first-child,
.strategic-read > p:first-of-type {
    color: var(--text-primary);
    font-size: var(--text-base);
    line-height: 1.7;
    border-left: 3px solid var(--accent);
    padding-left: 0.75rem;
    margin-bottom: 1.25rem;
}
.strategic-read ul, .strategic-read ol { padding-left: 1.25rem; margin-bottom: 1rem; }
.strategic-read li { 
    margin-bottom: 0.4rem; 
    color: var(--text-secondary); 
    line-height: 1.6;
}
.strategic-read li strong { color: var(--text-primary); }
.strategic-read strong { color: var(--text-primary); font-weight: 700; }
.strategic-read em { color: var(--text-primary); font-style: normal; font-weight: 600; }
.strategic-read code {
    font-family: 'Google Sans Flex', sans-serif;
    font-size: 0.8em;
    background: rgba(255,255,255,0.06);
    padding: 0.15em 0.4em;
    border-radius: var(--radius-sm);
    color: var(--text-secondary);
}
.strategic-read blockquote {
    border-left: 3px solid var(--accent);
    margin: 1rem 0;
    padding: 0.75rem 1rem;
    background: rgba(192, 200, 196, 0.07);
    border-radius: 0 var(--radius-md) var(--radius-md) 0;
    font-size: var(--text-base);
}
.strategic-read blockquote p { color: var(--text-primary); margin-bottom: 0.25rem; }
.strategic-read blockquote p:last-child { margin-bottom: 0; }
.strategic-read table {
    width: 100%;
    border-collapse: collapse;
    margin: 1rem 0;
    font-size: var(--text-sm);
    font-family: 'Google Sans Flex', sans-serif;
}
.strategic-read th {
    text-align: left;
    padding: 0.5rem 0.75rem;
    background: rgba(255,255,255,0.04);
    border-bottom: 1px solid var(--border);
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-size: var(--text-sm);
    font-weight: 600;
}
.strategic-read td {
    padding: 0.45rem 0.75rem;
    border-bottom: 1px solid rgba(255,255,255,0.04);
    color: var(--text-secondary);
}
.strategic-read tr:hover td { background: rgba(255,255,255,0.02); }
.strategic-read hr {
    border: none;
    border-top: 1px solid rgba(255,255,255,0.06);
    margin: 1.5rem 0;
}

/* Avatar Layouts */
.ai-avatar { 
    width: 72px; 
    height: 72px; 
    object-fit: contain; 
    flex-shrink: 0; 
}

.ai-avatar.small { 
    width: 42px; 
    height: 42px;
}

.ai-header-title { display: flex; align-items: center; gap: 1rem; }

/* Arti's Secondary/Outline Button */
.btn-ai-outline {
    background: transparent;
    border: 1px solid rgba(192, 200, 196, 0.35);
    color: var(--brand);
    border-radius: var(--radius-sm);
    padding: 0.4rem 0.75rem;
    font-size: var(--text-sm);
    font-weight: 700;
    font-family: 'Google Sans Flex', sans-serif;
    cursor: pointer;
    transition: all 0.2s ease;
    letter-spacing: 1px;
}

.btn-ai-outline:hover {
    background: var(--brand-dim);
    border-color: var(--brand);
    color: var(--text-primary);
}

/* =========================================
   14. AI CHAT INTERFACE & MICRO-INTERACTIONS
   ========================================= */
.ai-chat-history {
    margin-top: 1.5rem;
    border-top: 1px dashed rgba(192, 200, 196, 0.25); 
    padding-top: 1.5rem;
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.ai-msg-user {
    align-self: flex-end;
    background: var(--bg-input);
    border: 1px solid var(--border);
    padding: 0.75rem 1rem;
    border-radius: var(--radius-md) var(--radius-md) 0 var(--radius-md);
    color: var(--text-primary);
    max-width: 85%;
    font-size: var(--text-base);
    line-height: 1.5;
    font-family: 'Google Sans Flex', sans-serif;
}

.ai-msg-arti {
    align-self: flex-start;
    display: flex;
    gap: 1rem;
    max-width: 95%;
}

.ai-msg-arti .strategic-read {
    margin-top: 0; 
    padding-top: 0.5rem;
    flex: 1; 
    min-width: 0;
}

/* Tighten markdown spacing ONLY inside chat bubbles */
.ai-msg-arti .strategic-read h1, 
.ai-msg-arti .strategic-read h2, 
.ai-msg-arti .strategic-read h3 {
    margin-top: 0.75rem; 
    font-size: var(--text-sm); 
    padding-bottom: 0.15rem;
}
.ai-msg-arti .strategic-read > p:first-child,
.ai-msg-arti .strategic-read > p:first-of-type {
    font-size: var(--text-base) !important;
    border-left: none !important;
    padding-left: 0 !important;
}
.ai-msg-arti .strategic-read p:first-child { margin-top: 0; }
.ai-msg-arti .strategic-read p:last-child { margin-bottom: 0; }
.ai-msg-arti .strategic-read ul { margin-bottom: 0.5rem; }
.ai-msg-arti .strategic-read blockquote { margin: 0.5rem 0; padding: 0.5rem 0.75rem; }

.ai-chat-input-wrapper {
    display: flex;
    gap: 0.5rem;
    margin-top: 1.5rem;
}

#aiChatInput {
    flex: 1;
    min-width: 0;
}

/* Pulse Animation for Loading State */
@keyframes artiPulse {
    0% { opacity: 0.4; transform: scale(0.95); }
    50% { opacity: 1; transform: scale(1.05); }
    100% { opacity: 0.4; transform: scale(0.95); }
}

.arti-thinking .ai-avatar {
    animation: artiPulse 1.5s infinite ease-in-out;
}

/* Make disabled inputs look intentionally locked */
.ai-chat-input-wrapper input:disabled,
.ai-chat-input-wrapper button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.ai-chat-counter {
    font-size: var(--text-sm); 
    color: var(--text-primary); 
    text-align: right;
    margin-top: 0.5rem;
    font-family: 'Google Sans Flex', sans-serif;
    opacity: 0.9; 
    transition: color 0.3s ease;
}

.ai-disclaimer {
    font-size: var(--text-sm); 
    color: var(--text-primary);  
    opacity: 0.95; 
    text-align: left;
    margin-top: 0.9rem;
    font-family: 'Google Sans Flex', sans-serif;
    line-height: 1.4;
}

#aiChatSendBtn {
    cursor: pointer;
    touch-action: manipulation;
    -webkit-tap-highlight-color: transparent;
}
.ai-msg-arti, .ai-msg-user {
    scroll-margin-top: 100px;
}

/* =========================================
   15. ARTI FLOATING ACTION BUTTON (MOBILE)
   ========================================= */
.arti-fab {
    position: fixed;
    /* Use max() to ensure a minimum of 24px, plus safe-area for iPhones */
    bottom: max(24px, env(safe-area-inset-bottom, 24px));
    right: 20px;
    z-index: 9999; /* Boosted z-index to ensure it sits above all charts */
    width: 64px;
    height: 64px;
    border-radius: 50%;
    background: var(--brand);
    border: 2px solid var(--brand-hover);
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
    cursor: pointer;
    display: none; 
    align-items: center;
    justify-content: center;
    padding: 0;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    -webkit-tap-highlight-color: transparent;
}

.arti-fab:active {
    transform: scale(0.95);
}

.arti-fab img {
    width: 44px;
    height: 44px;
    object-fit: contain;
}

@keyframes fabPopIn {
    0% { opacity: 0; transform: scale(0.5) translateY(20px); }
    100% { opacity: 1; transform: scale(1) translateY(0); }
}

@keyframes govhooScan {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(300%); }
}

.govhoo-progress-bar {
    width: 100%; 
    height: 6px; 
    background: rgba(255,255,255,0.05); 
    border-radius: var(--radius-sm); 
    overflow: hidden; 
    position: relative; 
    border: 1px solid var(--border); 
    margin-top: 1.25rem;
}
.govhoo-progress-fill {
    position: absolute; top: 0; left: 0; height: 100%; width: 0%; 
    background: var(--brand); 
    border-radius: var(--radius-sm); 
    transition: width 0.2s ease-out;
}
.govhoo-progress-glow {
    position: absolute; top: 0; left: 0; width: 50%; height: 100%; 
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent); 
    animation: govhooScan 1.5s infinite linear;
}

/* =========================================
   16. MEDIA QUERIES (RESPONSIVE)
   ========================================= */
@media (max-width: 900px) {
  .chart-wrapper { overflow-x: scroll !important; -webkit-overflow-scrolling: touch; }
}

@media (max-width: 768px) {
  .dashboard-container {
    width: 100% !important; max-width: 100% !important; padding-left: 1rem !important;
    padding-right: 1rem !important; overflow-x: hidden !important;
  }
  .job-intel-panel > div { grid-template-columns: 1fr !important; }
  .btn-row { flex-direction: column; }
  .chart-container { min-width: auto; width: 100%; }
  .sankey-panel { padding: 0.5rem !important; }
  .reach-row { padding: 0.7rem 0.5rem; min-height: 60px; }
  .reach-name { font-size: var(--text-base); }
  .reach-amount { font-size: var(--text-base); }
  .data-panel { border-radius: var(--radius-md); margin-bottom: 0.6rem; }
  .data-panel-header { padding: 0.55rem 0.75rem 0.3rem; }
  .data-panel-title { font-size: var(--text-xs); }
  .data-panel-body { padding: 0.25rem 0.75rem 0.6rem; }

  /* Touch targets: 44px minimum per WCAG 2.5.8 */
  .job-link { min-height: 34px; min-width: 34px; display: inline-flex; align-items: center; justify-content: center; padding: 4px 8px; font-size: var(--text-xs); }
  .meta-tag { padding: 4px 8px; font-size: var(--text-xs); }
  .breadcrumb-item { min-height: 44px; padding: 8px 12px; display: inline-flex; align-items: center; }
  .icon-btn { width: 44px; height: 44px; font-size: 16px; }
  .action-btn { min-height: 44px; padding: 8px 12px; }
  .bubble-bc-item { min-height: 40px; padding: 8px 10px; }
  .bubble-toggle-btn { min-height: 40px; padding: 8px 12px; }
  .deal-footer .action-btn { min-height: 44px; }

  /* Cards: tighter on mobile to show more above fold */
  .deal-card { padding: 1rem; }
  .deal-header { margin-bottom: 0.5rem; }
  .deal-desc { margin-bottom: 0.35rem; font-size: var(--text-base); }
  .deal-vendor { margin-bottom: 0.5rem; }
  .deal-meta { margin-bottom: 0.75rem; }
  .deal-footer { padding-top: 0.75rem; }

  /* Prevent iOS zoom on input focus */
  .main-input, .mini-search, input, select, textarea { font-size: 16px !important; }
  
  .arti-fab.visible {
      display: flex;
      animation: fabPopIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
  }
}

@media (max-width: 600px) {
  /* Header: tighter, logo shrinks to just >_ on very small screens */
  .app-header { gap: 0.4rem; padding: 0.4rem 0.6rem; }
  .header-left { gap: 0.4rem; flex: 1; min-width: 0; }
  .mini-search { max-width: none; padding: 0.45rem 0.6rem; font-size: 16px; flex: 1; }
  .mini-search-wrapper { flex: 1; min-width: 0; }
  .logo-btn { font-size: var(--text-base); flex-shrink: 0; }
  .logo-btn .logo-gt, .logo-btn .logo-us, .logo-btn .logo-name { font-size: inherit; }
  .logo-btn .logo-name { display: none; }
  /* Mobile: replace full word with styled G home button */
  .logo-btn .logo-gt, .logo-btn .logo-us { display: none; }
  .logo-btn .logo-home-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    background: var(--money);
    color: var(--money-ink);
    font-size: 15px;
    font-family: 'Google Sans Flex', sans-serif;
    font-weight: 700;
    transition: opacity 0.15s ease, transform 0.15s ease;
  }
  .logo-btn .logo-home-icon:hover {
    opacity: 0.82;
    transform: scale(1.08);
  }
  .header-actions { gap: 0.2rem; flex-shrink: 0; }
  .icon-btn { width: 30px; height: 30px; font-size: 13px; }
  /* Hide presentation mode toggle on mobile — not useful on phones */
  .icon-btn-pres { display: none; }
  .job-links { gap: 6px; }
  #bubbleChartContainer { min-height: 320px; }
  .toggle-sep { width: 100%; height: 0; border: none; margin: 0; }
  
  /* Arti banner: compact single-line with CTA */
  .ai-banner { 
      padding: 0.5rem 0.75rem; 
      gap: 0.5rem;
      align-items: center;
      flex-direction: row;
  }
  .ai-avatar-float { 
      width: 32px; 
      height: 32px; 
      margin-right: 6px;
      margin-bottom: 0;
      float: none;
      flex-shrink: 0;
  }
  .ai-banner-wrapper { display: flex; align-items: center; gap: 0; flex: 1; min-width: 0; }
  .ai-banner-title { 
      font-size: var(--text-xs); 
      padding-top: 0;
      margin-bottom: 0;
  }
  .ai-banner-desc { display: none !important; } /* Hide desc on mobile — title + button enough */
  .ai-banner .btn-ai { 
      padding: 0.4rem 0.75rem;
      font-size: var(--text-xs);
      margin-top: 0;
      white-space: nowrap;
      width: auto;
      flex-shrink: 0;
  }

  /* Stat panel: stack stats vertically for scanability */
  .stat-panel { padding: 0.75rem; }
  .stat-subtitle { font-size: var(--text-xs); letter-spacing: 0.5px; margin-bottom: 0.3rem; line-height: 1.4; }
  .stat-hero { font-size: 1.6rem; margin-bottom: 0.15rem; }
  .stat-row { flex-direction: column; align-items: flex-start; gap: 0.25rem; }
  .stat-group { 
    gap: 0.75rem; 
    margin-left: 0; 
    padding-left: 0; 
    border-left: none;
  }
  .stat-value { font-size: var(--text-base); }

  /* Sankey: tighter padding, better label handling */
  .sankey-panel { padding: 0.35rem !important; }
  
  /* Feed cards: tighter on mobile */
  .feed-card { padding: 0.75rem; }
  .meta-tags { gap: 4px; }
  .meta-tag { font-size: var(--text-xs); padding: 4px 8px; }

  /* Responsive Chat Elements */
  .ai-msg-arti {
      flex-direction: column;
      align-items: flex-start;
      gap: 0.75rem;
      max-width: 100%;
  }
  
  .ai-msg-arti .strategic-read {
      margin-top: 0;
      width: 100%;
  }

  .ai-chat-history .ai-avatar.small { width: 48px; height: 48px; }

  .ai-msg-user {
      max-width: 95%;
      padding: 0.6rem 0.85rem;
  }

  .ai-chat-input-wrapper { gap: 0.4rem; }
  
  #aiChatSendBtn {
      padding: 0 0.8rem;
      font-size: var(--text-sm);
  }

  /* NAICS panel: slightly smaller code font */
  #naicsMixBody .reach-row { padding: 0.5rem 0.4rem; min-height: 52px; }
}

@media (max-width: 520px){
  .drill-controls-bar{ padding: 0.5rem 0.6rem; }
  .breadcrumb-item{ font-size: var(--text-sm); padding: 0.22rem 0.45rem; }
}

@media (max-width: 400px) {
  /* iPhone SE and other very small screens */
  .dashboard-container { padding-left: 0.6rem !important; padding-right: 0.6rem !important; }
  .stat-hero { font-size: 1.5rem; }
  .stat-group { gap: 0.5rem; padding-left: 0.5rem; }
  .stat-value { font-size: var(--text-sm); }
  .stat-subtitle { font-size: var(--text-xs); }
  .app-header { padding: 0.35rem 0.5rem; }
  .icon-btn { width: 28px; height: 28px; font-size: 12px; }
  .logo-btn .logo-home-icon { width: 28px; height: 28px; font-size: 13px; }
}
/* Hide scrollbars for horizontal swiping areas */
.drill-breadcrumb, 
.chart-wrapper,
.bubble-toggle-row {
  scrollbar-width: none; /* Firefox */
  -ms-overflow-style: none;  /* IE and Edge */
}

.drill-breadcrumb::-webkit-scrollbar,
.chart-wrapper::-webkit-scrollbar,
.bubble-toggle-row::-webkit-scrollbar {
  display: none; /* Chrome, Safari and Opera */
}
.bubble-tooltip {
  /* ... existing styles ... */
  background: rgba(22, 27, 24, 0.85) !important; /* Slightly more transparent */
  backdrop-filter: blur(12px) saturate(180%); /* The Apple Glass effect */
  -webkit-backdrop-filter: blur(12px) saturate(180%);
  border: 1px solid rgba(255, 255, 255, 0.1) !important;
}

.arti-fab {
  /* ... existing styles ... */
  background: rgba(192, 200, 196, 0.9);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
}
.deal-card {
  background: var(--bg-card); 
  border: 1px solid var(--border) !important;
  border-radius: var(--radius-md); 
  padding: 1.25rem; 
  transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1); /* Smoother spring transition */
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  cursor: pointer; /* Indicates it can be interacted with */
}

/* The Hover Lift & Glow */
.deal-card:hover {
  transform: translateY(-3px);
  border-color: var(--accent) !important;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(192, 200, 196, 0.15);
  background: #1f2724; /* Slightly lighter on hover */
}

.deal-card:active { transform: translateY(0) scale(0.99); }
/* Add this to your Global Rules */
body {
  /* Uses Apple/Windows native smooth fonts for reading */
  font-family: 'Google Sans Flex', sans-serif; 
}

/* Force Google Sans Flex on numbers, buttons, headers, and UI elements */
h1, h2, h3, h4, h5, h6, 
button, input, select, textarea, 
.deal-amount, .deal-vendor, .deal-date, .deal-agency,
.reach-amount, .reach-badge, .meta-tag, .section-title,
.footer-link, .breadcrumb-item {
  font-family: 'Google Sans Flex', sans-serif !important;
}

/* Let the AI output and deal descriptions use the smooth reading font */
.ai-result-content, .deal-desc, .strategic-read p, .hero-subtitle {
  font-family: 'Google Sans Flex', sans-serif;
  letter-spacing: 0.2px;
}
.hero-suggestions {
    margin-top: 1.25rem;
    font-size: var(--text-sm);
    color: var(--text-tertiary);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.6rem;
    flex-wrap: wrap;
    font-family: 'Google Sans Flex', sans-serif;
}

.hero-suggestion-chip {
    color: var(--text-secondary);
    background: rgba(255, 255, 255, 0.03);
    padding: 4px 10px;
    border-radius: var(--radius-pill);
    text-decoration: none;
    font-family: 'Google Sans Flex', sans-serif;
    font-size: var(--text-sm);
    border: 1px solid var(--border);
    transition: all 0.2s ease;
}

.hero-suggestion-chip:hover {
    background: var(--accent-dim);
    border-color: var(--accent);
    color: var(--accent);
    transform: translateY(-1px);
}

/* Subtle Syntax Tooltip */
.syntax-tooltip-wrapper {
    position: relative;
    display: inline-flex;
    align-items: center;
    margin-left: 0.25rem;
    cursor: help;
}

.syntax-icon {
    font-size: var(--text-sm);
    color: var(--text-tertiary);
    transition: color 0.2s;
}

.syntax-tooltip-wrapper:hover .syntax-icon {
    color: var(--accent);
}

.syntax-tooltip {
    position: absolute;
    bottom: 150%;
    left: 50%;
    transform: translateX(-50%) translateY(5px);
    background: var(--bg-elevated);
    border: 1px solid var(--border);
    padding: 0.75rem 1rem;
    border-radius: var(--radius-md);
    color: var(--text-primary);
    font-size: var(--text-sm);
    font-family: 'Google Sans Flex', sans-serif;
    white-space: nowrap;
    opacity: 0;
    visibility: hidden;
    transition: all 0.2s ease;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    z-index: 100;
}

.syntax-tooltip-wrapper:hover .syntax-tooltip {
    opacity: 1;
    visibility: visible;
    transform: translateX(-50%) translateY(0);
}
/* Arti's Foot-Stomping Highlight */
.strategic-read mark {
    background: rgba(192, 200, 196, 0.07);
    color: var(--text-primary);
    padding: 2px 4px;
    border-radius: var(--radius-sm);
    font-weight: 600;
    /* This ensures the highlight background wraps nicely across multiple lines */
    box-decoration-break: clone;
    -webkit-box-decoration-break: clone;
}


/* =========================================
   TOAST NOTIFICATIONS — replaces alert()
   ========================================= */
.toast-container {
  position: fixed;
  bottom: calc(var(--safe-bottom, 20px) + 1rem);
  left: 50%;
  transform: translateX(-50%);
  z-index: 500;
  display: flex;
  flex-direction: column-reverse;
  align-items: center;
  gap: 0.5rem;
  pointer-events: none;
  width: 90%;
  max-width: 400px;
}
.toast {
  pointer-events: auto;
  background: var(--bg-elevated);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  padding: 0.75rem 1rem;
  font-family: 'Google Sans Flex', sans-serif;
  font-size: var(--text-sm);
  color: var(--text-primary);
  box-shadow: 0 8px 24px rgba(0,0,0,0.4);
  display: flex;
  align-items: center;
  gap: 0.5rem;
  animation: toastIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards;
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  width: 100%;
}
.toast.toast-error { border-color: var(--danger); }
.toast.toast-error .toast-icon { color: var(--danger); }
.toast.toast-success .toast-icon { color: var(--success); }
.toast.toast-warning .toast-icon { color: var(--warning); }
.toast-icon { flex-shrink: 0; font-size: var(--text-base); }
.toast-msg { flex: 1; line-height: 1.4; }
.toast.toast-out {
  animation: toastOut 0.2s ease forwards;
}
@keyframes toastIn {
  from { opacity: 0; transform: translateY(12px) scale(0.95); }
  to { opacity: 1; transform: translateY(0) scale(1); }
}
@keyframes toastOut {
  from { opacity: 1; transform: translateY(0) scale(1); }
  to { opacity: 0; transform: translateY(8px) scale(0.95); }
}

/* =========================================
   STAT PANEL SYSTEM — Reusable stat rows
   ========================================= */
.stat-panel {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-md);
  padding: 1.25rem;
  margin-bottom: var(--section-gap);
  overflow: hidden;
}
.stat-subtitle {
  font-family: 'Google Sans Flex', sans-serif;
  font-size: var(--text-xs);
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 1.5px;
  margin-bottom: 0.5rem;
}
.stat-row {
  display: flex; align-items: baseline; gap: 1.5rem; flex-wrap: wrap;
}
.stat-hero {
  font-family: 'Google Sans Flex', sans-serif;
  font-size: var(--text-hero);
  font-weight: 600; color: var(--text-primary); line-height: 1;
}
.stat-group {
  display: flex; gap: 1.25rem; align-items: baseline; flex-wrap: wrap;
  margin-left: 0.5rem; padding-left: 1.5rem; border-left: 1px solid var(--border);
}
.stat-item { display: flex; align-items: baseline; gap: 0.35rem; }
.stat-value {
  font-family: 'Google Sans Flex', sans-serif;
  font-size: var(--text-lg); font-weight: 700; color: var(--text-primary);
}
.stat-label {
  font-size: var(--text-xs); color: var(--text-secondary); text-transform: none;
}
.panel-footer {
  display: flex; align-items: center; justify-content: space-between;
  margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid var(--border);
  font-size: var(--text-xs); color: var(--text-secondary);
  font-family: 'Google Sans Flex', sans-serif;
}

/* Explainer box: collapsed editorial style */
.explainer-box {
  background: transparent !important;
  border: none !important;
  border-top: 1px solid rgba(143, 158, 152, 0.08) !important;
  border-bottom: 1px solid rgba(143, 158, 152, 0.08) !important;
  border-radius: 0 !important;
  padding: 0 0.25rem !important;
  margin-top: var(--section-gap) !important;
  margin-bottom: var(--section-gap) !important;
}
.explainer-box-content {
  font-size: var(--text-sm); color: var(--text-secondary); line-height: 1.6;
  font-family: 'Google Sans Flex', sans-serif;
}
.explainer-box-content strong { color: var(--text-primary); }

/* =========================================
   ETM: EDITORIAL TECH MINIMALISM OVERLAY
   Phase 1: Typography & Hierarchy
   Phase 2: Chart Framing & Captions
   Phase 3: Ask Arti Reframing
   Phase 4: Mobile Hierarchy Tuning
   ========================================= */

/* --- PHASE 1: TYPOGRAPHY & HIERARCHY --- */

body {
  font-family: 'Google Sans Flex', sans-serif !important;
  letter-spacing: 0.01em;
}

.section-title,
.stat-subtitle,
.ai-banner-title,
.ai-header h3,
.data-panel-title,
.bubble-header,
.footer-label {
  font-family: 'Google Sans Flex', sans-serif !important;
  text-transform: none !important;
  letter-spacing: 0.02em !important;
  font-weight: 600 !important;
}

.section-title {
  font-size: var(--text-lg) !important;
  font-weight: 700 !important;
  color: var(--text-primary) !important;
  letter-spacing: -0.01em !important;
  text-transform: none !important;
  border-bottom: none !important;
}

.section-header {
  border-bottom: 1px solid rgba(143, 158, 152, 0.12) !important;
  padding-bottom: 0.75rem !important;
  margin-top: 1.5rem !important;
}

.stat-subtitle {
  font-size: var(--text-sm) !important;
  color: var(--text-secondary) !important;
  letter-spacing: 0 !important;
  text-transform: none !important;
  font-weight: 500 !important;
  line-height: 1.5 !important;
}

.stat-hero {
  font-family: 'Google Sans Flex', sans-serif !important;
  font-weight: 600 !important;
  letter-spacing: -0.02em;
}

.data-panel-title {
  text-transform: none !important;
  letter-spacing: 0 !important;
  font-size: var(--text-sm) !important;
  color: var(--text-primary) !important;
  font-weight: 600 !important;
}

.data-panel-subtitle {
  font-family: 'Google Sans Flex', sans-serif !important;
  text-transform: none !important;
  letter-spacing: 0 !important;
  font-size: var(--text-xs) !important;
  color: var(--text-secondary) !important;
}

.data-panel-header {
  border-bottom: 1px solid rgba(143, 158, 152, 0.08) !important;
}

.stat-label {
  text-transform: none !important;
  font-size: var(--text-xs) !important;
  color: var(--text-secondary) !important;
  letter-spacing: 0 !important;
  font-family: 'Google Sans Flex', sans-serif !important;
}

/* Visual restraint on containers */
.stat-panel {
  border: 1px solid rgba(143, 158, 152, 0.12) !important;
  box-shadow: none !important;
  background: rgba(28, 35, 32, 0.6) !important;
}

.data-panel {
  border: 1px solid rgba(143, 158, 152, 0.10) !important;
  box-shadow: none !important;
  background: rgba(28, 35, 32, 0.5) !important;
}

.deal-card {
  box-shadow: none !important;
  border: 1px solid rgba(143, 158, 152, 0.10) !important;
  background: rgba(28, 35, 32, 0.4) !important;
}

.deal-card:hover {
  box-shadow: none !important;
  border-color: rgba(143, 158, 152, 0.25) !important;
  background: rgba(28, 35, 32, 0.6) !important;
  transform: none !important;
}

.deal-desc {
  font-family: 'Google Sans Flex', sans-serif !important;
  font-size: var(--text-lg) !important;
  font-weight: 600 !important;
  line-height: 1.5 !important;
  letter-spacing: -0.01em;
  color: var(--text-primary) !important;
}

/* Reading prose: optimized line height for 38-60 demo */
.explainer-box-content,
.ai-result-content,
.strategic-read p,
.footer-text,
.use-case-desc {
  font-family: 'Google Sans Flex', sans-serif !important;
  line-height: 1.75 !important;
  letter-spacing: 0.01em !important;
  color: var(--text-secondary) !important;
}

/* Monospace only for technical fields */
.deal-amount,
.deal-vendor,
.reach-amount,
.reach-badge,
.meta-tag {
  font-family: 'Google Sans Flex', sans-serif !important;
}

/* --- READABILITY BOOST: reach rows, meta, feed --- */
.reach-name {
  color: var(--text-primary) !important;
  font-weight: 600 !important;
}

.reach-meta {
  color: var(--text-secondary) !important;
  font-size: var(--text-xs) !important;
}

.reach-amount {
  color: var(--text-primary) !important;
}

.deal-agency {
  color: var(--text-secondary) !important;
  font-weight: 600 !important;
}

.deal-date,
.mission-gap-signals {
  color: var(--text-secondary) !important;
}

.meta-tag {
  color: var(--text-secondary) !important;
}

/* --- PHASE 2: CHART FRAMING & CAPTIONS --- */

.panel-footer {
  font-family: 'Google Sans Flex', sans-serif !important;
  font-size: var(--text-xs) !important;
  color: var(--text-tertiary) !important;
  text-transform: none !important;
  letter-spacing: 0 !important;
  border-top: 1px solid rgba(143, 158, 152, 0.08) !important;
  padding-top: 0.6rem !important;
  margin-top: 0.6rem !important;
}

#bubbleChartPanel,
#subBubblePanel {
  background: rgba(28, 35, 32, 0.5) !important;
  border: 1px solid rgba(143, 158, 152, 0.10) !important;
  box-shadow: none !important;
}

.bubble-toggle-btn {
  font-family: 'Google Sans Flex', sans-serif !important;
  font-size: var(--text-xs) !important;
  letter-spacing: 0.05em !important;
  font-weight: 600 !important;
  border-color: rgba(143, 158, 152, 0.15) !important;
  text-transform: uppercase !important;
}

.bubble-toggle-btn.active {
  background: var(--brand) !important;
  border-color: var(--brand) !important;
  font-weight: 700 !important;
}

.drill-hint {
  font-family: 'Google Sans Flex', sans-serif !important;
  background: rgba(255, 255, 255, 0.02) !important;
  border: 1px dashed rgba(143, 158, 152, 0.12) !important;
  font-size: var(--text-sm) !important;
  color: var(--text-secondary) !important;
}

/* --- PHASE 3: ASK ARTI — SENIOR ANALYST --- */

.ai-banner {
  background: rgba(28, 35, 32, 0.8) !important;
  border: 1px solid rgba(192, 200, 196, 0.2) !important;
  border-left: 3px solid var(--accent) !important;
  box-shadow: none !important;
  border-radius: var(--radius-sm) !important;
  padding: 1rem 1.25rem !important;
}

.ai-banner-title {
  font-family: 'Google Sans Flex', sans-serif !important;
  text-transform: none !important;
  letter-spacing: 0 !important;
  font-size: var(--text-base) !important;
  font-weight: 600 !important;
  color: var(--text-primary) !important;
}

.ai-banner-desc {
  font-family: 'Google Sans Flex', sans-serif !important;
  font-size: var(--text-sm) !important;
  color: var(--text-secondary) !important;
  line-height: 1.6 !important;
}

.btn-ai {
  background: var(--brand) !important;
  color: var(--brand-text) !important;
  font-family: 'Google Sans Flex', sans-serif !important;
  font-weight: 700 !important;
  font-size: var(--text-sm) !important;
  letter-spacing: 0.06em !important;
  text-transform: uppercase !important;
  border-radius: var(--radius-sm) !important;
  box-shadow: none !important;
  padding: 0.5rem 1rem !important;
}

.btn-ai:hover {
  background: var(--brand-hover) !important;
  box-shadow: none !important;
  transform: none !important;
}

.ai-action-panel {
  border-left: 3px solid var(--accent) !important;
  border-radius: 0 var(--radius-sm) var(--radius-sm) 0 !important;
  box-shadow: none !important;
  background: rgba(28, 35, 32, 0.6) !important;
}

.ai-header h3 {
  font-family: 'Google Sans Flex', sans-serif !important;
  text-transform: none !important;
  letter-spacing: 0 !important;
  font-size: var(--text-lg) !important;
  font-weight: 600 !important;
}

.strategic-read h1,
.strategic-read h2,
.strategic-read h3 {
  font-family: 'Google Sans Flex', sans-serif !important;
  text-transform: none !important;
  letter-spacing: 0 !important;
  font-size: var(--text-base) !important;
  font-weight: 600 !important;
  color: var(--text-primary) !important;
  border-bottom: 1px solid rgba(143, 158, 152, 0.08) !important;
}

.strategic-read p {
  font-family: 'Google Sans Flex', sans-serif !important;
  line-height: 1.75 !important;
  font-size: var(--text-base) !important;
  color: var(--text-secondary) !important;
}

.strategic-read > p:first-child,
.strategic-read > p:first-of-type {
  font-family: 'Google Sans Flex', sans-serif !important;
  font-size: var(--text-lg) !important;
  line-height: 1.6 !important;
  border-left: 2px solid var(--accent) !important;
  color: var(--text-primary) !important;
  font-weight: 400 !important;
}

.ai-msg-user {
  font-family: 'Google Sans Flex', sans-serif !important;
  border-radius: var(--radius-sm) !important;
}

.ai-chat-input-wrapper input {
  font-family: 'Google Sans Flex', sans-serif !important;
}

.ai-disclaimer {
  font-family: 'Google Sans Flex', sans-serif !important;
  font-size: var(--text-xs) !important;
  opacity: 0.7 !important;
  color: var(--text-secondary) !important;
}

.ai-chat-counter {
  font-family: 'Google Sans Flex', sans-serif !important;
  font-size: var(--text-xs) !important;
  opacity: 0.6 !important;
}

/* --- EXPLAINER HIGHLIGHTS: editorial minimal outside Arti --- */
/* Strip the neon highlight outside of Arti's chat/analysis panels */
.explainer-highlight {
  background: none !important;
  color: var(--text-primary) !important;
  padding: 0 !important;
  border-radius: 0 !important;
  font-weight: 600 !important;
  font-style: normal !important;
  box-decoration-break: initial !important;
  -webkit-box-decoration-break: initial !important;
}

/* Keep a refined, restrained highlight inside Arti only */
.ai-action-panel .explainer-highlight,
.ai-msg-arti .explainer-highlight,
.strategic-read .explainer-highlight {
  background: rgba(192, 200, 196, 0.08) !important;
  color: var(--text-primary) !important;
  padding: 1px 4px !important;
  border-radius: 2px !important;
  font-weight: 600 !important;
}

/* Also keep the <mark> treatment editorial inside Arti */
.strategic-read mark {
  background: rgba(192, 200, 196, 0.08) !important;
  color: var(--text-primary) !important;
  font-weight: 600 !important;
  padding: 1px 4px !important;
  border-radius: 2px !important;
}

/* --- PHASE 4: MOBILE & GLOBAL --- */

.hero-subtitle {
  font-family: 'Google Sans Flex', sans-serif !important;
  font-size: var(--text-lg) !important;
  color: var(--text-primary) !important;
  font-weight: 400 !important;
  letter-spacing: -0.01em;
  line-height: 1.5 !important;
}

.terminal-logo .logo-name {
  font-family: 'Google Sans Flex', sans-serif !important;
  color: #C0C8C4 !important;
}

.main-input {
  box-shadow: none !important;
  border: 1px solid rgba(143, 158, 152, 0.25) !important;
  font-family: 'Google Sans Flex', sans-serif !important;
}

.main-input:focus {
  border-color: var(--accent) !important;
  box-shadow: none !important;
}

/* ALL BUTTONS: UPPERCASE */
.btn-primary,
#searchBtn,
.btn-ai,
.btn-ai-outline,
.bubble-toggle-btn,
.mission-gap-toggle,
.action-btn,
.breadcrumb-item,
#aiChatSendBtn,
#copyAiBtn {
  text-transform: uppercase !important;
  letter-spacing: 0.06em !important;
  font-weight: 700 !important;
}

.btn-primary, #searchBtn {
  font-family: 'Google Sans Flex', sans-serif !important;
  font-size: var(--text-base) !important;
  box-shadow: none !important;
}

.btn-primary:hover, #searchBtn:hover {
  transform: none !important;
}

.hero-suggestion-chip {
  font-family: 'Google Sans Flex', sans-serif !important;
  font-size: var(--text-xs) !important;
}

.footer-label {
  font-family: 'Google Sans Flex', sans-serif !important;
  text-transform: uppercase !important;
  letter-spacing: 0.08em !important;
  font-size: var(--text-xs) !important;
  font-weight: 700 !important;
}

.use-case-title {
  font-family: 'Google Sans Flex', sans-serif !important;
  text-transform: none !important;
  letter-spacing: 0 !important;
  font-weight: 600 !important;
}

/* Global visual restraint */
.ai-banner,
.deal-card,
.stat-panel,
.data-panel,
.ai-action-panel,
#bubbleChartPanel,
#subBubblePanel {
  box-shadow: none !important;
}

.icon-btn {
  opacity: 0.85;
}
.icon-btn:hover {
  opacity: 1;
}

.mission-gap-toggle {
  font-family: 'Google Sans Flex', sans-serif !important;
  font-size: var(--text-xs) !important;
  font-weight: 700 !important;
  letter-spacing: 0.06em !important;
}

.breadcrumb-item {
  font-family: 'Google Sans Flex', sans-serif !important;
  font-size: var(--text-sm) !important;
}

.app-header {
  border-bottom: 1px solid rgba(143, 158, 152, 0.10) !important;
}

.mini-search {
  font-family: 'Google Sans Flex', sans-serif !important;
  box-shadow: none !important;
}

#loaderText {
  font-family: 'Google Sans Flex', sans-serif !important;
  text-transform: none !important;
  letter-spacing: 0 !important;
  font-weight: 600 !important;
}

/* --- COHESIVE LINK BUTTONS: job-link, action-btn, footer-link --- */
/* Unified "pill button" design language for all dynamic linked actions */
.job-link {
  font-family: 'Google Sans Flex', sans-serif !important;
  font-size: var(--text-xs) !important;
  font-weight: 500 !important;
  color: var(--text-tertiary) !important;
  background: none !important;
  border: none !important;
  border-radius: var(--radius-sm) !important;
  padding: 2px 4px !important;
  text-decoration: none !important;
  text-transform: none !important;
  letter-spacing: 0 !important;
  transition: color 0.15s ease !important;
}

.job-link:hover {
  color: var(--text-primary) !important;
  background: rgba(255,255,255,0.04) !important;
  border-color: var(--accent) !important;
}

.job-link i {
  display: none !important;
}

.deal-footer .action-btn {
  font-family: 'Google Sans Flex', sans-serif !important;
  text-transform: uppercase !important;
  letter-spacing: 0.06em !important;
  font-weight: 700 !important;
  font-size: var(--text-xs) !important;
  color: var(--text-secondary) !important;
  border: 1px solid rgba(143, 158, 152, 0.18) !important;
  background: rgba(255, 255, 255, 0.04) !important;
  border-radius: var(--radius-sm) !important;
  transition: all 0.15s ease !important;
}

.deal-footer .action-btn:hover {
  color: var(--text-primary) !important;
  background: rgba(192, 200, 196, 0.08) !important;
  border-color: var(--accent) !important;
}

.btn-ai-outline {
  font-family: 'Google Sans Flex', sans-serif !important;
  text-transform: uppercase !important;
  letter-spacing: 0.06em !important;
  font-weight: 700 !important;
}

/* --- MOBILE-SPECIFIC ETM OVERRIDES --- */
@media (max-width: 768px) {
  .stat-subtitle {
    font-size: var(--text-sm) !important;
    line-height: 1.5 !important;
  }
  
  .stat-hero {
    font-size: clamp(1.5rem, 4vw, 2rem) !important;
  }
  
  .bubble-toggle-btn {
    min-height: 36px !important;
    padding: 6px 12px !important;
  }
  
  .ai-banner {
    border-left: 3px solid var(--brand) !important;
    border-radius: 0 var(--radius-sm) var(--radius-sm) 0 !important;
  }
  
  .ai-banner-title {
    font-size: var(--text-sm) !important;
  }
  
  .job-link {
    min-height: 44px !important;
    min-width: 44px !important;
    padding: 8px 12px !important;
    font-size: var(--text-sm) !important;
  }
}

@media (max-width: 600px) {
  .section-title {
    font-size: var(--text-base) !important;
  }
  
  .deal-desc {
    font-size: var(--text-base) !important;
    line-height: 1.5 !important;
  }
  
  .strategic-read > p:first-child,
  .strategic-read > p:first-of-type {
    font-size: var(--text-base) !important;
    line-height: 1.6 !important;
  }
}

/* =========================================
   17. BENTO GRID LAYOUT
   ========================================= */
.bento-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: var(--section-gap);
  margin-bottom: var(--section-gap);
}

.bento-row > * {
  min-width: 0; /* Prevent grid blowout */
  margin-bottom: 0 !important; /* Grid handles spacing */
}

/* When a bento-row has only one visible child, let it span full width */
.bento-row > *:only-child {
  grid-column: 1 / -1;
}

@media (max-width: 768px) {
  .bento-row {
    grid-template-columns: 1fr;
    gap: 0.6rem;
  }
}
</style>
</head>
<body>

  <div id="heroView" class="hero-view">
    <div class="terminal-logo">
      <span class="logo-name">Govhoo</span>
    </div>
    <p class="hero-subtitle" style="padding-left: 1.25em;">Follow the Money. For Free.</p>
    
    <div class="search-box-container">
      <div style="position: relative;">
        <input type="text" id="mainSearchInput" class="main-input" placeholder="Try: CLOUD, 541512 AND AIR FORCE, or DA10 AND AIR FORCE">
        <button class="input-clear" onclick="document.getElementById('mainSearchInput').value=''; document.getElementById('mainSearchInput').focus();" aria-label="Clear search">×</button>
      </div>
      <div class="btn-row">
        <button id="searchBtn" class="btn-primary" data-action="search" style="flex: none; width: 100%;">
          Search
        </button>
      </div>
    </div>

    <div class="hero-suggestions">
      <a href="?q=ZERO+TRUST%2C+FIREWALL" class="hero-suggestion-chip">ZERO TRUST, FIREWALL</a>
      <a href="?q=541512+AND+AIR FORCE" class="hero-suggestion-chip">541512 AND AIR FORCE</a>
      <a href="?q=Department+of+Homeland+Security&drill=Department+of+Homeland+Security" class="hero-suggestion-chip">DHS</a>
      <a href="?q=SBIR+PHASE+III" class="hero-suggestion-chip">SBIR PHASE III</a>
    </div>

    <footer class="hero-footer">
      <div class="footer-grid">

        <div class="footer-section">
          <div class="footer-label mono text-xs accent upper">How it works</div>
          <div style="margin-bottom: 1rem;">
            <ol class="steps-list" style="list-style: none; padding-left: 0;">
              <li style="margin-bottom: 1rem;">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                  <strong style="color: var(--text-primary);">Size Federal Markets</strong>
                </div>
                <div style="font-size: var(--text-sm); color: var(--text-primary); opacity: 0.95; line-height: 1.5;">
                  Search a keyword, NAICS code, company, or agency to <em class="explainer-highlight">instantly see total spend, who's buying, and who's winning</em>. Use <strong style="color: var(--text-primary); font-weight: 700;">AND</strong> to narrow — <em>541512 AND Air Force</em>. Use a <strong style="color: var(--text-primary); font-weight: 700;">,</strong> to broaden — <em>Cloud, Cyber</em>. Shorthand like <em>DHS</em>, <em>VA</em>, <em>DISA</em> works too.
                </div>
              </li>
              <li style="margin-bottom: 1rem;">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                  <strong style="color: var(--text-primary);">Follow the Money</strong>
                </div>
                <div style="font-size: var(--text-sm); color: var(--text-primary); opacity: 0.95; line-height: 1.5;">
                  See exactly how dollars move from agencies to primes, and which sub-agencies control the budget. <em class="explainer-highlight">Click any bar to drill in</em>. Filter by NAICS code or contract vehicle to zero in on your target market.
                </div>
              </li>
              <li style="margin-bottom: 0;">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                  <strong style="color: var(--text-primary);">Find Partners</strong>
                </div>
                <div style="font-size: var(--text-sm); color: var(--text-primary); opacity: 0.95; line-height: 1.5;">
                  See which primes have the broadest agency reach in your market, <em class="explainer-highlight">ideal teaming partners</em>. Click any vendor to see their full federal portfolio. Switch to the Sub view to map prime→sub workshare relationships and find who actually does the work.
                </div>
              </li>
            </ol>
          </div>
        </div>

        <div class="footer-section">
          <div class="footer-label mono text-xs accent upper">Use cases</div>
          <div class="use-cases">
            <div class="use-case">
              <div class="use-case-title">Territory Planning</div>
              <div class="use-case-desc">
                See total spend, top buyers, dominant vendors, and expiring contracts in any market, the <em class="explainer-highlight">data you need for QBRs and territory plans</em>, without the manual spreadsheet work.
              </div>
            </div>
            <div class="use-case">
              <div class="use-case-title">Teaming & Partnering</div>
              <div class="use-case-desc">
                Find which primes work across the most agencies in your space. See their sub relationships, workshare patterns, and contract vehicles, so you <em class="explainer-highlight">approach the right partner with real data</em>.
              </div>
            </div>
            <div class="use-case">
              <div class="use-case-title">Competitive Intelligence</div>
              <div class="use-case-desc">
                Click any vendor to see their full federal portfolio, every agency, every NAICS code, every contract vehicle. Know who owns what <em class="explainer-highlight">before you decide to invest resources</em>.
              </div>
            </div>
          </div>
        </div>

        <div class="footer-section">
          <div class="footer-label mono text-xs accent upper">Built by a seller</div>
          <p class="footer-text">
            <img src="https://govhoo.com/images/oldmark.jpg" alt="Mark Flournoy" class="tip-bio-img">
            Hi, I’m Mark. I’ve sold at AWS, F5, and Red Hat, served as a DISA COTR, and spent 20 years in the Marines. And even with all that government experience, I still <em class="explainer-highlight">wasted hours every month as a seller digging through USASpending</em>, SAM.gov, and industry days just to understand where the money was flowing and who really owned the workshare.
            <br><br>
           I built Govhoo to <em class="explainer-highlight">visualize federal markets so you can follow the money, make better decisions, and spend more time with your customers.</em> All data is pulled live from USASpending.gov. And it's free.
            <br><br>
            If you want to walk through your territory together or sanity-check a GTM plan, you can <em class="explainer-highlight">book a free session</em> below or find me on
            <a href="https://www.linkedin.com/in/markflournoy/" target="_blank" class="footer-link">LinkedIn</a>.
          </p>
          <div style="padding: 1rem; margin-top: 1.2rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-md);">
            <div style="font-family: 'Google Sans Flex', sans-serif; font-size: var(--text-sm); font-weight: 700; color: var(--text-primary); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 0.5rem;">
              30-Min Google Meet
            </div>
            <div style="font-size: var(--text-sm); color: var(--text-primary); opacity: 0.95; line-height: 1.4; margin-bottom: 1rem;">
              Bring your territory or a target market. <em class="explainer-highlight">We’ll pull the data together live</em> and I’ll show you how to turn it into a plan you can act on and drop into your next QBR or pipeline review. All sessions are <em class="explainer-highlight">100% confidential</em>.
            </div>
            <a href="https://calendly.com/markflournoy/govhoo" target="_blank" style="text-decoration:none;">
              <button class="btn-primary" style="width: 100%; padding: 0.6rem; font-size: var(--text-sm); justify-content: center;">
                Book a Session
              </button>
            </a>
          </div>
        </div>

      </div>
      <div class="footer-bottom">
        <div class="footer-copyright">© 2026 <span style="font-family: 'Google Sans Flex', sans-serif;font-weight:600;color:#C0C8C4;">GOVHOO.COM</span> — DATA VIA USASPENDING.GOV</div>
      </div>
    </footer>
  </div>

  <div id="appView" style="display:none;">
    <header class="app-header">
      <div class="header-left">
        <span class="logo-btn" data-action="showHero" title="Back to home"><span class="logo-home-icon"><i class="fa-solid fa-house"></i></span><span class="logo-name">Govhoo</span></span>
        <div class="mini-search-wrapper">
          <input type="text" id="miniSearch" class="mini-search" placeholder="Search keywords, companies, NAICS, agencies...">
        </div>
      </div>
      <div class="header-actions">
        <button class="icon-btn icon-btn-slack" data-action="shareBrief" title="Share Link">
          <i class="fa-regular fa-paper-plane"></i>
        </button>
        <button class="icon-btn icon-btn-csv" title="Download CSV" data-action="exportCSV">
          <i class="fas fa-arrow-down"></i>
        </button>
        <button class="icon-btn icon-btn-pres" id="presToggleBtn" onclick="App.togglePresentationMode()" title="Light Mode">
          <i class="fas fa-rainbow"></i>
        </button>
      </div>
    </header>

    <div id="dashboardContainer" class="dashboard-container">
      <div id="searchModeView" class="view-section active">
        
        <div id="aiIntelligenceBanner" class="ai-banner">
          <div class="ai-banner-wrapper">
            <img src="images/arti.png" alt="Arti" class="ai-avatar-float">
            <h4 class="ai-banner-title">Analyst briefing for this market</h4>
            <p class="ai-banner-desc">Ask Arti where the opportunities are, who to team with, and how to engage. Get a quick read, then dig deeper if it’s worth it.</p>
          </div>
          <button id="triggerAiPlanBtn" class="btn-ai" onclick="App.runAiActionPlan()">
            Read briefing
          </button>
        </div>

        <div id="aiActionPanel" class="ai-action-panel">
          <div class="ai-header">
            <div class="ai-header-title">
              <img src="images/arti.png" alt="Arti" class="ai-avatar">
              <h3>Arti's analysis</h3>
            </div>
            <button id="copyAiBtn" class="btn-ai-outline" onclick="App.copyAiPlan()" style="display: none;">Copy</button>
          </div>
          
          <div id="aiContentContainer" class="ai-result-content"></div>
          
          <div id="aiChatHistory" class="ai-chat-history" style="display: none;"></div>
          
          <div id="aiChatInputWrapper" class="ai-chat-input-wrapper" style="display: none;">
            <input type="text" id="aiChatInput" class="main-input" placeholder="What else do you want to know?" autocomplete="off" style="font-size: var(--text-base); padding: 0.75rem 1rem; height: auto;">
            <button id="aiChatSendBtn" class="btn-ai" onclick="App.sendAiChatMessage()" style="padding: 0 1.25rem; font-weight: 700; letter-spacing: 1px;">Send</button>
          </div>
          <div id="aiChatCounter" class="ai-chat-counter" style="display: none;">5 questions remaining</div>
          <div id="aiDisclaimer" class="ai-disclaimer" style="display: none;">
            Arti is an AI. Always verify USASpending data and use your own judgment before making strategic decisions.
          </div>
        </div>

        <div id="drillControlsBar" class="drill-controls-bar" style="display: none; margin-bottom: 1rem; padding: 0.75rem 1rem; background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: var(--radius-md); overflow: hidden;">
          <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 0.5rem;">
            <div id="drillBreadcrumb" class="drill-breadcrumb" style="display: flex; margin: 0; flex-wrap: wrap; min-width: 0;">
              <div class="breadcrumb-item" data-action="resetDrill">
                <span>All Agencies</span>
              </div>
            </div>
          </div>
        </div>

        <div id="sankeyPanel" class="stat-panel sankey-panel">
          <div style="margin-bottom: 1rem;">
            <div id="sankeySubtitle" class="stat-subtitle">Where the money flows · Active obligated value</div>
            <div class="stat-row">
              <div id="stat-vol" class="stat-hero">-</div>
              <div id="searchStatsCompact" class="stat-group">
                <div class="stat-item"><span id="stat-agencies" class="stat-value">-</span><span class="stat-label">Agencies</span></div>
                <div class="stat-item"><span id="stat-count" class="stat-value">-</span><span class="stat-label">Contracts</span></div>
                <div class="stat-item"><span id="stat-vendors" class="stat-value">-</span><span class="stat-label">Vendors</span></div>
              </div>
            </div>
          </div>
          <div class="chart-wrapper" style="border: none; padding: 0; background: transparent; overflow-x: auto; overflow-y: visible;">
            <div id="chartContainer" class="chart-container"></div>
          </div>
          <div class="panel-footer">
            <span id="marketHealth"></span>
            <span style="display:inline-flex;align-items:baseline;"><span style="font-family: 'Google Sans Flex', sans-serif;font-weight:600;color:#C0C8C4;">Govhoo.com</span></span>
          </div>
        </div>

        <div id="drillHint" class="drill-hint" style="display:none;">
          <span>Click an <strong>agency bar</strong> to drill into sub-agencies</span>
        </div>

        <div id="bubbleChartPanel" style="display: none;">
          <div style="margin-bottom: 1rem;">
            <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 0.5rem;">
              <div id="bubbleChartSubtitle" class="stat-subtitle" style="margin-bottom:0;">Market concentration by vendor and agency · Funded value</div>
              <div class="bubble-toggle-row" style="margin-bottom: 0;" id="bubbleToggleRow">
                <button class="bubble-toggle-btn active" onclick="App.setBubbleMode('vendors')" id="bubbleToggleVendors">Vendors</button>
                <button class="bubble-toggle-btn" onclick="App.setBubbleMode('agencies')" id="bubbleToggleAgencies">Agencies</button>
                <button class="bubble-toggle-btn" onclick="App.setBubbleMode('subagencies')" id="bubbleToggleSubAgencies" style="display:none;">Sub-Agencies</button>
                <span class="toggle-sep"></span>
                <button class="bubble-toggle-btn active" onclick="App.setBubbleChartType('bubbles')" id="chartTypeBubbles">Bubbles</button>
                <button class="bubble-toggle-btn" onclick="App.setBubbleChartType('treemap')" id="chartTypeTreemap">Treemap</button>
              </div>
            </div>
            <div class="stat-row">
              <div id="bubble-stat-vol" class="stat-hero">-</div>
              <div class="stat-group">
                <div class="stat-item"><span id="bubble-stat-agencies" class="stat-value">-</span><span class="stat-label">Agencies</span></div>
                <div class="stat-item"><span id="bubble-stat-count" class="stat-value">-</span><span class="stat-label">Contracts</span></div>
                <div class="stat-item"><span id="bubble-stat-vendors" class="stat-value">-</span><span class="stat-label">Vendors</span></div>
              </div>
            </div>
          </div>

          <div id="bubbleBreadcrumb" style="display:none; margin-bottom: 0.75rem; padding: 0.5rem 0.75rem; background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: var(--radius-md); font-size: var(--text-sm); overflow-x: auto;">
            <div id="bubbleBreadcrumbInner" style="display: flex; align-items: center; gap: 0.35rem; flex-wrap: wrap;"></div>
          </div>
          <div id="bubbleChartContainer">
            <div class="bubble-tooltip" id="bubbleTooltip"></div>
          </div>
          <div class="panel-footer">
            <span> Size = total award value · Click to drill down · Toggle Treemap for market share view</span>
            <span style="display:inline-flex;align-items:baseline;"><span style="font-family: 'Google Sans Flex', sans-serif;font-weight:600;color:#C0C8C4;">Govhoo.com</span></span>
          </div>
        </div>

        <div id="vehicleFilterBar" style="display: none; margin-bottom: 0.75rem; padding: 0.5rem 0.75rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-md);">
          <div style="display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
            <span class="stat-label" style="flex-shrink: 0;">Vehicles</span>
            <div id="vehiclePills" style="display: flex; gap: 0.35rem; flex-wrap: wrap;"></div>
          </div>
        </div>

        <div id="naicsPanel" class="data-panel" style="display: none;">
          <div class="data-panel-header">
            <span class="data-panel-title">NAICS Breakdown</span>
            <span class="data-panel-subtitle">click to explore all agencies buying this NAICS</span>
          </div>
          <div class="data-panel-body" id="naicsMixBody"></div>
        </div>

        <div class="bento-row">
        <div id="searchJobPanel" style="margin: 0; padding: 0; position: relative;">
          <div id="agencyReachPanel" class="data-panel" style="display: none;">
            <div class="data-panel-header">
              <span class="data-panel-title">Top Agencies</span>
              <span class="data-panel-subtitle">click to drill · ranked by spend</span>
            </div>
            <div class="data-panel-body" id="searchTopBuyersBody"></div>
          </div>
        </div>

        <div id="teamingPanel" class="data-panel" style="display: none;">
          <div class="data-panel-header">
            <span class="data-panel-title">Prime Reach</span>
            <span class="data-panel-subtitle">ranked by agency diversity · click for footprint</span>
          </div>
          <div class="data-panel-body" id="teamingList"></div>
        </div>
        </div>

        <div id="recompetesList" style="margin-bottom: var(--section-gap);"></div>

        <div class="section-header">
          <div class="section-title-group">
            <span class="section-title">Recent Awards</span>
          </div>
        </div>
        <div id="feedGrid" class="feed-grid"></div>

        <div id="primeExplainerBox" class="explainer-box" style="display:none;">
          <div style="display: flex; align-items: center; justify-content: space-between; cursor: pointer; padding: 0.5rem 0;" onclick="(function(e){ var b=e.currentTarget.nextElementSibling; var icon=e.currentTarget.querySelector('.etm-toggle-icon'); if(b.style.display==='none'){b.style.display='block';icon.textContent='−';}else{b.style.display='none';icon.textContent='+';} })(event)">
            <span style="font-family: 'Google Sans Flex', sans-serif; font-size: var(--text-sm); font-weight: 600; color: var(--text-primary);">How to read this data</span>
            <span class="etm-toggle-icon" style="font-family: 'Google Sans Flex', sans-serif; font-size: var(--text-lg); color: var(--text-secondary); font-weight: 700; line-height: 1; padding: 0 4px;">+</span>
          </div>
          <div style="display: none; font-size: var(--text-sm); color: var(--text-secondary); line-height: 1.7; padding-top: 0.5rem; border-top: 1px solid rgba(143, 158, 152, 0.08);">
            You're looking at live federal award data from USASpending.gov. Every contract shown had funding activity in the past 12 months. Dollar values are <strong style="color: var(--text-primary);">total obligations to date</strong> — the government's cumulative commitment over the life of the contract.<br><br>
            <strong style="color: var(--text-primary);">Sankey</strong> — where the money flows. Click any agency to drill into sub-agencies.
            <strong style="color: var(--text-primary);">Bubble chart</strong> — market concentration. See if spend is spread or locked up.
            <strong style="color: var(--text-primary);">NAICS</strong> — which service categories carry the most investment. Click to filter.
            <strong style="color: var(--text-primary);">Prime reach</strong> — primes ranked by agency breadth — your strongest teaming candidates.
            <strong style="color: var(--text-primary);">Top agencies</strong> — buyers ranked by spend. Click to drill.<br><br>
            <strong style="color: var(--text-primary);">Search tips:</strong> Use <strong style="color: var(--text-primary); font-weight: 700;">AND</strong> with codes: <em>541512 AND Air Force</em>. Commas broaden: <em>Cloud, Cyber</em>. Click any NAICS or vendor name to see their full footprint.
          </div>
        </div>

        <div id="subawardWrapper" style="display: none;">      
          
          <div style="margin-top: 1.5rem;">
            <div id="subcontractingPanel" class="stat-panel">
              <div id="subcontractingStats" style="margin-bottom: 1rem;">
                <div id="subSankeySubtitle" class="stat-subtitle">Prime-to-sub workshare · Transaction value</div>
                <div class="stat-row">
                  <div id="sub-stat-vol" class="stat-hero">-</div>
                  <div class="stat-group">
                    <div class="stat-item"><span id="sub-stat-primes" class="stat-value">-</span><span class="stat-label">Primes</span></div>
                    <div class="stat-item"><span id="sub-stat-subs" class="stat-value">-</span><span class="stat-label">Subs</span></div>
                    <div class="stat-item"><span id="sub-stat-count" class="stat-value">-</span><span class="stat-label">Contracts</span></div>
                  </div>
                </div>
              </div>
              <div class="chart-wrapper" style="border: none; padding: 0; background: transparent; overflow-x: auto; overflow-y: visible;">
                <div id="subcontractingBody" style="min-height: 350px;"></div>
              </div>
            </div>
          </div>

          <div id="subBubblePanel" class="stat-panel" style="display: none; margin-top: var(--section-gap);">
            <div style="margin-bottom: 1rem;">
              <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 0.5rem;">
                <div id="subBubbleSubtitle" class="stat-subtitle" style="margin-bottom:0;">Market concentration by primes and subs · Transaction value</div>
                <div class="bubble-toggle-row" style="margin-bottom: 0;">
                  <button class="bubble-toggle-btn active" onclick="App.setSubBubbleMode('primes')" id="subBubbleTogglePrimes">Primes</button>
                  <button class="bubble-toggle-btn" onclick="App.setSubBubbleMode('subs')" id="subBubbleToggleSubs">Subs</button>
                  <span class="toggle-sep"></span>
                  <button class="bubble-toggle-btn active" onclick="App.setSubBubbleChartType('bubbles')" id="subChartTypeBubbles">Bubbles</button>
                  <button class="bubble-toggle-btn" onclick="App.setSubBubbleChartType('treemap')" id="subChartTypeTreemap">Treemap</button>
                </div>
              </div>
              <div class="stat-row">
                <div id="sub-bubble-stat-vol" class="stat-hero">-</div>
                <div class="stat-group">
                  <div class="stat-item"><span id="sub-bubble-stat-primes" class="stat-value">-</span><span class="stat-label">Primes</span></div>
                  <div class="stat-item"><span id="sub-bubble-stat-subs" class="stat-value">-</span><span class="stat-label">Subs</span></div>
                  <div class="stat-item"><span id="sub-bubble-stat-records" class="stat-value">-</span><span class="stat-label">Contracts</span></div>
                </div>
              </div>
            </div>
            <div id="subBubbleBreadcrumb" style="display:none; margin-bottom: 0.75rem; padding: 0.5rem 0.75rem; background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: var(--radius-md); font-size: var(--text-sm); overflow-x: auto;">
              <div id="subBubbleBreadcrumbInner" style="display: flex; align-items: center; gap: 0.35rem; flex-wrap: wrap;"></div>
            </div>
            <div id="subBubbleContainer" style="width: 100%; min-height: 380px; position: relative;">
              <div class="bubble-tooltip" id="subBubbleTooltip"></div>
            </div>
            <div class="panel-footer">
              <span> Bubble size = subaward value · Click to drill</span>
              <span style="display:inline-flex;align-items:baseline;"><span style="font-family: 'Google Sans Flex', sans-serif;font-weight:600;color:#C0C8C4;">Govhoo.com</span></span>
            </div>
          </div>

          <div class="bento-row" style="margin-top: var(--section-gap);">
          <div id="subPrimesPanel" class="data-panel" style="display: none;">
            <div class="data-panel-header">
              <span class="data-panel-title">Top Primes</span>
              <span class="data-panel-subtitle">by sub value awarded</span>
            </div>
            <div class="data-panel-body" id="searchTopPrimesBody"></div>
          </div>

          <div id="subSubsPanel" class="data-panel" style="display: none;">
            <div class="data-panel-header">
              <span class="data-panel-title">Top Subs</span>
              <span class="data-panel-subtitle">by sub value received</span>
            </div>
            <div class="data-panel-body" id="searchTopSubsBody"></div>
          </div>
          </div>

          <div id="subExplainerBox" class="explainer-box" style="display: none;">
          <div style="display: flex; align-items: center; justify-content: space-between; cursor: pointer; padding: 0.5rem 0;" onclick="(function(e){ var b=e.currentTarget.nextElementSibling; var icon=e.currentTarget.querySelector('.etm-toggle-icon'); if(b.style.display==='none'){b.style.display='block';icon.textContent='−';}else{b.style.display='none';icon.textContent='+';} })(event)">
            <span style="font-family: 'Google Sans Flex', sans-serif; font-size: var(--text-sm); font-weight: 600; color: var(--text-primary);">How to read this data</span>
            <span class="etm-toggle-icon" style="font-family: 'Google Sans Flex', sans-serif; font-size: var(--text-lg); color: var(--text-secondary); font-weight: 700; line-height: 1; padding: 0 4px;">+</span>
          </div>
          <div style="display: none; font-size: var(--text-sm); color: var(--text-secondary); line-height: 1.7; padding-top: 0.5rem; border-top: 1px solid rgba(143, 158, 152, 0.08);">
            This is subcontracting activity from the past 12 months. Dollar amounts are <strong style="color: var(--text-primary);">individual transaction values</strong>, not cumulative obligations. Use this to understand who does the work, who the gatekeepers are, and where teaming relationships already exist.<br><br>
            <strong style="color: var(--text-primary);">Sankey</strong> — how sub dollars flow from agencies through primes to subs.
            <strong style="color: var(--text-primary);">Bubble chart</strong> — concentration. Toggle between primes and subs.
            <strong style="color: var(--text-primary);">Top primes</strong> — who's awarding the most sub work — teaming partners or competitors.
            <strong style="color: var(--text-primary);">Top subs</strong> — who's receiving the most sub work and which primes they serve under.<br><br>
            Click any vendor name to see their full federal footprint. Use the People/Jobs/News links to find contacts.
            <span id="subAndNote" style="display:none;"><br><br>
              <strong style="color: var(--text-primary);">AND searches:</strong> Subcontract data shows the broader market. The USASpending subaward API does not support AND filtering. Use the Prime view for precise AND-filtered totals.
            </span>
          </div>
          </div>

          <div id="subFeedWrapper" style="display: none; margin-top: var(--section-gap);">
            <div class="section-header">
              <div class="section-title-group">
                <span class="section-title">Recent subcontract activity</span>
              </div>
            </div>
            <div id="subFeedGrid" class="feed-grid"></div>
          </div>

        </div>

      </div> 
    </div>
  </div>

  <button id="artiFab" class="arti-fab" onclick="App.runAiActionPlan()" title="Ask Arti">
    <img src="images/arti.png" alt="Arti">
  </button>
  
  <div id="toastContainer" class="toast-container"></div>

  <div id="loader" class="loader">
    <div style="display:flex;flex-direction:column;align-items:center;gap:1rem;max-width:320px;text-align:center;">
      <div class="spinner"></div>
      <p id="loaderText" style="font-family: 'Google Sans Flex', sans-serif;color:var(--brand);font-size:var(--text-base);font-weight:700;letter-spacing:1px;text-transform:uppercase;margin:0;">Retrieving data...</p>
      <p id="loaderSubtext" style="color:var(--text-tertiary);font-size:var(--text-sm);margin:0;font-family: 'Google Sans Flex', sans-serif;"></p>
      <div style="width:200px;height:3px;background:rgba(255,255,255,0.05);border-radius:var(--radius-sm);overflow:hidden;position:relative;">
        <div style="position:absolute;top:0;left:-40%;width:40%;height:100%;background:var(--brand);border-radius:var(--radius-sm);animation:loaderSlide 1.2s ease-in-out infinite;"></div>
      </div>
    </div>
  </div>
<script>
// ============================================================
// GOVHOO APPLICATION — Module Index
//
//   Utils ........................ Formatting, query parsing, filters
//   VehicleDetector ............. GWAC/IDIQ/Vehicle pattern detection
//   Html ........................ HTML escaping utility
//   API ......................... USASpending.gov API client
//   ForecastEngine .............. Spending analysis & recompete detection
//   JobLinks .................... LinkedIn/USAJobs URL generators
//   App ......................... Core application state & rendering
//   Bubble/Treemap Charts ....... D3 visualization renderers
//   Presentation Mode ........... Light-theme screenshot toggle
// ============================================================

// ========================================
// SECTION 1: CONSTANTS & CONFIG
// ========================================
// ========================================
// SECTION 2: LIBRARY LOADER (Smart Preloading)
// ========================================
const LibLoader = {
  _p: null,
  loadD3() {
    if (window.d3 && window.d3.sankey) return Promise.resolve();
    if (this._p) return this._p;
    this._p = new Promise((resolve, reject) => {
      const s1 = document.createElement('script');
      s1.src = 'https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js';
      s1.onload = () => {
        const s2 = document.createElement('script');
        s2.src = 'https://cdnjs.cloudflare.com/ajax/libs/d3-sankey/0.12.3/d3-sankey.min.js';
        s2.onload = resolve;
        s2.onerror = reject;
        document.head.appendChild(s2);
      };
      s1.onerror = reject;
      document.head.appendChild(s1);
    });
    return this._p;
  },
  ensureAll() { return this.loadD3(); },
  preloadWhenIdle() {
    if ('requestIdleCallback' in window) requestIdleCallback(() => this.loadD3(), { timeout: 2000 });
    else setTimeout(() => this.loadD3(), 100);
  }
};

// ========================================
// SECTION 3: UTILITIES
// ========================================
const Utils = {
  // Animate deal cards with staggered entrance
  showMoreBtn(onclick, label) {
    return `<button onclick="${onclick}" class="show-more-btn">${label}</button>`;
  },
  animateCards(container) {
    if (!container) return;
    const cards = container.querySelectorAll('.deal-card');
    cards.forEach((card, i) => {
      card.classList.add('deal-card-animate');
      card.style.animationDelay = `${i * 60}ms`;
    });
  },

  // Sync drill state to URL without reloading
  syncUrlState() {
    const url = new URL(window.location);
    if (App.currentQuery) {
      url.searchParams.set('q', App.currentQuery);
    }
    if (App.drillState && App.drillState.level > 0 && App.drillState.path.length > 0) {
      const drillParts = App.drillState.path.map(p => p.name);
      url.searchParams.set('drill', drillParts.join('|||'));
    } else {
      url.searchParams.delete('drill');
    }
    if (App.activeVehicleFilter) {
      url.searchParams.set('vehicle', App.activeVehicleFilter);
    } else {
      url.searchParams.delete('vehicle');
    }
    history.replaceState(null, '', url.toString());
  },
formatDateISO: date => date.toISOString().split('T')[0],

  countUp: (element, targetValue, formatter = val => Math.round(val).toLocaleString()) => {
    if (!element) return;
    
    const numericTarget = Number(targetValue) || 0;

    // Accessibility check
    if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
      element.innerText = formatter(numericTarget);
      return;
    }

    const duration = 400; // Snappy 400ms animation
    const frameRate = 16; // ~60 FPS
    const totalFrames = Math.round(duration / frameRate);
    let frame = 0;

    const easeOutExpo = t => t === 1 ? 1 : 1 - Math.pow(2, -10 * t);

    clearInterval(element.countInterval);

    element.countInterval = setInterval(() => {
      frame++;
      const progress = easeOutExpo(frame / totalFrames);
      const currentValue = numericTarget * progress;
      
      element.innerText = formatter(currentValue);

      if (frame >= totalFrames) {
        clearInterval(element.countInterval);
        element.innerText = formatter(numericTarget); // Exact final value
      }
    }, frameRate);
  },
copyFields(pairs, btn) {
    copyAndFlash(pairs.filter(Boolean).join('\n'), btn);
  },
  copyDealToClipboard(idx, btn) {
    const c = App.searchData.active[idx];
    if (!c) return;
    const id = c['generated_internal_id'], url = id ? `https://www.usaspending.gov/award/${id}` : '';
    const v = VehicleDetector.detect(c['Award ID']), sa = VehicleDetector.getSetAsideLabel(c['Type of Set Aside']);
    const ct = Utils.getContractTypeTag(c['Contract Award Type']);
    this.copyFields([
      `Agency: ${c['Awarding Agency'] || 'N/A'}`,
      c['Awarding Sub Agency'] && c['Awarding Sub Agency'] !== c['Awarding Agency'] ? `Sub-Agency: ${c['Awarding Sub Agency']}` : null,
      `Vendor: ${c['Recipient Name'] || 'N/A'}`, `Obligated: ${Utils.money(c['Award Amount'])}`,
      `Description: ${(c['Description'] || 'N/A').substring(0, 200)}`,
      `Start: ${c['Start Date'] || 'N/A'}`, `End: ${c['End Date'] || 'N/A'}`,
      c['Award ID'] ? `Award ID: ${c['Award ID']}` : null,
      c['Last Modified Date'] ? `Last Modified: ${c['Last Modified Date']}` : null,
      ct ? `Type: ${ct.full}` : null, v ? `Vehicle: ${v.vehicle}` : null, sa ? `Set-Aside: ${sa}` : null,
      c['NAICS Code'] ? `NAICS: ${c['NAICS Code']} - ${c['NAICS Description'] || ''}` : null,
      c['PSC Code'] ? `PSC: ${c['PSC Code']} - ${c['PSC Description'] || ''}` : null,
      url ? `Link: ${url}` : null
    ], btn);
  },
  copySubDealToClipboard(dataStr, btn) {
    try {
      const s = JSON.parse(decodeURIComponent(dataStr));
      const url = s.prime_award_generated_internal_id ? `https://www.usaspending.gov/award/${s.prime_award_generated_internal_id}` : '';
      this.copyFields([
        `Type: Subcontract`, `Agency: ${s['Awarding Agency'] || 'N/A'}`,
        `Prime: ${s['Prime Recipient Name'] || 'N/A'}`, `Subcontractor: ${s['Sub-Awardee Name'] || 'N/A'}`,
        `Amount: ${Utils.money(parseFloat(s['Sub-Award Amount']) || 0)}`, `Date: ${s['Sub-Award Date'] || 'N/A'}`,
        url ? `Prime Award: ${url}` : null
      ], btn);
    } catch(e) { console.error('Copy failed', e); }
  },
  copyRecompeteToClipboard(btn, agency, subAgency, vendor, amount, desc, start, end, awardId, psc, pscDesc, naics, naicsDesc, setAside, url) {
    const v = VehicleDetector.detect(awardId), sa = VehicleDetector.getSetAsideLabel(setAside);
    this.copyFields([
      `EXPIRING CONTRACT`, `Agency: ${agency || 'N/A'}`,
      subAgency && subAgency !== agency ? `Sub-Agency: ${subAgency}` : null,
      `Incumbent: ${vendor || 'N/A'}`, `Amount: ${amount}`, `Description: ${desc || 'N/A'}`,
      `Start: ${start || 'N/A'}`, `Expires: ${end || 'N/A'}`,
      awardId ? `Award ID: ${awardId}` : null, v ? `Vehicle: ${v.vehicle}` : null, sa ? `Set-Aside: ${sa}` : null,
      naics ? `NAICS: ${naics} - ${naicsDesc || ''}` : null, psc ? `PSC: ${psc} - ${pscDesc || ''}` : null,
      url ? `Link: ${url}` : null
    ], btn);
  },
  money: n => {
    if (!n && n !== 0) return '-';
    if(n >= 1e9) return '$' + (n/1e9).toFixed(1) + 'B';
    if(n >= 1e6) return '$' + (n/1e6).toFixed(1) + 'M';
    if(n >= 1e3) return '$' + (n/1e3).toFixed(0) + 'K';
    return '$' + Math.round(n).toLocaleString();
  },
  trunc: (s, l) => (s && s.length > l) ? s.substring(0,l)+'...' : (s || 'No Description'),
  date: s => s ? new Date(s).toLocaleDateString() : '—',
  formatDateISO: date => date.toISOString().split('T')[0],
  getTrailing12Mo() {
    const end = new Date(), start = new Date();
    start.setFullYear(end.getFullYear() - 1);
    return [{ start_date: this.formatDateISO(start), end_date: this.formatDateISO(end) }];
  },
  
  getCurrentFY: () => {
    const now = new Date();
    // Federal FY starts Oct 1 (Month 9)
    return now.getMonth() >= 9 ? now.getFullYear() + 1 : now.getFullYear();
  },

  
getColor: (() => {
  const palette = [
    '#8A9B94', // 1. Chart: Muted Sage
    '#7B6D8D', // 2. Chart: Muted Purple
    '#5B7C99', // 3. Chart: Slate Blue
    '#E07A5F', // 4. Chart: Terracotta
    '#D98895', // 5. Chart: Dusty Rose
    '#3D405B', // 6. Chart: Dark Navy
    '#F2E8CF', // 7. Chart: Newsprint
    '#A8B5B0', // 8. Chart: Fog
    '#778DA9', // 9. Chart: Blue-Grey
    '#8C8577'  // 10. Army Surplus (Drab Olive)
  ];

  const assigned = new Map();
  let nextIdx = 0;

  const fn = name => {
    // Safety Check
    if (!name) return '#4A4A4A';

    // "Unknowns" get "Ink Stain" (Deep Charcoal)
    if (name.includes('Other') || name.includes('Unknown')) return '#353A40';
    
    if (!assigned.has(name)) assigned.set(name, nextIdx++);
    return palette[assigned.get(name) % palette.length];
  };

  fn.reset = () => { assigned.clear(); nextIdx = 0; };
  return fn;
})(),
// Agency aliases — these will use the structured agencies filter, not keyword search
agencyAliases: {
  'dod': 'Department of Defense', 'doj': 'Department of Justice', 'dhs': 'Department of Homeland Security',
  'hhs': 'Health and Human Services', 'dot': 'Department of Transportation', 'doe': 'Department of Energy',
  'doi': 'Department of the Interior', 'dol': 'Department of Labor', 'doc': 'Department of Commerce',
  'dos': 'Department of State', 'ed': 'Department of Education', 'hud': 'Housing and Urban Development',
  'usda': 'Department of Agriculture', 'va': 'Department of Veterans Affairs',
  'army': 'Department of the Army', 'navy': 'Department of the Navy', 'usaf': 'Department of the Air Force',
  'ussf': 'Space Force', 'usmc': 'Marine Corps',
  'gsa': 'General Services Administration', 'nasa': 'National Aeronautics and Space Administration',
  'epa': 'Environmental Protection Agency', 'ssa': 'Social Security Administration',
  'opm': 'Office of Personnel Management', 'sba': 'Small Business Administration',
  'nara': 'National Archives and Records Administration', 'usaid': 'Agency for International Development',
},

// Sub-agency aliases — these match at the sub-agency level
subAgencyAliases: {
  'cia': 'Central Intelligence Agency', 'nsa': 'National Security Agency',
  'nga': 'National Geospatial-Intelligence Agency', 'nro': 'National Reconnaissance Office',
  'dia': 'Defense Intelligence Agency', 'disa': 'Defense Information Systems Agency',
  'darpa': 'Defense Advanced Research Projects Agency', 'dcsa': 'Defense Counterintelligence and Security Agency',
  'dla': 'Defense Logistics Agency', 'mda': 'Missile Defense Agency',
  'fbi': 'Federal Bureau of Investigation', 'dea': 'Drug Enforcement Administration',
  'atf': 'Bureau of Alcohol Tobacco Firearms and Explosives',
  'irs': 'Internal Revenue Service', 'fda': 'Food and Drug Administration',
  'cdc': 'Centers for Disease Control and Prevention', 'nih': 'National Institutes of Health',
  'cms': 'Centers for Medicare and Medicaid Services',
  'fema': 'Federal Emergency Management Agency', 'tsa': 'Transportation Security Administration',
  'cbp': 'Customs and Border Protection', 'ice': 'Immigration and Customs Enforcement',
  'uscis': 'Citizenship and Immigration Services', 'usss': 'Secret Service',
  'cisa': 'Cybersecurity and Infrastructure Security Agency',
  'faa': 'Federal Aviation Administration', 'fhwa': 'Federal Highway Administration',
  'noaa': 'National Oceanic and Atmospheric Administration', 'nist': 'National Institute of Standards and Technology',
  'census': 'Census Bureau', 'blm': 'Bureau of Land Management', 'nps': 'National Park Service',
  'usfs': 'Forest Service', 'fws': 'Fish and Wildlife Service', 'usgs': 'Geological Survey',
  'nnsa': 'National Nuclear Security Administration',
  'socom': 'Special Operations Command', 'cybercom': 'Cyber Command',
  'stratcom': 'Strategic Command', 'transcom': 'Transportation Command',
  'centcom': 'Central Command', 'eucom': 'European Command',
  'indopacom': 'Indo-Pacific Command', 'northcom': 'Northern Command',
  'southcom': 'Southern Command', 'africom': 'Africa Command',
  'sec': 'Securities and Exchange Commission', 'ftc': 'Federal Trade Commission',
  'fcc': 'Federal Communications Commission',
},

// Non-agency aliases (companies, brands) — these stay as keyword expansion
queryAliases: {
  'aws': 'Amazon', 'gcp': 'Google Cloud', 'msft': 'Microsoft',
  'ibm': 'International Business Machines', 'hp': 'Hewlett Packard',
  'hpe': 'Hewlett Packard Enterprise', 'dell': 'Dell Technologies',
  'gd': 'General Dynamics', 'gdit': 'General Dynamics Information Technology',
  'lmco': 'Lockheed Martin', 'ngc': 'Northrop Grumman',
  'bah': 'Booz Allen Hamilton', 'saic': 'Science Applications International',
  'usps': 'Postal Service', 'amtrak': 'Amtrak',
},

// Check if a term is an agency alias and return filter info
resolveAgencyAlias(term) {
  const lower = term.toLowerCase().trim();
  if (this.agencyAliases[lower]) return { tier: 'toptier', name: this.agencyAliases[lower] };
  if (this.subAgencyAliases[lower]) return { tier: 'subtier', name: this.subAgencyAliases[lower] };
  return null;
},

normalizeQuery(query) {
  const lower = query.toLowerCase().trim();
  // Only expand non-agency aliases (companies/brands) as keyword replacement
  if (this.queryAliases[lower]) return this.queryAliases[lower];
  // Agency aliases: don't replace — buildFilters will handle them via the agencies filter
  if (this.agencyAliases[lower]) return this.agencyAliases[lower];
  if (this.subAgencyAliases[lower]) return this.subAgencyAliases[lower];
  return query;
},
  missionGapRisk(award) {
    const endDate = new Date(award['End Date']);
    const daysUntil = Math.ceil((endDate - new Date()) / (1000 * 60 * 60 * 24));

    const amt = parseFloat(award['Award Amount']) || 0;

    const desc = (award['Description'] || '').toLowerCase();
    const pscDesc = (award['PSC Description'] || '').toLowerCase();
    const naicsDesc = (award['NAICS Description'] || '').toLowerCase();
    const psc = (award['PSC Code'] || '').toUpperCase();

    // Ongoing support signals - tune this list over time
    const supportTerms = [
      'operations', 'o&m', 'maintenance', 'sustainment', 'help desk', 'service desk',
      'support services', 'managed services', 'hosting', 'cloud', 'network',
      'cyber', 'security', 'monitoring', 'soc', 'continuity', 'backup', 'dr', 'patch',
      'infrastructure', 'enterprise', 'mission', 'critical', '24/7', 'production'
    ];

    const text = `${desc} ${pscDesc} ${naicsDesc}`;
    const supportHits = supportTerms.filter(t => text.includes(t));
    const looksOperational = supportHits.length >= 2;

    // PSC shortcuts - common federal service families
    // D = IT/Data Processing, R = Professional Services, J = Maintenance/Repair
    const servicePscPrefixes = ['D', 'R', 'J'];
    const isServicePsc = servicePscPrefixes.includes(psc.slice(0, 1));

    // Risk logic
    if (daysUntil <= 180 && (looksOperational || isServicePsc) && amt >= 250000) {
      return { level: 'high', daysUntil, reasons: supportHits.slice(0, 4) };
    }
    if (daysUntil <= 365 && (looksOperational || isServicePsc) && amt >= 100000) {
      return { level: 'medium', daysUntil, reasons: supportHits.slice(0, 3) };
    }
    return { level: 'low', daysUntil, reasons: supportHits.slice(0, 2) };
  },
  
  // Normalize API response field names from elasticsearch_lookups.py keys to display names.
  // The spending_by_award endpoint returns data keyed by contracts_mapping field names.
  // Filter out completed/closeout contracts from API results.
  // The time_period filter matches any contract with an action_date in the window,
  // including $0 closeout mods on massive old contracts. This removes those ghosts.
  // Uses Last Modified Date (base_mapping: last_modified_date) as secondary recency signal.
  filterActiveContracts(awards) {
    const now = new Date();
    const grace = new Date();
    grace.setDate(grace.getDate() - 90);
    const recentMod = new Date();
    recentMod.setDate(recentMod.getDate() - 30);
    return awards.filter(a => {
      const endStr = a['End Date'];
      if (!endStr) return true;
      const end = new Date(endStr);
      if (isNaN(end.getTime())) return true;
      if (end > now) return true; // Still active
      // Ended recently — check if substantial or recently modified (extension/follow-on signal)
      if (end > grace) {
        if ((parseFloat(a['Award Amount']) || 0) > 10000) return true;
        // Recently modified past-end contract = likely extension in progress
        const modStr = a['Last Modified Date'];
        if (modStr) { const mod = new Date(modStr); if (!isNaN(mod.getTime()) && mod > recentMod) return true; }
        return false;
      }
      return false; // Ended 90+ days ago = closeout artifact
    });
  },

  // Contract type labels from lookups.py contract_type_mapping
  getContractTypeTag(typeDesc) {
    if (!typeDesc) return null;
    const t = typeDesc.toLowerCase();
    if (t.includes('definitive')) return { short: 'DEF', full: 'Definitive Contract' };
    if (t.includes('delivery')) return { short: 'DO', full: 'Delivery Order' };
    if (t.includes('purchase')) return { short: 'PO', full: 'Purchase Order' };
    if (t.includes('bpa call')) return { short: 'BPA', full: 'BPA Call' };
    if (t.includes('blanket')) return { short: 'BPA', full: 'Blanket Purchase Agreement' };
    if (t.includes('indefinite')) return { short: 'IDC', full: typeDesc };
    if (t.includes('gwac')) return { short: 'GWAC', full: typeDesc };
    return { short: typeDesc.substring(0, 4).toUpperCase(), full: typeDesc };
  },

  // Consolidated search term parser - eliminates duplication across API methods
  parseSearchTerms(keywords) {
    const pscPattern = /^[A-Z]{1,2}\d{1,3}$|^\d{1,2}[A-Z]\d{0,2}$/i;
    const naicsPattern = /^\d{6}$/; // NAICS codes are exactly 6 digits
    
    // AND operator: + or uppercase AND only (lowercase "and" stays in the phrase, e.g. "command and control")
    const hasAndOperator = keywords.includes('+') || /\bAND\b/.test(keywords);
    
    // Strip legal suffixes BEFORE comma-split so "FOUR POINTS TECHNOLOGY, LLC" doesn't become two terms
    const cleaned = keywords
      .replace(/,?\s*(L\.?L\.?C\.?|INC\.?|CORP\.?|CORPORATION|INCORPORATED|COMPANY|CO\.?|LTD\.?|L\.?P\.?|P\.?C\.?|P\.?L\.?L\.?C\.?)\.?(?=\s*,|\s*$|\s+AND\b|\s*\+)/gi, '')
      .replace(/,\s*$/, '')
      .trim();
    
    const terms = cleaned.split(',').map(s => s.trim()).filter(s => s.length > 0);
    const pscCodes = terms.filter(t => pscPattern.test(t)).map(t => t.toUpperCase());
    const naicsCodes = terms.filter(t => naicsPattern.test(t));
    const keywordTerms = terms.filter(t => !pscPattern.test(t) && !naicsPattern.test(t));
    
    // Parse AND groups: "Air Force + Cloud" or "Air Force AND Cloud"
    let andGroups = [];
    if (hasAndOperator) {
      keywordTerms.forEach(term => {
        const parts = term.split(/\+|\bAND\b/).map(s => s.trim()).filter(s => s.length > 0);
        if (parts.length > 1) {
          // Expand aliases on each part — check company, agency, and sub-agency aliases
          // buildFilters will route agency aliases to the agencies filter
          const expanded = parts.map(p => {
            const lower = p.toLowerCase().trim();
            return Utils.queryAliases[lower] || Utils.agencyAliases[lower] || Utils.subAgencyAliases[lower] || p;
          });
          andGroups.push(expanded);
        }
      });
    }
    
    return { pscCodes, naicsCodes, keywordTerms, allTerms: terms, andGroups };
  },
  
  // Build filters for API calls - consolidates filter building logic
  buildFilters(keywords, timePeriods) {
    const { pscCodes, naicsCodes, keywordTerms, andGroups } = this.parseSearchTerms(keywords);
    const filters = { time_period: timePeriods, award_type_codes: API.CONTRACT_TYPES };
    
    // If AND query with codes, build combined filter
    if (andGroups.length > 0) {
      const group = andGroups[0];
      const pscPat = /^[A-Z]{1,2}\d{1,3}$|^\d{1,2}[A-Z]\d{0,2}$/i;
      const naicsPat = /^\d{6}$/;
      const kws = [];
      group.forEach(term => {
        const agencyMatch = Utils.resolveAgencyAlias(term);
        if (naicsPat.test(term)) { filters._naics = filters._naics || []; filters._naics.push(term); }
        else if (pscPat.test(term)) { filters.psc_codes = filters.psc_codes || []; filters.psc_codes.push(term.toUpperCase()); }
        else if (agencyMatch) {
          filters.agencies = filters.agencies || [];
          filters.agencies.push({ type: 'awarding', tier: agencyMatch.tier, name: agencyMatch.name });
        }
        else kws.push(term);
      });
      if (kws.length > 0) filters.keywords = kws;
      if (filters._naics) { filters.naics_codes = { require: filters._naics }; delete filters._naics; }
      return filters;
    }
    
    // Check if any keyword terms are agency aliases
    const agencyFilters = [];
    const nonAgencyKeywords = [];
    keywordTerms.forEach(term => {
      const agencyMatch = Utils.resolveAgencyAlias(term);
      if (agencyMatch) {
        agencyFilters.push({ type: 'awarding', tier: agencyMatch.tier, name: agencyMatch.name });
      } else {
        nonAgencyKeywords.push(term);
      }
    });
    
    if (agencyFilters.length > 0) filters.agencies = agencyFilters;
    if (pscCodes.length > 0) filters.psc_codes = pscCodes;
    if (naicsCodes.length > 0) filters.naics_codes = { require: naicsCodes };
    if (nonAgencyKeywords.length > 0) filters.keywords = nonAgencyKeywords;
    if (!filters.psc_codes && !filters.naics_codes && !filters.keywords && !filters.agencies) filters.keywords = [keywords];
    return filters;
  }
};

// Shared helpers (global for onclick handler compat)
const SUB_FIELD_MAP = { agency: ['Awarding Agency','Unknown Agency'], subagency: ['Awarding Sub Agency','Unknown Sub Agency'], prime: ['Prime Recipient Name','Unknown Prime'], sub: ['Sub-Awardee Name','Unknown Sub'] };
function applySubDrillFilter(data, drill) {
  if (!drill || !drill.level || !drill.path || !drill.path.length) return data;
  let f = data;
  drill.path.forEach(step => { const [field, fb] = SUB_FIELD_MAP[step.type] || []; if (field) f = f.filter(s => (s[field] || fb) === step.name); });
  return f;
}
function copyAndFlash(text, btn) {
  navigator.clipboard.writeText(text).then(() => { if (!btn) return; btn.innerHTML = ''; btn.style.color = 'var(--accent)'; setTimeout(() => { btn.innerHTML = ''; btn.style.color = ''; }, 1500); });
}

// ==================== CHART UTILITIES ====================
const ChartUtils = {
  // Text fitting for D3 visualizations
  wrapText(name, maxW, fontSize) {
    const charW = fontSize * 0.58, maxChars = Math.floor(maxW / charW);
    if (maxChars < 3) return [];
    const words = name.split(/\s+/), lines = []; let cur = '';
    words.forEach(w => { const t = cur ? cur + ' ' + w : w; if (t.length <= maxChars) { cur = t; } else { if (cur) lines.push(cur); cur = w.length > maxChars ? w.slice(0, maxChars - 1) + '\u2026' : w; } });
    if (cur) lines.push(cur); return lines;
  },
  fitTreemapText(d) {
    const cW = d.x1 - d.x0, cH = d.y1 - d.y0, name = d.data.name;
    for (let fs = Math.min(cW / 5, cH / 3, 22); fs >= 7; fs -= 0.5) { const nl = ChartUtils.wrapText(name, cW - 12, fs), aFs = fs * 0.85, lH = fs * 1.25, tH = nl.length * lH + aFs * 1.3 + 8; if (tH < cH - 8 && nl.length > 0 && nl.length <= 4) return { nameLines: nl, fontSize: fs, amountFs: aFs, lineH: lH, totalH: tH }; }
    const fs = 7, charW = fs * 0.58, maxC = Math.floor((cW - 12) / charW);
    return { nameLines: [Utils.trunc(name, Math.max(maxC, 3))], fontSize: fs, amountFs: 6, lineH: fs * 1.25, totalH: fs * 2.5 + 8 };
  },
  fitCircleText(d) {
    const r = d.r, name = d.data.name;
    for (let fs = Math.min(r / 2.5, 20); fs >= 7; fs -= 0.5) { const nl = ChartUtils.wrapText(name, r * 1.6, fs), aFs = fs * 0.85, lH = fs * 1.2, tH = nl.length * lH + aFs * 1.3 + 4; if (tH < r * 1.6 && nl.length > 0 && nl.length <= 3) return { nameLines: nl, fontSize: fs, amountFs: aFs, lineH: lH, totalH: tH }; }
    return null;
  },
  // Shared bubble/treemap chart interactions (tooltip + touch + drill)
  attachInteractions(selection, svg, tooltip, container, w, h, isTouch, buildTip, doDrill, touchState) {
    if (isTouch) {
      selection.on('click', function(event, d) {
        event.stopPropagation();
        const e = d.data || d;
        if (touchState.touchStateGet() === e.name) {
          tooltip.classList.remove('visible'); touchState.touchStateSet(null); doDrill(e);
        } else {
          touchState.touchStateSet(e.name);
          tooltip.innerHTML = buildTip(e);
          tooltip.style.left = '50%'; tooltip.style.top = 'auto'; tooltip.style.bottom = '8px';
          tooltip.style.transform = 'translateX(-50%)'; tooltip.style.maxWidth = '90%';
          tooltip.classList.add('visible');
        }
      });
      svg.on('click', function() { tooltip.classList.remove('visible'); touchState.touchStateSet(null); });
    } else {
      selection
        .on('mouseover', function(event, d) { tooltip.innerHTML = buildTip(d.data || d); tooltip.classList.add('visible'); })
        .on('mousemove', function(event) {
          const cr = container.getBoundingClientRect();
          let tx = event.clientX - cr.left + 15, ty = event.clientY - cr.top - 10;
          if (tx + 260 > w) tx -= 280; if (ty + 90 > h) ty -= 100;
          tooltip.style.left = tx + 'px'; tooltip.style.top = ty + 'px';
          tooltip.style.bottom = 'auto'; tooltip.style.transform = 'none'; tooltip.style.maxWidth = '';
        })
        .on('mouseout', function() { tooltip.classList.remove('visible'); })
        .on('click', function(event, d) { tooltip.classList.remove('visible'); doDrill(d.data || d); });
    }
  },
  // Generic Sankey renderer — shared between prime and sub Sankeys
  drawSankey(svgEl, { nodes, links, gradientPrefix, isDrillable, isActive, onNodeClick, heightPerNode }) {
    const w = svgEl.node().parentElement ? svgEl.node().parentElement.offsetWidth - 2 : 800;
    const h = Math.max(heightPerNode > 25 ? 500 : 350, nodes.length * (heightPerNode || 28));

    svgEl.attr('viewBox', `0 0 ${w} ${h}`)
      .attr('preserveAspectRatio', 'xMidYMid meet')
      .style('width', '100%').style('height', 'auto').style('display', 'block');

    const nodeMap = new Map(nodes.map((n, i) => [n.name, i]));
    const d3Links = links.map(l => ({ source: nodeMap.get(l.source), target: nodeMap.get(l.target), value: l.value }));

    const sankey = d3.sankey().nodeId(d => d.index).nodeWidth(20).nodePadding(20).extent([[1, 1], [w - 1, h - 6]]);
    const { nodes: gn, links: gl } = sankey({
      nodes: nodes.map(d => Object.assign({}, d)),
      links: d3Links.map(d => Object.assign({}, d))
    });

    // Gradients
    Utils.getColor.reset();
    const defs = svgEl.append('defs');
    gl.forEach((l, i) => {
      const g = defs.append('linearGradient')
        .attr('id', `${gradientPrefix}-${i}`)
        .attr('gradientUnits', 'userSpaceOnUse')
        .attr('x1', l.source.x1).attr('x2', l.target.x0);
      g.append('stop').attr('offset', '0%').attr('stop-color', Utils.getColor(l.source.name));
      g.append('stop').attr('offset', '100%').attr('stop-color', Utils.getColor(l.target.name));
    });

    // Links
    svgEl.append('g').attr('fill', 'none').selectAll('path').data(gl).join('path')
      .attr('d', d3.sankeyLinkHorizontal())
      .attr('stroke', (d, i) => `url(#${gradientPrefix}-${i})`)
      .attr('stroke-width', d => Math.max(1, d.width))
      .attr('stroke-opacity', 0.4)
      .style('transition', 'stroke-opacity 0.2s')
      .on('mouseover', function() { d3.select(this).attr('stroke-opacity', 0.8); })
      .on('mouseout', function() { d3.select(this).attr('stroke-opacity', 0.4); })
      .append('title').text(d => `${d.source.name} \u2192 ${d.target.name}\n${Utils.money(d.value)}`);

    // Nodes
    const isTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
    svgEl.append('g').selectAll('rect').data(gn).join('rect')
      .attr('x', d => d.x0).attr('y', d => d.y0)
      .attr('height', d => Math.max(1, d.y1 - d.y0))
      .attr('width', d => d.x1 - d.x0)
      .attr('fill', d => Utils.getColor(d.name))
      .attr('opacity', d => isActive(d) ? 1 : 0.8)
      .attr('stroke', d => isActive(d) ? '#F1EEE9' : 'transparent')
      .attr('stroke-width', d => isActive(d) ? 0 : (isTouch ? 24 : 0))
      .style('cursor', d => isDrillable(d) ? 'pointer' : 'default')
      .on('click', function(e, d) { if (isDrillable(d)) onNodeClick(d, this); })
      .on('mouseover', function(e, d) { if (isDrillable(d)) d3.select(this).attr('opacity', 1); })
      .on('mouseout', function(e, d) { d3.select(this).attr('opacity', isActive(d) ? 1 : 0.8); })
      .append('title').text(d => {
        if (!isDrillable(d)) return `${d.name}\n${Utils.money(d.value)}`;
        const action = isActive(d) ? '\u2190 Click to drill out' : 'Click to drill down \u2192';
        return `${d.name}\n${Utils.money(d.value)}\n${action}`;
      });

    // Labels
    const isNarrow = w < 600;
    svgEl.append('g').selectAll('text').data(gn).join('text')
      .attr('x', d => d.x0 < w / 2 ? d.x1 + 6 : d.x0 - 6)
      .attr('y', d => (d.y1 + d.y0) / 2)
      .attr('dy', d => { if (d.y1 - d.y0 > 30) return d.x0 < w / 2 ? '-0.5em' : '1.1em'; return '0.35em'; })
      .attr('text-anchor', d => d.x0 < w / 2 ? 'start' : 'end')
      .text(d => Utils.trunc(d.name, isNarrow ? 25 : 40))
      .style('font-size', '11px')
      .style('font-weight', d => (d.y1 - d.y0 > 30) ? '700' : '400')
      .style('fill', App.presentationMode ? '#1A1A1A' : '#F1EEE9')
      .style('pointer-events', 'none');

    return { nodes: gn, links: gl, w, h };
  }
};
// Backward-compat: keep global names for bubble charts that call them directly
const attachChartInteractions = ChartUtils.attachInteractions.bind(ChartUtils);

// ==================== AUTOCOMPLETE ====================
const VehicleDetector = {
  // GWAC/IDIQ/Vehicle detection from Award ID (PIID) prefixes
  patterns: [
    { prefix: /^GS-35F/i, vehicle: 'GSA Schedule', short: 'GSA' },
    { prefix: /^GS-00F/i, vehicle: 'GSA Schedule', short: 'GSA' },
    { prefix: /^GS-07F/i, vehicle: 'GSA Schedule', short: 'GSA' },
    { prefix: /^GS-\d{2}F/i, vehicle: 'GSA Schedule', short: 'GSA' },
    { prefix: /^47Q[A-Z]{2}A/i, vehicle: 'OASIS+', short: 'OASIS+' },
    { prefix: /^47QTCA/i, vehicle: 'OASIS', short: 'OASIS' },
    { prefix: /^47QTCK/i, vehicle: 'OASIS SB', short: 'OASIS SB' },
    { prefix: /^GS-06F/i, vehicle: 'ALLIANT 2', short: 'ALLIANT' },
    { prefix: /^HC102[89]/i, vehicle: 'CIO-SP3', short: 'CIO-SP3' },
    { prefix: /^HC1013/i, vehicle: 'CIO-SP4', short: 'CIO-SP4' },
    { prefix: /^W15QKN/i, vehicle: 'Army ITES', short: 'ITES' },
    { prefix: /^W52P1J/i, vehicle: 'Army CHESS', short: 'CHESS' },
    { prefix: /^FA870[12]/i, vehicle: 'NETCENTS', short: 'NETCENTS' },
    { prefix: /^N0017[89]/i, vehicle: 'SeaPort', short: 'SEAPORT' },
    { prefix: /^N00189/i, vehicle: 'SeaPort-NxG', short: 'SEAPORT' },
    { prefix: /^47QFCA/i, vehicle: '8(a) STARS III', short: 'STARS III' },
    { prefix: /^47QFSA/i, vehicle: '8(a) STARS III', short: 'STARS III' },
    { prefix: /^HHSN/i, vehicle: 'NIH CIO-SP', short: 'NIH' },
    { prefix: /^75N98/i, vehicle: 'NIH NITAAC', short: 'NITAAC' },
    { prefix: /^VA118/i, vehicle: 'VA T4NG', short: 'T4NG' },
    { prefix: /^36C10X/i, vehicle: 'VA VETS 2', short: 'VETS 2' },
  ],
  
  detect(awardId) {
    if (!awardId) return null;
    for (const p of this.patterns) {
      if (p.prefix.test(awardId)) return p;
    }
    return null;
  },
  
  // Set-aside code to human-readable label
  setAsideLabels: {
    'SBA': '8(a)', '8A': '8(a)', '8AN': '8(a)',
    'HZC': 'HUBZone', 'HZS': 'HUBZone',
    'WOSB': 'WOSB', 'EDWOSB': 'EDWOSB',
    'SDVOSBC': 'SDVOSB', 'SDVOSBS': 'SDVOSB',
    'SBP': 'Small Biz', 'SMP': 'Small Biz',
    'VSA': 'VOSB', 'VSB': 'VOSB',
    'HS2': 'HUBZone SB', 'HS3': 'HUBZone/8(a)',
    'ISBEE': 'Econ. Disadv.', 'IEE': 'Econ. Disadv.',
  },
  
  getSetAsideLabel(code) {
    if (!code) return null;
    return this.setAsideLabels[code] || (code.length <= 10 ? code : null);
  }
};


const Html = {
  escapeHtml(str) {
    if (!str) return '';
    return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
  },
  parseAiMarkdown(rawText) {
    if (!rawText) return '';
    const processed = rawText.replace(/==([^=]+)==/g, '<mark>$1</mark>');
    if (window.marked && typeof window.marked.parse === 'function') {
      marked.setOptions({ breaks: true, gfm: true });
      return marked.parse(processed);
    }
    const safe = Html.escapeHtml(processed).replace(/&lt;mark&gt;/g, '<mark>').replace(/&lt;\/mark&gt;/g, '</mark>');
    return `<pre style="white-space: pre-wrap; font-family: 'Google Sans Flex', sans-serif; font-size: var(--text-sm); line-height: 1.5;">${safe}</pre>`;
  }
};

// ==================== API ====================
const API = {
  baseUrl: 'https://api.usaspending.gov/api/v2',

  // lookups.py contract_type_mapping: A=BPA Call, B=Purchase Order, C=Delivery Order, D=Definitive Contract
  CONTRACT_TYPES: ['A', 'B', 'C', 'D'],

  AWARD_FIELDS: [
    'Award ID', 'Recipient Name', 'Awarding Agency', 'Awarding Sub Agency',
    'Award Amount', 'Description', 'generated_internal_id', 'Start Date', 'End Date', 
    'NAICS Code', 'NAICS Description', 'PSC Code', 'PSC Description'
  ],
  
  // Search Mode API
  async searchAwards(keywords) {
    const timePeriod = Utils.getTrailing12Mo();
    const period = timePeriod[0];
    
    const { pscCodes, naicsCodes, keywordTerms, andGroups } = Utils.parseSearchTerms(keywords);
    
    // AND search: hybrid approach
    if (andGroups.length > 0) {
      const group = andGroups[0];
      const pscPat = /^[A-Z]{1,2}\d{1,3}$|^\d{1,2}[A-Z]\d{0,2}$/i;
      const naicsPat = /^\d{6}$/;
      const codes = [];
      const kws = [];
      const agencies = [];
      group.forEach(term => {
        const agencyMatch = Utils.resolveAgencyAlias(term);
        if (naicsPat.test(term)) codes.push({ type: 'naics', value: term });
        else if (pscPat.test(term)) codes.push({ type: 'psc', value: term.toUpperCase() });
        else if (agencyMatch) agencies.push({ type: 'awarding', tier: agencyMatch.tier, name: agencyMatch.name });
        else kws.push(term);
      });
      
      const filters = { time_period: [period], award_type_codes: this.CONTRACT_TYPES };
      codes.forEach(c => {
        if (c.type === 'naics') { filters.naics_codes = filters.naics_codes || { require: [] }; filters.naics_codes.require.push(c.value); }
        else { filters.psc_codes = filters.psc_codes || []; filters.psc_codes.push(c.value); }
      });
      if (agencies.length > 0) filters.agencies = agencies;
      if (kws.length > 0) filters.keywords = kws;
      
      if (codes.length > 0 || agencies.length > 0) {
        const res = await fetch(`${this.baseUrl}/search/spending_by_award/`, {
          method: 'POST', headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ filters, fields: this.AWARD_FIELDS, limit: 70, sort: 'Award Amount', order: 'desc' })
        });
        return (await res.json()).results || [];
      } else {
        // All keywords, no codes or agencies — send as keywords, client-side AND filter
        filters.keywords = kws;
        const res = await fetch(`${this.baseUrl}/search/spending_by_award/`, {
          method: 'POST', headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ filters, fields: this.AWARD_FIELDS, limit: 70, sort: 'Award Amount', order: 'desc' })
        });
        const pool = (await res.json()).results || [];
        const filtered = pool.filter(award => {
          const haystack = [
            award['Recipient Name'], award['Awarding Agency'], award['Awarding Sub Agency'],
            award['Description'], award['NAICS Description'], award['PSC Description'], award['Award ID']
          ].filter(Boolean).join(' ').toLowerCase();
          return kws.every(term => haystack.includes(term.toLowerCase()));
        });
        return filtered.sort((a,b) => b['Award Amount'] - a['Award Amount']);
      }
    }
    
    // OPTIMIZED: Single API call when possible, parallel only when mixing types
    const hasPsc = pscCodes.length > 0;
    const hasNaics = naicsCodes.length > 0;
    
    // Separate agency aliases from regular keywords
    const agencyFilters = [];
    const plainKeywords = [];
    keywordTerms.forEach(term => {
      const agencyMatch = Utils.resolveAgencyAlias(term);
      if (agencyMatch) {
        agencyFilters.push({ type: 'awarding', tier: agencyMatch.tier, name: agencyMatch.name });
      } else {
        plainKeywords.push(term);
      }
    });
    
    const hasKeywords = plainKeywords.length > 0;
    const hasAgencies = agencyFilters.length > 0;
    const typeCount = (hasPsc ? 1 : 0) + (hasNaics ? 1 : 0) + (hasKeywords ? 1 : 0) + (hasAgencies ? 1 : 0);
    
    // If all terms resolve to a single filter type, send ONE request
    if (typeCount === 1) {
      const filters = { time_period: [period], award_type_codes: this.CONTRACT_TYPES };
      if (hasPsc) filters.psc_codes = pscCodes;
      else if (hasNaics) filters.naics_codes = { require: naicsCodes };
      else if (hasAgencies) filters.agencies = agencyFilters;
      else filters.keywords = plainKeywords;
      
      const res = await fetch(`${this.baseUrl}/search/spending_by_award/`, {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ filters, fields: this.AWARD_FIELDS, limit: 70, sort: 'Award Amount', order: 'desc' })
      });
      return (await res.json()).results || [];
    }
    
    // Mixed types: build a single combined filter (agencies + keywords + codes work together)
    const filters = { time_period: [period], award_type_codes: this.CONTRACT_TYPES };
    if (hasPsc) filters.psc_codes = pscCodes;
    if (hasNaics) filters.naics_codes = { require: naicsCodes };
    if (hasKeywords) filters.keywords = plainKeywords;
    if (hasAgencies) filters.agencies = agencyFilters;
    
    const res = await fetch(`${this.baseUrl}/search/spending_by_award/`, {
      method: 'POST', headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ filters, fields: this.AWARD_FIELDS, limit: 70, sort: 'Award Amount', order: 'desc' })
    });
    return (await res.json()).results || [];
  },
  
  // Forecast Mode APIs

  // NAICS breakdown via spending_by_category/naics — the spending_by_award endpoint
  // returns null for NAICS fields, so we use this dedicated aggregation endpoint.
  async getNaicsBreakdown(keywords) {
    const timePeriod = Utils.getTrailing12Mo();
    const filters = Utils.buildFilters(keywords, timePeriod);
    filters.award_type_codes = this.CONTRACT_TYPES;
    const res = await fetch(`${this.baseUrl}/search/spending_by_category/naics`, {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ category: 'naics', filters, limit: 10 })
    });
    return (await res.json()).results || [];
  },

  // ==================== SUBAWARDS ====================
  async getSubawards(keywords) {
    const timePeriod = Utils.getTrailing12Mo();
    
    // Use buildFilters which handles AND, PSC, NAICS, and keywords
    const filters = Utils.buildFilters(keywords, timePeriod);
    
    const res = await fetch(`${this.baseUrl}/search/spending_by_award/`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        subawards: true,
        filters,
        fields: [
          'Sub-Award ID', 'Sub-Awardee Name', 'Sub-Award Amount', 
          'Prime Award ID', 'Prime Recipient Name', 'Sub-Award Date',
          'Awarding Agency', 'Awarding Sub Agency',
          'prime_award_generated_internal_id'
        ],
        limit: 70,
        sort: 'Sub-Award Amount',
        order: 'desc'
      })
    });
    return (await res.json()).results || [];
  }
};

// ==================== EXPIRING CONTRACTS DETECTION ====================
const ForecastEngine = {
  detectRecompetes(awards) {
    const now = new Date();
    const twoYears = new Date(); twoYears.setFullYear(now.getFullYear()+2);
    return awards
      .filter(a => {
        const end = new Date(a['End Date']);
        return end > now && end < twoYears && a['Award Amount'] > 50000;
      })
      .sort((a, b) => new Date(a['End Date']) - new Date(b['End Date']))
      .slice(0, 15);
  }
};
// ==================== JOB SEEKER UTILITIES ====================
const JobLinks = {
  // Known parent company names - if vendor starts with these, just use the parent name
  knownBrands: [
    'KBR', 'SAIC', 'CACI', 'LEIDOS', 'SERCO', 'AECOM', 'JACOBS', 'PARSONS', 
    'MAXIMUS', 'ICF', 'CGI', 'IBM', 'DELL', 'HP', 'CISCO', 'ORACLE', 'GOOGLE',
    'AMAZON WEB', 'MICROSOFT', 'ACCENTURE FEDERAL', 'DELOITTE', 'KPMG', 'PWC', 'EY',
    'PERATON', 'AMENTUM', 'MANTECH', 'BAE SYSTEMS', 'RAYTHEON', 'BOEING', 'AIRBUS',
    'HONEYWELL', 'HARRIS', 'TEXTRON', 'VERIZON', 'ATT', 'AT&T', 'SPRINT',
    'PALANTIR', 'ANDURIL', 'CROWDSTRIKE', 'SPLUNK', 'VMWARE', 'SALESFORCE',
    'SERVICENOW', 'SNOWFLAKE', 'DATABRICKS', 'ELASTIC', 'GITLAB', 'ATLASSIAN'
  ],
  
  // Multi-word brand names that need OR with abbreviation
  brandAliases: {
    'BOOZ ALLEN': 'BAH',
    'GENERAL DYNAMICS': 'GDIT',
    'NORTHROP GRUMMAN': 'NGC',
    'LOCKHEED MARTIN': 'LMCO',
    'L3HARRIS': 'L3 HARRIS',
    'L3 HARRIS': 'L3HARRIS',
    'WORLD WIDE TECHNOLOGY': 'WWT',
    'RED HAT': 'REDHAT',
    'PALO ALTO': 'PANW'
  },

  // Shared logic for cleaning vendor names
  cleanVendorName(vendorName) {
    let cleanName = vendorName
      .replace(/,?\s*(LLC|INC|CORP|CORPORATION|INCORPORATED|L\.L\.C\.|L\.P\.|LP|LTD|LIMITED|CO\.)\.?\s*$/gi, '')
      .replace(/\s+/g, ' ')
      .trim();
    
    const upperName = cleanName.toUpperCase();
    
    // Check if it starts with a known single-word brand
    for (const brand of this.knownBrands) {
      if (upperName === brand || upperName.startsWith(brand + ' ')) {
        return brand;
      }
    }
    
    // Check for known multi-word brand aliases
    for (const [brand, alias] of Object.entries(this.brandAliases)) {
      if (upperName.startsWith(brand)) {
        return brand;
      }
    }
    
    return cleanName;
  },

  // Generate LinkedIn job search URL
  getLinkedInUrl(vendorName) {
    const cleanName = this.cleanVendorName(vendorName);
    return `https://www.linkedin.com/jobs/search/?keywords=${encodeURIComponent(cleanName)}&f_C=`;
  },
  
  // Generate LinkedIn people search URL - finds contacts at a company
  getLinkedInPeopleUrl(vendorName, roleKeywords = '') {
    const cleanName = this.cleanVendorName(vendorName);
    let searchQuery = roleKeywords ? `"${cleanName}" ${roleKeywords}` : cleanName;
    return `https://www.linkedin.com/search/results/people/?keywords=${encodeURIComponent(searchQuery)}&origin=GLOBAL_SEARCH_HEADER`;
  },
  // Generate LinkedIn content/news search URL
getLinkedInNewsUrl(searchTerm) {
  const cleanName = typeof searchTerm === 'string' ? this.cleanVendorName(searchTerm) : searchTerm;
  return `https://www.linkedin.com/search/results/content/?keywords=${encodeURIComponent(cleanName)}`;
}
};

// ==================== APP CORE ====================
// ==================== SIGNAL ENGINE ====================
// Computes directional signals from ES search data. No enrichment calls.
// IMPORTANT: Data is top 100 by obligation. Signals describe where the MONEY is,
// not the full market. Framing reflects this honestly.

const App = {
  mode: 'search', // Always 'search' — retained for URL sharing compatibility
  currentQuery: '',
  originalQuery: '',
  searchData: { raw: [], active: [], filter: null, loaded: false },
  forecastData: { analysis: null, subawards: null, loaded: false },
  naicsData: null,
  drillState: { level: 0, path: [], currentAgency: null, currentSubAgency: null },
  subawardDrillState: { level: 0, path: [], filter: null, filterType: null },
  activeFeedSource: 'prime', // 'prime' or 'sub' - tracks which Sankey the user is interacting with
  onlyHighMissionGap: false,

// =======================================================================
  // ⚡ AI ACCOUNT INTELLIGENCE BRIEF (Data Analyst Persona)
  // =======================================================================
  AI_ENDPOINT: 'https://76unm1rlj0.execute-api.us-east-1.amazonaws.com/default/grumpy2', 
	aiState: { history: [], count: 0, max: 5 },
async runAiActionPlan() {
      const banner = document.getElementById('aiIntelligenceBanner');
      const panel = document.getElementById('aiActionPanel');
      const content = document.getElementById('aiContentContainer');
      const btn = document.getElementById('triggerAiPlanBtn');
      const copyBtn = document.getElementById('copyAiBtn');

      if (!App.searchData || !App.searchData.active || App.searchData.active.length === 0) {
          App.toast("Run a search first to load contract data.", "warning");
          return;
      }

      // 1. UI Setup: Hide banner, show panel, hide FAB, scroll down
      if (banner) banner.style.display = 'none';
      panel.style.display = 'block';
      document.getElementById('artiFab')?.classList.remove('visible');
      setTimeout(() => {
          panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }, 100);
      copyBtn.style.display = 'none';

      // 2. Button Loading State
      btn.innerHTML = '<i class="fas fa-spinner fa-spin" style="margin-right: 6px;"></i> ASKING ARTI...';
      btn.disabled = true;

      // 3. Set Initial Phased Loader HTML (Rich Progress Bar)
      content.innerHTML = `
          <div style="padding: 0.5rem 0 1.5rem 0;">
              <div style="display: flex; align-items: center; gap: 1rem;">
                  <img src="images/arti.png" class="ai-avatar small" style="animation: artiPulse 1.5s infinite ease-in-out;" alt="Arti">
                  <div>
                      <div id="aiLoaderText" style="font-family: 'Google Sans Flex', sans-serif; font-size: var(--text-base); color: var(--brand); font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">
                          INITIALIZING...
                      </div>
                      <div id="aiLoaderSubtext" style="font-size: var(--text-sm); color: var(--text-secondary); margin-top: 4px;">
                          Connecting to Govhoo AI engine
                      </div>
                  </div>
              </div>
              
              <div class="govhoo-progress-bar">
                  <div id="aiProgressFill" class="govhoo-progress-fill"></div>
                  <div class="govhoo-progress-glow"></div>
              </div>
              
              <div style="display: flex; justify-content: flex-end; margin-top: 0.5rem;">
                  <span id="aiLoaderTimer" style="font-size: var(--text-xs); color: var(--text-secondary); font-family: 'Google Sans Flex', sans-serif;">0.0s</span>
              </div>
          </div>`;

      // 4. Start Phased Animation Timer
      const briefStartTime = Date.now();
      const briefProgressTimer = setInterval(() => {
          const titleEl = document.getElementById('aiLoaderText');
          const subEl = document.getElementById('aiLoaderSubtext');
          const fillEl = document.getElementById('aiProgressFill');
          const timerEl = document.getElementById('aiLoaderTimer');
          
          if (!titleEl) { clearInterval(briefProgressTimer); return; }
          
          const elapsedSecs = (Date.now() - briefStartTime) / 1000;
          timerEl.textContent = elapsedSecs.toFixed(1) + 's';

          // Asymptotic progress calculation (Slows down as it gets closer to 100% so it never "stalls" completely)
          const progress = Math.min(96, 100 * (1 - Math.exp(-elapsedSecs / 4)));
          fillEl.style.width = `${progress}%`;

          // Phased Text Logic
          if (elapsedSecs < 2) {
              titleEl.textContent = 'SCANNING DATASET';
              subEl.textContent = `Processing ${App.searchData.active.length} active contracts`;
          } else if (elapsedSecs < 5) {
              titleEl.textContent = 'ANALYZING PATTERNS';
              subEl.textContent = 'Identifying agency trends and vendor reach';
          } else if (elapsedSecs < 8) {
              titleEl.textContent = 'EVALUATING COMPETITION';
              subEl.textContent = 'Cross-referencing prime and sub relationships';
          } else {
              titleEl.textContent = 'COMPOSING BRIEF';
              subEl.textContent = 'Applying federal sales heuristics';
          }
      }, 100); // 100ms interval for ultra-smooth progress bar and timer updates

      const summaryPayload = App.searchData.active;

      try {
          // 5. Fetch from Lambda
          const res = await fetch(App.AI_ENDPOINT, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                  request_type: 'govhoo_action_plan',
                  market_data: summaryPayload,
                  objective: 'Account Intelligence'
              })
          });

          if (!res.ok) throw new Error(`Gateway Error: ${res.status}`);

          const data = await res.json();
          if (data.error) throw new Error(data.error);

          const strategicTextRaw = data.strategic_read;
          if (!strategicTextRaw) throw new Error("Invalid AI response format.");
          
          const strategicText = strategicTextRaw.replace(/==([^=]+)==/g, '<mark>$1</mark>');

          // >>> SUCCESS: STOP THE TIMER <<<
          clearInterval(briefProgressTimer);

          const renderedHtml = Html.parseAiMarkdown(strategicTextRaw);
          
          // 6. Inject the response
          content.innerHTML = `<div class="ai-result-section strategic-read">${renderedHtml}</div>`;
          content.dataset.rawPlan = strategicText;
          copyBtn.style.display = 'inline-block';

          // 7. Setup Chat Interface
          document.getElementById('aiChatInputWrapper').style.display = 'flex';
          document.getElementById('aiChatCounter').style.display = 'block';
          document.getElementById('aiChatCounter').innerText = `${App.aiState.max} questions remaining for this view.`;
          document.getElementById('aiDisclaimer').style.display = 'block';

          document.getElementById('aiChatInput').onkeydown = function(e) {
              if (e.key === 'Enter') {
                  e.preventDefault(); 
                  App.sendAiChatMessage();
              }
          };

          App.aiState.history = [
              { role: 'user', content: `Give me a strategic read on the "${App.currentQuery}" market.` },
              { role: 'model', content: strategicText }
          ];
          
      } catch (e) {
          console.error("AI Error:", e);

          // >>> ERROR: STOP THE TIMER <<<
          clearInterval(briefProgressTimer);
          
          const safeMessage = (e.message || "Unknown error").replace(/[&<>"']/g, m => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;' }[m]));

          content.innerHTML = `
              <div style="color: var(--danger); font-size: var(--text-base); padding: 1rem 0;">
                  Briefing failed: ${safeMessage}
              </div>
          `;

      } finally {
          // 8. Always reset the button state
          btn.innerHTML = 'ASK ARTI';
          btn.disabled = false;
      }
  },
async sendAiChatMessage() {
      if (App.aiState.count >= App.aiState.max) return;
      const inputEl = document.getElementById('aiChatInput');
      const sendBtn = document.getElementById('aiChatSendBtn');
      const msg = inputEl.value.trim();
      if (!msg) return;

      const historyEl = document.getElementById('aiChatHistory');
      historyEl.style.display = 'flex';

      // 1. Append user message
      const safeMsg = msg.replace(/[&<>"']/g, m => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;' }[m]));
      historyEl.insertAdjacentHTML('beforeend', `<div class="ai-msg-user">${safeMsg}</div>`);
      
      // Lock UI
      inputEl.value = '';
      inputEl.disabled = true;
      sendBtn.disabled = true;

      // 2. Show loading bubble for Arti (with animated progress)
      const loaderId = 'arti-load-' + Date.now();
      historyEl.insertAdjacentHTML('beforeend', `
          <div class="ai-msg-arti arti-thinking" id="${loaderId}">
              <img src="images/arti.png" class="ai-avatar small">
              <div id="${loaderId}-text" style="padding-top: 8px; color: var(--text-secondary); font-size: var(--text-sm); font-style: italic;">
                  Reviewing the data
              </div>
          </div>
      `);
      
      // Animated progress dots + elapsed timer
      const startTime = Date.now();
      const progressTimer = setInterval(() => {
        const textEl = document.getElementById(`${loaderId}-text`);
        if (!textEl) { clearInterval(progressTimer); return; }
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        const dots = '.'.repeat((elapsed % 3) + 1);
        const phases = ['Reviewing the data', 'Analyzing patterns', 'Composing response'];
        const phase = phases[Math.min(Math.floor(elapsed / 5), phases.length - 1)];
        textEl.textContent = `${phase}${dots} (${elapsed}s)`;
      }, 500);
      
      // Scroll to the loading bubble, pinning the avatar exactly where it belongs
      const loaderEl = document.getElementById(loaderId);
      loaderEl.scrollIntoView({ behavior: 'smooth', block: 'start' });

      // 3. Push to history state
      App.aiState.history.push({ role: 'user', content: msg });

      try {
          const res = await fetch(App.AI_ENDPOINT, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                  request_type: 'govhoo_chat', 
                  market_data: App.searchData.active, 
                  history: App.aiState.history
              })
          });

          if (!res.ok) throw new Error(`Gateway Error: ${res.status}`);
          const data = await res.json();
          if (data.error) throw new Error(data.error);

          // NEW: Intercept and convert ==highlight== to <mark> tags for chat messages
          const renderedHtml = Html.parseAiMarkdown(data.response);

          // 5. Replace loader with actual response and clean up animation
          clearInterval(progressTimer);
          loaderEl.classList.remove('arti-thinking');
          loaderEl.innerHTML = `
              <img src="images/arti.png" class="ai-avatar small">
              <div class="strategic-read">${renderedHtml}</div>
          `;

          setTimeout(() => {
              loaderEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }, 200);

          // 6. Update State
          App.aiState.history.push({ role: 'model', content: data.response });
          App.aiState.count++;

          const remaining = App.aiState.max - App.aiState.count;
          const counterEl = document.getElementById('aiChatCounter');
          
          if (remaining > 1) {
              // Standard state
              counterEl.innerText = `${remaining} questions remaining for this view.`;
              counterEl.style.color = 'var(--money-strong)';
              inputEl.disabled = false;
              sendBtn.disabled = false;
              if (window.innerWidth > 768) setTimeout(() => inputEl.focus(), 100);
          } else if (remaining === 1) {
              // Warning state: 1 left
              counterEl.innerText = "Make it count. I've got time for one more question on this dataset.";
              counterEl.style.color = 'var(--money-strong)'; 
              inputEl.disabled = false;
              sendBtn.disabled = false;
              if (window.innerWidth > 768) setTimeout(() => inputEl.focus(), 100);
          } else {
              // Final state: 0 left
              counterEl.innerText = "That's all for this dataset. Run a new search or drill into an agency to reset my limits.";
              counterEl.style.color = 'var(--money-strong)';
              inputEl.placeholder = "Limits reached for this view.";
          }

      } catch (e) {
          console.error("Chat Error:", e);
          clearInterval(progressTimer);
          loaderEl.classList.remove('arti-thinking');
          loaderEl.innerHTML = `<div style="color: var(--danger); font-size: var(--text-base); padding-top: 8px;">Error fetching response. Try again.</div>`;
          inputEl.value = msg; 
          inputEl.disabled = false;
          sendBtn.disabled = false;
          App.aiState.history.pop(); 
      }
  },
  // --- NEW CHAT FUNCTION END ---
copyAiPlan() {
  const container = document.getElementById('aiContentContainer');
  if (!container) return;

  const text = container.dataset.rawPlan;
  if (!text) return;

  navigator.clipboard.writeText(text)
    .then(() => {
      const btn = document.getElementById('copyAiBtn');
      const original = btn.innerHTML;

      // Add the success colors!
      btn.innerHTML = 'COPIED';
      btn.style.color = 'var(--success)';
      btn.style.borderColor = 'var(--success)';
      
      setTimeout(() => {
        btn.innerHTML = original;
        btn.style.color = '';
        btn.style.borderColor = '';
      }, 1500);
    })
    .catch(err => {
      console.error('Clipboard failed:', err);
      App.toast('Copy failed — try again.', 'error');
    });
},
resetAiPanel() {
    const banner = document.getElementById('aiIntelligenceBanner');
    const panel = document.getElementById('aiActionPanel');
    const content = document.getElementById('aiContentContainer');
    const btn = document.getElementById('triggerAiPlanBtn');
    const copyBtn = document.getElementById('copyAiBtn');
App.aiState = { history: [], count: 0, max: 5 };
    const historyEl = document.getElementById('aiChatHistory');
    if (historyEl) { historyEl.innerHTML = ''; historyEl.style.display = 'none'; }
    const inputWrap = document.getElementById('aiChatInputWrapper');
    if (inputWrap) inputWrap.style.display = 'none';
    const counterEl = document.getElementById('aiChatCounter');
    if (counterEl) counterEl.style.display = 'none';
	const disclaimerEl = document.getElementById('aiDisclaimer');
	if (disclaimerEl) disclaimerEl.style.display = 'none';
    // Reset visibility
	// Reset FAB visibility
    document.getElementById('artiFab')?.classList.remove('visible');
    if (banner) banner.style.display = 'flex';
    if (panel) panel.style.display = 'none';
    if (copyBtn) copyBtn.style.display = 'none';

    // Clear content and state
    if (content) {
        content.innerHTML = '';
        delete content.dataset.rawPlan;
    }

    // Reset button text
    if (btn) {
        btn.innerHTML = 'ASK ARTI';
        btn.disabled = false;
    }
  },
  setupInputListeners() {
    document.getElementById('mainSearchInput').addEventListener('keypress', e => { if (e.key === 'Enter') App.runSearch(); });
    document.getElementById('miniSearch').addEventListener('keypress', e => { if (e.key === 'Enter') { document.getElementById('mainSearchInput').value = e.target.value; App.runSearch(e.target.value); } });
    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
    if (!isMobile) {
      document.getElementById('mainSearchInput').addEventListener('focus', function() { this.select(); });
      document.getElementById('miniSearch').addEventListener('focus', function() { this.select(); });
    }
    document.addEventListener('keydown', (e) => {
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) return;
      if (e.metaKey || e.ctrlKey || e.altKey) return;
      if (e.key === '/') {
        e.preventDefault();
        const mini = document.getElementById('miniSearch');
        const main = document.getElementById('mainSearchInput');
        if (mini && mini.offsetParent !== null) { mini.focus(); mini.select(); }
        else if (main) { main.focus(); main.select(); }
      }
      if (e.key === 'Escape' && document.activeElement && (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA')) {
        document.activeElement.blur();
      }
    });
    const input = document.getElementById('mainSearchInput');
    const btn = document.querySelector('.input-clear');
    if (input && btn) {
      const wrapper = input.parentElement;
      if (wrapper && btn.parentNode !== wrapper) { wrapper.style.position = 'relative'; wrapper.appendChild(btn); }
      const toggle = () => btn.classList.toggle('visible', input.value.length > 0);
      input.addEventListener('input', toggle);
      input.addEventListener('change', toggle);
      toggle();
    }
    // Responsive placeholder
    const mini = document.getElementById('miniSearch');
    if (mini) {
      const setPlaceholder = () => { mini.placeholder = window.innerWidth <= 600 ? 'Search...' : 'Search keywords, companies, NAICS, agencies...'; };
      setPlaceholder();
      window.addEventListener('resize', setPlaceholder);
    }
  },
  init() {

    
    // Setup Event Delegation for all data-action handlers
    this.setupEventDelegation();
    
    this.setupInputListeners();

    let resizeTimer;
    let lastWidth = window.innerWidth;
    window.addEventListener('resize', () => { 
      clearTimeout(resizeTimer);
      // Mobile browsers fire resize when address bar hides/shows on scroll.
      // Only re-render if the width actually changed (true resize or rotation).
      if (window.innerWidth === lastWidth) return;
      lastWidth = window.innerWidth;
      resizeTimer = setTimeout(() => { 
        if(App.mode === 'search' && App.searchData?.active?.length > 0) {
          App.renderSankey(); 
          App.renderBubbleChart();
        }
        const subawardWrapper = document.getElementById('subawardWrapper');
        if(App.forecastData?.subawards && subawardWrapper && subawardWrapper.style.display !== 'none') {
          App.renderSubawardSankey(App.forecastData.subawards);
        }
      }, 500); 
    });

    // Preload visualization libraries during idle time
    LibLoader.preloadWhenIdle();

    const params = new URLSearchParams(window.location.search);
    const q = params.get('q');
    const drillParam = params.get('drill');

    if (q) {
      document.getElementById('mainSearchInput').value = q;
      
      App.runSearch(q).then(() => {
        if (drillParam && App.searchData.raw.length > 0) {
          setTimeout(() => {
            const drillParts = drillParam.split('|||');
            drillParts.forEach(name => {
              App.drillDown(name);
            });
          }, 100);
        }
      });
    }
  }, 
  
  // Event Delegation - handles all data-action clicks
  setupEventDelegation() {
    document.addEventListener('click', (e) => {
      const target = e.target.closest('[data-action]');
      if (!target) return;
      
      const action = target.dataset.action;
      const actions = {
        'search': () => this.runSearch(),
        'showHero': () => this.showHero(),
        'resetDrill': () => this.resetDrill(),
        'clearFilter': () => this.resetDrill(),
        'shareLink': () => this.shareLink(target),
        'shareBrief': () => this.shareBrief(target),
        'exportCSV': () => this.exportCSV(target),
        'resetSubawardDrill': () => this.resetSubawardDrill(),
      };
      
      if (actions[action]) {
        e.preventDefault();
        actions[action]();
      }
    });
  },

  showHero() {
    document.getElementById('appView').style.display = 'none';
    const hero = document.getElementById('heroView'); hero.style.display = 'flex'; hero.classList.remove('hidden');
    setTimeout(() => hero.classList.remove('slide-up'), 10);
  },

  setMode() {
    document.getElementById('searchModeView')?.classList.add('active');
  },


  // --- Search Mode ---
  _searchId: 0, // Guard against concurrent searches

  async runSearch(val) {
    let query = val || document.getElementById('mainSearchInput').value; if(!query) return;
    const rawQuery = query.toUpperCase();
    
	query = Utils.normalizeQuery(rawQuery);
  document.getElementById('mainSearchInput').value = query;
  document.getElementById('miniSearch').value = query;
  document.title = `Govhoo | ${query.toUpperCase()}`;
    if(query !== App.currentQuery) { App.searchData = { raw: [], active: [], filter: null, loaded: false }; App.forecastData = { loaded: false }; App.naicsData = null; App.resetDrill(); App.subawardDrillState = { level: 0, path: [], filter: null, filterType: null }; }
    App.currentQuery = query;
    App.originalQuery = rawQuery;

    const thisSearch = ++App._searchId;
    const loadingMessages = [
      "Bypassing SAM.gov search...",
      "Making some coffee...",
      "Finding out who does the work...",
      "Following the money...",
      "Skipping industry day...",
      "Waiting for the KO to reply...",
      "Deciphering a 500-page RFP...",
      "Pretending to understand the FAR...",
      "Bypassing the gatekeepers..."
    ];
    const randomMsg = loadingMessages[Math.floor(Math.random() * loadingMessages.length)];
    
    App.showLoader('SCANNING ' + query.toUpperCase(), randomMsg);

    try {
      const [, searchResults] = await Promise.all([
        LibLoader.loadD3(),
        API.searchAwards(query)
      ]);

      if (thisSearch !== App._searchId) return;

      App.searchData.raw = Utils.filterActiveContracts(searchResults); App.searchData.active = App.searchData.raw; App.searchData.loaded = true;
      App.transitionToApp(); App.setMode('search'); App.updateSearchDashboard(); Utils.syncUrlState(); requestAnimationFrame(() => { App.renderVehiclePills(); App.renderPrimeReach(); });
      this.loadBackgroundData(query);
    } catch(e) { 
      if (thisSearch !== App._searchId) return;
      console.error(e);
      App.toast('Error retrieving data. Check your connection and try again.', 'error', 5000);
    } finally { App.hideLoader(); }
  },

  async loadBackgroundData(query) {
    // Expiring contracts — computed from existing search data, no API call
    this.loadForecastInBackground(query);

    // Background API calls: NAICS breakdown + subs
    try { this.loadNaicsBreakdown(query); } catch(e) { console.warn('NAICS load failed:', e); }
    try {
      setTimeout(() => this.loadSubcontractingData(query), 0);
    } catch(e) { console.warn('Background data failure:', e); }
  },

  async loadNaicsBreakdown(query) {
    try {
      const results = await API.getNaicsBreakdown(query);
      App.naicsData = results;
      App.renderNaicsMix();
    } catch(e) { console.warn('[NAICS] API call failed:', e); }
  },

  // Background forecast loading — populates recompetes from existing search data
  // OPTIMIZATION: Reuses searchData.raw from searchAwards() instead of making a duplicate API call.
  async loadForecastInBackground(query) {
    // Expiring contracts detection — uses searchData.raw directly, no extra API calls needed
    if (!query) return;
    const awards = App.searchData.raw || [];
    const recompetes = ForecastEngine.detectRecompetes(awards);
    App.forecastData = {
      analysis: { recompetes },
      subawards: App.forecastData?.subawards || null,
      loaded: true
    };
    App.renderStrategyTools();
  },

  // Render strategy tools, spending chart, expiring stat, and recompetes into search view
  renderStrategyTools() {
    // Forecast-dependent items: GTM, Pipeline, Recompetes
    const analysis = App.forecastData && App.forecastData.analysis;
    if (!analysis) return;

    // Show GTM Plan + Pipeline Builder buttons in action bar

    // Determine drill-filtered recompetes
    const allRecompetes = analysis.recompetes || [];
    const drill = App.drillState || {};
    let filteredRecompetes = allRecompetes;
    if (drill.level >= 1 && drill.currentAgency) {
      filteredRecompetes = allRecompetes.filter(r => r['Awarding Agency'] === drill.currentAgency);
      if (drill.level >= 2 && drill.currentSubAgency) {
        filteredRecompetes = filteredRecompetes.filter(r => r['Awarding Sub Agency'] === drill.currentSubAgency);
      }
    }

    // Render recompetes (filtered)
    this.renderRecompetes(filteredRecompetes);
  },

  // Re-fetch or re-use spending data based on drill state
  updateSearchDashboard() {
	App.resetAiPanel();
    const data = App.searchData.active;
    const totalObligations = data.reduce((acc, c) => acc + (c['Award Amount']||0), 0);
    Utils.countUp(document.getElementById('stat-vol'), totalObligations, Utils.money);
    document.getElementById('stat-count').innerText = data.length;
    document.getElementById('stat-vendors').innerText = new Set(data.map(c => c['Recipient Name'])).size;
    document.getElementById('stat-agencies').innerText = new Set(data.map(c => c['Awarding Agency'])).size;
	// Delay FAB until user scrolls a bit — avoids competing with initial data load
	const fab = document.getElementById('artiFab');
	if (fab) {
	  fab.classList.remove('visible');
	  if (!App._fabScrollHandler) {
	    App._fabScrollHandler = () => {
	      if (window.scrollY > 200) {
	        fab.classList.add('visible');
	        window.removeEventListener('scroll', App._fabScrollHandler);
	        App._fabScrollHandler = null;
	      }
	    };
	    window.addEventListener('scroll', App._fabScrollHandler, { passive: true });
	    // Fallback: show after 4s even without scroll
	    setTimeout(() => {
	      if (!fab.classList.contains('visible')) {
	        fab.classList.add('visible');
	        if (App._fabScrollHandler) {
	          window.removeEventListener('scroll', App._fabScrollHandler);
	          App._fabScrollHandler = null;
	        }
	      }
	    }, 4000);
	  }
	}

    // #5 Mod recency — market health signal
    const healthEl = document.getElementById('marketHealth');
    if (healthEl) {
      const now = new Date();
      const d90 = new Date(); d90.setDate(d90.getDate() - 90);
      let recent = 0;
      data.forEach(c => {
        const mod = c['Last Modified Date'] ? new Date(c['Last Modified Date']) : null;
        if (mod && !isNaN(mod.getTime()) && mod > d90) recent++;
      });
      if (recent > 0) {
        const pct = Math.round(recent / data.length * 100);
        const signal = pct > 70 ? 'Active — programs are funded and moving' 
          : pct > 40 ? 'Moderate — some programs active, some dormant' 
          : 'Low activity — most contracts idle';
        healthEl.innerHTML = `<strong style="color:${pct > 70 ? 'var(--accent)' : pct > 40 ? 'var(--warning, #FDD835)' : 'var(--text-secondary)'};">${pct}%</strong> of contracts modified in last 90 days · ${signal}`;
      } else {
        healthEl.innerHTML = '';
      }
    }

    App.renderFeed(); App.updateDrillUI();

    // Compute and render directional signals
    
    // Update Job Seeker Panels (dynamically based on active/filtered data)
	App.renderSearchTopBuyers(data);
    
    
    // OPTIMIZED: Defer heavy chart rendering to after initial paint
    requestAnimationFrame(() => {
      App.renderSankey();
      App.renderBubbleChart();
      App.renderStrategyTools();
    });
    
    // Enable Conversation Starters button
    // Generate data-driven editorial headlines
    App.generateEditorialHeadlines(data, totalObligations);
    
    // Show data explainer boxes (collapsed by default)
    const primeExpl = document.getElementById('primeExplainerBox');
    if (primeExpl) primeExpl.style.display = 'block';
    const subExpl = document.getElementById('subExplainerBox');
    if (subExpl) subExpl.style.display = 'block';
    
    // Show AND note in sub explainer if AND query is active
    const subAndNote = document.getElementById('subAndNote');
    if (subAndNote) {
      const { andGroups } = Utils.parseSearchTerms(App.currentQuery || '');
      subAndNote.style.display = andGroups.length > 0 ? 'inline' : 'none';
    }
    
    // Add loaded animation to sankey
    const sankeyEl = document.getElementById('sankeyPanel');
    if (sankeyEl) sankeyEl.classList.add('sankey-loaded');
    
  },

  // ==================== EDITORIAL HEADLINE GENERATOR ====================
  // Computes data-driven insights and writes them as editorial subtitles.
  // Goal: user reads the headline and knows what matters without interacting.
  generateEditorialHeadlines(data, totalObligations) {
    if (!data || data.length === 0) return;
    const query = App.currentQuery ? App.currentQuery.toUpperCase() : '';

    // --- SANKEY HEADLINE: Agency concentration ---
    const sankeyEl = document.getElementById('sankeySubtitle');
    if (sankeyEl) {
      const agencySpend = {};
      data.forEach(c => {
        const a = c['Awarding Agency'] || 'Unknown';
        agencySpend[a] = (agencySpend[a] || 0) + (c['Award Amount'] || 0);
      });
      const sorted = Object.entries(agencySpend).sort((a, b) => b[1] - a[1]);
      const totalAgencies = sorted.length;

      if (totalAgencies > 0 && totalObligations > 0) {
        // Find how many agencies account for ~70%+ of spend
        let cumulative = 0;
        let topCount = 0;
        for (const [, spend] of sorted) {
          cumulative += spend;
          topCount++;
          if (cumulative / totalObligations >= 0.7) break;
        }
        const topPct = Math.round((cumulative / totalObligations) * 100);
        const topName = sorted[0][0];
        const topNamePct = Math.round((sorted[0][1] / totalObligations) * 100);

        let headline = '';
        if (topCount === 1 && topNamePct >= 60) {
          headline = Utils.trunc(topName, 40) + ' accounts for ' + topNamePct + '% of ' + query + ' spending';
        } else if (topCount <= 3 && totalAgencies > 3) {
          headline = topCount + ' of ' + totalAgencies + ' agencies control ' + topPct + '% of ' + query + ' obligations';
        } else if (totalAgencies <= 3) {
          headline = query + ' spending is concentrated across ' + totalAgencies + ' agenc' + (totalAgencies === 1 ? 'y' : 'ies');
        } else {
          headline = query + ' spend is distributed across ' + totalAgencies + ' agencies — top ' + topCount + ' hold ' + topPct + '%';
        }
        sankeyEl.textContent = headline;
      } else {
        sankeyEl.textContent = query + ' · Active obligated value';
      }
    }

    // --- BUBBLE HEADLINE: Vendor concentration ---
    const bubbleEl = document.getElementById('bubbleChartSubtitle');
    if (bubbleEl) {
      const vendorSpend = {};
      data.forEach(c => {
        const v = c['Recipient Name'] || 'Unknown';
        vendorSpend[v] = (vendorSpend[v] || 0) + (c['Award Amount'] || 0);
      });
      const vSorted = Object.entries(vendorSpend).sort((a, b) => b[1] - a[1]);
      const totalVendors = vSorted.length;

      if (totalVendors > 0 && totalObligations > 0) {
        const topVendor = vSorted[0][0];
        const topVendorPct = Math.round((vSorted[0][1] / totalObligations) * 100);
        
        // HHI-lite: are top 5 vendors > 80%?
        const top5Spend = vSorted.slice(0, 5).reduce((s, [, v]) => s + v, 0);
        const top5Pct = Math.round((top5Spend / totalObligations) * 100);

        let headline = '';
        if (totalVendors <= 5) {
          headline = 'Only ' + totalVendors + ' vendor' + (totalVendors === 1 ? '' : 's') + ' active in ' + query;
        } else if (topVendorPct >= 40) {
          headline = Utils.trunc(topVendor, 35) + ' dominates with ' + topVendorPct + '% of ' + query + ' awards';
        } else if (top5Pct >= 70) {
          headline = 'Top 5 of ' + totalVendors + ' vendors hold ' + top5Pct + '% — a concentrated market';
        } else {
          headline = query + ' spend is fragmented across ' + totalVendors + ' vendors — top 5 hold ' + top5Pct + '%';
        }
        bubbleEl.textContent = headline;
      }
    }
  },

  // --- Drill Down Logic ---
  resetDrill() { 
    App.drillState = { level: 0, path: [], currentAgency: null, currentSubAgency: null }; 
    App.searchData.filter = null; 
    App.searchData.active = App.searchData.raw;
    App.activeFeedSource = 'prime';
    App.activeVehicleFilter = null;
    App.bubbleMode = 'auto';
    Utils.syncUrlState();
    App.updateSearchDashboard(); 
  },

  // === COMPETITIVE FOOTPRINT ===
  // Run a fresh search for a specific vendor — see their entire federal portfolio

  // === NAICS FILTER ===
  // Client-side filter: instantly narrow current results to a specific NAICS code

  viewFootprint(vendorName) {
    const clean = JobLinks.cleanVendorName(vendorName);
    if (!clean || clean.length < 2) return;
    document.getElementById('mainSearchInput').value = clean;
    document.getElementById('miniSearch').value = clean;
    App.runSearch(clean);
  },

  // === VEHICLE FILTER ===
  // Filter the entire view to show only task orders on a specific vehicle
  activeVehicleFilter: null,

  filterByVehicle(parentId, label) {
    if (App.activeVehicleFilter === parentId) {
      this.clearVehicleFilter();
      return;
    }
    App.activeVehicleFilter = parentId;
    App.searchData.active = App.searchData.raw.filter(c => c['parent_award_id'] === parentId);
    App.searchData.filter = label;
    App.activeFeedSource = 'prime';
    App.updateSearchDashboard();
    App.renderVehiclePills(); // Re-render to show active state
  },

  clearVehicleFilter() {
    App.activeVehicleFilter = null;
    App.searchData.filter = null;
    App.searchData.active = App.searchData.raw;
    App.activeFeedSource = 'prime';
    App.updateSearchDashboard();
    App.renderVehiclePills();
  },

  renderVehiclePills() {
    const bar = document.getElementById('vehicleFilterBar');
    const container = document.getElementById('vehiclePills');
    if (!bar || !container) return;

    const data = App.searchData.raw || [];
    const vehicles = {};

    data.forEach(c => {
      const pid = c['parent_award_id'];
      if (!pid || pid === 'NONE') return;
      const label = VehicleDetector.detect(pid)?.short || pid;
      if (!vehicles[pid]) vehicles[pid] = { pid, label, count: 0, amount: 0 };
      vehicles[pid].count++;
      vehicles[pid].amount += parseFloat(c['Award Amount']) || 0;
    });

    const sorted = Object.values(vehicles).sort((a, b) => b.amount - a.amount);

    // Only show if there are vehicles with 2+ orders
    const meaningful = sorted.filter(v => v.count >= 2);
    if (meaningful.length === 0) {
      bar.style.display = 'none';
      return;
    }

    bar.style.display = 'block';
    const top = meaningful.slice(0, 8);
    const active = App.activeVehicleFilter;

    container.innerHTML = top.map(v => {
      const isActive = active === v.pid;
      return `<button onclick="App.filterByVehicle('${v.pid.replace(/'/g, "\\'")}', '${v.label.replace(/'/g, "\\'")}')"
        style="padding: 0.2rem 0.5rem; font-family: 'Google Sans Flex', sans-serif; font-size: var(--text-xs);
        background: ${isActive ? 'var(--brand)' : 'rgba(255,255,255,0.07)'}; 
        color: ${isActive ? 'var(--brand-text)' : 'var(--text-secondary)'};
        border: 1px solid ${isActive ? 'var(--brand)' : 'var(--border)'}; border-radius: var(--radius-sm); 
        cursor: pointer; transition: all 0.15s; white-space: nowrap;"
        title="${v.pid} · ${v.count} orders · ${Utils.money(v.amount)}">${v.label} <span style="opacity:0.9">${v.count}</span></button>`;
    }).join('') + (active ? `<button onclick="App.clearVehicleFilter()" 
      style="padding: 0.2rem 0.5rem; font-family: 'Google Sans Flex', sans-serif; font-size: var(--text-xs);
      background: rgba(239,83,80,0.15); color: var(--danger); border: 1px solid rgba(239,83,80,0.3); 
      border-radius: var(--radius-sm); cursor: pointer;">Clear</button>` : '');
  },

  // === PRIME REACH ===
  // Primes ranked by agency breadth — "who gives you the most reach?"
  // Built from prime search data, not subawards. No extra API call.
  renderPrimeReach() {
    const panel = document.getElementById('teamingPanel');
    const list = document.getElementById('teamingList');
    if (!panel || !list) return;

    const data = App.searchData.raw || [];
    if (data.length === 0) { panel.style.display = 'none'; return; }

    // Map each vendor to their agencies and sub-agencies
    const vendorMap = {};
    data.forEach(c => {
      const vendor = c['Recipient Name'] || 'Unknown';
      const agency = c['Awarding Agency'] || '';
      const subAgency = c['Awarding Sub Agency'] || '';
      const amt = parseFloat(c['Award Amount']) || 0;

      if (!vendorMap[vendor]) vendorMap[vendor] = { name: vendor, agencies: {}, subAgencies: new Set(), totalAmt: 0, count: 0 };
      vendorMap[vendor].totalAmt += amt;
      vendorMap[vendor].count++;
      if (agency) {
        if (!vendorMap[vendor].agencies[agency]) vendorMap[vendor].agencies[agency] = 0;
        vendorMap[vendor].agencies[agency] += amt;
      }
      if (subAgency) vendorMap[vendor].subAgencies.add(subAgency);
    });

    // Top 5 primes by spend — sorted by agency diversity first, then spend
    const ranked = Object.values(vendorMap)
      .sort((a, b) => Object.keys(b.agencies).length - Object.keys(a.agencies).length || b.totalAmt - a.totalAmt)
      .slice(0, 5);

    if (ranked.length === 0) { panel.style.display = 'none'; return; }

    panel.style.display = 'block';
    const esc = (s) => s.replace(/'/g, "\\'").replace(/"/g, '&quot;');

    list.innerHTML = ranked.map(v => {
      const agencyCount = Object.keys(v.agencies).length;
      const subCount = v.subAgencies.size;
      const topAgencies = Object.entries(v.agencies)
        .sort((a, b) => b[1] - a[1])
        .map(([name]) => name.replace(/^Department of (the )?/i, '').replace(/^Office of (the )?/i, ''));

      return `<div class="reach-row" onclick="App.viewFootprint('${esc(v.name)}')" title="Search ${v.name}'s full federal portfolio">
        <div style="min-width: 0; flex: 1;">
          <span class="reach-name">${Utils.trunc(v.name, 32)}</span>
          <div class="reach-meta">${agencyCount} ${agencyCount === 1 ? 'agency' : 'agencies'}${subCount > agencyCount ? ' · ' + subCount + ' offices' : ''} · ${v.count} awards · ${topAgencies.slice(0, 3).map(a => Utils.trunc(a, 18)).join(' · ')}${topAgencies.length > 3 ? ' +' + (topAgencies.length - 3) : ''}</div>
          <div class="reach-meta" onclick="event.stopPropagation();"><a href="${JobLinks.getLinkedInPeopleUrl(v.name)}" target="_blank" class="job-link">People</a> <a href="${JobLinks.getLinkedInUrl(v.name)}" target="_blank" class="job-link">Jobs</a> <a href="${JobLinks.getLinkedInNewsUrl(v.name)}" target="_blank" class="job-link">News</a></div>
        </div>
        <div style="text-align: right; flex-shrink: 0;">
          <div class="reach-amount">${Utils.money(v.totalAmt)}</div>
        </div>
      </div>`;
    }).join('');
  },
  
  updateDrillUI() {
  const bc = document.getElementById('drillBreadcrumb'); 
  const hint = document.getElementById('drillHint'); 
  const drillControlsBar = document.getElementById('drillControlsBar');

  if (App.drillState.level === 0) {
    if (drillControlsBar) drillControlsBar.style.display = 'none';
    hint.style.display = 'none'; 
  } else {
    if (drillControlsBar) drillControlsBar.style.display = 'block';
    bc.style.display = 'flex'; 

    let html = `<div class="breadcrumb-item" data-action="resetDrill"><span>All Agencies</span></div>`;
    
    App.drillState.path.forEach((p, i) => {
      const isLast = i === App.drillState.path.length - 1;
      const action = isLast ? '' : `App.drillToLevel(${i + 1})`;
      html += `
        <span class="breadcrumb-separator"></span>
        <div class="breadcrumb-item ${isLast ? 'active' : ''}" onclick="${action}">
          <span>${Utils.trunc(p.name, 25)}</span>
        </div>`;
    });
    bc.innerHTML = html; 

    if (App.drillState.level === 1) { 
      hint.innerHTML = `<span>Click a <strong>sub-agency</strong> or <strong>vendor</strong> to refine</span>`; 
    } else if (App.drillState.level === 2) {
      hint.innerHTML = `<span>Viewing <strong>sub-agency</strong> breakdown</span>`; 
    } else { 
      hint.innerHTML = `<span>Viewing filtered breakdown</span>`; 
    }
  }
},

  drillToAgency(name) {
  App.drillState = { 
    level: 1, 
    currentAgency: name, 
    currentSubAgency: null, 
    path: [{type: 'agency', name: name}] 
  };
  App.searchData.active = App.searchData.raw.filter(d => d['Awarding Agency'] === name);
  App.searchData.filter = name;
  App.activeFeedSource = 'prime';
  if (App.bubbleMode !== 'vendors' && App.bubbleMode !== 'agencies') App.bubbleMode = 'auto';
  Utils.syncUrlState();
  App.updateSearchDashboard();
},

drillToSubAgency(name) {
  App.drillState.level = 2;
  App.drillState.currentSubAgency = name;
  // Re-build path from the current agency and new sub-agency
  App.drillState.path = [
    {type: 'agency', name: App.drillState.currentAgency}, 
    {type: 'sub', name: name}
  ];
  // Filter from raw
  App.searchData.active = App.searchData.raw.filter(d => 
    d['Awarding Agency'] === App.drillState.currentAgency && 
    d['Awarding Sub Agency'] === name
  );
  App.searchData.filter = name;
  App.activeFeedSource = 'prime'; // Switch feed back to prime awards
  if (App.bubbleMode !== 'vendors' && App.bubbleMode !== 'agencies') App.bubbleMode = 'auto';
  Utils.syncUrlState();
  App.updateSearchDashboard();
},

  
  drillToLevel(lvl) { 
  // Always restore full data before re-applying a level-specific filter
  App.searchData.active = App.searchData.raw;

  if (lvl === 0) {
    App.resetDrill();
  } else if (lvl === 1) {
    App.drillToAgency(App.drillState.path[0].name); 
  } else if (lvl === 2) {
    App.drillToSubAgency(App.drillState.path[1].name);
  }
},
  drillDown(name) {
  const data = App.searchData.raw;
  
  // 1. Identify the entity type from the master dataset
  const agencyMatch = data.find(d => d['Awarding Agency'] === name);
  const subAgencyMatch = data.find(d => d['Awarding Sub Agency'] === name);
  const vendorMatch = data.find(d => d['Recipient Name'] === name);

  // 2. Clear previous specific filters to avoid "No Data" conflicts
  App.searchData.active = data;

  if (agencyMatch && !subAgencyMatch) {
    // It's a top-tier agency: Clean drill to Level 1
    App.drillToAgency(name);
  } 
  else if (subAgencyMatch) {
    // If it's a sub-agency (or both), we must ensure the parent context is set
    // to prevent "No Description" breadcrumbs.
    const parentName = subAgencyMatch['Awarding Agency'];
    App.drillState.currentAgency = parentName; 
    App.drillToSubAgency(name);
  } 
  else if (vendorMatch) {
    // Vendor Perspective (Level 3)
    if (App.drillState.level === 3) {
      App.drillState.path.pop(); // Replace vendor if already in vendor view
    }
    
    App.drillState.level = 3; 
    App.drillState.path.push({ type: 'vendor', name: name });
    App.searchData.filter = `Vendor: ${name}`;
    App.activeFeedSource = 'prime'; // Switch feed back to prime awards
    
    // Filter specifically for this vendor across all agencies
    App.searchData.active = data.filter(d => d['Recipient Name'] === name);
    
    Utils.syncUrlState();
    App.updateSearchDashboard();
  }
},
  clearFilter() { App.drillState.level > 0 ? App.resetDrill() : (App.searchData.filter = null, App.searchData.active = App.searchData.raw, App.activeFeedSource = 'prime', App.updateSearchDashboard()); },

renderSankey() {
  const container = document.getElementById('chartContainer');

  // Crossfade: if container has existing content, fade out first then rebuild
  if (container.children.length > 0) {
    container.classList.add('sankey-fade-out');
    container.classList.remove('sankey-fade-in');
    setTimeout(() => {
      container.innerHTML = '';
      container.classList.remove('sankey-fade-out');
      App._renderSankeyInner(container);
      container.classList.add('sankey-fade-in');
    }, 150);
  } else {
    container.innerHTML = '';
    App._renderSankeyInner(container);
    container.classList.add('sankey-fade-in');
  }
},

_renderSankeyInner(container) {
  
  const data = App.searchData.active; 
  if(!data || data.length === 0) { 
    container.innerHTML = '<div style="text-align:center; padding:4rem; color:var(--text-tertiary)">No data available for this view.</div>'; 
    return; 
  }
  
  // 1. DATA AGGREGATION (Kept your exact logic)
  const isLvl0 = App.drillState.level === 0;
  const flowMap = {}; 

  data.forEach(d => { 
    if(d['Award Amount'] > 0) {
      // Logic: Agency -> Vendor (Level 0) OR SubAgency -> Vendor (Level 1)
      const source = (isLvl0 ? d['Awarding Agency'] : d['Awarding Sub Agency']) || d['Awarding Agency'] || 'Unknown Agency';
      const target = d['Recipient Name'] || 'Unknown Vendor';
      const key = source + "|||" + target;
      
      flowMap[key] = (flowMap[key] || 0) + d['Award Amount']; 
    }
  });

  const allFlows = Object.entries(flowMap).sort((a,b) => b[1] - a[1]); 
  const limit = App.drillState.level > 0 ? 50 : 25;
  const topFlows = allFlows.slice(0, limit); 
  const tailFlows = allFlows.slice(limit);
  
  const nodesSet = new Set(); 
  const links = [];
  
  topFlows.forEach(([k,v]) => { 
    const [s,t] = k.split("|||"); 
    nodesSet.add(s); 
    nodesSet.add(t); 
    links.push({source:s, target:t, value:v}); 
  });

  // "Other" Category Logic
  if(tailFlows.length > 0) { 
    const aggs = {}; 
    tailFlows.forEach(([k,v]) => { 
      const [s] = k.split("|||"); 
      if(nodesSet.has(s)) aggs[s] = (aggs[s] || 0) + v; 
    }); 
    Object.entries(aggs).forEach(([s,v]) => { 
      const n = `Other (${tailFlows.length} Vendors)`; 
      nodesSet.add(n); 
      links.push({source:s, target:n, value:v}); 
    }); 
  }
  
  const nodes = Array.from(nodesSet).map(n => ({name:n})); 
  const nodeMap = new Map(nodes.map((n,i) => [n.name, i]));
  const d3Links = links.map(l => ({source:nodeMap.get(l.source), target:nodeMap.get(l.target), value:l.value}));
  
  // 2. RENDER via ChartUtils
  const drillableNames = new Set();
  App.searchData.raw.forEach(d => {
    if (d['Awarding Agency']) drillableNames.add(d['Awarding Agency']);
    if (d['Awarding Sub Agency']) drillableNames.add(d['Awarding Sub Agency']);
    if (d['Recipient Name']) drillableNames.add(d['Recipient Name']);
  });

  const svg = d3.select(container).append('svg').attr('id', 'sankeySvg');
  ChartUtils.drawSankey(svg, {
    nodes, links,
    gradientPrefix: 'prime-grad',
    heightPerNode: 28,
    isDrillable: d => {
      const n = d.name;
      if (!n || n.startsWith('Other') || n.includes('Unknown') || n === 'No Description') return false;
      return drillableNames.has(n);
    },
    isActive: d => {
      if (App.drillState.level === 0) return false;
      const last = App.drillState.path[App.drillState.path.length - 1];
      return last && last.name === d.name;
    },
    onNodeClick: (d, el) => {
      // Tap flash
      const s = d3.select(el);
      s.transition().duration(150).attr('opacity', 0.4).transition().duration(150).attr('opacity', 1);
      const isAct = App.drillState.level > 0 && App.drillState.path[App.drillState.path.length - 1]?.name === d.name;
      if (isAct) {
        if (App.drillState.level <= 1) App.resetDrill(); else App.drillToLevel(App.drillState.level - 1);
      } else {
        App.drillDown(d.name);
      }
    }
  });
},
  buildCardHTML({ borderStyle, agency, amount, desc, vendorHtml, metaHtml, signalsHtml, dateHtml, subText, footerLinks, url }) {
    return `<div class="deal-card"${borderStyle ? ` style="${borderStyle}"` : ''}>
      <div class="deal-header"><span class="deal-agency">${agency}</span><span class="deal-amount">${amount}</span></div>
      <div class="deal-desc">${desc}</div>
      <div class="deal-vendor">${vendorHtml}</div>
      ${metaHtml ? `<div class="deal-meta">${metaHtml}</div>` : ''}
      ${signalsHtml || ''}
      <div class="deal-footer"><div><div class="deal-date">${dateHtml}</div>${subText ? `<div style="font-size:var(--text-sm);color:var(--text-tertiary)">${subText}</div>` : ''}</div>
        <div style="display:flex;gap:0.5rem;align-items:center;">${footerLinks || ''}${url ? `<a href="${url}" target="_blank" class="action-btn">VIEW </a>` : ''}</div>
      </div></div>`;
  },
  renderFeed(showAll) {
    const div = document.getElementById('feedGrid');
    
    // Always render prime awards in the main feed
    const data = App.searchData.active;
    if(data.length === 0) { div.innerHTML = '<div style="text-align:center; padding:2rem; color:var(--text-tertiary)">No contracts found.</div>'; return; }
    
    const INITIAL_COUNT = 3;
    const displayData = showAll ? data : data.slice(0, INITIAL_COUNT);
    const hasMore = !showAll && data.length > INITIAL_COUNT;
    
    const cards = displayData.map((c, idx) => {
      const internalId = c['generated_internal_id'];
      let url = '#';
      if (internalId) url = `https://www.usaspending.gov/award/${internalId}`;
      else if (c['Award ID']) url = `https://www.usaspending.gov/search/?hash=&filters=${encodeURIComponent(JSON.stringify({keyword: c['Award ID']}))}`;
      
      let metaTags = '';
      const contractType = Utils.getContractTypeTag(c['Contract Award Type']);
      if (contractType) metaTags += `<span class="meta-tag" style="background:rgba(255,255,255,0.04);border-color:var(--border);color:var(--text-secondary);" title="${contractType.full}">${contractType.short}</span>`;
      if (c['NAICS Code']) metaTags += `<span class="meta-tag naics" title="${Html.escapeHtml(c['NAICS Description'] || '')}">NAICS: ${Html.escapeHtml(c['NAICS Code'])}</span>`;
      if (c['PSC Code']) metaTags += `<span class="meta-tag psc" title="${Html.escapeHtml(c['PSC Description'] || '')}">PSC: ${Html.escapeHtml(c['PSC Code'])}</span>`;
      const vehicle = VehicleDetector.detect(c['Award ID']);
      if (vehicle) metaTags += `<span class="meta-tag" style="background:rgba(255,255,255,0.04);border-color:var(--border);color:var(--text-secondary);" title="${vehicle.vehicle}">${vehicle.short}</span>`;
      // Set-aside: 'Type of Set Aside' is the correct USASpending field name
      const setAsideCode = c['Type of Set Aside'];
      const setAside = VehicleDetector.getSetAsideLabel(setAsideCode);
      if (setAside) metaTags += `<span class="meta-tag" style="background:rgba(255,255,255,0.04);border-color:var(--border);color:var(--text-secondary);" title="Set-Aside: ${setAside}">${setAside}</span>`;

      // Number of offers — real competition signal
      const offers = parseInt(c['number_of_offers_received']);
      if (offers && offers > 0) metaTags += `<span class="meta-tag" style="background:rgba(255,255,255,0.05);border-color:var(--border);color:var(--text-secondary);" title="Number of offers received">${offers} offer${offers > 1 ? 's' : ''}</span>`;
      
      const subAgency = c['Awarding Sub Agency'];
      const agencyDisplay = subAgency && subAgency !== c['Awarding Agency'] 
        ? `${Utils.trunc(c['Awarding Agency'], 20)} → ${Utils.trunc(subAgency, 20)}` 
        : Utils.trunc(c['Awarding Agency'], 35);
      
      const vendorNameRaw = c['Recipient Name'] || 'Unknown Vendor';
      const vendorName = Html.escapeHtml(vendorNameRaw);
      const desc = Html.escapeHtml(Utils.trunc(c['Description'], 100));
      const agencyDisplaySafe = Html.escapeHtml(agencyDisplay);
const linkedInUrl = JobLinks.getLinkedInUrl(vendorNameRaw);
const linkedInPeopleUrl = JobLinks.getLinkedInPeopleUrl(vendorNameRaw);
const linkedInNewsUrl = JobLinks.getLinkedInNewsUrl(vendorNameRaw);
return App.buildCardHTML({
  agency: agencyDisplaySafe,
  amount: Utils.money(c['Award Amount']),
  desc, vendorHtml: vendorName,
  metaHtml: metaTags,
  dateHtml: `${Utils.date(c['Start Date'])}${c['End Date'] ? ' \u2013 ' + Utils.date(c['End Date']) : ''}`,
  footerLinks: `<a href="${linkedInPeopleUrl}" target="_blank" class="job-link" title="Contacts">People</a><a href="${linkedInUrl}" target="_blank" class="job-link" title="Jobs">Jobs</a>`,
  url
});
}).join('');

    const showMoreBtn = hasMore ? Utils.showMoreBtn('App.renderFeed(true)', `Show All ${data.length} Contracts`) : '';

    div.innerHTML = cards + showMoreBtn;
    Utils.animateCards(div);
},
  renderSubawardFeed(targetDiv, showAll) {
    const div = targetDiv || document.getElementById('subFeedGrid');
    const wrapper = document.getElementById('subFeedWrapper');
    if (!div) return;
    
    let subawards = applySubDrillFilter(App.forecastData.subawards || [], App.subawardDrillState);
    
    if (subawards.length === 0) {
      div.innerHTML = '<div style="text-align:center; padding:2rem; color:var(--text-tertiary)">No subcontracts found.</div>';
      if (wrapper) wrapper.style.display = 'none';
      return;
    }
    
    // Show the sub feed wrapper
    if (wrapper) wrapper.style.display = 'block';
    
    // Sort by amount descending
    subawards = [...subawards].sort((a, b) => (parseFloat(b['Sub-Award Amount']) || 0) - (parseFloat(a['Sub-Award Amount']) || 0));
    
    const INITIAL_COUNT = 3;
    const displayData = showAll ? subawards.slice(0, 50) : subawards.slice(0, INITIAL_COUNT);
    const hasMore = !showAll && subawards.length > INITIAL_COUNT;
    
    const cards = displayData.map(s => {
      const prime = s['Prime Recipient Name'] || 'Unknown Prime';
      const sub = s['Sub-Awardee Name'] || 'Unknown Sub';
      const amount = parseFloat(s['Sub-Award Amount']) || 0;
      const date = s['Sub-Award Date'];
      const agency = s['Awarding Agency'] || s['Awarding Sub Agency'] || '';
      const primeAwardInternalId = s['prime_award_generated_internal_id'] || '';
      
      let usaSpendingUrl = '';
      if (primeAwardInternalId) {
        usaSpendingUrl = `https://www.usaspending.gov/award/${primeAwardInternalId}`;
      }
      
      const primeShort = Html.escapeHtml(Utils.trunc(prime, 25));
      const subShort = Html.escapeHtml(Utils.trunc(sub, 25));
      const linkedInPrimeUrl = JobLinks.getLinkedInPeopleUrl(prime);
      const linkedInSubUrl = JobLinks.getLinkedInPeopleUrl(sub);
      
      // Encode minimal data for copy button
      const copyData = encodeURIComponent(JSON.stringify({
        'Awarding Agency': agency, 'Prime Recipient Name': prime, 'Sub-Awardee Name': sub,
        'Sub-Award Amount': s['Sub-Award Amount'], 'Sub-Award Date': date,
        'prime_award_generated_internal_id': primeAwardInternalId
      }));
      
      return App.buildCardHTML({
        borderStyle: 'border-left-color: var(--accent);',
        agency: '<span style="color:var(--accent);">SUBCONTRACT</span>',
        amount: Utils.money(amount),
        desc: `<span style="font-size:var(--text-sm);"><strong>${primeShort}</strong>  <strong>${subShort}</strong></span>`,
        vendorHtml: `<span style="font-size:var(--text-sm);color:var(--text-secondary);">${agency ? `Agency: ${Html.escapeHtml(Utils.trunc(agency, 30))}` : ''}</span>`,
        dateHtml: date ? Utils.date(date) : 'Date N/A',
        footerLinks: `<a href="${linkedInPrimeUrl}" target="_blank" class="job-link" title="Find contacts at prime"> Prime</a><a href="${linkedInSubUrl}" target="_blank" class="job-link" title="Find contacts at sub"> Sub</a>`,
        url: usaSpendingUrl || null
      });
    }).join('');

    const showMoreBtn = hasMore ? Utils.showMoreBtn('App.renderSubawardFeed(null, true)', `Show All ${Math.min(subawards.length, 50)} Subcontracts`) : '';

    div.innerHTML = cards + showMoreBtn;
    Utils.animateCards(div);
  },
// --- Search View: Top Buyers with LinkedIn Links ---
renderReachList(opts) {
    const { data, containerId, panelId, primaryField, primaryFallback = 'Unknown',
      secondaryField, tertiaryField, secondaryLabel, overflowLabel = 'more',
      onClickTpl, countLabel = 'awards', rightLabel = 'awards',
      formatName = n => n, formatMeta } = opts;
    const body = document.getElementById(containerId);
    const panel = document.getElementById(panelId);
    if (!body) return;
    if (!data || data.length === 0) { if (panel) panel.style.display = 'none'; return; }
    const map = {};
    data.forEach(row => {
      const primary = row[primaryField] || (typeof primaryFallback === 'function' ? primaryFallback(row) : primaryFallback);
      const amt = parseFloat(row['Award Amount'] || row['Sub-Award Amount']) || 0;
      if (!map[primary]) map[primary] = { name: primary, spend: 0, count: 0, secSet: new Set(), tertMap: {} };
      map[primary].spend += amt;
      map[primary].count++;
      if (secondaryField && row[secondaryField]) map[primary].secSet.add(row[secondaryField]);
      if (tertiaryField && row[tertiaryField]) {
        const t = row[tertiaryField];
        if (!map[primary].tertMap[t]) map[primary].tertMap[t] = 0;
        map[primary].tertMap[t] += amt;
      }
    });
    const sorted = Object.values(map).sort((a, b) => b.spend - a.spend);
    const top = sorted.slice(0, 5);
    if (top.length === 0) { if (panel) panel.style.display = 'none'; return; }
    if (panel) panel.style.display = 'block';
    const esc = s => s.replace(/'/g, "\\'").replace(/"/g, '&quot;');
    const defaultMeta = items => items.slice(0, 3).join(' \u00b7 ') + (items.length > 3 ? ` +${items.length - 3}` : '');
    const metaFn = formatMeta || defaultMeta;
    body.innerHTML = top.map(item => {
      const secCount = item.secSet.size;
      const topTert = Object.entries(item.tertMap).sort((a, b) => b[1] - a[1]).map(([n]) => Utils.trunc(n, 20));
      const metaHtml = tertiaryField && topTert.length ? metaFn(topTert) : '';
      const click = onClickTpl ? `onclick="${onClickTpl.replace('{name}', esc(item.name))}"` : '';
      const secBadge = secondaryLabel && secCount > 0 ? `<span class="reach-badge accent">${secCount} ${secondaryLabel(secCount)}</span>` : '';
      return `<div class="reach-row" ${click} title="Explore ${esc(item.name)}">
        <div style="min-width: 0; flex: 1;">
          <span class="reach-name">${Utils.trunc(formatName(item.name), 32)}</span>
          <div class="reach-meta">${secCount > 0 && secondaryLabel ? secCount + ' ' + secondaryLabel(secCount) + ' · ' : ''}${item.count} ${countLabel}${metaHtml ? ' · ' + metaHtml : ''}</div>
          <div class="reach-meta" onclick="event.stopPropagation();"><a href="${JobLinks.getLinkedInPeopleUrl(item.name)}" target="_blank" class="job-link">People</a> <a href="${JobLinks.getLinkedInUrl(item.name)}" target="_blank" class="job-link">Jobs</a> <a href="${JobLinks.getLinkedInNewsUrl(item.name)}" target="_blank" class="job-link">News</a></div>
        </div>
        <div style="text-align: right; flex-shrink: 0;">
          <div class="reach-amount">${Utils.money(item.spend)}</div>
        </div>
      </div>`;
    }).join('') + (sorted.length > 5 ? `<div class="reach-overflow">+${sorted.length - 5} ${overflowLabel}</div>` : '');
  },

  renderSearchTopBuyers(data) {
    const drill = App.drillState || {};
    if (drill.level >= 1 && drill.currentAgency) {
      this.renderReachList({ data, containerId: 'searchTopBuyersBody', panelId: 'agencyReachPanel',
        primaryField: 'Awarding Sub Agency', primaryFallback: row => row['Awarding Agency'] || 'Unknown',
        onClickTpl: "App.drillToSubAgency('{name}')", overflowLabel: 'more offices' });
    } else {
      this.renderReachList({ data, containerId: 'searchTopBuyersBody', panelId: 'agencyReachPanel',
        primaryField: 'Awarding Agency', secondaryField: 'Awarding Sub Agency', tertiaryField: 'Recipient Name',
        secondaryLabel: n => n === 1 ? 'office' : 'offices',
        formatName: n => n.replace(/^Department of (the )?/i, '').replace(/^Office of (the )?/i, ''),
        formatMeta: items => items.length ? `${Utils.trunc(items[0], 22)} leads` : '',
        onClickTpl: "App.drillToAgency('{name}')", overflowLabel: 'more agencies' });
    }
  },

  renderSearchTopPrimes(subawards) {
    const filtered = applySubDrillFilter(subawards || [], App.subawardDrillState);
    this.renderReachList({ data: filtered, containerId: 'searchTopPrimesBody', panelId: 'subPrimesPanel',
      primaryField: 'Prime Recipient Name', secondaryField: 'Sub-Awardee Name', tertiaryField: 'Sub-Awardee Name',
      secondaryLabel: n => n === 1 ? 'sub' : 'subs',
      onClickTpl: "App.viewFootprint('{name}')", rightLabel: 'subs', overflowLabel: 'more primes' });
  },

  renderSearchTopSubs(subawards) {
    const filtered = applySubDrillFilter(subawards || [], App.subawardDrillState);
    this.renderReachList({ data: filtered, containerId: 'searchTopSubsBody', panelId: 'subSubsPanel',
      primaryField: 'Sub-Awardee Name', secondaryField: 'Prime Recipient Name', tertiaryField: 'Prime Recipient Name',
      secondaryLabel: n => n === 1 ? 'prime' : 'primes',
      onClickTpl: "App.viewFootprint('{name}')", rightLabel: 'subs', overflowLabel: 'more subs' });
  },

  // --- NAICS Mix: Uses spending_by_category/naics endpoint (App.naicsData) ---
  renderNaicsMix() {
    const panel = document.getElementById('naicsPanel');
    const body = document.getElementById('naicsMixBody');
    if (!body || !panel) return;
    
    const data = App.naicsData;
    if (!data || data.length === 0) { panel.style.display = 'none'; return; }

    const totalAmt = data.reduce((sum, d) => sum + (d.amount || 0), 0);
    const sorted = data.slice(0, 5);
    if (sorted.length === 0) { panel.style.display = 'none'; return; }

    panel.style.display = 'block';
    const maxAmt = sorted[0].amount || 1;
    const esc = (s) => s.replace(/'/g, "\\'");

    body.innerHTML = `<div style="display: flex; flex-direction: column; gap: 0.15rem;">
      ${sorted.map(s => {
        const pct = totalAmt > 0 ? ((s.amount / totalAmt) * 100).toFixed(0) : 0;
        return `<div class="reach-row" onclick="App.runSearch('${s.code}')">
          <div style="min-width: 0; flex: 1;">
            <div style="display: flex; align-items: center; gap: 0.5rem;">
              <span style="font-family: 'Google Sans Flex', sans-serif; font-size: var(--text-base); font-weight: 700; color: var(--text-primary); flex-shrink: 0; min-width: 52px;">${s.code}</span>
              <div style="flex: 1; min-width: 0;">
                <div style="height: 6px; background: rgba(255,255,255,0.07); border-radius: var(--radius-sm); overflow: hidden;">
                  <div style="height: 100%; width: ${(s.amount / maxAmt) * 100}%; background: var(--accent); border-radius: var(--radius-sm); opacity: 0.85;"></div>
                </div>
              </div>
            </div>
            <div class="reach-meta" style="padding-left: 0;">
              ${Utils.trunc(s.name || '', 50)}
            </div>
          </div>
          <div style="text-align: right; flex-shrink: 0;">
            <div class="reach-amount">${Utils.money(s.amount)}</div>
            <div class="reach-count">${pct}%</div>
          </div>
        </div>`;
      }).join('')}
    </div>`;
  },


// --- Forecast Mode ---


  async loadSubcontractingData(query) {
  if (App.forecastData.subawards && App.currentQuery === query) return;
    const body = document.getElementById('subcontractingBody');
    const statsEl = document.getElementById('subcontractingStats');
    if (!body) return;
    
    body.innerHTML = `<div style="text-align:center; padding:2rem; color:var(--text-secondary);"> Loading subaward flow...</div>`;
    
    // Timeout wrapper — show fallback if API takes longer than 15 seconds
    const timeout = setTimeout(() => {
      if (body.querySelector('.fa-spinner')) {
        body.innerHTML = `<div style="text-align:center; padding:1rem; color:var(--text-secondary); font-size:var(--text-base);">
           Subaward data is taking too long to load.
          <br><a href="#" onclick="App.loadSubcontractingData('${query.replace(/'/g, "\\'")}'); return false;" style="color:var(--accent); text-decoration:underline; font-size:var(--text-sm);">Retry</a>
        </div>`;
      }
    }, 15000);
    
    try {
      API.getSubawards(query)
  .then(subawards => {
    clearTimeout(timeout);
    App.forecastData.subawards = subawards;

    this.renderSubawardSankey(subawards);
    this.renderSearchTopPrimes(subawards);
    this.renderSearchTopSubs(subawards);
    this.renderSubawardFeed();
    App.renderSubBubbleChart();
  })
  .catch(e => {
    clearTimeout(timeout);
    console.error(e);
  });

      // Teaming partner discovery — find subs working with multiple primes
    } catch (e) {
      clearTimeout(timeout);
      console.error(e);
      body.innerHTML = `<div style="text-align:center; padding:1rem; color:var(--text-secondary); font-size:var(--text-base);">
         Unable to load subaward data.
        <br><a href="#" onclick="App.loadSubcontractingData('${query.replace(/'/g, "\\'")}'); return false;" style="color:var(--accent); text-decoration:underline; font-size:var(--text-sm);">Retry</a>
      </div>`;
    }
  },

  renderSubawardSankey(subawards) {
    const wrapper = document.getElementById('subawardWrapper');
    const body = document.getElementById('subcontractingBody');
    const statsEl = document.getElementById('subcontractingStats');
    
    if (!wrapper || !body) return;

    // 2. CHECK DATA EXISTENCE
    if (!subawards || subawards.length === 0) {
      wrapper.style.display = 'none';
      if (statsEl) {
        const volEl = document.getElementById('sub-stat-vol');
        if (volEl) volEl.innerText = '-';
      }
      return;
    }

    // Data exists: Reveal the wrapper and sub convo panel
    wrapper.style.display = 'block';
    
    // Update sub sankey subtitle with query context
    const subSankeySubEl = document.getElementById('subSankeySubtitle');
    if (subSankeySubEl && App.currentQuery) {
      subSankeySubEl.textContent = '"' + App.currentQuery.toUpperCase() + '" · TOP SUBCONTRACTS · INDIVIDUAL TRANSACTION VALUE';
    }
    
    // --- Apply Drill Filter ---
    const drill = App.subawardDrillState;
    let filteredSubawards = applySubDrillFilter(subawards, drill);
    if (drill.level > 0 && drill.path.length > 0) {
      drill.filter = drill.path[drill.path.length - 1].name;
      drill.filterType = drill.path[drill.path.length - 1].type;
    }
    
    // --- Data Processing ---
    // Determine the left-side source based on drill level
    const flowMap = {};
    let totalValue = 0;
    
    // Determine what the 3 columns should be based on drill depth
    const drillHasAgency = drill.path.some(p => p.type === 'agency');
    const drillHasSubAgency = drill.path.some(p => p.type === 'subagency');
    
    filteredSubawards.forEach(sub => {
      const agency = sub['Awarding Agency'] || 'Unknown Agency';
      const subAgency = sub['Awarding Sub Agency'] || agency;
      const prime = sub['Prime Recipient Name'] || 'Unknown Prime';
      const subName = sub['Sub-Awardee Name'] || 'Unknown Sub';
      const amount = parseFloat(sub['Sub-Award Amount']) || 0;
      
      if (amount > 0) {
        // Determine left column based on drill state
        let leftCol;
        if (!drillHasAgency) {
          // Level 0: Agency → Prime → Sub
          leftCol = agency;
        } else if (!drillHasSubAgency) {
          // Level 1 (agency drilled): SubAgency → Prime → Sub
          leftCol = subAgency;
        } else {
          // Level 2+ (subagency drilled): Prime → Sub (2-column)
          leftCol = prime;
        }
        
        if (drillHasAgency && !drillHasSubAgency) {
          // SubAgency → Prime → Sub (3-column)
          const key1 = `${leftCol}|||${prime}`;
          flowMap[key1] = (flowMap[key1] || 0) + amount;
          const key2 = `${prime}|||${subName}`;
          flowMap[key2] = (flowMap[key2] || 0) + amount;
        } else if (drillHasSubAgency) {
          // Prime → Sub (2-column, subagency already filtered)
          const key = `${prime}|||${subName}`;
          flowMap[key] = (flowMap[key] || 0) + amount;
        } else {
          // Agency → Prime → Sub (default 3-column)
          const key1 = `${agency}|||${prime}`;
          flowMap[key1] = (flowMap[key1] || 0) + amount;
          const key2 = `${prime}|||${subName}`;
          flowMap[key2] = (flowMap[key2] || 0) + amount;
        }
        
        totalValue += amount;
      }
    });
    
    // Update hero stats
    if (statsEl) {
      const volEl = document.getElementById('sub-stat-vol');
      const primesEl = document.getElementById('sub-stat-primes');
      const subsEl = document.getElementById('sub-stat-subs');
      const countEl = document.getElementById('sub-stat-count');
      const uniquePrimes = new Set(filteredSubawards.map(s => s['Prime Recipient Name'] || 'Unknown')).size;
      const uniqueSubs = new Set(filteredSubawards.map(s => s['Sub-Awardee Name'] || 'Unknown')).size;
      if (volEl) Utils.countUp(volEl, totalValue, Utils.money);
    if (primesEl) primesEl.innerText = uniquePrimes;
    if (subsEl) subsEl.innerText = uniqueSubs;
    if (countEl) countEl.innerText = filteredSubawards.length;
    }
    
    const allFlows = Object.entries(flowMap).sort((a, b) => b[1] - a[1]);
    const topFlows = allFlows.slice(0, 40);
    
    const nodesSet = new Set();
    const links = [];
    
    topFlows.forEach(([key, value]) => {
      const [source, target] = key.split('|||');
      nodesSet.add(source);
      nodesSet.add(target);
      links.push({ source, target, value });
    });
    
    if (links.length === 0) {
      wrapper.style.display = 'none';
      return;
    }

    const nodes = Array.from(nodesSet).map(name => ({ name }));
    const nodeMap = new Map(nodes.map((n, i) => [n.name, i]));
    const d3Links = links.map(l => ({
      source: nodeMap.get(l.source),
      target: nodeMap.get(l.target),
      value: l.value
    }));
    
    // --- Rendering ---
    // Build breadcrumb HTML for multi-level drill state
    let breadcrumbHtml = '';
    if (drill.level > 0 && drill.path.length > 0) {
      const typeIcons = { agency: 'fa-landmark', subagency: 'fa-sitemap', prime: 'fa-building', sub: 'fa-handshake' };
      const typeLabels = { agency: 'Agency', subagency: 'Sub-Agency', prime: 'Prime', sub: 'Sub' };
      
      let crumbs = `<div class="breadcrumb-item" onclick="App.resetSubawardDrill()" style="cursor:pointer;">
        
        <span>All Subawards</span>
      </div>`;
      
      drill.path.forEach((step, idx) => {
        const isLast = idx === drill.path.length - 1;
        const icon = typeIcons[step.type] || 'fa-circle';
        crumbs += `<span class="breadcrumb-separator"></span>`;
        if (isLast) {
          crumbs += `<div class="breadcrumb-item active">
            
            <span>${Utils.trunc(step.name, 30)}</span>
            <span style="font-size:var(--text-xs); color:var(--text-secondary); margin-left:6px;">(${typeLabels[step.type] || step.type})</span>
          </div>`;
        } else {
          crumbs += `<div class="breadcrumb-item" onclick="App.drillSubawardToLevel(${idx})" style="cursor:pointer;">
            
            <span>${Utils.trunc(step.name, 25)}</span>
          </div>`;
        }
      });
      
      breadcrumbHtml = `<div class="drill-breadcrumb" style="display: flex; margin-bottom: 0.75rem;">${crumbs}</div>`;
    }
    
    body.innerHTML = `
      ${breadcrumbHtml}
      <div id="subawardDrillHint" class="drill-hint" style="margin-bottom: 0.5rem; ${drill.level > 0 ? 'display:none;' : ''}">
        
        <span>Click any bar to drill down · click the active bar to drill back up</span>
      </div>
      <svg id="subawardSankeySvg"></svg>
    `;
    
    // Determine node types for drill behavior
    const primeNames = new Set(filteredSubawards.map(s => s['Prime Recipient Name'] || 'Unknown Prime'));
    const subNames = new Set(filteredSubawards.map(s => s['Sub-Awardee Name'] || 'Unknown Sub'));
    const agencyNames = new Set(filteredSubawards.map(s => s['Awarding Agency'] || 'Unknown Agency'));
    const subAgencyNames = new Set(filteredSubawards.map(s => s['Awarding Sub Agency'] || s['Awarding Agency'] || 'Unknown Agency'));

    const svg = d3.select('#subawardSankeySvg');
    const result = ChartUtils.drawSankey(svg, {
      nodes, links,
      gradientPrefix: 'sub-grad',
      heightPerNode: 20,
      isDrillable: d => !d.name.startsWith('Other') && !d.name.includes('Unknown'),
      isActive: d => drill.path.length > 0 && drill.path[drill.path.length - 1].name === d.name,
      onNodeClick: (d) => {
        const isAct = drill.path.length > 0 && drill.path[drill.path.length - 1].name === d.name;
        if (isAct) {
          if (drill.path.length <= 1) App.resetSubawardDrill(); else App.drillSubawardToLevel(drill.path.length - 2);
        } else {
          // Determine nodeType from data sets
          let nodeType = 'sub';
          if (drillHasAgency && !drillHasSubAgency && subAgencyNames.has(d.name) && !primeNames.has(d.name)) nodeType = 'subagency';
          else if (!drillHasAgency && agencyNames.has(d.name) && !primeNames.has(d.name)) nodeType = 'agency';
          else if (primeNames.has(d.name) && !subNames.has(d.name)) nodeType = 'prime';
          else if (primeNames.has(d.name)) nodeType = 'prime';
          App.drillSubaward(d.name, nodeType);
        }
      }
    });
},
  // Subaward drill-down handler - multi-level path support
  drillSubaward(name, nodeType) {
    const drill = App.subawardDrillState;
    
    // Push onto path
    drill.path.push({ type: nodeType, name: name });
    drill.level = drill.path.length;
    drill.filter = name;
    drill.filterType = nodeType;
    
    App.activeFeedSource = 'sub';
    
    // Re-render with filter applied — preserve scroll position to avoid jarring jump
    if (App.forecastData.subawards) {
      const scrollY = window.scrollY;
      App.renderSubawardSankey(App.forecastData.subawards);
      App.renderSearchTopPrimes(App.forecastData.subawards);
      App.renderSearchTopSubs(App.forecastData.subawards);
      App.renderSubawardFeed();
      App.renderSubBubbleChart();
      requestAnimationFrame(() => window.scrollTo(0, scrollY));
    }
  },
  
  // Navigate to a specific level in subaward drill path
  drillSubawardToLevel(idx) {
    const drill = App.subawardDrillState;
    if (idx < 0) {
      App.resetSubawardDrill();
      return;
    }
    drill.path = drill.path.slice(0, idx + 1);
    drill.level = drill.path.length;
    if (drill.path.length > 0) {
      drill.filter = drill.path[drill.path.length - 1].name;
      drill.filterType = drill.path[drill.path.length - 1].type;
    } else {
      drill.filter = null;
      drill.filterType = null;
    }
    
    App.activeFeedSource = 'sub';
    
    if (App.forecastData.subawards) {
      const scrollY = window.scrollY;
      App.renderSubawardSankey(App.forecastData.subawards);
      App.renderSearchTopPrimes(App.forecastData.subawards);
      App.renderSearchTopSubs(App.forecastData.subawards);
      App.renderSubawardFeed();
      App.renderSubBubbleChart();
      requestAnimationFrame(() => window.scrollTo(0, scrollY));
    }
  },

  // Reset subaward drill
  resetSubawardDrill() {
    App.subawardDrillState = { level: 0, path: [], filter: null, filterType: null };
    App.activeFeedSource = 'sub'; // Stay on subaward view but unfiltered
    
    if (App.forecastData.subawards) {
      const scrollY = window.scrollY;
      App.renderSubawardSankey(App.forecastData.subawards);
      App.renderSearchTopPrimes(App.forecastData.subawards);
      App.renderSearchTopSubs(App.forecastData.subawards);
      App.renderSubawardFeed();
      App.renderSubBubbleChart();
      requestAnimationFrame(() => window.scrollTo(0, scrollY));
    }
  },

renderRecompetes(recompetes, showAll = false) {
  const container = document.getElementById('recompetesList');
  if (!container) return;
  
  if (!recompetes || recompetes.length === 0) {
    container.innerHTML = '';
    return;
  }
  
  // 1. Mission Gap Risk Calculation
  const withRisk = recompetes.map(r => ({
    ...r,
    risk: Utils.missionGapRisk(r)
  }));
  
  // 2. Metrics Calculation
  const totalRecompeteValue = withRisk.reduce((sum, r) => sum + (parseFloat(r['Award Amount']) || 0), 0);
  const highRiskContracts = withRisk.filter(r => r.risk.level === 'high');
  const highRiskValue = highRiskContracts.reduce((sum, r) => sum + (parseFloat(r['Award Amount']) || 0), 0);
  
  // 3. User-Defined Filtering
  const filtered = App.onlyHighMissionGap 
    ? withRisk.filter(r => r.risk.level === 'high')
    : withRisk;

  // 4. LOAD MORE LOGIC: Limit to 5 unless 'showAll' is true
  const INITIAL_COUNT = 3;
  const displayData = showAll ? filtered : filtered.slice(0, INITIAL_COUNT);
  const hasMore = !showAll && filtered.length > INITIAL_COUNT;
  
  // 5. Subtitle Logic
  let subtitleText = `${Utils.money(totalRecompeteValue)} in ${recompetes.length} contracts expiring within 24 months`;
  if (highRiskContracts.length > 0) {
    subtitleText += ` · <span style="color:var(--danger); font-weight:600;">${highRiskContracts.length} high-risk (${Utils.money(highRiskValue)})</span>`;
  }
  
  // 6. Header
  let html = `
    <div class="section-header">
      <div class="section-title-group">
        <span class="section-title">Expiring Contracts</span>
      </div>
      <div class="mission-gap-filter">
        <span class="section-subtitle">${subtitleText}</span>
        ${highRiskContracts.length > 0 ? `
          <button class="mission-gap-toggle ${App.onlyHighMissionGap ? 'active' : ''}"
        onclick="App.toggleMissionGapFilter()"
        title="Show only contracts with high mission continuity risk">
  <i class="fa-solid fa-sort"></i>
</button>
        ` : ''}
      </div>
    </div>`;
    
  if (filtered.length === 0) {
    html += `<div style="text-align:center; padding:2rem; color:var(--text-secondary);">No contracts match the current filter. <a href="#" onclick="App.toggleMissionGapFilter(); return false;" style="color:var(--accent); margin-left:0.5rem;">Show all</a></div>`;
  } else {
    // Recompete card list (timeline chart removed — cards are what matters)

    // Map only the displayData (the limited set)
    html += displayData.map(r => {
      if (!r['End Date']) return '';
      
      const internalId = r['generated_internal_id'];
      const awardUrl = internalId 
        ? `https://www.usaspending.gov/award/${internalId}`
        : (r['Award ID'] ? `https://www.usaspending.gov/search/?hash=&filters=${encodeURIComponent(JSON.stringify({keyword: r['Award ID']}))}` : null);
      
      const endDate = new Date(r['End Date']);
      const m = endDate.getMonth();
      const y = endDate.getFullYear();
      const fy = m >= 9 ? y + 1 : y;
      let q = 1;
      if (m >= 0 && m <= 2) q = 2;
      else if (m >= 3 && m <= 5) q = 3;
      else if (m >= 6 && m <= 8) q = 4;
      const fiscalPeriod = `FY${String(fy).slice(-2)} Q${q}`;

      const today = new Date();
      const daysUntil = Math.ceil((endDate - today) / (1000 * 60 * 60 * 24));
      const urgency = daysUntil < 180 ? 'urgent' : daysUntil < 365 ? 'soon' : 'later';
      
      const risk = r.risk;
      const riskLabel = risk.level === 'high' ? 'Mission Gap: High' : risk.level === 'medium' ? 'Mission Gap: Medium' : 'Mission Gap: Low';
      const esc = str => Html.escapeHtml(str);
      
      return App.buildCardHTML({
        borderStyle: risk.level === 'high' ? 'margin-bottom:1rem;border-left:3px solid var(--danger);' : risk.level === 'medium' ? 'margin-bottom:1rem;border-left:3px solid #FDD835;' : 'margin-bottom:1rem;',
        agency: esc(Utils.trunc(r['Awarding Agency'], 40)),
        amount: Utils.money(r['Award Amount']),
        desc: esc(Utils.trunc(r['Description'], 100)),
        vendorHtml: '',
        metaHtml: `<span class="meta-tag" style="background:rgba(255,255,255,0.04);border-color:var(--border);color:var(--text-secondary);">${fiscalPeriod}</span><span class="meta-tag mission-gap ${risk.level}">${riskLabel}</span>${r['PSC Code'] ? `<span class="meta-tag psc">PSC: ${esc(r['PSC Code'])}</span>` : ''}`,
        signalsHtml: risk.reasons.length > 0 && risk.level !== 'low' ? `<div class="mission-gap-signals">Signals: ${esc(risk.reasons.join(', '))}</div>` : '',
        dateHtml: `<span style="color:${urgency === 'urgent' ? 'var(--danger)' : urgency === 'soon' ? '#FDD835' : 'var(--text-secondary)'}">Expires: ${Utils.date(r['End Date'])} (${daysUntil} days)</span>`,
        subText: `Incumbent: ${esc(Utils.trunc(r['Recipient Name'], 35))}`,
        url: awardUrl
      });
    }).join('');
    
    // 8. Add the "Show All" button if there are more items
    if (hasMore) {
      html += Utils.showMoreBtn('App.renderRecompetes(App.forecastData.analysis.recompetes, true)', `Show All ${filtered.length} Expiring Contracts`);
    }
  }
  
  container.innerHTML = html;
  Utils.animateCards(container);
},
  toggleMissionGapFilter() {
    App.onlyHighMissionGap = !App.onlyHighMissionGap;
    // Re-render with current recompetes data
    if (App.forecastData.analysis && App.forecastData.analysis.recompetes) {
      this.renderRecompetes(App.forecastData.analysis.recompetes);
    }
  },

// --- Helpers ---
  exportCSV(btn) {
    const data = App.searchData.active;
    
    // IF NO DATA: Flash Red (Error)
    if (!data.length) {
      if (btn) {
        const originalHtml = btn.innerHTML;
        btn.style.color = 'var(--danger)';
        btn.style.borderColor = 'var(--danger)';
        btn.innerHTML = ''; 
        setTimeout(() => {
          btn.style.color = '';
          btn.style.borderColor = '';
          btn.innerHTML = originalHtml;
        }, 2000);
      }
      return;
    }
    
    // Updated Headers with Fiscal Period
    const headers = ['Fiscal Period', 'Recipient', 'Agency', 'Sub-Agency', 'Total Obligations', 'Description', 'Start Date', 'End Date', 'Award ID', 'Award Link'];
    
    const rows = data.map(c => {
      // Logic for FY26 Q1 shorthand
      let fiscalPeriod = 'N/A';
      if (c['Start Date']) {
        const d = new Date(c['Start Date']);
        const m = d.getMonth(); 
        const y = d.getFullYear();
        const fy = m >= 9 ? y + 1 : y;
        let q;
        if (m >= 9) q = 1;        // Oct-Nov-Dec = Q1
        else if (m <= 2) q = 2;   // Jan-Feb-Mar = Q2
        else if (m <= 5) q = 3;   // Apr-May-Jun = Q3
        else q = 4;               // Jul-Aug-Sep = Q4
        fiscalPeriod = `FY${String(fy).slice(-2)} Q${q}`;
      }

      const internalId = c['generated_internal_id']; 
      let awardUrl = '';
      if (internalId) awardUrl = `https://www.usaspending.gov/award/${internalId}`;
      else if (c['Award ID']) awardUrl = `https://www.usaspending.gov/search/?hash=&filters=${encodeURIComponent(JSON.stringify({keyword: c['Award ID']}))}`;
      
      return [
        `"${fiscalPeriod}"`,
        `"${(c['Recipient Name'] || '').replace(/"/g, '""')}"`, 
        `"${(c['Awarding Agency'] || '').replace(/"/g, '""')}"`, 
        `"${(c['Awarding Sub Agency'] || '').replace(/"/g, '""')}"`, 
        c['Award Amount'] || 0, 
        `"${(c['Description'] || '').replace(/"/g, '""')}"`, 
        c['Start Date'] || '', 
        c['End Date'] || '', 
        c['Award ID'] || '', 
        awardUrl
      ];
    });
    
    const csvContent = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a"); 
    link.setAttribute("href", url); 
    link.setAttribute("download", `govhoo_${App.mode}_${App.currentQuery}.csv`);
    document.body.appendChild(link); link.click(); document.body.removeChild(link);

    // SUCCESS: Flash Green
    if (btn) {
      const originalHtml = btn.innerHTML;
      btn.style.color = 'var(--success)';
      btn.style.borderColor = 'var(--success)';
      btn.innerHTML = ''; 
      setTimeout(() => {
        btn.style.color = '';
        btn.style.borderColor = '';
        btn.innerHTML = originalHtml;
      }, 2000);
    }
  },
  
  showSkeleton() { App._isLoading = true; },
  hideSkeleton() { App._isLoading = false; },

  showZeroResults(query) {
    const container = document.getElementById('chartContainer');
    const sankeyPanel = document.getElementById('sankeyPanel');
    const bubblePanel = document.getElementById('bubbleChartPanel');
    if (bubblePanel) bubblePanel.style.display = 'none';

    // Reset stats to zero
    ['stat-vol', 'stat-agencies', 'stat-count', 'stat-vendors'].forEach(id => {
      const el = document.getElementById(id); if (el) el.innerText = '0';
    });

    if (container) {
      container.innerHTML = `
        <div style="text-align:center; padding:3rem 1.5rem;">
          <div style="font-size:var(--text-hero); margin-bottom:1rem; opacity:0.3;">∅</div>
          <div style="font-family: 'Google Sans Flex', sans-serif; font-size:var(--text-lg); font-weight:600; color:var(--text-primary); margin-bottom:0.5rem;">
            No active contracts found for "${Utils.trunc(query, 30)}"
          </div>
          <div style="font-size:var(--text-base); color:var(--text-secondary); max-width:360px; margin:0 auto 1.5rem; line-height:1.6;">
            USASpending may not have awards matching this term in the past 12 months. Try adjusting your search.
          </div>
          <div style="display:flex; flex-wrap:wrap; justify-content:center; gap:0.5rem; font-size:var(--text-sm); color:var(--text-tertiary);">
            <span style="color:var(--text-secondary);">Try:</span>
            <span>Broader keywords</span> · 
            <span>Company name instead of acronym</span> · 
            <span>NAICS code (e.g. 541512)</span>
          </div>
        </div>`;
    }

    // Clear feed
    const feed = document.getElementById('feedGrid');
    if (feed) feed.innerHTML = '';

    // Hide explainer boxes
    const pe = document.getElementById('primeExplainerBox');
    if (pe) pe.style.display = 'none';
  },

  // Keep legacy loader for any edge cases (Arti, etc.)
  showLoader(text, subtext) { document.getElementById('loaderText').innerText = text; document.getElementById('loaderSubtext').innerText = subtext || ''; document.getElementById('loader').style.display = 'flex'; },
  hideLoader() { document.getElementById('loader').style.display = 'none'; },

  // Toast notification system — replaces alert()
  toast(msg, type = 'info', duration = 3500) {
    const container = document.getElementById('toastContainer');
    const icons = { error: 'fas fa-exclamation-circle', success: 'fas fa-check-circle', warning: 'fas fa-exclamation-triangle', info: 'fas fa-info-circle' };
    const el = document.createElement('div');
    el.className = `toast toast-${type}`;
    el.innerHTML = `<i class="toast-icon ${icons[type] || icons.info}"></i><span class="toast-msg">${msg}</span>`;
    container.appendChild(el);
    setTimeout(() => {
      el.classList.add('toast-out');
      el.addEventListener('animationend', () => el.remove());
    }, duration);
  },
  transitionToApp() {
    const hero = document.getElementById('heroView');
    const appView = document.getElementById('appView');

    // Already in app view? Just update the search bar.
    if (appView.style.display === 'block') {
      document.getElementById('miniSearch').value = App.currentQuery;
      return;
    }

    hero.classList.add('slide-up');
    appView.style.display = 'block'; 
    document.getElementById('miniSearch').value = App.currentQuery;
    document.getElementById('dashboardContainer').classList.add('active'); 
    const dashContainer = document.getElementById('dashboardContainer');
    if (!dashContainer.querySelector('.hero-footer')) {
      const heroFooter = hero.querySelector('.hero-footer');
      if (heroFooter) {
        const footerClone = heroFooter.cloneNode(true);
        footerClone.removeAttribute('id'); 
        dashContainer.appendChild(footerClone);
      }
    }

    setTimeout(() => { 
      hero.style.display = 'none'; 
      hero.classList.add('hidden'); 
    }, 500);
  },
  
  shareLink(btn) {
    Utils.syncUrlState();
    const url = new URL(window.location);
    
    navigator.clipboard.writeText(url.toString()).then(() => {
      if (btn) {
        const originalHtml = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check"></i>';
        btn.style.background = '#78A890';
        setTimeout(() => {
          btn.style.background = '';
          btn.innerHTML = originalHtml;
        }, 1500);
      }
    });
  },

  shareBrief(btn) {
    const data = App.searchData.active;
    const query = App.currentQuery || 'Unknown';
    const totalValue = data.reduce((sum, c) => sum + (parseFloat(c['Award Amount']) || 0), 0);
    const agencies = new Set(data.map(c => c['Awarding Agency']).filter(Boolean));
    const vendors = new Set(data.map(c => c['Recipient Name']).filter(Boolean));
    
    const now = new Date();
    const d90 = new Date(now.getTime() + 90 * 24 * 60 * 60 * 1000);
    let expiringCount = 0, expiringValue = 0;
    data.forEach(c => {
      if (c['End Date']) {
        const end = new Date(c['End Date']);
        if (end >= now && end <= d90) { expiringCount++; expiringValue += parseFloat(c['Award Amount']) || 0; }
      }
    });
    
    Utils.syncUrlState();
    const url = new URL(window.location);
    
    let viewContext = '';
    if (App.drillState && App.drillState.level > 0 && App.drillState.path.length > 0) {
      viewContext = ` → ${App.drillState.path.map(p => p.name).join(' → ')}`;
    }

    // Top vendors by spend
    const vendorSpend = {};
    data.forEach(c => {
      const v = c['Recipient Name'];
      if (v) vendorSpend[v] = (vendorSpend[v] || 0) + (parseFloat(c['Award Amount']) || 0);
    });
    const topVendors = Object.entries(vendorSpend)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 3)
      .map(([name, spend]) => `${Utils.trunc(name, 25)} (${Utils.money(spend)})`)
      .join(', ');

    // Top agencies by spend
    const agencySpend = {};
    data.forEach(c => {
      const a = c['Awarding Agency'];
      if (a) agencySpend[a] = (agencySpend[a] || 0) + (parseFloat(c['Award Amount']) || 0);
    });
    const topAgencies = Object.entries(agencySpend)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 3)
      .map(([name]) => Utils.trunc(name, 30))
      .join(', ');

    let brief = `GOVHOO | ${query.toUpperCase()}${viewContext}\n`;
    brief += `───────────────\n`;
    brief += `AWARDS   ${Utils.money(totalValue)} across ${data.length} contracts\n`;
    if (topAgencies) brief += `BUYERS   ${topAgencies}\n`;
    if (topVendors) brief += `VENDORS  ${topVendors}\n`;
    if (expiringCount > 0) {
      brief += `EXPIRING ${expiringCount} contracts <90 days (${Utils.money(expiringValue)})\n`;
    }
    brief += `───────────────\n`;
    brief += url.toString();
    
    navigator.clipboard.writeText(brief).then(() => {
      if (btn) {
        const originalHtml = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check"></i>';
        btn.style.background = '#78A890';
        
        setTimeout(() => {
          btn.style.background = '';
          btn.innerHTML = originalHtml;
        }, 1500);
      }
    });
	}
};
// ==================== BUBBLE CHART (Drill-Synced) ====================
App.bubbleMode = 'auto'; // 'auto' = follows drill state, or manual override

App.bubbleChartType = 'bubbles';

App.setBubbleChartType = function(type) {
  App.bubbleChartType = type;
  document.getElementById('chartTypeBubbles').classList.toggle('active', type === 'bubbles');
  document.getElementById('chartTypeTreemap').classList.toggle('active', type === 'treemap');
  App.renderBubbleChart();
};

App.setBubbleMode = function(mode) {
  App.bubbleMode = mode;
  // Update toggle buttons
  document.getElementById('bubbleToggleVendors').classList.toggle('active', mode === 'vendors');
  document.getElementById('bubbleToggleAgencies').classList.toggle('active', mode === 'agencies');
  document.getElementById('bubbleToggleSubAgencies').classList.toggle('active', mode === 'subagencies');
  App.renderBubbleChart();
};

// Determine the effective bubble view based on drill state + manual override
App.getEffectiveBubbleMode = function() {
  if (App.bubbleMode !== 'auto') return App.bubbleMode;
  const drill = App.drillState || {};
  if (drill.level === 0) return 'vendors';
  if (drill.level === 1) return 'subagencies';
  return 'vendors';
};

// Update bubble toggle buttons to reflect current drill context
App.updateBubbleToggles = function() {
  const drill = App.drillState || {};
  const vendorsBtn = document.getElementById('bubbleToggleVendors');
  const agenciesBtn = document.getElementById('bubbleToggleAgencies');
  const subAgenciesBtn = document.getElementById('bubbleToggleSubAgencies');
  
  // Show sub-agencies toggle only when drilled into an agency
  if (subAgenciesBtn) {
    subAgenciesBtn.style.display = drill.level >= 1 ? 'inline-block' : 'none';
  }
  
  // Determine effective mode
  const effective = App.getEffectiveBubbleMode();
  
  vendorsBtn.classList.toggle('active', effective === 'vendors');
  agenciesBtn.classList.toggle('active', effective === 'agencies');
  if (subAgenciesBtn) subAgenciesBtn.classList.toggle('active', effective === 'subagencies');
  
  // Update subtitle
  const subtitle = document.getElementById('bubbleChartSubtitle');
  if (subtitle) {
    const modeLabels = {
      'agencies': 'Spending concentration by agency · Funded value',
      'subagencies': 'Spending concentration by sub-agency · Funded value',
      'vendors': 'Market concentration by vendor · Funded value'
    };
    subtitle.textContent = modeLabels[effective] || 'Market concentration by vendor and agency · Funded value';
  }
};

// Render bubble breadcrumb (synced with Sankey drill state)
App.renderBubbleBreadcrumb = function() {
  const bc = document.getElementById('bubbleBreadcrumb');
  const inner = document.getElementById('bubbleBreadcrumbInner');
  if (!bc || !inner) return;
  
  const drill = App.drillState || {};
  
  if (drill.level === 0) {
    bc.style.display = 'none';
    return;
  }
  
  bc.style.display = 'block';
  
  let html = `<div class="bubble-bc-item" onclick="App.resetDrill()"> All</div>`;
  
  if (drill.path && drill.path.length > 0) {
    drill.path.forEach((step, i) => {
      const isLast = i === drill.path.length - 1;
      const icon = step.type === 'agency' ? 'fa-landmark' : step.type === 'sub' ? 'fa-sitemap' : 'fa-building';
      const clickAction = isLast ? '' : `onclick="App.drillToLevel(${i + 1})"`;
      html += `<span class="bubble-bc-sep"></span>`;
      html += `<div class="bubble-bc-item ${isLast ? 'active' : ''}" ${clickAction}> ${Utils.trunc(step.name, 30)}</div>`;
    });
  }
  
  inner.innerHTML = html;
};

App.renderBubbleChart = function() {
  const container = document.getElementById('bubbleChartContainer');
  const panel = document.getElementById('bubbleChartPanel');
  if (!container || !panel) return;
  
  const data = App.searchData.active;
  if (!data || data.length === 0) {
    panel.style.display = 'none';
    return;
  }
  
  panel.style.display = 'block';
  
  // Update toggles and breadcrumb to reflect drill state
  App.updateBubbleToggles();
  App.renderBubbleBreadcrumb();
  
  const drill = App.drillState || {};
  const effective = App.getEffectiveBubbleMode();
  
  // Aggregate data based on effective mode
  const entityMap = {};
  let totalSpend = 0;
  
  data.forEach(award => {
    let key;
    if (effective === 'agencies') {
      key = award['Awarding Agency'] || 'Unknown';
    } else if (effective === 'subagencies') {
      key = award['Awarding Sub Agency'] || award['Awarding Agency'] || 'Unknown';
    } else {
      key = award['Recipient Name'] || 'Unknown';
    }
    const amount = parseFloat(award['Award Amount']) || 0;
    
    if (!entityMap[key]) {
      entityMap[key] = { 
        name: key, 
        spend: 0, 
        count: 0,
        agencies: new Set(),
        subAgencies: new Set(),
        vendors: new Set(),
        // Track the parent agency for sub-agency bubbles
        parentAgency: null
      };
    }
    entityMap[key].spend += amount;
    entityMap[key].count++;
    entityMap[key].agencies.add(award['Awarding Agency'] || 'Unknown');
    entityMap[key].subAgencies.add(award['Awarding Sub Agency'] || '');
    entityMap[key].vendors.add(award['Recipient Name'] || 'Unknown');
    if (effective === 'subagencies') {
      entityMap[key].parentAgency = award['Awarding Agency'] || 'Unknown';
    }
    totalSpend += amount;
  });
  
  // Convert to array and sort
  let entities = Object.values(entityMap)
    .filter(e => e.spend > 0)
    .sort((a, b) => b.spend - a.spend)
    .slice(0, 50);
  
  if (entities.length === 0) {
    panel.style.display = 'none';
    return;
  }
  
  // Convert Sets to counts
  entities.forEach(e => {
    e.agencyCount = e.agencies ? e.agencies.size : 0;
    e.subAgencyCount = e.subAgencies ? e.subAgencies.size : 0;
    e.vendorCount = e.vendors ? e.vendors.size : 0;
    delete e.agencies;
    delete e.subAgencies;
    delete e.vendors;
  });
  
  // --- Update header stats ---
  const uniqueAgencies = new Set(data.map(a => a['Awarding Agency'])).size;
  const uniqueVendors = new Set(data.map(a => a['Recipient Name'])).size;
  const volEl = document.getElementById('bubble-stat-vol');
  const agEl = document.getElementById('bubble-stat-agencies');
  const ctEl = document.getElementById('bubble-stat-count');
  const vnEl = document.getElementById('bubble-stat-vendors');
  const enEl = document.getElementById('bubble-stat-entities');
  const enLabelEl = document.getElementById('bubble-stat-entities-label');
  const subtitleEl = document.getElementById('bubbleChartSubtitle');
  
  if (volEl) Utils.countUp(volEl, totalSpend, Utils.money);
if (agEl) Utils.countUp(agEl, uniqueAgencies);
if (ctEl) Utils.countUp(ctEl, data.length);
if (vnEl) Utils.countUp(vnEl, uniqueVendors);
if (enEl) Utils.countUp(enEl, entities.length);
  if (subtitleEl) {
    const query = App.currentQuery ? '"' + App.currentQuery.toUpperCase() + '" · ' : '';
    const modeLabel = { agencies: 'Agencies', subagencies: 'Sub-Agencies', vendors: 'Vendors' };
    subtitleEl.textContent = query + 'Concentration by ' + (modeLabel[effective] || 'vendor').toLowerCase() + ' · Funded value';
  }
  
  // Clear previous
  const tooltip = document.getElementById('bubbleTooltip');
  container.querySelectorAll('svg').forEach(s => s.remove());
  
  // Dimensions
  const rect = container.getBoundingClientRect();
  const w = Math.max(rect.width || 600, 300);
  const h = Math.max(420, Math.min(w * 0.7, 600));
  
  // Color palette — Govhoo vintage chalk tones
  const bubbleColors = [
    '#8A9B94', '#7B6D8D', '#5B7C99', '#E07A5F',
    '#D98895', '#3D405B', '#F2E8CF', '#A8B5B0',
    '#778DA9', '#8C8577'
];

  // Shared tooltip + click handler builder (touch-aware)
  const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
  let touchSelectedEntity = null; // Track which entity is "focused" on touch

  function attachInteractions(selection) {
    attachChartInteractions(selection, svg, tooltip, container, w, h, isTouchDevice,
      function(entity) {
        const share = totalSpend > 0 ? ((entity.spend / totalSpend) * 100).toFixed(1) : '0';
        let metaText;
        if (effective === 'agencies') metaText = `${entity.count} awards · ${entity.vendorCount} vendors · ${share}%`;
        else if (effective === 'subagencies') metaText = `${entity.count} awards · ${entity.vendorCount} vendors · ${share}%`;
        else metaText = `${entity.count} awards · ${entity.agencyCount} agencies · ${share}%`;
        let drillHint = '';
        if (effective === 'agencies') drillHint = `<div style="color:var(--accent);font-size:var(--text-xs);margin-top:4px;">${isTouchDevice ? 'Tap again' : 'Click'} to drill into sub-agencies →</div>`;
        else if (effective === 'subagencies') drillHint = `<div style="color:var(--accent);font-size:var(--text-xs);margin-top:4px;">${isTouchDevice ? 'Tap again' : 'Click'} to drill into vendors →</div>`;
        else if (effective === 'vendors' && drill.level < 3) drillHint = `<div style="color:var(--accent);font-size:var(--text-xs);margin-top:4px;">${isTouchDevice ? 'Tap again' : 'Click'} to focus on this vendor →</div>`;
        return `<div class="bubble-tooltip-name">${entity.name}</div>
          <div class="bubble-tooltip-amount">${Utils.money(entity.spend)}</div>
          <div class="bubble-tooltip-meta">${metaText}</div>${drillHint}`;
      },
      function(entity) {
        if (effective === 'agencies') { App.bubbleMode = 'auto'; App.drillToAgency(entity.name); }
        else if (effective === 'subagencies') { App.bubbleMode = 'auto'; App.drillToSubAgency(entity.name); }
        else { App.drillDown(entity.name); }
      },
      { touchStateGet: () => touchSelectedEntity, touchStateSet: v => { touchSelectedEntity = v; } }
    );
  }

  // Create SVG
  const svg = d3.select(container)
    .append('svg')
    .attr('width', w)
    .attr('height', h)
    .attr('viewBox', `0 0 ${w} ${h}`);

  // ============ TREEMAP ============
  if (App.bubbleChartType === 'treemap') {
    const hierarchy = d3.hierarchy({ children: entities })
      .sum(d => d.spend)
      .sort((a, b) => b.value - a.value);

    d3.treemap()
      .size([w, h])
      .paddingInner(2)
      .paddingOuter(3)
      .round(true)(hierarchy);

    const cells = svg.selectAll('.treemap-cell')
      .data(hierarchy.leaves())
      .join('g')
      .attr('class', 'treemap-cell')
      .attr('transform', d => `translate(${d.x0},${d.y0})`);

    // Clip path per cell to contain text
    cells.append('clipPath')
      .attr('id', (d, i) => `tm-clip-${i}`)
      .append('rect')
      .attr('width', d => Math.max(0, d.x1 - d.x0))
      .attr('height', d => Math.max(0, d.y1 - d.y0))
      .attr('rx', 3);

    cells.append('rect')
      .attr('width', d => Math.max(0, d.x1 - d.x0))
      .attr('height', d => Math.max(0, d.y1 - d.y0))
      .attr('fill', (d, i) => bubbleColors[i % bubbleColors.length])
      .attr('opacity', 0.85)
      .attr('rx', 3)
      .attr('stroke', 'rgba(241, 238, 233, 0.08)')
      .attr('stroke-width', 1);

    // Text group clipped to cell bounds
    const textGroup = cells.append('g')
      .attr('clip-path', (d, i) => `url(#tm-clip-${i})`);

    // Word-wrap helper: splits name into lines that fit cell width at given font size
    // Render name + amount with word wrap
    textGroup.each(function(d) {
      const cellW = d.x1 - d.x0;
      const cellH = d.y1 - d.y0;
      if (cellW < 40 || cellH < 25) return;

      const g = d3.select(this);
      const layout = ChartUtils.fitTreemapText(d);
      const startY = (cellH - layout.totalH) / 2 + layout.fontSize;

      // Name lines
      layout.nameLines.forEach((line, i) => {
        g.append('text')
          .attr('class', 'bubble-label')
          .attr('x', cellW / 2)
          .attr('y', startY + i * layout.lineH)
          .attr('font-size', layout.fontSize + 'px')
          .attr('font-weight', '700')
          .text(line);
      });

      // Dollar amount below name
      if (cellH > 40) {
        g.append('text')
          .attr('class', 'bubble-amount-label')
          .attr('x', cellW / 2)
          .attr('y', startY + layout.nameLines.length * layout.lineH + 4)
          .attr('font-size', layout.amountFs + 'px')
          .attr('font-weight', '800')
          .attr('fill', 'rgba(240, 238, 234, 0.95)')
          .text(Utils.money(d.data.spend));
      }
    });

    attachInteractions(cells);

    // Entrance animation
    cells.selectAll('rect')
      .attr('opacity', 0)
      .transition()
      .duration(500)
      .delay((d, i) => i * 12)
      .ease(d3.easeCubicOut)
      .attr('opacity', 0.85);

    cells.selectAll('text')
      .attr('opacity', 0)
      .transition()
      .duration(400)
      .delay((d, i) => 200 + i * 12)
      .attr('opacity', 1);

    return;
  }

  // ============ BUBBLE PACK ============
  const hierarchy = d3.hierarchy({ children: entities })
    .sum(d => d.spend)
    .sort((a, b) => b.value - a.value);
  
  const pack = d3.pack()
    .size([w, h])
    .padding(1.5);
  
  const root = pack(hierarchy);

  // Nodes
  const nodes = svg.selectAll('.bubble-node')
    .data(root.leaves())
    .join('g')
    .attr('class', 'bubble-node')
    .attr('transform', d => `translate(${d.x},${d.y})`);
  
  // Circles
  nodes.append('circle')
    .attr('r', d => d.r)
    .attr('fill', (d, i) => bubbleColors[i % bubbleColors.length])
    .attr('opacity', 0.85)
    .attr('stroke', 'rgba(241, 238, 233, 0.1)')
    .attr('stroke-width', 1);
  
  // Word-wrap for circles: fits name + amount inside bubble diameter
  // Render name + amount with word wrap inside circles
  nodes.each(function(d) {
    if (d.r < 25) return;
    const g = d3.select(this);
    const layout = ChartUtils.fitCircleText(d);
    if (!layout) return;

    const startY = -(layout.totalH / 2) + layout.fontSize * 0.8;

    layout.nameLines.forEach((line, i) => {
      g.append('text')
        .attr('class', 'bubble-label')
        .attr('y', startY + i * layout.lineH)
        .attr('font-size', layout.fontSize + 'px')
        .attr('font-weight', '700')
        .text(line);
    });

    if (d.r > 35) {
      g.append('text')
        .attr('class', 'bubble-amount-label')
        .attr('y', startY + layout.nameLines.length * layout.lineH + 4)
        .attr('font-size', layout.amountFs + 'px')
        .attr('font-weight', '800')
        .attr('fill', 'rgba(240, 238, 234, 0.95)')
        .text(Utils.money(d.data.spend));
    }
  });
  
  // Tooltip interactions
  attachInteractions(nodes);
  
  // Entrance animation
  nodes.selectAll('circle')
    .attr('r', 0)
    .transition()
    .duration(600)
    .delay((d, i) => i * 15)
    .ease(d3.easeCubicOut)
    .attr('r', d => d.r);
  
  nodes.selectAll('text')
    .attr('opacity', 0)
    .transition()
    .duration(400)
    .delay((d, i) => 300 + i * 15)
    .attr('opacity', 1);
};

// ==================== SUBAWARD BUBBLE CHART ====================
App.subBubbleMode = 'primes';

App.subBubbleChartType = 'bubbles';

App.setSubBubbleChartType = function(type) {
  App.subBubbleChartType = type;
  document.getElementById('subChartTypeBubbles').classList.toggle('active', type === 'bubbles');
  document.getElementById('subChartTypeTreemap').classList.toggle('active', type === 'treemap');
  App.renderSubBubbleChart();
};

App.setSubBubbleMode = function(mode) {
  App.subBubbleMode = mode;
  document.getElementById('subBubbleTogglePrimes').classList.toggle('active', mode === 'primes');
  document.getElementById('subBubbleToggleSubs').classList.toggle('active', mode === 'subs');
  App.renderSubBubbleChart();
};

App.renderSubBubbleBreadcrumb = function() {
  const bc = document.getElementById('subBubbleBreadcrumb');
  const inner = document.getElementById('subBubbleBreadcrumbInner');
  if (!bc || !inner) return;
  
  const drill = App.subawardDrillState || {};
  if (!drill.level || drill.level === 0) {
    bc.style.display = 'none';
    return;
  }
  
  bc.style.display = 'block';
  const typeIcons = { agency: 'fa-landmark', subagency: 'fa-sitemap', prime: 'fa-building', sub: 'fa-handshake' };
  
  let html = `<div class="bubble-bc-item" onclick="App.resetSubawardDrill()"> All Subawards</div>`;
  
  if (drill.path && drill.path.length > 0) {
    drill.path.forEach((step, i) => {
      const isLast = i === drill.path.length - 1;
      const icon = typeIcons[step.type] || 'fa-circle';
      const clickAction = isLast ? '' : `onclick="App.drillSubawardToLevel(${i})"`;
      html += `<span class="bubble-bc-sep"></span>`;
      html += `<div class="bubble-bc-item ${isLast ? 'active' : ''}" ${clickAction}> ${Utils.trunc(step.name, 30)}</div>`;
    });
  }
  
  inner.innerHTML = html;
};

App.renderSubBubbleChart = function() {
  const container = document.getElementById('subBubbleContainer');
  const panel = document.getElementById('subBubblePanel');
  if (!container || !panel) return;
  
  const subawards = App.forecastData?.subawards;
  if (!subawards || subawards.length === 0) {
    panel.style.display = 'none';
    return;
  }
  
  // Apply subaward drill filter (same logic as renderSubawardSankey)
  let filtered = applySubDrillFilter(subawards, App.subawardDrillState || {});
  
  if (filtered.length === 0) {
    panel.style.display = 'none';
    return;
  }
  
  panel.style.display = 'block';
  App.renderSubBubbleBreadcrumb();
  
  const mode = App.subBubbleMode || 'primes';
  
  // Aggregate
  const entityMap = {};
  let totalSpend = 0;
  const allPrimes = new Set();
  const allSubs = new Set();
  
  filtered.forEach(sub => {
    const prime = sub['Prime Recipient Name'] || 'Unknown Prime';
    const subName = sub['Sub-Awardee Name'] || 'Unknown Sub';
    const amount = parseFloat(sub['Sub-Award Amount']) || 0;
    const key = mode === 'primes' ? prime : subName;
    
    allPrimes.add(prime);
    allSubs.add(subName);
    
    if (!entityMap[key]) {
      entityMap[key] = { name: key, spend: 0, count: 0, partners: new Set() };
    }
    entityMap[key].spend += amount;
    entityMap[key].count++;
    entityMap[key].partners.add(mode === 'primes' ? subName : prime);
    totalSpend += amount;
  });
  
  let entities = Object.values(entityMap)
    .filter(e => e.spend > 0)
    .sort((a, b) => b.spend - a.spend)
    .slice(0, 40);
  
  if (entities.length === 0) { panel.style.display = 'none'; return; }
  
  entities.forEach(e => {
    e.partnerCount = e.partners ? e.partners.size : 0;
    delete e.partners;
  });
  
  // Update stats
  const subtitle = document.getElementById('subBubbleSubtitle');
  if (subtitle) {
    const query = App.currentQuery ? '"' + App.currentQuery.toUpperCase() + '" · ' : '';
    subtitle.textContent = query + 'Top ' + (mode === 'primes' ? 'Primes' : 'Subcontractors') + ' · Individual Transaction Value';
  }
  const els = {
    vol: document.getElementById('sub-bubble-stat-vol'),
    primes: document.getElementById('sub-bubble-stat-primes'),
    subs: document.getElementById('sub-bubble-stat-subs'),
    records: document.getElementById('sub-bubble-stat-records')
  };
  if (els.vol) Utils.countUp(els.vol, totalSpend, Utils.money);
  if (els.primes) els.primes.innerText = allPrimes.size;
  if (els.subs) els.subs.innerText = allSubs.size;
  if (els.records) els.records.innerText = filtered.length;
  
  // Clear previous
  const tooltip = document.getElementById('subBubbleTooltip');
  container.querySelectorAll('svg').forEach(s => s.remove());
  
  // Dimensions
  const rect = container.getBoundingClientRect();
  const w = Math.max(rect.width || 600, 300);
  const h = Math.max(380, Math.min(w * 0.65, 550));
  
  const bubbleColors = [
    '#8A9B94', '#7B6D8D', '#5B7C99', '#E07A5F',
    '#D98895', '#3D405B', '#F2E8CF', '#A8B5B0',
    '#778DA9', '#8C8577'
];

  // Shared tooltip + click (touch-aware)
  const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
  let subTouchSelected = null;

  function attachSubInteractions(selection) {
    attachChartInteractions(selection, svg, tooltip, container, w, h, isTouchDevice,
      function(e) {
        const share = totalSpend > 0 ? ((e.spend / totalSpend) * 100).toFixed(1) : '0';
        const partnerLabel = mode === 'primes' ? 'subs' : 'primes';
        return `<div class="bubble-tooltip-name">${e.name}</div>
          <div class="bubble-tooltip-amount">${Utils.money(e.spend)}</div>
          <div class="bubble-tooltip-meta">${e.count} subawards · ${e.partnerCount} ${partnerLabel} · ${share}%</div>
          <div style="color:var(--accent);font-size:var(--text-xs);margin-top:4px;">${isTouchDevice ? 'Tap again' : 'Click'} to drill →</div>`;
      },
      function(e) { App.drillSubaward(e.name, mode === 'primes' ? 'prime' : 'sub'); },
      { touchStateGet: () => subTouchSelected, touchStateSet: v => { subTouchSelected = v; } }
    );
  }

  const svg = d3.select(container)
    .append('svg')
    .attr('width', w)
    .attr('height', h)
    .attr('viewBox', `0 0 ${w} ${h}`);

  // ============ SUB TREEMAP ============
  if (App.subBubbleChartType === 'treemap') {
    const hierarchy = d3.hierarchy({ children: entities })
      .sum(d => d.spend)
      .sort((a, b) => b.value - a.value);

    d3.treemap()
      .size([w, h])
      .paddingInner(2)
      .paddingOuter(3)
      .round(true)(hierarchy);

    const cells = svg.selectAll('.treemap-cell')
      .data(hierarchy.leaves())
      .join('g')
      .attr('class', 'treemap-cell')
      .attr('transform', d => `translate(${d.x0},${d.y0})`);

    cells.append('clipPath')
      .attr('id', (d, i) => `stm-clip-${i}`)
      .append('rect')
      .attr('width', d => Math.max(0, d.x1 - d.x0))
      .attr('height', d => Math.max(0, d.y1 - d.y0))
      .attr('rx', 3);

    cells.append('rect')
      .attr('width', d => Math.max(0, d.x1 - d.x0))
      .attr('height', d => Math.max(0, d.y1 - d.y0))
      .attr('fill', (d, i) => bubbleColors[i % bubbleColors.length])
      .attr('opacity', 0.85)
      .attr('rx', 3)
      .attr('stroke', 'rgba(241, 238, 233, 0.08)')
      .attr('stroke-width', 1);

    const textGroup = cells.append('g')
      .attr('clip-path', (d, i) => `url(#stm-clip-${i})`);

    textGroup.each(function(d) {
      const cellW = d.x1 - d.x0;
      const cellH = d.y1 - d.y0;
      if (cellW < 40 || cellH < 25) return;
      const g = d3.select(this);
      const layout = ChartUtils.fitTreemapText(d);
      const startY = (cellH - layout.totalH) / 2 + layout.fontSize;
      layout.nameLines.forEach((line, i) => {
        g.append('text')
          .attr('class', 'bubble-label')
          .attr('x', cellW / 2)
          .attr('y', startY + i * layout.lineH)
          .attr('font-size', layout.fontSize + 'px')
          .attr('font-weight', '700')
          .text(line);
      });
      if (cellH > 40) {
        g.append('text')
          .attr('class', 'bubble-amount-label')
          .attr('x', cellW / 2)
          .attr('y', startY + layout.nameLines.length * layout.lineH + 4)
          .attr('font-size', layout.amountFs + 'px')
          .attr('font-weight', '800')
          .attr('fill', 'rgba(240, 238, 234, 0.95)')
          .text(Utils.money(d.data.spend));
      }
    });

    attachSubInteractions(cells);

    cells.selectAll('rect')
      .attr('opacity', 0).transition().duration(500).delay((d, i) => i * 12)
      .ease(d3.easeCubicOut).attr('opacity', 0.85);
    cells.selectAll('text')
      .attr('opacity', 0).transition().duration(400).delay((d, i) => 200 + i * 12)
      .attr('opacity', 1);
    return;
  }

  // ============ SUB BUBBLE PACK ============
  const hierarchy = d3.hierarchy({ children: entities })
    .sum(d => d.spend)
    .sort((a, b) => b.value - a.value);
  
  const pack = d3.pack().size([w, h]).padding(1.5);
  const root = pack(hierarchy);

  const nodes = svg.selectAll('.bubble-node')
    .data(root.leaves())
    .join('g')
    .attr('class', 'bubble-node')
    .attr('transform', d => `translate(${d.x},${d.y})`);
  
  nodes.append('circle')
    .attr('r', d => d.r)
    .attr('fill', (d, i) => bubbleColors[i % bubbleColors.length])
    .attr('opacity', 0.85)
    .attr('stroke', 'rgba(241, 238, 233, 0.1)')
    .attr('stroke-width', 1);
  
  nodes.each(function(d) {
    if (d.r < 25) return;
    const g = d3.select(this);
    const layout = ChartUtils.fitCircleText(d);
    if (!layout) return;
    const startY = -(layout.totalH / 2) + layout.fontSize * 0.8;
    layout.nameLines.forEach((line, i) => {
      g.append('text')
        .attr('class', 'bubble-label')
        .attr('y', startY + i * layout.lineH)
        .attr('font-size', layout.fontSize + 'px')
        .attr('font-weight', '700')
        .text(line);
    });
    if (d.r > 35) {
      g.append('text')
        .attr('class', 'bubble-amount-label')
        .attr('y', startY + layout.nameLines.length * layout.lineH + 4)
        .attr('font-size', layout.amountFs + 'px')
        .attr('font-weight', '800')
        .attr('fill', 'rgba(240, 238, 234, 0.95)')
        .text(Utils.money(d.data.spend));
    }
  });

  attachSubInteractions(nodes);
  
  // Entrance animation
  nodes.selectAll('circle')
    .attr('r', 0).transition().duration(600).delay((d, i) => i * 15)
    .ease(d3.easeCubicOut).attr('r', d => d.r);
  nodes.selectAll('text')
    .attr('opacity', 0).transition().duration(400).delay((d, i) => 300 + i * 15)
    .attr('opacity', 1);
};

// ==================== PRESENTATION MODE ====================
App.presentationMode = false;

App.togglePresentationMode = function() {
  App.presentationMode = !App.presentationMode;
  const wrapper = document.getElementById('searchModeView');
  const btn = document.getElementById('presToggleBtn');
  
  if (App.presentationMode) {
    wrapper.classList.add('presentation-mode');
    btn.classList.add('active');
    btn.innerHTML = '<i class="fas fa-moon"></i>';
  } else {
    wrapper.classList.remove('presentation-mode');
    btn.classList.remove('active');
    btn.innerHTML = '<i class="fas fa-rainbow"></i>';
  }
  
  // Re-render charts so D3 inline fills respect the mode
  const textColor = App.presentationMode ? '#1A1A1A' : '#F1EEE9';
  
  // Prime Sankey labels
  d3.select('#chartContainer').selectAll('text').style('fill', textColor);
  // Subaward Sankey labels
  d3.select('#subcontractingBody').selectAll('text').style('fill', textColor);
  
  // Bubble charts re-render cleanly via CSS class overrides (no inline fill)
  // but re-render to be safe
  App.renderBubbleChart();
  if (App.forecastData?.subawards) App.renderSubBubbleChart();
};

App.init();

</script>
</body>
</html>