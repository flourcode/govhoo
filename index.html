<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#000000">
  
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 rx=%2220%22 fill=%22%23000000%22/><text y=%2250%%22 x=%2250%%22 font-size=%2285%22 font-family=%22'JetBrains Mono', monospace%22 font-weight=%22700%22 fill=%22%23D4C4A8%22 text-anchor=%22middle%22 dominant-baseline=%22central%22>G</text></svg>">
  <title>Govhoo - Federal Contract Intelligence & Sales Planning</title>
  <meta name="title" content="Govhoo - Federal Contract Intelligence & Sales Planning">
  <meta name="description" content="Free Federal Sales Intelligence & FY2026 Strategic Planning. Follow the money with live USASpending data analysis.">
  <meta name="keywords" content="federal sales, usaspending search, government contracts, defense contracts, federal jobs, expiring contracts, federal territory planning, incumbent search">
  
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://govhoo.com/">
  <meta property="og:title" content="Govhoo | Follow the Money">
  <meta property="og:description" content="Analyze federal agency award flow and generate AI-ready sales plans.">
  <meta property="og:image" content="https://govhoo.com/social.png">
  
  <meta property="twitter:card" content="summary_large_image">
  <meta property="twitter:title" content="Govhoo | Federal Contract Intelligence">
  <meta property="twitter:description" content="Build your federal sales plan with live obligation data and trend forecasting.">
  
  <link rel="canonical" href="https://govhoo.com/">
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <script src="https://kit.fontawesome.com/8ef6ca8a5d.js" crossorigin="anonymous"></script>
  
  <link rel="preconnect" href="https://api.usaspending.gov">
  <link rel="dns-prefetch" href="https://api.usaspending.gov">
  <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js" as="script">
  <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/d3-sankey/0.12.3/d3-sankey.min.js" as="script">
  <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js" as="script">
  
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-T343V4RFHV"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-T343V4RFHV');
  </script>
<style>
:root {
  --bg-app: #000000;
  --bg-card: #121212; 
  --bg-input: #1a1a1a;
  --border: #333333;
  --text-primary: #eee7e4;
  --text-muted: #9A9A9A;
  --accent: #999999;
  --accent-dim: rgba(153, 153, 153, 0.1);
  --link: #8DA0CB;
  --success: #5F8055;
  --danger: #A64438;
  --safe-top: env(safe-area-inset-top, 20px);
  --safe-bottom: env(safe-area-inset-bottom, 20px);
}
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

body {
  margin: 0; padding: 0;
  font-family: 'Inter', sans-serif;
  background: var(--bg-app);
  color: var(--text-primary);
  min-height: 100vh;
  overflow-x: hidden;
  width: 100%;
}

.hero-view {
  position: fixed; inset: 0; z-index: 200; 
  display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
  padding: 2rem; padding-top: max(8vh, var(--safe-top)); 
  transition: transform 0.5s cubic-bezier(0.16, 1, 0.3, 1);
  overflow-y: auto; 
}
.hero-view.slide-up { transform: translateY(-100%); }
.hero-view.hidden { display: none; }

.terminal-logo {
  font-family: 'JetBrains Mono', monospace; font-size: 2.5rem; font-weight: 700;
  margin-bottom: 0.5rem; color: var(--text-primary); letter-spacing: -1px; text-align: center;
}
.terminal-logo span { color: var(--accent); }

.hero-subtitle {
  margin-bottom: 2rem; text-align: center;
  font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; color: var(--text-muted);
}

.search-box-container { 
  position: relative; z-index: 210; 
  width: 100%; max-width: 500px; margin-top: 1.5rem; 
}

.main-input {
  width: 100%; background: var(--bg-input); border: 1px solid var(--border);
  padding: 1.25rem 1rem; font-size: 1.1rem; color: white; border-radius: 4px;
  font-family: 'Inter', sans-serif; transition: border-color 0.2s; -webkit-appearance: none;
}
.main-input:focus { outline: none; border-color: var(--accent); background: #222; }

.btn-row { display: flex; gap: 0.75rem; margin-top: 1rem; }
.btn-primary, .btn-secondary {
  flex: 1; padding: 1rem;
  font-weight: 700; border: none; border-radius: 4px;
  font-size: 0.9rem; cursor: pointer; text-transform: uppercase; letter-spacing: 1px;
  display: flex; align-items: center; justify-content: center; gap: 0.5rem;
}
.btn-primary { background: var(--accent); color: #000; }
.btn-secondary { background: transparent; color: var(--accent); border: 1px solid var(--accent); }
.btn-primary:hover, .btn-secondary:hover { opacity: 0.9; }

.autocomplete-wrapper { position: relative; }
.autocomplete-dropdown {
  position: absolute; top: 100%; left: 0; right: 0; z-index: 220;
  background: var(--bg-card); border: 1px solid var(--border); border-top: none;
  border-radius: 0 0 4px 4px; max-height: 320px; overflow-y: auto;
  display: none;
}
.autocomplete-dropdown.active { display: block; }
.autocomplete-section { padding: 0.5rem 0; border-bottom: 1px solid var(--border); }
.autocomplete-section:last-child { border-bottom: none; }
.autocomplete-section-label {
  padding: 0.25rem 1rem; font-size: 0.65rem; color: var(--text-muted);
  text-transform: uppercase; letter-spacing: 1px; font-family: 'JetBrains Mono', monospace;
}
.autocomplete-item {
  padding: 0.6rem 1rem; cursor: pointer; display: flex; align-items: center; gap: 0.75rem;
  font-size: 0.9rem; color: var(--text-primary); transition: background 0.1s;
}
.autocomplete-item:hover, .autocomplete-item.selected { background: rgba(255,255,255,0.05); }
.autocomplete-item i { color: var(--text-muted); width: 16px; text-align: center; font-size: 0.8rem; }
.autocomplete-item-text { flex: 1; min-width: 0; }
.autocomplete-item-main { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.autocomplete-item-sub { font-size: 0.7rem; color: var(--text-muted); margin-top: 2px; }
.autocomplete-empty { padding: 1rem; text-align: center; color: var(--text-muted); font-size: 0.85rem; }

.app-header {
  position: sticky; top: 0; z-index: 100;
  background: rgba(0,0,0,0.95); backdrop-filter: blur(10px);
  padding: 0.75rem 1rem; padding-top: max(0.75rem, var(--safe-top));
  border-bottom: 1px solid var(--border);
  display: flex; justify-content: space-between; align-items: center; gap: 1rem;
}
.header-left { display: flex; align-items: center; gap: 1rem; flex: 1; min-width: 0; }
.logo-btn { font-family: 'JetBrains Mono'; font-weight: 700; color: white; cursor: pointer; flex-shrink: 0; }
.logo-btn:hover { color: var(--accent); }

.mini-search {
  background: var(--bg-input); border: 1px solid var(--border);
  color: white; padding: 0.5rem 1rem; border-radius: 4px;
  font-size: 0.9rem; flex: 1; min-width: 0;
}
.mini-search:focus { outline: none; border-color: var(--accent); }

.header-actions { display: flex; gap: 0.5rem; flex-shrink: 0; }
.icon-btn {
  background: var(--bg-input); border: 1px solid var(--border); color: var(--text-muted);
  width: 36px; height: 36px; border-radius: 4px;
  display: flex; align-items: center; justify-content: center; cursor: pointer;
}
.icon-btn:hover { border-color: var(--accent); color: var(--accent); }
.icon-btn.active { background: var(--accent-dim); color: var(--accent); border-color: var(--accent); }

.dashboard-container {
  padding: 1rem; padding-bottom: calc(2rem + var(--safe-bottom));
  max-width: 1400px; margin: 0 auto;
  display: none;
  width: 100%;
}
.dashboard-container.active { display: block; animation: fadeIn 0.8s forwards; }
@keyframes fadeIn { to { opacity: 1; } }

.mode-toggle {
  display: flex; gap: 0.5rem; margin-bottom: 1.5rem;
  background: var(--bg-card); padding: 0.5rem; border-radius: 4px; border: 1px solid var(--border);
}
.mode-btn {
  flex: 1; padding: 0.75rem; background: transparent; border: none;
  color: var(--text-muted); font-family: 'JetBrains Mono'; font-size: 0.85rem;
  cursor: pointer; border-radius: 4px; transition: all 0.2s;
  display: flex; align-items: center; justify-content: center; gap: 0.5rem;
}
.mode-btn.active { 
  background: var(--accent); 
  color: #000; 
  font-weight: 700; 
}
.mode-btn:hover:not(.active) { 
  color: var(--text-primary); 
}

.stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem; }
.stat-item {
  background: var(--bg-card); padding: 1rem; border-radius: 4px;
  border: 1px solid var(--border); text-align: center;
}
.stat-label { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.5rem; }
.stat-val { font-size: 1.25rem; font-weight: 700; font-family: 'JetBrains Mono'; color: white; }
.stat-sub { font-size: 0.7rem; color: var(--success); margin-top: 4px; }
.stat-sub.neutral { color: var(--text-muted); }
.stat-item-action:hover { background: var(--accent-dim); border-color: var(--accent) !important; }

.projection-summary { margin-top: 1rem; padding: 1rem; background: rgba(212, 196, 168, 0.05); border: 1px solid var(--accent); border-radius: 4px; font-size: 0.85rem; color: var(--text-primary); line-height: 1.5; }

.section-header { display: flex; align-items: center; justify-content: space-between; gap: 0.5rem; margin: 2rem 0 1rem 0; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem; flex-wrap: wrap; }
.section-title-group { display: flex; align-items: center; gap: 0.5rem; }
.section-title { font-family: 'JetBrains Mono', monospace; font-size: 0.9rem; font-weight: 700; color: var(--accent); text-transform: uppercase; letter-spacing: 1px; }
.section-subtitle { font-size: 0.75rem; color: var(--text-muted); font-style: italic; }

.buyer-list { display: flex; flex-direction: column; gap: 0; width: 100%; }
.buyer-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 0; border-bottom: 1px solid rgba(255,255,255,0.05); width: 100%; }
.buyer-item:last-child { border-bottom: none; }
.buyer-rank { width: 24px; height: 24px; background: var(--accent-dim); color: var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; font-weight: 700; flex-shrink: 0; }
.buyer-info { flex: 1; min-width: 0; }
.buyer-name { font-size: 0.85rem; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.buyer-stats { font-size: 0.7rem; color: var(--text-muted); margin-top: 2px; }
.buyer-amount { text-align: right; flex-shrink: 0; }
.buyer-spend { font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; font-weight: 600; color: var(--accent); }
.buyer-share { font-size: 0.7rem; color: var(--text-muted); }

/* Job Seeker Links */
.job-link { font-size: 0.65rem; color: var(--link); text-decoration: none; display: inline-flex; align-items: center; gap: 3px; padding: 2px 6px; border-radius: 3px; background: rgba(141, 160, 203, 0.1); border: 1px solid rgba(141, 160, 203, 0.2); transition: all 0.15s; }
.job-link:hover { background: rgba(141, 160, 203, 0.2); border-color: rgba(141, 160, 203, 0.4); color: #fff; }
.job-link i { font-size: 0.6rem; }

/* Skills in Demand */
.skills-demand { margin-top: 1rem; padding: 1rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; }
.skills-header { font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; color: var(--accent); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem; }
.skill-bar-container { margin-bottom: 0.5rem; }
.skill-bar-label { display: flex; justify-content: space-between; font-size: 0.75rem; margin-bottom: 4px; }
.skill-bar-name { color: var(--text-primary); font-weight: 500; }
.skill-bar-pct { color: var(--text-muted); font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; }
.skill-bar { height: 8px; background: rgba(255,255,255,0.08); border-radius: 4px; overflow: hidden; position: relative; }
.skill-bar-fill { height: 100%; background: linear-gradient(90deg, #8DA0CB 0%, #D4C4A8 100%); border-radius: 4px; transition: width 0.4s ease-out; min-width: 2px; }

/* Compact Winner List (Search View) */
.compact-winner-list { display: flex; flex-direction: column; gap: 0.6rem; }
.compact-winner-item { display: flex; align-items: flex-start; gap: 0.6rem; padding: 0.5rem; border-radius: 4px; background: rgba(255,255,255,0.02); }
.compact-winner-item:hover { background: rgba(255,255,255,0.05); }
.compact-winner-rank { width: 20px; height: 20px; background: var(--accent-dim); color: var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-family: 'JetBrains Mono', monospace; font-size: 0.6rem; font-weight: 700; flex-shrink: 0; margin-top: 2px; }
.compact-winner-info { flex: 1; min-width: 0; }
.compact-winner-name { font-size: 0.8rem; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 500; }
.compact-winner-meta { font-size: 0.65rem; color: var(--text-muted); font-family: 'JetBrains Mono', monospace; margin-top: 2px; }

/* Compact Location List (Search View) */
.compact-location-list { display: flex; flex-direction: column; gap: 0.5rem; }
.compact-location-item { display: flex; align-items: center; gap: 0.6rem; padding: 0.4rem 0.5rem; border-radius: 4px; background: rgba(255,255,255,0.02); }
.compact-location-item:hover { background: rgba(255,255,255,0.05); }
.compact-location-rank { width: 18px; height: 18px; background: rgba(141, 160, 203, 0.2); color: var(--link); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-family: 'JetBrains Mono', monospace; font-size: 0.55rem; font-weight: 700; flex-shrink: 0; }
.compact-location-info { flex: 1; min-width: 0; }
.compact-location-name { font-size: 0.75rem; color: var(--text-primary); font-weight: 500; }
.compact-location-meta { font-size: 0.6rem; color: var(--text-muted); font-family: 'JetBrains Mono', monospace; }

/* Job Intel Panel */
.job-intel-panel { background: linear-gradient(135deg, rgba(141, 160, 203, 0.05) 0%, rgba(212, 196, 168, 0.05) 100%); border: 1px solid var(--border); border-radius: 6px; padding: 1rem; }

.header-controls { display: flex; gap: 0.75rem; align-items: center; }
.time-badge { font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; color: var(--text-muted); border: 1px solid var(--border); padding: 4px 8px; border-radius: 4px; }
.filter-badge { display: none; background: var(--accent-dim); color: var(--accent); border: 1px solid var(--accent); padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; font-family: 'JetBrains Mono', monospace; cursor: pointer; align-items: center; gap: 6px; }
.filter-badge:hover { background: rgba(212, 196, 168, 0.2); }

.chart-wrapper { background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; padding: 1rem; width: 100%; overflow-x: auto; overflow-y: visible; }
.chart-container { width: 100%; min-height: 500px; height: auto; display: block; }

.feed-grid { display: flex; flex-direction: column; gap: 1rem; }
.deal-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; padding: 1.25rem; transition: transform 0.1s; }
.deal-card:active { transform: scale(0.99); }
.deal-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem; }
.deal-agency { font-size: 0.75rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase; background: rgba(255,255,255,0.05); padding: 2px 6px; border-radius: 4px; }
.deal-amount { font-family: 'JetBrains Mono', monospace; color: var(--accent); font-weight: 700; font-size: 1rem; }
.deal-desc { font-size: 1rem; font-weight: 600; margin-bottom: 0.5rem; line-height: 1.4; color: white; }
.deal-vendor { font-size: 0.85rem; color: #8DA0CB; margin-bottom: 0.75rem; font-family: 'JetBrains Mono', monospace; }
.deal-meta { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem; }
.meta-tag { font-size: 0.65rem; font-family: 'JetBrains Mono', monospace; padding: 3px 8px; border-radius: 3px; background: rgba(255,255,255,0.05); color: var(--text-muted); border: 1px solid var(--border); }
.meta-tag.psc { background: rgba(143, 182, 208, 0.15); border-color: rgba(143, 182, 208, 0.3); color: #8FB6D0; }
.meta-tag.mission-gap { font-weight: 600; }
.meta-tag.mission-gap.high { background: rgba(251, 128, 114, 0.15); border-color: rgba(251, 128, 114, 0.4); color: var(--danger); }
.meta-tag.mission-gap.medium { background: rgba(253, 216, 53, 0.15); border-color: rgba(253, 216, 53, 0.4); color: #FDD835; }
.meta-tag.mission-gap.low { background: rgba(255, 255, 255, 0.05); border-color: var(--border); color: var(--text-muted); }
.mission-gap-signals { font-size: 0.7rem; color: var(--text-muted); margin-top: 6px; font-style: italic; }
.mission-gap-filter { display: flex; align-items: center; gap: 0.5rem; }
.mission-gap-toggle { display: flex; align-items: center; gap: 0.4rem; padding: 4px 10px; background: transparent; border: 1px solid var(--border); border-radius: 4px; font-size: 0.7rem; font-family: 'JetBrains Mono', monospace; color: var(--text-muted); cursor: pointer; transition: all 0.2s; }
.mission-gap-toggle:hover { border-color: var(--accent); color: var(--accent); }
.mission-gap-toggle.active { background: rgba(251, 128, 114, 0.15); border-color: var(--danger); color: var(--danger); }
.mission-gap-toggle i { font-size: 0.65rem; }
.deal-footer { display: flex; justify-content: space-between; align-items: center; padding-top: 1rem; border-top: 1px solid #222; }
.deal-date { font-size: 0.75rem; color: var(--text-muted); }
.action-btn { background: var(--bg-input); color: var(--accent); text-decoration: none; padding: 0.5rem 1rem; border-radius: 4px; font-size: 0.8rem; font-weight: 600; border: 1px solid var(--border); display: flex; align-items: center; gap: 6px; }
.action-btn:hover { border-color: var(--accent); background: var(--accent-dim); }

.forecast-table-wrapper { background: var(--bg-card); border: 1px solid var(--border); overflow-x: auto; border-radius: 4px; width: 100%; }
.forecast-table { width: 100%; border-collapse: collapse; font-family: 'JetBrains Mono'; font-size: 0.8rem; }
.forecast-table th { text-align: left; padding: 1rem; color: var(--text-muted); border-bottom: 1px solid var(--border); }
.forecast-table td { padding: 1rem; border-bottom: 1px solid var(--border); color: var(--text-primary); }
.trend-pill { 
  padding: 2px 6px; 
  border-radius: 2px; 
  font-size: 0.7rem; 
  font-weight: 700;
  white-space: nowrap; /* Prevents text inside the pill from wrapping */
  display: inline-flex; /* Keeps icon and text together */
  align-items: center;
  gap: 2px;
}
.trend-up { color: var(--success); background: rgba(102, 194, 165, 0.1); }
.trend-down { color: var(--danger); background: rgba(251, 128, 114, 0.1); }

.insight-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 2rem; }
.insight-card { background: var(--bg-card); border: 1px solid var(--border); padding: 1rem; border-radius: 4px; }
.insight-val { font-size: 1.1rem; color: var(--text-primary); font-weight: 700; font-family: 'JetBrains Mono'; }
.insight-label { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.5rem; }

.view-section { display: none; }
.view-section.active { display: block; }

.loader { position: fixed; inset: 0; z-index: 300; background: rgba(0,0,0,0.9); display: none; flex-direction: column; align-items: center; justify-content: center; }
.spinner { width: 40px; height: 40px; border: 2px solid #333; border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }

.methodology-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; padding: 1.5rem; display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem; }
.method-item { padding-bottom: 1rem; border-bottom: 1px solid var(--border); }
.method-item:nth-last-child(-n+2) { border-bottom: none; padding-bottom: 0; }
.method-title { font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; font-weight: 700; color: var(--accent); margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem; }
.method-title i { font-size: 0.75rem; opacity: 0.7; }
.method-desc { font-size: 0.8rem; color: var(--text-muted); line-height: 1.5; }
.method-desc code { background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 3px; font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; color: var(--text-primary); }
.method-desc strong { color: var(--text-primary); }

.geo-map-container { background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; padding: 1rem; margin-bottom: 1.5rem; width: 100%; }
.geo-map-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
.geo-map-title { font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }
.geo-map-total { font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; color: var(--accent); font-weight: 600; }
.geo-states-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 0.5rem; max-height: 300px; overflow-y: auto; width: 100%; }
.geo-state-item { display: flex; align-items: center; justify-content: space-between; gap: 0.5rem; padding: 0.5rem 0.75rem; background: rgba(255,255,255,0.02); border-radius: 4px; font-size: 0.8rem; }
.geo-state-name { color: var(--text-primary); font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1; min-width: 0; }
.geo-state-amount { color: var(--accent); font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; flex-shrink: 0; }

.analysis-panel { background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; overflow: hidden; width: 100%; }
.analysis-panel-header { padding: 0.75rem 1rem; background: rgba(255,255,255,0.02); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
.analysis-panel-title { font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; gap: 0.5rem; }
.analysis-panel-badge { font-size: 0.65rem; padding: 2px 8px; border-radius: 10px; font-weight: 600; }
.analysis-panel-badge.high { background: rgba(102, 194, 165, 0.2); color: var(--success); }
.analysis-panel-badge.medium { background: rgba(253, 216, 53, 0.2); color: #FDD835; }
.analysis-panel-badge.low { background: rgba(239, 83, 80, 0.2); color: var(--danger); }
.analysis-panel-badge.neutral { background: rgba(255,255,255,0.1); color: var(--text-muted); }
.analysis-panel-body { padding: 1rem; width: 100%; }
.analysis-metric { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
.analysis-metric:last-child { border-bottom: none; }
.analysis-metric-label { font-size: 0.8rem; color: var(--text-muted); }
.analysis-metric-value { font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; font-weight: 600; color: var(--text-primary); }
.analysis-insight { margin-top: 0.75rem; padding: 0.75rem; background: rgba(212, 196, 168, 0.05); border-left: 2px solid var(--accent); font-size: 0.8rem; color: var(--text-muted); line-height: 1.5; }

.drill-breadcrumb { display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1rem; background: linear-gradient(90deg, rgba(212, 196, 168, 0.1), transparent); border: 1px solid var(--border); border-radius: 4px; margin-bottom: 1rem; font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; overflow-x: auto; white-space: nowrap; }
.breadcrumb-item { display: flex; align-items: center; gap: 0.5rem; color: var(--text-muted); cursor: pointer; padding: 4px 8px; border-radius: 4px; transition: all 0.2s; }
.breadcrumb-item:hover { background: var(--accent); color: #000; }
.breadcrumb-item.active { background: var(--accent-dim); color: var(--accent); border: 1px solid var(--accent); cursor: default; }
.breadcrumb-separator { color: var(--border); font-size: 0.7rem; }
.breadcrumb-icon { font-size: 0.75rem; }

.drill-hint { display: flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.5rem; background: rgba(212, 196, 168, 0.05); border: 1px dashed var(--border); border-radius: 4px; margin-top: 0.5rem; font-size: 0.75rem; color: var(--text-muted); }
.drill-hint i { color: var(--accent); }


.subagency-panel { background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; margin-top: 1.5rem; overflow: hidden; }
.subagency-header { display: flex; align-items: center; justify-content: space-between; padding: 1rem; background: linear-gradient(90deg, rgba(212, 196, 168, 0.08), transparent); border-bottom: 1px solid var(--border); }
.subagency-header-left { display: flex; align-items: center; gap: 0.75rem; }
.subagency-header-icon { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; background: var(--accent-dim); border: 1px solid var(--accent); border-radius: 4px; color: var(--accent); }
.subagency-header-text h3 { margin: 0; font-family: 'JetBrains Mono', monospace; font-size: 0.9rem; color: var(--text-primary); font-weight: 600; }
.subagency-header-text span { font-size: 0.75rem; color: var(--text-muted); }
.subagency-stats { display: flex; gap: 1.5rem; font-family: 'JetBrains Mono', monospace; }
.subagency-stat { text-align: right; }
.subagency-stat-val { font-size: 1rem; font-weight: 700; color: var(--accent); }
.subagency-stat-label { font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase; }

.subagency-list { max-height: 400px; overflow-y: auto; }
.subagency-item { display: flex; align-items: center; justify-content: space-between; padding: 1rem; border-bottom: 1px solid var(--border); cursor: pointer; transition: all 0.15s; }
.subagency-item:hover { background: rgba(255,255,255,0.02); }
.subagency-item:last-child { border-bottom: none; }
.subagency-item-left { display: flex; align-items: center; gap: 1rem; flex: 1; min-width: 0; }
.subagency-rank { width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.05); border-radius: 4px; font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; color: var(--text-muted); flex-shrink: 0; }
.subagency-rank.top-3 { background: var(--accent-dim); color: var(--accent); border: 1px solid rgba(212, 196, 168, 0.3); }
.subagency-info { flex: 1; min-width: 0; }
.subagency-name { font-size: 0.9rem; color: var(--text-primary); font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.subagency-contracts { font-size: 0.75rem; color: var(--text-muted); margin-top: 2px; }
.subagency-item-right { display: flex; align-items: center; gap: 1rem; flex-shrink: 0; }
.subagency-bar-container { width: 120px; height: 8px; background: rgba(255,255,255,0.05); border-radius: 4px; overflow: hidden; }
.subagency-bar { height: 100%; background: linear-gradient(90deg, var(--accent), rgba(153, 153, 153, 0.3)); border-radius: 4px; transition: width 0.3s ease; }
.subagency-amount { font-family: 'JetBrains Mono', monospace; font-size: 0.9rem; font-weight: 700; color: var(--accent); min-width: 80px; text-align: right; }
.subagency-drill-icon { color: var(--text-muted); font-size: 0.8rem; opacity: 0; transition: all 0.15s; }
.subagency-item:hover .subagency-drill-icon { opacity: 1; color: var(--accent); transform: translateX(2px); }
.drill-level-indicator { display: inline-flex; align-items: center; gap: 0.25rem; padding: 2px 6px; background: rgba(102, 194, 165, 0.1); border: 1px solid rgba(102, 194, 165, 0.3); border-radius: 4px; font-size: 0.65rem; color: var(--success); margin-left: 0.5rem; }
.node-drillable { cursor: pointer; }
.node-drillable:hover { filter: brightness(1.2); }
.empty-drill-state { text-align: center; padding: 3rem 2rem; color: var(--text-muted); }
.empty-drill-state i { font-size: 2rem; color: var(--border); margin-bottom: 1rem; }
.empty-drill-state p { margin: 0.5rem 0; }

.sales-plan-card { background: linear-gradient(135deg, rgba(212, 196, 168, 0.15) 0%, rgba(212, 196, 168, 0.05) 100%); border: 1px solid var(--accent); border-radius: 4px; padding: 1rem; cursor: pointer; transition: all 0.3s ease; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
.sales-plan-card:hover { transform: translateY(-4px); box-shadow: 0 8px 30px rgba(212, 196, 168, 0.4); border-color: var(--accent); background: linear-gradient(135deg, rgba(212, 196, 168, 0.25) 0%, rgba(212, 196, 168, 0.1) 100%); }
.sales-plan-card-icon { font-size: 1.5rem; color: var(--accent); margin-bottom: 0.5rem; }
.sales-plan-card-title { font-size: 0.85rem; font-weight: 700; color: var(--accent); margin-bottom: 0.25rem; text-transform: uppercase; letter-spacing: 1px; }
.sales-plan-card-subtitle { font-size: 0.85rem; color: var(--text-primary); line-height: 1.4; margin-bottom: 0.75rem; }
.sales-plan-card-action { display: inline-flex; align-items: center; gap: 0.5rem; font-size: 0.75rem; color: var(--accent); text-transform: uppercase; letter-spacing: 1px; font-weight: 600; }

.channel-marking-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0); z-index: 500; padding: 2rem; overflow-y: auto; display: flex; align-items: flex-start; justify-content: center; opacity: 0; visibility: hidden; transition: opacity 0.25s ease, background 0.25s ease, visibility 0.25s; }
.channel-marking-modal.active { opacity: 1; visibility: visible; background: rgba(0, 0, 0, 0.9); }
.channel-modal-content { background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; max-width: 800px; width: 100%; margin: 2rem auto; transform: translateY(-20px) scale(0.98); transition: transform 0.25s ease-out; display: flex; flex-direction: column; max-height: 85vh; }
.channel-marking-modal.active .channel-modal-content { transform: translateY(0) scale(1); }
.channel-modal-header { padding: 1.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
.channel-modal-title { font-size: 1.3rem; font-weight: 700; color: var(--accent); font-family: 'JetBrains Mono', monospace; }
.channel-modal-close { background: transparent; border: none; color: var(--text-muted); font-size: 1.5rem; cursor: pointer; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 4px; }
.channel-modal-close:hover { background: rgba(255, 255, 255, 0.05); color: var(--accent); }
.channel-modal-body { padding: 1.5rem; flex: 1; overflow-y: auto; min-height: 0; }
.channel-explanation { background: rgba(212, 196, 168, 0.1); border-left: 3px solid var(--accent); padding: 1rem; margin-bottom: 1.5rem; font-size: 0.9rem; color: var(--text-primary); line-height: 1.6; }
.vendor-list-item { display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 1rem; border: 1px solid var(--border); border-radius: 4px; margin-bottom: 0.5rem; transition: all 0.2s; }
.vendor-list-item:hover { background: rgba(255, 255, 255, 0.02); border-color: var(--accent); }
.vendor-info { flex: 1; min-width: 0; }
.vendor-name { font-weight: 600; color: var(--text-primary); margin-bottom: 0.25rem; }
.vendor-stats { font-size: 0.75rem; color: var(--text-muted); }
.vendor-toggle { display: flex; align-items: center; gap: 0.5rem; }
.toggle-switch { position: relative; width: 50px; height: 26px; background: #333; border-radius: 13px; cursor: pointer; transition: background 0.3s; }
.toggle-switch.active { background: var(--accent); }
.toggle-slider { position: absolute; top: 3px; left: 3px; width: 20px; height: 20px; background: white; border-radius: 50%; transition: transform 0.3s; }
.toggle-switch.active .toggle-slider { transform: translateX(24px); }
.toggle-label { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; min-width: 80px; }
.toggle-switch.active + .toggle-label { color: var(--accent); font-weight: 600; }
.channel-modal-footer { padding: 1rem 1.5rem; border-top: 1px solid var(--border); display: flex; gap: 1rem; justify-content: space-between; align-items: center; flex-shrink: 0; background: var(--bg-card); }
.modal-footer-buttons { display: flex; gap: 0.75rem; align-items: center; }
.modal-footer-secondary { display: flex; gap: 0.5rem; }
.modal-status-line { font-size: 0.75rem; color: var(--text-muted); }
.modal-btn { padding: 0.75rem 1.5rem; border-radius: 4px; font-weight: 600; cursor: pointer; transition: all 0.2s; text-transform: uppercase; letter-spacing: 1px; font-size: 0.85rem; }
.modal-btn-cancel { background: transparent; border: 1px solid var(--border); color: var(--text-muted); }
.modal-btn-cancel:hover { border-color: var(--accent); color: var(--accent); }
.modal-btn-primary { background: var(--accent); border: none; color: #000; }
.modal-btn-primary:hover { opacity: 0.9; transform: translateY(-1px); }
.channel-link { display: inline-flex; align-items: center; gap: 0.25rem; font-size: 0.75rem; color: var(--text-muted); margin-top: 0.5rem; cursor: pointer; text-decoration: underline; }
.channel-link:hover { color: var(--accent); }

#spIntentBanner { display: none; background: rgba(255, 255, 255, 0.02); border-bottom: 1px solid var(--border); padding: 1rem 1.5rem; }
.intent-banner-content { display: flex; align-items: flex-start; gap: 0.75rem; }
.intent-banner-icon { font-size: 1.25rem; color: var(--accent); opacity: 0.9; width: 24px; text-align: center; flex-shrink: 0; }
.intent-banner-text { flex: 1; }
.intent-banner-title { font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 0.25rem; }
.intent-banner-desc { font-size: 0.95rem; color: var(--text-primary); margin-bottom: 0.5rem; font-weight: 500; }
.intent-banner-focus { display: flex; flex-wrap: wrap; align-items: center; gap: 0.4rem; }
.focus-label { font-family: 'JetBrains Mono', monospace; font-size: 0.6rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
.focus-tag { font-size: 0.65rem; background: transparent; border: none; color: var(--text-muted); padding: 0; }
.focus-tag::before { content: 'â€¢'; margin-right: 0.35rem; color: var(--accent); }

.ai-link-btn { display: flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.75rem 1rem; border-radius: 4px; color: white; text-decoration: none; font-family: 'Inter', sans-serif; font-size: 0.8rem; font-weight: 600; border: none; transition: transform 0.1s, opacity 0.2s; }
.ai-link-btn:hover { transform: translateY(-1px); opacity: 0.9; }
.ai-link-btn.claude { background: #C15F3C; }
.ai-link-btn.chatgpt { background: #4796E3; }
.ai-link-btn.gemini { background: #9177C7; }

/* Pipeline Builder Styles */
.pipeline-builder-btn {
  display: flex; align-items: center; gap: 0.5rem;
  padding: 0.75rem 1.25rem; border-radius: 4px;
  background: linear-gradient(135deg, #5F8055 0%, #4a6b42 100%);
  color: white; border: none; cursor: pointer;
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.8rem; font-weight: 600;
  text-transform: uppercase; letter-spacing: 0.5px;
  transition: all 0.2s ease;
}
.pipeline-builder-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(95, 128, 85, 0.3); }
.pipeline-builder-btn i { font-size: 1rem; }

.pipeline-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0); z-index: 500; padding: 2rem; overflow-y: auto; display: flex; align-items: flex-start; justify-content: center; opacity: 0; visibility: hidden; transition: opacity 0.25s ease, background 0.25s ease, visibility 0.25s; }
.pipeline-modal.active { opacity: 1; visibility: visible; background: rgba(0, 0, 0, 0.9); }
.pipeline-modal-content { background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; max-width: 1100px; width: 100%; margin: 2rem auto; transform: translateY(-20px) scale(0.98); transition: transform 0.25s ease-out; display: flex; flex-direction: column; max-height: 90vh; }
.pipeline-modal.active .pipeline-modal-content { transform: translateY(0) scale(1); }

.pipeline-progress { display: flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 2rem; color: var(--accent); }
.pipeline-progress .spinner { width: 24px; height: 24px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }

.pipeline-results-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem; }
.pipeline-stat { background: rgba(255,255,255,0.02); border: 1px solid var(--border); border-radius: 4px; padding: 1rem; text-align: center; }
.pipeline-stat-label { font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 0.5rem; }
.pipeline-stat-value { font-family: 'JetBrains Mono', monospace; font-size: 1.25rem; font-weight: 700; color: var(--accent); }
.pipeline-stat-sub { font-size: 0.7rem; color: var(--text-muted); margin-top: 0.25rem; }

.pipeline-table-wrapper { overflow-x: auto; max-height: 400px; overflow-y: auto; border: 1px solid var(--border); border-radius: 4px; }
.pipeline-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
.pipeline-table th { position: sticky; top: 0; background: var(--bg-card); padding: 0.75rem 0.5rem; text-align: left; font-weight: 600; color: var(--accent); border-bottom: 2px solid var(--border); font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap; }
.pipeline-table td { padding: 0.6rem 0.5rem; border-bottom: 1px solid rgba(255,255,255,0.05); color: var(--text-primary); }
.pipeline-table tr:hover { background: rgba(255,255,255,0.02); }
.pipeline-table .amount { font-family: 'JetBrains Mono', monospace; color: var(--success); font-weight: 600; }
.pipeline-table .date { font-family: 'JetBrains Mono', monospace; color: var(--text-muted); font-size: 0.75rem; }
.pipeline-table .agency { color: var(--link); }
.pipeline-table .stage { display: inline-block; padding: 2px 6px; border-radius: 3px; font-size: 0.65rem; font-weight: 600; text-transform: uppercase; }
.pipeline-table .stage.prospecting { background: rgba(141, 160, 203, 0.2); color: #8DA0CB; }
.pipeline-table .stage.qualification { background: rgba(233, 196, 106, 0.2); color: #E9C46A; }

.pipeline-quarter-badge { display: inline-block; padding: 2px 6px; border-radius: 3px; font-size: 0.65rem; font-weight: 600; background: rgba(95, 128, 85, 0.2); color: var(--success); font-family: 'JetBrains Mono', monospace; }
.pipeline-source-tag { display: inline-block; padding: 1px 4px; border-radius: 2px; font-size: 0.6rem; background: rgba(212, 196, 168, 0.1); color: var(--text-muted); margin-left: 4px; }

.pipeline-config-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 1rem; }
.pipeline-config-item label { display: block; font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.5rem; font-weight: 600; }
.pipeline-config-item select, .pipeline-config-item input { width: 100%; padding: 0.6rem; background: var(--bg-app); border: 1px solid var(--border); border-radius: 4px; color: var(--text-primary); font-size: 0.85rem; }
.pipeline-config-item select:focus, .pipeline-config-item input:focus { outline: none; border-color: var(--accent); }

@media (max-width: 768px) {
  .pipeline-results-grid { grid-template-columns: repeat(2, 1fr); }
  .pipeline-config-row { grid-template-columns: 1fr; }
}

#copySuccessModal .channel-modal-content { 
  border: 1px solid var(--border);
  box-shadow: 0 0 30px rgba(0,0,0,0.5); 
}
#copySuccessModal kbd { background: var(--bg-app); border: 1px solid var(--border); color: var(--accent); font-family: 'JetBrains Mono', monospace; padding: 2px 4px; border-radius: 3px; }

@media (max-width: 900px) { 
  .insight-grid { grid-template-columns: 1fr; }
  .market-structure-grid { grid-template-columns: 1fr; }
  .scenario-grid { grid-template-columns: 1fr; gap: 0.5rem; }
}

@media (max-width: 768px) {
  .methodology-card { grid-template-columns: 1fr; }
  .subagency-bar-container { display: none; }
  .subagency-stats { flex-direction: column; gap: 0.5rem; }
  .subagency-stat { text-align: left; }
  .stats-row { grid-template-columns: 1fr !important; gap: 0.75rem !important; }
  .stat-item { display: flex !important; justify-content: space-between !important; align-items: center !important; padding: 1rem !important; text-align: left !important; }
  .stat-label { margin-bottom: 0 !important; }
  .stat-item-action { grid-column: span 1 !important; }
  
  #forecastModeView div[style*="display: grid"] {
    grid-template-columns: 1fr !important;
    gap: 1rem !important;
    width: 100% !important;
    overflow: hidden !important;
  }
  
  .dashboard-container {
    width: 100% !important;
    max-width: 100% !important;
    padding-left: 1rem !important;
    padding-right: 1rem !important;
    overflow-x: hidden !important;
  }

  .analysis-panel, .analysis-panel-body, .buyer-list {
    width: 100% !important;
    max-width: 100% !important;
  }
  
  /* Stack job intel panels on mobile */
  .job-intel-panel > div { 
    grid-template-columns: 1fr !important; 
  }
  
.forecast-table th, .forecast-table td {
    padding: 0.75rem 0.25rem !important; 
    font-size: 0.75rem; 
  }
  
  .forecast-table td:last-child {
    padding-right: 0 !important;
  }
  .geo-states-grid { grid-template-columns: 1fr !important; }
  .btn-row { flex-direction: column; }
  .chart-container { min-width: 600px; }
  .chart-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; }
}

@media (max-width: 600px) {
  .mode-toggle { flex-direction: column; }
  .app-header { gap: 0.5rem; padding: 0.5rem 0.75rem; }
  .header-left { gap: 0.5rem; }
  .mini-search { 
    max-width: 140px; 
    padding: 0.5rem 0.6rem; 
    font-size: 0.8rem; 
  }
  .logo-btn { font-size: 0.9rem; }
  .icon-btn { width: 32px; height: 32px; }
  .header-actions { gap: 0.35rem; }
  .channel-marking-modal { padding: 0; }
  .channel-modal-content { 
    margin: 0; 
    border-radius: 0; 
    height: 100%; 
    max-height: 100%; 
    max-width: 100%; 
    display: flex; 
    flex-direction: column;
  }
  .channel-modal-header { flex-shrink: 0; padding: 1rem; }
  .channel-modal-title { font-size: 1.1rem; }
  .channel-modal-body { flex: 1; overflow-y: auto; min-height: 0; }
  .channel-modal-footer { 
    flex-direction: column;
    gap: 0.75rem; 
    padding: 1rem;
    padding-bottom: max(1rem, env(safe-area-inset-bottom));
  }
  .modal-footer-buttons {
    flex-direction: column;
    width: 100%;
    gap: 0.5rem;
  }
  .modal-footer-buttons .modal-btn-primary {
    width: 100%;
    padding: 0.875rem;
  }
  .modal-footer-secondary {
    width: 100%;
    gap: 0.5rem;
  }
  .modal-footer-secondary .modal-btn {
    flex: 1;
    padding: 0.75rem;
  }
  .modal-status-line {
    text-align: center;
    font-size: 0.7rem;
    opacity: 0.7;
    padding-top: 0.5rem;
    border-top: 1px solid var(--border);
  }
  .step-grid { grid-template-columns: 1fr !important; }
  
  .hero-growth-value { font-size: 2rem; }
  
  div[style*="grid-template-columns: 1fr 1fr"] {
    grid-template-columns: 1fr !important;
  }
}

.buyer-name, .vendor-name, .geo-state-name {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 180px;
}

::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: var(--bg-app); }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--accent); }
/* --- Projection & Narrative Enhancements --- */
.projection-summary {
  margin-top: 1rem;
  padding: 1.5rem;
  background: linear-gradient(135deg, rgba(212, 196, 168, 0.1) 0%, rgba(18, 18, 18, 1) 100%);
  border: 1px solid var(--accent);
  border-radius: 4px;
  position: relative;
  overflow: hidden;
}

.hero-growth-label {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.7rem;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 2px;
  margin-bottom: 0.5rem;
}

.hero-growth-value {
  font-size: 2.5rem;
  font-weight: 800;
  font-family: 'JetBrains Mono', monospace;
  line-height: 1;
}

.strategic-narrative-card {
  background: var(--bg-card);
  border-left: 4px solid var(--accent);
  padding: 1.25rem;
  margin: 1.5rem 0;
  font-size: 0.9rem;
  line-height: 1.6;
}

/* Confidence Badge Styling */
.analysis-panel-badge {
  font-size: 0.65rem;
  padding: 2px 8px;
  border-radius: 10px;
  font-weight: 600;
  font-family: 'JetBrains Mono', monospace;
}
.analysis-panel-badge.high { background: rgba(102, 194, 165, 0.2); color: var(--success); }
.analysis-panel-badge.medium { background: rgba(253, 216, 53, 0.2); color: #FDD835; }
.analysis-panel-badge.low { background: rgba(239, 83, 80, 0.2); color: var(--danger); }

/* Disclaimer & Footer */
.disclaimer-text {
  margin-top: 1.5rem;
  padding: 1rem;
  font-size: 0.7rem;
  color: var(--text-muted);
  border-top: 1px solid var(--border);
  line-height: 1.4;
  font-style: italic;
}

.tip-bio-img {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  filter: grayscale(1) contrast(1.1);
  flex-shrink: 0;
  float: left;
  margin-right: 12px;
  margin-bottom: 4px;
}

/* ===== HERO FOOTER ===== */
.hero-footer {
  width: 100%;
  max-width: 1200px;
  /* Center the footer container */
  margin: 3rem auto 0 auto;
  padding-top: 2rem;
}

.footer-grid {
  display: grid;
  /* Default to 1 column (Stacked/Mobile) */
  grid-template-columns: 1fr;
  gap: 2rem;
}

.footer-section {
  padding-bottom: 1.5rem;
  /* Add border for stacked view */
  border-bottom: 1px solid rgba(255,255,255,0.1); 
}

.footer-section:last-child {
  border-bottom: none;
  padding-bottom: 0;
}

/* Desktop Layout Override */
@media (min-width: 768px) {
  .footer-grid {
    /* Force 3 columns side-by-side */
    grid-template-columns: 1fr 1fr 1fr; 
    gap: 2rem;
  }
  
  .footer-section {
    /* Remove mobile borders on desktop */
    border-bottom: none; 
    padding-bottom: 0;
  }
}

.footer-label {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.65rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: var(--accent);
  margin-bottom: 0.75rem;
}

.footer-heading {
  font-size: 1rem;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 0.75rem;
  letter-spacing: -0.01em;
}

.footer-text {
  overflow: hidden;
  font-size: 0.8rem;
  line-height: 1.6;
  color: var(--text-muted);
  margin-bottom: 0.75rem;
}
.footer-text:last-child {
  margin-bottom: 0;
}

/* Use Cases */
.use-cases {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

/* Feature List (integrated search tips) */
.feature-list {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}

.feature-item {
  display: flex;
  align-items: flex-start;
  gap: 0.75rem;
  font-size: 0.75rem;
  line-height: 1.5;
}

.feature-tag {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.65rem;
  font-weight: 700;
  color: var(--text-primary);
  background: rgba(255, 255, 255, 0.1);
  padding: 0.2rem 0.5rem;
  border-radius: 2px;
  white-space: nowrap;
  flex-shrink: 0;
}

.feature-desc {
  color: var(--text-muted);
}

.use-case {
  padding: 0.875rem;
  background: rgba(255, 255, 255, 0.02);
  border-left: 2px solid var(--accent);
}

.use-case-title {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.7rem;
  font-weight: 700;
  color: var(--text-primary);
  margin-bottom: 0.375rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.use-case-desc {
  font-size: 0.75rem;
  color: var(--text-muted);
  line-height: 1.5;
}

/* Steps List */
.steps-list {
  counter-reset: step;
  list-style: none;
  padding: 0;
  margin: 0;
}

.steps-list li {
  position: relative;
  padding-left: 1.75rem;
  margin-bottom: 0.625rem;
  font-size: 0.75rem;
  color: var(--text-muted);
  line-height: 1.5;
}

.steps-list li::before {
  counter-increment: step;
  content: counter(step);
  position: absolute;
  left: 0;
  top: 0;
  width: 1.125rem;
  height: 1.125rem;
  background: var(--accent);
  color: #000;
  font-size: 0.6rem;
  font-weight: 700;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 2px;
}

/* Footer Links */
.footer-links {
  display: flex;
  gap: 1rem;
  flex-wrap: wrap;
  margin-top: 1rem;
}

.footer-link {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.7rem;
  color: var(--accent);
  text-decoration: none;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  font-weight: 700;
  padding-bottom: 2px;
  border-bottom: 1px solid var(--accent);
  transition: opacity 0.2s ease;
}

.footer-link:hover {
  opacity: 0.7;
}

/* Data Source */
.data-source {
  display: flex;
  align-items: flex-start;
  gap: 0.75rem;
  padding: 0.75rem;
  background: rgba(255, 255, 255, 0.02);
  border: 1px solid var(--border);
  border-radius: 4px;
  margin-top: 1rem;
}

.data-source-icon {
  font-size: 1rem;
  color: var(--text-muted);
  margin-top: 2px;
}

.data-source-text {
  font-size: 0.7rem;
  color: var(--text-muted);
  line-height: 1.5;
}

.data-source-text a {
  color: var(--accent);
  text-decoration: none;
}

.data-source-text a:hover {
  text-decoration: underline;
}

/* Pro Tip Box */
.pro-tip-box {
  font-family: 'JetBrains Mono', monospace;
  background: rgba(212, 196, 168, 0.08);
  border: 1px solid var(--accent);
  border-radius: 4px;
  padding: 0.75rem;
  margin-top: 1rem;
}

.pro-tip-label {
  font-size: 0.6rem;
  font-weight: 700;
  color: var(--accent);
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 0.5rem;
}

.pro-tip-code {
  font-size: 0.75rem;
  color: var(--text-primary);
  background: rgba(0, 0, 0, 0.3);
  padding: 0.375rem 0.5rem;
  border-radius: 2px;
  display: inline-block;
  margin-top: 0.25rem;
}

/* Footer Bottom */
.footer-bottom {
  margin-top: 2rem;
  padding-top: 1.5rem;
  text-align: center;
}

.footer-copyright {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.65rem;
  color: var(--text-muted);
  letter-spacing: 0.5px;
}

.dashboard-container .hero-footer {
  margin: 4rem auto 0 auto; /* Centers the footer and adds space above it */
  padding-bottom: 2rem;
  animation: fadeIn 1s forwards;
}

.dashboard-container .hero-footer .footer-grid {
  gap: 2rem; 
}
.intelligence-banner {
  margin: 1.5rem 0 0.5rem 0;
  padding: 1rem;
  /* 1. Subtle Red Tint: Eye-catching but readable */
  background: rgba(214, 109, 100, 0.1); 
  /* 2. Solid Red Border: Creates the "Stop" signal */
  border: 1px solid rgba(214, 109, 100, 0.3);
  border-left: 4px solid #D66D64; 
  border-radius: 4px;
  /* 3. Layout */
  display: flex;
  gap: 1rem;
  align-items: flex-start;
  font-size: 0.75rem;
  color: var(--text-muted);
  line-height: 1.5;
}

.intel-icon {
  /* 4. Tomato Icon: Ties the visual story together */
  color: #D66D64; 
  font-size: 1.1rem; /* Slightly larger to grab attention */
  margin-top: 2px;
  flex-shrink: 0;
}

.intel-content strong {
  color: #fff; /* Bright white title for contrast */
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.intel-tip {
  margin-top: 0.5rem;
  padding-top: 0.5rem;
  border-top: 1px solid rgba(214, 109, 100, 0.2); /* Red separator */
  color: #e0e0e0; /* Brighter text for the tip itself */
}
.input-clear {
  position: absolute;
  right: 12px;
  top: 50%;
  transform: translateY(-50%);
  background: none;
  border: none;
  color: var(--text-muted);
  font-size: 1.25rem;
  cursor: pointer;
  display: none;
  padding: 4px 8px;
  z-index: 215;
}
.input-clear:hover { color: var(--accent); }
.input-clear.visible { display: block; }
/* --- UNIVERSAL MOBILE CHART FIX --- */
@media (max-width: 900px) {
  #chartContainer {
    min-width: 0 !important;
    width: 100% !important;
  }

  .chart-wrapper, 
  #subcontractingPanel .analysis-panel-body {
    padding: 0 !important;
    overflow: hidden !important;
  }

  #chartContainer svg,
  #subcontractingBody svg,
  #subawardSankeySvg {
    width: 100% !important;
    height: auto !important;
    max-width: 100%;
    display: block;
  }
}
</style>

</head>
<body>

<div id="heroView" class="hero-view">
  <div class="terminal-logo"><span>>_</span>Govhoo</div>
  <p class="hero-subtitle">Follow the Money. For Free.</p>
  
  <div class="search-box-container">
  <input type="text" id="mainSearchInput" class="main-input" placeholder="Search keywords, company, or agency..." autocomplete="off">
  <button class="input-clear" onclick="document.getElementById('mainSearchInput').value=''; document.getElementById('mainSearchInput').focus();" aria-label="Clear search">Ã—</button>
    <div class="btn-row">
      <button id="searchBtn" class="btn-primary" data-action="search">
        <i class="fas fa-search"></i> SEARCH
      </button>
      <button id="forecastBtn" class="btn-secondary" data-action="forecast">
        <i class="fas fa-chart-line"></i> FORECAST
      </button>
    </div>
  </div>

<!-- Hero Footer -->
<footer class="hero-footer">
  <div class="footer-grid">
<div class="footer-section">
  <div class="footer-label mono text-xs accent upper">Search Tips</div>
  <div class="feature-list">

    <div class="feature-item">
      <span class="feature-tag mono">Keywords</span>
      <span class="feature-desc muted">Think like a KO. Search for scope terms like <a href="?q=DevSecOps" style="color: #fff; text-decoration: underline;">DevSecOps</a>, <a href="?q=Zero+Trust" style="color: #fff; text-decoration: underline;">Zero Trust</a>, or <a href="?q=Cloud+Migration" style="color: #fff; text-decoration: underline;">Cloud Migration</a> to find funded programs.</span>
    </div>

    <div class="feature-item">
      <span class="feature-tag mono">Names</span>
      <span class="feature-desc muted"><strong>For VARs/Channel:</strong> Search the OEM or Prime's name (e.g., <a href="?q=Amazon" style="color: #fff; text-decoration: underline;">Amazon</a>) to find where products or services are being sold through.</span>
    </div>

    <div class="feature-item">
      <span class="feature-tag mono">PSC Codes</span>
      <span class="feature-desc muted">Use codes like <a href="?q=DA10" style="color: #fff; text-decoration: underline;">DA10</a> (IT App Dev), <a href="?q=7A21" style="color: #fff; text-decoration: underline;">7A21</a> (SW Perpetual License), and <a href="?q=R499" style="color: #fff; text-decoration: underline;">R499</a> (Other Professional Services).</span>
    </div>
    
    <div class="feature-item">
      <span class="feature-tag mono">Multi</span>
      <span class="feature-desc muted">Stack your search. Separate multiple agencies or vendors with commas: <a href="?q=Amazon,+Microsoft,+Google,+Oracle" style="color: #fff; text-decoration: underline;">Amazon, Microsoft, Google, Oracle</a>.</span>
    </div>

    <div class="pro-tip-box" style="margin-top: 0.5rem; border: 1px dashed var(--border); background: rgba(255,255,255,0.02);">
      <div class="pro-tip-label" style="color: var(--text-muted); margin-bottom: 0.25rem;">Data Intelligence Note</div>
      <div class="feature-desc muted" style="font-size: 0.7rem; line-height: 1.4;">
        We query the live USASpending database to capture Prime Obligations. To keep results actionable, we fetch the <strong>top 100 most relevant awards</strong> based on your criteria. This view shows direct Government-to-Prime spend.
      </div>
    </div>

  </div>
</div>
    <!-- Use Cases -->
<div class="footer-section">
  <div class="footer-label mono text-xs accent upper">Use Cases</div>
  <div class="use-cases">
    <div class="use-case">
      <div class="use-case-title">Defend</div>
      <div class="use-case-desc">Protect your base. Monitor your expiring contracts and agency relationships well before the recompete RFP hits.</div>
    </div>
    <div class="use-case">
      <div class="use-case-title">Displace</div>
      <div class="use-case-desc">Identify vulnerable incumbents. See who is winning work you should have won and position early for the takeaway.</div>
    </div>
    <div class="use-case">
      <div class="use-case-title">Expand</div>
      <div class="use-case-desc">Find "White Space." Discover agencies buying your competitors or identify teaming partners (Primes) holding the contract vehicles you need.</div>
    </div>
   <div class="use-case">
  <div class="use-case-title">Connect</div>
  <div class="use-case-desc">Find the people behind the contracts with pre-filtered LinkedIn search links to current employees (for networking), past employees (for recruiting), and active job openings (for your next career move), as well as USAJobs links for federal positions.</div>
</div>
  </div>
</div>
   
     <!-- About -->
    <div class="footer-section">
      <div class="footer-label mono text-xs accent upper">About</div>
      <h3 class="footer-heading">Built by a Sales Guy</h3>
      <p class="footer-text">
<img src="https://govhoo.com/images/oldmark.jpg" alt="Mark Flournoy" class="tip-bio-img">Hi, Iâ€™m Mark, a retired federal sales guy and Marine. Over decades of selling at AWS, F5, and Red Hat, I spent too much time bouncing between USASpending, SAM.gov, and industry days just to figure out who the incumbents were and when contracts were coming up for recompete. So I built Govhoo. It uses real award data to surface expiring contracts and mission gaps, so you can focus on the right customer conversations at the right time. Itâ€™s free to use, and I hope it helps you win. Good luck out there.
      </p>
      
       <p class="footer-text">Questions or want to collaborate? DM me on <a href="https://www.linkedin.com/in/markflournoy/" target="_blank" style="color: var(--accent); text-decoration: underline;">LinkedIn</a>. Be sure to check out my other sites <a href="https://askarti.com" target="_blank" style="color: var(--accent); text-decoration: underline;">AskArti</a> (free sales prompts) and <a href="https://subhoo.com" target="_blank" style="color: var(--accent); text-decoration: underline;">Subhoo</a> (Primes with Subcontracting Plans).</p>
    </div>
  </div>
  <div class="footer-bottom">
    <div class="footer-copyright">Â© 2025 GOVHOO â€” DATA VIA USASPENDING.GOV</div>
  </div>
</footer>
</div>

<div id="appView" style="display:none;">
  <header class="app-header">
    <div class="header-left">
      <span class="logo-btn" data-action="showHero">>_Govhoo</span>
      <div class="mini-search-wrapper">
  <input type="text" id="miniSearch" class="mini-search" placeholder="New search...">
</div>
    </div>
    <div class="header-actions">
      <button class="icon-btn" id="toggleModeBtn" data-action="toggleMode" title="Toggle Mode">
        <i class="fas fa-exchange-alt"></i>
      </button>
      <button class="icon-btn" data-action="shareLink" title="Copy Share Link">
  <i class="fas fa-link"></i>
</button>

<button class="icon-btn" title="Export CSV" data-action="exportCSV">
  <i class="fas fa-download"></i>
</button>
    </div>
  </header>

  <div id="dashboardContainer" class="dashboard-container">
    
    <div class="mode-toggle">
      <button class="mode-btn active" id="modeSearchBtn" data-action="setModeSearch">
        <i class="fas fa-project-diagram"></i> Agency Award Flow
      </button>
      <button class="mode-btn" id="modeForecastBtn" data-action="setModeForecast">
        <i class="fas fa-eye"></i> Forecast & Strategy
      </button>
    </div>

    <div id="searchModeView" class="view-section active">
      
      <div class="stats-row" id="searchStats">
        <div class="stat-item">
          <div class="stat-label">Contract Awards</div>
          <div class="stat-val" id="stat-vol">-</div>
          <div class="stat-sub neutral">Past 12 Mo (Ceiling)</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Contract Count</div>
          <div class="stat-val" id="stat-count">-</div>
          <div class="stat-sub neutral">Past 12 Months</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Prime Vendors</div>
          <div class="stat-val" id="stat-vendors">-</div>
          <div class="stat-sub neutral">Unique Recipients</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Agencies</div>
          <div class="stat-val" id="stat-agencies">-</div>
          <div class="stat-sub neutral">Awarding Agencies</div>
        </div>
      </div>

      <div id="drillBreadcrumb" class="drill-breadcrumb" style="display: none;">
        <div class="breadcrumb-item" data-action="resetDrill">
          <i class="fas fa-globe breadcrumb-icon"></i>
          <span>All Agencies</span>
        </div>
      </div>

      <div class="section-header">
        <div class="section-title-group">
          <i class="fas fa-project-diagram accent"></i>
          <span class="section-title mono bold accent upper">Agency to Prime Award Flow</span>
          <span id="drillLevelBadge" class="drill-level-indicator" style="display:none;">
            <i class="fas fa-layer-group"></i>
            <span id="drillLevelText">Level 1</span>
          </span>
        </div>
        <div class="header-controls">
          <div id="filterBadge" class="filter-badge" data-action="clearFilter">
            <span id="filterName">FILTER</span> <i class="fas fa-times"></i>
          </div>
          <div class="time-badge mono text-xs muted">PAST 12 MONTHS</div>
        </div>
      </div>
      
      <div class="chart-wrapper">
        <div id="chartContainer" class="chart-container"></div>
      </div>
      
      <div id="drillHint" class="drill-hint">
        <i class="fas fa-mouse-pointer"></i>
        <span>Click an <strong>agency bar</strong> to drill into sub-agencies</span>
      </div>
      <!-- Job Seeker Intelligence Panel (Search View) -->
<div id="searchJobPanel" class="job-intel-panel" style="margin: 1.5rem 0;">
  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
    
    <!-- Top Buyers with LinkedIn Links -->
    <div>
      <div class="section-header" style="margin: 0 0 0.75rem 0;">
        <div class="section-title-group">
          <i class="fas fa-landmark accent"></i>
          <span class="section-title mono bold accent upper text-xs">Top Agency Buyers</span>
          <span class="section-subtitle" style="margin-left: 6px;">Agency Contacts</span>
        </div>
      </div>
      <div class="analysis-panel" style="min-height: auto;">
        <div class="analysis-panel-body" id="searchTopBuyersBody" style="padding: 0.75rem;">
          <div class="muted text-xs" style="text-align:center;">Run a search to see top agencies</div>
        </div>
      </div>
    </div>
    
    <!-- Top Awardees with Job Links -->
    <div>
      <div class="section-header" style="margin: 0 0 0.75rem 0;">
        <div class="section-title-group">
          <i class="fas fa-dollar-sign accent"></i><i class="fas fa-dollar-sign accent"></i><i class="fas fa-dollar-sign accent"></i>
          <span class="section-title mono bold accent upper text-xs">Top Prime Contractors</span>
          <span class="section-subtitle" style="margin-left: 6px;">Vendor Contacts</span>
        </div>
      </div>
      <div class="analysis-panel" style="min-height: auto;">
        <div class="analysis-panel-body" id="searchTopWinnersBody" style="padding: 0.75rem;">
          <div class="muted text-xs" style="text-align:center;">Run a search to see top vendors</div>
        </div>
      </div>
    </div>
    
    <!-- Place of Performance -->
    <div>
      <div class="section-header" style="margin: 0 0 0.75rem 0;">
        <div class="section-title-group">
          <i class="fas fa-map-marker-alt accent"></i>
          <span class="section-title mono bold accent upper text-xs">Place of Performance</span>
          <span class="section-subtitle" style="margin-left: 6px;">Where the Work Is</span>
        </div>
      </div>
      <div class="analysis-panel" style="min-height: auto;">
        <div class="analysis-panel-body" id="searchLocationsBody" style="padding: 0.75rem;">
          <div class="muted text-xs" style="text-align:center;">Run a search to see locations</div>
        </div>
      </div>
    </div>
    
    <!-- Skills in Demand -->
    <div>
      <div class="section-header" style="margin: 0 0 0.75rem 0;">
        <div class="section-title-group">
          <i class="fas fa-code accent"></i>
          <span class="section-title mono bold accent upper text-xs">Skills in Demand</span>
          <span class="section-subtitle" style="margin-left: 6px;">Resume Keywords</span>
        </div>
      </div>
      <div class="analysis-panel" style="min-height: auto;">
        <div class="analysis-panel-body" id="searchSkillsBody" style="padding: 0.75rem;">
          <div class="muted text-xs" style="text-align:center;">Run a search to see in-demand skills</div>
        </div>
      </div>
    </div>
    
  </div>
</div>

      <div id="subawardWrapper" style="display: none;">
      <div class="intelligence-banner">
  <i class="fas fa-book-reader intel-icon"></i>
  
  <div class="intel-content" style="color: #ffffff;">
    <div><strong>DATA SOURCES: PRIME VS. SUB</strong></div>
    
    <div style="margin: 0.5rem 0; display: flex; flex-direction: column; gap: 0.5rem;">
      <div>
        <span style="color: #ffffff; font-family:'JetBrains Mono'; font-size:0.7rem; text-transform:uppercase; font-weight:700;">
          <i class="fas fa-arrow-up" style="margin-right: 4px;"></i> [Chart Above] Prime Obligations
        </span>
        <div style="margin-top:2px; color: #ffffff; opacity: 0.9;">
          Source: FPDS (via USASpending API). This represents <strong>Obligated Funds</strong> (Actual Spend to date), not the potential contract ceiling.
        </div>
      </div>
      
      <div>
        <span style="color: #ffffff; font-family:'JetBrains Mono'; font-size:0.7rem; text-transform:uppercase; font-weight:700;">
          <i class="fas fa-arrow-down" style="margin-right: 4px;"></i> [Chart Below] Subcontracts
        </span>
        <div style="margin-top:2px; color: #ffffff; opacity: 0.9;">
          Source: FSRS (via USASpending API). This represents the "Team" executing the work. 
          <em style="color: #dddddd;">Note: Sub data is self-reported by Primes and excludes awards under $30k.</em>
        </div>
      </div>
    </div>
<div class="intel-tip" style="color: #ffffff; border-top-color: rgba(255,255,255,0.2);">
  <div style="margin-bottom: 0.75rem; padding-bottom: 0.75rem; border-bottom: 1px dashed rgba(255,255,255,0.2);">
    <strong style="color: #ffcccc;">âš ï¸ Important Context:</strong> 
    These charts query <strong style="color: #ffffff;">independent databases</strong> (FPDS vs. FSRS). 
    Because of different reporting timelines and the $30k subaward threshold, <strong>the numbers will not sum perfectly</strong>. Do not try to reconcile them dollar-for-dollar.
  </div>

  <strong style="color: #ffffff;">So What?</strong> 
  Despite the reporting mismatch, the visual gap generally represents <strong>"Self-Performance"</strong> (revenue kept in-house).
  <br><br>
  <strong style="color: #ffffff;">Pro Tip:</strong> Don't focus on the math. Target Primes with <strong style="color: #ffffff;">high subaward volume</strong> in the bottom chart. These are your <strong>highest-probability teaming prospects</strong>, especially where you see them subbing work to companies similar to your own or your competitors.
</div>
  </div>
</div>
        
        <div style="margin-top: 1.5rem;">
          <div class="section-header" style="margin: 0 0 1rem 0;">
            <div class="section-title-group">
              <i class="fas fa-stream accent"></i>
              <span class="section-title mono bold accent upper">Prime to Sub Flow</span>
            </div>
            <div id="subcontractingStats" class="section-subtitle"></div>
          </div>
          <div id="subcontractingPanel" class="analysis-panel" style="min-height: 420px;">
            <div class="analysis-panel-body" id="subcontractingBody" style="padding: 0.5rem; position: relative;">
              </div>
          </div>
        </div>
      </div>

      <div id="subagencyPanel" class="subagency-panel" style="display: none;">
        <div class="subagency-header">
          <div class="subagency-header-left">
            <div class="subagency-header-icon">
              <i class="fas fa-building"></i>
            </div>
            <div class="subagency-header-text">
              <h3 id="subagencyParentName">Department of Defense</h3>
              <span id="subagencyParentType">Parent Agency</span>
            </div>
          </div>
          <div class="subagency-stats">
            <div class="subagency-stat">
              <div class="subagency-stat-val" id="subagencyTotalAmount">$0</div>
              <div class="subagency-stat-label">Total Value</div>
            </div>
            <div class="subagency-stat">
              <div class="subagency-stat-val" id="subagencyCount">0</div>
              <div class="subagency-stat-label">Sub-Agencies</div>
            </div>
          </div>
        </div>
        <div class="subagency-list" id="subagencyList"></div>
      </div>


      <!-- Subcontract Awardees Panel -->
<div id="searchSubcontractPanel" class="job-intel-panel" style="margin: 1.5rem 0;">
  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
    
    <!-- Top Primes with LinkedIn Links -->
    <div>
      <div class="section-header" style="margin: 0 0 0.75rem 0;">
        <div class="section-title-group">
          <i class="fas fa-building accent"></i>
          <span class="section-title mono bold accent upper text-xs">Top Primes who Subcontract</span>
          <span class="section-subtitle" style="margin-left: 6px;">Primes</span>
        </div>
      </div>
      <div class="analysis-panel" style="min-height: auto;">
        <div class="analysis-panel-body" id="searchTopPrimesBody" style="padding: 0.75rem;">
          <div class="muted text-xs" style="text-align:center;">Run a search to see top primes</div>
        </div>
      </div>
    </div>
    
    <!-- Top Subs with LinkedIn Links -->
    <div>
      <div class="section-header" style="margin: 0 0 0.75rem 0;">
        <div class="section-title-group">
          <i class="fas fa-handshake accent"></i>
          <span class="section-title mono bold accent upper text-xs">Top Subcontractors</span>
          <span class="section-subtitle" style="margin-left: 6px;">Subcontractors</span>
        </div>
      </div>
      <div class="analysis-panel" style="min-height: auto;">
        <div class="analysis-panel-body" id="searchTopSubsBody" style="padding: 0.75rem;">
          <div class="muted text-xs" style="text-align:center;">Run a search to see top subs</div>
        </div>
      </div>
    </div>
    
  </div>
</div>

      <div class="section-header">
        <div class="section-title-group">
          <i class="fas fa-list-ul accent"></i>
          <span class="section-title mono bold accent upper">Contract Award Feed</span>
        </div>
      </div>
      <div id="feedGrid" class="feed-grid"></div>

    </div> <div id="forecastModeView" class="view-section">
      
      <div class="stats-row" id="forecastStats" style="grid-template-columns: repeat(6, 1fr);">
        <div class="stat-item">
          <div class="stat-label">Awards</div>
          <div class="stat-val" id="stat-total-awards">-</div>
          <div class="stat-sub neutral">Last 12 Months</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Obligations</div>
          <div class="stat-val" id="stat-total-obligations">-</div>
          <div class="stat-sub neutral">Last Complete FY</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">YoY Trend</div>
          <div class="stat-val" id="stat-yoy-change">-</div>
          <div class="stat-sub" id="stat-yoy-direction">-</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Expiring Soon</div>
          <div class="stat-val" id="stat-recompetes">-</div>
          <div class="stat-sub" style="color:var(--danger)">Next 24 Months</div>
        </div>
        <div class="stat-item stat-item-action" data-action="openSalesPlan" style="cursor:pointer; background-color:#272727; border-color:var(--accent);">
          <div class="stat-label accent">GTM Plan</div>
          <div class="stat-val" style="font-size:1.5rem;"><i class="fas fa-file-export accent"></i></div>
          <div class="stat-sub accent">Export to AI</div>
        </div>
        <div class="stat-item stat-item-action" data-action="openPipelineBuilder" style="cursor:pointer; background-color:#1a2a1a; border-color:var(--success);">
          <div class="stat-label" style="color:var(--success);">Pipeline Builder</div>
          <div class="stat-val" style="font-size:1.5rem;"><i class="fas fa-chart-line" style="color:var(--success);"></i></div>
          <div class="stat-sub" style="color:var(--success);">Build from History</div>
        </div>
      </div>

      <div id="projectionSummary" class="projection-summary"></div>
      
      <div class="section-header" style="margin-top:1.5rem;">
        <div class="section-title-group">
          <i class="fas fa-calculator accent"></i>
          <span class="section-title mono bold accent upper">Quarterly Projection</span>
        </div>
        <span class="section-subtitle text-sm muted">Based on obligation history (not contract ceilings)</span>
      </div>
        
      <div id="forecastTableContainer" class="forecast-table-wrapper">
        <table class="forecast-table">
          <thead>
            <tr>
              <th>Quarter</th>
              <th>3-Year Avg</th>
              <th>Last Year</th>
              <th>Projection</th>
            </tr>
          </thead>
          <tbody id="forecastTableBody"></tbody>
        </table>
      </div>
     
      <div style="margin-top: 1.5rem;">
        <div class="chart-wrapper">
          <div class="section-title mono bold accent upper text-xs" style="margin-bottom:1rem;">Historical Spend</div>
          <canvas id="spendingChart" style="max-height: 300px;"></canvas>
        </div>
      </div>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-top: 1.5rem;">
        <div>
          <div class="section-header" style="margin: 0 0 1rem 0;">
            <div class="section-title-group">
              <i class="fas fa-landmark accent"></i>
              <span class="section-title mono bold accent upper">Top Agency Buyers</span>
            </div>
          </div>
          <div id="topBuyersPanel" class="analysis-panel">
            <div class="analysis-panel-body" id="topBuyersBody">
              <div class="muted" style="text-align:center; padding:1rem;">Loading...</div>
            </div>
          </div>
        </div>

        <div>
          <div class="section-header" style="margin: 0 0 1rem 0;">
            <div class="section-title-group">
              <i class="fas fa-dollar"></i><i class="fas fa-dollar"></i><i class="fas fa-dollar"></i>
              <span class="section-title mono bold accent upper">Top Prime Contractors</span>
            </div>
          </div>
          <div id="topWinnersPanel" class="analysis-panel">
            <div class="analysis-panel-body" id="topWinnersBody">
              <div class="muted" style="text-align:center; padding:1rem;">Loading...</div>
            </div>
          </div>
        </div>
      </div>


      <div id="recompetesList" style="margin-top:2rem;"></div>

    </div> </div>
</div>
<div id="loader" class="loader">
  <div class="spinner"></div>
  <p id="loaderText" style="margin-top:1rem; font-family:'JetBrains Mono'; color:var(--accent);">RETRIEVING DATA...</p>
  <p id="loaderSubtext" style="color:#666; font-size:0.8rem; margin-top:0.5rem;"></p>
</div>

<div id="salesPlanModal" class="channel-marking-modal">
  <div class="channel-modal-content" style="max-width: 900px;">
    <div class="channel-modal-header">
      <div class="channel-modal-title"><i class="fas fa-rocket"></i> GTM PLAN PROMPT</div>
      <button class="channel-modal-close" data-action="closeSalesPlan"><i class="fas fa-times"></i></button>
    </div>
    
    <div class="channel-modal-body" style="flex:1; overflow-y:auto; padding:0;">
      
      <!-- NEW: Intent Detection Banner -->
      <div id="spIntentBanner"></div>
      
      <!-- Step 1: Scope -->
      <div style="padding:1.5rem; border-bottom:1px solid var(--border); background:rgba(255,255,255,0.02);">
        <div style="font-size:0.85rem; color:var(--accent); font-weight:700; margin-bottom:1rem; text-transform:uppercase; letter-spacing:1px;">
          <i class="fas fa-bullseye"></i> Step 1: Define Plan Scope
        </div>
        <div class="step-grid" style="display:grid; grid-template-columns: 1fr 1fr; gap:1.5rem;">
          <div>
            <label style="display:block; font-size:0.75rem; color:var(--text-muted); margin-bottom:0.5rem; font-weight:600;">
              PLAN SCOPE / SECTOR
            </label>
            <select id="spScope" class="main-input" style="padding:0.6rem; font-size:0.9rem; background:var(--bg-app);">
              <option value="all">Entire Market (All Results)</option>
              <option value="defense">Defense (DoD & Branches)</option>
              <option value="civilian">Federal Civilian (Non-DoD)</option>
              <optgroup label="Specific Agencies" id="spSpecificAgencies"></optgroup>
            </select>
          </div>
          <div>
            <label style="display:block; font-size:0.75rem; color:var(--text-muted); margin-bottom:0.5rem; font-weight:600;">
              STRATEGIC GOAL
              <span style="cursor:help; margin-left:4px;" title="Growth = New business pursuit&#10;Retention = Defend existing contracts&#10;Partnership = Channel/partner optimization">â“˜</span>
            </label>
            <select id="spFocus" class="main-input" style="padding:0.6rem; font-size:0.9rem; background:var(--bg-app);">
              <option value="Growth">Aggressive Growth (New Business)</option>
              <option value="Retention">Retention (Defend Incumbency)</option>
              <option value="Partnership">Partner/Channel Strategy</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Step 2: Vendor Classification -->
      <div style="padding:1.5rem;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
          <div style="font-size:0.85rem; color:var(--accent); font-weight:700; text-transform:uppercase; letter-spacing:1px;">
            <i class="fas fa-sitemap"></i> Step 2: Classify Vendors
          </div>
          <div id="spBulkActionContainer"></div>
        </div>
        
        <div style="background:rgba(212, 196, 168, 0.05); padding:0.75rem; border-radius:4px; margin-bottom:1.5rem; font-size:0.8rem; color:var(--text-muted); border-left:2px solid var(--accent);">
          <i class="fas fa-magic" style="color:var(--accent);"></i>
          <strong>Smart Detection:</strong> We've pre-identified likely resellers based on known patterns. Accept our suggestions or customize below.
        </div>

        <div id="spVendorList"></div>
      </div>
    </div>

    <!-- Footer -->
    <div class="channel-modal-footer">
      <div class="modal-footer-buttons">
        <button id="btnCopyPrompt" class="modal-btn modal-btn-primary" data-action="copyPrompt">
          <i class="fas fa-copy"></i> Copy Prompt
        </button>
        <div class="modal-footer-secondary">
          <button class="modal-btn modal-btn-cancel" data-action="closeSalesPlan">Cancel</button>
          <button class="modal-btn modal-btn-cancel" data-action="generateDownload" title="Download as .txt file">
            <i class="fas fa-download"></i> .TXT
          </button>
        </div>
      </div>
      <div id="spDataStatus" class="modal-status-line"></div>
    </div>
  </div>
</div>

<!-- Pipeline Builder Modal -->
<div id="pipelineBuilderModal" class="pipeline-modal">
  <div class="pipeline-modal-content">
    <div class="channel-modal-header">
      <div class="channel-modal-title"><i class="fas fa-chart-line" style="color:var(--success);"></i> ANNUAL PIPELINE BUILDER</div>
      <button class="channel-modal-close" data-action="closePipelineBuilder"><i class="fas fa-times"></i></button>
    </div>
    
    <div class="channel-modal-body" style="flex:1; overflow-y:auto; padding:1.5rem;">
      <!-- Configuration -->
      <div style="background:rgba(95, 128, 85, 0.1); border-left:3px solid var(--success); padding:1rem; margin-bottom:1.5rem; font-size:0.85rem; color:var(--text-primary); line-height:1.5;">
        <strong><i class="fas fa-info-circle" style="color:var(--success);"></i> How it works:</strong> 
        This tool analyzes historical USAspending data to identify cyclic spending patterns and generates potential pipeline opportunities for the upcoming fiscal year. Opportunities are projected based on real historical awardsâ€”not placeholders.
      </div>
      
      <div class="pipeline-config-row">
        <div class="pipeline-config-item">
          <label>Target Fiscal Year</label>
          <select id="pipelineTargetFY">
            <!-- Options populated dynamically -->
          </select>
        </div>
        <div class="pipeline-config-item">
          <label>Historical Years to Analyze</label>
          <select id="pipelineHistoryYears">
            <option value="2">2 Years</option>
            <option value="3" selected>3 Years</option>
            <option value="4">4 Years</option>
            <option value="5">5 Years</option>
          </select>
        </div>
        <div class="pipeline-config-item">
          <label>Probability Multiplier</label>
          <select id="pipelineProbMultiplier">
            <option value="0.5">Conservative (50%)</option>
            <option value="0.7" selected>Moderate (70%)</option>
            <option value="0.9">Aggressive (90%)</option>
            <option value="1.0">Full Historical (100%)</option>
          </select>
        </div>
      </div>
      
      <div class="pipeline-config-row">
        <div class="pipeline-config-item">
          <label>Minimum Deal Size</label>
          <select id="pipelineMinDeal">
            <option value="0">No Minimum</option>
            <option value="25000">$25K+</option>
            <option value="50000" selected>$50K+</option>
            <option value="100000">$100K+</option>
            <option value="250000">$250K+</option>
            <option value="500000">$500K+</option>
            <option value="1000000">$1M+</option>
          </select>
        </div>
        <div class="pipeline-config-item">
          <label>Focus Agency (Optional)</label>
          <select id="pipelineFocusAgency">
            <option value="">All Agencies in Results</option>
            <!-- Populated dynamically -->
          </select>
        </div>
        <div class="pipeline-config-item">
          <label>&nbsp;</label>
          <button class="pipeline-builder-btn" style="width:100%;" data-action="generatePipeline">
            <i class="fas fa-magic"></i> Generate Pipeline
          </button>
        </div>
      </div>
      
      <!-- Results Area -->
      <div id="pipelineResultsArea" style="display:none;">
        <div class="section-header" style="margin:1.5rem 0 1rem 0;">
          <div class="section-title-group">
            <i class="fas fa-clipboard-list" style="color:var(--success);"></i>
            <span class="section-title mono bold upper" style="color:var(--success);">Generated Pipeline</span>
          </div>
          <span id="pipelineResultCount" class="section-subtitle"></span>
        </div>
        
        <div id="pipelineStatsGrid" class="pipeline-results-grid"></div>
        
        <div id="pipelineTableContainer" class="pipeline-table-wrapper"></div>
      </div>
      
      <!-- Loading State -->
      <div id="pipelineLoading" class="pipeline-progress" style="display:none;">
        <div class="spinner"></div>
        <span>Analyzing historical spending patterns...</span>
      </div>
    </div>
    
    <!-- Footer -->
    <div class="channel-modal-footer">
      <div class="modal-footer-buttons">
        <button id="btnDownloadPipeline" class="modal-btn modal-btn-primary" data-action="downloadPipelineCSV" style="background:var(--success);" disabled>
          <i class="fas fa-download"></i> Download CSV (Salesforce Ready)
        </button>
        <div class="modal-footer-secondary">
          <button class="modal-btn modal-btn-cancel" data-action="closePipelineBuilder">Close</button>
        </div>
      </div>
      <div id="pipelineDataStatus" class="modal-status-line">Configure options and click Generate to build your pipeline.</div>
    </div>
  </div>
</div>

<script>
// ========================================
// SECTION 1: CONSTANTS & CONFIG
// ========================================
const US_STATES = {
  'AL':'Alabama','AK':'Alaska','AZ':'Arizona','AR':'Arkansas','CA':'California',
  'CO':'Colorado','CT':'Connecticut','DE':'Delaware','FL':'Florida','GA':'Georgia',
  'HI':'Hawaii','ID':'Idaho','IL':'Illinois','IN':'Indiana','IA':'Iowa',
  'KS':'Kansas','KY':'Kentucky','LA':'Louisiana','ME':'Maine','MD':'Maryland',
  'MA':'Massachusetts','MI':'Michigan','MN':'Minnesota','MS':'Mississippi','MO':'Missouri',
  'MT':'Montana','NE':'Nebraska','NV':'Nevada','NH':'New Hampshire','NJ':'New Jersey',
  'NM':'New Mexico','NY':'New York','NC':'North Carolina','ND':'North Dakota','OH':'Ohio',
  'OK':'Oklahoma','OR':'Oregon','PA':'Pennsylvania','RI':'Rhode Island','SC':'South Carolina',
  'SD':'South Dakota','TN':'Tennessee','TX':'Texas','UT':'Utah','VT':'Vermont',
  'VA':'Virginia','WA':'Washington','WV':'West Virginia','WI':'Wisconsin','WY':'Wyoming',
  'DC':'Washington DC','PR':'Puerto Rico','GU':'Guam','VI':'Virgin Islands'
};

// ========================================
// SECTION 2: LIBRARY LOADER (Smart Preloading)
// ========================================
const LibLoader = {
  d3Loaded: false,
  chartLoaded: false,
  loading: { d3: null, chart: null },
  
  async loadD3() {
    if (this.d3Loaded && window.d3 && window.d3.sankey) return Promise.resolve();
    if (this.loading.d3) return this.loading.d3;
    
    this.loading.d3 = new Promise((resolve, reject) => {
      const script1 = document.createElement('script');
      script1.src = 'https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js';
      script1.onload = () => {
        const script2 = document.createElement('script');
        script2.src = 'https://cdnjs.cloudflare.com/ajax/libs/d3-sankey/0.12.3/d3-sankey.min.js';
        script2.onload = () => { this.d3Loaded = true; resolve(); };
        script2.onerror = reject;
        document.head.appendChild(script2);
      };
      script1.onerror = reject;
      document.head.appendChild(script1);
    });
    return this.loading.d3;
  },
  
  async loadChart() {
    if (this.chartLoaded && window.Chart) return Promise.resolve();
    if (this.loading.chart) return this.loading.chart;
    
    this.loading.chart = new Promise((resolve, reject) => {
      const script = document.createElement('script');
      script.src = 'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js';
      script.onload = () => { this.chartLoaded = true; resolve(); };
      script.onerror = reject;
      document.head.appendChild(script);
    });
    return this.loading.chart;
  },
  
  async ensureAll() {
    await Promise.all([this.loadD3(), this.loadChart()]);
  },
  
  // Preload during idle time - runs after page load for instant first search
  preloadWhenIdle() {
    if ('requestIdleCallback' in window) {
      requestIdleCallback(() => this.ensureAll(), { timeout: 2000 });
    } else {
      setTimeout(() => this.ensureAll(), 100);
    }
  }
};

// ========================================
// SECTION 3: UTILITIES
// ========================================
const Utils = {
  money: n => {
    if (!n && n !== 0) return '-';
    if(n >= 1e9) return '$' + (n/1e9).toFixed(1) + 'B';
    if(n >= 1e6) return '$' + (n/1e6).toFixed(1) + 'M';
    if(n >= 1e3) return '$' + (n/1e3).toFixed(0) + 'K';
    return '$' + Math.round(n).toLocaleString();
  },
  trunc: (s, l) => (s && s.length > l) ? s.substring(0,l)+'...' : (s || 'No Description'),
  date: s => s ? new Date(s).toLocaleDateString() : 'â€”',
  formatDateISO: date => date.toISOString().split('T')[0],
  
  getCurrentFY: () => {
    const now = new Date();
    // Federal FY starts Oct 1 (Month 9)
    return now.getMonth() >= 9 ? now.getFullYear() + 1 : now.getFullYear();
  },

  getCurrentQuarter: () => {
    const m = new Date().getMonth(); // 0-11
    if (m >= 9) return 1;
    if (m <= 2) return 2;
    if (m <= 5) return 3;
    return 4;
  },
  
getColor: name => {
  const palette = [
    '#D66D64', // Faded Red (Tomato)
    '#E3B66D', // Aged Yellow (Mustard)
    '#6B8E88', // Muted Teal (Slate)
    '#8D769A', // Dusty Violet
    '#D99368', // Burnt Orange (Terra Cotta)
    '#7A8869', // Olive Green
    '#708BA3'  // Faded Denim Blue
  ];
  
  let hash = 0;
  for (let i = 0; i < name.length; i++) {
    hash = name.charCodeAt(i) + ((hash << 5) - hash);
  }
  return palette[Math.abs(hash) % palette.length];
},

queryAliases: {
  // Big Tech & Defense Primes
  'aws': 'Amazon',
  'gcp': 'Google Cloud',
  'msft': 'Microsoft',
  'ibm': 'International Business Machines',
  'hp': 'Hewlett Packard',
  'hpe': 'Hewlett Packard Enterprise',
  'dell': 'Dell Technologies',
  'gd': 'General Dynamics',
  'gdit': 'General Dynamics Information Technology',
  'lmco': 'Lockheed Martin',
  'ngc': 'Northrop Grumman',
  'bah': 'Booz Allen Hamilton',
  'saic': 'Science Applications International',
  
  // Cabinet Departments
  'dod': 'Department of Defense',
  'doj': 'Department of Justice',
  'dhs': 'Department of Homeland Security',
  'hhs': 'Health and Human Services',
  'dot': 'Department of Transportation',
  'doe': 'Department of Energy',
  'doi': 'Department of the Interior',
  'dol': 'Department of Labor',
  'doc': 'Department of Commerce',
  'dos': 'Department of State',
  'ed': 'Department of Education',
  'hud': 'Housing and Urban Development',
  'usda': 'Department of Agriculture',
  'va': 'Veterans Affairs',
  
  // Defense & Intel
  'army': 'Department of the Army',
  'navy': 'Department of the Navy',
  'usaf': 'Department of the Air Force',
  'ussf': 'Space Force',
  'usmc': 'Marine Corps',
  'cia': 'Central Intelligence Agency',
  'nsa': 'National Security Agency',
  'nga': 'National Geospatial-Intelligence Agency',
  'nro': 'National Reconnaissance Office',
  'dia': 'Defense Intelligence Agency',
  'disa': 'Defense Information Systems Agency',
  'darpa': 'Defense Advanced Research Projects Agency',
  'dcsa': 'Defense Counterintelligence and Security Agency',
  'dla': 'Defense Logistics Agency',
  'mda': 'Missile Defense Agency',
  'socom': 'Special Operations Command',
  'cybercom': 'Cyber Command',
  'stratcom': 'Strategic Command',
  'transcom': 'Transportation Command',
  'centcom': 'Central Command',
  'eucom': 'European Command',
  'indopacom': 'Indo-Pacific Command',
  'northcom': 'Northern Command',
  'southcom': 'Southern Command',
  'africom': 'Africa Command',
  
  // Major Agencies
  'gsa': 'General Services Administration',
  'nasa': 'National Aeronautics and Space Administration',
  'fbi': 'Federal Bureau of Investigation',
  'dea': 'Drug Enforcement Administration',
  'atf': 'Bureau of Alcohol Tobacco Firearms and Explosives',
  'usps': 'Postal Service',
  'irs': 'Internal Revenue Service',
  'epa': 'Environmental Protection Agency',
  'fda': 'Food and Drug Administration',
  'cdc': 'Centers for Disease Control and Prevention',
  'nih': 'National Institutes of Health',
  'cms': 'Centers for Medicare and Medicaid Services',
  'ssa': 'Social Security Administration',
  'opm': 'Office of Personnel Management',
  'sba': 'Small Business Administration',
  'fema': 'Federal Emergency Management Agency',
  'tsa': 'Transportation Security Administration',
  'cbp': 'Customs and Border Protection',
  'ice': 'Immigration and Customs Enforcement',
  'uscis': 'Citizenship and Immigration Services',
  'usss': 'Secret Service',
  'cisa': 'Cybersecurity and Infrastructure Security Agency',
  'faa': 'Federal Aviation Administration',
  'fhwa': 'Federal Highway Administration',
  'fra': 'Federal Railroad Administration',
  'fta': 'Federal Transit Administration',
  'noaa': 'National Oceanic and Atmospheric Administration',
  'nist': 'National Institute of Standards and Technology',
  'census': 'Census Bureau',
  'ita': 'International Trade Administration',
  'blm': 'Bureau of Land Management',
  'nps': 'National Park Service',
  'usfs': 'Forest Service',
  'fws': 'Fish and Wildlife Service',
  'usgs': 'Geological Survey',
  'bia': 'Bureau of Indian Affairs',
  'boem': 'Bureau of Ocean Energy Management',
  'bor': 'Bureau of Reclamation',
  'ferc': 'Federal Energy Regulatory Commission',
  'nnsa': 'National Nuclear Security Administration',
  'sec': 'Securities and Exchange Commission',
  'ftc': 'Federal Trade Commission',
  'fcc': 'Federal Communications Commission',
  'nlrb': 'National Labor Relations Board',
  'eeoc': 'Equal Employment Opportunity Commission',
  'gao': 'Government Accountability Office',
  'omb': 'Office of Management and Budget',
  'cbo': 'Congressional Budget Office',
  'nara': 'National Archives and Records Administration',
  'pbgc': 'Pension Benefit Guaranty Corporation',
  'usaid': 'Agency for International Development',
  'amtrak': 'Amtrak',
  'fdic': 'Federal Deposit Insurance Corporation',
  'ncua': 'National Credit Union Administration',
  'cfpb': 'Consumer Financial Protection Bureau',
  'exim': 'Export-Import Bank'
},
normalizeQuery(query) {
  const lower = query.toLowerCase().trim();
  return this.queryAliases[lower] || query;
},
  missionGapRisk(award) {
    const endDate = new Date(award['End Date']);
    const daysUntil = Math.ceil((endDate - new Date()) / (1000 * 60 * 60 * 24));

    const amt = parseFloat(award['Award Amount']) || 0;

    const desc = (award['Description'] || '').toLowerCase();
    const pscDesc = (award['PSC Description'] || '').toLowerCase();
    const naicsDesc = (award['NAICS Description'] || '').toLowerCase();
    const psc = (award['PSC Code'] || '').toUpperCase();

    // Ongoing support signals - tune this list over time
    const supportTerms = [
      'operations', 'o&m', 'maintenance', 'sustainment', 'help desk', 'service desk',
      'support services', 'managed services', 'hosting', 'cloud', 'network',
      'cyber', 'security', 'monitoring', 'soc', 'continuity', 'backup', 'dr', 'patch',
      'infrastructure', 'enterprise', 'mission', 'critical', '24/7', 'production'
    ];

    const text = `${desc} ${pscDesc} ${naicsDesc}`;
    const supportHits = supportTerms.filter(t => text.includes(t));
    const looksOperational = supportHits.length >= 2;

    // PSC shortcuts - common federal service families
    // D = IT/Data Processing, R = Professional Services, J = Maintenance/Repair
    const servicePscPrefixes = ['D', 'R', 'J'];
    const isServicePsc = servicePscPrefixes.includes(psc.slice(0, 1));

    // Risk logic
    if (daysUntil <= 180 && (looksOperational || isServicePsc) && amt >= 250000) {
      return { level: 'high', daysUntil, reasons: supportHits.slice(0, 4) };
    }
    if (daysUntil <= 365 && (looksOperational || isServicePsc) && amt >= 100000) {
      return { level: 'medium', daysUntil, reasons: supportHits.slice(0, 3) };
    }
    return { level: 'low', daysUntil, reasons: supportHits.slice(0, 2) };
  },
  
  // Consolidated search term parser - eliminates duplication across API methods
  parseSearchTerms(keywords) {
    const pscPattern = /^[A-Z]\d{1,3}$|^\d{1,2}[A-Z]\d{0,2}$/i;
    const terms = keywords.split(',').map(s => s.trim()).filter(s => s.length > 0);
    const pscCodes = terms.filter(t => pscPattern.test(t)).map(t => t.toUpperCase());
    const keywordTerms = terms.filter(t => !pscPattern.test(t));
    return { pscCodes, keywordTerms, allTerms: terms };
  },
  
  // Build filters for API calls - consolidates filter building logic
  buildFilters(keywords, timePeriods) {
    const { pscCodes, keywordTerms } = this.parseSearchTerms(keywords);
    const filters = { time_period: timePeriods, award_type_codes: ['A','B','C','D'] };
    if (pscCodes.length > 0) filters.psc_codes = pscCodes;
    if (keywordTerms.length > 0) filters.keywords = keywordTerms;
    if (!filters.psc_codes && !filters.keywords) filters.keywords = [keywords];
    return filters;
  }
};

// ==================== MODAL UTILITIES ====================
const ModalUtils = {
  activeModal: null,
  previousFocus: null,
  
  open(modalId) {
    const modal = document.getElementById(modalId);
    if (!modal) return;
    
    // Store previous focus for restoration
    this.previousFocus = document.activeElement;
    
    // Lock body scroll
    document.body.style.overflow = 'hidden';
    
    // Show modal
    modal.classList.add('active');
    this.activeModal = modal;
    
    // Focus first focusable element
    const focusable = modal.querySelector('button, input, select, textarea');
    if (focusable) setTimeout(() => focusable.focus(), 50);
    
    // Add event listeners
    this._boundKeydown = this.handleKeydown.bind(this);
    this._boundBackdrop = this.handleBackdropClick.bind(this);
    document.addEventListener('keydown', this._boundKeydown);
    modal.addEventListener('click', this._boundBackdrop);
  },
  
  close() {
    if (!this.activeModal) return;
    
    const modal = this.activeModal;
    
    // Hide modal
    modal.classList.remove('active');
    
    // Restore body scroll
    document.body.style.overflow = '';
    
    // Restore previous focus
    if (this.previousFocus && this.previousFocus.focus) {
      this.previousFocus.focus();
    }
    
    // Remove event listeners
    document.removeEventListener('keydown', this._boundKeydown);
    modal.removeEventListener('click', this._boundBackdrop);
    
    this.activeModal = null;
  },
  
  handleKeydown(e) {
    if (e.key === 'Escape') {
      this.close();
      return;
    }
    
    // Focus trap - keep Tab within modal
    if (e.key === 'Tab' && this.activeModal) {
      const focusables = this.activeModal.querySelectorAll(
        'button:not([disabled]), input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"])'
      );
      if (focusables.length === 0) return;
      
      const first = focusables[0];
      const last = focusables[focusables.length - 1];
      
      if (e.shiftKey && document.activeElement === first) {
        e.preventDefault();
        last.focus();
      } else if (!e.shiftKey && document.activeElement === last) {
        e.preventDefault();
        first.focus();
      }
    }
  },
  
  handleBackdropClick(e) {
    // Close only if clicking the backdrop itself, not the content
    if (e.target === this.activeModal) {
      this.close();
    }
  }
};

// ==================== AUTOCOMPLETE ====================
const Autocomplete = {
  activeInput: null,
  dropdown: null,
  debounceTimer: null,
  selectedIndex: -1,
  results: { agencies: [], recipients: [] },
  
init(inputId) {
  const input = document.getElementById(inputId);
  if (!input) return;
  
  // Wrap input if not already wrapped
  if (!input.parentElement.classList.contains('autocomplete-wrapper')) {
    const wrapper = document.createElement('div');
    wrapper.className = 'autocomplete-wrapper';
    input.parentNode.insertBefore(wrapper, input);
    wrapper.appendChild(input);
  }
  
  // Create dropdown
  const dropdown = document.createElement('div');
  dropdown.className = 'autocomplete-dropdown';
  dropdown.id = `${inputId}-dropdown`;
  input.parentElement.appendChild(dropdown);
  
  // Event listeners
  input.addEventListener('input', (e) => this.handleInput(e, inputId));
  input.addEventListener('keydown', (e) => this.handleKeydown(e, inputId));
  input.addEventListener('focus', (e) => this.handleFocus(e, inputId));
  input.addEventListener('blur', () => setTimeout(() => this.hide(inputId), 200));
},
  
  handleInput(e, inputId) {
    const query = e.target.value.trim();
    clearTimeout(this.debounceTimer);
    
    if (query.length < 2) {
      this.hide(inputId);
      return;
    }
    
    this.debounceTimer = setTimeout(() => this.search(query, inputId), 250);
  },
  
  handleFocus(e, inputId) {
    const query = e.target.value.trim();
    if (query.length >= 2 && this.hasResults()) {
      this.show(inputId);
    }
  },
  
  handleKeydown(e, inputId) {
    const dropdown = document.getElementById(`${inputId}-dropdown`);
    if (!dropdown || !dropdown.classList.contains('active')) {
      if (e.key === 'ArrowDown' && e.target.value.length >= 2) {
        this.search(e.target.value.trim(), inputId);
      }
      return;
    }
    
    const items = dropdown.querySelectorAll('.autocomplete-item');
    
    if (e.key === 'ArrowDown') {
      e.preventDefault();
      this.selectedIndex = Math.min(this.selectedIndex + 1, items.length - 1);
      this.updateSelection(items);
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      this.selectedIndex = Math.max(this.selectedIndex - 1, 0);
      this.updateSelection(items);
    } else if (e.key === 'Enter' && this.selectedIndex >= 0) {
      e.preventDefault();
      items[this.selectedIndex]?.click();
    } else if (e.key === 'Escape') {
      this.hide(inputId);
    }
  },
  
  updateSelection(items) {
    items.forEach((item, i) => {
      item.classList.toggle('selected', i === this.selectedIndex);
    });
    items[this.selectedIndex]?.scrollIntoView({ block: 'nearest' });
  },
  
  async search(query, inputId) {
    try {
      const [agencies, recipients] = await Promise.all([
        API.autocompleteAgency(query),
        API.autocompleteRecipient(query)
      ]);
      
      this.results = { agencies, recipients };
      this.selectedIndex = -1;
      this.render(inputId);
    } catch (e) {
      console.error('Autocomplete error:', e);
    }
  },
  
  hasResults() {
    return this.results.agencies.length > 0 || 
           this.results.recipients.length > 0;
  },
  
  render(inputId) {
    const dropdown = document.getElementById(`${inputId}-dropdown`);
    if (!dropdown) return;
    
    const { agencies, recipients } = this.results;
    
    if (!this.hasResults()) {
      dropdown.innerHTML = '<div class="autocomplete-empty">No matches found</div>';
      this.show(inputId);
      return;
    }
    
    let html = '';
    
    if (agencies.length > 0) {
      html += `<div class="autocomplete-section">
        <div class="autocomplete-section-label mono muted upper"><i class="fas fa-landmark"></i> Agencies</div>
        ${agencies.slice(0, 5).map(a => `
          <div class="autocomplete-item" data-type="agency" data-value="${this.escapeHtml(a.subtier_agency?.name || a.toptier_agency?.name || '')}">
            <i class="fas fa-building muted"></i>
            <div class="autocomplete-item-text">
              <div class="autocomplete-item-main truncate">${this.escapeHtml(a.subtier_agency?.name || a.toptier_agency?.name || 'Unknown')}</div>
              ${a.toptier_agency?.name && a.subtier_agency?.name ? `<div class="autocomplete-item-sub muted">${this.escapeHtml(a.toptier_agency.name)}</div>` : ''}
            </div>
          </div>
        `).join('')}
      </div>`;
    }
    
    if (recipients.length > 0) {
      html += `<div class="autocomplete-section">
        <div class="autocomplete-section-label mono muted upper"><i class="fas fa-briefcase"></i> Vendors & Keywords</div>
        ${recipients.slice(0, 5).map(r => `
          <div class="autocomplete-item" data-type="recipient" data-value="${this.escapeHtml(r.recipient_name || '')}">
            <i class="fas fa-briefcase muted"></i>
            <div class="autocomplete-item-text">
              <div class="autocomplete-item-main truncate">${this.escapeHtml(r.recipient_name || 'Unknown')}</div>
              ${r.uei ? `<div class="autocomplete-item-sub muted">UEI: ${r.uei}</div>` : ''}
            </div>
          </div>
        `).join('')}
      </div>`;
    }
    
    dropdown.innerHTML = html;
    
    // Add click handlers
    dropdown.querySelectorAll('.autocomplete-item').forEach(item => {
      item.addEventListener('click', () => {
        const input = document.getElementById(inputId);
        if (input) {
          input.value = item.dataset.value;
          input.focus();
        }
        this.hide(inputId);
      });
    });
    
    this.show(inputId);
  },
  
  show(inputId) {
    const dropdown = document.getElementById(`${inputId}-dropdown`);
    if (dropdown) dropdown.classList.add('active');
  },
  
  hide(inputId) {
    const dropdown = document.getElementById(`${inputId}-dropdown`);
    if (dropdown) dropdown.classList.remove('active');
    this.selectedIndex = -1;
  },
  
  escapeHtml(str) {
    if (!str) return '';
    return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
  }
};

// ==================== API ====================
const API = {
  baseUrl: 'https://api.usaspending.gov/api/v2',
  
  // Search Mode API
  async searchAwards(keywords) {
    const today = new Date();
    const oneYearAgo = new Date();
    oneYearAgo.setFullYear(today.getFullYear() - 1);
    
    const period = {
      start_date: Utils.formatDateISO(oneYearAgo),
      end_date: Utils.formatDateISO(today)
    };
    
    // Use consolidated term parser
    const { allTerms } = Utils.parseSearchTerms(keywords);
    const pscPattern = /^[A-Z]\d{1,3}$|^\d{1,2}[A-Z]\d{0,2}$/i;
    
    const fetchPromises = allTerms.map(term => {
      const filters = { time_period: [period], award_type_codes: ['A','B','C','D'] };
      if (pscPattern.test(term)) filters.psc_codes = [term.toUpperCase()];
      else filters.keywords = [term];
      
      return fetch(`${this.baseUrl}/search/spending_by_award/`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          filters,
          fields: [
            'Award ID', 'Recipient Name', 'Awarding Agency', 'Awarding Sub Agency',
            'Award Amount', 'Description', 'generated_internal_id',
            'Start Date', 'End Date', 'NAICS Code', 'NAICS Description', 'PSC Code', 'PSC Description'
          ],
          limit: 100, sort: 'Award Amount', order: 'desc'
        })
      }).then(res => res.json());
    });
    
    const results = await Promise.all(fetchPromises);
    let combined = [];
    results.forEach(json => { if(json.results) combined = combined.concat(json.results); });
    
    // Deduplicate
    const unique = new Map();
    combined.forEach(item => { if(!unique.has(item['Award ID'])) unique.set(item['Award ID'], item); });
    
    return Array.from(unique.values()).sort((a,b) => b['Award Amount'] - a['Award Amount']);
  },
  
  // Forecast Mode APIs
  async getSpendingOverTime(keywords, yearsBack=4) {
    const curFY = Utils.getCurrentFY();
    const periods = [];
    // Get extra history to establish trends
    for(let y=curFY-yearsBack; y<=curFY; y++) {
      periods.push({start_date:`${y-1}-10-01`, end_date:`${y}-09-30`});
    }
    
    const filters = this._buildFilters(keywords, periods);
    
    const res = await fetch(`${this.baseUrl}/search/spending_over_time/`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        group: 'quarter',
        filters
      })
    });
    return (await res.json()).results || [];
  },
  
  async getAgencyData(keywords, yearsBack=3) {
    const curFY = Utils.getCurrentFY();
    const periods = [{start_date:`${curFY-yearsBack-1}-10-01`, end_date:`${curFY}-09-30`}];
    
    const filters = this._buildFilters(keywords, periods);
    
    const res = await fetch(`${this.baseUrl}/search/spending_by_category/awarding_agency`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        category: 'awarding_agency',
        filters,
        limit: 100
      })
    });
    return (await res.json()).results || [];
  },
  
  async getAwardsForForecast(keywords) {
    // Use same 12-month period as searchAwards for consistency
    const today = new Date();
    const oneYearAgo = new Date();
    oneYearAgo.setFullYear(today.getFullYear() - 1);
    
    const period = {
      start_date: Utils.formatDateISO(oneYearAgo),
      end_date: Utils.formatDateISO(today)
    };
    
    const filters = this._buildFilters(keywords, [period]);
    
    const res = await fetch(`${this.baseUrl}/search/spending_by_award/`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        filters,
        fields: [
          'Award ID', 'Recipient Name', 'Description', 'Start Date', 'End Date', 
          'Award Amount', 'Potential Total Value of Award', 'Awarding Agency', 'Awarding Sub Agency', 'generated_internal_id',
          'NAICS Code', 'NAICS Description', 'PSC Code', 'PSC Description'
        ],
        limit: 100, 
        sort: 'Award Amount',
        order: 'desc'
      })
    });
    return (await res.json()).results || [];
  },
  
  // Helper: Build filters with PSC code detection - delegates to Utils
  _buildFilters(keywords, timePeriods) {
    return Utils.buildFilters(keywords, timePeriods);
  },

  // ==================== NEW: AUTOCOMPLETE ====================
  async autocompleteAgency(searchText) {
    if (!searchText || searchText.length < 2) return [];
    const res = await fetch(`${this.baseUrl}/autocomplete/awarding_agency/`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ search_text: searchText, limit: 8 })
    });
    return (await res.json()).results || [];
  },

  async autocompleteRecipient(searchText) {
    if (!searchText || searchText.length < 2) return [];
    const res = await fetch(`${this.baseUrl}/autocomplete/recipient/`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ search_text: searchText, limit: 8 })
    });
    return (await res.json()).results || [];
  },

  // ==================== SPENDING BY GEOGRAPHY ====================
  async getSpendingByGeography(keywords, geoLayer = 'state') {
    const curFY = Utils.getCurrentFY();
    const res = await fetch(`${this.baseUrl}/search/spending_by_geography/`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        scope: 'place_of_performance',
        geo_layer: geoLayer,
        filters: { 
          keywords: [keywords], 
          time_period: [{start_date: `${curFY-1}-10-01`, end_date: `${curFY}-09-30`}],
          award_type_codes: ['A','B','C','D'] 
        }
      })
    });
    return (await res.json()).results || [];
  },

  // ==================== SUBAWARDS ====================
  async getSubawards(keywords) {
    const today = new Date();
    const oneYearAgo = new Date();
    oneYearAgo.setFullYear(today.getFullYear() - 1);
    
    // Build filters object
    const filters = { 
      time_period: [{
        start_date: Utils.formatDateISO(oneYearAgo),
        end_date: Utils.formatDateISO(today)
      }],
      award_type_codes: ['A','B','C','D']
    };
    
    // Detect if keyword looks like a PSC code (letter + numbers, e.g., DA10, R499, 7A21)
    const pscPattern = /^[A-Z]\d{1,3}$|^\d{1,2}[A-Z]\d{0,2}$/i;
    const terms = keywords.split(',').map(s => s.trim()).filter(s => s.length > 0);
    
    const pscCodes = terms.filter(t => pscPattern.test(t)).map(t => t.toUpperCase());
    const keywordTerms = terms.filter(t => !pscPattern.test(t));
    
    // Add PSC filter if PSC codes detected
    if (pscCodes.length > 0) {
      filters.psc_codes = pscCodes;
    }
    
    // Add keyword filter if non-PSC terms exist
    if (keywordTerms.length > 0) {
      filters.keywords = keywordTerms;
    }
    
    // If only PSC codes, we still need the filter (no keywords required)
    // But if nothing was added, fall back to original keyword
    if (!filters.psc_codes && !filters.keywords) {
      filters.keywords = [keywords];
    }
    
    const res = await fetch(`${this.baseUrl}/search/spending_by_award/`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        subawards: true,
        filters,
        fields: [
          'Sub-Award ID', 'Sub-Awardee Name', 'Sub-Award Amount', 
          'Prime Award ID', 'Prime Recipient Name', 'Sub-Award Date',
          'Awarding Agency', 'Awarding Sub Agency'
        ],
        limit: 100,
        sort: 'Sub-Award Amount',
        order: 'desc'
      })
    });
    return (await res.json()).results || [];
  }
};

// ==================== GEOGRAPHY MAP ====================
const GeoMap = {
  // Use shared US_STATES constant  
  async loadAndRender(containerId, keywords) {
    const container = document.getElementById(containerId);
    if (!container) return;
    
    container.innerHTML = `
      <div class="geo-map-header">
        <div class="geo-map-title"><i class="fas fa-map-marker-alt"></i> Performance Location</div>
        <div class="geo-map-total">Loading...</div>
      </div>
      <div class="geo-states-grid">
        <div style="grid-column: 1/-1; text-align:center; padding:2rem; color:var(--text-muted);">
          <i class="fas fa-spinner fa-spin"></i> Loading geography data...
        </div>
      </div>
    `;
    
    try {
      const data = await API.getSpendingByGeography(keywords, 'state');
      this.render(container, data);
    } catch (e) {
      container.innerHTML = `
        <div class="geo-map-header">
          <div class="geo-map-title"><i class="fas fa-map-marker-alt"></i> Performance Location</div>
        </div>
        <div style="text-align:center; padding:1rem; color:var(--text-muted); font-size:0.85rem;">
          Unable to load geography data
        </div>
      `;
    }
  },
  
  render(container, data) {
    if (!data || data.length === 0) {
      container.innerHTML = `
        <div class="geo-map-header">
          <div class="geo-map-title"><i class="fas fa-map-marker-alt"></i> Performance Location</div>
        </div>
        <div style="text-align:center; padding:1rem; color:var(--text-muted); font-size:0.85rem;">
          No geographic data available
        </div>
      `;
      return;
    }
    
    // Sort by amount descending
    const sorted = data
      .filter(d => d.aggregated_amount > 0)
      .sort((a, b) => b.aggregated_amount - a.aggregated_amount);
    
    const total = sorted.reduce((sum, d) => sum + d.aggregated_amount, 0);
    const maxAmount = sorted[0]?.aggregated_amount || 1;
    
    const statesHtml = sorted.slice(0, 20).map(d => {
      const stateCode = d.shape_code || d.display_name;
      const stateName = US_STATES[stateCode] || d.display_name || stateCode;
      
      return `
        <div class="geo-state-item">
          <span class="geo-state-name truncate">${stateName}</span>
          <span class="geo-state-amount mono accent">${Utils.money(d.aggregated_amount)}</span>
        </div>
      `;
    }).join('');
    
    container.innerHTML = `
      <div class="geo-map-header">
        <div class="geo-map-title mono text-sm muted upper"><i class="fas fa-map-marker-alt"></i> Top Performance Locations</div>
        <div class="geo-map-total mono accent">${Utils.money(total)} across ${sorted.length} states</div>
      </div>
      <div class="geo-states-grid">${statesHtml}</div>
    `;
  }
};
const ForecastEngine = {
  analyze(spendingData, awardsData, agencyData) {
    const organized = this.organizeByQuarter(spendingData);
    const filtered = this.filterOutliers(organized);
    // Removed unused profile/forecast calculations
    const recompetes = this.detectRecompetes(awardsData);
    const market = this.analyzeMarketConcentration(agencyData);
    const volatility = this.calculateVolatilityMetrics(filtered);
    
    return { 
      recompetes, 
      marketStatus: market.level, 
      hhi: market.hhi, 
      byFY: organized.byFY, 
      volatility
    };
  },

  organizeByQuarter(spendingData) {
    const organized = { byFY: {}, byQuarter: {}, totalByFY: {}, allAmounts: [] };
    spendingData.forEach(d => {
      const q = parseInt(d.time_period?.quarter); 
      const fy = parseInt(d.time_period?.fiscal_year); 
      const amt = d.aggregated_amount || 0;
      if(q && fy) {
        if(!organized.byFY[fy]) organized.byFY[fy] = {1:0, 2:0, 3:0, 4:0};
        organized.byFY[fy][q] = amt; 
        if(!organized.byQuarter[q]) organized.byQuarter[q] = [];
        organized.byQuarter[q].push({fy, amt}); 
        organized.totalByFY[fy] = (organized.totalByFY[fy] || 0) + amt;
        organized.allAmounts.push({fy, q, amt});
      }
    });
    return organized;
  },

  filterOutliers(organized) {
    const filtered = { byFY: {}, byQuarter: {}, totalByFY: {}, allAmounts: [] };
    Object.keys(organized.byFY).forEach(fy => filtered.byFY[fy] = {});
    for(let q=1; q<=4; q++) {
      const qData = organized.byQuarter[q] || []; 
      const amounts = qData.map(d => d.amt);
      if(amounts.length < 3) {
        qData.forEach(d => { 
           filtered.byQuarter[q] = filtered.byQuarter[q] || []; 
           filtered.byQuarter[q].push(d); 
           filtered.byFY[d.fy][q] = d.amt; 
           filtered.totalByFY[d.fy] = (filtered.totalByFY[d.fy]||0) + d.amt; 
        });
        continue;
      }
      const mean = amounts.reduce((a,b)=>a+b,0) / amounts.length;
      const variance = amounts.reduce((s,v)=>s+Math.pow(v-mean,2),0) / amounts.length;
      const stdDev = Math.sqrt(variance);
      const limit = mean + (2 * stdDev);
      qData.forEach(item => {
        if(item.amt <= limit) {
           filtered.byQuarter[q] = filtered.byQuarter[q] || []; 
           filtered.byQuarter[q].push(item); 
           filtered.byFY[item.fy][q] = item.amt; 
           filtered.totalByFY[item.fy] = (filtered.totalByFY[item.fy]||0) + item.amt;
        }
      });
    }
    return filtered;
  },

  calculateVolatilityMetrics(filtered) {
    const curFY = Utils.getCurrentFY();
    const years = Object.keys(filtered.totalByFY).map(Number).filter(y => y < curFY).sort();
    
    if (years.length < 2) {
      return { stdDev: 0, coeffVar: 0, score: 0.5 };
    }
    
    const amounts = years.map(y => filtered.totalByFY[y]);
    const mean = amounts.reduce((a, b) => a + b, 0) / amounts.length;
    const variance = amounts.reduce((s, v) => s + Math.pow(v - mean, 2), 0) / (amounts.length - 1);
    const stdDev = Math.sqrt(variance);
    const coeffVar = mean > 0 ? (stdDev / mean) : 0;
    
    return {
      stdDev,
      coeffVar,
      score: Math.min(coeffVar * 2.5, 1)
    };
  },

  analyzeMarketConcentration(agencyData) {
    const total = agencyData.reduce((s,a)=>s+a.amount,0); 
    let hhi = 0;
    let cr4 = 0;
    
    // Guard against division by zero
    if (total > 0) {
      agencyData.forEach(a => { 
        const share = (a.amount / total) * 100; 
        hhi += share * share; 
      });
      
      const sorted = [...agencyData].sort((a, b) => b.amount - a.amount);
      cr4 = sorted.slice(0, 4).reduce((s, a) => s + (a.amount / total) * 100, 0);
    }
    
    let level = "Competitive";
    let buyerPower = "Low";
    
    if(hhi > 2500) { level = "Concentrated"; buyerPower = "High"; }
    else if(hhi > 1500) { level = "Moderate"; buyerPower = "Medium"; }
    
    return { 
      hhi: Math.round(hhi), 
      level, 
      cr4: Math.round(cr4),
      buyerPower,
      agencyCount: agencyData.length 
    };
  },

  detectRecompetes(awards) {
    const now = new Date(); 
    const twoYears = new Date(); twoYears.setFullYear(now.getFullYear()+2);
    
    return awards
      .filter(a => { 
        const end = new Date(a['End Date']); 
        return end > now && end < twoYears && a['Award Amount'] > 50000; 
      })
      .sort((a, b) => new Date(a['End Date']) - new Date(b['End Date']))
      .slice(0, 15);
  }
};

// ==================== KNOWN VENDORS DATABASE ====================
const KnownVendors = {
  // Known VARs/Resellers
  vars: new Set([
    'CARAHSOFT TECHNOLOGY CORP', 'CARAHSOFT TECHNOLOGY CORPORATION',
    'CDW GOVERNMENT LLC', 'CDW-G',
    'SHI INTERNATIONAL CORP', 'SHI GOVERNMENT SOLUTIONS',
    'INSIGHT PUBLIC SECTOR INC', 'INSIGHT DIRECT USA INC',
    'GOVPLACE, LLC', 'GOVPLACE LLC',
    'IMMIX GROUP INC', 'IMMIXGROUP INC',
    'DLT SOLUTIONS LLC', 'DLT SOLUTIONS',
    'THUNDERCAT TECHNOLOGY, LLC', 'THUNDERCAT TECHNOLOGY LLC',
    'WORLD WIDE TECHNOLOGY LLC', 'WWT GOVERNMENT SERVICES',
    'PRESIDIO NETWORKED SOLUTIONS', 'PRESIDIO GOVERNMENT SOLUTIONS',
    'CONNECTION', 'PC CONNECTION', 'PCMG INC',
    'EN POINTE TECHNOLOGIES',
    'STERLING COMPUTERS CORPORATION', 'STERLING COMPUTERS',
    'MERLIN INTERNATIONAL', 'RED RIVER TECHNOLOGY',
    'MYTHICS INC', 'MYTHICS LLC',
    'FOUR POINTS TECHNOLOGY', 'FOUR POINTS TECHNOLOGY LLC',
    'SILOTECH GROUP INC', 'DECISIVE COMMUNICATIONS INC',
    'FCN INC', 'FCN, INC.',
    'SOFTCHOICE CORPORATION', 'SOFTCHOICE',
    'TRACE3', 'OPTIV SECURITY INC', 'OPTIV SECURITY',
    'FEDSTORE CORPORATION', 'FEDSTORE',
    'GOVSMART INC', 'GOVSMART, INC.',
    'NEW TECH SOLUTIONS', 'NEW TECH SOLUTIONS, INC.',
    'PANAMERICA COMPUTERS', 'PANAMERICA COMPUTERS, INC.',
    'SOFTWARE INFORMATION RESOURCE CORP',
    'ACCESSAGILITY LLC', 'BLUE TECH INC', 'BLUE TECH INC.',
    'DH TECHNOLOGIES', 'DH TECHNOLOGIES, INC.',
    'IT1 SOURCE LLC',
    'ENTERPRISE TECHNOLOGY SOLUTIONS', 'ENTERPRISE TECHNOLOGY SOLUTIONS, INC.',
    'DISTRIBUTED TECHNOLOGY GROUP LLC', 'ARCHITECHTURE SOLUTIONS LLC',
    'ADVANCED COMPUTER CONCEPTS', 'ADVANCED COMPUTER CONCEPTS, INC.',
    '4 STAR TECHNOLOGIES', '4 STAR TECHNOLOGIES, INC.',
    'THREE WIRE SYSTEMS', 'THREE WIRE SYSTEMS, LLC',
    'C & C INTERNATIONAL COMPUTERS'
  ]),

  // Known Large Primes/System Integrators
  primes: new Set([
    'BOOZ ALLEN HAMILTON', 'BOOZ ALLEN HAMILTON INC',
    'GENERAL DYNAMICS INFORMATION TECHNOLOGY', 'GENERAL DYNAMICS IT', 'GDIT',
    'LEIDOS INC', 'LEIDOS HOLDINGS', 'LEIDOS',
    'SAIC', 'SCIENCE APPLICATIONS INTERNATIONAL',
    'NORTHROP GRUMMAN', 'RAYTHEON',
    'LOCKHEED MARTIN', 'LOCKHEED MARTIN CORPORATION',
    'BAE SYSTEMS', 'L3HARRIS TECHNOLOGIES',
    'CACI INTERNATIONAL', 'CACI INC',
    'MANTECH INTERNATIONAL', 'MANTECH',
    'PERATON INC', 'PERATON',
    'ACCENTURE FEDERAL SERVICES', 'ACCENTURE',
    'DELOITTE CONSULTING', 'DELOITTE',
    'IBM CORPORATION', 'IBM', 'KPMG',
    'CGI FEDERAL', 'CGI TECHNOLOGIES',
    'MAXIMUS INC', 'MAXIMUS FEDERAL',
    'ICF INTERNATIONAL', 'ICF INC',
    'SERCO INC', 'SERCO',
    'PAE INCORPORATED', 'AMENTUM',
    'JACOBS TECHNOLOGY', 'KBR INC'
  ]),

  // Classify a vendor name
  classify(vendorName) {
    const upper = vendorName.toUpperCase().trim();
    
    // Check exact matches first
    if (this.vars.has(upper)) return 'var';
    if (this.primes.has(upper)) return 'prime';
    
    // Check partial matches
    for (const known of this.vars) {
      if (upper.includes(known) || known.includes(upper)) return 'var';
    }
    for (const known of this.primes) {
      if (upper.includes(known) || known.includes(upper)) return 'prime';
    }
    
    // Pattern-based detection for likely VARs
    const varPatterns = [
      /\b(TECHNOLOGY|TECHNOLOGIES)\s*(CORP|LLC|INC)/i,
      /\b(COMPUTERS?|COMPUTING)\s*(CORP|LLC|INC)/i,
      /\bSOLUTIONS?\s*(CORP|LLC|INC)/i,
      /\bGOV(PLACE|SMART|STORE)/i,
      /\bFEDERAL\s*(SOLUTIONS|TECHNOLOGY)/i
    ];
    
    for (const pattern of varPatterns) {
      if (pattern.test(upper)) return 'likely_var';
    }
    
    return 'unknown';
  }
};

// ==================== JOB SEEKER UTILITIES ====================
const JobLinks = {
  // Known parent company names - if vendor starts with these, just use the parent name
  knownBrands: [
    'KBR', 'SAIC', 'CACI', 'LEIDOS', 'SERCO', 'AECOM', 'JACOBS', 'PARSONS', 
    'MAXIMUS', 'ICF', 'CGI', 'IBM', 'DELL', 'HP', 'CISCO', 'ORACLE', 'GOOGLE',
    'AMAZON WEB', 'MICROSOFT', 'ACCENTURE FEDERAL', 'DELOITTE', 'KPMG', 'PWC', 'EY',
    'PERATON', 'AMENTUM', 'MANTECH', 'BAE SYSTEMS', 'RAYTHEON', 'BOEING', 'AIRBUS',
    'HONEYWELL', 'HARRIS', 'TEXTRON', 'VERIZON', 'ATT', 'AT&T', 'SPRINT',
    'PALANTIR', 'ANDURIL', 'CROWDSTRIKE', 'SPLUNK', 'VMWARE', 'SALESFORCE',
    'SERVICENOW', 'SNOWFLAKE', 'DATABRICKS', 'ELASTIC', 'GITLAB', 'ATLASSIAN'
  ],
  
  // Multi-word brand names that need OR with abbreviation
  brandAliases: {
    'BOOZ ALLEN': 'BAH',
    'GENERAL DYNAMICS': 'GDIT',
    'NORTHROP GRUMMAN': 'NGC',
    'LOCKHEED MARTIN': 'LMCO',
    'L3HARRIS': 'L3 HARRIS',
    'L3 HARRIS': 'L3HARRIS',
    'WORLD WIDE TECHNOLOGY': 'WWT',
    'RED HAT': 'REDHAT',
    'PALO ALTO': 'PANW'
  },

  // Shared logic for cleaning vendor names
  cleanVendorName(vendorName) {
    let cleanName = vendorName
      .replace(/,?\s*(LLC|INC|CORP|CORPORATION|INCORPORATED|L\.L\.C\.|L\.P\.|LP|LTD|LIMITED|CO\.)\.?\s*$/gi, '')
      .replace(/\s+/g, ' ')
      .trim();
    
    const upperName = cleanName.toUpperCase();
    
    // Check if it starts with a known single-word brand
    for (const brand of this.knownBrands) {
      if (upperName === brand || upperName.startsWith(brand + ' ')) {
        return brand;
      }
    }
    
    // Check for known multi-word brand aliases
    for (const [brand, alias] of Object.entries(this.brandAliases)) {
      if (upperName.startsWith(brand)) {
        return brand;
      }
    }
    
    return cleanName;
  },

  // Generate LinkedIn job search URL
  getLinkedInUrl(vendorName) {
    const cleanName = this.cleanVendorName(vendorName);
    return `https://www.linkedin.com/jobs/search/?keywords=${encodeURIComponent(cleanName)}&f_C=`;
  },
  
  // Generate LinkedIn people search URL - finds contacts at a company
  getLinkedInPeopleUrl(vendorName, roleKeywords = '') {
    const cleanName = this.cleanVendorName(vendorName);
    let searchQuery = roleKeywords ? `"${cleanName}" ${roleKeywords}` : cleanName;
    return `https://www.linkedin.com/search/results/people/?keywords=${encodeURIComponent(searchQuery)}&origin=GLOBAL_SEARCH_HEADER`;
  },
  // Generate LinkedIn content/news search URL
getLinkedInNewsUrl(searchTerm) {
  const cleanName = typeof searchTerm === 'string' ? this.cleanVendorName(searchTerm) : searchTerm;
  return `https://www.linkedin.com/search/results/content/?keywords=${encodeURIComponent(cleanName)}`;
}
};
const SkillsExtractor = {
  // Skills patterns to detect in award descriptions
  patterns: {
    'Cloud': /\b(cloud|aws|amazon web services|azure|gcp|google cloud|fedramp|iaas|paas|saas)\b/i,
    'Cybersecurity': /\b(cyber|security|soc|siem|zero trust|endpoint|threat|vulnerability|pentest|fisma|rmf)\b/i,
    'AI/ML': /\b(artificial intelligence|machine learning|ai\/ml|nlp|natural language|computer vision|deep learning|neural)\b/i,
    'DevOps': /\b(devops|devsecops|ci\/cd|jenkins|kubernetes|k8s|docker|container|ansible|terraform)\b/i,
    'Data Analytics': /\b(data engineer|analytics|business intelligence|tableau|power bi|visualization|big data|etl|data lake)\b/i,
    'Software Dev': /\b(software develop|full stack|frontend|backend|java|python|javascript|\.net|agile|scrum)\b/i,
    'IT Support': /\b(help desk|service desk|it support|technical support|tier [123]|desktop|end user)\b/i,
    'Network': /\b(network engineer|cisco|routing|switching|firewall|vpn|wan|lan|sd-wan)\b/i,
    'Project Mgmt': /\b(project manag|program manag|pmp|scrum master|agile coach)\b/i,
    'Systems Admin': /\b(system admin|sysadmin|windows server|linux|vmware|active directory)\b/i
  },
  
  // Extract skills from an array of awards
  extract(awards) {
    const skillCounts = {};
    const skillExamples = {};
    
    awards.forEach(award => {
      const text = `${award['Description'] || ''} ${award['PSC Description'] || ''} ${award['NAICS Description'] || ''}`;
      
      for (const [skill, pattern] of Object.entries(this.patterns)) {
        if (pattern.test(text)) {
          skillCounts[skill] = (skillCounts[skill] || 0) + 1;
          if (!skillExamples[skill]) {
            skillExamples[skill] = award['Description']?.substring(0, 100) || '';
          }
        }
      }
    });
    
    // Sort by frequency and return top skills
    return Object.entries(skillCounts)
      .map(([skill, count]) => ({ 
        skill, 
        count, 
        percentage: Math.round((count / awards.length) * 100),
        example: skillExamples[skill]
      }))
      .sort((a, b) => b.count - a.count)
      .slice(0, 6);
  }
};

// ==================== ENHANCED SALES PLAN MANAGER ====================
const SalesPlanManager = {
  channels: new Set(),
  currentVendors: [],
  detectedIntent: null,
  
  init() {
  try {
    const saved = localStorage.getItem('govhoo_channels');
    if (saved) this.channels = new Set(JSON.parse(saved));
  } catch (e) {
    console.warn('localStorage unavailable, using session-only storage');
  }
},

  isChannel(vendorName) { 
    return this.channels.has(vendorName); 
  },

  // ==================== INTENT DETECTION ====================
  detectIntent(awards) {
    const query = App.currentQuery || '';
    const vendorSpend = {};
    let totalSpend = 0;
    
    awards.forEach(r => {
      const v = r['Recipient Name'] || 'Unknown';
      const a = parseFloat(r['Award Amount']) || 0;
      vendorSpend[v] = (vendorSpend[v] || 0) + a;
      totalSpend += a;
    });
    
    const vendors = Object.entries(vendorSpend)
      .map(([name, spend]) => ({ name, spend, share: spend / totalSpend }))
      .sort((a, b) => b.spend - a.spend);
    
    // Calculate channel metrics
    let channelSpend = 0;
    let channelCount = 0;
    vendors.forEach(v => {
      if (this.isChannel(v.name)) {
        channelSpend += v.spend;
        channelCount++;
      }
    });
    const channelShare = totalSpend > 0 ? channelSpend / totalSpend : 0;
    
    // Detect Product/OEM (high channel share)
    if (channelShare > 0.7 && channelCount >= 3) {
      return {
        type: 'product_oem',
        icon: 'fa-box',
        title: 'PRODUCT / OEM CHANNEL',
        description: `${(channelShare * 100).toFixed(1)}% of revenue flows through ${channelCount} channel partners`,
        focusAreas: [
          'Channel performance & rankings',
          'Partner enablement priorities', 
          'Recompete defense by partner',
          'Agency coverage gaps'
        ],
        suggestedGoal: 'Partnership'
      };
    }
    
    // Detect own company search
    const topVendor = vendors[0];
    if (topVendor && query.toLowerCase().includes(topVendor.name.toLowerCase().split(' ')[0])) {
      return {
        type: 'own_company',
        icon: 'fa-building',
        title: 'YOUR COMPANY ANALYSIS',
        description: `Analyzing your market position: ${Utils.money(topVendor.spend)} (${(topVendor.share * 100).toFixed(1)}% share)`,
        focusAreas: [
          'Defend existing contracts',
          'Identify growth opportunities',
          'Competitive threats to your position',
          'Recompete calendar & defense'
        ],
        suggestedGoal: 'Retention'
      };
    }
    
    // Detect agency search
    const agencyKeywords = ['department', 'agency', 'administration', 'commission', 'bureau'];
    if (agencyKeywords.some(kw => query.toLowerCase().includes(kw))) {
      return {
        type: 'agency',
        icon: 'fa-landmark',
        title: 'AGENCY PENETRATION',
        description: `Analyzing how to enter or expand within this customer`,
        focusAreas: [
          'Agency mission & budget priorities',
          'Current vendor landscape',
          'Entry points & opportunities',
          'Key contracting vehicles'
        ],
        suggestedGoal: 'Growth'
      };
    }
    
    // Default: Market/keyword search
    return {
      type: 'market_keyword',
      icon: 'fa-chart-line',
      title: 'MARKET ANALYSIS',
      description: `Analyzing the "${query}" market landscape`,
      focusAreas: [
        'Market size & growth trends',
        'Competitive landscape',
        'Top agencies & opportunities',
        'Entry strategy recommendations'
      ],
      suggestedGoal: 'Growth'
    };
  },

  // ==================== UI ACTIONS ====================
  open() {
    const awards = App.forecastData.awards || App.searchData.raw || [];
    if (!awards.length) {
      alert("No award data loaded. Please run a search or forecast first.");
      return;
    }

    // Detect intent
    this.detectedIntent = this.detectIntent(awards);
    
    // Populate Agency Dropdown
    const agencyCounts = {};
    awards.forEach(r => {
      const ag = r['Awarding Agency'];
      if(ag) agencyCounts[ag] = (agencyCounts[ag] || 0) + 1;
    });
    
    const sortedAgencies = Object.entries(agencyCounts)
      .sort((a,b) => b[1] - a[1])
      .map(([name, count]) => `<option value="${name}">${name} (${count} awards)</option>`)
      .join('');
      
    document.getElementById('spSpecificAgencies').innerHTML = sortedAgencies;
    document.getElementById('spScope').value = 'all';
    
    // Set suggested goal based on intent
    document.getElementById('spFocus').value = this.detectedIntent.suggestedGoal;

    // Prepare and render
    this.prepareVendorList(awards);
    this.renderIntentBanner();
    this.updateStatus(awards.length, "Entire Market");
    this.renderSmartVendorList();
    
    ModalUtils.open('salesPlanModal');
  },

  close() {
    ModalUtils.close();
    // Also close success modal if open
    const successModal = document.getElementById('copySuccessModal');
    if (successModal) successModal.classList.remove('active');
  },

  // ==================== INTENT BANNER ====================
  renderIntentBanner() {
    const banner = document.getElementById('spIntentBanner');
    if (!banner || !this.detectedIntent) return;
    
    const intent = this.detectedIntent;
    banner.innerHTML = `
      <div class="intent-banner-content">
        <div class="intent-banner-icon"><i class="fas ${intent.icon}"></i></div>
        <div class="intent-banner-text">
          <div class="intent-banner-title">${intent.title}</div>
          <div class="intent-banner-desc">${intent.description}</div>
          <div class="intent-banner-focus">
            ${intent.focusAreas.map(f => `<span class="focus-tag">${f}</span>`).join('')}
          </div>
        </div>
      </div>
    `;
    banner.style.display = 'block';
  },

  // ==================== DATA PROCESSING ====================
  getFilteredData() {
    const scope = document.getElementById('spScope').value;
    const focus = document.getElementById('spFocus').value;
    const rawAwards = App.forecastData.awards || App.searchData.raw || [];
    
    let filteredAwards = [];
    let scopeName = "Entire Market";

    if (scope === 'all') {
      filteredAwards = rawAwards;
    } else if (scope === 'defense') {
      filteredAwards = rawAwards.filter(r => /defense|army|navy|air force|marine|space force/i.test(r['Awarding Agency']));
      scopeName = "Defense Sector";
    } else if (scope === 'civilian') {
      filteredAwards = rawAwards.filter(r => !/defense|army|navy|air force|marine|space force/i.test(r['Awarding Agency']));
      scopeName = "Federal Civilian Sector";
    } else {
      filteredAwards = rawAwards.filter(r => r['Awarding Agency'] === scope);
      scopeName = scope;
    }

    if (filteredAwards.length === 0) throw new Error("No awards found for the selected scope.");

    return { filteredAwards, scopeName, focus };
  },

  // ==================== OUTPUT ACTIONS ====================
  generate() {
    App.showLoader('GENERATING PLAN...', 'Filtering data & packaging prompt...');
    setTimeout(() => {
      try {
        const { filteredAwards, scopeName, focus } = this.getFilteredData();
        // SAFE PASSING OF ANALYSIS
        const analysisData = App.forecastData && App.forecastData.analysis ? App.forecastData.analysis : null;
        
        const pkg = PromptPackageGenerator.buildPackage(filteredAwards, analysisData, { scope: scopeName, focus });
        PromptPackageGenerator.downloadPackage(pkg);
        this.close();
      } catch(e) { 
        console.error(e); 
        alert(e.message || "Error generating plan");
      } finally { 
        App.hideLoader(); 
      }
    }, 500);
  },

  async copyPrompt() {
    const btn = document.getElementById('btnCopyPrompt');
    if (!btn) return;

    const originalHTML = btn.innerHTML;
    
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
    btn.style.opacity = '0.7';
    btn.style.pointerEvents = 'none';
    
    try {
      const { filteredAwards, scopeName, focus } = this.getFilteredData();
      // SAFE PASSING OF ANALYSIS
      const analysisData = App.forecastData && App.forecastData.analysis ? App.forecastData.analysis : null;
      
      const pkg = PromptPackageGenerator.buildPackage(filteredAwards, analysisData, { scope: scopeName, focus });
      
      await navigator.clipboard.writeText(pkg);
      this.showCopySuccessModal(pkg.length);
      
      btn.innerHTML = originalHTML;
      btn.style.opacity = '1';
      btn.style.pointerEvents = 'auto';
      
    } catch(e) {
      console.error(e);
      alert(e.message || "Error copying prompt");
      btn.innerHTML = originalHTML;
      btn.style.opacity = '1';
      btn.style.pointerEvents = 'auto';
    }
  },

  // ==================== SUCCESS MODAL ====================
  showCopySuccessModal(charCount) {
    let modal = document.getElementById('copySuccessModal');
    
    if (!modal) {
      // Create modal if it doesn't exist
      modal = document.createElement('div');
      modal.id = 'copySuccessModal';
      modal.className = 'channel-marking-modal';
      document.body.appendChild(modal);
    }
    
    const estimatedTokens = Math.round(charCount / 4);
    
    modal.innerHTML = `
      <div class="channel-modal-content" style="max-width: 420px; height: auto;">
        <div class="channel-modal-header" style="border-bottom-color: var(--accent);">
          <div class="channel-modal-title" style="color: var(--accent);">
            <i class="fas fa-check-circle"></i> Copied to Clipboard
          </div>
          <button class="channel-modal-close" onclick="SalesPlanManager.closeSuccessModal()">
            <i class="fas fa-times"></i>
          </button>
        </div>
        
        <div class="channel-modal-body" style="padding: 1.5rem;">
          <div style="margin-bottom: 1.25rem;">
            <div style="font-size: 0.95rem; color: #fff; font-weight: 500; margin-bottom: 0.25rem;">Your prompt is ready</div>
            <div style="font-size: 0.8rem; color: var(--text-muted);">
              ${charCount.toLocaleString()} chars Â· ~${estimatedTokens.toLocaleString()} tokens
            </div>
          </div>
          
          <div style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.5rem;">
            Open in
          </div>
          <div style="display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 1.25rem;">
            <a href="https://claude.ai/new" target="_blank" rel="noopener" class="ai-link-btn claude">
              Claude
            </a>
            <a href="https://chat.openai.com" target="_blank" rel="noopener" class="ai-link-btn chatgpt">
              ChatGPT
            </a>
            <a href="https://gemini.google.com" target="_blank" rel="noopener" class="ai-link-btn gemini">
              Gemini
            </a>
          </div>
          <div style="font-size: 0.75rem; color: var(--text-muted); line-height: 1.5;">
            Paste with <kbd>Ctrl+V</kbd> (or <kbd>âŒ˜V</kbd>) to generate your sales plan.
          </div>
        </div>
        
        <div class="channel-modal-footer" style="justify-content: flex-end;">
          <button class="modal-btn modal-btn-cancel" onclick="SalesPlanManager.closeSuccessModal()">
            Done
          </button>
        </div>
      </div>
    `;
    
    ModalUtils.open('copySuccessModal');
  },

  closeSuccessModal() {
    ModalUtils.close();
    // Also ensure main modal is closed
    document.getElementById('salesPlanModal').classList.remove('active');
    document.body.style.overflow = '';
  },

  // ==================== VENDOR LIST HELPERS ====================
  prepareVendorList(dataSlice) {
    const vendorSpend = {}; 
    let total = 0;
    
    dataSlice.forEach(r => { 
      const v = r['Recipient Name'] || 'Unknown'; 
      const a = parseFloat(r['Award Amount']) || 0; 
      vendorSpend[v] = (vendorSpend[v] || 0) + a; 
      total += a; 
    });
    
    this.currentVendors = Object.entries(vendorSpend)
      .map(([v, s]) => ({ 
        vendor: v, 
        spend: s, 
        marketShare: total > 0 ? ((s / total) * 100).toFixed(2) : "0.00", 
        contractCount: dataSlice.filter(r => r['Recipient Name'] === v).length,
        classification: KnownVendors.classify(v)
      }))
      .sort((a, b) => b.spend - a.spend)
      .slice(0, 30); // Increased to 30 for better coverage
  },

  updateStatus(count, scopeName) {
    const statusEl = document.getElementById('spDataStatus');
    if(!statusEl) return;
    
    const channelCount = this.currentVendors.filter(v => this.isChannel(v.vendor)).length;
    const totalVendors = this.currentVendors.length;
    
    statusEl.innerHTML = `
      <span style="color:var(--success);"><i class="fas fa-check-circle"></i></span>
      Ready Â· ${count} awards Â· ${channelCount}/${totalVendors} channels
    `;
  },

  // ==================== TOGGLE LOGIC ====================
  toggleChannel(vendorName) {
    if (this.channels.has(vendorName)) this.channels.delete(vendorName);
    else this.channels.add(vendorName);
    this.save();
    this.updateStatus(App.forecastData.awards?.length || App.searchData.raw?.length || 0, 
      document.getElementById('spScope')?.value === 'all' ? 'Entire Market' : document.getElementById('spScope')?.value);
  },

  toggleAll() {
    const allMarked = this.currentVendors.every(v => this.isChannel(v.vendor));
    if (allMarked) this.currentVendors.forEach(v => this.channels.delete(v.vendor));
    else this.currentVendors.forEach(v => this.channels.add(v.vendor));
    
    this.save();
    this.renderSmartVendorList();
    this.updateStatus(App.forecastData.awards?.length || App.searchData.raw?.length || 0, 
      document.getElementById('spScope')?.value === 'all' ? 'Entire Market' : document.getElementById('spScope')?.value);
  },

  acceptSuggested() {
    // Mark all suggested VARs as channels
    this.currentVendors.forEach(v => {
      if (v.classification === 'var' || v.classification === 'likely_var') {
        this.channels.add(v.vendor);
      }
    });
    this.save();
    this.renderSmartVendorList();
    this.updateStatus(App.forecastData.awards?.length || App.searchData.raw?.length || 0, 
      document.getElementById('spScope')?.value === 'all' ? 'Entire Market' : document.getElementById('spScope')?.value);
  },

  save() { 
  try {
    localStorage.setItem('govhoo_channels', JSON.stringify([...this.channels])); 
  } catch (e) {
  }
},

  // ==================== SMART VENDOR LIST RENDERING ====================
  renderSmartVendorList() {
    const list = document.getElementById('spVendorList');
    const container = document.getElementById('spBulkActionContainer');
    if(!list || !container) return;

    // Group vendors by classification
    const suggestedVars = this.currentVendors.filter(v => 
      (v.classification === 'var' || v.classification === 'likely_var') && !this.isChannel(v.vendor)
    );
    const primes = this.currentVendors.filter(v => v.classification === 'prime');
    const unknown = this.currentVendors.filter(v => 
      v.classification === 'unknown' && !this.isChannel(v.vendor)
    );
    const alreadyMarked = this.currentVendors.filter(v => this.isChannel(v.vendor));

    const allMarked = this.currentVendors.length > 0 && this.currentVendors.every(v => this.isChannel(v.vendor));
    
    // Bulk action buttons
    container.innerHTML = `
      <div style="display: flex; gap: 0.5rem;">
        ${suggestedVars.length > 0 ? `
          <button onclick="SalesPlanManager.acceptSuggested()" style="background: rgba(76, 175, 80, 0.1); border: 1px solid var(--success); color: var(--success); padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.7rem; font-family: 'JetBrains Mono'; display: flex; align-items: center; gap: 6px;">
            <i class="fas fa-magic"></i> ACCEPT SUGGESTIONS (${suggestedVars.length})
          </button>
        ` : ''}
        <button onclick="SalesPlanManager.toggleAll()" style="background: transparent; border: 1px solid var(--border); color: var(--accent); padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.7rem; font-family: 'JetBrains Mono'; display: flex; align-items: center; gap: 6px;">
          <i class="far ${allMarked ? 'fa-square' : 'fa-check-square'}"></i> ${allMarked ? 'UNMARK ALL' : 'MARK ALL'}
        </button>
      </div>
    `;

    if (this.currentVendors.length === 0) {
      list.innerHTML = `<div style="text-align:center; padding:1rem; color:#666;">No vendors found in this scope.</div>`;
      return;
    }

    let html = '';

    // Already Marked Section
    if (alreadyMarked.length > 0) {
      html += this.renderVendorSection(
        'âœ… MARKED AS CHANNELS',
        'These vendors are already marked as your channel partners',
        alreadyMarked,
        'success'
      );
    }

    // Suggested VARs Section  
    if (suggestedVars.length > 0) {
      html += this.renderVendorSection(
        'ðŸŽ¯ SUGGESTED CHANNELS',
        'We detected these as likely resellers/VARs based on known patterns',
        suggestedVars,
        'accent'
      );
    }

    // Unknown/Review Section
    if (unknown.length > 0) {
      html += this.renderVendorSection(
        'â“ NEEDS REVIEW', 
        'We couldn\'t automatically classify these vendors',
        unknown,
        'muted'
      );
    }

    // Primes Section (usually not marked as channels)
    if (primes.length > 0) {
      html += this.renderVendorSection(
        'ðŸ¢ LIKELY PRIMES/SIs',
        'These appear to be system integrators or large primes',
        primes,
        'muted'
      );
    }

    list.innerHTML = html;
  },

  renderVendorSection(title, description, vendors, colorClass) {
    const colorMap = {
      'success': 'var(--success)',
      'accent': 'var(--accent)',
      'muted': '#666'
    };
    const borderColor = colorMap[colorClass] || '#666';
    
    return `
      <div style="margin-bottom: 1.5rem;">
        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
          <span style="font-size: 0.8rem; font-weight: 700; color: ${borderColor}; text-transform: uppercase; letter-spacing: 0.5px;">
            ${title}
          </span>
          <span style="font-size: 0.7rem; color: #666;">(${vendors.length})</span>
        </div>
        <div style="font-size: 0.75rem; color: #888; margin-bottom: 0.75rem;">${description}</div>
        <div style="border: 1px solid var(--border); border-radius: 6px; overflow: hidden; border-left: 3px solid ${borderColor};">
          ${vendors.map(v => this.renderVendorRow(v)).join('')}
        </div>
      </div>
    `;
  },

  renderVendorRow(v) {
    const isMarked = this.isChannel(v.vendor);
    return `
      <div class="vendor-list-item" style="border-bottom: 1px solid var(--border); padding: 0.6rem 0.75rem;">
        <div class="vendor-info" style="flex: 1;">
          <div class="vendor-name" style="font-size: 0.85rem; font-weight: 600; color: #fff;">${v.vendor}</div>
          <div class="vendor-stats" style="font-size: 0.7rem; color: #888;">
            ${v.contractCount} contracts â€¢ ${Utils.money(v.spend)} â€¢ ${v.marketShare}% share
          </div>
        </div>
        <div class="vendor-toggle" style="display: flex; align-items: center; gap: 0.5rem;">
          <div class="toggle-switch ${isMarked ? 'active' : ''}" onclick="SalesPlanManager.toggleItem('${v.vendor.replace(/'/g, "\\'")}', this)">
            <div class="toggle-slider"></div>
          </div>
          <div class="toggle-label" style="font-size: 0.7rem; width: 70px; color: ${isMarked ? 'var(--success)' : '#888'};">
            ${isMarked ? 'Channel' : 'Competitor'}
          </div>
        </div>
      </div>
    `;
  },

  toggleItem(vendorName, element) {
    this.toggleChannel(vendorName);
    this.renderSmartVendorList(); 
  }
};
// ==================== APP CORE ====================
const App = {
  mode: 'search', 
  currentQuery: '',
  searchData: { raw: [], active: [], filter: null, loaded: false },
  forecastData: { spending: null, agencies: null, awards: null, analysis: null, loaded: false },
  drillState: { level: 0, path: [], currentAgency: null, currentSubAgency: null },
  subawardDrillState: { level: 0, filter: null, filterType: null },
  onlyHighMissionGap: false,

  init() {
    SalesPlanManager.init();
    
    // Initialize Autocomplete
    Autocomplete.init('mainSearchInput');
    Autocomplete.init('miniSearch');
    
    // Setup Event Delegation for all data-action handlers
    this.setupEventDelegation();
    
    // Legacy event listeners for inputs
document.getElementById('mainSearchInput').addEventListener('keypress', e => { if(e.key === 'Enter') App.runSearch(); });
document.getElementById('miniSearch').addEventListener('keypress', e => { if(e.key === 'Enter') { document.getElementById('mainSearchInput').value = e.target.value; App.mode === 'forecast' ? App.runForecast(e.target.value) : App.runSearch(e.target.value); } });

// Select all text on focus for easy replacement
document.getElementById('mainSearchInput').addEventListener('focus', function() { this.select(); });
document.getElementById('miniSearch').addEventListener('focus', function() { this.select(); });

// Show/hide clear button for main search only
function setupClearButton(inputId, buttonClass) {
  const input = document.getElementById(inputId);
  const btn = document.querySelector('.' + buttonClass);
  if (!input || !btn) return;
  
  // Move button inside the autocomplete wrapper
  const wrapper = input.closest('.autocomplete-wrapper');
  if (wrapper && btn.parentNode !== wrapper) {
    wrapper.appendChild(btn);
  }
  
  const toggle = () => btn.classList.toggle('visible', input.value.length > 0);
  input.addEventListener('input', toggle);
  input.addEventListener('change', toggle);
  toggle();
}
setupClearButton('mainSearchInput', 'input-clear');

    window.addEventListener('resize', () => { 
      setTimeout(() => { 
        if(App.mode === 'search' && App.searchData?.active?.length > 0) {
          App.renderSankey(); 
          if(App.forecastData?.subawards) {
            App.renderSubawardSankey(App.forecastData.subawards);
          }
        }
      }, 200); 
    });

    // Preload visualization libraries during idle time
    LibLoader.preloadWhenIdle();

    const params = new URLSearchParams(window.location.search);
    const q = params.get('q');
    const mode = params.get('mode');

    if (q) {
      document.getElementById('mainSearchInput').value = q;
      
      if (mode === 'forecast') {
        App.runForecast(q);
      } else {
        App.runSearch(q);
      }
    }
  },
  
  // Event Delegation - handles all data-action clicks
  setupEventDelegation() {
    document.addEventListener('click', (e) => {
      const target = e.target.closest('[data-action]');
      if (!target) return;
      
      const action = target.dataset.action;
      const actions = {
        'search': () => this.runSearch(),
        'forecast': () => this.runForecast(),
        'showHero': () => this.showHero(),
        'toggleMode': () => this.setMode(this.mode === 'search' ? 'forecast' : 'search'),
        'setModeSearch': () => this.setMode('search'),
        'setModeForecast': () => this.setMode('forecast'),
        'resetDrill': () => this.resetDrill(),
        'clearFilter': () => this.resetDrill(),
        'shareLink': () => this.shareLink(target),
        'exportCSV': () => this.exportCSV(target),
        'openSalesPlan': () => SalesPlanManager.open(),
        'closeSalesPlan': () => SalesPlanManager.close(),
        'copyPrompt': () => SalesPlanManager.copyPrompt(),
        'generateDownload': () => SalesPlanManager.generate(),
        'closeSuccessModal': () => SalesPlanManager.closeSuccessModal(),
        'resetSubawardDrill': () => this.resetSubawardDrill(),
        'toggleChannel': () => {
          const vendor = target.dataset.vendor;
          if (vendor) SalesPlanManager.toggleChannel(vendor);
        },
        // Pipeline Builder actions
        'openPipelineBuilder': () => PipelineBuilder.open(),
        'closePipelineBuilder': () => PipelineBuilder.close(),
        'generatePipeline': () => PipelineBuilder.generate(),
        'downloadPipelineCSV': () => PipelineBuilder.downloadCSV()
      };
      
      if (actions[action]) {
        e.preventDefault();
        actions[action]();
      }
    });
  },

  showHero() {
    document.getElementById('appView').style.display = 'none';
    const hero = document.getElementById('heroView'); hero.style.display = 'flex'; hero.classList.remove('hidden');
    setTimeout(() => hero.classList.remove('slide-up'), 10);
  },

  setMode(mode) {
    App.mode = mode;
    document.getElementById('modeSearchBtn').classList.toggle('active', mode === 'search');
    document.getElementById('modeForecastBtn').classList.toggle('active', mode === 'forecast');
    document.getElementById('searchModeView').classList.toggle('active', mode === 'search');
    document.getElementById('forecastModeView').classList.toggle('active', mode === 'forecast');
    if(App.currentQuery) {
      if(mode === 'search' && !App.searchData.loaded) App.runSearch(App.currentQuery);
      else if(mode === 'forecast' && !App.forecastData.loaded) App.runForecast(App.currentQuery);
    }
  },

  toggleMode() { App.setMode(App.mode === 'search' ? 'forecast' : 'search'); },

  // --- Search Mode ---
  async runSearch(val) {
    let query = val || document.getElementById('mainSearchInput').value; if(!query) return;
	query = Utils.normalizeQuery(query);
  document.getElementById('mainSearchInput').value = query;
    if(query !== App.currentQuery) { App.searchData = { raw: [], active: [], filter: null, loaded: false }; App.forecastData = { loaded: false }; App.searchGeoData = null; App.resetDrill(); App.subawardDrillState = { level: 0, filter: null, filterType: null }; }
    App.currentQuery = query; App.mode = 'search'; App.showLoader('RETRIEVING DATA...', 'Searching USASpending API');
    try {
      // Ensure D3 is loaded for Sankey (preloaded during idle, so usually instant)
      await LibLoader.loadD3();
      App.searchData.raw = await API.searchAwards(query); App.searchData.active = App.searchData.raw; App.searchData.loaded = true;
      App.transitionToApp(); App.setMode('search'); App.updateSearchDashboard(); this.loadSubcontractingData(query); this.loadGeoDataForSearch(query); requestAnimationFrame(() => App.renderSankey());
    } catch(e) { console.error(e); alert("Error retrieving data."); } finally { App.hideLoader(); }
  },
  
  // Load geo data for search view job locations panel (non-blocking)
  async loadGeoDataForSearch(query) {
    try {
      const data = await API.getSpendingByGeography(query, 'state');
      App.searchGeoData = data;
      App.renderSearchLocations();
    } catch(e) {
      console.warn('Could not load geo data:', e);
    }
  },

  updateSearchDashboard() {
    const data = App.searchData.active;
    document.getElementById('stat-vol').innerText = Utils.money(data.reduce((acc, c) => acc + (c['Award Amount']||0), 0));
    document.getElementById('stat-count').innerText = data.length;
    document.getElementById('stat-vendors').innerText = new Set(data.map(c => c['Recipient Name'])).size;
    document.getElementById('stat-agencies').innerText = new Set(data.map(c => c['Awarding Agency'])).size;
    const badge = document.getElementById('filterBadge');
    if (App.searchData.filter) { badge.style.display = 'inline-flex'; document.getElementById('filterName').innerText = App.searchData.filter; } else badge.style.display = 'none';
    App.renderFeed(); App.updateDrillUI();
    
    // Update Job Seeker Panels (dynamically based on active/filtered data)
    App.renderSearchTopWinners(data);
	App.renderSearchTopBuyers(data);
    App.renderSearchSkills(data);
    App.renderSearchLocations();
  },

  // --- Drill Down Logic ---
  resetDrill() { App.drillState = { level: 0, path: [], currentAgency: null, currentSubAgency: null }; App.searchData.filter = null; App.searchData.active = App.searchData.raw; App.updateSearchDashboard(); App.renderSankey(); },
  
  updateDrillUI() {
  const bc = document.getElementById('drillBreadcrumb'); 
  const hint = document.getElementById('drillHint'); 
  const lvl = document.getElementById('drillLevelBadge');
  const levelText = document.getElementById('drillLevelText');

  if (App.drillState.level === 0) {
    bc.style.display = 'none'; 
    hint.style.display = 'flex'; 
    lvl.style.display = 'none'; 
    document.getElementById('subagencyPanel').style.display = 'none';
    hint.innerHTML = `<i class="fas fa-mouse-pointer"></i><span>Click an <strong>agency</strong> or <strong>vendor</strong> bar to drill down</span>`;
  } else {
    bc.style.display = 'flex'; 
    lvl.style.display = 'inline-flex';
    
    // Set appropriate badge text
    if (App.drillState.level === 1) levelText.innerText = 'Agency View';
    else if (App.drillState.level === 2) levelText.innerText = 'Sub-Agency View';
    else if (App.drillState.level === 3) levelText.innerText = 'Vendor Perspective';

    let html = `<div class="breadcrumb-item" data-action="resetDrill"><i class="fas fa-globe breadcrumb-icon"></i><span>All Agencies</span></div>`;
    
    App.drillState.path.forEach((p, i) => {
      const isLast = i === App.drillState.path.length - 1;
      const action = isLast ? '' : `App.drillToLevel(${i + 1})`;
      html += `
        <span class="breadcrumb-separator"><i class="fas fa-chevron-right"></i></span>
        <div class="breadcrumb-item ${isLast ? 'active' : ''}" onclick="${action}">
          <span>${Utils.trunc(p.name, 25)}</span>
        </div>`;
    });
    bc.innerHTML = html; 

    if (App.drillState.level === 1) { 
      hint.innerHTML = `<i class="fas fa-layer-group"></i><span>Click a <strong>sub-agency</strong> or <strong>vendor</strong> to refine</span>`; 
      App.renderSubAgencyPanel(); 
    } else { 
      document.getElementById('subagencyPanel').style.display = 'none'; 
      hint.innerHTML = `<i class="fas fa-check-circle" style="color:var(--success)"></i><span>Viewing filtered breakdown</span>`; 
    }
  }
},

  renderSubAgencyPanel() {
    const list = document.getElementById('subagencyList');
    const contracts = App.searchData.raw.filter(d => d['Awarding Agency'] === App.drillState.currentAgency);
    const map = {}; contracts.forEach(c => { const sa = c['Awarding Sub Agency'] || 'Unknown'; map[sa] = map[sa] || {amount:0, count:0}; map[sa].amount += c['Award Amount']||0; map[sa].count++; });
    const subs = Object.entries(map).map(([k,v]) => ({name:k, ...v})).sort((a,b) => b.amount - a.amount);
    document.getElementById('subagencyParentName').innerText = Utils.trunc(App.drillState.currentAgency, 40);
    document.getElementById('subagencyTotalAmount').innerText = Utils.money(subs.reduce((s,x)=>s+x.amount,0));
    document.getElementById('subagencyCount').innerText = subs.length;
    list.innerHTML = subs.map((s,i) => `<div class="subagency-item" onclick="App.drillToSubAgency('${s.name.replace(/'/g, "\\'")}')"><div class="subagency-item-left"><div class="subagency-rank ${i<3?'top-3':''}">${i+1}</div><div class="subagency-info"><div class="subagency-name">${s.name}</div><div class="subagency-contracts">${s.count} contracts</div></div></div><div class="subagency-item-right"><div class="subagency-bar-container"><div class="subagency-bar" style="width:${(s.amount/subs[0].amount)*100}%"></div></div><div class="subagency-amount">${Utils.money(s.amount)}</div><i class="fas fa-chevron-right subagency-drill-icon"></i></div></div>`).join('');
    document.getElementById('subagencyPanel').style.display = 'block';
  },

  drillToAgency(name) {
  App.drillState = { 
    level: 1, 
    currentAgency: name, 
    currentSubAgency: null, 
    path: [{type: 'agency', name: name}] 
  };
  // ALWAYS filter from raw to prevent "No Data" screen
  App.searchData.active = App.searchData.raw.filter(d => d['Awarding Agency'] === name);
  App.searchData.filter = name;
  App.updateSearchDashboard();
  App.renderSankey();
},

drillToSubAgency(name) {
  App.drillState.level = 2;
  App.drillState.currentSubAgency = name;
  // Re-build path from the current agency and new sub-agency
  App.drillState.path = [
    {type: 'agency', name: App.drillState.currentAgency}, 
    {type: 'sub', name: name}
  ];
  // Filter from raw
  App.searchData.active = App.searchData.raw.filter(d => 
    d['Awarding Agency'] === App.drillState.currentAgency && 
    d['Awarding Sub Agency'] === name
  );
  App.searchData.filter = name;
  App.updateSearchDashboard();
  App.renderSankey();
},
  drillToLevel(lvl) { 
  // Always restore full data before re-applying a level-specific filter
  App.searchData.active = App.searchData.raw;

  if (lvl === 0) {
    App.resetDrill();
  } else if (lvl === 1) {
    App.drillToAgency(App.drillState.path[0].name); 
  } else if (lvl === 2) {
    App.drillToSubAgency(App.drillState.path[1].name);
  }
},
  drillDown(name) {
  const data = App.searchData.raw;
  
  // 1. Identify the entity type from the master dataset
  const agencyMatch = data.find(d => d['Awarding Agency'] === name);
  const subAgencyMatch = data.find(d => d['Awarding Sub Agency'] === name);
  const vendorMatch = data.find(d => d['Recipient Name'] === name);

  // 2. Clear previous specific filters to avoid "No Data" conflicts
  App.searchData.active = data;

  if (agencyMatch && !subAgencyMatch) {
    // It's a top-tier agency: Clean drill to Level 1
    App.drillToAgency(name);
  } 
  else if (subAgencyMatch) {
    // If it's a sub-agency (or both), we must ensure the parent context is set
    // to prevent "No Description" breadcrumbs.
    const parentName = subAgencyMatch['Awarding Agency'];
    App.drillState.currentAgency = parentName; 
    App.drillToSubAgency(name);
  } 
  else if (vendorMatch) {
    // Vendor Perspective (Level 3)
    if (App.drillState.level === 3) {
      App.drillState.path.pop(); // Replace vendor if already in vendor view
    }
    
    App.drillState.level = 3; 
    App.drillState.path.push({ type: 'vendor', name: name });
    App.searchData.filter = `Vendor: ${name}`;
    
    // Filter specifically for this vendor across all agencies
    App.searchData.active = data.filter(d => d['Recipient Name'] === name);
    
    App.updateSearchDashboard();
    App.renderSankey();
  }
},
  clearFilter() { App.drillState.level > 0 ? App.resetDrill() : (App.searchData.filter = null, App.searchData.active = App.searchData.raw, App.updateSearchDashboard(), App.renderSankey()); },

  renderSankey() {
  const container = document.getElementById('chartContainer'); 
  container.innerHTML = '';
  
  const data = App.searchData.active; 
  if(!data || data.length === 0) { 
    container.innerHTML = '<div style="text-align:center; padding:4rem; color:#666">No data available for this view.</div>'; 
    return; 
  }
  
  container.innerHTML = '<svg id="sankeySvg"></svg>';
  
  // Identify the source level for the left side of the Sankey
  const isLvl0 = App.drillState.level === 0;
  const flowMap = {}; 

  data.forEach(d => { 
    if(d['Award Amount'] > 0) {
      // Fallback logic to prevent "No Description" nodes
      const source = (isLvl0 ? d['Awarding Agency'] : d['Awarding Sub Agency']) || d['Awarding Agency'] || 'Unknown Agency';
      const target = d['Recipient Name'] || 'Unknown Vendor';
      const key = source + "|||" + target;
      
      flowMap[key] = (flowMap[key] || 0) + d['Award Amount']; 
    }
  });

  const allFlows = Object.entries(flowMap).sort((a,b) => b[1] - a[1]); 
  const limit = App.drillState.level > 0 ? 50 : 25;
  const topFlows = allFlows.slice(0, limit); 
  const tailFlows = allFlows.slice(limit);
  
  const nodesSet = new Set(); 
  const links = [];
  
  topFlows.forEach(([k,v]) => { 
    const [s,t] = k.split("|||"); 
    nodesSet.add(s); 
    nodesSet.add(t); 
    links.push({source:s, target:t, value:v}); 
  });

  // Aggregate smaller flows into an "Other" category to keep the chart clean
  if(tailFlows.length > 0) { 
    const aggs = {}; 
    tailFlows.forEach(([k,v]) => { 
      const [s] = k.split("|||"); 
      if(nodesSet.has(s)) aggs[s] = (aggs[s] || 0) + v; 
    }); 
    Object.entries(aggs).forEach(([s,v]) => { 
      const n = `Other (${tailFlows.length} Vendors)`; 
      nodesSet.add(n); 
      links.push({source:s, target:n, value:v}); 
    }); 
  }
  
  const nodes = Array.from(nodesSet).map(n => ({name:n})); 
  const nodeMap = new Map(nodes.map((n,i) => [n.name, i]));
  const d3Links = links.map(l => ({source:nodeMap.get(l.source), target:nodeMap.get(l.target), value:l.value}));
  
  const w = container.offsetWidth || 800; 
  const h = Math.max(500, nodes.length * 28);
  const svg = d3.select("#sankeySvg").attr("width", w).attr("height", h);
  const sankey = d3.sankey().nodeId(d => d.index).nodeWidth(20).nodePadding(20).extent([[1,1],[w-1,h-6]]);
  const {nodes:gn, links:gl} = sankey({nodes:nodes.map(d=>Object.assign({},d)), links:d3Links.map(d=>Object.assign({},d))});
  
  // Logic to determine if a node should show the "drill-down" highlight
  const isDrillable = n => {
    if (!n || n.startsWith('Other') || n.includes('Unknown') || n === 'No Description') return false;
    
    // Check if the node is a known Agency, Sub-Agency, or Vendor
    return App.searchData.raw.some(d => 
      d['Awarding Agency'] === n || 
      d['Awarding Sub Agency'] === n || 
      d['Recipient Name'] === n
    );
  };

  // Render Nodes
  svg.append("g").selectAll("rect").data(gn).join("rect")
     .attr("x", d => d.x0).attr("y", d => d.y0).attr("height", d => d.y1 - d.y0).attr("width", d => d.x1 - d.x0)
     .attr("fill", d => Utils.getColor(d.name)).attr("opacity", 0.8)
     .attr("stroke", "none") // Explicitly remove stroke
     .style("cursor", d => isDrillable(d.name) ? "pointer" : "default")
     .on("click", (e, d) => { if(isDrillable(d.name)) App.drillDown(d.name); })
     .append("title").text(d => `${d.name}\n${Utils.money(d.value)}`);

  // Render Gradients for links
  const defs = svg.append("defs");
  gl.forEach((l,i) => { 
    const g = defs.append("linearGradient").attr("id","g"+i).attr("gradientUnits","userSpaceOnUse").attr("x1",l.source.x1).attr("x2",l.target.x0); 
    g.append("stop").attr("offset","0%").attr("stop-color",Utils.getColor(l.source.name)); 
    g.append("stop").attr("offset","100%").attr("stop-color",Utils.getColor(l.target.name)); 
  });
  
  // Render Links
  svg.append("g").attr("fill","none").selectAll("path").data(gl).join("path")
     .attr("d", d3.sankeyLinkHorizontal()).attr("stroke",(d,i) => "url(#g"+i+")").attr("stroke-width", d => Math.max(1, d.width)).attr("stroke-opacity", 0.4);
  
  // Render Labels
  svg.append("g").selectAll("text").data(gn).join("text")
     .attr("x", d => d.x0 < w/2 ? d.x1 + 6 : d.x0 - 6).attr("y", d => (d.y1 + d.y0) / 2).attr("dy", "0.35em")
     .attr("text-anchor", d => d.x0 < w/2 ? "start" : "end").text(d => Utils.trunc(d.name, 40))
     .style("font-size", "11px").style("fill", "#fff").style("pointer-events", "none");
},

  renderFeed() {
    const div = document.getElementById('feedGrid');
    const data = App.searchData.active;
    if(data.length === 0) { div.innerHTML = '<div style="text-align:center; padding:2rem; color:#666">No contracts found.</div>'; return; }
    
    div.innerHTML = data.map(c => {
      const internalId = c['generated_internal_id'];
      let url = '#';
      if (internalId) url = `https://www.usaspending.gov/award/${internalId}`;
      else if (c['Award ID']) url = `https://www.usaspending.gov/search/?hash=&filters=${encodeURIComponent(JSON.stringify({keyword: c['Award ID']}))}`;
      
      let metaTags = '';
      if (c['NAICS Code']) metaTags += `<span class="meta-tag naics" title="${Autocomplete.escapeHtml(c['NAICS Description'] || '')}">NAICS: ${Autocomplete.escapeHtml(c['NAICS Code'])}</span>`;
      if (c['PSC Code']) metaTags += `<span class="meta-tag psc" title="${Autocomplete.escapeHtml(c['PSC Description'] || '')}">PSC: ${Autocomplete.escapeHtml(c['PSC Code'])}</span>`;
      
      const subAgency = c['Awarding Sub Agency'];
      const agencyDisplay = subAgency && subAgency !== c['Awarding Agency'] 
        ? `${Utils.trunc(c['Awarding Agency'], 20)} â†’ ${Utils.trunc(subAgency, 20)}` 
        : Utils.trunc(c['Awarding Agency'], 35);
      
      const vendorNameRaw = c['Recipient Name'] || 'Unknown Vendor';
      const vendorName = Autocomplete.escapeHtml(vendorNameRaw);
      const desc = Autocomplete.escapeHtml(Utils.trunc(c['Description'], 100));
      const agencyDisplaySafe = Autocomplete.escapeHtml(agencyDisplay);
const linkedInUrl = JobLinks.getLinkedInUrl(vendorNameRaw);
const linkedInPeopleUrl = JobLinks.getLinkedInPeopleUrl(vendorNameRaw);
const linkedInNewsUrl = JobLinks.getLinkedInNewsUrl(vendorNameRaw);
return `<div class="deal-card">
    <div class="deal-header"><span class="deal-agency">${agencyDisplaySafe}</span><span class="deal-amount">${Utils.money(c['Award Amount'])}</span></div>
    <div class="deal-desc">${desc}</div>
    <div class="deal-vendor">${vendorName} <a href="${linkedInPeopleUrl}" target="_blank" class="job-link" style="margin-left:6px;" title="Find contacts at this company"><i class="fab fa-linkedin"></i> People</a> <a href="${linkedInUrl}" target="_blank" class="job-link" title="Search jobs at this company"><i class="fab fa-linkedin"></i> Jobs</a> <a href="${linkedInNewsUrl}" target="_blank" class="job-link" title="LinkedIn posts about this company"><i class="fas fa-newspaper"></i> News</a></div>
    ${metaTags ? `<div class="deal-meta">${metaTags}</div>` : ''}
    <div class="deal-footer"><span class="deal-date">Start: ${Utils.date(c['Start Date'])}${c['End Date'] ? ' â†’ ' + Utils.date(c['End Date']) : ''}</span><a href="${url}" target="_blank" class="action-btn">OPEN AWARD <i class="fas fa-external-link-alt"></i></a></div>
  </div>`;
}).join('');
},
// --- Search View: Top Buyers with LinkedIn Links ---
renderSearchTopBuyers(data) {
  const body = document.getElementById('searchTopBuyersBody');
  if (!body) return;
  
  if (!data || data.length === 0) {
    body.innerHTML = `<div class="muted text-xs" style="text-align:center;">No agency data available</div>`;
    return;
  }
  
  const agencyMap = {};
  data.forEach(a => {
    const agency = a['Awarding Agency'] || 'Unknown';
    if (!agencyMap[agency]) {
      agencyMap[agency] = { name: agency, spend: 0, count: 0 };
    }
    agencyMap[agency].spend += parseFloat(a['Award Amount']) || 0;
    agencyMap[agency].count++;
  });
  
  const sorted = Object.values(agencyMap).sort((a, b) => b.spend - a.spend);
  const topAgencies = sorted.slice(0, 5);
  body.innerHTML = `
    <div class="compact-winner-list">
      ${topAgencies.map((a, i) => {
        const linkedInPeopleUrl = JobLinks.getLinkedInPeopleUrl(a.name);
        const usaJobsUrl = `https://www.usajobs.gov/Search/Results?k=${encodeURIComponent(a.name)}`;
        const linkedInNewsUrl = JobLinks.getLinkedInNewsUrl(a.name);
        
        return `
        <div class="compact-winner-item">
          <div class="compact-winner-rank">${i + 1}</div>
          <div class="compact-winner-info">
            <div class="compact-winner-name">${Utils.trunc(a.name, 28)}</div>
            <div class="compact-winner-meta">${Utils.money(a.spend)} Â· ${a.count} awards</div>
            <div class="job-links" style="margin-top:4px;">
              <a href="${linkedInPeopleUrl}" target="_blank" class="job-link" title="Find contacts at this agency"><i class="fab fa-linkedin"></i> People</a>
              <a href="${usaJobsUrl}" target="_blank" class="job-link" title="Federal jobs at this agency"><i class="fas fa-flag-usa"></i> Jobs</a>
              <a href="${linkedInNewsUrl}" target="_blank" class="job-link" title="LinkedIn posts about this agency"><i class="fas fa-newspaper"></i> News</a>
            </div>
          </div>
        </div>`;
      }).join('')}
    </div>
    ${sorted.length > 5 ? `<div class="text-xs muted" style="text-align:center; margin-top:0.5rem;">+${sorted.length - 5} more agencies</div>` : ''}
  `;
},

// --- Search View: Top Winners with Job Links ---
renderSearchTopWinners(data) {
  const body = document.getElementById('searchTopWinnersBody');
  if (!body) return;
  
  if (!data || data.length === 0) {
    body.innerHTML = `<div class="muted text-xs" style="text-align:center;">No vendor data available</div>`;
    return;
  }
  
  // Group by vendor
  const vendorMap = {};
  data.forEach(a => {
    const vendor = a['Recipient Name'] || 'Unknown';
    if (!vendorMap[vendor]) {
      vendorMap[vendor] = { name: vendor, spend: 0, count: 0 };
    }
    vendorMap[vendor].spend += parseFloat(a['Award Amount']) || 0;
    vendorMap[vendor].count++;
  });
  
  const sorted = Object.values(vendorMap).sort((a, b) => b.spend - a.spend);
  const topVendors = sorted.slice(0, 5);
  
  body.innerHTML = `
    <div class="compact-winner-list">
      ${topVendors.map((v, i) => {
        const linkedInUrl = JobLinks.getLinkedInUrl(v.name);
        const linkedInPeopleUrl = JobLinks.getLinkedInPeopleUrl(v.name);
        const linkedInNewsUrl = JobLinks.getLinkedInNewsUrl(v.name);
        
        return `
        <div class="compact-winner-item">
          <div class="compact-winner-rank">${i + 1}</div>
          <div class="compact-winner-info">
            <div class="compact-winner-name">${Utils.trunc(v.name, 28)}</div>
            <div class="compact-winner-meta">${Utils.money(v.spend)} Â· ${v.count} awards</div>
            <div class="job-links" style="margin-top:4px;">
              <a href="${linkedInPeopleUrl}" target="_blank" class="job-link" title="Find contacts at this company"><i class="fab fa-linkedin"></i> People</a>
              <a href="${linkedInUrl}" target="_blank" class="job-link" title="Search jobs on LinkedIn"><i class="fab fa-linkedin"></i> Jobs</a>
              <a href="${linkedInNewsUrl}" target="_blank" class="job-link" title="LinkedIn posts about this company"><i class="fas fa-newspaper"></i> News</a>
            </div>
          </div>
        </div>`;
      }).join('')}
    </div>
    ${sorted.length > 5 ? `<div class="text-xs muted" style="text-align:center; margin-top:0.5rem;">+${sorted.length - 5} more vendors in results</div>` : ''}
  `;
},

  // --- Search View: Top Primes with LinkedIn Links ---
  renderSearchTopPrimes(subawards) {
    const body = document.getElementById('searchTopPrimesBody');
    if (!body) return;
    
    if (!subawards || subawards.length === 0) {
      body.innerHTML = `<div class="muted text-xs" style="text-align:center;">No subcontract data available</div>`;
      return;
    }
    
    // Apply drill filter if active
    let filteredSubawards = subawards;
    const drill = App.subawardDrillState;
    
    if (drill.level > 0 && drill.filter) {
      if (drill.filterType === 'prime') {
        filteredSubawards = subawards.filter(sub => 
          (sub['Prime Recipient Name'] || 'Unknown Prime') === drill.filter
        );
      } else if (drill.filterType === 'sub') {
        filteredSubawards = subawards.filter(sub => 
          (sub['Sub-Awardee Name'] || 'Unknown Sub') === drill.filter
        );
      } else if (drill.filterType === 'agency') {
        filteredSubawards = subawards.filter(sub => 
          (sub['Awarding Agency'] || sub['Awarding Sub Agency'] || 'Unknown Agency') === drill.filter
        );
      }
    }
    
    const primeMap = {};
    filteredSubawards.forEach(sub => {
      const prime = sub['Prime Recipient Name'] || 'Unknown';
      if (!primeMap[prime]) {
        primeMap[prime] = { name: prime, spend: 0, count: 0 };
      }
      primeMap[prime].spend += parseFloat(sub['Sub-Award Amount']) || 0;
      primeMap[prime].count++;
    });
    
    const sorted = Object.values(primeMap).sort((a, b) => b.spend - a.spend);
    const topPrimes = sorted.slice(0, 5);
    
    body.innerHTML = `
      <div class="compact-winner-list">
        ${topPrimes.map((p, i) => {
          const linkedInUrl = JobLinks.getLinkedInUrl(p.name);
          const linkedInPeopleUrl = JobLinks.getLinkedInPeopleUrl(p.name);
          const linkedInNewsUrl = JobLinks.getLinkedInNewsUrl(p.name);
          
          return `
          <div class="compact-winner-item">
            <div class="compact-winner-rank">${i + 1}</div>
            <div class="compact-winner-info">
              <div class="compact-winner-name">${Utils.trunc(p.name, 28)}</div>
              <div class="compact-winner-meta">${Utils.money(p.spend)} Â· ${p.count} subawards</div>
              <div class="job-links" style="margin-top:4px;">
                <a href="${linkedInPeopleUrl}" target="_blank" class="job-link" title="Find contacts at this company"><i class="fab fa-linkedin"></i> People</a>
                <a href="${linkedInUrl}" target="_blank" class="job-link" title="Search jobs on LinkedIn"><i class="fab fa-linkedin"></i> Jobs</a>
                <a href="${linkedInNewsUrl}" target="_blank" class="job-link" title="LinkedIn posts about this company"><i class="fas fa-newspaper"></i> News</a>
              </div>
            </div>
          </div>`;
        }).join('')}
      </div>
      ${sorted.length > 5 ? `<div class="text-xs muted" style="text-align:center; margin-top:0.5rem;">+${sorted.length - 5} more primes in results</div>` : ''}
    `;
  },

  // --- Search View: Top Subs with LinkedIn Links ---
  renderSearchTopSubs(subawards) {
    const body = document.getElementById('searchTopSubsBody');
    if (!body) return;
    
    if (!subawards || subawards.length === 0) {
      body.innerHTML = `<div class="muted text-xs" style="text-align:center;">No subcontract data available</div>`;
      return;
    }
    
    // Apply drill filter if active
    let filteredSubawards = subawards;
    const drill = App.subawardDrillState;
    
    if (drill.level > 0 && drill.filter) {
      if (drill.filterType === 'prime') {
        filteredSubawards = subawards.filter(sub => 
          (sub['Prime Recipient Name'] || 'Unknown Prime') === drill.filter
        );
      } else if (drill.filterType === 'sub') {
        filteredSubawards = subawards.filter(sub => 
          (sub['Sub-Awardee Name'] || 'Unknown Sub') === drill.filter
        );
      } else if (drill.filterType === 'agency') {
        filteredSubawards = subawards.filter(sub => 
          (sub['Awarding Agency'] || sub['Awarding Sub Agency'] || 'Unknown Agency') === drill.filter
        );
      }
    }
    
    const subMap = {};
    filteredSubawards.forEach(sub => {
      const subName = sub['Sub-Awardee Name'] || 'Unknown';
      if (!subMap[subName]) {
        subMap[subName] = { name: subName, spend: 0, count: 0 };
      }
      subMap[subName].spend += parseFloat(sub['Sub-Award Amount']) || 0;
      subMap[subName].count++;
    });
    
    const sorted = Object.values(subMap).sort((a, b) => b.spend - a.spend);
    const topSubs = sorted.slice(0, 5);
    
    body.innerHTML = `
      <div class="compact-winner-list">
        ${topSubs.map((s, i) => {
          const linkedInUrl = JobLinks.getLinkedInUrl(s.name);
          const linkedInPeopleUrl = JobLinks.getLinkedInPeopleUrl(s.name);
          const linkedInNewsUrl = JobLinks.getLinkedInNewsUrl(s.name);
          
          return `
          <div class="compact-winner-item">
            <div class="compact-winner-rank">${i + 1}</div>
            <div class="compact-winner-info">
              <div class="compact-winner-name">${Utils.trunc(s.name, 28)}</div>
              <div class="compact-winner-meta">${Utils.money(s.spend)} Â· ${s.count} subawards</div>
              <div class="job-links" style="margin-top:4px;">
                <a href="${linkedInPeopleUrl}" target="_blank" class="job-link" title="Find contacts at this company"><i class="fab fa-linkedin"></i> People</a>
                <a href="${linkedInUrl}" target="_blank" class="job-link" title="Search jobs on LinkedIn"><i class="fab fa-linkedin"></i> Jobs</a>
                <a href="${linkedInNewsUrl}" target="_blank" class="job-link" title="LinkedIn posts about this company"><i class="fas fa-newspaper"></i> News</a>
              </div>
            </div>
          </div>`;
        }).join('')}
      </div>
      ${sorted.length > 5 ? `<div class="text-xs muted" style="text-align:center; margin-top:0.5rem;">+${sorted.length - 5} more subcontractors in results</div>` : ''}
    `;
  },

  // --- Search View: Skills in Demand ---
  renderSearchSkills(data) {
    const body = document.getElementById('searchSkillsBody');
    if (!body) return;
    
    if (!data || data.length === 0) {
      body.innerHTML = `<div class="muted text-xs" style="text-align:center;">No skills data available</div>`;
      return;
    }
    
    const skills = SkillsExtractor.extract(data);
    
    if (skills.length === 0) {
      body.innerHTML = `<div class="muted text-xs" style="text-align:center;">No specific skills detected in award descriptions</div>`;
      return;
    }
    
    const maxPct = skills[0]?.percentage || 100;
    
    body.innerHTML = `
      ${skills.slice(0, 5).map(s => `
        <div class="skill-bar-container">
          <div class="skill-bar-label">
            <span class="skill-bar-name">${s.skill}</span>
            <span class="skill-bar-pct">${s.percentage}%</span>
          </div>
          <div class="skill-bar">
            <div class="skill-bar-fill" style="width: ${(s.percentage / maxPct) * 100}%"></div>
          </div>
        </div>
      `).join('')}
      <div class="text-xs" style="margin-top: 0.75rem; color: var(--text-muted); font-style: italic;">
        <i class="fas fa-lightbulb" style="color: var(--accent);"></i> 
        These skills appear most in current results
      </div>
    `;
  },

  // --- Search View: Job Locations ---
  renderSearchLocations() {
    const body = document.getElementById('searchLocationsBody');
    if (!body) return;
    
    // Use cached geo data if available
    const geoData = App.searchGeoData;
    
    if (!geoData || geoData.length === 0) {
      body.innerHTML = `<div class="muted text-xs" style="text-align:center;">Loading location data...</div>`;
      return;
    }
    
    const sorted = geoData.sort((a, b) => b.aggregated_amount - a.aggregated_amount).slice(0, 5);
    const total = geoData.reduce((s, d) => s + d.aggregated_amount, 0);
    
    body.innerHTML = `
      <div class="compact-location-list">
        ${sorted.map((d, i) => {
          const stateCode = d.state_code || d.shape_code || 'XX';
          const stateName = US_STATES[stateCode] || stateCode;
          const pct = total > 0 ? Math.round((d.aggregated_amount / total) * 100) : 0;
          
          return `
          <div class="compact-location-item">
            <div class="compact-location-rank">${i + 1}</div>
            <div class="compact-location-info">
              <div class="compact-location-name">${stateName}</div>
              <div class="compact-location-meta">${Utils.money(d.aggregated_amount)} Â· ${pct}%</div>
            </div>
          </div>`;
        }).join('')}
      </div>
      ${geoData.length > 5 ? `<div class="text-xs muted" style="text-align:center; margin-top:0.5rem;">+${geoData.length - 5} more states</div>` : ''}
    `;
  },

// --- Forecast Mode ---
  async runForecast(val) {
    let query = val || document.getElementById('mainSearchInput').value; if(!query) return;
    query = Utils.normalizeQuery(query);
  document.getElementById('mainSearchInput').value = query;
    // Reset data if query changed
    if(query !== App.currentQuery) { 
      App.searchData = { loaded:false }; 
      App.forecastData = { spending:null, agencies:null, awards:null, analysis:null, loaded:false }; 
    }
    
    // Ensure libraries are loaded (usually instant due to preloading)
    await LibLoader.ensureAll();
    
    if (typeof Chart !== 'undefined') {
      const cs = Chart.getChart("spendingChart"); if(cs) cs.destroy();
    }
    App.currentQuery = query; 
    App.mode = 'forecast'; 
    App.showLoader('CRUNCHING NUMBERS...', 'Applying Recency-Weighted Seasonality');
    
    try {
      const [spending, agencies, awards] = await Promise.all([
        API.getSpendingOverTime(query), 
        API.getAgencyData(query), 
        API.getAwardsForForecast(query)
      ]);
      
      App.forecastData = { 
        spending, 
        agencies, 
        awards, 
        analysis: ForecastEngine.analyze(spending, awards, agencies), 
        loaded: true 
      };
      
      App.transitionToApp(); 
      App.setMode('forecast'); 
      App.renderForecastDashboard();
      
    } catch(e) { 
      console.error(e); 
      App.showToast("Error fetching forecast data.", "error"); 
    } finally { 
      App.hideLoader(); 
    }
  },

renderForecastDashboard() {
    const analysis = App.forecastData.analysis; 
	if(!analysis || !analysis.byFY) {
      document.getElementById('projectionSummary').innerHTML = 
        '<div style="padding:1rem; color:var(--danger)">Insufficient data for forecast analysis.</div>';
      return;
    }
    const awards = App.forecastData.awards || [];
	const totalCeiling = awards.reduce((sum, a) => 
      sum + (parseFloat(a['Potential Total Value of Award']) || parseFloat(a['Award Amount']) || 0), 0);
    if(!analysis) return;

    // Corrected line: Sums Potential Value (Ceiling) instead of Obligated Amount
const totalAwards = awards.reduce((sum, a) => 
  sum + (parseFloat(a['Potential Total Value of Award']) || parseFloat(a['Award Amount']) || 0), 0);
    
    // Get obligation data from spending over time (actual spending)
    const curFY = Utils.getCurrentFY();
    const curQ = Utils.getCurrentQuarter();
    const fyTotals = analysis.byFY || {};
    const years = Object.keys(fyTotals).map(Number).sort();
    
    // Last complete FY obligations
    const lastCompleteFY = curFY - 1;
    const lastFYTotal = fyTotals[lastCompleteFY] ? Object.values(fyTotals[lastCompleteFY]).reduce((a,b) => a + b, 0) : 0;
    const priorFYTotal = fyTotals[lastCompleteFY - 1] ? Object.values(fyTotals[lastCompleteFY - 1]).reduce((a,b) => a + b, 0) : 0;
    
    // Calculate YoY change from obligations
    let yoyChange = 0;
    let yoyDirection = 'No prior data';
    if (priorFYTotal > 0 && lastFYTotal > 0) {
      yoyChange = ((lastFYTotal - priorFYTotal) / priorFYTotal) * 100;
      yoyDirection = yoyChange >= 0 ? 'Obligations growing' : 'Obligations declining';
    }

    // Calculate rolling 4-quarter projection
    const quarterlyForecasts = this.calculateRollingForecast(analysis.byFY, curFY, curQ, yoyChange);
    const projectionTotal = quarterlyForecasts.reduce((sum, q) => sum + q.projection, 0);

    // Update Stats Row
    document.getElementById('stat-total-awards').innerText = Utils.money(totalCeiling);
    document.getElementById('stat-total-obligations').innerText = Utils.money(lastFYTotal);
    
    const yoyEl = document.getElementById('stat-yoy-change');
    const yoyDirEl = document.getElementById('stat-yoy-direction');
    if (priorFYTotal > 0 && lastFYTotal > 0) {
      yoyEl.innerText = `${yoyChange >= 0 ? '+' : ''}${yoyChange.toFixed(0)}%`;
      yoyEl.style.color = yoyChange >= 0 ? 'var(--success)' : 'var(--danger)';
      yoyDirEl.innerText = yoyDirection;
      yoyDirEl.style.color = yoyChange >= 0 ? 'var(--success)' : 'var(--danger)';
    } else {
      yoyEl.innerText = 'N/A';
      yoyEl.style.color = 'var(--text-muted)';
      yoyDirEl.innerText = 'Insufficient history';
      yoyDirEl.className = 'stat-sub neutral';
    }
    
    document.getElementById('stat-recompetes').innerText = analysis.recompetes.length;

    // Render Rolling Forecast Table
    this.renderForecastTable(quarterlyForecasts, lastFYTotal, yoyChange, projectionTotal, analysis, awards);

    // Render Top Buyers (Agencies)
    this.renderTopBuyers(awards);
    
    // Render Top Winners (Vendors)
    this.renderTopWinners(awards);
    
    // Render Spending History Chart
    const ctx = document.getElementById('spendingChart').getContext('2d');
    const chartYears = Object.keys(analysis.byFY).sort();
    
    // Grab the accent color from your CSS
    const accentColor = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim();

    new Chart(ctx, {
      type: 'bar',
      data: { 
        // Sliced year labels: FY22, FY23, etc.
        labels: chartYears.map(y => `FY${String(y).slice(-2)}`), 
        datasets: [
          { label: 'Q1', data: chartYears.map(y => analysis.byFY[y][1] || 0), backgroundColor: accentColor }, 
          { label: 'Q2', data: chartYears.map(y => analysis.byFY[y][2] || 0), backgroundColor: accentColor }, 
          { label: 'Q3', data: chartYears.map(y => analysis.byFY[y][3] || 0), backgroundColor: accentColor }, 
          { label: 'Q4', data: chartYears.map(y => analysis.byFY[y][4] || 0), backgroundColor: accentColor }
        ] 
      },
      options: { 
        responsive: true, 
        maintainAspectRatio: false, 
        scales: { 
          x: { 
            stacked: false, // Keeps bars side-by-side
            grid: { display: false }, 
            ticks: { color: '#888' } 
          }, 
          y: { 
            stacked: false, 
            grid: { color: '#333' }, 
            ticks: { color: '#888', callback: v => Utils.money(v) } 
          } 
        }, 
        plugins: { 
          legend: { display: false }, // Hides legend
          tooltip: {
            callbacks: {
              label: ctx => `${ctx.dataset.label}: ${Utils.money(ctx.raw)}`
            }
          }
        } 
      }
    });
    
    // Render Recompetes List
    this.renderRecompetes(analysis.recompetes);
  },

  async loadSubcontractingData(query) {
    const body = document.getElementById('subcontractingBody');
    const statsEl = document.getElementById('subcontractingStats');
    if (!body) return;
    
    body.innerHTML = `<div style="text-align:center; padding:2rem; color:var(--text-muted);"><i class="fas fa-spinner fa-spin"></i> Loading subaward flow...</div>`;
    
    try {
      const subawards = await API.getSubawards(query);
      App.forecastData.subawards = subawards; // Store for later use
      this.renderSubawardSankey(subawards);
      
      // Render Top Primes and Subs cards
      this.renderSearchTopPrimes(subawards);
      this.renderSearchTopSubs(subawards);
    } catch (e) {
      console.error(e);
      body.innerHTML = `<div style="text-align:center; padding:1rem; color:var(--text-muted); font-size:0.85rem;">Unable to load subaward data</div>`;
    }
  },

  renderSubawardSankey(subawards) {
    const wrapper = document.getElementById('subawardWrapper');
    const body = document.getElementById('subcontractingBody');
    const statsEl = document.getElementById('subcontractingStats');
    const legendEl = document.getElementById('subcontractingLegend');
    
    if (!wrapper || !body) return;
    
    // 1. Hide the old legend (we use dynamic vintage colors now)
    if (legendEl) legendEl.style.display = 'none';

    // 2. CHECK DATA EXISTENCE
    if (!subawards || subawards.length === 0) {
      wrapper.style.display = 'none';
      if (statsEl) statsEl.innerHTML = '';
      return;
    }

    // Data exists: Reveal the wrapper
    wrapper.style.display = 'block';
    
    // --- Apply Drill Filter ---
    let filteredSubawards = subawards;
    const drill = App.subawardDrillState;
    
    if (drill.level > 0 && drill.filter) {
      if (drill.filterType === 'prime') {
        filteredSubawards = subawards.filter(sub => 
          (sub['Prime Recipient Name'] || 'Unknown Prime') === drill.filter
        );
      } else if (drill.filterType === 'sub') {
        filteredSubawards = subawards.filter(sub => 
          (sub['Sub-Awardee Name'] || 'Unknown Sub') === drill.filter
        );
      } else if (drill.filterType === 'agency') {
        filteredSubawards = subawards.filter(sub => 
          (sub['Awarding Agency'] || sub['Awarding Sub Agency'] || 'Unknown Agency') === drill.filter
        );
      }
    }
    
    // --- Data Processing ---
    const flowMap = {};
    let totalValue = 0;
    
    filteredSubawards.forEach(sub => {
      const agency = sub['Awarding Agency'] || sub['Awarding Sub Agency'] || 'Unknown Agency';
      const prime = sub['Prime Recipient Name'] || 'Unknown Prime';
      const subName = sub['Sub-Awardee Name'] || 'Unknown Sub';
      const amount = parseFloat(sub['Sub-Award Amount']) || 0;
      
      if (amount > 0) {
        const key1 = `${agency}|||${prime}`;
        flowMap[key1] = (flowMap[key1] || 0) + amount;
        
        const key2 = `${prime}|||${subName}`;
        flowMap[key2] = (flowMap[key2] || 0) + amount;
        
        totalValue += amount;
      }
    });
    
    // Update stats (breadcrumb handles the reset UI now)
    if (statsEl) {
      statsEl.innerHTML = `${Utils.money(totalValue)} subaward flow Â· ${filteredSubawards.length} records`;
    }
    
    const allFlows = Object.entries(flowMap).sort((a, b) => b[1] - a[1]);
    const topFlows = allFlows.slice(0, 40);
    
    const nodesSet = new Set();
    const links = [];
    
    topFlows.forEach(([key, value]) => {
      const [source, target] = key.split('|||');
      nodesSet.add(source);
      nodesSet.add(target);
      links.push({ source, target, value });
    });
    
    if (links.length === 0) {
      wrapper.style.display = 'none';
      return;
    }

    const nodes = Array.from(nodesSet).map(name => ({ name }));
    const nodeMap = new Map(nodes.map((n, i) => [n.name, i]));
    const d3Links = links.map(l => ({
      source: nodeMap.get(l.source),
      target: nodeMap.get(l.target),
      value: l.value
    }));
    
    // --- Rendering ---
    // Build breadcrumb HTML for drill state
    let breadcrumbHtml = '';
    if (drill.level > 0) {
      const typeLabel = drill.filterType === 'prime' ? 'Prime' : (drill.filterType === 'sub' ? 'Subcontractor' : 'Agency');
      breadcrumbHtml = `
        <div class="drill-breadcrumb" style="display: flex; margin-bottom: 0.75rem;">
          <div class="breadcrumb-item" onclick="App.resetSubawardDrill()" style="cursor:pointer;">
            <i class="fas fa-stream breadcrumb-icon"></i>
            <span>All Subawards</span>
          </div>
          <span class="breadcrumb-separator"><i class="fas fa-chevron-right"></i></span>
          <div class="breadcrumb-item active">
            <span>${Utils.trunc(drill.filter, 30)}</span>
            <span style="font-size:0.65rem; color:var(--text-muted); margin-left:6px;">(${typeLabel})</span>
          </div>
        </div>
      `;
    }
    
    body.innerHTML = `
      ${breadcrumbHtml}
      <div id="subawardDrillHint" class="drill-hint" style="margin-bottom: 0.5rem; ${drill.level > 0 ? 'display:none;' : ''}">
        <i class="fas fa-mouse-pointer"></i>
        <span>Click a <strong>prime</strong> or <strong>subcontractor</strong> bar to drill down</span>
      </div>
      <svg id="subawardSankeySvg" style="width:100%;"></svg>
    `;
    
    const width = body.clientWidth || 600;
    const height = Math.max(350, nodes.length * 20);
    
    const svg = d3.select('#subawardSankeySvg')
      .attr('width', width)
      .attr('height', height);
    
    const sankey = d3.sankey()
      .nodeId(d => d.index)
      .nodeWidth(20)
      .nodePadding(20)
      .extent([[1, 1], [width - 1, height - 6]]);
    
    const { nodes: sankeyNodes, links: sankeyLinks } = sankey({
      nodes: nodes.map(d => Object.assign({}, d)),
      links: d3Links.map(d => Object.assign({}, d))
    });
    
    // Determine node types for drill behavior
    const primeNames = new Set(filteredSubawards.map(s => s['Prime Recipient Name'] || 'Unknown Prime'));
    const subNames = new Set(filteredSubawards.map(s => s['Sub-Awardee Name'] || 'Unknown Sub'));
    const agencyNames = new Set(filteredSubawards.map(s => s['Awarding Agency'] || s['Awarding Sub Agency'] || 'Unknown Agency'));
    
    sankeyNodes.forEach(node => {
      if (agencyNames.has(node.name) && !primeNames.has(node.name)) {
        node.nodeType = 'agency';
      } else if (primeNames.has(node.name)) {
        node.nodeType = 'prime';
      } else {
        node.nodeType = 'sub';
      }
    });
    
    // 3. GRADIENTS
    const defs = svg.append('defs');
    sankeyLinks.forEach((l, i) => {
      const colorSource = Utils.getColor(l.source.name);
      const colorTarget = Utils.getColor(l.target.name);
      
      const gradient = defs.append('linearGradient')
        .attr('id', `sub-gradient-${i}`)
        .attr('gradientUnits', 'userSpaceOnUse')
        .attr('x1', l.source.x1)
        .attr('x2', l.target.x0);
      
      gradient.append('stop').attr('offset', '0%').attr('stop-color', colorSource);
      gradient.append('stop').attr('offset', '100%').attr('stop-color', colorTarget);
    });
    
    // 4. LINKS
    svg.append('g')
      .attr('fill', 'none')
      .selectAll('path')
      .data(sankeyLinks)
      .join('path')
      .attr('d', d3.sankeyLinkHorizontal())
      .attr('stroke', (d, i) => `url(#sub-gradient-${i})`)
      .attr('stroke-width', d => Math.max(1, d.width))
      .attr('stroke-opacity', 0.4)
      .on('mouseover', function() { d3.select(this).attr('stroke-opacity', 0.8); })
      .on('mouseout', function() { d3.select(this).attr('stroke-opacity', 0.4); })
      .append('title')
      .text(d => `${d.source.name} â†’ ${d.target.name}\n${Utils.money(d.value)}`);
    
    // 5. NODES (with click handler for drill-down)
    svg.append('g')
      .selectAll('rect')
      .data(sankeyNodes)
      .join('rect')
      .attr('x', d => d.x0)
      .attr('y', d => d.y0)
      .attr('height', d => Math.max(1, d.y1 - d.y0))
      .attr('width', d => d.x1 - d.x0)
      .attr('fill', d => Utils.getColor(d.name))
      .attr('opacity', 0.8)
      .style('cursor', 'pointer')
      .on('click', function(event, d) {
        App.drillSubaward(d.name, d.nodeType);
      })
      .on('mouseover', function() { d3.select(this).attr('opacity', 1); })
      .on('mouseout', function() { d3.select(this).attr('opacity', 0.8); })
      .append('title')
      .text(d => `${d.name}\n${Utils.money(d.value)}\nClick to filter`);
    
    // 6. LABELS
    svg.append('g')
      .selectAll('text')
      .data(sankeyNodes)
      .join('text')
      .attr('x', d => d.x0 < width / 2 ? d.x1 + 6 : d.x0 - 6)
      .attr('y', d => (d.y1 + d.y0) / 2)
      .attr('dy', '0.35em')
      .attr('text-anchor', d => d.x0 < width / 2 ? 'start' : 'end')
      .text(d => Utils.trunc(d.name, 35))
      .style('font-size', '11px') 
      .style('fill', '#fff')
      .style('pointer-events', 'none')
      .style('text-shadow', 'none');
  },

  // Subaward drill-down handler
  drillSubaward(name, nodeType) {
    App.subawardDrillState = {
      level: 1,
      filter: name,
      filterType: nodeType
    };
    // Re-render with filter applied
    if (App.forecastData.subawards) {
      App.renderSubawardSankey(App.forecastData.subawards);
      App.renderSearchTopPrimes(App.forecastData.subawards);
      App.renderSearchTopSubs(App.forecastData.subawards);
    }
  },

  // Reset subaward drill
  resetSubawardDrill() {
    App.subawardDrillState = { level: 0, filter: null, filterType: null };
    if (App.forecastData.subawards) {
      App.renderSubawardSankey(App.forecastData.subawards);
      App.renderSearchTopPrimes(App.forecastData.subawards);
      App.renderSearchTopSubs(App.forecastData.subawards);
    }
  },

  renderTopBuyers(awards) {
    const body = document.getElementById('topBuyersBody');
    if (!body) return;
    
    // Group by agency
    const agencyMap = {};
    awards.forEach(a => {
      const agency = a['Awarding Agency'] || 'Unknown';
      if (!agencyMap[agency]) {
        agencyMap[agency] = { name: agency, spend: 0, count: 0 };
      }
      agencyMap[agency].spend += parseFloat(a['Award Amount']) || 0;
      agencyMap[agency].count++;
    });
    
    const sorted = Object.values(agencyMap).sort((a, b) => b.spend - a.spend);
    const total = sorted.reduce((s, a) => s + a.spend, 0);
    
    if (sorted.length === 0) {
      body.innerHTML = `<div style="text-align:center; color:var(--text-muted); padding:1rem;">No agency data available</div>`;
      return;
    }
    
    const topAgencies = sorted.slice(0, 8);
    
    body.innerHTML = `
      <div class="buyer-list">
        ${topAgencies.map((a, i) => {
          const share = total > 0 ? (a.spend / total * 100) : 0;
          return `
          <div class="buyer-item">
            <div class="buyer-rank mono text-xs bold accent">${i + 1}</div>
            <div class="buyer-info">
              <div class="buyer-name truncate">${Utils.trunc(a.name, 40)}</div>
              <div class="buyer-stats text-xs muted">${a.count} contracts</div>
            </div>
            <div class="buyer-amount">
              <div class="buyer-spend mono accent">${Utils.money(a.spend)}</div>
              <div class="buyer-share text-xs muted">${share.toFixed(1)}%</div>
            </div>
          </div>`;
        }).join('')}
      </div>
      ${sorted.length > 8 ? `<div style="text-align:center; color:var(--text-muted); font-size:0.75rem; margin-top:0.75rem;">+${sorted.length - 8} more agencies</div>` : ''}
    `;
  },

  renderTopWinners(awards) {
    const body = document.getElementById('topWinnersBody');
    if (!body) return;
    
    // Group by vendor
    const vendorMap = {};
    awards.forEach(a => {
      const vendor = a['Recipient Name'] || 'Unknown';
      if (!vendorMap[vendor]) {
        vendorMap[vendor] = { name: vendor, spend: 0, count: 0, agencies: new Set() };
      }
      vendorMap[vendor].spend += parseFloat(a['Award Amount']) || 0;
      vendorMap[vendor].count++;
      vendorMap[vendor].agencies.add(a['Awarding Agency'] || 'Unknown');
    });
    
    const sorted = Object.values(vendorMap)
      .map(v => ({ ...v, agencies: v.agencies.size }))
      .sort((a, b) => b.spend - a.spend);
    const total = sorted.reduce((s, v) => s + v.spend, 0);
    
    if (sorted.length === 0) {
      body.innerHTML = `<div style="text-align:center; color:var(--text-muted); padding:1rem;">No vendor data available</div>`;
      return;
    }
    
    const topVendors = sorted.slice(0, 8);
    
    body.innerHTML = `
      <div class="buyer-list">
        ${topVendors.map((v, i) => {
          const share = total > 0 ? (v.spend / total * 100) : 0;
          
          return `
          <div class="buyer-item">
            <div class="buyer-rank mono text-xs bold accent">${i + 1}</div>
            <div class="buyer-info">
              <div class="buyer-name truncate">${Utils.trunc(v.name, 35)}</div>
              <div class="buyer-stats text-xs muted">${v.count} contracts Â· ${v.agencies} ${v.agencies === 1 ? 'agency' : 'agencies'}</div>
            </div>
            <div class="buyer-amount">
              <div class="buyer-spend mono accent">${Utils.money(v.spend)}</div>
              <div class="buyer-share text-xs muted">${share.toFixed(1)}%</div>
            </div>
          </div>`;
        }).join('')}
      </div>
      ${sorted.length > 8 ? `<div style="text-align:center; color:var(--text-muted); font-size:0.75rem; margin-top:0.75rem;">+${sorted.length - 8} more vendors</div>` : ''}
    `;
  },

  renderRecompetes(recompetes) {
    const container = document.getElementById('recompetesList');
    if (!container) return;
    
    if (!recompetes || recompetes.length === 0) {
      container.innerHTML = '';
      return;
    }
    
    // 1. Preserve Mission Gap Risk Calculation
    const withRisk = recompetes.map(r => ({
      ...r,
      risk: Utils.missionGapRisk(r)
    }));
    
    // 2. Preserve Detailed Metrics Calculation
    const totalRecompeteValue = withRisk.reduce((sum, r) => sum + (parseFloat(r['Award Amount']) || 0), 0);
    const highRiskContracts = withRisk.filter(r => r.risk.level === 'high');
    const highRiskValue = highRiskContracts.reduce((sum, r) => sum + (parseFloat(r['Award Amount']) || 0), 0);
    
    // 3. Preserve User-Defined Filtering
    const filtered = App.onlyHighMissionGap 
      ? withRisk.filter(r => r.risk.level === 'high')
      : withRisk;
    
    // 4. Preserve Complex Subtitle Logic
    let subtitleText = `${Utils.money(totalRecompeteValue)} in ${recompetes.length} contracts expiring within 24 months`;
    if (highRiskContracts.length > 0) {
      subtitleText += ` Â· <span style="color:var(--danger); font-weight:600;">${highRiskContracts.length} high-risk (${Utils.money(highRiskValue)})</span>`;
    }
    
    // 5. Render Header with the "High Risk Only" Toggle
    container.innerHTML = `
      <div class="section-header">
        <div class="section-title-group">
          <i class="fas fa-clock" style="color:var(--danger)"></i>
          <span class="section-title">Expiring Contracts</span>
        </div>
        <div class="mission-gap-filter">
          <span class="section-subtitle">${subtitleText}</span>
          ${highRiskContracts.length > 0 ? `
            <button class="mission-gap-toggle ${App.onlyHighMissionGap ? 'active' : ''}" onclick="App.toggleMissionGapFilter()" title="Show only contracts with high mission continuity risk">
              <i class="fas fa-exclamation-triangle"></i>
              High Risk Only
            </button>
          ` : ''}
        </div>
      </div>
      
      ${filtered.length === 0 ? `
        <div style="text-align:center; padding:2rem; color:var(--text-muted);">
          No contracts match the current filter.
          <a href="#" onclick="App.toggleMissionGapFilter(); return false;" style="color:var(--accent); margin-left:0.5rem;">Show all</a>
        </div>
      ` : filtered.map(r => {
        // Skip contracts with no end date (prevents 1970 date bug)
        if (!r['End Date']) return '';
        
        const internalId = r['generated_internal_id'];
        const awardUrl = internalId 
          ? `https://www.usaspending.gov/award/${internalId}`
          : (r['Award ID'] ? `https://www.usaspending.gov/search/?hash=&filters=${encodeURIComponent(JSON.stringify({keyword: r['Award ID']}))}` : null);
        
        // 6. Updated: Standardized Fiscal Period Calculation (FY26 Q1)
        const endDate = new Date(r['End Date']);
        const m = endDate.getMonth();
        const y = endDate.getFullYear();
        const fy = m >= 9 ? y + 1 : y;
        let q = 1;
        if (m >= 0 && m <= 2) q = 2;
        else if (m >= 3 && m <= 5) q = 3;
        else if (m >= 6 && m <= 8) q = 4;
        const fiscalPeriod = `FY${String(fy).slice(-2)} Q${q}`;

        // 7. Preserve Urgency Calculation
        const today = new Date();
        const daysUntil = Math.ceil((endDate - today) / (1000 * 60 * 60 * 24));
        const urgency = daysUntil < 180 ? 'urgent' : daysUntil < 365 ? 'soon' : 'later';
        
        // 8. Preserve Mission Gap Labeling
        const risk = r.risk;
        const riskLabel = risk.level === 'high' ? 'Mission Gap: High'
          : risk.level === 'medium' ? 'Mission Gap: Medium'
          : 'Mission Gap: Low';
        
        // Helper for escaping HTML
        const esc = str => Autocomplete.escapeHtml(str);
        
        return `
        <div class="deal-card" style="margin-bottom:1rem; ${risk.level === 'high' ? 'border-left: 3px solid var(--danger);' : risk.level === 'medium' ? 'border-left: 3px solid #FDD835;' : ''}">
          <div class="deal-header">
            <span class="deal-agency">${esc(Utils.trunc(r['Awarding Agency'], 40))}</span>
            <span class="deal-amount">${Utils.money(r['Award Amount'])}</span>
          </div>
          <div class="deal-desc">${esc(Utils.trunc(r['Description'], 100))}</div>
          <div class="deal-meta">
            <span class="meta-tag" style="color:var(--accent); border-color:var(--accent);">${fiscalPeriod}</span>
            <span class="meta-tag mission-gap ${risk.level}" title="Flags contracts likely tied to ongoing operational support">${riskLabel}</span>
            ${r['PSC Code'] ? `<span class="meta-tag psc" title="${esc(r['PSC Description'] || '')}">PSC: ${esc(r['PSC Code'])}</span>` : ''}
          </div>
          
          ${risk.reasons.length > 0 && risk.level !== 'low' ? `<div class="mission-gap-signals">Signals: ${esc(risk.reasons.join(', '))}</div>` : ''}
          
          <div class="deal-footer">
            <div>
              <div style="font-size:0.8rem; color:${urgency === 'urgent' ? 'var(--danger)' : urgency === 'soon' ? '#FDD835' : 'var(--text-muted)'}">
                Expires: ${Utils.date(r['End Date'])} (${daysUntil} days)
              </div>
              <div style="font-size:0.75rem; color:#666">Incumbent: ${esc(Utils.trunc(r['Recipient Name'], 35))}</div>
            </div>
            ${awardUrl ? `<a href="${awardUrl}" target="_blank" rel="noopener" class="action-btn">OPEN AWARD <i class="fas fa-external-link-alt"></i></a>` : ''}
          </div>
        </div>`;
      }).join('')}
    `;
  },
  toggleMissionGapFilter() {
    App.onlyHighMissionGap = !App.onlyHighMissionGap;
    // Re-render with current recompetes data
    if (App.forecastData.analysis && App.forecastData.analysis.recompetes) {
      this.renderRecompetes(App.forecastData.analysis.recompetes);
    }
  },

calculateRollingForecast(byFY, curFY, curQ, overallYoyTrend) {
    const forecasts = [];
    let fy = curFY;
    let q = curQ;
    
    for (let i = 0; i < 4; i++) {
      const historicalValues = [];
      const years = Object.keys(byFY).map(Number).sort().reverse(); 
      
      years.forEach(year => {
        if (year < curFY && byFY[year] && byFY[year][q] > 0 && historicalValues.length < 3) {
          historicalValues.push({ fy: year, amount: byFY[year][q] });
        }
      });
      
      let weightedAvg = 0;
      if (historicalValues.length > 0) {
        const weights = [0.5, 0.3, 0.2];
        let totalWeight = 0;
        historicalValues.forEach((h, idx) => {
          const w = weights[idx] || 0.1;
          weightedAvg += h.amount * w;
          totalWeight += w;
        });
        weightedAvg = weightedAvg / totalWeight;
      }
      
      const lastYearVal = byFY[curFY - 1] && byFY[curFY - 1][q] ? byFY[curFY - 1][q] : 0;
      const priorYearVal = byFY[curFY - 2] && byFY[curFY - 2][q] ? byFY[curFY - 2][q] : 0;
      
      let quarterGrowthRate = 0;
      if (priorYearVal > 0 && lastYearVal > 0) {
        quarterGrowthRate = (lastYearVal - priorYearVal) / priorYearVal;
      } else if (overallYoyTrend) {
        quarterGrowthRate = overallYoyTrend / 100;
      }
      
      quarterGrowthRate = Math.max(-0.5, Math.min(0.5, quarterGrowthRate));
      const trendMultiplier = 1 + quarterGrowthRate;
      
      let projection = 0;
      if (lastYearVal > 0) projection = lastYearVal * trendMultiplier;
      else if (weightedAvg > 0) projection = weightedAvg * trendMultiplier;
      
      forecasts.push({
        // Updated to Standard Format: FY26 Q1
        period: `FY${String(fy).slice(-2)} Q${q}`,
        quarter: q,
        fiscalYear: fy,
        historicalAvg: weightedAvg,
        lastYear: lastYearVal,
        priorYear: priorYearVal,
        quarterGrowth: quarterGrowthRate * 100,
        projection: projection,
        dataPoints: historicalValues.length
      });
      
      q++;
      if (q > 4) { q = 1; fy++; }
    }
    return forecasts;
  },
  
  renderForecastTable(forecasts, lastFYTotal, yoyChange, projectionTotal, analysis, awards) {
  const tbody = document.getElementById('forecastTableBody');
  if (!tbody) return;

  const curFY = Utils.getCurrentFY();
  const curQ = Utils.getCurrentQuarter();
  
  // 1. Get Actual Data for Current FY
  const historicalData = (analysis.byFY && analysis.byFY[curFY]) ? analysis.byFY[curFY] : {};
  const ytdActuals = Object.values(historicalData).reduce((sum, val) => sum + (val || 0), 0);

  // 2. Calculate True FY Projection (Blended Actuals + Forecast)
  let trueFYProjection = 0;
  
  // Loop through all 4 quarters to build the landing number
  for (let q = 1; q <= 4; q++) {
    const actual = historicalData[q] || 0;
    
    // Find the model's projection for this quarter
    const match = forecasts.find(f => f.fiscalYear === curFY && f.quarter === q);
    const projected = match ? match.projection : 0;

    if (q < curQ) {
      // PAST: Use Actuals Only (Banked)
      trueFYProjection += actual;
    } else if (q === curQ) {
      // CURRENT: Use the higher of Actuals or Projection
      // This prevents the forecast from dipping below what we've already booked
      trueFYProjection += Math.max(actual, projected);
    } else {
      // FUTURE: Use Projection Only
      trueFYProjection += projected;
    }
  }

  // 3. Render the Table
  tbody.innerHTML = forecasts.map(f => {
    const hasData = f.dataPoints > 0;
    const qGrowth = f.quarterGrowth || 0;
    const trendClass = qGrowth >= 0 ? 'trend-up' : 'trend-down';
    const trendIcon = qGrowth >= 0 ? 'â–²' : 'â–¼';
    
    // Check if this row is a past or current quarter with actual data
    const actualAmount = historicalData[f.quarter] || 0;
    const isPast = f.fiscalYear === curFY && f.quarter < curQ;
    const isCurrent = f.fiscalYear === curFY && f.quarter === curQ;
    
    let amountDisplay = '';
    
    if (isPast) {
      // Past: Show Actual (Locked)
      amountDisplay = `<span style="color:var(--text-primary); font-weight:700; border-bottom:1px dotted var(--text-muted); cursor:help;" title="Actual Obligation (Final)">${Utils.money(actualAmount)}</span>`;
    } else if (isCurrent) {
      // Current: Show Projection but indicate Actuals progress
      amountDisplay = `<span style="color:var(--accent); font-weight:600;" title="Proj: ${Utils.money(f.projection)} / Actual: ${Utils.money(actualAmount)}">${Utils.money(Math.max(actualAmount, f.projection))}</span>`;
    } else {
      // Future: Show Projection
      amountDisplay = `<span style="color:var(--accent); font-weight:600;">${f.projection > 0 ? Utils.money(f.projection) : '-'}</span>`;
    }

    return `
      <tr>
        <td>
          <strong>${f.period}</strong> 
          ${isPast ? '<i class="fas fa-lock" style="font-size:0.6rem; color:var(--text-muted); margin-left:4px;" title="Closed Quarter"></i>' : ''}
          ${isCurrent ? '<i class="fas fa-clock" style="font-size:0.6rem; color:var(--accent); margin-left:4px;" title="Active Quarter"></i>' : ''}
        </td>
        <td style="color:var(--text-muted);">
          ${hasData ? Utils.money(f.historicalAvg) : '<span style="opacity:0.5">No data</span>'}
        </td>
        <td style="color:var(--text-muted);">${f.lastYear > 0 ? Utils.money(f.lastYear) : '-'}</td>
        <td style="white-space: nowrap;">
          <div style="display: inline-flex; align-items: center; gap: 0.5rem;">
            ${amountDisplay}
            ${!isPast && f.lastYear > 0 ? 
              `<span class="trend-pill ${trendClass}" style="font-size:0.65rem;">${trendIcon} ${Math.abs(qGrowth).toFixed(0)}%</span>` 
              : ''}
          </div>
        </td>
      </tr>
    `;
  }).join('');
  
  const summaryEl = document.getElementById('projectionSummary');
  if (summaryEl && trueFYProjection > 0) {
    const projectedGrowth = lastFYTotal > 0 ? ((trueFYProjection - lastFYTotal) / lastFYTotal) * 100 : 0;
    const growthColor = projectedGrowth >= 0 ? 'var(--success)' : 'var(--danger)';
    const fyShorthand = `FY${String(curFY).slice(-2)}`;
    
    // Calculate Percent Complete (YTD / Projected Landing)
    const percentComplete = trueFYProjection > 0 ? (ytdActuals / trueFYProjection) * 100 : 0;
    const toGoAmount = Math.max(0, trueFYProjection - ytdActuals);

    // Tactical Advice Logic
    const topAgency = (awards && awards[0] && awards[0]['Awarding Agency']) ? awards[0]['Awarding Agency'] : 'the primary agency';
    let tacticalAdvice = '';
    if (analysis.hhi > 2500) {
        tacticalAdvice = `teaming with established primes to bypass high barriers to entry.`;
    } else if (analysis.hhi > 1500) {
        tacticalAdvice = `a targeted account-entry strategy focusing on under-served sub-agencies.`;
    } else {
        tacticalAdvice = `an aggressive displacement strategy targeting the ${topAgency} incumbent base.`;
    }
    const recompeteValue = analysis.recompetes.reduce((s, r) => s + (parseFloat(r['Award Amount']) || 0), 0);
    const avgDataPoints = forecasts.length > 0 
      ? Number(forecasts.reduce((sum, f) => sum + (f.dataPoints || 0), 0) / forecasts.length) || 0 
      : 0;
    const volatilityScore = Number(analysis.volatility?.score) || 0.5;
    let confidenceScore = ((avgDataPoints / 3) * 70) + ((1 - volatilityScore) * 30);
    confidenceScore = Math.max(0, Math.min(100, Number(confidenceScore) || 0));
    let confidenceLevel = confidenceScore >= 75 ? 'HIGH' : (confidenceScore >= 45 ? 'MEDIUM' : 'LOW');
    let confidenceClass = confidenceLevel.toLowerCase();

    // 4. Update Summary HTML with YTD Logic
    summaryEl.innerHTML = `
      <div class="hero-growth-label">Projected ${fyShorthand} Forecast</div>
      <div style="display: flex; align-items: baseline; gap: 1.5rem; flex-wrap: wrap; margin-bottom: 0.5rem;">
        <div class="hero-growth-value">${Utils.money(trueFYProjection)}</div>
        <div style="color:${growthColor}; font-size: 1.5rem; font-weight: 700; font-family: 'JetBrains Mono';">
          ${projectedGrowth >= 0 ? 'â–²' : 'â–¼'} ${Math.abs(projectedGrowth).toFixed(0)}% <span style="font-size:0.8rem; opacity:0.7">YoY Growth</span>
        </div>
      </div>
      
      <div style="margin-bottom: 1.5rem; font-size: 0.7rem; color: var(--text-muted);">
        <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
          <span>Obligations YTD: <strong style="color:var(--text-primary)">${Utils.money(ytdActuals)}</strong></span>
          <span>Forecast (To-Go): ${Utils.money(toGoAmount)}</span>
        </div>
        <div style="height:6px; width:100%; background:rgba(255,255,255,0.1); border-radius:3px; overflow:hidden;">
          <div style="height:100%; width:${percentComplete}%; background:var(--text-primary); opacity:0.8;"></div>
        </div>
      </div>
      
      <div class="strategic-narrative-card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
          <div style="color:var(--accent); font-weight:700; font-size:0.7rem; text-transform:uppercase; letter-spacing:1px;">
            <i class="fas fa-robot"></i> Data Insights
          </div>
          <div style="font-size:0.6rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px;">
            Model Confidence: <span class="analysis-panel-badge ${confidenceClass}">${confidenceLevel} (${confidenceScore.toFixed(0)}%)</span>
          </div>
        </div>

        <strong>Market Dynamics:</strong> This is a <strong>${analysis.marketStatus}</strong> market (HHI: ${analysis.hhi}). 
        With a ${projectedGrowth >= 0 ? 'bullish' : 'softening'} <strong>${projectedGrowth.toFixed(0)}% ${fyShorthand} growth forecast</strong>, 
        the model recommends ${tacticalAdvice}
        ${analysis.recompetes.length > 5 ? ` High recompete volume (${Utils.money(recompeteValue)}) in the next 24 months signals a prime capture window.` : ''}
        
        <div style="margin-top: 15px; padding: 10px; background: rgba(0,0,0,0.2); border: 1px solid var(--border); border-radius: 4px;">
          <div style="font-size: 0.6rem; color: var(--accent); text-transform: uppercase; margin-bottom: 5px; font-weight: 700;">Confidence Logic</div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.65rem; color: var(--text-muted);">
            <div>
              <strong>Density:</strong> ${avgDataPoints.toFixed(1)}/3.0 Years 
              <div style="height:3px; width:100%; background:#333; margin-top:3px;">
                <div style="height:100%; width:${(avgDataPoints/3)*100}%; background:var(--accent);"></div>
              </div>
            </div>
            <div>
              <strong>Stability:</strong> ${(100 - (volatilityScore * 100)).toFixed(0)}% Stable
              <div style="height:3px; width:100%; background:#333; margin-top:3px;">
                <div style="height:100%; width:${(1-volatilityScore)*100}%; background:var(--accent);"></div>
              </div>
            </div>
          </div>
          <div style="font-size: 0.6rem; margin-top: 8px; font-style: italic; opacity: 0.8;">
            Note: High volatility or <1 year of data reduces projection reliability.
          </div>
        </div>
      </div>
      
      <div class="disclaimer-text" style="margin-top: 1.5rem; padding: 1rem; border-top: 1px solid var(--border); font-size: 0.7rem; color: var(--text-muted); line-height: 1.5;">
  
  <strong style="color: var(--accent); text-transform: uppercase; letter-spacing: 0.5px; display: block; margin-bottom: 0.5rem;">
    <i class="fas fa-info-circle"></i> Notes
  </strong>

  <ul style="padding-left: 1rem; margin-bottom: 1rem; list-style-type: disc;">
    <li style="margin-bottom: 0.25rem;">
      <strong>Obligations vs. Ceiling:</strong> We track <em>Obligated Funds</em> (cash spent), not Ceiling (potential value). This ensures you chase actual funded opportunities, not empty contract vehicles.
    </li>
    <li style="margin-bottom: 0.25rem;">
      <strong>Seasonality Model:</strong> Our forecasts account for the "Q4 Spending Spree" (July-Sept). If the "To-Go" number looks high, it's because the agency historically dumps budget at year-end.
    </li>
    <li style="margin-bottom: 0.25rem;">
      <strong>Market Lock (HHI):</strong> We calculate incumbency strength. <span style="color:#ddd;">Low scores (&lt;1,500)</span> mean the door is open; <span style="color:#ddd;">High scores (&gt;2,500)</span> mean you should look to partner.
    </li>
    <li style="margin-bottom: 0.25rem;">
      <strong>Reporting Lag:</strong> Defense agencies (DoD) often delay reporting by 90 days for security. Recent awards may not appear immediately.
    </li>
  </ul>

  <div style="font-style: italic; opacity: 0.8; border-top: 1px dashed var(--border); padding-top: 0.5rem;">
    <strong>Disclaimer:</strong> Govhoo is a free intelligence tool built to help you plan. Projections are estimates based solely on USASpending.gov data. Always verify specific opportunities on SAM.gov.
  </div>

</div>
    `;
  } else if (summaryEl) {
    summaryEl.innerHTML = '';
  }
},
// --- Helpers ---
  exportCSV(btn) {
    const data = App.mode === 'search' ? App.searchData.active : (App.forecastData.awards || []);
    
    // IF NO DATA: Flash Red (Error)
    if (!data.length) {
      if (btn) {
        const originalHtml = btn.innerHTML;
        btn.style.color = 'var(--danger)';
        btn.style.borderColor = 'var(--danger)';
        btn.innerHTML = '<i class="fas fa-times"></i>'; 
        setTimeout(() => {
          btn.style.color = '';
          btn.style.borderColor = '';
          btn.innerHTML = originalHtml;
        }, 2000);
      }
      return;
    }
    
    // Updated Headers with Fiscal Period
    const headers = ['Fiscal Period', 'Recipient', 'Agency', 'Sub-Agency', 'Amount', 'Description', 'Start Date', 'End Date', 'Award ID', 'Award Link'];
    
    const rows = data.map(c => {
      // Logic for FY26 Q1 shorthand
      let fiscalPeriod = 'N/A';
      if (c['Start Date']) {
        const d = new Date(c['Start Date']);
        const m = d.getMonth(); 
        const y = d.getFullYear();
        const fy = m >= 9 ? y + 1 : y;
        let q;
        if (m >= 9) q = 1;        // Oct-Nov-Dec = Q1
        else if (m <= 2) q = 2;   // Jan-Feb-Mar = Q2
        else if (m <= 5) q = 3;   // Apr-May-Jun = Q3
        else q = 4;               // Jul-Aug-Sep = Q4
        fiscalPeriod = `FY${String(fy).slice(-2)} Q${q}`;
      }

      const internalId = c['generated_internal_id']; 
      let awardUrl = '';
      if (internalId) awardUrl = `https://www.usaspending.gov/award/${internalId}`;
      else if (c['Award ID']) awardUrl = `https://www.usaspending.gov/search/?hash=&filters=${encodeURIComponent(JSON.stringify({keyword: c['Award ID']}))}`;
      
      return [
        `"${fiscalPeriod}"`,
        `"${(c['Recipient Name'] || '').replace(/"/g, '""')}"`, 
        `"${(c['Awarding Agency'] || '').replace(/"/g, '""')}"`, 
        `"${(c['Awarding Sub Agency'] || '').replace(/"/g, '""')}"`, 
        c['Award Amount'] || 0, 
        `"${(c['Description'] || '').replace(/"/g, '""')}"`, 
        c['Start Date'] || '', 
        c['End Date'] || '', 
        c['Award ID'] || '', 
        awardUrl
      ];
    });
    
    const csvContent = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a"); 
    link.setAttribute("href", url); 
    link.setAttribute("download", `govhoo_${App.mode}_${App.currentQuery}.csv`);
    document.body.appendChild(link); link.click(); document.body.removeChild(link);

    // SUCCESS: Flash Green
    if (btn) {
      const originalHtml = btn.innerHTML;
      btn.style.color = 'var(--success)';
      btn.style.borderColor = 'var(--success)';
      btn.innerHTML = '<i class="fas fa-check"></i>'; 
      setTimeout(() => {
        btn.style.color = '';
        btn.style.borderColor = '';
        btn.innerHTML = originalHtml;
      }, 2000);
    }
  },
  
  showLoader(text, subtext) { document.getElementById('loaderText').innerText = text; document.getElementById('loaderSubtext').innerText = subtext || ''; document.getElementById('loader').style.display = 'flex'; },
  hideLoader() { document.getElementById('loader').style.display = 'none'; },
  transitionToApp() {
    const hero = document.getElementById('heroView'); 
    hero.classList.add('slide-up');
    document.getElementById('appView').style.display = 'block'; 
    document.getElementById('miniSearch').value = App.currentQuery;
    document.getElementById('dashboardContainer').classList.add('active'); 
    const dashContainer = document.getElementById('dashboardContainer');
    if (!dashContainer.querySelector('.hero-footer')) {
      const heroFooter = hero.querySelector('.hero-footer');
      if (heroFooter) {
        const footerClone = heroFooter.cloneNode(true);
        // Remove the ID to prevent duplicates (if you add IDs later)
        footerClone.removeAttribute('id'); 
        dashContainer.appendChild(footerClone);
      }
    }

    setTimeout(() => { 
      hero.style.display = 'none'; 
      hero.classList.add('hidden'); 
    }, 500);
  },
  
  shareLink(btn) {
    const url = new URL(window.location); url.searchParams.set('q', App.currentQuery); url.searchParams.set('mode', App.mode);
    navigator.clipboard.writeText(url.toString()).then(() => {
      // SUCCESS: Flash Green
      if (btn) {
        const originalHtml = btn.innerHTML;
        btn.style.color = 'var(--success)';
        btn.style.borderColor = 'var(--success)';
        btn.innerHTML = '<i class="fas fa-check"></i>'; // Switch to Checkmark
        setTimeout(() => {
          btn.style.color = '';
          btn.style.borderColor = '';
          btn.innerHTML = originalHtml;
        }, 2000);
      }
    });
  }
};

const PromptPackageGenerator = {
  calculateMetrics(data, analysis) {
    const totalValue = data.reduce((sum, r) => sum + (parseFloat(r['Award Amount']) || 0), 0);
    const contractCount = data.length;
    const avgDealSize = contractCount > 0 ? totalValue / contractCount : 0;
    const amounts = data.map(r => parseFloat(r['Award Amount']) || 0).filter(a => a > 0).sort((a, b) => a - b);
    // Proper median calculation: average middle two values for even-length arrays
    let medianDealSize = 0;
    if (amounts.length > 0) {
      const mid = Math.floor(amounts.length / 2);
      medianDealSize = amounts.length % 2 !== 0 
        ? amounts[mid] 
        : (amounts[mid - 1] + amounts[mid]) / 2;
    }
    const largeDeals = amounts.filter(a => a >= 1000000).length;
    const midDeals = amounts.filter(a => a >= 100000 && a < 1000000).length;
    const smallDeals = amounts.filter(a => a < 100000).length;
    
    const now = new Date();
    const expiringContracts = data.filter(c => {
      const endDate = new Date(c['End Date']);
      const monthsOut = (endDate - now) / (1000 * 60 * 60 * 24 * 30);
      return monthsOut > 0 && monthsOut <= 18;
    });
    const expiringValue = expiringContracts.reduce((s, c) => s + (parseFloat(c['Award Amount']) || 0), 0);
    
    return {
      totalValue, contractCount, avgDealSize, medianDealSize,
      largeDeals, midDeals, smallDeals,
      expiringValue, expiringCount: expiringContracts.length
    };
  },

  buildVendorIntel(data) {
    const vendorMap = {};
    const now = new Date();
    
    data.forEach(r => {
      const v = r['Recipient Name'] || 'Unknown';
      if (!vendorMap[v]) vendorMap[v] = { 
        spend: 0, count: 0, agencies: new Set(), contracts: [], expiring: 0
      };
      const amt = parseFloat(r['Award Amount']) || 0;
      vendorMap[v].spend += amt;
      vendorMap[v].count++;
      vendorMap[v].agencies.add(r['Awarding Agency']);
      vendorMap[v].contracts.push(r);
      
      const endDate = new Date(r['End Date']);
      const monthsOut = (endDate - now) / (1000 * 60 * 60 * 24 * 30);
      if (monthsOut > 0 && monthsOut <= 18) {
        vendorMap[v].expiring += amt;
      }
    });
    
    const totalSpend = Object.values(vendorMap).reduce((s, v) => s + v.spend, 0);
    
    return Object.entries(vendorMap)
      .map(([name, d]) => ({
        name, spend: d.spend,
        share: totalSpend > 0 ? ((d.spend / totalSpend) * 100) : 0,
        contracts: d.count, agencies: d.agencies.size,
        expiring: d.expiring, avgDeal: d.count > 0 ? d.spend / d.count : 0,
        isChannel: SalesPlanManager.isChannel(name)
      }))
      .sort((a, b) => b.spend - a.spend);
  },

  buildAgencyIntel(data) {
    const agencyMap = {};
    data.forEach(r => {
      const ag = r['Awarding Agency'] || 'Unknown';
      const sub = r['Awarding Sub Agency'] || 'Unknown';
      if (!agencyMap[ag]) agencyMap[ag] = { spend: 0, count: 0, subs: {}, vendors: {} };
      
      const amt = parseFloat(r['Award Amount']) || 0;
      agencyMap[ag].spend += amt;
      agencyMap[ag].count++;
      
      if (!agencyMap[ag].subs[sub]) agencyMap[ag].subs[sub] = 0;
      agencyMap[ag].subs[sub] += amt;
      
      const v = r['Recipient Name'] || 'Unknown';
      if (!agencyMap[ag].vendors[v]) agencyMap[ag].vendors[v] = 0;
      agencyMap[ag].vendors[v] += amt;
    });
    
    const totalSpend = Object.values(agencyMap).reduce((s, a) => s + a.spend, 0);
    
    return Object.entries(agencyMap)
      .map(([name, d]) => {
        const topVendors = Object.entries(d.vendors).sort((a, b) => b[1] - a[1]).slice(0, 3).map(([v, s]) => ({ name: v, spend: s }));
        const topSubs = Object.entries(d.subs).sort((a, b) => b[1] - a[1]).slice(0, 3).map(([s, amt]) => ({ name: s, spend: amt }));
          
        return {
          name, spend: d.spend,
          share: totalSpend > 0 ? ((d.spend / totalSpend) * 100) : 0,
          contracts: d.count, topVendors, topSubs,
          incumbent: topVendors[0]?.name || 'Unknown'
        };
      })
      .sort((a, b) => b.spend - a.spend);
  },

  generatePrompt(extracted, config) {
    const mf = v => Utils.money(v);
    const pct = v => (v && !isNaN(v)) ? v.toFixed(1) + '%' : '0.0%';
    const query = extracted.query.toUpperCase();
    const fyShorthand = `FY${String(Utils.getCurrentFY()).slice(-2)}`;
    const fyFull = Utils.getCurrentFY();

    const competitors = extracted.vendors.filter(v => !v.isChannel);
    const channels = extracted.vendors.filter(v => v.isChannel);
    const agencies = extracted.agencies.slice(0, 6);
    const metrics = extracted.metrics;
    
    // SAFE ACCESS to analysis (Fallback to defaults if null)
    const analysis = extracted.analysis || {};
    const recompeteVal = metrics.expiringValue; 

    return `
<SYSTEM_INSTRUCTIONS_INTERNAL>
- ROLE: Senior Federal Sales Director at a Tier-1 CSP/Defense Prime.
- DATA INTEGRITY: Use ONLY the provided data below. 
- CLOSED UNIVERSE: Do not hallucinate outside companies, placeholder vendors, or market stats.
- START RESPONSE IMMEDIATELY with the # Title. Do not include meta-commentary.
</SYSTEM_INSTRUCTIONS_INTERNAL>

# Federal Go-To-Market Plan: ${query}

**Scope**: Fiscal Year ${fyFull} (${fyShorthand}). Target agencies include ${agencies.map(a => a.name).join(', ')}.

---

## EXECUTIVE SUMMARY
One high-density paragraph stating the ${fyShorthand} target revenue range (calculated as a percentage of the total ${mf(recompeteVal)} recompete signal), primary competitive risk, and agency focus.

## MARKET DYNAMICS & FRICTION
Four sentences explaining how revenue is won in the ${query} market and the specific role of incumbency.

## COMPETITIVE LANDSCAPE (NON-CHANNEL VENDORS)
Output the following table for these identified competitors ONLY. 
${competitors.length === 0 ? "> No non-channel competitors identified in dataset." : `
| Vendor | Spend | Share | Contracts | Agencies | Recompete Exposure |
|---|---:|---:|---:|---:|---:|
${competitors.slice(0,6).map(c =>
`| ${c.name} | ${mf(c.spend)} | ${pct(c.share)} | ${c.contracts} | ${c.agencies} | ${mf(c.expiring)} |`
).join('\n')}`}

* Identify specific vulnerabilities for the top 3 incumbents above (e.g., single-agency concentration or high recompete volume).
* Identify which incumbents act as "gatekeepers" to key programs.

## CHANNEL PARTNER LANDSCAPE (IDENTIFIED PARTNERS)
Output the following table for these identified friendly channel partners ONLY. 
${channels.length === 0 ? "> (No channel partners marked. Identify resellers in the Sales Plan modal to populate this section.)" : `
| Partner Vendor | Partner Spend | Share | Contracts | Agencies | Current Exposure |
|---|---:|---:|---:|---:|---:|
${channels.slice(0,6).map(c =>
`| ${c.name} | ${mf(c.spend)} | ${pct(c.share)} | ${c.contracts} | ${c.agencies} | ${mf(c.expiring)} |`
).join('\n')}`}

* Detail where these specific partners provide "speed to contract" via established vehicles.

## PARTNER-TO-INCUMBENT ATTACK MAP
Identify the most logical path to displace incumbents using identified partners.

| Target Incumbent | Vulnerability | Recommended Partner Path | Strategic Rationale |
|---|---|---|---|
${competitors.slice(0,3).map((comp, index) => {
    const partner = channels.length > 0 ? channels[index % channels.length].name : 'DIRECT-LED';
    return `| ${comp.name} | ${mf(comp.expiring)} Recompete | ${partner} | Target displacement via ${partner}'s agency footprint |`;
}).join('\n')}

## ACCOUNT PRIORITIZATION
| Account / Component | Priority | Decision |
|---|---|---|
${agencies.map(a =>
`| ${a.name} - ${a.topSubs[0]?.name || 'Primary Component'} | TBD | TBD |`
).join('\n')}

## STRATEGIC DECISIONS (PRIMARY ACCOUNTS ONLY)
Focus on target outcome, deal shape, and specific partner access path.

## PIPELINE AND TARGETS
Revenue range and required deal count logic based on the ${mf(metrics.medianDealSize)} median deal size.

## GO-TO-MARKET MOTION
State clearly if execution is Partner-Led (using partners identified above) or Direct-Led.

## RESOURCE PLAN
List requirements for Sponsorship, Sales, Technical coverage, and Legal.

## RISKS AND MITIGATION
Markdown table covering lock, dependency, vehicles, and timing.

## NEXT 30 DAYS: EXECUTION SPRINT
Markdown table with verifiable milestones and a Kill/No-Go decision point.

## APPENDIX: EXECUTION PRECONDITIONS
Succinctly state required leadership support and the alternative if withheld.`;
  },
  
  buildPackage(data, analysis, config = {}) {
    const metrics = this.calculateMetrics(data, analysis);
    const vendors = this.buildVendorIntel(data);
    const agencies = this.buildAgencyIntel(data);
    
    return this.generatePrompt({
      query: App.currentQuery,
      metrics,
      vendors,
      agencies,
      analysis // Pass this through even if null
    }, config);
  },

  downloadPackage(promptText) {
    const blob = new Blob([promptText], { type: 'text/plain;charset=utf-8' });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    const fy = Utils.getCurrentFY();
    link.download = `Territory_Plan_FY${fy}_${App.currentQuery.replace(/\s+/g, '_')}.txt`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }
};

// ==================== PIPELINE BUILDER ====================
const PipelineBuilder = {
  generatedPipeline: [],
  historicalData: null,
  
  init() {
    // Populate target FY dropdown
    const fySelect = document.getElementById('pipelineTargetFY');
    if (fySelect) {
      const currentFY = Utils.getCurrentFY();
      fySelect.innerHTML = `
        <option value="${currentFY}">FY${currentFY} (Current)</option>
        <option value="${currentFY + 1}" selected>FY${currentFY + 1} (Next)</option>
      `;
    }
  },
  
  open() {
    const modal = document.getElementById('pipelineBuilderModal');
    if (!modal) return;
    
    this.init();
    this.populateAgencyDropdown();
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';
    
    // Reset state
    document.getElementById('pipelineResultsArea').style.display = 'none';
    document.getElementById('pipelineLoading').style.display = 'none';
    document.getElementById('btnDownloadPipeline').disabled = true;
    document.getElementById('pipelineDataStatus').textContent = 'Configure options and click Generate to build your pipeline.';
  },
  
  close() {
    const modal = document.getElementById('pipelineBuilderModal');
    if (modal) {
      modal.classList.remove('active');
      document.body.style.overflow = '';
    }
  },
  
  populateAgencyDropdown() {
    const select = document.getElementById('pipelineFocusAgency');
    if (!select) return;
    
    // Get agencies from current data
    const awards = App.forecastData.awards || App.searchData.raw || [];
    const agencies = [...new Set(awards.map(a => a['Awarding Agency']).filter(Boolean))].sort();
    
    select.innerHTML = '<option value="">All Agencies in Results</option>' +
      agencies.map(a => `<option value="${a}">${Utils.trunc(a, 50)}</option>`).join('');
  },
  
  async generate() {
    const targetFY = parseInt(document.getElementById('pipelineTargetFY').value);
    const historyYears = parseInt(document.getElementById('pipelineHistoryYears').value);
    const probMultiplier = parseFloat(document.getElementById('pipelineProbMultiplier').value);
    const minDeal = parseFloat(document.getElementById('pipelineMinDeal').value);
    const focusAgency = document.getElementById('pipelineFocusAgency').value;
    
    // Show loading
    document.getElementById('pipelineLoading').style.display = 'flex';
    document.getElementById('pipelineResultsArea').style.display = 'none';
    document.getElementById('pipelineDataStatus').textContent = 'Fetching historical spending data...';
    
    try {
      // Fetch multi-year historical data from USAspending API
      const historicalData = await this.fetchHistoricalData(historyYears);
      
      if (!historicalData || historicalData.length === 0) {
        throw new Error('No historical data found for this search.');
      }
      
      this.historicalData = historicalData;
      
      // Analyze cyclic patterns and generate pipeline
      document.getElementById('pipelineDataStatus').textContent = 'Analyzing spending patterns...';
      
      const pipeline = this.buildPipelineFromHistory(historicalData, {
        targetFY,
        historyYears,
        probMultiplier,
        minDeal,
        focusAgency
      });
      
      this.generatedPipeline = pipeline;
      
      // Display results
      this.renderResults(pipeline, targetFY);
      
      document.getElementById('pipelineLoading').style.display = 'none';
      document.getElementById('pipelineResultsArea').style.display = 'block';
      document.getElementById('btnDownloadPipeline').disabled = pipeline.length === 0;
      document.getElementById('pipelineDataStatus').textContent = 
        `Generated ${pipeline.length} opportunities totaling ${Utils.money(pipeline.reduce((s,o) => s + o.Amount, 0))}`;
      
    } catch (error) {
      console.error('Pipeline generation error:', error);
      document.getElementById('pipelineLoading').style.display = 'none';
      document.getElementById('pipelineDataStatus').textContent = `Error: ${error.message}`;
    }
  },
  
  async fetchHistoricalData(yearsBack) {
    const query = App.currentQuery;
    if (!query) throw new Error('No search query found. Please run a search first.');
    
    const currentFY = Utils.getCurrentFY();
    const allAwards = [];
    
    // Fetch data year by year to get comprehensive history
    for (let i = 0; i < yearsBack; i++) {
      const fy = currentFY - i;
      const startDate = `${fy - 1}-10-01`;
      const endDate = `${fy}-09-30`;
      
      const filters = Utils.buildFilters(query, [{start_date: startDate, end_date: endDate}]);
      
      try {
        const res = await fetch(`${API.baseUrl}/search/spending_by_award/`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            filters,
            fields: [
              'Award ID', 'Recipient Name', 'Description', 'Start Date', 'End Date',
              'Award Amount', 'Awarding Agency', 'Awarding Sub Agency',
              'NAICS Code', 'NAICS Description', 'PSC Code', 'PSC Description', 'generated_internal_id'
            ],
            limit: 100,
            sort: 'Award Amount',
            order: 'desc'
          })
        });
        
        const data = await res.json();
        if (data.results && data.results.length > 0) {
          // Tag each award with its fiscal year
          data.results.forEach(award => {
            award._fiscalYear = fy;
            award._quarter = this.getQuarterFromDate(award['Start Date']);
          });
          allAwards.push(...data.results);
        }
      } catch (e) {
        console.warn(`Failed to fetch FY${fy} data:`, e);
      }
    }
    
    return allAwards;
  },
  
  getQuarterFromDate(dateStr) {
    if (!dateStr) return 1;
    const date = new Date(dateStr);
    const month = date.getMonth(); // 0-11
    // Federal fiscal year quarters: Q1=Oct-Dec, Q2=Jan-Mar, Q3=Apr-Jun, Q4=Jul-Sep
    if (month >= 9) return 1; // Oct-Dec
    if (month <= 2) return 2; // Jan-Mar
    if (month <= 5) return 3; // Apr-Jun
    return 4; // Jul-Sep
  },
  
  getFYQuarterDates(fy, quarter) {
    const quarterMonths = {
      1: { start: `${fy-1}-10-01`, end: `${fy-1}-12-31` },
      2: { start: `${fy}-01-01`, end: `${fy}-03-31` },
      3: { start: `${fy}-04-01`, end: `${fy}-06-30` },
      4: { start: `${fy}-07-01`, end: `${fy}-09-30` }
    };
    return quarterMonths[quarter];
  },
  
  buildPipelineFromHistory(historicalData, options) {
    const { targetFY, historyYears, probMultiplier, minDeal, focusAgency } = options;
    const pipeline = [];
    
    // Filter by agency if specified
    let filteredData = historicalData;
    if (focusAgency) {
      filteredData = historicalData.filter(a => a['Awarding Agency'] === focusAgency);
    }
    
    // Filter by minimum deal size
    if (minDeal > 0) {
      filteredData = filteredData.filter(a => (a['Award Amount'] || 0) >= minDeal);
    }
    
    // Group historical awards by agency + quarter pattern
    const patterns = {};
    
    filteredData.forEach(award => {
      const agency = award['Awarding Agency'] || 'Unknown';
      const subAgency = award['Awarding Sub Agency'] || '';
      const quarter = award._quarter || 1;
      const naicsCode = award['NAICS Code'] || '';
      const pscCode = award['PSC Code'] || '';
      
      // Create a pattern key based on agency + quarter + optional category
      const patternKey = `${agency}|Q${quarter}|${naicsCode || pscCode}`;
      
      if (!patterns[patternKey]) {
        patterns[patternKey] = {
          agency,
          subAgency,
          quarter,
          naicsCode,
          pscCode,
          naicsDesc: award['NAICS Description'] || '',
          pscDesc: award['PSC Description'] || '',
          historicalAmounts: [],
          historicalYears: [],
          descriptions: [],
          vendors: []
        };
      }
      
      patterns[patternKey].historicalAmounts.push(award['Award Amount'] || 0);
      patterns[patternKey].historicalYears.push(award._fiscalYear);
      if (award['Description']) patterns[patternKey].descriptions.push(award['Description']);
      if (award['Recipient Name']) patterns[patternKey].vendors.push(award['Recipient Name']);
    });
    
    // Generate opportunities from patterns
    let oppId = 1;
    Object.values(patterns).forEach(pattern => {
      // Skip patterns with insufficient history
      if (pattern.historicalAmounts.length < 1) return;
      
      // Calculate projected amount based on historical average
      const avgAmount = pattern.historicalAmounts.reduce((a, b) => a + b, 0) / pattern.historicalAmounts.length;
      const projectedAmount = avgAmount * probMultiplier;
      
      // Skip if below threshold
      if (projectedAmount < minDeal) return;
      
      // Determine probability based on recurrence
      const uniqueYears = [...new Set(pattern.historicalYears)];
      const recurrenceRate = uniqueYears.length / historyYears;
      const baseProbability = Math.min(recurrenceRate * 100, 100);
      
      // Get quarter dates for target FY
      const quarterDates = this.getFYQuarterDates(targetFY, pattern.quarter);
      
      // Get most common description
      const descCounts = {};
      pattern.descriptions.forEach(d => {
        const key = d.substring(0, 100);
        descCounts[key] = (descCounts[key] || 0) + 1;
      });
      const topDesc = Object.entries(descCounts).sort((a, b) => b[1] - a[1])[0];
      
      // Get most common vendor (incumbent)
      const vendorCounts = {};
      pattern.vendors.forEach(v => { vendorCounts[v] = (vendorCounts[v] || 0) + 1; });
      const incumbent = Object.entries(vendorCounts).sort((a, b) => b[1] - a[1])[0];
      
      // Determine stage based on timing
      const currentQuarter = Utils.getCurrentQuarter();
      const currentFY = Utils.getCurrentFY();
      let stage = 'Prospecting';
      if (targetFY === currentFY) {
        if (pattern.quarter <= currentQuarter) stage = 'Qualification';
        else if (pattern.quarter === currentQuarter + 1) stage = 'Qualification';
      } else if (targetFY === currentFY + 1 && pattern.quarter === 1) {
        stage = 'Qualification';
      }
      
      pipeline.push({
        // Salesforce Standard Fields
        OpportunityName: `${pattern.agency.split(' ').slice(0, 3).join(' ')} - ${pattern.pscDesc || pattern.naicsDesc || App.currentQuery} - FY${targetFY}Q${pattern.quarter}`,
        AccountName: pattern.agency,
        Amount: Math.round(projectedAmount),
        CloseDate: quarterDates.end,
        StageName: stage,
        Probability: Math.round(baseProbability * probMultiplier),
        Type: 'New Business',
        LeadSource: 'USAspending Historical Analysis',
        Description: topDesc ? topDesc[0] : `Projected opportunity based on ${uniqueYears.length} year(s) of historical spending in Q${pattern.quarter}`,
        NextStep: stage === 'Prospecting' ? 'Research incumbent and identify stakeholders' : 'Qualify opportunity and engage customer',
        
        // Custom/Extended Fields
        FiscalYear: `FY${targetFY}`,
        FiscalQuarter: `Q${pattern.quarter}`,
        SubAgency: pattern.subAgency,
        NAICSCode: pattern.naicsCode,
        NAICSDescription: pattern.naicsDesc,
        PSCCode: pattern.pscCode,
        PSCDescription: pattern.pscDesc,
        Incumbent: incumbent ? incumbent[0] : '',
        HistoricalAverage: Math.round(avgAmount),
        HistoricalYearsObserved: uniqueYears.join(', '),
        RecurrenceRate: `${Math.round(recurrenceRate * 100)}%`,
        DataSource: 'USAspending.gov',
        GeneratedDate: new Date().toISOString().split('T')[0],
        SearchKeyword: App.currentQuery
      });
      
      oppId++;
    });
    
    // Sort by close date, then amount
    pipeline.sort((a, b) => {
      const dateCompare = new Date(a.CloseDate) - new Date(b.CloseDate);
      if (dateCompare !== 0) return dateCompare;
      return b.Amount - a.Amount;
    });
    
    return pipeline;
  },
  
  renderResults(pipeline, targetFY) {
    // Stats
    const totalValue = pipeline.reduce((s, o) => s + o.Amount, 0);
    const avgDeal = pipeline.length > 0 ? totalValue / pipeline.length : 0;
    const quarterCounts = { Q1: 0, Q2: 0, Q3: 0, Q4: 0 };
    pipeline.forEach(o => {
      const q = o.FiscalQuarter;
      if (quarterCounts[q] !== undefined) quarterCounts[q]++;
    });
    const peakQuarter = Object.entries(quarterCounts).sort((a, b) => b[1] - a[1])[0];
    
    document.getElementById('pipelineStatsGrid').innerHTML = `
      <div class="pipeline-stat">
        <div class="pipeline-stat-label">Total Pipeline Value</div>
        <div class="pipeline-stat-value">${Utils.money(totalValue)}</div>
        <div class="pipeline-stat-sub">FY${targetFY} Projected</div>
      </div>
      <div class="pipeline-stat">
        <div class="pipeline-stat-label">Opportunities</div>
        <div class="pipeline-stat-value">${pipeline.length}</div>
        <div class="pipeline-stat-sub">Based on History</div>
      </div>
      <div class="pipeline-stat">
        <div class="pipeline-stat-label">Average Deal</div>
        <div class="pipeline-stat-value">${Utils.money(avgDeal)}</div>
        <div class="pipeline-stat-sub">Projected Size</div>
      </div>
      <div class="pipeline-stat">
        <div class="pipeline-stat-label">Peak Quarter</div>
        <div class="pipeline-stat-value">${peakQuarter ? peakQuarter[0] : '-'}</div>
        <div class="pipeline-stat-sub">${peakQuarter ? peakQuarter[1] + ' opportunities' : ''}</div>
      </div>
    `;
    
    document.getElementById('pipelineResultCount').textContent = `${pipeline.length} opportunities generated`;
    
    // Table
    if (pipeline.length === 0) {
      document.getElementById('pipelineTableContainer').innerHTML = `
        <div style="text-align:center; padding:2rem; color:var(--text-muted);">
          <i class="fas fa-search" style="font-size:2rem; margin-bottom:1rem; opacity:0.5;"></i>
          <p>No opportunities generated. Try adjusting the minimum deal size or historical years.</p>
        </div>
      `;
      return;
    }
    
    document.getElementById('pipelineTableContainer').innerHTML = `
      <table class="pipeline-table">
        <thead>
          <tr>
            <th>Opportunity Name</th>
            <th>Account</th>
            <th>Amount</th>
            <th>Close Date</th>
            <th>Quarter</th>
            <th>Stage</th>
            <th>Prob</th>
            <th>Incumbent</th>
          </tr>
        </thead>
        <tbody>
          ${pipeline.map(opp => `
            <tr>
              <td title="${opp.OpportunityName}">${Utils.trunc(opp.OpportunityName, 45)}</td>
              <td class="agency" title="${opp.AccountName}">${Utils.trunc(opp.AccountName, 30)}</td>
              <td class="amount">${Utils.money(opp.Amount)}</td>
              <td class="date">${opp.CloseDate}</td>
              <td><span class="pipeline-quarter-badge">${opp.FiscalQuarter}</span></td>
              <td><span class="stage ${opp.StageName.toLowerCase()}">${opp.StageName}</span></td>
              <td>${opp.Probability}%</td>
              <td title="${opp.Incumbent}">${Utils.trunc(opp.Incumbent || '-', 20)}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    `;
  },
  
  downloadCSV() {
    if (this.generatedPipeline.length === 0) {
      alert('No pipeline data to download. Please generate a pipeline first.');
      return;
    }
    
    // Salesforce-compatible CSV headers
    const headers = [
      'Opportunity Name',
      'Account Name',
      'Amount',
      'Close Date',
      'Stage',
      'Probability (%)',
      'Type',
      'Lead Source',
      'Description',
      'Next Step',
      'Fiscal Year',
      'Fiscal Quarter',
      'Sub-Agency',
      'NAICS Code',
      'NAICS Description',
      'PSC Code',
      'PSC Description',
      'Incumbent',
      'Historical Average',
      'Historical Years Observed',
      'Recurrence Rate',
      'Data Source',
      'Generated Date',
      'Search Keyword'
    ];
    
    const rows = this.generatedPipeline.map(opp => [
      opp.OpportunityName,
      opp.AccountName,
      opp.Amount,
      opp.CloseDate,
      opp.StageName,
      opp.Probability,
      opp.Type,
      opp.LeadSource,
      opp.Description,
      opp.NextStep,
      opp.FiscalYear,
      opp.FiscalQuarter,
      opp.SubAgency,
      opp.NAICSCode,
      opp.NAICSDescription,
      opp.PSCCode,
      opp.PSCDescription,
      opp.Incumbent,
      opp.HistoricalAverage,
      opp.HistoricalYearsObserved,
      opp.RecurrenceRate,
      opp.DataSource,
      opp.GeneratedDate,
      opp.SearchKeyword
    ]);
    
    // Escape CSV values
    const escapeCSV = (val) => {
      if (val === null || val === undefined) return '';
      const str = String(val);
      if (str.includes(',') || str.includes('"') || str.includes('\n')) {
        return `"${str.replace(/"/g, '""')}"`;
      }
      return str;
    };
    
    const csvContent = [
      headers.map(escapeCSV).join(','),
      ...rows.map(row => row.map(escapeCSV).join(','))
    ].join('\n');
    
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    const targetFY = document.getElementById('pipelineTargetFY').value;
    link.download = `Pipeline_FY${targetFY}_${App.currentQuery.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    document.getElementById('pipelineDataStatus').textContent = 'CSV downloaded successfully! Ready for Salesforce import.';
  }
};

App.init();

// Initialize Autocomplete on search inputs
Autocomplete.init('mainSearchInput');
Autocomplete.init('miniSearch');
</script>
</body>
</html>