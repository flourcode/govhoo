<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#000000">
  <meta name="color-scheme" content="dark">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 rx=%2220%22 fill=%22%23000000%22/><text y=%2250%%22 x=%2250%%22 font-size=%2265%22 font-family=%22'JetBrains Mono', monospace%22 font-weight=%22700%22 fill=%22%23426a5a%22 text-anchor=%22middle%22 dominant-baseline=%22central%22>>_</text></svg>">
  <title>Govhoo - Federal Contract Intelligence & Sales Planning</title>
  <meta name="title" content="Govhoo - Federal Contract Intelligence & Sales Planning">
  <meta name="description" content="Free Federal Sales Intelligence Strategic Planning. Follow the money with live USASpending data analysis.">
  <meta name="keywords" content="federal sales, usaspending search, government contracts, defense contracts, federal jobs, expiring contracts, federal territory planning, incumbent search">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://govhoo.com/">
  <meta property="og:title" content="Govhoo | Follow the Money">
  <meta property="og:description" content="Analyze federal agency award flow and generate AI-ready sales plans.">
  <meta property="og:image" content="https://govhoo.com/social.png">
  <meta property="twitter:card" content="summary_large_image">
  <meta property="twitter:title" content="Govhoo | Federal Contract Intelligence">
  <meta property="twitter:description" content="Build your federal sales plan with live obligation data and trend forecasting.">
  <link rel="canonical" href="https://govhoo.com/">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://kit.fontawesome.com/8ef6ca8a5d.js" crossorigin="anonymous"></script>
  <link rel="preconnect" href="https://api.usaspending.gov">
  <link rel="dns-prefetch" href="https://api.usaspending.gov">
  <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js" as="script">
  <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/d3-sankey/0.12.3/d3-sankey.min.js" as="script">
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-T343V4RFHV"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-T343V4RFHV');
  </script>
<style>
:root {
  /* SURFACES - Warm, Deep Charcoal (Less "Electronic", more "Ink") */
  --bg-app: #0E1111;      /* Deepest Black-Green */
  --bg-card: #161B18;     /* Soft Charcoal */
  --bg-input: #1A211E;
  --bg-elevated: #232D29;

  /* TEXT - Softened contrast to reduce eye strain */
  --text-primary: #E8E6E1; /* Parchment White (Not harsh #FFF) */
  --text-muted: #8F9E98;   /* Faded Slate */
  --text-subtle: #5A6660;  /* Deep Graphite */
  --link: #7DAF9C;         /* Muted Teal link color */

  /* ACCENT - "Antique Fern" */
  --accent: #4A7A67;       
  --accent-dark: #365C4C;
  --accent-light: #7DAF9C; 
  --accent-dim: rgba(74, 122, 103, 0.15);

  /* FUNCTIONAL CHALK COLORS - The key to "Relaxing" */
  /* These replace standard neon colors with "pastel" versions */
  --success: #78A890; /* Sage instead of Green */
  --warning: #D1Bfa7; /* Sand instead of Yellow */
  --danger: #B87E7E;  /* Faded Rose instead of Red */
  --info: #7E9CB8;    /* Steel Blue instead of Blue */

  /* BORDERS */
  --border: rgba(143, 158, 152, 0.15);
  --border-hover: rgba(143, 158, 152, 0.3);
  
  /* SIZING */
  --safe-top: env(safe-area-inset-top, 20px);
  --safe-bottom: env(safe-area-inset-bottom, 20px);
}
/* =========================================
   2. GLOBAL RESET & SCROLLBAR
   ========================================= */
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

body {
  margin: 0; padding: 0;
  font-family: 'JetBrains Mono', monospace;
  background: var(--bg-app);
  color: var(--text-primary);
  min-height: 100vh;
  overflow-x: hidden;
  width: 100%;
}

/* Custom Scrollbar - Muted Slate Thumb */
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: var(--bg-app); }
::-webkit-scrollbar-thumb { 
  background: rgba(251, 247, 245, 0.15); 
  border-radius: 10px; 
}
::-webkit-scrollbar-thumb:hover { background: var(--accent); }

/* =========================================
   3. GLOBAL UTILITIES & ANIMATIONS
   ========================================= */
.view-section { display: none; }
.view-section.active { display: block; animation: fadeIn 0.5s ease; }

.loader {
  position: fixed; inset: 0; z-index: 300;
  background: rgba(14, 18, 17, 0.95);
  display: none; flex-direction: column; align-items: center; justify-content: center;
}

.spinner {
  width: 40px; height: 40px;
  border: 2px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}

@keyframes spin { to { transform: rotate(360deg); } }
@keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
@keyframes panelSlideUp { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
@keyframes subtlePulse { 
  0%, 100% { box-shadow: 0 0 0 0 rgba(66, 106, 90, 0); }
  50% { box-shadow: 0 0 0 4px rgba(66, 106, 90, 0.08); }
}

/* Stagger Animations for Intelligence Panels */
.intel-stagger-1 { animation: panelSlideUp 0.4s ease-out 0.1s both; }
.intel-stagger-2 { animation: panelSlideUp 0.4s ease-out 0.2s both; }
.intel-stagger-3 { animation: panelSlideUp 0.4s ease-out 0.3s both; }
.intel-stagger-4 { animation: panelSlideUp 0.4s ease-out 0.4s both; }

/* Text Truncation Helpers */
.buyer-name, .vendor-name, .geo-state-name {
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 180px;
}

/* =========================================
   4. INPUTS & BUTTONS (UNIFIED SYSTEM)
   ========================================= */
.main-input, .mini-search, .modal-select, select, textarea {
  width: 100%;
  background: var(--bg-input) !important;
  border: 1px solid var(--border) !important;
  color: #F1EEE9 !important;
  padding: 1.25rem 1rem;
  font-size: 1.1rem;
  border-radius: 4px;
  font-family: 'JetBrains Mono', monospace;
  transition: border-color 0.2s;
  -webkit-appearance: none;
}

.main-input:focus, .mini-search:focus {
  outline: none; 
  border-color: var(--accent) !important; 
  background: #222; 
}

.btn-row { display: flex; gap: 0.75rem; margin-top: 1rem; }

/* PRIMARY ACTIONS (Solid Fern) */
.btn-primary, .modal-btn-primary, .pipeline-builder-btn, 
.convo-starters-btn, #searchBtn {
  flex: 1;
  padding: 1rem;
  font-weight: 700;
  border: 1px solid var(--accent) !important;
  background: var(--accent) !important;
  color: #F1EEE9 !important;
  border-radius: 4px;
  font-size: 0.9rem;
  cursor: pointer;
  text-transform: uppercase;
  letter-spacing: 1px;
  display: flex; align-items: center; justify-content: center; gap: 0.5rem;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2) !important;
  transition: all 0.2s ease;
  font-family: 'JetBrains Mono', monospace;
}

.btn-primary:hover, .pipeline-builder-btn:hover, .convo-starters-btn:hover, #searchBtn:hover {
  background: var(--accent-dark) !important;
  border-color: var(--accent-dark) !important;
  transform: translateY(-1px);
  opacity: 1;
}

/* SECONDARY ACTIONS (Transparent Chalk Outline) */
.btn-secondary, .modal-btn-cancel {
  flex: 1;
  padding: 1rem;
  font-weight: 700;
  border: 1px solid rgba(251, 247, 245, 0.3) !important;
  background: transparent !important;
  color: var(--text-primary) !important;
  border-radius: 4px;
  font-size: 0.9rem;
  cursor: pointer;
  text-transform: uppercase;
  letter-spacing: 1px;
  display: flex; align-items: center; justify-content: center; gap: 0.5rem;
  transition: all 0.2s ease;
  opacity: 0.9;
}

.btn-secondary:hover, #convoStartersBtn:hover, #gtmPlanBtn:hover, #pipelineBtn:hover {
  background: rgba(251, 247, 245, 0.08) !important;
  border-color: var(--text-primary) !important;
  color: #F1EEE9 !important;
  opacity: 1;
}

.action-btn {
  background: var(--bg-input); color: var(--accent);
  text-decoration: none; padding: 0.5rem 1rem;
  border-radius: 4px; font-size: 0.8rem; font-weight: 600;
  border: 1px solid var(--border); display: flex; align-items: center; gap: 6px;
}
.action-btn:hover { border-color: var(--accent); background: var(--accent-dim); }

.input-clear {
  position: absolute; 
  right: 12px; 
  top: 50%; 
  transform: translateY(-50%); /* This pulls it up to the true center */
  background: none; 
  border: none; 
  color: var(--text-muted);
  font-size: 1.25rem; 
  cursor: pointer; 
  display: none; 
  padding: 4px 8px; 
  z-index: 215;
  line-height: 1; /* Keeps the character itself from shifting */
  display: flex;
  align-items: center;
  justify-content: center;
}

.input-clear:hover { 
  color: var(--accent) !important;
  opacity: 1;
  transform: translateY(-50%) scale(1.1); /* Keeps it centered while giving a tiny 'pop' */
  transition: all 0.15s ease;
}
.input-clear.visible { 
  display: flex; /* Changed from block to flex to support centering */
}

/* =========================================
   5. HERO VIEW
   ========================================= */
.hero-view {
  position: fixed; inset: 0; z-index: 200;
  display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
  padding: 2rem; padding-top: max(8vh, var(--safe-top));
  transition: transform 0.5s cubic-bezier(0.16, 1, 0.3, 1);
  overflow-y: auto;
}
.hero-view.slide-up { transform: translateY(-100%); }
.hero-view.hidden { display: none; }

.terminal-logo {
  font-family: 'JetBrains Mono', monospace;
  font-size: 2.5rem; font-weight: 700; margin-bottom: 0.5rem;
  color: #F1EEE9; letter-spacing: -1px; text-align: center;
}
.terminal-logo span { color: var(--accent-light); }

.hero-subtitle {
  margin-bottom: 2rem; text-align: center;
  font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; color: var(--text-muted);
}
.search-box-container { position: relative; z-index: 210; width: 100%; max-width: 500px; margin-top: 1.5rem; }

/* =========================================
   6. AUTOCOMPLETE
   ========================================= */
.autocomplete-wrapper { position: relative; }
.autocomplete-dropdown {
  position: absolute; top: 100%; left: 0; right: 0; z-index: 220;
  background: var(--bg-card); border: 1px solid var(--border);
  border-top: none; border-radius: 0 0 4px 4px;
  max-height: 320px; overflow-y: auto; display: none;
}
.autocomplete-dropdown.active { display: block; }
.autocomplete-section { padding: 0.5rem 0; border-bottom: 1px solid var(--border); }
.autocomplete-section:last-child { border-bottom: none; }
.autocomplete-section-label {
  padding: 0.25rem 1rem; font-size: 0.65rem; color: var(--text-muted);
  text-transform: uppercase; letter-spacing: 1px; font-family: 'JetBrains Mono', monospace;
}
.autocomplete-item {
  padding: 0.6rem 1rem; cursor: pointer; display: flex; align-items: center; gap: 0.75rem;
  font-size: 0.9rem; color: var(--text-primary); transition: background 0.1s;
}
.autocomplete-item:hover, .autocomplete-item.selected { background: rgba(255, 255, 255, 0.05); }
.autocomplete-item i { color: var(--text-muted); width: 16px; text-align: center; font-size: 0.8rem; }
.autocomplete-item-text { flex: 1; min-width: 0; }
.autocomplete-item-main { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.autocomplete-item-sub { font-size: 0.7rem; color: var(--text-muted); margin-top: 2px; }
.autocomplete-empty { padding: 1rem; text-align: center; color: var(--text-muted); font-size: 0.85rem; }

/* =========================================
   7. APP HEADER
   ========================================= */
.app-header {
  position: sticky; top: 0; z-index: 100;
  background: rgba(14, 18, 17, 0.95); backdrop-filter: blur(10px);
  padding: 0.75rem 1rem; padding-top: max(0.75rem, var(--safe-top));
  border-bottom: 1px solid var(--border);
  display: flex; justify-content: space-between; align-items: center; gap: 1rem; overflow: hidden;
}
.header-left { display: flex; align-items: center; gap: 1rem; flex: 1; min-width: 0; }
.logo-btn { font-family: 'JetBrains Mono'; font-weight: 700; color: #F1EEE9; cursor: pointer; flex-shrink: 0; }
.logo-btn:hover { color: var(--accent); }
.logo-btn span { color: var(--accent); }

.mini-search {
  background: var(--bg-input); border: 1px solid var(--border); color: #F1EEE9;
  padding: 0.5rem 1rem; border-radius: 4px; font-size: 0.9rem; flex: 1; min-width: 0; width: 100%;
}
.mini-search-wrapper { flex: 1; min-width: 0; overflow: hidden; }
.header-actions { display: flex; gap: 0.4rem; flex-shrink: 0; align-items: center; }
.header-controls { display: flex; gap: 0.75rem; align-items: center; }

/* Base icon button — same behavior, neutral ink */
.icon-btn {
 background: var(--accent);
  border: none;
  color: #F1EEE9;

  width: 34px;
  height: 34px;
  border-radius: 50%;

  display: flex;
  align-items: center;
  justify-content: center;

  cursor: pointer;
  font-size: 14px;
  font-family: 'JetBrains Mono', monospace;

  transition: opacity 0.15s ease, transform 0.15s ease;
}

/* EXACT original hover behavior */
.icon-btn:hover {
  opacity: 0.82;
  transform: scale(1.08);
  color: #F1EEE9;
}

.icon-btn.active {
  background: var(--accent-light);
  color: #F1EEE9;
}
/* Share – Faded Treasury Blue */
.icon-btn-share {
background: var(--accent);
}

/* Details / Slack – Dusty Archive Violet */
.icon-btn-slack {
 background: var(--accent);
}

/* CSV – Accounting Slate */
.icon-btn-csv {
 background: var(--accent);
}


/* =========================================
   8. DASHBOARD LAYOUT & HEADERS
   ========================================= */
.dashboard-container {
  padding: 1rem; padding-bottom: calc(2rem + var(--safe-bottom));
  max-width: 1400px; margin: 0 auto; display: none; width: 100%;
}
.dashboard-container.active { display: block; animation: fadeIn 0.8s forwards; }

.mode-toggle { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; background: var(--bg-card); padding: 0.5rem; border-radius: 4px; border: 1px solid var(--border); }
.mode-btn {
  flex: 1; padding: 0.75rem; background: transparent; border: none;
  color: var(--text-muted); font-family: 'JetBrains Mono'; font-size: 0.85rem;
  cursor: pointer; border-radius: 4px; transition: all 0.2s;
  display: flex; align-items: center; justify-content: center; gap: 0.5rem;
}
.mode-btn.active { background: #839E8E; color: #0a0e0d; font-weight: 700; }
.mode-btn:hover:not(.active) { color: var(--text-primary); }

/* Section Headers */
.section-header {
  display: flex; align-items: center; justify-content: space-between; gap: 0.5rem;
  margin: 2rem 0 1rem 0; border-bottom: 1px solid var(--border);
  padding-bottom: 0.5rem; flex-wrap: wrap;
}
.section-title-group { display: flex; align-items: center; gap: 0.5rem; }
.section-title {
  font-family: 'JetBrains Mono', monospace; font-size: 0.9rem; font-weight: 700 !important;
  color: #F1EEE9 !important; text-transform: uppercase; letter-spacing: 2px;
}
.section-subtitle { font-size: 0.75rem; color: var(--text-primary); opacity: 0.65; font-style: italic; }

/* Subway Route Bullets — MTA-inspired colored circles with FA icons inside */
.sub-bullet {
  display: inline-flex; align-items: center; justify-content: center;
  width: 34px; height: 34px; border-radius: 50%;
  background: var(--accent); color: #F1EEE9;
  font-size: 15px; flex-shrink: 0; line-height: 1;
}
.sub-bullet.sm { width: 34px; height: 34px; font-size: 15px; }
.sub-bullet.lg { width: 34px; height: 34px; font-size: 15px; }
.sub-bullet.xl { width: 34px; height: 34px; font-size: 15px; }
.sub-bullet i { line-height: 1; }

/* MTA Line Colors — unified accent green */
.sub-bullet.blue { background: var(--accent); }
.sub-bullet.orange { background: var(--accent); }
.sub-bullet.red { background: var(--accent); }
.sub-bullet.purple { background: var(--accent); }
.sub-bullet.yellow { background: var(--accent); color: #F1EEE9; }
.sub-bullet.gray { background: var(--accent); }
.sub-bullet.teal { background: var(--accent); }

/* Inverted — white circle */
.sub-bullet.inv { background: rgba(255,255,255,0.95); color: var(--accent); }
.sub-bullet.inv.blue { color: var(--accent); }
.sub-bullet.inv.orange { color: var(--accent); }
.sub-bullet.inv.purple { color: var(--accent); }

/* =========================================
   9. WIDGETS, CARDS & STATS
   ========================================= */
.stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem; }

.stat-item {
  background: var(--bg-card); padding: 1rem; border-radius: 4px;
  border: 1px solid var(--border) !important; text-align: center;
}
.stat-label { font-size: 0.7rem; color: var(--text-primary); opacity: 0.65; text-transform: uppercase; margin-bottom: 0.5rem; }
.stat-val, #stat-vol, #stat-agencies, #stat-count, #stat-vendors {
  font-size: 1.25rem; font-weight: 700 !important; font-family: 'JetBrains Mono';
  color: #F1EEE9 !important; text-shadow: 0 0 1px rgba(251, 247, 245, 0.2);
}
.stat-sub { font-size: 0.7rem; color: var(--success); margin-top: 4px; }
.stat-sub.neutral { color: var(--text-primary); opacity: 0.65; }
.stat-item-action:hover { background: var(--accent-dim); border-color: var(--accent) !important; }

/* Charts */
.chart-wrapper {
  background: var(--bg-card); border: 1px solid var(--border) !important;
  border-radius: 4px; padding: 1rem; width: 100%; overflow-x: auto; overflow-y: visible;
}
.chart-container { width: 100%; min-height: 500px; height: auto; display: block; }

/* Feed / Deal Cards */
.feed-grid { display: flex; flex-direction: column; gap: 1rem; }
.deal-card {
  background: var(--bg-card); border: 1px solid var(--border) !important;
  border-radius: 4px; padding: 1.25rem; transition: transform 0.1s;
}
.deal-card:active { transform: scale(0.99); }
#feedGrid .deal-card:nth-child(n+4) { opacity: 0.7; }
#feedGrid .deal-card:nth-child(n+4):hover { opacity: 1; }

.deal-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem; }
.deal-agency {
  font-size: 0.75rem; color: var(--text-muted); font-weight: 600;
  text-transform: uppercase; background: rgba(255, 255, 255, 0.05); padding: 2px 6px; border-radius: 4px;
}
.deal-amount {
  font-family: 'JetBrains Mono', monospace; color: #F1EEE9 !important;
  font-weight: 700; font-size: 1rem;
}
.deal-desc { font-size: 1rem; font-weight: 600; margin-bottom: 0.5rem; line-height: 1.4; color: white; }
.deal-vendor { font-size: 0.85rem; color: var(--info); margin-bottom: 0.75rem; font-family: 'JetBrains Mono', monospace; }
.deal-meta { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem; }
.deal-footer { display: flex; justify-content: space-between; align-items: center; padding-top: 1rem; border-top: 1px solid #222; }
.deal-date { font-size: 0.75rem; color: var(--text-primary); opacity: 0.65; }

/* Tags & Badges */
.meta-tag {
  font-size: 0.65rem; font-family: 'JetBrains Mono', monospace; padding: 3px 8px;
  border-radius: 3px; background: rgba(251, 247, 245, 0.05) !important;
  color: var(--text-muted) !important; border: 1px solid var(--border) !important;
}
.meta-tag.psc { background: rgba(143, 182, 208, 0.15); border-color: rgba(143, 182, 208, 0.3); color: #8FB6D0; }
.meta-tag.naics { background: rgba(180, 143, 208, 0.15); border-color: rgba(180, 143, 208, 0.3); color: #B48FD0; }
.meta-tag.mission-gap { font-weight: 600; }
.meta-tag.mission-gap.high { background: rgba(251, 128, 114, 0.15); border-color: var(--danger) !important; color: var(--danger) !important; }
.meta-tag.mission-gap.medium { background: rgba(253, 216, 53, 0.15); border-color: var(--warning) !important; color: var(--warning) !important; }
.meta-tag.mission-gap.low { background: rgba(255, 255, 255, 0.05); border-color: var(--border); color: var(--text-muted); }

.time-badge { font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; color: var(--text-muted); border: 1px solid var(--border); padding: 4px 8px; border-radius: 4px; }
.filter-badge {
  display: none; background: var(--accent-dim); color: var(--accent);
  border: 1px solid var(--accent); padding: 10px 14px; min-height: 44px;
  border-radius: 4px; font-size: 0.7rem; font-family: 'JetBrains Mono', monospace;
  cursor: pointer; align-items: center; gap: 6px;
}
.filter-badge:hover { background: rgba(212, 196, 168, 0.2); }

/* Mission Gap Controls */
.mission-gap-signals { font-size: 0.7rem; color: var(--text-muted); margin-top: 6px; font-style: italic; }
.mission-gap-filter { display: flex; align-items: center; gap: 0.5rem; }
.mission-gap-toggle {
  display: inline-flex; align-items: center; justify-content: center; gap: 0.4rem;
  padding: 0 12px; height: 34px; min-width: 34px;
  background: #A7A9AC !important; border: none !important; border-radius: 34px;
  font-size: 0.7rem; font-family: 'JetBrains Mono', monospace; color: #F1EEE9 !important;
  font-weight: 700; cursor: pointer; transition: opacity 0.15s, transform 0.15s;
  white-space: nowrap;
}
.mission-gap-toggle:hover { opacity: 0.82; transform: scale(1.04); color: #F1EEE9 !important; }
.mission-gap-toggle.active { background: #A7A9AC !important; color: #F1EEE9 !important; opacity: 1; }
.mission-gap-toggle i { font-size: 0.65rem; color: #F1EEE9 !important; }

/* Buyers List */
.buyer-list { display: flex; flex-direction: column; gap: 0; width: 100%; }
.buyer-item {
  display: flex; align-items: center; gap: 0.85rem; padding: 0.75rem 0;
  border-bottom: 1px solid rgba(255, 255, 255, 0.05); width: 100%;
}
.buyer-item:last-child { border-bottom: none; }
.buyer-rank {
  width: 34px; height: 34px; background: var(--accent) !important;
  color: #F1EEE9 !important; border-radius: 50%; display: flex; align-items: center;
  justify-content: center; font-family: 'JetBrains Mono', monospace;
  font-size: 15px !important; font-weight: 700; flex-shrink: 0; border: none !important;
}
.buyer-info { flex: 1; min-width: 0; }
.buyer-name { font-size: 0.95rem; color: var(--text-primary); font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.buyer-stats { font-size: 0.7rem; color: var(--text-muted); margin-top: 2px; }
.buyer-amount { text-align: right; flex-shrink: 0; }
.buyer-spend {
  font-family: 'JetBrains Mono', monospace; font-size: 1.15rem; font-weight: 700;
  color: #F1EEE9 !important; white-space: nowrap; line-height: 1.2;
}
.buyer-share { font-size: 0.7rem; color: var(--text-muted); }

/* Projection & Forecast Table */
.projection-summary {
  margin-top: 1rem; padding: 1.5rem; background: var(--paper-dim);
  border: 1px solid var(--accent); border-radius: 4px; position: relative; overflow: hidden;
}
.forecast-table-wrapper {
  background: var(--bg-card); border: 1px solid var(--border);
  overflow-x: auto; border-radius: 4px; width: 100%;
}
.forecast-table { width: 100%; border-collapse: collapse; font-family: 'JetBrains Mono'; font-size: 0.8rem; }
.forecast-table th {
  text-align: left; padding: 1rem; color: var(--accent-light);
  border-bottom: 2px solid var(--border);
}
.forecast-table td { padding: 1rem; border-bottom: 1px solid var(--border); color: var(--text-primary); }
.trend-pill {
  padding: 2px 6px; border-radius: 2px; font-size: 0.7rem; font-weight: 700;
  white-space: nowrap; display: inline-flex; align-items: center; gap: 2px;
}
.trend-up { color: var(--success); background: rgba(66, 106, 90, 0.1); }
.trend-down { color: var(--danger); background: rgba(251, 128, 114, 0.1); }

/* Insight Cards */
.insight-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 2rem; }
.insight-card { background: var(--bg-card); border: 1px solid var(--border) !important; padding: 1rem; border-radius: 4px; }
.insight-val { font-size: 1.1rem; color: #F1EEE9 !important; font-weight: 700; font-family: 'JetBrains Mono'; }
.insight-label { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.5rem; }

/* Methodology */
.methodology-card {
  background: var(--bg-card); border: 1px solid var(--border) !important;
  border-radius: 4px; padding: 1.5rem; display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem;
}
.method-item { padding-bottom: 1rem; border-bottom: 1px solid var(--border); }
.method-item:nth-last-child(-n+2) { border-bottom: none; padding-bottom: 0; }
.method-title {
  font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; font-weight: 700;
  color: var(--accent); margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;
}
.method-title i { font-size: 0.75rem; opacity: 0.7; }
.method-desc { font-size: 0.8rem; color: var(--text-muted); line-height: 1.5; }
.method-desc code {
  background: rgba(255, 255, 255, 0.1); padding: 2px 6px; border-radius: 3px;
  font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; color: var(--text-primary);
}
.method-desc strong { color: var(--text-primary); }

/* Geo Map */
.geo-map-container {
  background: var(--bg-card); border: 1px solid var(--border) !important;
  border-radius: 4px; padding: 1rem; margin-bottom: 1.5rem; width: 100%;
}
.geo-map-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
.geo-map-title {
  font-family: 'JetBrains Mono', monospace; font-size: 0.75rem;
  color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px;
}
.geo-map-total { font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; color: var(--accent); font-weight: 600; }
.geo-states-grid {
  display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 0.5rem;
  max-height: 300px; overflow-y: auto; width: 100%;
}
.geo-state-item {
  display: flex; align-items: center; justify-content: space-between; gap: 0.5rem;
  padding: 0.5rem 0.75rem; background: rgba(255, 255, 255, 0.02); border-radius: 4px; font-size: 0.8rem;
}
.geo-state-name {
  color: var(--text-primary); font-weight: 600; font-size: 0.85rem;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1; min-width: 0;
}
.geo-state-amount { color: var(--accent); font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; font-weight: 700; flex-shrink: 0; }

/* Analysis Panel */
.analysis-panel {
  background: var(--bg-card); border: 1px solid var(--border) !important;
  border-radius: 4px; overflow: hidden; width: 100%;
}
.analysis-panel-header {
  padding: 0.75rem 1rem; background: rgba(255, 255, 255, 0.02);
  border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;
}
.analysis-panel-title {
  font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; color: var(--text-muted);
  text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; gap: 0.5rem;
}
.analysis-panel-badge {
  font-size: 0.65rem; padding: 2px 8px; border-radius: 10px;
  font-weight: 600; font-family: 'JetBrains Mono', monospace;
}
.analysis-panel-badge.high { background: rgba(66, 106, 90, 0.2); color: var(--success); }
.analysis-panel-badge.medium { background: rgba(253, 216, 53, 0.2); color: #FDD835; }
.analysis-panel-badge.low { background: rgba(239, 83, 80, 0.2); color: var(--danger); }
.analysis-panel-badge.neutral { background: rgba(255, 255, 255, 0.1); color: var(--text-muted); }
.analysis-panel-body { padding: 1rem; width: 100%; }
.analysis-metric {
  display: flex; justify-content: space-between; align-items: center;
  padding: 0.5rem 0; border-bottom: 1px solid rgba(255, 255, 255, 0.05);
}
.analysis-metric:last-child { border-bottom: none; }
.analysis-metric-label { font-size: 0.8rem; color: var(--text-primary); opacity: 0.65; }
.analysis-metric-value { font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; font-weight: 600; color: var(--text-primary); }
.analysis-insight {
  margin-top: 0.75rem; padding: 0.75rem; background: rgba(212, 196, 168, 0.05);
  border-left: 2px solid var(--accent); font-size: 0.8rem; color: var(--text-muted); line-height: 1.5;
}

/* Subagency & Drill Down */
.drill-breadcrumb {
  display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1rem;
  background: var(--paper-dim); border: 1px solid var(--border);
  border-radius: 4px; margin-bottom: 1rem; font-family: 'JetBrains Mono', monospace;
  font-size: 0.8rem; overflow-x: auto; white-space: nowrap;
}
.breadcrumb-item {
  display: flex; align-items: center; gap: 0.5rem; color: var(--text-muted);
  cursor: pointer; padding: 10px 14px; min-height: 44px; border-radius: 4px; transition: all 0.2s;
}
.breadcrumb-item:hover { background: var(--accent); color: #0a0e0d; }
.breadcrumb-item.active {
  background: var(--accent-dim); color: var(--accent);
  border: 1px solid var(--accent); cursor: default;
}
.breadcrumb-separator { color: var(--text-subtle); font-size: 0.8rem; font-weight: 700; }
.breadcrumb-icon { font-size: 0.75rem; }
.drill-hint {
  display: flex; align-items: center; justify-content: center; gap: 0.5rem;
  padding: 0.5rem; background: rgba(212, 196, 168, 0.05); border: 1px dashed var(--border);
  border-radius: 4px; margin-top: 0.5rem; font-size: 0.75rem; color: var(--text-muted);
}
.drill-hint i { color: var(--accent); }

.subagency-panel {
  background: var(--bg-card); border: 1px solid var(--border) !important;
  border-radius: 4px; margin-top: 1.5rem; overflow: hidden;
}
.subagency-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 1rem; background: var(--paper-dim); border-bottom: 1px solid var(--border);
}
.subagency-header-left { display: flex; align-items: center; gap: 0.75rem; }
.subagency-header-icon {
  width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;
  background: var(--accent-dim); border: 1px solid var(--accent); border-radius: 4px; color: var(--accent);
}
.subagency-header-text h3 { margin: 0; font-family: 'JetBrains Mono', monospace; font-size: 0.9rem; color: var(--text-primary); font-weight: 600; }
.subagency-header-text span { font-size: 0.75rem; color: var(--text-muted); }
.subagency-stats { display: flex; gap: 1.5rem; font-family: 'JetBrains Mono', monospace; }
.subagency-stat { text-align: right; }
.subagency-stat-val { font-size: 1rem; font-weight: 700; color: var(--accent); }
.subagency-stat-label { font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase; }

.subagency-list { max-height: 400px; overflow-y: auto; }
.subagency-item {
  display: flex; align-items: center; justify-content: space-between;
  padding: 1rem; border-bottom: 1px solid var(--border); cursor: pointer; transition: all 0.15s;
}
.subagency-item:hover { background: rgba(255, 255, 255, 0.02); }
.subagency-item:last-child { border-bottom: none; }
.subagency-item-left { display: flex; align-items: center; gap: 1rem; flex: 1; min-width: 0; }
.subagency-rank {
  width: 34px; height: 34px; display: flex; align-items: center; justify-content: center;
  background: var(--accent) !important; color: #F1EEE9 !important; border-radius: 50%;
  font-family: 'JetBrains Mono', monospace; font-size: 15px !important; font-weight: 700; flex-shrink: 0; border: none !important;
}
.subagency-info { flex: 1; min-width: 0; }
.subagency-name { font-size: 0.95rem; color: var(--text-primary); font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.subagency-contracts { font-size: 0.75rem; color: var(--text-muted); margin-top: 2px; }
.subagency-item-right { display: flex; align-items: center; gap: 1rem; flex-shrink: 0; }
.subagency-bar-container { width: 120px; height: 8px; background: rgba(255, 255, 255, 0.05); border-radius: 4px; overflow: hidden; }
.subagency-bar { height: 100%; background: var(--paper-dim); border-radius: 4px; transition: width 0.3s ease; }
.subagency-amount {
  font-family: 'JetBrains Mono', monospace; font-size: 1.1rem; font-weight: 700;
  color: #F1EEE9 !important; min-width: 90px; text-align: right;
}
.subagency-drill-icon { color: var(--text-muted); font-size: 0.8rem; opacity: 0; transition: all 0.15s; }
.subagency-item:hover .subagency-drill-icon { opacity: 1; color: var(--accent); transform: translateX(2px); }
.drill-level-indicator {
  display: inline-flex; align-items: center; gap: 0.25rem; padding: 2px 6px;
  background: rgba(66, 106, 90, 0.1); border: 1px solid rgba(66, 106, 90, 0.3);
  border-radius: 4px; font-size: 0.65rem; color: var(--success); margin-left: 0.5rem;
}
.node-drillable { cursor: pointer; }
.node-drillable:hover { filter: brightness(1.2); }
.empty-drill-state { text-align: center; padding: 3rem 2rem; color: var(--text-muted); }
.empty-drill-state i { font-size: 2rem; color: var(--border); margin-bottom: 1rem; }
.empty-drill-state p { margin: 0.5rem 0; }

/* Sales Plan / Intelligence */
.sales-plan-card {
  background: var(--paper-dim); border: 1px solid var(--accent);
  border-radius: 4px; padding: 1rem; cursor: pointer; transition: all 0.3s ease;
  display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center;
}
.sales-plan-card:hover { transform: none; box-shadow: none; border-color: var(--accent); background: var(--paper-dim); }
.sales-plan-card-icon { font-size: 1.5rem; color: var(--accent); margin-bottom: 0.5rem; }
.sales-plan-card-title {
  font-size: 0.85rem; font-weight: 700; color: var(--accent);
  margin-bottom: 0.25rem; text-transform: uppercase; letter-spacing: 1px;
}
.sales-plan-card-subtitle { font-size: 0.85rem; color: var(--text-primary); line-height: 1.4; margin-bottom: 0.75rem; }
.sales-plan-card-action {
  display: inline-flex; align-items: center; gap: 0.5rem; font-size: 0.75rem;
  color: var(--accent); text-transform: uppercase; letter-spacing: 1px; font-weight: 600;
}
.hero-growth-label {
  font-family: 'JetBrains Mono', monospace; font-size: 0.7rem;
  color: var(--text-muted); text-transform: uppercase; letter-spacing: 2px; margin-bottom: 0.5rem;
}
.hero-growth-value {
  font-size: 2.5rem; font-weight: 800; font-family: 'JetBrains Mono', monospace;
  line-height: 1; color: #F1EEE9 !important;
}
.strategic-narrative-card {
  background: var(--bg-card); border-left: 4px solid var(--accent);
  padding: 1.25rem; margin: 1.5rem 0; font-size: 0.9rem; line-height: 1.6;
}

/* Job Intel Panel specific */
#searchJobPanel, #searchSubcontractPanel { overflow: hidden; max-width: 100%; box-sizing: border-box; }
.intel-grid > div { min-width: 0; overflow: hidden; }
.job-intel-panel {
  background: var(--bg-card); border: 1px solid var(--border) !important;
  border-radius: 6px; padding: 1rem; overflow: hidden;
}

/* Job Links */
.job-link {
  font-size: 0.65rem; color: var(--link); text-decoration: none;
  display: inline-flex; align-items: center; gap: 3px; padding: 2px 6px;
  border-radius: 3px; background: rgba(141, 160, 203, 0.1);
  border: 1px solid rgba(141, 160, 203, 0.2); transition: all 0.15s;
}
.job-link:hover {
  background: rgba(141, 160, 203, 0.2); border-color: rgba(141, 160, 203, 0.4); color: #F1EEE9;
}
.job-link i { font-size: 0.6rem; }

/* Skills Demand */
.skills-demand {
  margin-top: 1rem; padding: 1rem; background: var(--bg-card);
  border: 1px solid var(--border); border-radius: 4px;
}
.skills-header {
  font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; color: var(--accent);
  text-transform: uppercase; letter-spacing: 1px; margin-bottom: 0.75rem;
  display: flex; align-items: center; gap: 0.5rem;
}
.skill-bar-container { margin-bottom: 0.5rem; }
.skill-bar-label { display: flex; justify-content: space-between; font-size: 0.75rem; margin-bottom: 4px; }
.skill-bar-name { color: var(--text-primary); font-weight: 600; font-size: 0.85rem; }
.skill-bar-pct { color: #F1EEE9 !important; font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; font-weight: 700; }
.skill-bar {
  height: 8px; background: rgba(255, 255, 255, 0.05) !important;
  border-radius: 4px; overflow: hidden; position: relative;
}
.skill-bar-fill {
  height: 100%; background: var(--accent); border-radius: 4px;
  transition: width 0.4s ease-out; min-width: 2px;
}

/* Compact Lists */
.compact-winner-list { display: flex; flex-direction: column; gap: 0.6rem; }
.compact-winner-item {
  display: flex; align-items: flex-start; gap: 0.6rem;
  padding: 0.5rem; border-radius: 4px; background: rgba(255, 255, 255, 0.02);
}
.compact-winner-item:hover { background: rgba(255, 255, 255, 0.05); }
.compact-winner-rank {
  width: 34px; height: 34px; background: var(--accent) !important; color: #F1EEE9 !important;
  border-radius: 50%; display: flex; align-items: center; justify-content: center;
  font-family: 'JetBrains Mono', monospace; font-size: 15px !important; font-weight: 700;
  flex-shrink: 0; margin-top: 2px; border: none !important;
}
.compact-winner-info { flex: 1; min-width: 0; }
.compact-winner-name {
  font-size: 0.9rem; color: var(--text-primary); white-space: nowrap;
  overflow: hidden; text-overflow: ellipsis; font-weight: 600;
}
.compact-winner-meta { font-size: 0.65rem; color: var(--text-muted); font-family: 'JetBrains Mono', monospace; margin-top: 2px; }
.compact-location-list { display: flex; flex-direction: column; gap: 0.5rem; }
.compact-location-item {
  display: flex; align-items: center; gap: 0.6rem; padding: 0.4rem 0.5rem;
  border-radius: 4px; background: rgba(255, 255, 255, 0.02);
}
.compact-location-item:hover { background: rgba(255, 255, 255, 0.05); }
.compact-location-rank {
  width: 34px; height: 34px; background: var(--accent) !important; color: #F1EEE9 !important;
  border-radius: 50%; display: flex; align-items: center; justify-content: center;
  font-family: 'JetBrains Mono', monospace; font-size: 15px !important; font-weight: 700;
  flex-shrink: 0; border: none !important;
}
.compact-location-info { flex: 1; min-width: 0; }
.compact-location-name { font-size: 0.9rem; color: var(--text-primary); font-weight: 600; }
.compact-location-meta { font-size: 0.6rem; color: var(--text-muted); font-family: 'JetBrains Mono', monospace; }
.compact-winner-count { font-size: 0.75rem; color: var(--text-muted); font-family: 'JetBrains Mono', monospace; margin-top: 2px; }
.compact-winner-amount {
  font-family: 'JetBrains Mono', monospace; font-size: 1.05rem; font-weight: 700;
  color: #F1EEE9 !important; white-space: nowrap; flex-shrink: 0;
  text-align: right; min-width: 80px; line-height: 1.2;
}
.compact-location-count { font-size: 0.7rem; color: var(--text-muted); font-family: 'JetBrains Mono', monospace; margin-top: 1px; }
.compact-location-amount {
  font-family: 'JetBrains Mono', monospace; font-size: 1rem; font-weight: 700;
  color: #F1EEE9 !important; white-space: nowrap; flex-shrink: 0; text-align: right; min-width: 75px;
}

/* Intelligence Banner */
.intelligence-banner {
  margin: 1.5rem 0 0.5rem 0; padding: 1rem; background: rgba(214, 109, 100, 0.1);
  border: 1px solid rgba(214, 109, 100, 0.3); border-left: 4px solid #D66D64;
  border-radius: 4px; display: flex; gap: 1rem; align-items: flex-start;
  font-size: 0.75rem; color: var(--text-muted); line-height: 1.5;
}
.intel-icon { color: var(--accent-light) !important; font-size: 1.1rem; margin-top: 2px; flex-shrink: 0; }
.intel-content strong {
  color: #F1EEE9; font-family: 'JetBrains Mono', monospace; font-size: 0.75rem;
  text-transform: uppercase; letter-spacing: 0.5px;
}
.intel-tip {
  margin-top: 0.5rem; padding-top: 0.5rem;
  border-top: 1px solid rgba(214, 109, 100, 0.2); color: #e0e0e0;
}

/* Intent Banner */
#spIntentBanner {
  display: none; background: rgba(255, 255, 255, 0.02);
  border-bottom: 1px solid var(--border); padding: 1rem 1.5rem;
}
.intent-banner-content { display: flex; align-items: flex-start; gap: 0.75rem; }
.intent-banner-icon {
  font-size: 1.25rem; color: var(--accent-light) !important;
  opacity: 0.9; width: 24px; text-align: center; flex-shrink: 0;
}
.intent-banner-text { flex: 1; }
.intent-banner-title {
  font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; font-weight: 700;
  color: var(--text-muted); text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 0.25rem;
}
.intent-banner-desc { font-size: 0.95rem; color: var(--text-primary); margin-bottom: 0.5rem; font-weight: 500; }
.intent-banner-focus { display: flex; flex-wrap: wrap; align-items: center; gap: 0.4rem; }
.focus-label {
  font-family: 'JetBrains Mono', monospace; font-size: 0.6rem;
  color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px;
}
.focus-tag { font-size: 0.65rem; background: transparent; border: none; color: var(--text-muted); padding: 0; }
.focus-tag::before { content: '•'; margin-right: 0.35rem; color: var(--accent); }

/* =========================================
   10. MODALS & OVERLAYS (MONOCHROMATIC GREEN)
   ========================================= */

/* --- Base Modal Container --- */
.channel-marking-modal, .pipeline-modal, .convo-modal {
  position: fixed; top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(14, 18, 17, 0.95) !important; /* Darker, richer backdrop */
  z-index: 500;
  padding: 2rem; 
  overflow-y: auto; 
  display: flex; align-items: flex-start; justify-content: center;
  opacity: 0; visibility: hidden; 
  transition: opacity 0.2s ease, visibility 0.2s;
  backdrop-filter: blur(5px);
}

.channel-marking-modal.active, .pipeline-modal.active, .convo-modal.active { 
  opacity: 1; visibility: visible; 
}

/* --- Unified Modal Content Card --- */
.channel-modal-content, .pipeline-modal-content, .convo-modal-content {
  background: var(--bg-card); 
  border: 1px solid var(--border);
  border-top: 3px solid var(--accent) !important; /* UNIFIED GREEN TOP */
  border-radius: 8px;
  width: 100%; margin: 2rem auto;
  
  /* Smooth Entry Animation */
  transform: translateY(12px) scale(0.99); 
  opacity: 0;
  transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
  
  display: flex; flex-direction: column; 
  box-shadow: 0 24px 60px rgba(0,0,0,0.6);
}

.channel-marking-modal.active .channel-modal-content, 
.pipeline-modal.active .pipeline-modal-content, 
.convo-modal.active .convo-modal-content { 
  transform: translateY(0) scale(1); 
  opacity: 1; 
}

/* Max Widths */
.channel-modal-content { max-width: 800px; max-height: 85vh; }
.pipeline-modal-content { max-width: 1100px; max-height: 90vh; }
.convo-modal-content { max-width: 700px; max-height: 90vh; }

/* --- Modal Header --- */
.channel-modal-header {
  padding: 1.25rem 1.5rem; 
  border-bottom: 1px solid var(--border);
  background: rgba(255, 255, 255, 0.02); 
  display: flex; justify-content: space-between; align-items: center;
}

.channel-modal-title {
  font-size: 1.1rem; font-weight: 700; color: #F1EEE9 !important;
  font-family: 'JetBrains Mono', monospace;
  text-transform: uppercase; letter-spacing: 1px;
  display: flex; align-items: center; gap: 0.75rem;
}

/* Force header bullets to green */
.channel-modal-title .sub-bullet {
  background: var(--accent) !important;
  color: #F1EEE9 !important;
  box-shadow: 0 0 0 2px var(--bg-card); /* Cutout effect */
}

/* Close Button (Muted until hover) */
.channel-modal-close {
  background: transparent; 
  border: 1px solid transparent;
  color: var(--text-muted); 
  font-size: 1.1rem; 
  cursor: pointer;
  width: 32px; height: 32px; 
  display: flex; align-items: center; justify-content: center; 
  border-radius: 4px; 
  transition: all 0.2s ease;
}

.channel-modal-close:hover {
  background: rgba(255, 255, 255, 0.05);
  color: #F1EEE9;
}

/* --- Modal Body & Footer --- */
.channel-modal-body { padding: 1.5rem; flex: 1; overflow-y: auto; min-height: 0; }

.channel-modal-footer {
  padding: 1rem 1.5rem; 
  border-top: 1px solid var(--border);
  display: flex; gap: 1rem; justify-content: space-between; align-items: center; 
  flex-shrink: 0; 
  background: var(--bg-elevated);
}

.modal-footer-buttons { display: flex; gap: 0.75rem; align-items: center; }
.modal-footer-secondary { display: flex; gap: 0.5rem; }
.modal-status-line { font-size: 0.75rem; color: var(--text-muted); font-family: 'JetBrains Mono', monospace; }

/* Modal Buttons */
.modal-btn {
  padding: 0.65rem 1.25rem; border-radius: 4px; font-weight: 600;
  cursor: pointer; transition: all 0.2s; text-transform: uppercase;
  letter-spacing: 1px; font-size: 0.75rem; font-family: 'JetBrains Mono', monospace;
}

/* Primary = Green */
.modal-btn-primary {
  background: var(--accent) !important;
  border: 1px solid var(--accent) !important;
  color: #F1EEE9 !important;
  box-shadow: 0 2px 5px rgba(0,0,0,0.3);
}
.modal-btn-primary:hover {
  background: var(--accent-dark) !important;
  transform: translateY(-1px);
}

/* Cancel/Secondary = Muted Glass */
.modal-btn-cancel {
  background: rgba(255,255,255,0.03) !important;
  border: 1px solid var(--border) !important;
  color: var(--text-muted) !important;
}
.modal-btn-cancel:hover {
  background: rgba(255,255,255,0.08) !important;
  color: var(--text-primary) !important;
}

/* --- Vendor List & Toggles --- */
.vendor-list-item {
  display: flex; align-items: center; justify-content: space-between;
  padding: 0.75rem 1rem; 
  border: 1px solid var(--border);
  border-radius: 4px; margin-bottom: 0.5rem; 
  background: rgba(255,255,255,0.01);
  transition: all 0.2s;
}
.vendor-list-item:hover {
  background: rgba(255, 255, 255, 0.03); 
  border-color: var(--accent-light);
}

.toggle-switch {
  position: relative; width: 44px; height: 24px; 
  background: #2a2a2a; /* Dark gray off state */
  border-radius: 12px; cursor: pointer; transition: background 0.3s;
}
.toggle-switch.active { background: var(--accent) !important; } /* Green on state */

.toggle-slider {
  position: absolute; top: 3px; left: 3px; width: 18px; height: 18px;
  background: #F1EEE9; border-radius: 50%; transition: transform 0.3s;
  box-shadow: 0 1px 3px rgba(0,0,0,0.3);
}
.toggle-switch.active .toggle-slider { transform: translateX(20px); }

/* --- CONVERSATION STARTERS (The "Blue" Fix) --- */
.convo-card {
  background: var(--bg-card); 
  border: 1px solid var(--border) !important;
  border-left: 3px solid var(--accent) !important; /* Green, not Blue */
  border-radius: 4px;
  padding: 1.25rem; margin-bottom: 0.75rem; position: relative;
  transition: transform 0.2s ease;
}
.convo-card:hover { 
  border-color: var(--accent-light) !important; 
  transform: translateX(4px); 
}

.convo-card-label {
  font-family: 'JetBrains Mono', monospace; font-size: 0.65rem; 
  color: var(--accent-light) !important; /* Green text */
  text-transform: uppercase; letter-spacing: 1px; margin-bottom: 0.75rem;
  display: flex; align-items: center; gap: 0.5rem; font-weight: 700;
}

.convo-card-copy {
  position: absolute; top: 1rem; right: 1rem; 
  background: transparent;
  border: 1px solid var(--border); 
  color: var(--text-muted); 
  width: 32px; height: 32px;
  border-radius: 4px; cursor: pointer; 
  display: flex; align-items: center; justify-content: center; 
  transition: all 0.15s;
}
.convo-card-copy:hover { 
  border-color: var(--accent); 
  color: var(--accent); 
  background: var(--accent-dim); 
}

/* Convo Toggles - Green Active State */
.convo-focus-toggle { display: flex; gap: 0.5rem; margin-bottom: 1.25rem; }
.convo-focus-btn {
  flex: 1; padding: 0.6rem; 
  background: transparent; 
  border: 1px solid var(--border);
  color: var(--text-muted); 
  border-radius: 4px; cursor: pointer;
  font-family: 'JetBrains Mono', monospace; font-size: 0.7rem;
  text-transform: uppercase; transition: all 0.2s;
  display: flex; align-items: center; justify-content: center; gap: 6px;
}
.convo-focus-btn:hover { color: var(--text-primary); border-color: var(--text-muted); }

.convo-focus-btn.active { 
  background: var(--accent-dim) !important; 
  border-color: var(--accent) !important; 
  color: var(--text-primary) !important; 
}
/* Force icons inside active buttons to be green */
.convo-focus-btn.active .sub-bullet { background: var(--accent) !important; }

/* --- PIPELINE BUILDER (The "Yellow" Fix) --- */
.pipeline-config-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 1rem; }
.pipeline-config-item label {
  display: block; font-size: 0.7rem; color: var(--text-muted);
  text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.5rem; font-weight: 600;
}

.pipeline-config-item select, .pipeline-config-item input {
  width: 100%; padding: 0.7rem; 
  background: var(--bg-input);
  border: 1px solid var(--border); 
  border-radius: 4px; 
  color: var(--text-primary); font-size: 0.85rem;
  font-family: 'JetBrains Mono', monospace;
}
.pipeline-config-item select:focus { border-color: var(--accent); outline: none; }

/* Pipeline Table - Monochromatic Badges */
.pipeline-table th {
  background: var(--bg-card); color: var(--accent); /* Green Headers */
  font-family: 'JetBrains Mono', monospace;
  padding: 0.75rem 0.5rem; text-align: left;
  border-bottom: 2px solid var(--border); font-size: 0.7rem;
  text-transform: uppercase;
}

.pipeline-table .stage {
  display: inline-block; padding: 2px 8px; border-radius: 4px;
  font-size: 0.65rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;
}
/* Prospecting = Muted Green */
.pipeline-table .stage.prospecting { 
  background: rgba(255, 255, 255, 0.05); 
  color: var(--text-muted); 
  border: 1px solid var(--border);
}
/* Qualification = Active Green */
.pipeline-table .stage.qualification { 
  background: var(--accent-dim); 
  color: var(--accent-light); 
  border: 1px solid var(--accent);
}

.pipeline-quarter-badge {
  color: var(--text-primary);
  background: var(--bg-elevated);
  border: 1px solid var(--border);
  padding: 2px 6px; border-radius: 3px; font-size: 0.65rem;
}

/* --- Info/Success Banners --- */
/* Replaces the "Beige" and "Red" boxes */
.modal-info-box, .channel-explanation, .intelligence-banner {
  background: var(--accent-dim) !important;
  border-left: 3px solid var(--accent) !important;
  padding: 1rem; margin-bottom: 1.5rem; 
  font-size: 0.85rem; color: var(--text-primary); 
  line-height: 1.6; border-radius: 0 4px 4px 0;
}
.modal-info-box i, .intelligence-banner i { color: var(--accent); margin-right: 8px; }

/* --- AI Link Buttons (Success Modal) --- */
.ai-link-btn {
  display: flex; align-items: center; justify-content: center; gap: 0.5rem;
  padding: 0.75rem 1rem; border-radius: 4px; 
  color: var(--text-muted); text-decoration: none; 
  font-family: 'JetBrains Mono', monospace; font-size: 0.8rem;
  font-weight: 600; 
  border: 1px solid var(--border); 
  background: rgba(255,255,255,0.02);
  transition: all 0.2s;
}
/* Monochromatic Hover: All turn Green */
.ai-link-btn:hover { 
  color: #F1EEE9; 
  background: var(--accent); 
  border-color: var(--accent); 
}
/* =========================================
   11. FOOTER & MISC
   ========================================= */
.hero-footer { width: 100%; max-width: 1200px; margin: 3rem auto 0 auto; padding-top: 2rem; }
.dashboard-container .hero-footer { margin: 4rem auto 0 auto; padding-bottom: 2rem; animation: fadeIn 1s forwards; }
.dashboard-container .hero-footer .footer-grid { gap: 2rem; }
.footer-grid { display: grid; grid-template-columns: 1fr; gap: 2rem; }
@media (min-width: 768px) {
  .footer-grid { grid-template-columns: 1fr 1fr 1fr; gap: 2rem; }
  .footer-section { border-bottom: none; padding-bottom: 0; }
}
.footer-section { padding-bottom: 1.5rem; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
.footer-section:last-child { border-bottom: none; padding-bottom: 0; }
.footer-label {
  font-family: 'JetBrains Mono', monospace; font-size: 0.65rem; font-weight: 700;
  text-transform: uppercase; letter-spacing: 1px; color: var(--accent); margin-bottom: 0.75rem;
}
.footer-heading {
  font-size: 1rem; font-weight: 600; color: var(--text-primary);
  margin-bottom: 0.75rem; letter-spacing: -0.01em;
}
.footer-text { overflow: hidden; font-size: 0.8rem; line-height: 1.6; color: var(--text-primary); opacity: 0.65; margin-bottom: 0.75rem; }
.footer-text:last-child { margin-bottom: 0; }
.footer-links { display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 1rem; }
.footer-link {
  font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; color: var(--link);
  text-decoration: none; text-transform: uppercase; letter-spacing: 0.5px;
  font-weight: 700; padding-bottom: 2px; border-bottom: 1px solid var(--accent); transition: opacity 0.2s ease;
}
.footer-link:hover { opacity: 0.7; }
.footer-bottom { margin-top: 2rem; padding-top: 1.5rem; text-align: center; }
.footer-copyright { font-family: 'JetBrains Mono', monospace; font-size: 0.65rem; color: var(--text-muted); letter-spacing: 0.5px; }
.use-cases { display: flex; flex-direction: column; gap: 1rem; }
.use-case { padding: 0.875rem; background: rgba(255, 255, 255, 0.02); border-left: 2px solid var(--accent); }
.use-case-title {
  font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; font-weight: 700;
  color: var(--text-primary); margin-bottom: 0.375rem; text-transform: uppercase; letter-spacing: 0.5px;
}
.use-case-desc { font-size: 0.75rem; color: var(--text-muted); line-height: 1.5; }
.feature-list { display: flex; flex-direction: column; gap: 0.75rem; }
.feature-item { display: flex; align-items: flex-start; gap: 0.75rem; font-size: 0.75rem; line-height: 1.5; }
.feature-tag {
  font-family: 'JetBrains Mono', monospace; font-size: 0.65rem; font-weight: 700;
  color: var(--text-primary); background: rgba(255, 255, 255, 0.1); padding: 0.2rem 0.5rem;
  border-radius: 2px; white-space: nowrap; flex-shrink: 0;
}
.feature-desc { color: var(--text-muted); }
.data-source {
  display: flex; align-items: flex-start; gap: 0.75rem; padding: 0.75rem;
  background: rgba(255, 255, 255, 0.02); border: 1px solid var(--border); border-radius: 4px; margin-top: 1rem;
}
.data-source-icon { font-size: 1rem; color: var(--text-muted); margin-top: 2px; }
.data-source-text { font-size: 0.7rem; color: var(--text-muted); line-height: 1.5; }
.data-source-text a { color: var(--accent); text-decoration: none; }
.data-source-text a:hover { text-decoration: underline; }
.pro-tip-box {
  font-family: 'JetBrains Mono', monospace; background: rgba(212, 196, 168, 0.08);
  border: 1px solid var(--accent); border-radius: 4px; padding: 0.75rem; margin-top: 1rem;
}
.pro-tip-label {
  font-size: 0.6rem; font-weight: 700; color: var(--accent);
  text-transform: uppercase; letter-spacing: 1px; margin-bottom: 0.5rem;
}
.pro-tip-code {
  font-size: 0.75rem; color: var(--text-primary); background: rgba(0, 0, 0, 0.3);
  padding: 0.375rem 0.5rem; border-radius: 2px; display: inline-block; margin-top: 0.25rem;
}
.tip-bio-img { width: 48px; height: 48px; border-radius: 50%; filter: grayscale(1) contrast(1.1); flex-shrink: 0; float: left; margin-right: 12px; margin-bottom: 4px; }
.disclaimer-text {
  margin-top: 1.5rem; padding: 1rem; font-size: 0.7rem; color: var(--text-muted);
  border-top: 1px solid var(--border); line-height: 1.4; font-style: italic;
}

/* Steps List (Subway Line Bullets) */
.steps-list { counter-reset: step; list-style: none; padding: 0; margin: 0; }
.steps-list li {
  position: relative; padding-left: 2.75rem !important; margin-bottom: 1rem !important;
  color: #CCCCCC !important; font-size: 0.75rem; line-height: 1.5;
}
.steps-list li::before {
  counter-increment: step; content: counter(step);
  position: absolute; left: 0; top: -4px;
  background-color: var(--accent) !important; color: #F1EEE9 !important;
  border-radius: 50% !important; width: 34px !important; height: 34px !important;
  font-size: 15px !important; font-weight: 700 !important;
  font-family: 'JetBrains Mono', monospace !important;
  display: flex; align-items: center; justify-content: center;
  border: none !important;
}
.steps-list li strong { color: #F1EEE9 !important; font-weight: 700 !important; }

/* =========================================
   12. SPECIALTY LOGIC (SANKEY & JOBS)
   ========================================= */
.sankey-link { opacity: 0.35; transition: opacity 0.2s; }
.sankey-link:hover { opacity: 0.7; }
.sankey-loaded { animation: subtlePulse 2s ease-in-out 1; }
.agency-bar, .prog-bar-fill, .skill-bar-fill { background: var(--accent); }

.modal-step-label {
  font-size: 0.85rem; color: var(--accent); font-weight: 700; margin-bottom: 1rem;
  text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; gap: 0.5rem;
}
.modal-step-section { padding: 1.5rem; border-bottom: 1px solid var(--border); background: rgba(255, 255, 255, 0.02); }
.modal-step-section:last-child { border-bottom: none; }
.modal-info-box {
  background: rgba(66, 106, 90, 0.06); border-left: 2px solid var(--accent);
  padding: 0.75rem 1rem; border-radius: 0 4px 4px 0; margin-bottom: 1.5rem;
  font-size: 0.8rem; color: var(--text-muted); line-height: 1.6;
}
.modal-info-box strong { color: var(--text-primary); }
.modal-info-box i { color: var(--accent); }
.modal-info-box.success { background: rgba(66, 106, 90, 0.08); border-color: var(--success); }
.modal-info-box.success i { color: var(--success); }
.modal-form-label { display: block; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.5rem; font-weight: 600; }
.modal-step-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
.modal-body-section { padding: 1.5rem; }
.modal-select { padding: 0.6rem; font-size: 0.9rem; background: var(--bg-app); }
@keyframes modalSlideIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
.modal-animate-in { animation: modalSlideIn 0.3s ease-out forwards; }
.beat-label {
  font-family: "JetBrains Mono", monospace; font-size: 0.6rem; font-weight: 700;
  text-transform: uppercase; letter-spacing: 2.5px; color: var(--accent);
  opacity: 0.5; padding: 0.75rem 0 0.25rem 0;
}
.action-bar-label {
  font-family: "JetBrains Mono", monospace; font-size: 0.6rem; font-weight: 700;
  text-transform: uppercase; letter-spacing: 2px; color: var(--accent-light) !important;
  opacity: 0.6; margin-bottom: 0.75rem; width: 100%; display: flex; align-items: center; gap: 0.5rem;
}
.action-bar-label::after { content: ""; flex: 1; height: 1px; background: var(--border); }

/* =========================================
   13. MEDIA QUERIES (RESPONSIVE)
   ========================================= */
@media (max-width: 900px) {
  .insight-grid { grid-template-columns: 1fr; }
  .market-structure-grid { grid-template-columns: 1fr; }
  .scenario-grid { grid-template-columns: 1fr; gap: 0.5rem; }
  .chart-wrapper { overflow-x: scroll !important; -webkit-overflow-scrolling: touch; }
  .stats-row, .pipeline-results-grid { grid-template-columns: 1fr 1fr; }
}

@media (max-width: 768px) {
  .pipeline-results-grid { grid-template-columns: repeat(2, 1fr); }
  .pipeline-config-row { grid-template-columns: 1fr; }
  .methodology-card { grid-template-columns: 1fr; }
  .subagency-bar-container { display: none; }
  .subagency-stats { flex-direction: column; gap: 0.5rem; }
  .subagency-stat { text-align: left; }
  .stats-row { grid-template-columns: 1fr !important; gap: 0.75rem !important; }
  .stat-item {
    display: flex !important; justify-content: space-between !important;
    align-items: center !important; padding: 1rem !important; text-align: left !important;
  }
  .stat-label { margin-bottom: 0 !important; }
  .stat-item-action { grid-column: span 1 !important; }
  #forecastModeView div[style*="display: grid"] { grid-template-columns: 1fr !important; gap: 1rem !important; width: 100% !important; overflow: hidden !important; }
  .dashboard-container {
    width: 100% !important; max-width: 100% !important; padding-left: 1rem !important;
    padding-right: 1rem !important; overflow-x: hidden !important;
  }
  .analysis-panel, .analysis-panel-body, .buyer-list { width: 100% !important; max-width: 100% !important; }
  .job-intel-panel > div { grid-template-columns: 1fr !important; }
  .forecast-table th, .forecast-table td { padding: 0.75rem 0.25rem !important; font-size: 0.75rem; }
  .forecast-table td:last-child { padding-right: 0 !important; }
  .geo-states-grid { grid-template-columns: 1fr !important; }
  .btn-row { flex-direction: column; }
  .chart-container { min-width: auto; width: 100%; }
  .chart-wrapper { padding: 0 !important; border: none !important; }
  .sankey-panel { padding: 0.5rem !important; }
}

@media (max-width: 600px) {
  .mode-toggle { flex-direction: column; }
  .app-header { gap: 0.5rem; padding: 0.5rem 0.75rem; }
  .header-left { gap: 0.5rem; }
  .mini-search { max-width: none; padding: 0.5rem 0.6rem; font-size: 0.8rem; }
  .logo-btn { font-size: 0.9rem; }
  .header-actions { gap: 0.35rem; }
  .channel-marking-modal { padding: 0; }
  .channel-modal-content {
    margin: 0; border-radius: 0; border-top: 2px solid var(--accent); height: 100%;
    max-height: 100%; max-width: 100%; display: flex; flex-direction: column;
    transform: translateY(16px); opacity: 0;
  }
  .channel-modal-header { flex-shrink: 0; padding: 1rem; }
  .channel-modal-title { font-size: 1.1rem; }
  .channel-modal-body { flex: 1; overflow-y: auto; min-height: 0; }
  .channel-modal-footer {
    flex-direction: column; gap: 0.75rem; padding: 1rem;
    padding-bottom: max(1rem, env(safe-area-inset-bottom));
  }
  .modal-footer-buttons { flex-direction: column; width: 100%; gap: 0.5rem; }
  .modal-footer-buttons .modal-btn-primary { width: 100%; padding: 0.875rem; }
  .modal-footer-secondary { width: 100%; gap: 0.5rem; }
  .modal-footer-secondary .modal-btn { flex: 1; padding: 0.75rem; }
  .modal-status-line {
    text-align: center; font-size: 0.7rem; opacity: 0.7;
    padding-top: 0.5rem; border-top: 1px solid var(--border);
  }
  .step-grid { grid-template-columns: 1fr !important; }
  .hero-growth-value { font-size: 2rem; }
  .intel-grid { grid-template-columns: 1fr !important; }
  .intel-grid > div { min-width: 0; overflow: hidden; }
  .modal-step-grid { grid-template-columns: 1fr !important; }
  .channel-modal-close {
    width: 44px; height: 44px; font-size: 1.25rem; margin: -0.25rem -0.25rem -0.25rem 0;
  }
  .buyer-spend { font-size: 1rem; }
  .buyer-amount { min-width: 75px; }
  .compact-winner-amount { font-size: 0.9rem; min-width: 65px; }
  .compact-location-amount { font-size: 0.85rem; min-width: 60px; }
  .subagency-amount { font-size: 0.95rem; min-width: 70px; }
  .buyer-name, .compact-winner-name, .subagency-name { font-size: 0.85rem; }
  .job-links { gap: 4px; }
  .job-link { font-size: 0.6rem; padding: 2px 4px; }
  .buyer-rank { width: 34px; height: 34px; font-size: 15px !important; }
  .compact-winner-rank { width: 34px; height: 34px; font-size: 15px !important; }
  .compact-location-rank { width: 34px; height: 34px; font-size: 15px !important; }
  .subagency-rank { width: 34px; height: 34px; font-size: 15px !important; }
  .sub-bullet, .sub-bullet.sm, .sub-bullet.lg, .sub-bullet.xl { width: 34px; height: 34px; font-size: 15px; }
  .steps-list li::before { width: 34px !important; height: 34px !important; font-size: 15px !important; }
  .steps-list li { padding-left: 2.75rem !important; }
  .icon-btn { width: 34px; height: 34px; font-size: 15px; }
}
/* FORCE FOOTER STEPS TO JETBRAINS MONO */
.steps-list li {
  font-family: 'JetBrains Mono', monospace !important;
  letter-spacing: 0.5px;
}

/* Ensure the number inside the circle uses JetBrains Mono */
.steps-list li::before {
  font-family: 'JetBrains Mono', monospace !important;
  font-weight: 700 !important;
}

/* Ensure any bold text inside the step is also JetBrains Mono */
.steps-list li strong {
  font-family: 'JetBrains Mono', monospace !important;
}
/* Sharp Chalk Overrides for Metadata */
.deal-amount, 
.compact-winner-amount, 
.compact-location-amount {
  font-family: 'JetBrains Mono', monospace !important;
  color: #F1EEE9 !important; /* Pure Chalk White */
  letter-spacing: -0.5px;
}

.deal-date, 
.mission-gap-signals, 
.vendor-stats {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.65rem !important;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: var(--text-primary) !important;
  opacity: 0.5; /* Dusty Chalk look */
}

/* Ensure 'Open Award' button matches the unified outline style */
.deal-footer .action-btn {
  border: 1px solid rgba(251, 247, 245, 0.3) !important;
  background: transparent !important;
  color: var(--text-primary) !important;
  text-transform: uppercase;
  font-size: 0.65rem !important;
}
/* Refined Open Award Button - Secondary Outline Style */
.deal-footer .action-btn {
  background: transparent !important;
  border: 1px solid rgba(251, 247, 245, 0.3) !important; /* Muted Chalk Outline */
  color: var(--text-primary) !important;
  text-transform: uppercase;
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.65rem !important;
  font-weight: 700;
  letter-spacing: 0.5px;
  padding: 0.5rem 0.75rem;
  transition: all 0.2s ease;
}

.deal-footer .action-btn:hover {
  background: rgba(251, 247, 245, 0.08) !important; /* Subtle Glow */
  border-color: var(--text-primary) !important;
  color: #F1EEE9 !important;
}
/* Tighten up the Search Box Cohesion */
#heroView .search-box-container {
  display: flex;
  flex-direction: column;
  gap: 12px; /* Uniform gap between input and button */
}

#heroView .main-input {
  height: 56px; /* Explicit height to match button heft */
  border-radius: 6px !important; /* Slightly softer corners */
}

#searchBtn {
  height: 56px;
  border-radius: 6px !important;
  font-weight: 800 !important; /* Make it more authoritative */
  letter-spacing: 2px;
}

/* Make the Chips feel like part of the 'Chalk' system */
#heroView a[href^="?q="] {
  background: rgba(255, 255, 255, 0.03) !important;
  /* Use a solid transparent border so dimensions are identical to the hover state */
  border: 1px solid transparent !important; 
  padding: 8px 14px !important;
  color: var(--text-muted) !important;
  font-weight: 500;
  text-decoration: none;
  border-radius: 4px;
  transition: all 0.2s ease-in-out;
  display: inline-block; /* Ensures padding and transforms behave consistently */
}

#heroView a[href^="?q="]:hover {
  border: 1px solid var(--accent) !important; /* Now it just changes color, not size */
  background: var(--accent-dim) !important;
  color: var(--accent-light) !important;
  transform: translateY(-2px); /* Subtle lift instead of a layout jump */
}
/* Unified Sankey header surface */
.sankey-header,
.prime-sankey-header,
.subcontract-sankey-header {
  background: var(--bg-card);
  color: var(--text-primary);

  border-bottom: 1px solid var(--border);
  padding: 0.75rem 1rem;

  font-weight: 600;
  letter-spacing: 0.2px;
}
/* =========================================
   Compact drill/breadcrumb bar
   Keeps your current HTML; just tightens it
   ========================================= */

/* Outer bar */
.drill-controls-bar{
  padding: 0.5rem 0.75rem;
  border-radius: 8px;
  background: rgba(255,255,255,0.02);
  border: 1px solid var(--border);
}

/* Breadcrumb container */
.drill-breadcrumb{
  gap: 0.35rem !important;
}

/* Each breadcrumb chip */
.breadcrumb-item{
  padding: 0.25rem 0.5rem;
  border-radius: 6px;
  border: 1px solid var(--border);
  background: transparent;
  color: var(--text-muted);
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.72rem;
  line-height: 1.1;
  display: inline-flex;
  align-items: center;
  gap: 0.35rem;
  cursor: pointer;
  transition: opacity 0.15s ease, transform 0.15s ease;
}

/* Icon inside breadcrumb */
.breadcrumb-icon{
  font-size: 0.72rem;
  opacity: 0.75;
}

/* Hover: tiny lift, no shadow */
.breadcrumb-item:hover{
  opacity: 0.92;
  transform: scale(1.02);
  color: var(--text-primary);
}

/* Drill level badge (Level 1, etc.) */
.drill-level-indicator{
  padding: 0.2rem 0.5rem;
  border-radius: 999px;
  border: 1px solid var(--border);
  background: rgba(255,255,255,0.015);
  color: var(--text-muted);
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.70rem;
  line-height: 1.1;
  display: inline-flex;
  align-items: center;
  gap: 0.35rem;
}

/* Filter badge */
.filter-badge{
  padding: 0.2rem 0.55rem;
  border-radius: 999px;
  border: 1px solid rgba(66,106,90,0.45);
  background: rgba(66,106,90,0.10);
  color: var(--text-primary);
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.70rem;
  line-height: 1.1;
  display: inline-flex;
  align-items: center;
  gap: 0.35rem;
  cursor: pointer;
  transition: opacity 0.15s ease, transform 0.15s ease;
}

.filter-badge:hover{
  opacity: 0.92;
  transform: scale(1.02);
}

/* Reduce spacing between left and right groups inside the bar */
#drillControlsBar > div{
  gap: 0.5rem !important;
}

/* Optional: if the bar feels tall due to wrapped lines */
@media (max-width: 520px){
  .drill-controls-bar{
    padding: 0.5rem 0.6rem;
  }
  .breadcrumb-item{
    font-size: 0.70rem;
    padding: 0.22rem 0.45rem;
  }
}
/* Hide redundant drill badges (logic stays intact) */
#drillLevelBadge,
#filterBadge {
  display: none !important;
}
/* 1. SOFTEN THE SEARCH BOX */
.main-input, .mini-search {
  border-radius: 8px; /* Softer corners */
  background: var(--bg-input) !important;
  border: 1px solid var(--border) !important;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2); /* Deep shadow, not harsh */
}
.main-input:focus {
  border-color: var(--accent-light) !important;
  box-shadow: 0 0 0 3px var(--accent-dim); /* Soft glow instead of hard outline */
}

/* 2. RELAX THE "QUICK START" CHIPS */
/* Makes them look like paper tickets */
#heroView a[href^="?q="] {
  background: rgba(255, 255, 255, 0.03) !important;
  border: 1px solid var(--border) !important;
  color: var(--text-muted) !important;
  border-radius: 20px !important; /* Pill shape is friendlier */
  padding: 6px 16px !important;
  font-size: 0.75rem;
  letter-spacing: 0.5px;
}
#heroView a[href^="?q="]:hover {
  background: var(--accent-dim) !important;
  color: var(--accent-light) !important;
  border-color: var(--accent) !important;
  transform: translateY(-1px);
}

/* 3. MUTED SUBWAY BULLETS */
/* Instead of hardcoded orange/blue, use the palette variables */
.sub-bullet.blue { background: var(--info); }
.sub-bullet.orange { background: var(--warning); color: var(--bg-app); } /* Dark text on light background for contrast */
.sub-bullet.red { background: var(--danger); }
.sub-bullet.purple { background: #9B8EA9; } 

/* 4. CARD STYLING - "Matte" finish */
.deal-card, .stat-item, .analysis-panel {
  background: var(--bg-card);
  border: 1px solid var(--border) !important;
  box-shadow: 0 2px 8px rgba(0,0,0,0.15); /* Subtle depth */
}

/* 5. TEXT HIERARCHY */
/* Ensure big numbers don't dazzle the eyes */
.hero-growth-value, #stat-vol, .deal-amount {
  color: var(--text-primary) !important;
  text-shadow: none; /* Remove any hard shadows */
  letter-spacing: -1px; /* Tighten for a modern look */
}

/* 6. TAGS - Pastel Chalk look */
.meta-tag {
  border-radius: 4px;
  font-weight: 600;
  border: 1px solid transparent;
}
.meta-tag.psc { 
  background: rgba(126, 156, 184, 0.15); 
  color: var(--info); 
}
.meta-tag.naics { 
  background: rgba(155, 142, 169, 0.15); 
  color: #9B8EA9; 
}
/* =========================================
   MOBILE MODAL FIXES (Add to end of CSS)
   ========================================= */
@media (max-width: 768px) {
  
  /* 1. Tighten the outer container padding */
  /* Was 2rem, which is too wide for iPhone. Reduces wasted edge space. */
  .channel-marking-modal, .pipeline-modal, .convo-modal {
    padding: 0.75rem !important;
    align-items: center !important; /* Centers small modals vertically */
  }

  /* 2. Fix GTM & General Modals */
  /* Allows them to fit on screen without being forced 100% height if not needed */
  .channel-modal-content, .pipeline-modal-content, .convo-modal-content {
    margin: 0 !important;
    width: 100% !important;
    max-height: 95vh !important;
    border-radius: 8px !important; /* Keep rounded corners on mobile */
    display: flex;
    flex-direction: column;
  }

  /* 3. FIX: COPY SUCCESS MODAL (Stop it from being huge) */
  /* This specific ID override prevents the success message from filling the screen */
  #copySuccessModal .channel-modal-content {
    height: auto !important;
    min-height: auto !important;
    max-height: auto !important;
    flex: 0 0 auto !important; /* Don't grow */
    margin: auto !important;   /* Center in view */
    transform: none !important;
  }

  /* 4. Optimize GTM/Pipeline Internal Spacing */
  .channel-modal-header, .channel-modal-footer {
    padding: 1rem !important; /* Shrink header/footer height */
  }
  
  .channel-modal-body {
    padding: 1rem !important;
  }

  /* 5. Shrink large titles on mobile */
  .channel-modal-title {
    font-size: 0.95rem !important;
  }
}
@media (max-width: 768px) {
  /* Prevent iOS zoom on focus */
  input, select, textarea {
    font-size: 16px !important; 
  }
}
/* Custom "Midnight" Scrollbars */
::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}
::-webkit-scrollbar-track {
  background: var(--bg-app); 
}
::-webkit-scrollbar-thumb {
  background: var(--bg-elevated); 
  border: 1px solid var(--border);
  border-radius: 4px;
}
::-webkit-scrollbar-thumb:hover {
  background: var(--accent-dim); 
}
.pipeline-modal-body {
  overflow-x: auto; /* Adds scroll bar if table is too wide */
  -webkit-overflow-scrolling: touch; /* Smooth scroll on iOS */
}
/* Remove border from Sankey containers to make them 'float' */
#sankey, #sankey-sub, .sankey-container, .chart-wrapper {
  border: none !important;
  box-shadow: none !important;
  background: transparent !important;
}

/* If the SVG itself has a border class */
svg {
  border: none !important;
  outline: none !important;
}
</style>
</head>
<body>

<div id="heroView" class="hero-view">
  <div class="terminal-logo"><span style="color: var(--accent);">>_</span>Govhoo</div>
  <p class="hero-subtitle" style="padding-left: 1.25em;">Follow the Money. For Free.</p>
  
  <div class="search-box-container">
  <input type="text" id="mainSearchInput" class="main-input" placeholder="Keywords, company, or agency..." autocomplete="off">
  <button class="input-clear" onclick="document.getElementById('mainSearchInput').value=''; document.getElementById('mainSearchInput').focus();" aria-label="Clear search">×</button>
    <div class="btn-row">
      <button id="searchBtn" class="btn-primary" data-action="search" style="flex: none; width: 100%; background-color: var(--accent); color: #F1EEE9;">
        SEARCH
      </button>
    </div>
  </div>

  <!-- Quick Start Chips -->
  <div style="width: 100%; max-width: 500px; margin-top: 1.5rem;">
    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: center;">
      <a href="?q=Cloud" style="text-decoration: none; padding: 0.4rem 0.75rem; border: 1px solid var(--border); border-radius: 4px; font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; color: var(--text-muted); transition: all 0.15s; background: rgba(255,255,255,0.02);" onmouseover="this.style.borderColor='var(--accent)';this.style.color='var(--accent)';this.style.background='var(--accent-dim)'" onmouseout="this.style.borderColor='var(--border)';this.style.color='var(--text-muted)';this.style.background='rgba(255,255,255,0.02)'">Cloud</a>
      <a href="?q=Cyber" style="text-decoration: none; padding: 0.4rem 0.75rem; border: 1px solid var(--border); border-radius: 4px; font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; color: var(--text-muted); transition: all 0.15s; background: rgba(255,255,255,0.02);" onmouseover="this.style.borderColor='var(--accent)';this.style.color='var(--accent)';this.style.background='var(--accent-dim)'" onmouseout="this.style.borderColor='var(--border)';this.style.color='var(--text-muted)';this.style.background='rgba(255,255,255,0.02)'">Cyber</a>
      <a href="?q=DevSecOps" style="text-decoration: none; padding: 0.4rem 0.75rem; border: 1px solid var(--border); border-radius: 4px; font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; color: var(--text-muted); transition: all 0.15s; background: rgba(255,255,255,0.02);" onmouseover="this.style.borderColor='var(--accent)';this.style.color='var(--accent)';this.style.background='var(--accent-dim)'" onmouseout="this.style.borderColor='var(--border)';this.style.color='var(--text-muted)';this.style.background='rgba(255,255,255,0.02)'">DevSecOps</a>
      <a href="?q=DHS" style="text-decoration: none; padding: 0.4rem 0.75rem; border: 1px solid var(--border); border-radius: 4px; font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; color: var(--text-muted); transition: all 0.15s; background: rgba(255,255,255,0.02);" onmouseover="this.style.borderColor='var(--accent)';this.style.color='var(--accent)';this.style.background='var(--accent-dim)'" onmouseout="this.style.borderColor='var(--border)';this.style.color='var(--text-muted)';this.style.background='rgba(255,255,255,0.02)'">DHS</a>
      <a href="?q=541512" style="text-decoration: none; padding: 0.4rem 0.75rem; border: 1px solid var(--border); border-radius: 4px; font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; color: var(--text-muted); transition: all 0.15s; background: rgba(255,255,255,0.02);" onmouseover="this.style.borderColor='var(--accent)';this.style.color='var(--accent)';this.style.background='var(--accent-dim)'" onmouseout="this.style.borderColor='var(--border)';this.style.color='var(--text-muted)';this.style.background='rgba(255,255,255,0.02)'">NAICS 541512</a>
    </div>
  </div>
<footer class="hero-footer">
  <div class="footer-grid">

    <div class="footer-section">
      <div class="footer-label mono text-xs accent upper">Getting Started</div>
      
      <div style="margin-bottom: 1rem;">
        <ol class="steps-list" style="list-style: none; padding-left: 0;">
          <li style="margin-bottom: 1rem;">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
              <strong style="color: var(--text-primary);">Explore the Data</strong> 
            </div>
            <div style="font-size: 0.75rem; color: var(--text-primary); opacity: 0.7; line-height: 1.5;">
              Just type a keyword or a company name. If you want to be precise, you can use PSC or NAICS codes like <a href="?q=541512" style="color: var(--accent-light); text-decoration: underline;">541512</a>. Think of it as opening a map of where the work is currently happening.
            </div>
          </li>
          
          <li style="margin-bottom: 1rem;">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
              <strong style="color: var(--text-primary);">Follow the Money</strong>
            </div>
            <div style="font-size: 0.75rem; color: var(--text-primary); opacity: 0.7; line-height: 1.5;">
              Click on the bars in the chart to see how the money moves from the agency to the vendors. You'll start to see patterns, like who is teaming with whom and which contracts are ending soon.
            </div>
          </li>
          
          <li style="margin-bottom: 1rem;">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
              <strong style="color: var(--text-primary);">Make Connections</strong>
            </div>
            <div style="font-size: 0.75rem; color: var(--text-primary); opacity: 0.7; line-height: 1.5;">
              Once you find a lead, use the LinkedIn links to find the right person to talk to. I've even included some conversation starters to help you get the ball rolling without the stress.
            </div>
          </li>
        </ol>
      </div>
    </div>

    <div class="footer-section">
      <div class="footer-label mono text-xs accent upper">Why use Govhoo?</div>
      <div class="use-cases">
        
        <div class="use-case">
          <div class="use-case-title">
             Defend Your Base
          </div>
          <div class="use-case-desc">
            It's always good to look ahead. Check on your expiring contracts early so you aren't surprised when the recompete comes around.
          </div>
        </div>

        <div class="use-case">
          <div class="use-case-title">
            Find new Partners
          </div>
          <div class="use-case-desc">
            Use the subcontracting maps to see who's winning work in your space. It's the easiest way to find a partner who needs what you do.
          </div>
        </div>

        <div class="use-case">
          <div class="use-case-title">
            Grow Pipeline
          </div>
          <div class="use-case-desc">
            Sometimes the best opportunities are in agencies you haven't visited yet. We help you see where your competitors are active so you can find your own path in.
          </div>
        </div>
      </div>
    </div>

    <div class="footer-section">
      <div class="footer-label mono text-xs accent upper">Built by a Sales Guy</div>
      <p class="footer-text">
        <img src="https://govhoo.com/images/oldmark.jpg" alt="Mark Flournoy" class="tip-bio-img">Hi, I'm Mark, a retired federal sales guy and Marine. Over decades of selling at AWS, F5, and Red Hat, I spent too much time bouncing between USASpending, SAM.gov, and industry days just to figure out who the incumbents were. So I built Govhoo. It uses live award data to show who's winning the work so you can focus on the right conversations at the right time. And it's 100% free. If you need help with pipeline or planning, schedule a free 30 minute session below or DM me on <a href="https://www.linkedin.com/in/markflournoy/" target="_blank" class="footer-link"><i class="fab fa-linkedin" style="margin-right: 4px;"></i>LinkedIn</a>.
      </p>

      <div style="padding: 1rem; margin-top: 1.2rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px;">
        <div style="font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; font-weight: 700; color: #F1EEE9; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 0.5rem;">Need Help?</div>
        <div style="font-size: 0.7rem; color: var(--text-primary); opacity: 0.7; line-height: 1.4; margin-bottom: 1rem;">If you're feeling stuck or just want a second pair of eyes on your plan, I'm happy to help. Let's grab 30 minutes.</div>
        <a href="https://calendly.com/markflournoy/govhoo" target="_blank" style="text-decoration:none;">
          <button class="btn-primary" style="width: 100%; padding: 0.6rem; font-size: 0.75rem; justify-content: center;">
            <i class="fas fa-mug-hot"></i> Schedule a free chat
          </button>
        </a>
      </div>
    </div>

  </div>
</footer>
</div>

<div id="appView" style="display:none;">
  <header class="app-header">
    <div class="header-left">
      <span class="logo-btn" data-action="showHero"><span style="color: var(--accent);">>_</span>Govhoo</span>
      <div class="mini-search-wrapper">
  <input type="text" id="miniSearch" class="mini-search" placeholder="New search...">
</div>
    </div>
    <div class="header-actions">
      <button class="icon-btn icon-btn-share"
        data-action="shareLink"
        title="Copy Share Link">
  <i class="fas fa-link"></i>
</button>

<button class="icon-btn icon-btn-slack" data-action="shareBrief" title="Copy Brief for Slack/Teams">
  <i class="fa-brands fa-slack"></i>
</button>

<button class="icon-btn icon-btn-csv" title="Export CSV" data-action="exportCSV">
  <i class="fas fa-download"></i>
</button>
    </div>
  </header>

  <div id="dashboardContainer" class="dashboard-container">
    
    <div id="searchModeView" class="view-section active">
      
      <!-- Drill Navigation Controls -->
      <div id="drillControlsBar" class="drill-controls-bar" style="display: none; margin-bottom: 1rem; padding: 0.75rem 1rem; background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 6px; overflow: hidden;">
        <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 0.5rem;">
          <div id="drillBreadcrumb" class="drill-breadcrumb" style="display: flex; margin: 0; flex-wrap: wrap; min-width: 0;">
            <div class="breadcrumb-item" data-action="resetDrill">
              <i class="fas fa-globe breadcrumb-icon"></i>
              <span>All Agencies</span>
            </div>
          </div>
          <div style="display: flex; align-items: center; gap: 0.5rem;">
            <span id="drillLevelBadge" class="drill-level-indicator">
              <i class="fas fa-layer-group"></i>
              <span id="drillLevelText">Level 1</span>
            </span>
            <div id="filterBadge" class="filter-badge" data-action="clearFilter">
              <span id="filterName">FILTER</span> <i class="fas fa-times"></i>
            </div>
          </div>
        </div>
      </div>

      <!-- Agency Award Flow Sankey -->
      <div id="sankeyPanel" class="sankey-panel" style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 1.25rem; margin-bottom: 1rem; overflow: hidden;">
        
        <div style="margin-bottom: 1rem;">
          <div id="sankeySubtitle" style="font-family: 'JetBrains Mono', monospace; font-size: 0.6rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 0.5rem;">Last 12 Months · Top 100 Awards by Value</div>
          <div style="display: flex; align-items: baseline; gap: 1.5rem; flex-wrap: wrap;">
            <div id="stat-vol" style="font-family: 'JetBrains Mono', monospace; font-size: clamp(1.75rem, 5vw, 2.5rem); font-weight: 800; color: var(--text-primary); line-height: 1;">-</div>
            <div id="searchStatsCompact" style="display: flex; gap: 1.25rem; align-items: baseline; flex-wrap: wrap; margin-left: 0.5rem; padding-left: 1.5rem; border-left: 1px solid var(--border);">
              <div style="display: flex; align-items: baseline; gap: 0.35rem;">
                <span id="stat-agencies" style="font-family: 'JetBrains Mono', monospace; font-size: 1rem; font-weight: 700; color: var(--accent);">-</span>
                <span style="font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase;">Agencies</span>
              </div>
              <div style="display: flex; align-items: baseline; gap: 0.35rem;">
                <span id="stat-count" style="font-family: 'JetBrains Mono', monospace; font-size: 1rem; font-weight: 700; color: var(--accent);">-</span>
                <span style="font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase;">Contracts</span>
              </div>
              <div style="display: flex; align-items: baseline; gap: 0.35rem;">
                <span id="stat-vendors" style="font-family: 'JetBrains Mono', monospace; font-size: 1rem; font-weight: 700; color: var(--accent);">-</span>
                <span style="font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase;">Vendors</span>
              </div>
            </div>
          </div>
        </div>

        <div class="chart-wrapper" style="border: none; padding: 0; background: transparent; overflow-x: auto; overflow-y: visible;">
          <div id="chartContainer" class="chart-container"></div>
        </div>
        <div style="display: flex; align-items: center; justify-content: space-between; margin-top: 1rem; padding-top: 0.75rem; border-top: 1px solid var(--border); font-size: 0.65rem; color: var(--text-muted);">
          <span>Data: USASpending.gov</span>
          <span style="font-family: 'JetBrains Mono', monospace;"><span style="color: var(--accent);">>_</span>Govhoo.com</span>
        </div>
      </div>
      
      <div id="drillHint" class="drill-hint" style="display:none;">
        <i class="fas fa-mouse-pointer"></i>
        <span>Click an <strong>agency bar</strong> to drill into sub-agencies</span>
      </div>

      <div id="searchJobPanel" style="margin: 0 0 1.5rem 0; padding: 0; position: relative;">
  <div class="intel-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem 1.5rem;">
    
    <div>
      <div class="section-header" style="margin: 0 0 0.75rem 0;">
        <div class="section-title-group">
          <span class="section-title mono bold upper text-xs" style="color: var(--info);">Agencies</span>
        </div>
      </div>
      <div class="analysis-panel" style="min-height: auto;">
        <div class="analysis-panel-body intel-stagger-1" id="searchTopBuyersBody" style="padding: 0.75rem;">
          <div class="muted text-xs" style="text-align:center;">Agencies awarding contracts will appear here</div>
        </div>
      </div>
    </div>
    
    <div>
      <div class="section-header" style="margin: 0 0 0.75rem 0;">
        <div class="section-title-group">
          <span class="section-title mono bold accent upper text-xs">Winners</span>
        </div>
      </div>
      <div class="analysis-panel" style="min-height: auto;">
        <div class="analysis-panel-body intel-stagger-2" id="searchTopWinnersBody" style="padding: 0.75rem;">
          <div class="muted text-xs" style="text-align:center;">Prime contractors winning awards will appear here</div>
        </div>
      </div>
    </div>

    <div>
      <div class="section-header" style="margin: 0 0 0.75rem 0;">
        <div class="section-title-group">
          <span class="section-title mono bold upper text-xs" style="color: var(--text-muted);">Locations</span>
        </div>
      </div>
      <div class="analysis-panel" style="min-height: auto;">
        <div class="analysis-panel-body intel-stagger-3" id="searchLocationsBody" style="padding: 0.75rem;">
          <div class="muted text-xs" style="text-align:center;">Where the work happens will appear here</div>
        </div>
      </div>
    </div>

    <div>
      <div class="section-header" style="margin: 0 0 0.75rem 0;">
        <div class="section-title-group">
          <span class="section-title mono bold upper text-xs" style="color: var(--text-muted);">Key Terms</span>
        </div>
      </div>
      <div class="analysis-panel" style="min-height: auto;">
        <div class="analysis-panel-body intel-stagger-4" id="searchSkillsBody" style="padding: 0.75rem;">
          <div class="muted text-xs" style="text-align:center;">Key terms from results will appear here</div>
        </div>
      </div>
    </div>

  </div>
</div>

<div id="actionBar" style="display: flex; gap: 0.75rem; margin: 0 0 1.5rem 0; flex-wrap: wrap; align-items: stretch; padding: 1.25rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; position: relative;">
        <div class="action-bar-label">Toolbox</div>
       <button class="btn-primary" data-action="openConvoStarters" id="convoStartersBtn" style="width: 100%; padding: 0.6rem; font-size: 0.75rem; justify-content: center; flex: 1; min-width: 130px;">
    Ice Breakers
  </button>
  
  <button class="btn-primary" id="gtmPlanBtn" data-action="openSalesPlan" style="display: none; width: 100%; padding: 0.6rem; font-size: 0.75rem; justify-content: center; flex: 1; min-width: 130px;">
    GTM Plan
  </button>
  
  <button class="btn-primary" id="pipelineBtn" data-action="openPipelineBuilder" style="display: none; width: 100%; padding: 0.6rem; font-size: 0.75rem; justify-content: center; flex: 1; min-width: 130px;">
    Pipeline Builder
  </button>
      </div>

      <div id="recompetesList" style="margin-bottom: 1.5rem;"></div>

      <div class="section-header">
        <div class="section-title-group">
          <span class="section-title">Recent Awards</span>
        </div>
      </div>
      <div id="feedGrid" class="feed-grid"></div>

      <div id="subawardWrapper" style="display: none;">      
        <div style="margin-top: 1.5rem;">
          <div id="subcontractingPanel" style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 1.25rem; overflow: hidden;">
            <div id="subcontractingStats" style="margin-bottom: 1rem;">
  <div style="font-family: 'JetBrains Mono', monospace; font-size: 0.6rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 0.5rem;">Subcontracting Activity · Prime → Sub Flow</div>
  <div style="display: flex; align-items: baseline; gap: 1.5rem; flex-wrap: wrap;">
    <div id="sub-stat-vol" style="font-family: 'JetBrains Mono', monospace; font-size: clamp(1.75rem, 5vw, 2.5rem); font-weight: 800; color: #F1EEE9; line-height: 1;">-</div>
    
    <div style="display: flex; gap: 1.25rem; align-items: baseline; flex-wrap: wrap; margin-left: 0.5rem; padding-left: 1.5rem; border-left: 1px solid var(--border);">
      <div style="display: flex; align-items: baseline; gap: 0.35rem;">
        <span id="sub-stat-primes" style="font-family: 'JetBrains Mono', monospace; font-size: 1rem; font-weight: 700; color: #F1EEE9;">-</span>
        <span style="font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase;">Primes</span>
      </div>
      <div style="display: flex; align-items: baseline; gap: 0.35rem;">
        <span id="sub-stat-subs" style="font-family: 'JetBrains Mono', monospace; font-size: 1rem; font-weight: 700; color: #F1EEE9;">-</span>
        <span style="font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase;">Subs</span>
      </div>
      <div style="display: flex; align-items: baseline; gap: 0.35rem;">
        <span id="sub-stat-count" style="font-family: 'JetBrains Mono', monospace; font-size: 1rem; font-weight: 700; color: #F1EEE9;">-</span>
        <span style="font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase;">Records</span>
      </div>
    </div>
  </div>
</div>
            <div class="chart-wrapper" style="border: none; padding: 0; background: transparent; overflow-x: auto; overflow-y: visible;">
              <div id="subcontractingBody" style="min-height: 350px;"></div>
            </div>
          </div>
        </div>
      </div>

      <div id="subConvoStartersPanel" style="margin: 1.5rem 0; padding: 1.25rem; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; display: none; align-items: center; justify-content: space-between; gap: 1rem;">
  <button class="convo-starters-btn" data-action="openSubConvoStarters" id="subConvoStartersBtn">
    Conversation Starters
  </button>
</div>

<div id="searchSubcontractPanel" style="margin: 1.5rem 0; padding: 0;">
  <div class="intel-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
    
    <div>
      <div class="section-header" style="margin: 0 0 0.75rem 0;">
        <div class="section-title-group">
          <span class="section-title mono bold upper text-xs" style="color: var(--info);">Primes</span>
        </div>
      </div>
      <div class="analysis-panel" style="min-height: auto;">
        <div class="analysis-panel-body" id="searchTopPrimesBody" style="padding: 0.75rem;">
          <div class="muted text-xs" style="text-align:center;">Primes subcontracting work will appear here</div>
        </div>
      </div>
    </div>
    
    <div>
      <div class="section-header" style="margin: 0 0 0.75rem 0;">
        <div class="section-title-group">
          <span class="section-title mono bold accent upper text-xs">Subs</span>
        </div>
      </div>
      <div class="analysis-panel" style="min-height: auto;">
        <div class="analysis-panel-body" id="searchTopSubsBody" style="padding: 0.75rem;">
          <div class="muted text-xs" style="text-align:center;">Subcontractors receiving work will appear here</div>
        </div>
      </div>
    </div>
    
  </div>
</div>

      <div id="subFeedWrapper" style="display: none; margin-top: 1.5rem;">
        <div class="section-header">
          <div class="section-title-group">
            <span class="section-title">Recent Subcontracts</span>
          </div>
        </div>
        <div id="subFeedGrid" class="feed-grid"></div>
      </div>

    </div> </div>
</div>
<div id="loader" class="loader">
  <div class="spinner"></div>
  <p id="loaderText" style="margin-top:1rem; font-family:'JetBrains Mono'; color:var(--accent);">RETRIEVING DATA...</p>
  <p id="loaderSubtext" style="color:var(--text-subtle); font-size:0.8rem; margin-top:0.5rem;"></p>
</div>

<div id="salesPlanModal" class="channel-marking-modal">
  <div class="channel-modal-content" style="max-width: 900px;">
    <div class="channel-modal-header">
      <div class="channel-modal-title"><span class="sub-bullet orange"><i class="fas fa-rocket"></i></span> GTM PLAN PROMPT</div>
      <button class="channel-modal-close" data-action="closeSalesPlan"><i class="fas fa-times"></i></button>
    </div>
    
    <div class="channel-modal-body" style="flex:1; overflow-y:auto; padding:0;">
      
      <div id="spIntentBanner"></div>
      
      <div class="modal-step-section">
        <div class="modal-step-label">
          <span class="sub-bullet sm orange"><i class="fas fa-bullseye"></i></span> Step 1: Define Plan Scope
        </div>
        <div class="modal-step-grid step-grid">
          <div>
            <label class="modal-form-label">
              PLAN SCOPE / SECTOR
            </label>
            <select id="spScope" class="main-input modal-select">
              <option value="all">Entire Market (All Results)</option>
              <option value="defense">Defense (DoD & Branches)</option>
              <option value="civilian">Federal Civilian (Non-DoD)</option>
              <optgroup label="Specific Agencies" id="spSpecificAgencies"></optgroup>
            </select>
          </div>
          <div>
            <label class="modal-form-label">
              STRATEGIC GOAL
              <span style="cursor:help; margin-left:4px;" title="Growth = New business pursuit&#10;Retention = Defend existing contracts&#10;Partnership = Channel/partner optimization">ⓘ</span>
            </label>
            <select id="spFocus" class="main-input modal-select">
              <option value="Growth">Aggressive Growth (New Business)</option>
              <option value="Retention">Retention (Defend Incumbency)</option>
              <option value="Partnership">Partner/Channel Strategy</option>
            </select>
          </div>
        </div>
      </div>

      <div class="modal-body-section">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
          <div class="modal-step-label" style="margin-bottom:0;">
            <span class="sub-bullet sm orange"><i class="fas fa-sitemap"></i></span> Step 2: Classify Vendors
          </div>
          <div id="spBulkActionContainer"></div>
        </div>
        


        <div id="spVendorList"></div>
      </div>
      
      <div id="spPreviewSection" style="display:none; border-top: 1px solid var(--border);">
        <div class="modal-step-section" style="padding: 1rem 1.5rem;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.75rem;">
            <div class="modal-step-label" style="margin-bottom:0;">
              <i class="fas fa-eye"></i> Prompt Preview
            </div>
            <span style="font-size:0.7rem; color:var(--text-muted); font-family:'JetBrains Mono',monospace;" id="spPreviewStats"></span>
          </div>
          <pre id="spPreviewContent" style="background:var(--bg-app); border:1px solid var(--border); border-radius:4px; padding:1rem; font-size:0.75rem; color:var(--text-muted); font-family:'JetBrains Mono',monospace; max-height:300px; overflow-y:auto; white-space:pre-wrap; word-wrap:break-word; line-height:1.5;"></pre>
        </div>
      </div>
    </div>

    <div class="channel-modal-footer">
      <div class="modal-footer-buttons">
        <button id="btnCopyPrompt" class="modal-btn modal-btn-primary" data-action="copyPrompt">
          <i class="fas fa-copy"></i> Copy Prompt
        </button>
        <div class="modal-footer-secondary">
          <button class="modal-btn modal-btn-cancel" onclick="SalesPlanManager.togglePreview()" title="Preview the prompt before copying">
            <i class="fas fa-eye"></i> Preview
          </button>
          <button class="modal-btn modal-btn-cancel" data-action="generateDownload" title="Save prompt as a .txt file for offline use">
            <i class="fas fa-download"></i> Save
          </button>
          <button class="modal-btn modal-btn-cancel" data-action="closeSalesPlan">Cancel</button>
        </div>
      </div>
      <div id="spDataStatus" class="modal-status-line"></div>
    </div>
  </div>
</div>

<div id="pipelineBuilderModal" class="pipeline-modal">
  <div class="pipeline-modal-content">
    <div class="channel-modal-header">
      <div class="channel-modal-title"><span class="sub-bullet"><i class="fas fa-chart-line"></i></span> ANNUAL PIPELINE BUILDER</div>
      <button class="channel-modal-close" data-action="closePipelineBuilder"><i class="fas fa-times"></i></button>
    </div>
    
    <div class="channel-modal-body" style="flex:1; overflow-y:auto; padding:1.5rem;">
      <div class="modal-info-box success">
        <strong><i class="fas fa-info-circle" style="color:var(--success);"></i> How it works:</strong> 
        This tool analyzes historical USAspending data to identify cyclic spending patterns and generates pipeline opportunities for the upcoming fiscal year. Defaults are tuned for most searches — just hit Generate, then adjust if needed.
      </div>
      
      <div class="pipeline-config-row">
        <div class="pipeline-config-item">
          <label>Target Fiscal Year</label>
          <select id="pipelineTargetFY"></select>
        </div>
        <div class="pipeline-config-item">
          <label>Historical Years to Analyze</label>
          <select id="pipelineHistoryYears">
            <option value="2">2 Years</option>
            <option value="3" selected>3 Years</option>
            <option value="4">4 Years</option>
            <option value="5">5 Years</option>
          </select>
        </div>
        <div class="pipeline-config-item">
          <label>Probability Multiplier</label>
          <select id="pipelineProbMultiplier">
            <option value="0.5">Conservative (50%)</option>
            <option value="0.7" selected>Moderate (70%)</option>
            <option value="0.9">Aggressive (90%)</option>
            <option value="1.0">Full Historical (100%)</option>
          </select>
        </div>
      </div>
      
      <div class="pipeline-config-row">
        <div class="pipeline-config-item">
          <label>Minimum Deal Size</label>
          <select id="pipelineMinDeal">
            <option value="0">No Minimum</option>
            <option value="25000">$25K+</option>
            <option value="50000" selected>$50K+</option>
            <option value="100000">$100K+</option>
            <option value="250000">$250K+</option>
            <option value="500000">$500K+</option>
            <option value="1000000">$1M+</option>
          </select>
        </div>
        <div class="pipeline-config-item">
          <label>Focus Agency (Optional)</label>
          <select id="pipelineFocusAgency">
            <option value="">All Agencies in Results</option>
          </select>
        </div>
      </div>
      
      <button class="pipeline-builder-btn" style="width:100%; padding: 0.85rem; font-size: 0.85rem; margin-top: 0.75rem;" data-action="generatePipeline">
        <i class="fas fa-magic"></i> Generate Pipeline
      </button>
      
      <div id="pipelineResultsArea" style="display:none;">
        <div style="display:flex; align-items:baseline; gap:1rem; margin:1.5rem 0 1rem 0; flex-wrap:wrap;">
          <span id="pipelineResultCount" style="font-family:'JetBrains Mono',monospace; font-size:clamp(1.5rem, 4vw, 2rem); font-weight:800; color:var(--text-primary); line-height:1;"></span>
          <span style="font-family:'JetBrains Mono',monospace; font-size:0.7rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px;">opportunities ready for Salesforce</span>
        </div>
        
        <div id="pipelineStatsGrid" class="pipeline-results-grid"></div>
        <div id="pipelineTableContainer" class="pipeline-table-wrapper"></div>
      </div>
      
      <div id="pipelineLoading" class="pipeline-progress" style="display:none;">
        <div class="spinner"></div>
        <span>Analyzing historical spending patterns...</span>
      </div>
    </div>
    
    <div class="channel-modal-footer">
      <div class="modal-footer-buttons">
        <button id="btnDownloadPipeline" class="modal-btn modal-btn-primary" data-action="downloadPipelineCSV" style="background:var(--success);" disabled>
          <i class="fas fa-download"></i> Download CSV
        </button>
        <div class="modal-footer-secondary">
          <button class="modal-btn modal-btn-cancel" data-action="closePipelineBuilder">Close</button>
        </div>
      </div>
      <div id="pipelineDataStatus" class="modal-status-line">Configure options and click Generate to build your pipeline.</div>
    </div>
  </div>
</div>

<div id="convoStartersModal" class="convo-modal">
  <div class="convo-modal-content">
    <div class="channel-modal-header">
      <div class="channel-modal-title"><span class="sub-bullet blue"><i class="fas fa-comments"></i></span> CONVERSATION STARTERS</div>
      <button class="channel-modal-close" data-action="closeConvoStarters"><i class="fas fa-times"></i></button>
    </div>
    
    <div class="channel-modal-body" style="flex:1; overflow-y:auto; padding:1.25rem;">
      <div class="convo-focus-toggle">
        <button class="convo-focus-btn active" data-convo-focus="agencies" onclick="ConvoStarters.setFocus('agencies')">
          <span class="sub-bullet sm blue"><i class="fas fa-landmark"></i></span> Agencies
        </button>
        <button class="convo-focus-btn" data-convo-focus="vendors" onclick="ConvoStarters.setFocus('vendors')">
          <span class="sub-bullet sm"><i class="fas fa-building"></i></span> Vendors
        </button>
        <button class="convo-focus-btn" data-convo-focus="both" onclick="ConvoStarters.setFocus('both')">
          <span class="sub-bullet sm gray"><i class="fas fa-users"></i></span> Both
        </button>
      </div>
      
      <div id="convoResultsArea" class="convo-results-scroll">
        <div class="convo-empty">
          <i class="fas fa-spinner fa-spin"></i>
          <p>Generating talking points...</p>
        </div>
      </div>
    </div>
    
    <div class="channel-modal-footer">
      <div class="modal-footer-buttons">
        <button class="modal-btn modal-btn-primary" data-action="copyAllConvo" style="background: var(--info);">
          <i class="fas fa-copy"></i> Copy
        </button>
        <button class="modal-btn modal-btn-primary" data-action="downloadConvoPDF" style="background: var(--accent);" title="Save as .txt to AirDrop or email to your phone before the event">
          <i class="fas fa-mobile-alt"></i> Download
        </button>
        <div class="modal-footer-secondary">
          <button class="modal-btn modal-btn-cancel" data-action="closeConvoStarters">Close</button>
        </div>
      </div>
      <div id="convoDataStatus" class="modal-status-line">Based on <span id="convoAwardCount">0</span> awards from your search.</div>
    </div>
  </div>
</div>
<script>
// ========================================
// SECTION 1: CONSTANTS & CONFIG
// ========================================
const US_STATES = {
  'AL':'Alabama','AK':'Alaska','AZ':'Arizona','AR':'Arkansas','CA':'California',
  'CO':'Colorado','CT':'Connecticut','DE':'Delaware','FL':'Florida','GA':'Georgia',
  'HI':'Hawaii','ID':'Idaho','IL':'Illinois','IN':'Indiana','IA':'Iowa',
  'KS':'Kansas','KY':'Kentucky','LA':'Louisiana','ME':'Maine','MD':'Maryland',
  'MA':'Massachusetts','MI':'Michigan','MN':'Minnesota','MS':'Mississippi','MO':'Missouri',
  'MT':'Montana','NE':'Nebraska','NV':'Nevada','NH':'New Hampshire','NJ':'New Jersey',
  'NM':'New Mexico','NY':'New York','NC':'North Carolina','ND':'North Dakota','OH':'Ohio',
  'OK':'Oklahoma','OR':'Oregon','PA':'Pennsylvania','RI':'Rhode Island','SC':'South Carolina',
  'SD':'South Dakota','TN':'Tennessee','TX':'Texas','UT':'Utah','VT':'Vermont',
  'VA':'Virginia','WA':'Washington','WV':'West Virginia','WI':'Wisconsin','WY':'Wyoming',
  'DC':'Washington DC','PR':'Puerto Rico','GU':'Guam','VI':'Virgin Islands'
};

// ========================================
// SECTION 2: LIBRARY LOADER (Smart Preloading)
// ========================================
const LibLoader = {
  d3Loaded: false,
  chartLoaded: false,
  loading: { d3: null, chart: null },
  
  async loadD3() {
    if (this.d3Loaded && window.d3 && window.d3.sankey) return Promise.resolve();
    if (this.loading.d3) return this.loading.d3;
    
    this.loading.d3 = new Promise((resolve, reject) => {
      const script1 = document.createElement('script');
      script1.src = 'https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js';
      script1.onload = () => {
        const script2 = document.createElement('script');
        script2.src = 'https://cdnjs.cloudflare.com/ajax/libs/d3-sankey/0.12.3/d3-sankey.min.js';
        script2.onload = () => { this.d3Loaded = true; resolve(); };
        script2.onerror = reject;
        document.head.appendChild(script2);
      };
      script1.onerror = reject;
      document.head.appendChild(script1);
    });
    return this.loading.d3;
  },
  
async loadChart() {
    // Chart.js is not used, so we skip loading it to save ~200KB
    return Promise.resolve();
  },
  
  async ensureAll() {
    // Only wait for D3 since Chart.js is removed
    await this.loadD3();
  },
  
  // Preload during idle time - runs after page load for instant first search
  preloadWhenIdle() {
    if ('requestIdleCallback' in window) {
      requestIdleCallback(() => this.ensureAll(), { timeout: 2000 });
    } else {
      setTimeout(() => this.ensureAll(), 100);
    }
  }
};

// ========================================
// SECTION 3: UTILITIES
// ========================================
const Utils = {
  copyDealToClipboard(idx, btn) {
    const c = App.searchData.active[idx];
    if (!c) return;
    const internalId = c['generated_internal_id'];
    let url = '';
    if (internalId) url = `https://www.usaspending.gov/award/${internalId}`;
    const vehicle = VehicleDetector.detect(c['Award ID']);
    const setAside = VehicleDetector.getSetAsideLabel(c['Type of Set Aside']);
    const text = [
      `Agency: ${c['Awarding Agency'] || 'N/A'}`,
      c['Awarding Sub Agency'] && c['Awarding Sub Agency'] !== c['Awarding Agency'] ? `Sub-Agency: ${c['Awarding Sub Agency']}` : null,
      `Vendor: ${c['Recipient Name'] || 'N/A'}`,
      `Amount: ${Utils.money(c['Award Amount'])}`,
      `Description: ${(c['Description'] || 'N/A').substring(0, 200)}`,
      `Start: ${c['Start Date'] || 'N/A'}`,
      `End: ${c['End Date'] || 'N/A'}`,
      c['Award ID'] ? `Award ID: ${c['Award ID']}` : null,
      vehicle ? `Vehicle: ${vehicle.vehicle}` : null,
      setAside ? `Set-Aside: ${setAside}` : null,
      c['NAICS Code'] ? `NAICS: ${c['NAICS Code']} - ${c['NAICS Description'] || ''}` : null,
      c['PSC Code'] ? `PSC: ${c['PSC Code']} - ${c['PSC Description'] || ''}` : null,
      url ? `Link: ${url}` : null
    ].filter(Boolean).join('\n');
    navigator.clipboard.writeText(text).then(() => {
      if (btn) { btn.innerHTML = '<i class="fas fa-check"></i>'; btn.style.color = 'var(--accent)'; setTimeout(() => { btn.innerHTML = '<i class="fas fa-copy"></i>'; btn.style.color = ''; }, 1500); }
    });
  },
  copySubDealToClipboard(dataStr, btn) {
    try {
      const s = JSON.parse(decodeURIComponent(dataStr));
      const url = s.prime_award_generated_internal_id ? `https://www.usaspending.gov/award/${s.prime_award_generated_internal_id}` : '';
      const text = [
        `Type: Subcontract`,
        `Agency: ${s['Awarding Agency'] || 'N/A'}`,
        `Prime: ${s['Prime Recipient Name'] || 'N/A'}`,
        `Subcontractor: ${s['Sub-Awardee Name'] || 'N/A'}`,
        `Amount: ${Utils.money(parseFloat(s['Sub-Award Amount']) || 0)}`,
        `Date: ${s['Sub-Award Date'] || 'N/A'}`,
        url ? `Prime Award: ${url}` : null
      ].filter(Boolean).join('\n');
      navigator.clipboard.writeText(text).then(() => {
        if (btn) { btn.innerHTML = '<i class="fas fa-check"></i>'; btn.style.color = 'var(--accent)'; setTimeout(() => { btn.innerHTML = '<i class="fas fa-copy"></i>'; btn.style.color = ''; }, 1500); }
      });
    } catch(e) { console.error('Copy failed', e); }
  },
  copyRecompeteToClipboard(btn, agency, subAgency, vendor, amount, desc, start, end, awardId, psc, pscDesc, naics, naicsDesc, setAside, url) {
    const vehicle = VehicleDetector.detect(awardId);
    const setAsideLabel = VehicleDetector.getSetAsideLabel(setAside);
    const text = [
      `EXPIRING CONTRACT`,
      `Agency: ${agency || 'N/A'}`,
      subAgency && subAgency !== agency ? `Sub-Agency: ${subAgency}` : null,
      `Incumbent: ${vendor || 'N/A'}`,
      `Amount: ${amount}`,
      `Description: ${desc || 'N/A'}`,
      `Start: ${start || 'N/A'}`,
      `Expires: ${end || 'N/A'}`,
      awardId ? `Award ID: ${awardId}` : null,
      vehicle ? `Vehicle: ${vehicle.vehicle}` : null,
      setAsideLabel ? `Set-Aside: ${setAsideLabel}` : null,
      naics ? `NAICS: ${naics} - ${naicsDesc || ''}` : null,
      psc ? `PSC: ${psc} - ${pscDesc || ''}` : null,
      url ? `Link: ${url}` : null
    ].filter(Boolean).join('\n');
    navigator.clipboard.writeText(text).then(() => {
      if (btn) { btn.innerHTML = '<i class="fas fa-check"></i>'; btn.style.color = 'var(--accent)'; setTimeout(() => { btn.innerHTML = '<i class="fas fa-copy"></i>'; btn.style.color = ''; }, 1500); }
    });
  },
  money: n => {
    if (!n && n !== 0) return '-';
    if(n >= 1e9) return '$' + (n/1e9).toFixed(1) + 'B';
    if(n >= 1e6) return '$' + (n/1e6).toFixed(1) + 'M';
    if(n >= 1e3) return '$' + (n/1e3).toFixed(0) + 'K';
    return '$' + Math.round(n).toLocaleString();
  },
  trunc: (s, l) => (s && s.length > l) ? s.substring(0,l)+'...' : (s || 'No Description'),
  date: s => s ? new Date(s).toLocaleDateString() : '—',
  formatDateISO: date => date.toISOString().split('T')[0],
  
  getCurrentFY: () => {
    const now = new Date();
    // Federal FY starts Oct 1 (Month 9)
    return now.getMonth() >= 9 ? now.getFullYear() + 1 : now.getFullYear();
  },

  getCurrentQuarter: () => {
    const m = new Date().getMonth(); // 0-11
    if (m >= 9) return 1;
    if (m <= 2) return 2;
    if (m <= 5) return 3;
    return 4;
  },
  
getColor: (() => {
  const palette = [
    '#5C8070', // 1. Faded Ranger Green (Base)
    '#C49A9A', // 2. Dusty Rose (Replaces Clay - Soft, pressed flower pink)
    '#6C86A8', // 3. Hazy Lake Blue (Vintage denim)
    '#9AA0A3', // 4. Granite Rock (Neutral cool grey)
    '#D6CFC2', // 5. Old Topo Map (Paper beige)
    '#8F705C', // 6. Worn Leather (Brown)
    '#6E8DA6', // 7. Weathered Steel Sign
    '#7C8A6B', // 8. Dry Grass (Muted Olive)
    '#9E6B6B', // 9. Old Brick (Darker red-brown to contrast with Rose)
    '#8596A3'  // 10. Foggy Slate
  ];

  const assigned = new Map();
  let nextIdx = 0;

  const fn = name => {
    // Safety check
    if (!name) return '#4A4A4A';

    // "Unknowns" get a deep charcoal like old printer ink
    if (name.includes('Other') || name.includes('Unknown')) return '#363330';
    
    if (!assigned.has(name)) assigned.set(name, nextIdx++);
    return palette[assigned.get(name) % palette.length];
  };

  fn.reset = () => { assigned.clear(); nextIdx = 0; };
  return fn;
})(),
queryAliases: {
  // Big Tech & Defense Primes
  'aws': 'Amazon',
  'gcp': 'Google Cloud',
  'msft': 'Microsoft',
  'ibm': 'International Business Machines',
  'hp': 'Hewlett Packard',
  'hpe': 'Hewlett Packard Enterprise',
  'dell': 'Dell Technologies',
  'gd': 'General Dynamics',
  'gdit': 'General Dynamics Information Technology',
  'lmco': 'Lockheed Martin',
  'ngc': 'Northrop Grumman',
  'bah': 'Booz Allen Hamilton',
  'saic': 'Science Applications International',
  
  // Cabinet Departments
  'dod': 'Department of Defense',
  'doj': 'Department of Justice',
  'dhs': 'Department of Homeland Security',
  'hhs': 'Health and Human Services',
  'dot': 'Department of Transportation',
  'doe': 'Department of Energy',
  'doi': 'Department of the Interior',
  'dol': 'Department of Labor',
  'doc': 'Department of Commerce',
  'dos': 'Department of State',
  'ed': 'Department of Education',
  'hud': 'Housing and Urban Development',
  'usda': 'Department of Agriculture',
  'va': 'Veterans Affairs',
  
  // Defense & Intel
  'army': 'Department of the Army',
  'navy': 'Department of the Navy',
  'usaf': 'Department of the Air Force',
  'ussf': 'Space Force',
  'usmc': 'Marine Corps',
  'cia': 'Central Intelligence Agency',
  'nsa': 'National Security Agency',
  'nga': 'National Geospatial-Intelligence Agency',
  'nro': 'National Reconnaissance Office',
  'dia': 'Defense Intelligence Agency',
  'disa': 'Defense Information Systems Agency',
  'darpa': 'Defense Advanced Research Projects Agency',
  'dcsa': 'Defense Counterintelligence and Security Agency',
  'dla': 'Defense Logistics Agency',
  'mda': 'Missile Defense Agency',
  'socom': 'Special Operations Command',
  'cybercom': 'Cyber Command',
  'stratcom': 'Strategic Command',
  'transcom': 'Transportation Command',
  'centcom': 'Central Command',
  'eucom': 'European Command',
  'indopacom': 'Indo-Pacific Command',
  'northcom': 'Northern Command',
  'southcom': 'Southern Command',
  'africom': 'Africa Command',
  
  // Major Agencies
  'gsa': 'General Services Administration',
  'nasa': 'National Aeronautics and Space Administration',
  'fbi': 'Federal Bureau of Investigation',
  'dea': 'Drug Enforcement Administration',
  'atf': 'Bureau of Alcohol Tobacco Firearms and Explosives',
  'usps': 'Postal Service',
  'irs': 'Internal Revenue Service',
  'epa': 'Environmental Protection Agency',
  'fda': 'Food and Drug Administration',
  'cdc': 'Centers for Disease Control and Prevention',
  'nih': 'National Institutes of Health',
  'cms': 'Centers for Medicare and Medicaid Services',
  'ssa': 'Social Security Administration',
  'opm': 'Office of Personnel Management',
  'sba': 'Small Business Administration',
  'fema': 'Federal Emergency Management Agency',
  'tsa': 'Transportation Security Administration',
  'cbp': 'Customs and Border Protection',
  'ice': 'Immigration and Customs Enforcement',
  'uscis': 'Citizenship and Immigration Services',
  'usss': 'Secret Service',
  'cisa': 'Cybersecurity and Infrastructure Security Agency',
  'faa': 'Federal Aviation Administration',
  'fhwa': 'Federal Highway Administration',
  'fra': 'Federal Railroad Administration',
  'fta': 'Federal Transit Administration',
  'noaa': 'National Oceanic and Atmospheric Administration',
  'nist': 'National Institute of Standards and Technology',
  'census': 'Census Bureau',
  'ita': 'International Trade Administration',
  'blm': 'Bureau of Land Management',
  'nps': 'National Park Service',
  'usfs': 'Forest Service',
  'fws': 'Fish and Wildlife Service',
  'usgs': 'Geological Survey',
  'bia': 'Bureau of Indian Affairs',
  'boem': 'Bureau of Ocean Energy Management',
  'bor': 'Bureau of Reclamation',
  'ferc': 'Federal Energy Regulatory Commission',
  'nnsa': 'National Nuclear Security Administration',
  'sec': 'Securities and Exchange Commission',
  'ftc': 'Federal Trade Commission',
  'fcc': 'Federal Communications Commission',
  'nlrb': 'National Labor Relations Board',
  'eeoc': 'Equal Employment Opportunity Commission',
  'gao': 'Government Accountability Office',
  'omb': 'Office of Management and Budget',
  'cbo': 'Congressional Budget Office',
  'nara': 'National Archives and Records Administration',
  'pbgc': 'Pension Benefit Guaranty Corporation',
  'usaid': 'Agency for International Development',
  'amtrak': 'Amtrak',
  'fdic': 'Federal Deposit Insurance Corporation',
  'ncua': 'National Credit Union Administration',
  'cfpb': 'Consumer Financial Protection Bureau',
  'exim': 'Export-Import Bank'
},
normalizeQuery(query) {
  const lower = query.toLowerCase().trim();
  return this.queryAliases[lower] || query;
},
  missionGapRisk(award) {
    const endDate = new Date(award['End Date']);
    const daysUntil = Math.ceil((endDate - new Date()) / (1000 * 60 * 60 * 24));

    const amt = parseFloat(award['Award Amount']) || 0;

    const desc = (award['Description'] || '').toLowerCase();
    const pscDesc = (award['PSC Description'] || '').toLowerCase();
    const naicsDesc = (award['NAICS Description'] || '').toLowerCase();
    const psc = (award['PSC Code'] || '').toUpperCase();

    // Ongoing support signals - tune this list over time
    const supportTerms = [
      'operations', 'o&m', 'maintenance', 'sustainment', 'help desk', 'service desk',
      'support services', 'managed services', 'hosting', 'cloud', 'network',
      'cyber', 'security', 'monitoring', 'soc', 'continuity', 'backup', 'dr', 'patch',
      'infrastructure', 'enterprise', 'mission', 'critical', '24/7', 'production'
    ];

    const text = `${desc} ${pscDesc} ${naicsDesc}`;
    const supportHits = supportTerms.filter(t => text.includes(t));
    const looksOperational = supportHits.length >= 2;

    // PSC shortcuts - common federal service families
    // D = IT/Data Processing, R = Professional Services, J = Maintenance/Repair
    const servicePscPrefixes = ['D', 'R', 'J'];
    const isServicePsc = servicePscPrefixes.includes(psc.slice(0, 1));

    // Risk logic
    if (daysUntil <= 180 && (looksOperational || isServicePsc) && amt >= 250000) {
      return { level: 'high', daysUntil, reasons: supportHits.slice(0, 4) };
    }
    if (daysUntil <= 365 && (looksOperational || isServicePsc) && amt >= 100000) {
      return { level: 'medium', daysUntil, reasons: supportHits.slice(0, 3) };
    }
    return { level: 'low', daysUntil, reasons: supportHits.slice(0, 2) };
  },
  
  // Consolidated search term parser - eliminates duplication across API methods
  parseSearchTerms(keywords) {
    const pscPattern = /^[A-Z]\d{1,3}$|^\d{1,2}[A-Z]\d{0,2}$/i;
    const naicsPattern = /^\d{6}$/; // NAICS codes are exactly 6 digits
    const terms = keywords.split(',').map(s => s.trim()).filter(s => s.length > 0);
    const pscCodes = terms.filter(t => pscPattern.test(t)).map(t => t.toUpperCase());
    const naicsCodes = terms.filter(t => naicsPattern.test(t));
    const keywordTerms = terms.filter(t => !pscPattern.test(t) && !naicsPattern.test(t));
    return { pscCodes, naicsCodes, keywordTerms, allTerms: terms };
  },
  
  // Build filters for API calls - consolidates filter building logic
  buildFilters(keywords, timePeriods) {
    const { pscCodes, naicsCodes, keywordTerms } = this.parseSearchTerms(keywords);
    const filters = { time_period: timePeriods, award_type_codes: ['A','B','C','D'] };
    if (pscCodes.length > 0) filters.psc_codes = pscCodes;
    if (naicsCodes.length > 0) filters.naics_codes = naicsCodes;
    if (keywordTerms.length > 0) filters.keywords = keywordTerms;
    if (!filters.psc_codes && !filters.naics_codes && !filters.keywords) filters.keywords = [keywords];
    return filters;
  }
};

// ==================== MODAL UTILITIES ====================
const ModalUtils = {
  activeModal: null,
  previousFocus: null,
  _boundKeydown: null,
  _boundClick: null,

  open(modalId) {
    const modal = document.getElementById(modalId);
    if (!modal) return;

    // 1. Safety: If another modal is open, close it first to prevent overlap
    if (this.activeModal && this.activeModal !== modal) {
      this.close();
    }

    // 2. Store trigger element to restore focus later
    this.previousFocus = document.activeElement;

    // 3. Lock Body Scroll (Prevents background scrolling while modal is open)
    document.body.style.overflow = 'hidden';

    // 4. Activate Modal
    // We use requestAnimationFrame to ensure the CSS transition triggers beautifully
    requestAnimationFrame(() => {
      modal.classList.add('active');
    });

    this.activeModal = modal;

    // 5. Smart Focus
    // We focus the first input, but use preventScroll to stop the page jumping on mobile
    const focusable = modal.querySelector('input, select, textarea, button:not(.modal-close)');
    if (focusable) {
      // Small delay ensures the modal is visible before we try to focus
      setTimeout(() => {
        focusable.focus({ preventScroll: true });
      }, 50);
    }

    // 6. Bind Events
    this._boundKeydown = this.handleKeydown.bind(this);
    this._boundClick = this.handleClick.bind(this);

    document.addEventListener('keydown', this._boundKeydown);
    modal.addEventListener('click', this._boundClick);
  },

  close() {
    if (!this.activeModal) return;

    const modal = this.activeModal;

    // 1. Deactivate
    modal.classList.remove('active');

    // 2. Unlock Body Scroll
    document.body.style.overflow = '';

    // 3. Cleanup Events
    document.removeEventListener('keydown', this._boundKeydown);
    modal.removeEventListener('click', this._boundClick);

    // 4. Restore Focus to the button that opened the modal
    if (this.previousFocus && typeof this.previousFocus.focus === 'function') {
      this.previousFocus.focus({ preventScroll: true });
    }

    // Reset state
    this.activeModal = null;
    this.previousFocus = null;
  },

  // Centralized Click Handler
  // Handles both Backdrop clicks AND "Close/Cancel" buttons automatically
  handleClick(e) {
    // 1. Backdrop Click (Close if clicking outside content)
    if (e.target === this.activeModal) {
      this.close();
      return;
    }

    // 2. Auto-Close for any element with these classes
    // This saves you from writing manual onclick="" handlers for every X button
    if (e.target.closest('.modal-close') || e.target.closest('.modal-btn-cancel')) {
      this.close();
    }
  },

  handleKeydown(e) {
    // 1. ESC to Close
    if (e.key === 'Escape') {
      this.close();
      return;
    }

    // 2. Focus Trap (Keeps Tab cycle inside the modal)
    if (e.key === 'Tab' && this.activeModal) {
      const focusables = this.activeModal.querySelectorAll(
        'button:not([disabled]), input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"])'
      );
      
      if (focusables.length === 0) return;

      const first = focusables[0];
      const last = focusables[focusables.length - 1];

      // Shift+Tab on first element -> wrap to last
      if (e.shiftKey && document.activeElement === first) {
        e.preventDefault();
        last.focus();
      } 
      // Tab on last element -> wrap to first
      else if (!e.shiftKey && document.activeElement === last) {
        e.preventDefault();
        first.focus();
      }
    }
  }
};
// ==================== AUTOCOMPLETE ====================
const VehicleDetector = {
  // GWAC/IDIQ/Vehicle detection from Award ID (PIID) prefixes
  patterns: [
    { prefix: /^GS-35F/i, vehicle: 'GSA Schedule', short: 'GSA' },
    { prefix: /^GS-00F/i, vehicle: 'GSA Schedule', short: 'GSA' },
    { prefix: /^GS-07F/i, vehicle: 'GSA Schedule', short: 'GSA' },
    { prefix: /^GS-\d{2}F/i, vehicle: 'GSA Schedule', short: 'GSA' },
    { prefix: /^47Q[A-Z]{2}A/i, vehicle: 'OASIS+', short: 'OASIS+' },
    { prefix: /^47QTCA/i, vehicle: 'OASIS', short: 'OASIS' },
    { prefix: /^47QTCK/i, vehicle: 'OASIS SB', short: 'OASIS SB' },
    { prefix: /^GS-06F/i, vehicle: 'ALLIANT 2', short: 'ALLIANT' },
    { prefix: /^HC102[89]/i, vehicle: 'CIO-SP3', short: 'CIO-SP3' },
    { prefix: /^HC1013/i, vehicle: 'CIO-SP4', short: 'CIO-SP4' },
    { prefix: /^W15QKN/i, vehicle: 'Army ITES', short: 'ITES' },
    { prefix: /^W52P1J/i, vehicle: 'Army CHESS', short: 'CHESS' },
    { prefix: /^FA870[12]/i, vehicle: 'NETCENTS', short: 'NETCENTS' },
    { prefix: /^N0017[89]/i, vehicle: 'SeaPort', short: 'SEAPORT' },
    { prefix: /^N00189/i, vehicle: 'SeaPort-NxG', short: 'SEAPORT' },
    { prefix: /^47QFCA/i, vehicle: '8(a) STARS III', short: 'STARS III' },
    { prefix: /^47QFSA/i, vehicle: '8(a) STARS III', short: 'STARS III' },
    { prefix: /^HHSN/i, vehicle: 'NIH CIO-SP', short: 'NIH' },
    { prefix: /^75N98/i, vehicle: 'NIH NITAAC', short: 'NITAAC' },
    { prefix: /^VA118/i, vehicle: 'VA T4NG', short: 'T4NG' },
    { prefix: /^36C10X/i, vehicle: 'VA VETS 2', short: 'VETS 2' },
  ],
  
  detect(awardId) {
    if (!awardId) return null;
    for (const p of this.patterns) {
      if (p.prefix.test(awardId)) return p;
    }
    return null;
  },
  
  // Set-aside code to human-readable label
  setAsideLabels: {
    'SBA': '8(a)', '8A': '8(a)', '8AN': '8(a)',
    'HZC': 'HUBZone', 'HZS': 'HUBZone',
    'WOSB': 'WOSB', 'EDWOSB': 'EDWOSB',
    'SDVOSBC': 'SDVOSB', 'SDVOSBS': 'SDVOSB',
    'SBP': 'Small Biz', 'SMP': 'Small Biz',
    'VSA': 'VOSB', 'VSB': 'VOSB',
    'HS2': 'HUBZone SB', 'HS3': 'HUBZone/8(a)',
    'ISBEE': 'Econ. Disadv.', 'IEE': 'Econ. Disadv.',
  },
  
  getSetAsideLabel(code) {
    if (!code) return null;
    return this.setAsideLabels[code] || (code.length <= 10 ? code : null);
  }
};

const VendorRelationships = {
  // States: null (unset), 'mine', 'partner', 'competitor'
  _map: {},
  
  get(vendorName) {
    return this._map[vendorName.toUpperCase()] || null;
  },
  
  cycle(vendorName) {
    const key = vendorName.toUpperCase();
    const states = [null, 'mine', 'partner', 'competitor'];
    const current = this._map[key] || null;
    const idx = states.indexOf(current);
    const next = states[(idx + 1) % states.length];
    if (next) this._map[key] = next;
    else delete this._map[key];
    return next;
  },
  
  getIcon(state) {
    if (state === 'mine') return { icon: 'fas fa-building', color: 'var(--accent)', label: 'My Company', bg: 'rgba(95,128,85,0.15)' };
    if (state === 'partner') return { icon: 'fas fa-handshake', color: 'var(--info)', label: 'Partner', bg: 'rgba(141,160,203,0.15)' };
    if (state === 'competitor') return { icon: 'fas fa-crosshairs', color: '#A64438', label: 'Competitor', bg: 'rgba(166,68,56,0.15)' };
    return { icon: 'fas fa-tag', color: 'var(--text-muted)', label: 'Tag vendor', bg: 'transparent' };
  },
  
  // Get all tagged vendors grouped by relationship
  getTagged() {
    const result = { mine: [], partner: [], competitor: [] };
    Object.entries(this._map).forEach(([name, rel]) => {
      if (result[rel]) result[rel].push(name);
    });
    return result;
  }
};

const Autocomplete = {
  activeInput: null,
  dropdown: null,
  debounceTimer: null,
  selectedIndex: -1,
  results: { agencies: [], recipients: [] },
  
init(inputId) {
  const input = document.getElementById(inputId);
  if (!input) return;
  
  // Wrap input if not already wrapped
  if (!input.parentElement.classList.contains('autocomplete-wrapper')) {
    const wrapper = document.createElement('div');
    wrapper.className = 'autocomplete-wrapper';
    input.parentNode.insertBefore(wrapper, input);
    wrapper.appendChild(input);
  }
  
  // Create dropdown
  const dropdown = document.createElement('div');
  dropdown.className = 'autocomplete-dropdown';
  dropdown.id = `${inputId}-dropdown`;
  input.parentElement.appendChild(dropdown);
  
  // Event listeners
  input.addEventListener('input', (e) => this.handleInput(e, inputId));
  input.addEventListener('keydown', (e) => this.handleKeydown(e, inputId));
  input.addEventListener('focus', (e) => this.handleFocus(e, inputId));
  input.addEventListener('blur', () => setTimeout(() => this.hide(inputId), 200));
},
  
  handleInput(e, inputId) {
    const query = e.target.value.trim();
    clearTimeout(this.debounceTimer);
    
    if (query.length < 2) {
      this.hide(inputId);
      return;
    }
    
    this.debounceTimer = setTimeout(() => this.search(query, inputId), 250);
  },
  
  handleFocus(e, inputId) {
    const query = e.target.value.trim();
    if (query.length >= 2 && this.hasResults()) {
      this.show(inputId);
    }
  },
  
  handleKeydown(e, inputId) {
    const dropdown = document.getElementById(`${inputId}-dropdown`);
    if (!dropdown || !dropdown.classList.contains('active')) {
      if (e.key === 'ArrowDown' && e.target.value.length >= 2) {
        this.search(e.target.value.trim(), inputId);
      }
      return;
    }
    
    const items = dropdown.querySelectorAll('.autocomplete-item');
    
    if (e.key === 'ArrowDown') {
      e.preventDefault();
      this.selectedIndex = Math.min(this.selectedIndex + 1, items.length - 1);
      this.updateSelection(items);
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      this.selectedIndex = Math.max(this.selectedIndex - 1, 0);
      this.updateSelection(items);
    } else if (e.key === 'Enter' && this.selectedIndex >= 0) {
      e.preventDefault();
      items[this.selectedIndex]?.click();
    } else if (e.key === 'Escape') {
      this.hide(inputId);
    }
  },
  
  updateSelection(items) {
    items.forEach((item, i) => {
      item.classList.toggle('selected', i === this.selectedIndex);
    });
    items[this.selectedIndex]?.scrollIntoView({ block: 'nearest' });
  },
  
  async search(query, inputId) {
    try {
      const [agencies, recipients] = await Promise.all([
        API.autocompleteAgency(query),
        API.autocompleteRecipient(query)
      ]);
      
      this.results = { agencies, recipients };
      this.selectedIndex = -1;
      this.render(inputId);
    } catch (e) {
      console.error('Autocomplete error:', e);
    }
  },
  
  hasResults() {
    return this.results.agencies.length > 0 || 
           this.results.recipients.length > 0;
  },
  
  render(inputId) {
    const dropdown = document.getElementById(`${inputId}-dropdown`);
    if (!dropdown) return;
    
    const { agencies, recipients } = this.results;
    
    if (!this.hasResults()) {
      dropdown.innerHTML = '<div class="autocomplete-empty">No matches found</div>';
      this.show(inputId);
      return;
    }
    
    let html = '';
    
    if (agencies.length > 0) {
      html += `<div class="autocomplete-section">
        <div class="autocomplete-section-label mono muted upper"><i class="fas fa-landmark"></i> Agencies</div>
        ${agencies.slice(0, 5).map(a => `
          <div class="autocomplete-item" data-type="agency" data-value="${this.escapeHtml(a.subtier_agency?.name || a.toptier_agency?.name || '')}">
            <i class="fas fa-building muted"></i>
            <div class="autocomplete-item-text">
              <div class="autocomplete-item-main truncate">${this.escapeHtml(a.subtier_agency?.name || a.toptier_agency?.name || 'Unknown')}</div>
              ${a.toptier_agency?.name && a.subtier_agency?.name ? `<div class="autocomplete-item-sub muted">${this.escapeHtml(a.toptier_agency.name)}</div>` : ''}
            </div>
          </div>
        `).join('')}
      </div>`;
    }
    
    if (recipients.length > 0) {
      html += `<div class="autocomplete-section">
        <div class="autocomplete-section-label mono muted upper"><i class="fas fa-briefcase"></i> Vendors & Keywords</div>
        ${recipients.slice(0, 5).map(r => `
          <div class="autocomplete-item" data-type="recipient" data-value="${this.escapeHtml(r.recipient_name || '')}">
            <i class="fas fa-briefcase muted"></i>
            <div class="autocomplete-item-text">
              <div class="autocomplete-item-main truncate">${this.escapeHtml(r.recipient_name || 'Unknown')}</div>
              ${r.uei ? `<div class="autocomplete-item-sub muted">UEI: ${r.uei}</div>` : ''}
            </div>
          </div>
        `).join('')}
      </div>`;
    }
    
    dropdown.innerHTML = html;
    
    // Add click handlers
    dropdown.querySelectorAll('.autocomplete-item').forEach(item => {
      item.addEventListener('click', () => {
        const input = document.getElementById(inputId);
        if (input) {
          input.value = item.dataset.value;
          input.focus();
        }
        this.hide(inputId);
      });
    });
    
    this.show(inputId);
  },
  
  show(inputId) {
    const dropdown = document.getElementById(`${inputId}-dropdown`);
    if (dropdown) dropdown.classList.add('active');
  },
  
  hide(inputId) {
    const dropdown = document.getElementById(`${inputId}-dropdown`);
    if (dropdown) dropdown.classList.remove('active');
    this.selectedIndex = -1;
  },
  
  escapeHtml(str) {
    if (!str) return '';
    return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
  }
};

// ==================== API ====================
const API = {
  baseUrl: 'https://api.usaspending.gov/api/v2',
  
  // Search Mode API
  async searchAwards(keywords) {
    const today = new Date();
    const oneYearAgo = new Date();
    oneYearAgo.setFullYear(today.getFullYear() - 1);
    
    const period = {
      start_date: Utils.formatDateISO(oneYearAgo),
      end_date: Utils.formatDateISO(today)
    };
    
    // Use consolidated term parser
    const { pscCodes, naicsCodes, keywordTerms } = Utils.parseSearchTerms(keywords);
    const allTermsCategorized = [
      ...pscCodes.map(t => ({ type: 'psc', value: t })),
      ...naicsCodes.map(t => ({ type: 'naics', value: t })),
      ...keywordTerms.map(t => ({ type: 'keyword', value: t }))
    ];
    
    const fetchPromises = allTermsCategorized.map(({ type, value }) => {
      const filters = { time_period: [period], award_type_codes: ['A','B','C','D'] };
      if (type === 'psc') filters.psc_codes = [value];
      else if (type === 'naics') filters.naics_codes = [value];
      else filters.keywords = [value];
      
      return fetch(`${this.baseUrl}/search/spending_by_award/`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          filters,
          fields: [
            'Award ID', 'Recipient Name', 'Awarding Agency', 'Awarding Sub Agency',
            'Award Amount', 'Description', 'generated_internal_id',
            'Start Date', 'End Date', 'NAICS Code', 'NAICS Description', 'PSC Code', 'PSC Description',
            'Type of Set Aside'
          ],
          limit: 100, sort: 'Award Amount', order: 'desc'
        })
      }).then(res => res.json());
    });
    
    const results = await Promise.all(fetchPromises);
    let combined = [];
    results.forEach(json => { if(json.results) combined = combined.concat(json.results); });
    
    // Deduplicate
    const unique = new Map();
    combined.forEach(item => { if(!unique.has(item['Award ID'])) unique.set(item['Award ID'], item); });
    
    return Array.from(unique.values()).sort((a,b) => b['Award Amount'] - a['Award Amount']);
  },
  
  // Forecast Mode APIs
  async getSpendingOverTime(keywords, yearsBack=3) {
    const curFY = Utils.getCurrentFY();
    const periods = [];
    // Get extra history to establish trends
    for(let y=curFY-yearsBack; y<=curFY; y++) {
      periods.push({start_date:`${y-1}-10-01`, end_date:`${y}-09-30`});
    }
    
    const filters = Utils.buildFilters(keywords, periods);
    
    const res = await fetch(`${this.baseUrl}/search/spending_over_time/`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        group: 'quarter',
        filters
      })
    });
    return (await res.json()).results || [];
  },
  
  async getAgencyData(keywords, yearsBack=3) {
    const curFY = Utils.getCurrentFY();
    const periods = [{start_date:`${curFY-yearsBack-1}-10-01`, end_date:`${curFY}-09-30`}];
    
    const filters = Utils.buildFilters(keywords, periods);
    
    const res = await fetch(`${this.baseUrl}/search/spending_by_category/awarding_agency`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        category: 'awarding_agency',
        filters,
        limit: 100
      })
    });
    return (await res.json()).results || [];
  },
  
  async getAwardsForForecast(keywords) {
    // 1-year window — recompetes need recent awards, not diluted by old ones
    const today = new Date();
    const oneYearAgo = new Date();
    oneYearAgo.setFullYear(today.getFullYear() - 1);
    
    const period = {
      start_date: Utils.formatDateISO(oneYearAgo),
      end_date: Utils.formatDateISO(today)
    };
    
    const filters = Utils.buildFilters(keywords, [period]);
    
    const res = await fetch(`${this.baseUrl}/search/spending_by_award/`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        filters,
        fields: [
          'Award ID', 'Recipient Name', 'Description', 'Start Date', 'End Date', 
          'Award Amount', 'Potential Total Value of Award', 'Awarding Agency', 'Awarding Sub Agency', 'generated_internal_id',
          'NAICS Code', 'NAICS Description', 'PSC Code', 'PSC Description',
          'Type of Set Aside'
        ],
        limit: 100, 
        sort: 'Award Amount',
        order: 'desc'
      })
    });
    return (await res.json()).results || [];
  },
  

  // ==================== NEW: AUTOCOMPLETE ====================
  async autocompleteAgency(searchText) {
    if (!searchText || searchText.length < 2) return [];
    const res = await fetch(`${this.baseUrl}/autocomplete/awarding_agency/`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ search_text: searchText, limit: 8 })
    });
    return (await res.json()).results || [];
  },
  
  // Fetch contracting offices for a sub-agency
  async fetchOfficesForSubAgency(subAgencyName) {
    try {
      const res = await fetch(`${this.baseUrl}/autocomplete/awarding_agency_office/`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ search_text: subAgencyName, limit: 50 })
      });
      const data = await res.json();
      // Extract offices from the response - structure has subtier_agency with offices array
      const offices = [];
      if (data.results) {
        data.results.forEach(result => {
          // Check if this is a subtier_agency match
          if (result.subtier_agency && result.subtier_agency.name === subAgencyName && result.subtier_agency.offices) {
            result.subtier_agency.offices.forEach(office => {
              offices.push({ code: office.code, name: office.name });
            });
          }
          // Also check toptier_agency offices
          if (result.toptier_agency && result.toptier_agency.offices) {
            result.toptier_agency.offices.forEach(office => {
              offices.push({ code: office.code, name: office.name });
            });
          }
          // Direct office match
          if (result.office) {
            offices.push({ code: result.office.code, name: result.office.name });
          }
        });
      }
      return offices;
    } catch (e) {
      console.error('Error fetching offices:', e);
      return [];
    }
  },

  async autocompleteRecipient(searchText) {
    if (!searchText || searchText.length < 2) return [];
    const res = await fetch(`${this.baseUrl}/autocomplete/recipient/`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ search_text: searchText, limit: 8 })
    });
    return (await res.json()).results || [];
  },

  // ==================== SPENDING BY GEOGRAPHY ====================
  async getSpendingByGeography(keywords, geoLayer = 'state') {
    const curFY = Utils.getCurrentFY();
    const timePeriod = [{start_date: `${curFY-1}-10-01`, end_date: `${curFY}-09-30`}];
    
    // Use consolidated filter builder for PSC/NAICS/keyword detection
    const filters = Utils.buildFilters(keywords, timePeriod);
    
    const res = await fetch(`${this.baseUrl}/search/spending_by_geography/`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        scope: 'place_of_performance',
        geo_layer: geoLayer,
        filters
      })
    });
    return (await res.json()).results || [];
  },

  // ==================== SUBAWARDS ====================
  async getSubawards(keywords) {
    const today = new Date();
    const oneYearAgo = new Date();
    oneYearAgo.setFullYear(today.getFullYear() - 1);
    
    // Build filters object
    const filters = { 
      time_period: [{
        start_date: Utils.formatDateISO(oneYearAgo),
        end_date: Utils.formatDateISO(today)
      }],
      award_type_codes: ['A','B','C','D']
    };
    
    // Use consolidated term parser for PSC/NAICS detection
    const { pscCodes, naicsCodes, keywordTerms } = Utils.parseSearchTerms(keywords);
    
    // Add PSC filter if PSC codes detected
    if (pscCodes.length > 0) {
      filters.psc_codes = pscCodes;
    }
    
    // Add NAICS filter if NAICS codes detected
    if (naicsCodes.length > 0) {
      filters.naics_codes = naicsCodes;
    }
    
    // Add keyword filter if non-code terms exist
    if (keywordTerms.length > 0) {
      filters.keywords = keywordTerms;
    }
    
    // If nothing was added, fall back to original keyword
    if (!filters.psc_codes && !filters.naics_codes && !filters.keywords) {
      filters.keywords = [keywords];
    }
    
    const res = await fetch(`${this.baseUrl}/search/spending_by_award/`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        subawards: true,
        filters,
        fields: [
          'Sub-Award ID', 'Sub-Awardee Name', 'Sub-Award Amount', 
          'Prime Award ID', 'Prime Recipient Name', 'Sub-Award Date',
          'Awarding Agency', 'Awarding Sub Agency',
          'prime_award_generated_internal_id'
        ],
        limit: 100,
        sort: 'Sub-Award Amount',
        order: 'desc'
      })
    });
    return (await res.json()).results || [];
  }
};

// ==================== GEOGRAPHY MAP ====================
const GeoMap = {
  // Use shared US_STATES constant  
  async loadAndRender(containerId, keywords) {
    const container = document.getElementById(containerId);
    if (!container) return;
    
    container.innerHTML = `
      <div class="geo-map-header">
        <div class="geo-map-title"><i class="fas fa-map-marker-alt"></i> Performance Location</div>
        <div class="geo-map-total">Loading...</div>
      </div>
      <div class="geo-states-grid">
        <div style="grid-column: 1/-1; text-align:center; padding:2rem; color:var(--text-muted);">
          <i class="fas fa-spinner fa-spin"></i> Loading geography data...
        </div>
      </div>
    `;
    
    try {
      const data = await API.getSpendingByGeography(keywords, 'state');
      this.render(container, data);
    } catch (e) {
      container.innerHTML = `
        <div class="geo-map-header">
          <div class="geo-map-title"><i class="fas fa-map-marker-alt"></i> Performance Location</div>
        </div>
        <div style="text-align:center; padding:1rem; color:var(--text-muted); font-size:0.85rem;">
          Unable to load geography data
        </div>
      `;
    }
  },
  
  render(container, data) {
    if (!data || data.length === 0) {
      container.innerHTML = `
        <div class="geo-map-header">
          <div class="geo-map-title"><i class="fas fa-map-marker-alt"></i> Performance Location</div>
        </div>
        <div style="text-align:center; padding:1rem; color:var(--text-muted); font-size:0.85rem;">
          No geographic data available
        </div>
      `;
      return;
    }
    
    // Sort by amount descending
    const sorted = data
      .filter(d => d.aggregated_amount > 0)
      .sort((a, b) => b.aggregated_amount - a.aggregated_amount);
    
    const total = sorted.reduce((sum, d) => sum + d.aggregated_amount, 0);
    const maxAmount = sorted[0]?.aggregated_amount || 1;
    
    const statesHtml = sorted.slice(0, 20).map(d => {
      const stateCode = d.shape_code || d.display_name;
      const stateName = US_STATES[stateCode] || d.display_name || stateCode;
      
      return `
        <div class="geo-state-item">
          <span class="geo-state-name truncate">${stateName}</span>
          <span class="geo-state-amount mono accent">${Utils.money(d.aggregated_amount)}</span>
        </div>
      `;
    }).join('');
    
    container.innerHTML = `
      <div class="geo-map-header">
        <div class="geo-map-title mono text-sm muted upper"><i class="fas fa-map-marker-alt"></i> Top Performance Locations</div>
        <div class="geo-map-total mono accent">${Utils.money(total)} across ${sorted.length} states</div>
      </div>
      <div class="geo-states-grid">${statesHtml}</div>
    `;
  }
};
const ForecastEngine = {
  analyze(spendingData, awardsData, agencyData) {
    const organized = this.organizeByQuarter(spendingData);
    const filtered = this.filterOutliers(organized);
    // Removed unused profile/forecast calculations
    const recompetes = this.detectRecompetes(awardsData);
    const market = this.analyzeMarketConcentration(agencyData);
    const volatility = this.calculateVolatilityMetrics(filtered);
    
    return { 
      recompetes, 
      marketStatus: market.level, 
      hhi: market.hhi, 
      byFY: organized.byFY, 
      volatility
    };
  },

  organizeByQuarter(spendingData) {
    const organized = { byFY: {}, byQuarter: {}, totalByFY: {}, allAmounts: [] };
    spendingData.forEach(d => {
      const q = parseInt(d.time_period?.quarter); 
      const fy = parseInt(d.time_period?.fiscal_year); 
      const amt = d.aggregated_amount || 0;
      if(q && fy) {
        if(!organized.byFY[fy]) organized.byFY[fy] = {1:0, 2:0, 3:0, 4:0};
        organized.byFY[fy][q] = amt; 
        if(!organized.byQuarter[q]) organized.byQuarter[q] = [];
        organized.byQuarter[q].push({fy, amt}); 
        organized.totalByFY[fy] = (organized.totalByFY[fy] || 0) + amt;
        organized.allAmounts.push({fy, q, amt});
      }
    });
    return organized;
  },

  filterOutliers(organized) {
    const filtered = { byFY: {}, byQuarter: {}, totalByFY: {}, allAmounts: [] };
    Object.keys(organized.byFY).forEach(fy => filtered.byFY[fy] = {});
    for(let q=1; q<=4; q++) {
      const qData = organized.byQuarter[q] || []; 
      const amounts = qData.map(d => d.amt);
      if(amounts.length < 3) {
        qData.forEach(d => { 
           filtered.byQuarter[q] = filtered.byQuarter[q] || []; 
           filtered.byQuarter[q].push(d); 
           filtered.byFY[d.fy][q] = d.amt; 
           filtered.totalByFY[d.fy] = (filtered.totalByFY[d.fy]||0) + d.amt; 
        });
        continue;
      }
      const mean = amounts.reduce((a,b)=>a+b,0) / amounts.length;
      const variance = amounts.reduce((s,v)=>s+Math.pow(v-mean,2),0) / amounts.length;
      const stdDev = Math.sqrt(variance);
      const limit = mean + (2 * stdDev);
      qData.forEach(item => {
        if(item.amt <= limit) {
           filtered.byQuarter[q] = filtered.byQuarter[q] || []; 
           filtered.byQuarter[q].push(item); 
           filtered.byFY[item.fy][q] = item.amt; 
           filtered.totalByFY[item.fy] = (filtered.totalByFY[item.fy]||0) + item.amt;
        }
      });
    }
    return filtered;
  },

  calculateVolatilityMetrics(filtered) {
    const curFY = Utils.getCurrentFY();
    const years = Object.keys(filtered.totalByFY).map(Number).filter(y => y < curFY).sort();
    
    if (years.length < 2) {
      return { stdDev: 0, coeffVar: 0, score: 0.5 };
    }
    
    const amounts = years.map(y => filtered.totalByFY[y]);
    const mean = amounts.reduce((a, b) => a + b, 0) / amounts.length;
    const variance = amounts.reduce((s, v) => s + Math.pow(v - mean, 2), 0) / (amounts.length - 1);
    const stdDev = Math.sqrt(variance);
    const coeffVar = mean > 0 ? (stdDev / mean) : 0;
    
    return {
      stdDev,
      coeffVar,
      score: Math.min(coeffVar * 2.5, 1)
    };
  },

  analyzeMarketConcentration(agencyData) {
    const total = agencyData.reduce((s,a)=>s+a.amount,0); 
    let hhi = 0;
    let cr4 = 0;
    
    // Guard against division by zero
    if (total > 0) {
      agencyData.forEach(a => { 
        const share = (a.amount / total) * 100; 
        hhi += share * share; 
      });
      
      const sorted = [...agencyData].sort((a, b) => b.amount - a.amount);
      cr4 = sorted.slice(0, 4).reduce((s, a) => s + (a.amount / total) * 100, 0);
    }
    
    let level = "Competitive";
    let buyerPower = "Low";
    
    if(hhi > 2500) { level = "Concentrated"; buyerPower = "High"; }
    else if(hhi > 1500) { level = "Moderate"; buyerPower = "Medium"; }
    
    return { 
      hhi: Math.round(hhi), 
      level, 
      cr4: Math.round(cr4),
      buyerPower,
      agencyCount: agencyData.length 
    };
  },

  detectRecompetes(awards) {
    const now = new Date(); 
    const twoYears = new Date(); twoYears.setFullYear(now.getFullYear()+2);
    
    return awards
      .filter(a => { 
        const end = new Date(a['End Date']); 
        return end > now && end < twoYears && a['Award Amount'] > 50000; 
      })
      .sort((a, b) => new Date(a['End Date']) - new Date(b['End Date']))
      .slice(0, 15);
  }
};

// ==================== KNOWN VENDORS DATABASE ====================
const KnownVendors = {
  // Known VARs/Resellers
  vars: new Set([
    'CARAHSOFT TECHNOLOGY CORP', 'CARAHSOFT TECHNOLOGY CORPORATION',
    'CDW GOVERNMENT LLC', 'CDW-G',
    'SHI INTERNATIONAL CORP', 'SHI GOVERNMENT SOLUTIONS',
    'INSIGHT PUBLIC SECTOR INC', 'INSIGHT DIRECT USA INC',
    'GOVPLACE, LLC', 'GOVPLACE LLC',
    'IMMIX GROUP INC', 'IMMIXGROUP INC',
    'DLT SOLUTIONS LLC', 'DLT SOLUTIONS',
    'THUNDERCAT TECHNOLOGY, LLC', 'THUNDERCAT TECHNOLOGY LLC',
    'WORLD WIDE TECHNOLOGY LLC', 'WWT GOVERNMENT SERVICES',
    'PRESIDIO NETWORKED SOLUTIONS', 'PRESIDIO GOVERNMENT SOLUTIONS',
    'CONNECTION', 'PC CONNECTION', 'PCMG INC',
    'EN POINTE TECHNOLOGIES',
    'STERLING COMPUTERS CORPORATION', 'STERLING COMPUTERS',
    'MERLIN INTERNATIONAL', 'RED RIVER TECHNOLOGY',
    'MYTHICS INC', 'MYTHICS LLC',
    'FOUR POINTS TECHNOLOGY', 'FOUR POINTS TECHNOLOGY LLC',
    'SILOTECH GROUP INC', 'DECISIVE COMMUNICATIONS INC',
    'FCN INC', 'FCN, INC.',
    'SOFTCHOICE CORPORATION', 'SOFTCHOICE',
    'TRACE3', 'OPTIV SECURITY INC', 'OPTIV SECURITY',
    'FEDSTORE CORPORATION', 'FEDSTORE',
    'GOVSMART INC', 'GOVSMART, INC.',
    'NEW TECH SOLUTIONS', 'NEW TECH SOLUTIONS, INC.',
    'PANAMERICA COMPUTERS', 'PANAMERICA COMPUTERS, INC.',
    'SOFTWARE INFORMATION RESOURCE CORP',
    'ACCESSAGILITY LLC', 'BLUE TECH INC', 'BLUE TECH INC.',
    'DH TECHNOLOGIES', 'DH TECHNOLOGIES, INC.',
    'IT1 SOURCE LLC',
    'ENTERPRISE TECHNOLOGY SOLUTIONS', 'ENTERPRISE TECHNOLOGY SOLUTIONS, INC.',
    'DISTRIBUTED TECHNOLOGY GROUP LLC', 'ARCHITECHTURE SOLUTIONS LLC',
    'ADVANCED COMPUTER CONCEPTS', 'ADVANCED COMPUTER CONCEPTS, INC.',
    '4 STAR TECHNOLOGIES', '4 STAR TECHNOLOGIES, INC.',
    'THREE WIRE SYSTEMS', 'THREE WIRE SYSTEMS, LLC',
    'C & C INTERNATIONAL COMPUTERS'
  ]),

  // Known Large Primes/System Integrators
  primes: new Set([
    'BOOZ ALLEN HAMILTON', 'BOOZ ALLEN HAMILTON INC',
    'GENERAL DYNAMICS INFORMATION TECHNOLOGY', 'GENERAL DYNAMICS IT', 'GDIT',
    'LEIDOS INC', 'LEIDOS HOLDINGS', 'LEIDOS',
    'SAIC', 'SCIENCE APPLICATIONS INTERNATIONAL',
    'NORTHROP GRUMMAN', 'RAYTHEON',
    'LOCKHEED MARTIN', 'LOCKHEED MARTIN CORPORATION',
    'BAE SYSTEMS', 'L3HARRIS TECHNOLOGIES',
    'CACI INTERNATIONAL', 'CACI INC',
    'MANTECH INTERNATIONAL', 'MANTECH',
    'PERATON INC', 'PERATON',
    'ACCENTURE FEDERAL SERVICES', 'ACCENTURE',
    'DELOITTE CONSULTING', 'DELOITTE',
    'IBM CORPORATION', 'IBM', 'KPMG',
    'CGI FEDERAL', 'CGI TECHNOLOGIES',
    'MAXIMUS INC', 'MAXIMUS FEDERAL',
    'ICF INTERNATIONAL', 'ICF INC',
    'SERCO INC', 'SERCO',
    'PAE INCORPORATED', 'AMENTUM',
    'JACOBS TECHNOLOGY', 'KBR INC'
  ]),

  // Classify a vendor name
  classify(vendorName) {
    const upper = vendorName.toUpperCase().trim();
    
    // Check exact matches first
    if (this.vars.has(upper)) return 'var';
    if (this.primes.has(upper)) return 'prime';
    
    // Check partial matches
    for (const known of this.vars) {
      if (upper.includes(known) || known.includes(upper)) return 'var';
    }
    for (const known of this.primes) {
      if (upper.includes(known) || known.includes(upper)) return 'prime';
    }
    
    // Pattern-based detection for likely VARs
    const varPatterns = [
      /\b(TECHNOLOGY|TECHNOLOGIES)\s*(CORP|LLC|INC)/i,
      /\b(COMPUTERS?|COMPUTING)\s*(CORP|LLC|INC)/i,
      /\bSOLUTIONS?\s*(CORP|LLC|INC)/i,
      /\bGOV(PLACE|SMART|STORE)/i,
      /\bFEDERAL\s*(SOLUTIONS|TECHNOLOGY)/i
    ];
    
    for (const pattern of varPatterns) {
      if (pattern.test(upper)) return 'likely_var';
    }
    
    return 'unknown';
  }
};

// ==================== JOB SEEKER UTILITIES ====================
const JobLinks = {
  // Known parent company names - if vendor starts with these, just use the parent name
  knownBrands: [
    'KBR', 'SAIC', 'CACI', 'LEIDOS', 'SERCO', 'AECOM', 'JACOBS', 'PARSONS', 
    'MAXIMUS', 'ICF', 'CGI', 'IBM', 'DELL', 'HP', 'CISCO', 'ORACLE', 'GOOGLE',
    'AMAZON WEB', 'MICROSOFT', 'ACCENTURE FEDERAL', 'DELOITTE', 'KPMG', 'PWC', 'EY',
    'PERATON', 'AMENTUM', 'MANTECH', 'BAE SYSTEMS', 'RAYTHEON', 'BOEING', 'AIRBUS',
    'HONEYWELL', 'HARRIS', 'TEXTRON', 'VERIZON', 'ATT', 'AT&T', 'SPRINT',
    'PALANTIR', 'ANDURIL', 'CROWDSTRIKE', 'SPLUNK', 'VMWARE', 'SALESFORCE',
    'SERVICENOW', 'SNOWFLAKE', 'DATABRICKS', 'ELASTIC', 'GITLAB', 'ATLASSIAN'
  ],
  
  // Multi-word brand names that need OR with abbreviation
  brandAliases: {
    'BOOZ ALLEN': 'BAH',
    'GENERAL DYNAMICS': 'GDIT',
    'NORTHROP GRUMMAN': 'NGC',
    'LOCKHEED MARTIN': 'LMCO',
    'L3HARRIS': 'L3 HARRIS',
    'L3 HARRIS': 'L3HARRIS',
    'WORLD WIDE TECHNOLOGY': 'WWT',
    'RED HAT': 'REDHAT',
    'PALO ALTO': 'PANW'
  },

  // Shared logic for cleaning vendor names
  cleanVendorName(vendorName) {
    let cleanName = vendorName
      .replace(/,?\s*(LLC|INC|CORP|CORPORATION|INCORPORATED|L\.L\.C\.|L\.P\.|LP|LTD|LIMITED|CO\.)\.?\s*$/gi, '')
      .replace(/\s+/g, ' ')
      .trim();
    
    const upperName = cleanName.toUpperCase();
    
    // Check if it starts with a known single-word brand
    for (const brand of this.knownBrands) {
      if (upperName === brand || upperName.startsWith(brand + ' ')) {
        return brand;
      }
    }
    
    // Check for known multi-word brand aliases
    for (const [brand, alias] of Object.entries(this.brandAliases)) {
      if (upperName.startsWith(brand)) {
        return brand;
      }
    }
    
    return cleanName;
  },

  // Generate LinkedIn job search URL
  getLinkedInUrl(vendorName) {
    const cleanName = this.cleanVendorName(vendorName);
    return `https://www.linkedin.com/jobs/search/?keywords=${encodeURIComponent(cleanName)}&f_C=`;
  },
  
  // Generate LinkedIn people search URL - finds contacts at a company
  getLinkedInPeopleUrl(vendorName, roleKeywords = '') {
    const cleanName = this.cleanVendorName(vendorName);
    let searchQuery = roleKeywords ? `"${cleanName}" ${roleKeywords}` : cleanName;
    return `https://www.linkedin.com/search/results/people/?keywords=${encodeURIComponent(searchQuery)}&origin=GLOBAL_SEARCH_HEADER`;
  },
  // Generate LinkedIn content/news search URL
getLinkedInNewsUrl(searchTerm) {
  const cleanName = typeof searchTerm === 'string' ? this.cleanVendorName(searchTerm) : searchTerm;
  return `https://www.linkedin.com/search/results/content/?keywords=${encodeURIComponent(cleanName)}`;
}
};
const SkillsExtractor = {
  // Stopwords and boilerplate terms to ignore
  _stop: new Set([
    'the','and','for','that','this','with','from','are','was','were','will','has','have','had',
    'not','but','all','can','her','his','its','our','they','been','each','which','their','said',
    'use','may','than','other','into','some','could','them','only','then','also','over','such',
    'after','before','these','more','would','about','between','through','under','being','during',
    'services','service','support','provide','providing','provides','provided','including','include',
    'includes','based','related','various','shall','must','per','using','used','non','new','work',
    'contract','contractor','government','agency','federal','award','acquisition','task','order',
    'option','period','base','year','years','fiscal','fy24','fy25','fy23','fy22','fy26',
    'igf','igt','igf::ot::igf','igf::ct::igf','continued','continue','exercise','modification',
    'inc','llc','corp','ltd','company','group','systems','solutions','technologies',
    'total','amount','funded','funding','obligated','estimated','approximately','pursuant',
    'addition','additional','added','update','updated','existing','current','ensure',
    'management','operations','operational','program','project','specific','require',
    'required','requirements','department','office','national','center','united','states',
    'necessary','needed','resources','within','without','above','below','following','general',
    'activities','activity','efforts','effort','performance','mission','critical','executive'
  ]),

  // Extract the most frequent meaningful terms from award text
  extract(awards) {
    const phraseCounts = {};  // phrase -> number of awards containing it
    const phraseExamples = {};
    const total = awards.length;
    if (!total) return [];

    awards.forEach(award => {
      const desc = (award['Description'] || '').toLowerCase();
      const psc = (award['PSC Description'] || '').toLowerCase();
      const naics = (award['NAICS Description'] || '').toLowerCase();
      const text = `${desc} ${psc} ${naics}`;

      // Tokenize: strip colons first (kills IGF::OT::IGF), then keep alphanumeric and hyphens
      const words = text.replace(/:+/g, ' ').replace(/[^a-z0-9\-]+/g, ' ').split(/\s+/).filter(w => w.length > 2 && !this._stop.has(w));

      // Collect unique bigrams and trigrams from this award
      const seen = new Set();

      // Meaningful single words (only longer domain-specific ones, 8+ chars to avoid generic noise)
      words.forEach(w => {
        if (w.length >= 8 && !this._stop.has(w)) {
          seen.add(w);
        }
      });

      // Bigrams
      for (let i = 0; i < words.length - 1; i++) {
        const bg = `${words[i]} ${words[i+1]}`;
        if (!this._stop.has(words[i]) && !this._stop.has(words[i+1])) {
          seen.add(bg);
        }
      }

      // Trigrams
      for (let i = 0; i < words.length - 2; i++) {
        const tg = `${words[i]} ${words[i+1]} ${words[i+2]}`;
        if (!this._stop.has(words[i]) && !this._stop.has(words[i+2])) {
          seen.add(tg);
        }
      }

      seen.forEach(phrase => {
        phraseCounts[phrase] = (phraseCounts[phrase] || 0) + 1;
        if (!phraseExamples[phrase]) {
          phraseExamples[phrase] = (award['Description'] || '').substring(0, 100);
        }
      });
    });

    // Require phrase to appear in at least 2 awards or 5% of results (whichever is lower)
    const minCount = Math.max(2, Math.ceil(total * 0.03));

    // Score: prefer multi-word phrases, penalize very short single words
    let candidates = Object.entries(phraseCounts)
      .filter(([phrase, count]) => count >= Math.min(minCount, 2))
      .map(([phrase, count]) => {
        const wordCount = phrase.split(' ').length;
        // Boost multi-word phrases so "jet engine maintenance" beats "maintenance"
        const boost = wordCount >= 3 ? 1.5 : wordCount === 2 ? 1.2 : 1.0;
        return { phrase, count, score: count * boost };
      })
      .sort((a, b) => b.score - a.score);

    // Deduplicate: if a longer phrase contains a shorter one with similar count, drop the shorter
    const results = [];
    const used = new Set();
    for (const c of candidates) {
      if (results.length >= 5) break;
      // Check if this phrase is a substring of an already-selected longer phrase
      let dominated = false;
      for (const r of results) {
        if (r.phrase.includes(c.phrase) || c.phrase.includes(r.phrase)) {
          // Keep the one with higher count, skip the other
          if (c.count <= r.count * 1.3) { dominated = true; break; }
        }
      }
      if (dominated) continue;
      results.push(c);
    }

    // Titlecase the phrases for display
    const titleCase = s => s.replace(/\b\w/g, c => c.toUpperCase());

    return results.map(r => ({
      skill: r.phrase.toUpperCase(),
      count: r.count,
      percentage: Math.round((r.count / total) * 100),
      example: phraseExamples[r.phrase] || ''
    }));
  }
};

// ==================== ENHANCED SALES PLAN MANAGER ====================
const SalesPlanManager = {
  channels: new Set(),
  currentVendors: [],
  detectedIntent: null,
  
  init() {
    // Hydrate channel set from URL param if present (no localStorage dependency)
    try {
      const params = new URLSearchParams(window.location.search);
      const encoded = params.get('ch');
      if (encoded) {
        const decoded = decodeURIComponent(atob(encoded));
        this.channels = new Set(JSON.parse(decoded));
      }
    } catch (e) {
      // Silently fall back to empty set — user can re-classify
    }
  },

  isChannel(vendorName) { 
    return this.channels.has(vendorName); 
  },

  // ==================== INTENT DETECTION ====================
  detectIntent(awards) {
    const query = App.currentQuery || '';
    const vendorSpend = {};
    let totalSpend = 0;
    
    awards.forEach(r => {
      const v = r['Recipient Name'] || 'Unknown';
      const a = parseFloat(r['Award Amount']) || 0;
      vendorSpend[v] = (vendorSpend[v] || 0) + a;
      totalSpend += a;
    });
    
    const vendors = Object.entries(vendorSpend)
      .map(([name, spend]) => ({ name, spend, share: spend / totalSpend }))
      .sort((a, b) => b.spend - a.spend);
    
    // Calculate channel metrics
    let channelSpend = 0;
    let channelCount = 0;
    vendors.forEach(v => {
      if (this.isChannel(v.name)) {
        channelSpend += v.spend;
        channelCount++;
      }
    });
    const channelShare = totalSpend > 0 ? channelSpend / totalSpend : 0;
    
    // Detect Product/OEM (high channel share)
    if (channelShare > 0.7 && channelCount >= 3) {
      return {
        type: 'product_oem',
        icon: 'fa-box',
        title: 'PRODUCT / OEM CHANNEL',
        description: `${(channelShare * 100).toFixed(1)}% of revenue flows through ${channelCount} channel partners`,
        focusAreas: [
          'Channel performance & rankings',
          'Partner enablement priorities', 
          'Recompete defense by partner',
          'Agency coverage gaps'
        ],
        suggestedGoal: 'Partnership'
      };
    }
    
    // Detect own company search
    const topVendor = vendors[0];
    if (topVendor && query.toLowerCase().includes(topVendor.name.toLowerCase().split(' ')[0])) {
      return {
        type: 'own_company',
        icon: 'fa-building',
        title: 'YOUR COMPANY ANALYSIS',
        description: `Analyzing your market position: ${Utils.money(topVendor.spend)} (${(topVendor.share * 100).toFixed(1)}% share)`,
        focusAreas: [
          'Defend existing contracts',
          'Identify growth opportunities',
          'Competitive threats to your position',
          'Recompete calendar & defense'
        ],
        suggestedGoal: 'Retention'
      };
    }
    
    // Detect agency search
    const agencyKeywords = ['department', 'agency', 'administration', 'commission', 'bureau'];
    if (agencyKeywords.some(kw => query.toLowerCase().includes(kw))) {
      return {
        type: 'agency',
        icon: 'fa-landmark',
        title: 'AGENCY PENETRATION',
        description: `Analyzing how to enter or expand within this customer`,
        focusAreas: [
          'Agency mission & budget priorities',
          'Current vendor landscape',
          'Entry points & opportunities',
          'Key contracting vehicles'
        ],
        suggestedGoal: 'Growth'
      };
    }
    
    // Default: Market/keyword search
    return {
      type: 'market_keyword',
      icon: 'fa-chart-line',
      title: 'MARKET ANALYSIS',
      description: `Analyzing the "${query}" market landscape`,
      focusAreas: [
        'Market size & growth trends',
        'Competitive landscape',
        'Top agencies & opportunities',
        'Entry strategy recommendations'
      ],
      suggestedGoal: 'Growth'
    };
  },

  // ==================== UI ACTIONS ====================
  open() {
    const awards = App.forecastData.awards || App.searchData.raw || [];
    if (!awards.length) {
      alert("No award data loaded. Please run a search or forecast first.");
      return;
    }

    // Detect intent
    this.detectedIntent = this.detectIntent(awards);
    
    // Populate Agency Dropdown
    const agencyCounts = {};
    awards.forEach(r => {
      const ag = r['Awarding Agency'];
      if(ag) agencyCounts[ag] = (agencyCounts[ag] || 0) + 1;
    });
    
    const sortedAgencies = Object.entries(agencyCounts)
      .sort((a,b) => b[1] - a[1])
      .map(([name, count]) => `<option value="${name}">${name} (${count} awards)</option>`)
      .join('');
      
    document.getElementById('spSpecificAgencies').innerHTML = sortedAgencies;
    document.getElementById('spScope').value = 'all';
    
    // Set suggested goal based on intent
    document.getElementById('spFocus').value = this.detectedIntent.suggestedGoal;

    // Prepare and render
    this.prepareVendorList(awards);
    this.renderIntentBanner();
    this.updateStatus(awards.length, "Entire Market");
    this.renderSmartVendorList();
    
    // Re-filter vendor list when scope changes
    const scopeEl = document.getElementById('spScope');
    if (scopeEl && !scopeEl._spBound) {
      scopeEl._spBound = true;
      scopeEl.addEventListener('change', () => {
        try {
          const { filteredAwards, scopeName } = SalesPlanManager.getFilteredData();
          SalesPlanManager.prepareVendorList(filteredAwards);
          SalesPlanManager.renderSmartVendorList();
          SalesPlanManager.updateStatus(filteredAwards.length, scopeName);
        } catch(e) {
          document.getElementById('spDataStatus').textContent = 'No awards match this scope.';
        }
      });
    }
    
    ModalUtils.open('salesPlanModal');
  },

  close() {
    ModalUtils.close();
    // Also close success modal if open
    const successModal = document.getElementById('copySuccessModal');
    if (successModal) successModal.classList.remove('active');
  },

  // ==================== INTENT BANNER ====================
  renderIntentBanner() {
    const banner = document.getElementById('spIntentBanner');
    if (!banner || !this.detectedIntent) return;
    
    const intent = this.detectedIntent;
    banner.innerHTML = `
      <div class="intent-banner-content">
        <div class="intent-banner-icon"><i class="fas ${intent.icon}"></i></div>
        <div class="intent-banner-text">
          <div class="intent-banner-title">${intent.title}</div>
          <div class="intent-banner-desc">${intent.description}</div>
          <div class="intent-banner-focus">
            ${intent.focusAreas.map(f => `<span class="focus-tag">${f}</span>`).join('')}
          </div>
        </div>
      </div>
    `;
    banner.style.display = 'block';
  },

  // ==================== DATA PROCESSING ====================
  getFilteredData() {
    const scope = document.getElementById('spScope').value;
    const focus = document.getElementById('spFocus').value;
    const rawAwards = App.forecastData.awards || App.searchData.raw || [];
    
    let filteredAwards = [];
    let scopeName = "Entire Market";

    if (scope === 'all') {
      filteredAwards = rawAwards;
    } else if (scope === 'defense') {
      filteredAwards = rawAwards.filter(r => /defense|army|navy|air force|marine|space force/i.test(r['Awarding Agency']));
      scopeName = "Defense Sector";
    } else if (scope === 'civilian') {
      filteredAwards = rawAwards.filter(r => !/defense|army|navy|air force|marine|space force/i.test(r['Awarding Agency']));
      scopeName = "Federal Civilian Sector";
    } else {
      filteredAwards = rawAwards.filter(r => r['Awarding Agency'] === scope);
      scopeName = scope;
    }

    if (filteredAwards.length === 0) throw new Error("No awards found for the selected scope.");

    return { filteredAwards, scopeName, focus };
  },

  // ==================== OUTPUT ACTIONS ====================
  generate() {
    App.showLoader('GENERATING PLAN...', 'Filtering data & packaging prompt...');
    setTimeout(() => {
      try {
        const { filteredAwards, scopeName, focus } = this.getFilteredData();
        // SAFE PASSING OF ANALYSIS
        const analysisData = App.forecastData && App.forecastData.analysis ? App.forecastData.analysis : null;
        
        const pkg = PromptPackageGenerator.buildPackage(filteredAwards, analysisData, { scope: scopeName, focus });
        PromptPackageGenerator.downloadPackage(pkg);
        this.close();
      } catch(e) { 
        console.error(e); 
        alert(e.message || "Error generating plan");
      } finally { 
        App.hideLoader(); 
      }
    }, 500);
  },

  async copyPrompt() {
    const btn = document.getElementById('btnCopyPrompt');
    if (!btn) return;

    const originalHTML = btn.innerHTML;
    
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
    btn.style.opacity = '0.7';
    btn.style.pointerEvents = 'none';
    
    try {
      const { filteredAwards, scopeName, focus } = this.getFilteredData();
      // SAFE PASSING OF ANALYSIS
      const analysisData = App.forecastData && App.forecastData.analysis ? App.forecastData.analysis : null;
      
      const pkg = PromptPackageGenerator.buildPackage(filteredAwards, analysisData, { scope: scopeName, focus });
      
      await navigator.clipboard.writeText(pkg);
      this.showCopySuccessModal(pkg.length);
      
      btn.innerHTML = originalHTML;
      btn.style.opacity = '1';
      btn.style.pointerEvents = 'auto';
      
    } catch(e) {
      console.error(e);
      alert(e.message || "Error copying prompt");
      btn.innerHTML = originalHTML;
      btn.style.opacity = '1';
      btn.style.pointerEvents = 'auto';
    }
  },

showCopySuccessModal(charCount) {
  let modal = document.getElementById('copySuccessModal');
  
  if (!modal) {
    modal = document.createElement('div');
    modal.id = 'copySuccessModal';
    modal.className = 'channel-marking-modal';
    document.body.appendChild(modal);
  }
  
  const estimatedTokens = Math.round(charCount / 4);
  
  modal.innerHTML = `
    <div class="channel-modal-content" style="max-width: 420px; height: auto; border-top: 4px solid var(--accent) !important; background: var(--bg-card);">
      <div class="channel-modal-header" style="border-bottom: 1px solid var(--border);">
        <div class="channel-modal-title mono" style="font-size: 1rem; color: #F1EEE9;">
          <i class="fas fa-check-circle" style="color: var(--accent); margin-right: 8px;"></i> PROMPT COPIED
        </div>
        <button class="channel-modal-close" onclick="SalesPlanManager.closeSuccessModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="channel-modal-body" style="padding: 1.5rem; background: var(--bg-card);">
        <div style="margin-bottom: 1.5rem; border-left: 2px solid var(--accent); padding-left: 1rem;">
          <div style="font-size: 0.9rem; color: #F1EEE9; font-weight: 600; margin-bottom: 0.25rem; font-family: 'JetBrains Mono', monospace;">Ready to Paste</div>
          <div style="font-size: 0.7rem; color: var(--text-muted); font-family: 'JetBrains Mono', monospace; text-transform: uppercase; letter-spacing: 1px;">
            ${charCount.toLocaleString()} chars · ~${estimatedTokens.toLocaleString()} tokens
          </div>
        </div>
        
        <div style="font-size: 0.6rem; color: var(--accent); text-transform: uppercase; letter-spacing: 2px; margin-bottom: 1rem; font-family: 'JetBrains Mono', monospace; font-weight: 700;">
          Launch AI Workspace
        </div>
        
        <div style="display: flex; flex-direction: column; gap: 0.75rem; margin-bottom: 1.5rem;">
          <a href="https://claude.ai/new" target="_blank" rel="noopener" class="btn-primary" style="padding: 0.6rem; font-size: 0.75rem; justify-content: center; text-decoration: none;">
            <i class="fas fa-robot"></i> Open Claude
          </a>
          <a href="https://chat.openai.com" target="_blank" rel="noopener" class="btn-primary" style="padding: 0.6rem; font-size: 0.75rem; justify-content: center; text-decoration: none;">
            <i class="fas fa-bolt"></i> Open ChatGPT
          </a>
          <a href="https://gemini.google.com/app" target="_blank" rel="noopener" class="btn-primary" style="padding: 0.6rem; font-size: 0.75rem; justify-content: center; text-decoration: none;">
            <i class="fas fa-stars"></i> Open Gemini
          </a>
        </div>
        
        <div style="font-size: 0.75rem; color: var(--text-muted); line-height: 1.6; font-style: italic; border-top: 1px dashed var(--border); padding-top: 1rem;">
          Paste this prompt into your preferred AI to generate a full tactical sales plan based on the live data from your search.
        </div>
      </div>
      
      <div class="channel-modal-footer" style="background: rgba(0,0,0,0.2); border-top: 1px solid var(--border);">
        <button class="btn-secondary" onclick="SalesPlanManager.closeSuccessModal()" style="padding: 0.5rem 1rem; font-size: 0.7rem; min-width: 80px; flex: none;">
          Close
        </button>
      </div>
    </div>
  `;
  
  ModalUtils.open('copySuccessModal');
},

  togglePreview() {
    const section = document.getElementById('spPreviewSection');
    const content = document.getElementById('spPreviewContent');
    const stats = document.getElementById('spPreviewStats');
    if (!section || !content) return;
    
    const isVisible = section.style.display !== 'none';
    if (isVisible) {
      section.style.display = 'none';
      return;
    }
    
    try {
      const { filteredAwards, scopeName, focus } = this.getFilteredData();
      const analysisData = App.forecastData && App.forecastData.analysis ? App.forecastData.analysis : null;
      const pkg = PromptPackageGenerator.buildPackage(filteredAwards, analysisData, { scope: scopeName, focus });
      
      content.textContent = pkg.substring(0, 3000) + (pkg.length > 3000 ? '\n\n... [truncated — full prompt is ' + pkg.length.toLocaleString() + ' chars]' : '');
      if (stats) {
        const tokens = Math.round(pkg.length / 4);
        stats.textContent = pkg.length.toLocaleString() + ' chars · ~' + tokens.toLocaleString() + ' tokens';
      }
      section.style.display = 'block';
      section.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    } catch(e) {
      content.textContent = 'Error generating preview: ' + e.message;
      section.style.display = 'block';
    }
  },

  closeSuccessModal() {
    ModalUtils.close();
    // Also ensure main modal is closed
    document.getElementById('salesPlanModal').classList.remove('active');
    document.body.style.overflow = '';
  },

  // ==================== VENDOR LIST HELPERS ====================
  prepareVendorList(dataSlice) {
    const vendorSpend = {}; 
    let total = 0;
    
    dataSlice.forEach(r => { 
      const v = r['Recipient Name'] || 'Unknown'; 
      const a = parseFloat(r['Award Amount']) || 0; 
      vendorSpend[v] = (vendorSpend[v] || 0) + a; 
      total += a; 
    });
    
    this.currentVendors = Object.entries(vendorSpend)
      .map(([v, s]) => ({ 
        vendor: v, 
        spend: s, 
        marketShare: total > 0 ? ((s / total) * 100).toFixed(2) : "0.00", 
        contractCount: dataSlice.filter(r => r['Recipient Name'] === v).length,
        classification: KnownVendors.classify(v)
      }))
      .sort((a, b) => b.spend - a.spend)
      .slice(0, 30); // Increased to 30 for better coverage
  },

  updateStatus(count, scopeName) {
    const statusEl = document.getElementById('spDataStatus');
    if(!statusEl) return;
    
    const channelCount = this.currentVendors.filter(v => this.isChannel(v.vendor)).length;
    const totalVendors = this.currentVendors.length;
    
    statusEl.innerHTML = `
      <span style="color:var(--success);"><i class="fas fa-check-circle"></i></span>
      Ready · ${count} awards · ${channelCount}/${totalVendors} channels
    `;
  },

  // ==================== TOGGLE LOGIC ====================
  toggleChannel(vendorName) {
    if (this.channels.has(vendorName)) this.channels.delete(vendorName);
    else this.channels.add(vendorName);
    this.save();
    this.updateStatus(App.forecastData.awards?.length || App.searchData.raw?.length || 0, 
      document.getElementById('spScope')?.value === 'all' ? 'Entire Market' : document.getElementById('spScope')?.value);
  },

  toggleAll() {
    const allMarked = this.currentVendors.every(v => this.isChannel(v.vendor));
    if (allMarked) this.currentVendors.forEach(v => this.channels.delete(v.vendor));
    else this.currentVendors.forEach(v => this.channels.add(v.vendor));
    
    this.save();
    this.renderSmartVendorList();
    this.updateStatus(App.forecastData.awards?.length || App.searchData.raw?.length || 0, 
      document.getElementById('spScope')?.value === 'all' ? 'Entire Market' : document.getElementById('spScope')?.value);
  },

  acceptSuggested() {
    // Mark all suggested VARs as channels
    this.currentVendors.forEach(v => {
      if (v.classification === 'var' || v.classification === 'likely_var') {
        this.channels.add(v.vendor);
      }
    });
    this.save();
    this.renderSmartVendorList();
    this.updateStatus(App.forecastData.awards?.length || App.searchData.raw?.length || 0, 
      document.getElementById('spScope')?.value === 'all' ? 'Entire Market' : document.getElementById('spScope')?.value);
  },

  save() { 
    // Persist channel set into URL param so it survives shares and bookmarks (no localStorage)
    try {
      const url = new URL(window.location);
      if (this.channels.size > 0) {
        const encoded = btoa(encodeURIComponent(JSON.stringify([...this.channels])));
        url.searchParams.set('ch', encoded);
      } else {
        url.searchParams.delete('ch');
      }
      window.history.replaceState({}, '', url);
    } catch (e) {
      // URL update failed — channels remain in-memory for this session
    }
  },

  // ==================== SMART VENDOR LIST RENDERING ====================
  renderSmartVendorList() {
    const list = document.getElementById('spVendorList');
    const container = document.getElementById('spBulkActionContainer');
    if(!list || !container) return;

    // Group vendors by classification
    const suggestedVars = this.currentVendors.filter(v => 
      (v.classification === 'var' || v.classification === 'likely_var') && !this.isChannel(v.vendor)
    );
    const primes = this.currentVendors.filter(v => v.classification === 'prime');
    const unknown = this.currentVendors.filter(v => 
      v.classification === 'unknown' && !this.isChannel(v.vendor)
    );
    const alreadyMarked = this.currentVendors.filter(v => this.isChannel(v.vendor));

    const allMarked = this.currentVendors.length > 0 && this.currentVendors.every(v => this.isChannel(v.vendor));
    
    // Bulk action buttons
    container.innerHTML = `
      <div style="display: flex; gap: 0.5rem;">
        ${suggestedVars.length > 0 ? `
          <button onclick="SalesPlanManager.acceptSuggested()" style="background: rgba(76, 175, 80, 0.1); border: 1px solid var(--success); color: var(--success); padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.7rem; font-family: 'JetBrains Mono'; display: flex; align-items: center; gap: 6px;">
            <i class="fas fa-magic"></i> ACCEPT SUGGESTIONS (${suggestedVars.length})
          </button>
        ` : ''}
        <button onclick="SalesPlanManager.toggleAll()" style="background: transparent; border: 1px solid var(--border); color: var(--accent); padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.7rem; font-family: 'JetBrains Mono'; display: flex; align-items: center; gap: 6px;">
          <i class="far ${allMarked ? 'fa-square' : 'fa-check-square'}"></i> ${allMarked ? 'UNMARK ALL' : 'MARK ALL'}
        </button>
      </div>
    `;

    if (this.currentVendors.length === 0) {
      list.innerHTML = `<div style="text-align:center; padding:1rem; color:var(--text-subtle);">No vendors found in this scope.</div>`;
      return;
    }

    let html = '';

    // Already Marked Section
    if (alreadyMarked.length > 0) {
      html += this.renderVendorSection(
        'MARKED AS CHANNELS',
        'These vendors are already marked as your channel partners',
        alreadyMarked,
        'success'
      );
    }

    // Suggested VARs Section  
    if (suggestedVars.length > 0) {
      html += this.renderVendorSection(
        'SUGGESTED CHANNELS',
        'We detected these as likely resellers/VARs based on known patterns',
        suggestedVars,
        'accent'
      );
    }

    // Unknown/Review Section
    if (unknown.length > 0) {
      html += this.renderVendorSection(
        '❓ NEEDS REVIEW', 
        'We couldn\'t automatically classify these vendors',
        unknown,
        'muted'
      );
    }

    // Primes Section (usually not marked as channels)
    if (primes.length > 0) {
      html += this.renderVendorSection(
        'LIKELY PRIMES/SIs',
        'These appear to be system integrators or large primes',
        primes,
        'muted'
      );
    }

    list.innerHTML = html;
  },

  renderVendorSection(title, description, vendors, colorClass) {
    const colorMap = {
      'success': 'var(--success)',
      'accent': 'var(--accent)',
      'muted': 'var(--text-subtle)'
    };
    const borderColor = colorMap[colorClass] || 'var(--text-subtle)';
    
    return `
      <div style="margin-bottom: 1.5rem;">
        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
          <span style="font-size: 0.8rem; font-weight: 700; color: ${borderColor}; text-transform: uppercase; letter-spacing: 0.5px;">
            ${title}
          </span>
          <span style="font-size: 0.7rem; color: var(--text-subtle);">(${vendors.length})</span>
        </div>
        <div style="font-size: 0.75rem; color: #888; margin-bottom: 0.75rem;">${description}</div>
        <div style="border: 1px solid var(--border); border-radius: 6px; overflow: hidden; border-left: 3px solid ${borderColor};">
          ${vendors.map(v => this.renderVendorRow(v)).join('')}
        </div>
      </div>
    `;
  },

  renderVendorRow(v) {
    const isMarked = this.isChannel(v.vendor);
    return `
      <div class="vendor-list-item" style="border-bottom: 1px solid var(--border); padding: 0.6rem 0.75rem;">
        <div class="vendor-info" style="flex: 1;">
          <div class="vendor-name" style="font-size: 0.85rem; font-weight: 600; color: #F1EEE9;">${v.vendor}</div>
          <div class="vendor-stats" style="font-size: 0.7rem; color: #888;">
            ${v.contractCount} contracts • ${Utils.money(v.spend)} • ${v.marketShare}% share
          </div>
        </div>
        <div class="vendor-toggle" style="display: flex; align-items: center; gap: 0.5rem;">
          <div class="toggle-switch ${isMarked ? 'active' : ''}" onclick="SalesPlanManager.toggleItem('${v.vendor.replace(/'/g, "\\'")}', this)">
            <div class="toggle-slider"></div>
          </div>
          <div class="toggle-label" style="font-size: 0.7rem; width: 70px; color: ${isMarked ? 'var(--success)' : '#888'};">
            ${isMarked ? 'Channel' : 'Competitor'}
          </div>
        </div>
      </div>
    `;
  },

  toggleItem(vendorName, element) {
    this.toggleChannel(vendorName);
    this.renderSmartVendorList(); 
  }
};
// ==================== APP CORE ====================
const App = {
  mode: 'search', 
  currentQuery: '',
  searchData: { raw: [], active: [], filter: null, loaded: false },
  forecastData: { spending: null, agencies: null, awards: null, analysis: null, loaded: false },
  drillState: { level: 0, path: [], currentAgency: null, currentSubAgency: null },
  subawardDrillState: { level: 0, path: [], filter: null, filterType: null },
  activeFeedSource: 'prime', // 'prime' or 'sub' - tracks which Sankey the user is interacting with
  onlyHighMissionGap: false,

  init() {
    SalesPlanManager.init();
    
    // Initialize Autocomplete
    Autocomplete.init('mainSearchInput');
    Autocomplete.init('miniSearch');
    
    // Setup Event Delegation for all data-action handlers
    this.setupEventDelegation();
    
    // Legacy event listeners for inputs
document.getElementById('mainSearchInput').addEventListener('keypress', e => { if(e.key === 'Enter') App.runSearch(); });
document.getElementById('miniSearch').addEventListener('keypress', e => { if(e.key === 'Enter') { document.getElementById('mainSearchInput').value = e.target.value; App.runSearch(e.target.value); } });

// Select all text on focus for easy replacement
document.getElementById('mainSearchInput').addEventListener('focus', function() { this.select(); });
document.getElementById('miniSearch').addEventListener('focus', function() { this.select(); });

// Show/hide clear button for main search only
function setupClearButton(inputId, buttonClass) {
  const input = document.getElementById(inputId);
  const btn = document.querySelector('.' + buttonClass);
  if (!input || !btn) return;
  
  // Move button inside the autocomplete wrapper
  const wrapper = input.closest('.autocomplete-wrapper');
  if (wrapper && btn.parentNode !== wrapper) {
    wrapper.appendChild(btn);
  }
  
  const toggle = () => btn.classList.toggle('visible', input.value.length > 0);
  input.addEventListener('input', toggle);
  input.addEventListener('change', toggle);
  toggle();
}
setupClearButton('mainSearchInput', 'input-clear');

    let resizeTimer;
    window.addEventListener('resize', () => { 
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(() => { 
        // Skip expensive re-renders if a modal is covering the screen
        if (document.querySelector('.channel-marking-modal.active, .pipeline-modal.active, .convo-modal.active')) return;
        
        if(App.mode === 'search' && App.searchData?.active?.length > 0) {
          App.renderSankey(); 
        }
        // Always try to re-render subaward Sankey if data exists and wrapper is visible
        const subawardWrapper = document.getElementById('subawardWrapper');
        if(App.forecastData?.subawards && subawardWrapper && subawardWrapper.style.display !== 'none') {
          App.renderSubawardSankey(App.forecastData.subawards);
        }
      }, 250); 
    });

    // Preload visualization libraries during idle time
    LibLoader.preloadWhenIdle();

    const params = new URLSearchParams(window.location.search);
    const q = params.get('q');
    const mode = params.get('mode');

    if (q) {
      document.getElementById('mainSearchInput').value = q;
      App.runSearch(q);
    }
  },
  
  // Event Delegation - handles all data-action clicks
  setupEventDelegation() {
    document.addEventListener('click', (e) => {
      const target = e.target.closest('[data-action]');
      if (!target) return;
      
      const action = target.dataset.action;
      const actions = {
        'search': () => this.runSearch(),
        'forecast': () => this.runForecast(),
        'showHero': () => this.showHero(),
        'toggleMode': () => {},
        'setModeSearch': () => {},
        'setModeForecast': () => {},
        'resetDrill': () => this.resetDrill(),
        'clearFilter': () => this.resetDrill(),
        'shareLink': () => this.shareLink(target),
        'shareBrief': () => this.shareBrief(target),
        'exportCSV': () => this.exportCSV(target),
        'openSalesPlan': () => SalesPlanManager.open(),
        'closeSalesPlan': () => SalesPlanManager.close(),
        'copyPrompt': () => SalesPlanManager.copyPrompt(),
        'generateDownload': () => SalesPlanManager.generate(),
        'closeSuccessModal': () => SalesPlanManager.closeSuccessModal(),
        'resetSubawardDrill': () => this.resetSubawardDrill(),
        'toggleChannel': () => {
          const vendor = target.dataset.vendor;
          if (vendor) SalesPlanManager.toggleChannel(vendor);
        },
        // Pipeline Builder actions
        'openPipelineBuilder': () => PipelineBuilder.open(),
        'closePipelineBuilder': () => PipelineBuilder.close(),
        'generatePipeline': () => PipelineBuilder.generate(),
        'downloadPipelineCSV': () => PipelineBuilder.downloadCSV(),
        // Conversation Starters actions
        'openConvoStarters': () => ConvoStarters.open('prime'),
        'openSubConvoStarters': () => ConvoStarters.open('sub'),
        'closeConvoStarters': () => ConvoStarters.close(),
        'copyAllConvo': () => ConvoStarters.copyAll(),
        'downloadConvoPDF': () => ConvoStarters.downloadForPhone()
      };
      
      if (actions[action]) {
        e.preventDefault();
        actions[action]();
      }
    });
  },

  showHero() {
    document.getElementById('appView').style.display = 'none';
    const hero = document.getElementById('heroView'); hero.style.display = 'flex'; hero.classList.remove('hidden');
    setTimeout(() => hero.classList.remove('slide-up'), 10);
  },

  setMode(mode) {
    App.mode = 'search';
    const smv = document.getElementById('searchModeView');
    if (smv) smv.classList.add('active');
  },

  toggleMode() { },

  // --- Search Mode ---
  async runSearch(val) {
    let query = val || document.getElementById('mainSearchInput').value; if(!query) return;
	query = Utils.normalizeQuery(query);
  document.getElementById('mainSearchInput').value = query;
  document.title = `Govhoo | ${query.toUpperCase()}`;
    if(query !== App.currentQuery) { App.searchData = { raw: [], active: [], filter: null, loaded: false }; App.forecastData = { loaded: false }; App.searchGeoData = null; App.resetDrill(); App.subawardDrillState = { level: 0, path: [], filter: null, filterType: null }; }
    App.currentQuery = query; App.mode = 'search'; App.showLoader('SCANNING ' + query.toUpperCase(), 'Pulling live awards from USASpending.gov');
    try {
      // Ensure D3 is loaded for Sankey (preloaded during idle, so usually instant)
      await LibLoader.loadD3();
      App.searchData.raw = await API.searchAwards(query); App.searchData.active = App.searchData.raw; App.searchData.loaded = true;
      App.transitionToApp(); App.setMode('search'); App.updateSearchDashboard(); this.loadSubcontractingData(query); this.loadGeoDataForSearch(query); requestAnimationFrame(() => App.renderSankey());
      // Background: load forecast data and render strategy tools into search view
      this.loadForecastInBackground(query);
    } catch(e) { console.error(e); alert("Error retrieving data."); } finally { App.hideLoader(); }
  },
  
  // Load geo data for search view job locations panel (non-blocking)
  async loadGeoDataForSearch(query) {
    const body = document.getElementById('searchLocationsBody');
    
    // Timeout wrapper — show fallback if geo API takes longer than 15 seconds
    const timeout = setTimeout(() => {
      if (body && body.textContent.includes('Loading')) {
        body.innerHTML = `<div class="muted text-xs" style="text-align:center;">
          <i class="fas fa-exclamation-circle" style="color:var(--danger);"></i> Location data unavailable.
          <br><a href="#" onclick="App.loadGeoDataForSearch('${query.replace(/'/g, "\\'")}'); return false;" style="color:var(--accent); text-decoration:underline;">Retry</a>
        </div>`;
      }
    }, 15000);
    
    try {
      const data = await API.getSpendingByGeography(query, 'state');
      clearTimeout(timeout);
      App.searchGeoData = data;
      App.renderSearchLocations();
    } catch(e) {
      clearTimeout(timeout);
      console.warn('Could not load geo data:', e);
      if (body) {
        body.innerHTML = `<div class="muted text-xs" style="text-align:center;">
          <i class="fas fa-exclamation-circle" style="color:var(--danger);"></i> Location data unavailable.
          <br><a href="#" onclick="App.loadGeoDataForSearch('${query.replace(/'/g, "\\'")}'); return false;" style="color:var(--accent); text-decoration:underline;">Retry</a>
        </div>`;
      }
    }
  },

  // Background forecast loading — runs after search, populates strategy tools + spending chart + recompetes
  async loadForecastInBackground(query) {
    if (!query) return;
    try {
      await LibLoader.ensureAll();
      const [spending, agencies, awards] = await Promise.all([
        API.getSpendingOverTime(query),
        API.getAgencyData(query),
        API.getAwardsForForecast(query)
      ]);
      App.forecastData = {
        spending, agencies, awards,
        analysis: ForecastEngine.analyze(spending, awards, agencies),
        subawards: App.forecastData?.subawards || null,
        loaded: true
      };
      // Now render the strategy pieces into the search view
      App.renderStrategyTools();
    } catch(e) {
      console.warn('Background forecast load failed:', e);
    }
  },

  // Render strategy tools, spending chart, expiring stat, and recompetes into search view
  renderStrategyTools() {
    // Forecast-dependent items: GTM, Pipeline, Recompetes
    const analysis = App.forecastData && App.forecastData.analysis;
    if (!analysis) return;

    // Show GTM Plan + Pipeline Builder buttons in action bar
    const gtmBtn = document.getElementById('gtmPlanBtn');
    const pipelineBtn = document.getElementById('pipelineBtn');
    if (gtmBtn) gtmBtn.style.display = 'flex';
    if (pipelineBtn) pipelineBtn.style.display = 'flex';

    // Determine drill-filtered recompetes
    const allRecompetes = analysis.recompetes || [];
    const drill = App.drillState || {};
    let filteredRecompetes = allRecompetes;
    if (drill.level >= 1 && drill.currentAgency) {
      filteredRecompetes = allRecompetes.filter(r => r['Awarding Agency'] === drill.currentAgency);
      if (drill.level >= 2 && drill.currentSubAgency) {
        filteredRecompetes = filteredRecompetes.filter(r => r['Awarding Sub Agency'] === drill.currentSubAgency);
      }
    }

    // Render recompetes (filtered)
    this.renderRecompetes(filteredRecompetes);
  },

  // Re-fetch or re-use spending data based on drill state
  updateSearchDashboard() {
    const data = App.searchData.active;
    document.getElementById('stat-vol').innerText = Utils.money(data.reduce((acc, c) => acc + (c['Award Amount']||0), 0));
    document.getElementById('stat-count').innerText = data.length;
    document.getElementById('stat-vendors').innerText = new Set(data.map(c => c['Recipient Name'])).size;
    document.getElementById('stat-agencies').innerText = new Set(data.map(c => c['Awarding Agency'])).size;
    App.renderFeed(); App.updateDrillUI();
    
    // Update Job Seeker Panels (dynamically based on active/filtered data)
    App.renderSearchTopWinners(data);
	App.renderSearchTopBuyers(data);
    App.renderSearchSkills(data);
    App.renderSearchLocations();
    
    // Refresh strategy tools (spending chart from search data, recompetes if forecast loaded)
    App.renderStrategyTools();
    
    // Enable Conversation Starters button
    // Update sankey subtitle with query context
    const subEl = document.getElementById('sankeySubtitle');
    if (subEl && App.currentQuery) {
      subEl.textContent = '"' + App.currentQuery.toUpperCase() + '" · LAST 12 MONTHS · TOP 100 BY VALUE';
    }
    
    // Add loaded animation to sankey
    const sankeyEl = document.getElementById('sankeyPanel');
    if (sankeyEl) sankeyEl.classList.add('sankey-loaded');
    
    const convoBtn = document.getElementById('convoStartersBtn');
    if (convoBtn) {
      convoBtn.disabled = App.searchData.raw.length === 0;
    }
  },

  // --- Drill Down Logic ---
  resetDrill() { 
    App.drillState = { level: 0, path: [], currentAgency: null, currentSubAgency: null }; 
    App.searchData.filter = null; 
    App.searchData.active = App.searchData.raw; 
    App.activeFeedSource = 'prime';
    const officesPanel = document.getElementById('officesPanel');
    if (officesPanel) officesPanel.style.display = 'none'; 
    App.updateSearchDashboard(); 
    App.renderSankey(); 
  },
  
  updateDrillUI() {
  const bc = document.getElementById('drillBreadcrumb'); 
  const hint = document.getElementById('drillHint'); 
  const lvl = document.getElementById('drillLevelBadge');
  const levelText = document.getElementById('drillLevelText');
  const officesPanel = document.getElementById('officesPanel');
  const drillControlsBar = document.getElementById('drillControlsBar');
  const filterBadge = document.getElementById('filterBadge');

  if (App.drillState.level === 0) {
    if (drillControlsBar) drillControlsBar.style.display = 'none';
    hint.style.display = 'none'; 
    const _sp = document.getElementById('subagencyPanel'); if(_sp) _sp.style.display = 'none';
    if (officesPanel) officesPanel.style.display = 'none';
    if (filterBadge) filterBadge.style.display = 'none';
  } else {
    if (drillControlsBar) drillControlsBar.style.display = 'block';
    bc.style.display = 'flex'; 
    lvl.style.display = 'inline-flex';
    if (filterBadge && App.searchData.filter) {
      filterBadge.style.display = 'inline-flex';
      document.getElementById('filterName').innerText = Utils.trunc(App.searchData.filter, 20);
    } else if (filterBadge) {
      filterBadge.style.display = 'none';
    }
    
    // Set appropriate badge text
    if (App.drillState.level === 1) levelText.innerText = 'Agency View';
    else if (App.drillState.level === 2) levelText.innerText = 'Sub-Agency View';
    else if (App.drillState.level === 3) levelText.innerText = 'Vendor Perspective';

    let html = `<div class="breadcrumb-item" data-action="resetDrill"><i class="fas fa-globe breadcrumb-icon"></i><span>All Agencies</span></div>`;
    
    App.drillState.path.forEach((p, i) => {
      const isLast = i === App.drillState.path.length - 1;
      const action = isLast ? '' : `App.drillToLevel(${i + 1})`;
      html += `
        <span class="breadcrumb-separator"><i class="fas fa-chevron-right"></i></span>
        <div class="breadcrumb-item ${isLast ? 'active' : ''}" onclick="${action}">
          <span>${Utils.trunc(p.name, 25)}</span>
        </div>`;
    });
    bc.innerHTML = html; 

    if (App.drillState.level === 1) { 
      hint.innerHTML = `<i class="fas fa-layer-group"></i><span>Click a <strong>sub-agency</strong> or <strong>vendor</strong> to refine</span>`; 
      App.renderSubAgencyPanel();
      if (officesPanel) officesPanel.style.display = 'none';
    } else if (App.drillState.level === 2) {
      App.renderSubAgencyPanel();
      if (officesPanel) officesPanel.style.display = 'none';
      hint.innerHTML = `<i class="fas fa-check-circle" style="color:var(--success)"></i><span>Viewing <strong>sub-agency</strong> breakdown</span>`; 
    } else { 
      const _sp = document.getElementById('subagencyPanel'); if(_sp) _sp.style.display = 'none';
      if (officesPanel) officesPanel.style.display = 'none';
      hint.innerHTML = `<i class="fas fa-check-circle" style="color:var(--success)"></i><span>Viewing filtered breakdown</span>`; 
    }
  }
},

  renderSubAgencyPanel() {
    // Sub-agency display now handled by Top Agency Buyers panel
  },

  drillToAgency(name) {
  App.drillState = { 
    level: 1, 
    currentAgency: name, 
    currentSubAgency: null, 
    path: [{type: 'agency', name: name}] 
  };
  // ALWAYS filter from raw to prevent "No Data" screen
  App.searchData.active = App.searchData.raw.filter(d => d['Awarding Agency'] === name);
  App.searchData.filter = name;
  App.activeFeedSource = 'prime'; // Switch feed back to prime awards
  App.updateSearchDashboard();
  App.renderSankey();
},

drillToSubAgency(name) {
  App.drillState.level = 2;
  App.drillState.currentSubAgency = name;
  // Re-build path from the current agency and new sub-agency
  App.drillState.path = [
    {type: 'agency', name: App.drillState.currentAgency}, 
    {type: 'sub', name: name}
  ];
  // Filter from raw
  App.searchData.active = App.searchData.raw.filter(d => 
    d['Awarding Agency'] === App.drillState.currentAgency && 
    d['Awarding Sub Agency'] === name
  );
  App.searchData.filter = name;
  App.activeFeedSource = 'prime'; // Switch feed back to prime awards
  App.updateSearchDashboard();
  App.renderSankey();
},

  // Load offices for sub-agency
  async loadOfficesForSubAgency(subAgencyName) {
    const panel = document.getElementById('officesPanel');
    const list = document.getElementById('officesList');
    
    // Show loading state
    panel.style.display = 'block';
    document.getElementById('officesSubAgencyName').innerText = Utils.trunc(subAgencyName, 40);
    list.innerHTML = '<div style="text-align:center; padding:1rem; color:var(--text-muted);"><i class="fas fa-spinner fa-spin"></i> Loading offices...</div>';
    
    try {
      const offices = await API.fetchOfficesForSubAgency(subAgencyName);
      
      if (offices.length === 0) {
        list.innerHTML = '<div style="text-align:center; padding:1rem; color:var(--text-muted);">No contracting offices found for this sub-agency</div>';
        document.getElementById('officesCount').innerText = '0';
        document.getElementById('officesTotalAmount').innerText = '$0';
        return;
      }
      
      // Deduplicate offices by code
      const uniqueOffices = [];
      const seenCodes = new Set();
      offices.forEach(o => {
        if (!seenCodes.has(o.code)) {
          seenCodes.add(o.code);
          uniqueOffices.push(o);
        }
      });
      
      document.getElementById('officesCount').innerText = uniqueOffices.length;
      document.getElementById('officesTotalAmount').innerText = Utils.money(App.searchData.active.reduce((s, c) => s + (c['Award Amount'] || 0), 0));
      
      list.innerHTML = uniqueOffices.slice(0, 15).map((office, i) => `
        <div class="subagency-item" style="cursor: default;">
          <div class="subagency-item-left">
            <div class="subagency-rank ${i < 3 ? 'top-3' : ''}">${i + 1}</div>
            <div class="subagency-info">
              <div class="subagency-name">${Autocomplete.escapeHtml(office.name)}</div>
              <div class="subagency-contracts" style="font-family: 'JetBrains Mono', monospace; font-size: 0.7rem;">${Autocomplete.escapeHtml(office.code || 'N/A')}</div>
            </div>
          </div>
          <div class="subagency-item-right">
            <i class="fas fa-briefcase" style="color: var(--text-muted); opacity: 0.5;"></i>
          </div>
        </div>
      `).join('');
      
    } catch (e) {
      console.error('Error loading offices:', e);
      list.innerHTML = '<div style="text-align:center; padding:1rem; color:var(--text-muted);">Error loading offices</div>';
    }
  },
  drillToLevel(lvl) { 
  // Always restore full data before re-applying a level-specific filter
  App.searchData.active = App.searchData.raw;

  if (lvl === 0) {
    App.resetDrill();
  } else if (lvl === 1) {
    App.drillToAgency(App.drillState.path[0].name); 
  } else if (lvl === 2) {
    App.drillToSubAgency(App.drillState.path[1].name);
  }
},
  drillDown(name) {
  const data = App.searchData.raw;
  
  // 1. Identify the entity type from the master dataset
  const agencyMatch = data.find(d => d['Awarding Agency'] === name);
  const subAgencyMatch = data.find(d => d['Awarding Sub Agency'] === name);
  const vendorMatch = data.find(d => d['Recipient Name'] === name);

  // 2. Clear previous specific filters to avoid "No Data" conflicts
  App.searchData.active = data;

  if (agencyMatch && !subAgencyMatch) {
    // It's a top-tier agency: Clean drill to Level 1
    App.drillToAgency(name);
  } 
  else if (subAgencyMatch) {
    // If it's a sub-agency (or both), we must ensure the parent context is set
    // to prevent "No Description" breadcrumbs.
    const parentName = subAgencyMatch['Awarding Agency'];
    App.drillState.currentAgency = parentName; 
    App.drillToSubAgency(name);
  } 
  else if (vendorMatch) {
    // Vendor Perspective (Level 3)
    if (App.drillState.level === 3) {
      App.drillState.path.pop(); // Replace vendor if already in vendor view
    }
    
    App.drillState.level = 3; 
    App.drillState.path.push({ type: 'vendor', name: name });
    App.searchData.filter = `Vendor: ${name}`;
    App.activeFeedSource = 'prime'; // Switch feed back to prime awards
    
    // Filter specifically for this vendor across all agencies
    App.searchData.active = data.filter(d => d['Recipient Name'] === name);
    
    App.updateSearchDashboard();
    App.renderSankey();
  }
},
  clearFilter() { App.drillState.level > 0 ? App.resetDrill() : (App.searchData.filter = null, App.searchData.active = App.searchData.raw, App.activeFeedSource = 'prime', App.updateSearchDashboard(), App.renderSankey()); },

  renderSankey() {
  const container = document.getElementById('chartContainer'); 
  container.innerHTML = '';
  
  const data = App.searchData.active; 
  if(!data || data.length === 0) { 
    container.innerHTML = '<div style="text-align:center; padding:4rem; color:var(--text-subtle)">No data available for this view.</div>'; 
    return; 
  }
  
  container.innerHTML = '<svg id="sankeySvg"></svg>';
  
  // Identify the source level for the left side of the Sankey
  const isLvl0 = App.drillState.level === 0;
  const flowMap = {}; 

  data.forEach(d => { 
    if(d['Award Amount'] > 0) {
      // Fallback logic to prevent "No Description" nodes
      const source = (isLvl0 ? d['Awarding Agency'] : d['Awarding Sub Agency']) || d['Awarding Agency'] || 'Unknown Agency';
      const target = d['Recipient Name'] || 'Unknown Vendor';
      const key = source + "|||" + target;
      
      flowMap[key] = (flowMap[key] || 0) + d['Award Amount']; 
    }
  });

  const allFlows = Object.entries(flowMap).sort((a,b) => b[1] - a[1]); 
  const limit = App.drillState.level > 0 ? 50 : 25;
  const topFlows = allFlows.slice(0, limit); 
  const tailFlows = allFlows.slice(limit);
  
  const nodesSet = new Set(); 
  const links = [];
  
  topFlows.forEach(([k,v]) => { 
    const [s,t] = k.split("|||"); 
    nodesSet.add(s); 
    nodesSet.add(t); 
    links.push({source:s, target:t, value:v}); 
  });

  // Aggregate smaller flows into an "Other" category to keep the chart clean
  if(tailFlows.length > 0) { 
    const aggs = {}; 
    tailFlows.forEach(([k,v]) => { 
      const [s] = k.split("|||"); 
      if(nodesSet.has(s)) aggs[s] = (aggs[s] || 0) + v; 
    }); 
    Object.entries(aggs).forEach(([s,v]) => { 
      const n = `Other (${tailFlows.length} Vendors)`; 
      nodesSet.add(n); 
      links.push({source:s, target:n, value:v}); 
    }); 
  }
  
  const nodes = Array.from(nodesSet).map(n => ({name:n})); 
  const nodeMap = new Map(nodes.map((n,i) => [n.name, i]));
  const d3Links = links.map(l => ({source:nodeMap.get(l.source), target:nodeMap.get(l.target), value:l.value}));
  
  const w = ((container.parentElement ? container.parentElement.offsetWidth : container.offsetWidth) || 800) - 2; 
  const h = Math.max(500, nodes.length * 28);
  const svg = d3.select("#sankeySvg").attr("viewBox",`0 0 ${w} ${h}`).attr("preserveAspectRatio","xMidYMid meet").style("width","100%").style("height","auto").style("display","block");
  const sankey = d3.sankey().nodeId(d => d.index).nodeWidth(20).nodePadding(20).extent([[1,1],[w-1,h-6]]);
  const {nodes:gn, links:gl} = sankey({nodes:nodes.map(d=>Object.assign({},d)), links:d3Links.map(d=>Object.assign({},d))});
  
  // Logic to determine if a node should show the "drill-down" highlight
  const isDrillable = n => {
    if (!n || n.startsWith('Other') || n.includes('Unknown') || n === 'No Description') return false;
    
    // Check if the node is a known Agency, Sub-Agency, or Vendor
    return App.searchData.raw.some(d => 
      d['Awarding Agency'] === n || 
      d['Awarding Sub Agency'] === n || 
      d['Recipient Name'] === n
    );
  };

  // Check if a node is the current drill filter (for drill-out)
  const isActiveDrill = n => {
    if (App.drillState.level === 0) return false;
    const lastStep = App.drillState.path[App.drillState.path.length - 1];
    return lastStep && lastStep.name === n;
  };

  // Reset color assignment for fresh sequential palette
  Utils.getColor.reset();

  // Render Nodes
  svg.append("g").selectAll("rect").data(gn).join("rect")
     .attr("x", d => d.x0).attr("y", d => d.y0).attr("height", d => d.y1 - d.y0).attr("width", d => d.x1 - d.x0)
     .attr("fill", d => Utils.getColor(d.name))
     .attr("opacity", d => isActiveDrill(d.name) ? 1 : 0.8)
     .attr("stroke", d => isActiveDrill(d.name) ? "#F1EEE9" : "none")
     .attr("stroke-width", d => isActiveDrill(d.name) ? 0 : 0)
     .style("cursor", d => isDrillable(d.name) ? "pointer" : "default")
     .on("click", (e, d) => { 
       if (!isDrillable(d.name)) return;
       // Click the active filter → drill OUT
       if (isActiveDrill(d.name)) {
         if (App.drillState.level <= 1) {
           App.resetDrill();
         } else {
           App.drillToLevel(App.drillState.level - 1);
         }
       } else {
         // Drill IN
         App.drillDown(d.name); 
       }
     })
     .on("mouseover", function(e, d) {
       if (!isDrillable(d.name)) return;
       d3.select(this).attr("opacity", 1);
       if (isActiveDrill(d.name)) d3.select(this).attr("stroke", "#F1EEE9").attr("stroke-width", 0);
     })
     .on("mouseout", function(e, d) {
       d3.select(this).attr("opacity", isActiveDrill(d.name) ? 1 : 0.8);
       d3.select(this).attr("stroke", isActiveDrill(d.name) ? "#F1EEE9" : "none")
         .attr("stroke-width", isActiveDrill(d.name) ? 0 : 0);
     })
     .append("title").text(d => {
       if (!isDrillable(d.name)) return `${d.name}\n${Utils.money(d.value)}`;
       const action = isActiveDrill(d.name) ? '← Click to drill out' : 'Click to drill down →';
       return `${d.name}\n${Utils.money(d.value)}\n${action}`;
     });

// Render Gradients for links
const defs = svg.append("defs");

gl.forEach((l, i) => {
  const g = defs.append("linearGradient")
    .attr("id", "g" + i)
    .attr("gradientUnits", "userSpaceOnUse")
    .attr("x1", l.source.x1)
    .attr("x2", l.target.x0);

  g.append("stop")
    .attr("offset", "0%")
    .attr("stop-color", Utils.getColor(l.source.name))
    .attr("stop-opacity", 0.85);

  g.append("stop")
    .attr("offset", "100%")
    .attr("stop-color", Utils.getColor(l.target.name))
    .attr("stop-opacity", 0.85);
});

// Render Links
const linkGroup = svg.append("g").attr("fill", "none");

const linkPaths = linkGroup
  .selectAll("path")
  .data(gl)
  .join("path")
  .attr("d", d3.sankeyLinkHorizontal())
  .attr("stroke", (d, i) => "url(#g" + i + ")")
  .attr("stroke-width", d => Math.max(1, d.width))
  .attr("stroke-opacity", 0.40)
  .attr("stroke-linecap", "butt")
  .attr("stroke-linejoin", "round");

// Optional: subtle hover lift (does not affect layout)
linkPaths
  .on("mouseover", function () {
    d3.select(this).attr("stroke-opacity", 0.40);
  })
  .on("mouseout", function () {
    d3.select(this).attr("stroke-opacity", 0.38);
  });

// Render Labels
svg.append("g")
  .selectAll("text")
  .data(gn)
  .join("text")
  .attr("x", d => (d.x0 < w / 2 ? d.x1 + 6 : d.x0 - 6))
  .attr("y", d => (d.y1 + d.y0) / 2)
  .attr("dy", "0.35em")
  .attr("text-anchor", d => (d.x0 < w / 2 ? "start" : "end"))
  .text(d => Utils.trunc(d.name, 40))
  .style("font-size", "11px")
  .style("fill", "#F1EEE9")
  .style("pointer-events", "none");
},

  renderFeed(showAll) {
    const div = document.getElementById('feedGrid');
    
    // Always render prime awards in the main feed
    const data = App.searchData.active;
    if(data.length === 0) { div.innerHTML = '<div style="text-align:center; padding:2rem; color:var(--text-subtle)">No contracts found.</div>'; return; }
    
    const INITIAL_COUNT = 3;
    const displayData = showAll ? data : data.slice(0, INITIAL_COUNT);
    const hasMore = !showAll && data.length > INITIAL_COUNT;
    
    const cards = displayData.map((c, idx) => {
      const internalId = c['generated_internal_id'];
      let url = '#';
      if (internalId) url = `https://www.usaspending.gov/award/${internalId}`;
      else if (c['Award ID']) url = `https://www.usaspending.gov/search/?hash=&filters=${encodeURIComponent(JSON.stringify({keyword: c['Award ID']}))}`;
      
      let metaTags = '';
      if (c['NAICS Code']) metaTags += `<span class="meta-tag naics" title="${Autocomplete.escapeHtml(c['NAICS Description'] || '')}">NAICS: ${Autocomplete.escapeHtml(c['NAICS Code'])}</span>`;
      if (c['PSC Code']) metaTags += `<span class="meta-tag psc" title="${Autocomplete.escapeHtml(c['PSC Description'] || '')}">PSC: ${Autocomplete.escapeHtml(c['PSC Code'])}</span>`;
      const vehicle = VehicleDetector.detect(c['Award ID']);
      if (vehicle) metaTags += `<span class="meta-tag" style="background:rgba(95,128,85,0.15);border-color:rgba(95,128,85,0.3);color:var(--accent);" title="${vehicle.vehicle}">${vehicle.short}</span>`;
      const setAside = VehicleDetector.getSetAsideLabel(c['Type of Set Aside']);
      if (setAside) metaTags += `<span class="meta-tag" style="background:rgba(229,192,123,0.15);border-color:rgba(229,192,123,0.3);color:var(--accent);" title="Set-Aside: ${setAside}">${setAside}</span>`;
      
      const subAgency = c['Awarding Sub Agency'];
      const agencyDisplay = subAgency && subAgency !== c['Awarding Agency'] 
        ? `${Utils.trunc(c['Awarding Agency'], 20)} → ${Utils.trunc(subAgency, 20)}` 
        : Utils.trunc(c['Awarding Agency'], 35);
      
      const vendorNameRaw = c['Recipient Name'] || 'Unknown Vendor';
      const vendorName = Autocomplete.escapeHtml(vendorNameRaw);
      const desc = Autocomplete.escapeHtml(Utils.trunc(c['Description'], 100));
      const agencyDisplaySafe = Autocomplete.escapeHtml(agencyDisplay);
const linkedInUrl = JobLinks.getLinkedInUrl(vendorNameRaw);
const linkedInPeopleUrl = JobLinks.getLinkedInPeopleUrl(vendorNameRaw);
const linkedInNewsUrl = JobLinks.getLinkedInNewsUrl(vendorNameRaw);
return `<div class="deal-card">
    <div class="deal-header"><span class="deal-agency">${agencyDisplaySafe}</span><span class="deal-amount">${Utils.money(c['Award Amount'])}</span></div>
    <div class="deal-desc">${desc}</div>
    <div class="deal-vendor">${vendorName} <a href="${linkedInPeopleUrl}" target="_blank" class="job-link" style="margin-left:6px;" title="Find contacts at this company"><i class="fab fa-linkedin"></i> People</a> <a href="${linkedInUrl}" target="_blank" class="job-link" title="Search jobs at this company"><i class="fab fa-linkedin"></i> Jobs</a> <a href="${linkedInNewsUrl}" target="_blank" class="job-link" title="LinkedIn posts about this company"><i class="fas fa-newspaper"></i> News</a></div>
    ${metaTags ? `<div class="deal-meta">${metaTags}</div>` : ''}
    <div class="deal-footer"><span class="deal-date">Start: ${Utils.date(c['Start Date'])}${c['End Date'] ? ' → ' + Utils.date(c['End Date']) : ''}</span><div style="display:flex;gap:0.5rem;align-items:center;"><button onclick="Utils.copyDealToClipboard(${idx}, this)" class="action-btn" style="font-size:0.7rem; padding:0.35rem 0.6rem; cursor:pointer; background:transparent;" title="Copy for CRM"><i class="fas fa-copy"></i></button><a href="${url}" target="_blank" class="action-btn">OPEN AWARD <i class="fas fa-external-link-alt"></i></a></div></div>
  </div>`;
}).join('');

    const showMoreBtn = hasMore ? `<button onclick="App.renderFeed(true)" style="width: 100%; padding: 0.875rem; background: var(--bg-card); border: 1px dashed var(--border); border-radius: 4px; color: var(--accent); font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; cursor: pointer; transition: all 0.2s; text-transform: uppercase; letter-spacing: 1px;" onmouseover="this.style.borderColor='var(--accent)';this.style.background='var(--accent-dim)'" onmouseout="this.style.borderColor='var(--border)';this.style.background='var(--bg-card)'"><i class="fas fa-chevron-down" style="margin-right: 0.5rem;"></i>Show All ${data.length} Contracts</button>` : '';

    div.innerHTML = cards + showMoreBtn;
},

  // Render subaward data in the feed
  renderSubawardFeed(targetDiv, showAll) {
    const div = targetDiv || document.getElementById('subFeedGrid');
    const wrapper = document.getElementById('subFeedWrapper');
    if (!div) return;
    
    let subawards = App.forecastData.subawards || [];
    const drill = App.subawardDrillState;
    
    // Apply drill filter if active (path-based)
    if (drill.level > 0 && drill.path && drill.path.length > 0) {
      drill.path.forEach(step => {
        if (step.type === 'agency') subawards = subawards.filter(s => (s['Awarding Agency'] || 'Unknown Agency') === step.name);
        else if (step.type === 'subagency') subawards = subawards.filter(s => (s['Awarding Sub Agency'] || 'Unknown Sub Agency') === step.name);
        else if (step.type === 'prime') subawards = subawards.filter(s => (s['Prime Recipient Name'] || 'Unknown Prime') === step.name);
        else if (step.type === 'sub') subawards = subawards.filter(s => (s['Sub-Awardee Name'] || 'Unknown Sub') === step.name);
      });
    }
    
    if (subawards.length === 0) {
      div.innerHTML = '<div style="text-align:center; padding:2rem; color:var(--text-subtle)">No subcontracts found.</div>';
      if (wrapper) wrapper.style.display = 'none';
      return;
    }
    
    // Show the sub feed wrapper
    if (wrapper) wrapper.style.display = 'block';
    
    // Sort by amount descending
    subawards = [...subawards].sort((a, b) => (parseFloat(b['Sub-Award Amount']) || 0) - (parseFloat(a['Sub-Award Amount']) || 0));
    
    const INITIAL_COUNT = 3;
    const displayData = showAll ? subawards.slice(0, 50) : subawards.slice(0, INITIAL_COUNT);
    const hasMore = !showAll && subawards.length > INITIAL_COUNT;
    
    const cards = displayData.map(s => {
      const prime = s['Prime Recipient Name'] || 'Unknown Prime';
      const sub = s['Sub-Awardee Name'] || 'Unknown Sub';
      const amount = parseFloat(s['Sub-Award Amount']) || 0;
      const date = s['Sub-Award Date'];
      const agency = s['Awarding Agency'] || s['Awarding Sub Agency'] || '';
      const primeAwardInternalId = s['prime_award_generated_internal_id'] || '';
      
      let usaSpendingUrl = '';
      if (primeAwardInternalId) {
        usaSpendingUrl = `https://www.usaspending.gov/award/${primeAwardInternalId}`;
      }
      
      const primeShort = Autocomplete.escapeHtml(Utils.trunc(prime, 25));
      const subShort = Autocomplete.escapeHtml(Utils.trunc(sub, 25));
      const linkedInPrimeUrl = JobLinks.getLinkedInPeopleUrl(prime);
      const linkedInSubUrl = JobLinks.getLinkedInPeopleUrl(sub);
      
      // Encode minimal data for copy button
      const copyData = encodeURIComponent(JSON.stringify({
        'Awarding Agency': agency, 'Prime Recipient Name': prime, 'Sub-Awardee Name': sub,
        'Sub-Award Amount': s['Sub-Award Amount'], 'Sub-Award Date': date,
        'prime_award_generated_internal_id': primeAwardInternalId
      }));
      
      return `<div class="deal-card" style="border-left-color: var(--accent);">
        <div class="deal-header">
          <span class="deal-agency" style="color: var(--accent);">SUBCONTRACT</span>
          <span class="deal-amount">${Utils.money(amount)}</span>
        </div>
        <div class="deal-desc" style="font-size: 0.8rem;">
          <strong>${primeShort}</strong> <i class="fas fa-arrow-right" style="margin: 0 6px; opacity: 0.5;"></i> <strong>${subShort}</strong>
        </div>
        <div class="deal-vendor" style="font-size: 0.75rem; color: var(--text-muted);">
          ${agency ? `Agency: ${Autocomplete.escapeHtml(Utils.trunc(agency, 30))}` : ''}
        </div>
        <div class="deal-footer">
          <span class="deal-date">${date ? Utils.date(date) : 'Date N/A'}</span>
          <div style="display: flex; gap: 0.5rem; align-items: center;">
            <button onclick="Utils.copySubDealToClipboard('${copyData}', this)" class="action-btn" style="font-size:0.65rem; padding:0.25rem 0.5rem; cursor:pointer; background:transparent;" title="Copy for CRM"><i class="fas fa-copy"></i></button>
            <a href="${linkedInPrimeUrl}" target="_blank" class="job-link" title="Find contacts at prime"><i class="fab fa-linkedin"></i> Prime</a>
            <a href="${linkedInSubUrl}" target="_blank" class="job-link" title="Find contacts at sub"><i class="fab fa-linkedin"></i> Sub</a>
            ${usaSpendingUrl ? `<a href="${usaSpendingUrl}" target="_blank" class="action-btn" style="font-size: 0.65rem; padding: 0.25rem 0.5rem;">OPEN AWARD <i class="fas fa-external-link-alt"></i></a>` : ''}
          </div>
        </div>
      </div>`;
    }).join('');

    const showMoreBtn = hasMore ? `<button onclick="App.renderSubawardFeed(null, true)" style="width: 100%; padding: 0.875rem; background: var(--bg-card); border: 1px dashed var(--border); border-radius: 4px; color: var(--accent); font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; cursor: pointer; transition: all 0.2s; text-transform: uppercase; letter-spacing: 1px;" onmouseover="this.style.borderColor='var(--accent)';this.style.background='rgba(229,192,123,0.08)'" onmouseout="this.style.borderColor='var(--border)';this.style.background='var(--bg-card)'"><i class="fas fa-chevron-down" style="margin-right: 0.5rem;"></i>Show All ${Math.min(subawards.length, 50)} Subcontracts</button>` : '';

    div.innerHTML = cards + showMoreBtn;
  },
// --- Search View: Top Buyers with LinkedIn Links ---
renderSearchTopBuyers(data) {
  const body = document.getElementById('searchTopBuyersBody');
  const headerEl = document.querySelector('#searchJobPanel .section-title-group .section-title');
  const subtitleEl = document.querySelector('#searchJobPanel .section-title-group .section-subtitle');
  if (!body) return;
  
  if (!data || data.length === 0) {
    body.innerHTML = `<div class="muted text-xs" style="text-align:center;">No agency data available</div>`;
    return;
  }
  
  const drill = App.drillState || {};
  const isDrilled = drill.level >= 1 && drill.currentAgency;
  
  // Update panel title based on drill state
  if (headerEl) {
    headerEl.textContent = isDrilled ? `${Utils.trunc(drill.currentAgency, 22)} Offices` : 'Top Agency Buyers';
  }
  if (subtitleEl) {
    subtitleEl.textContent = isDrilled ? 'Sub-agencies' : 'Who buys';
  }

  if (isDrilled) {
    // DRILLED: Show sub-agencies within the selected agency
    const subMap = {};
    data.forEach(a => {
      const sub = a['Awarding Sub Agency'] || a['Awarding Agency'] || 'Unknown';
      if (!subMap[sub]) subMap[sub] = { name: sub, spend: 0, count: 0 };
      subMap[sub].spend += parseFloat(a['Award Amount']) || 0;
      subMap[sub].count++;
    });
    
    const sorted = Object.values(subMap).sort((a, b) => b.spend - a.spend);
    const top = sorted.slice(0, 7);
    
    body.innerHTML = `
      <div class="compact-winner-list">
        ${top.map((s, i) => {
          const linkedInUrl = JobLinks.getLinkedInPeopleUrl(s.name);
          const usaJobsUrl = 'https://www.usajobs.gov/Search/Results?k=' + encodeURIComponent(s.name);
          const linkedInNewsUrl = JobLinks.getLinkedInNewsUrl(s.name);
          return `
          <div class="compact-winner-item" style="cursor:pointer;" onclick="App.drillToSubAgency('${s.name.replace(/'/g, "\\'")}')">
            <div class="compact-winner-rank" >${i + 1}</div>
            <div class="compact-winner-info">
              <div class="compact-winner-name">${Utils.trunc(s.name, 28)}</div>
              <div class="compact-winner-count">${s.count} awards</div>
              <div class="job-links" style="margin-top:4px;" onclick="event.stopPropagation();">
                <a href="${linkedInUrl}" target="_blank" class="job-link" title="Find contacts"><i class="fab fa-linkedin"></i> People</a>
                <a href="${usaJobsUrl}" target="_blank" class="job-link" title="Federal jobs"><i class="fas fa-flag-usa"></i> Jobs</a>
                <a href="${linkedInNewsUrl}" target="_blank" class="job-link" title="News"><i class="fas fa-newspaper"></i> News</a>
              </div>
            </div>
            <div class="compact-winner-amount">${Utils.money(s.spend)}</div>
          </div>`;
        }).join('')}
      </div>
      ${sorted.length > 7 ? `<div class="text-xs muted" style="text-align:center; margin-top:0.5rem;">+${sorted.length - 7} more offices</div>` : ''}
    `;
  } else {
    // TOP LEVEL: Show top agencies with external links
    const agencyMap = {};
    data.forEach(a => {
      const agency = a['Awarding Agency'] || 'Unknown';
      if (!agencyMap[agency]) agencyMap[agency] = { name: agency, spend: 0, count: 0 };
      agencyMap[agency].spend += parseFloat(a['Award Amount']) || 0;
      agencyMap[agency].count++;
    });
    
    const sorted = Object.values(agencyMap).sort((a, b) => b.spend - a.spend);
    const topAgencies = sorted.slice(0, 5);
    body.innerHTML = `
      <div class="compact-winner-list">
        ${topAgencies.map((a, i) => {
          const linkedInPeopleUrl = JobLinks.getLinkedInPeopleUrl(a.name);
          const usaJobsUrl = 'https://www.usajobs.gov/Search/Results?k=' + encodeURIComponent(a.name);
          const linkedInNewsUrl = JobLinks.getLinkedInNewsUrl(a.name);
          return `
          <div class="compact-winner-item" style="cursor:pointer;" onclick="App.drillToAgency('${a.name.replace(/'/g, "\\'")}')">
            <div class="compact-winner-rank" >${i + 1}</div>
            <div class="compact-winner-info">
              <div class="compact-winner-name">${Utils.trunc(a.name, 24)}</div>
              <div class="compact-winner-count">${a.count} awards</div>
              <div class="job-links" style="margin-top:4px;" onclick="event.stopPropagation();">
                <a href="${linkedInPeopleUrl}" target="_blank" class="job-link" title="Find contacts at this agency"><i class="fab fa-linkedin"></i> People</a>
                <a href="${usaJobsUrl}" target="_blank" class="job-link" title="Federal jobs at this agency"><i class="fas fa-flag-usa"></i> Jobs</a>
                <a href="${linkedInNewsUrl}" target="_blank" class="job-link" title="LinkedIn posts about this agency"><i class="fas fa-newspaper"></i> News</a>
              </div>
            </div>
            <div class="compact-winner-amount">${Utils.money(a.spend)}</div>
          </div>`;
        }).join('')}
      </div>
      ${sorted.length > 5 ? `<div class="text-xs muted" style="text-align:center; margin-top:0.5rem;">+${sorted.length - 5} more agencies</div>` : ''}
    `;
  }
},

// --- Search View: Top Winners with Job Links ---
renderSearchTopWinners(data) {
  const body = document.getElementById('searchTopWinnersBody');
  if (!body) return;
  
  if (!data || data.length === 0) {
    body.innerHTML = `<div class="muted text-xs" style="text-align:center;">No vendor data available</div>`;
    return;
  }
  
  // Group by vendor
  const vendorMap = {};
  data.forEach(a => {
    const vendor = a['Recipient Name'] || 'Unknown';
    if (!vendorMap[vendor]) {
      vendorMap[vendor] = { name: vendor, spend: 0, count: 0 };
    }
    vendorMap[vendor].spend += parseFloat(a['Award Amount']) || 0;
    vendorMap[vendor].count++;
  });
  
  const sorted = Object.values(vendorMap).sort((a, b) => b.spend - a.spend);
  const topVendors = sorted.slice(0, 5);
  
  body.innerHTML = `
    <div class="compact-winner-list">
      ${topVendors.map((v, i) => {
        const linkedInUrl = JobLinks.getLinkedInUrl(v.name);
        const linkedInPeopleUrl = JobLinks.getLinkedInPeopleUrl(v.name);
        const linkedInNewsUrl = JobLinks.getLinkedInNewsUrl(v.name);
        const rel = VendorRelationships.get(v.name);
        const relIcon = VendorRelationships.getIcon(rel);
        
        return `
        <div class="compact-winner-item">
          <div class="compact-winner-rank">${i + 1}</div>
          <div class="compact-winner-info">
            <div class="compact-winner-name" style="display:flex;align-items:center;gap:6px;">
              ${Utils.trunc(v.name, 28)}
              <button onclick="VendorRelationships.cycle('${v.name.replace(/'/g, "\\'")}'); App.renderSearchTopWinners(App.searchData.active);" 
                style="background:${relIcon.bg};border:1px solid ${rel ? relIcon.color : 'var(--border)'};color:${relIcon.color};width:22px;height:22px;border-radius:4px;display:inline-flex;align-items:center;justify-content:center;cursor:pointer;font-size:0.55rem;flex-shrink:0;transition:all 0.15s;padding:0;" 
                title="${relIcon.label}"><i class="${relIcon.icon}"></i></button>
              ${rel ? `<span style="font-size:0.55rem;color:${relIcon.color};font-family:'JetBrains Mono',monospace;text-transform:uppercase;letter-spacing:0.5px;">${relIcon.label}</span>` : ''}
            </div>
            <div class="compact-winner-count">${v.count} awards</div>
            <div class="job-links" style="margin-top:4px;">
              <a href="${linkedInPeopleUrl}" target="_blank" class="job-link" title="Find contacts at this company"><i class="fab fa-linkedin"></i> People</a>
              <a href="${linkedInUrl}" target="_blank" class="job-link" title="Search jobs on LinkedIn"><i class="fab fa-linkedin"></i> Jobs</a>
              <a href="${linkedInNewsUrl}" target="_blank" class="job-link" title="LinkedIn posts about this company"><i class="fas fa-newspaper"></i> News</a>
            </div>
          </div>
          <div class="compact-winner-amount">${Utils.money(v.spend)}</div>
        </div>`;
      }).join('')}
    </div>
    ${sorted.length > 5 ? `<div class="text-xs muted" style="text-align:center; margin-top:0.5rem;">+${sorted.length - 5} more vendors in results</div>` : ''}
  `;
},

  // --- Search View: Top Primes with LinkedIn Links ---
  renderSearchTopPrimes(subawards) {
    const body = document.getElementById('searchTopPrimesBody');
    if (!body) return;
    
    if (!subawards || subawards.length === 0) {
      body.innerHTML = `<div class="muted text-xs" style="text-align:center;">No subcontract data available</div>`;
      return;
    }
    
    // Apply drill filter if active
    let filteredSubawards = subawards;
    const drill = App.subawardDrillState;
    
    if (drill.level > 0 && drill.path && drill.path.length > 0) {
      drill.path.forEach(step => {
        if (step.type === 'agency') filteredSubawards = filteredSubawards.filter(sub => (sub['Awarding Agency'] || 'Unknown Agency') === step.name);
        else if (step.type === 'subagency') filteredSubawards = filteredSubawards.filter(sub => (sub['Awarding Sub Agency'] || 'Unknown Sub Agency') === step.name);
        else if (step.type === 'prime') filteredSubawards = filteredSubawards.filter(sub => (sub['Prime Recipient Name'] || 'Unknown Prime') === step.name);
        else if (step.type === 'sub') filteredSubawards = filteredSubawards.filter(sub => (sub['Sub-Awardee Name'] || 'Unknown Sub') === step.name);
      });
    }
    
    const primeMap = {};
    filteredSubawards.forEach(sub => {
      const prime = sub['Prime Recipient Name'] || 'Unknown';
      if (!primeMap[prime]) {
        primeMap[prime] = { name: prime, spend: 0, count: 0 };
      }
      primeMap[prime].spend += parseFloat(sub['Sub-Award Amount']) || 0;
      primeMap[prime].count++;
    });
    
    const sorted = Object.values(primeMap).sort((a, b) => b.spend - a.spend);
    const topPrimes = sorted.slice(0, 5);
    
    body.innerHTML = `
      <div class="compact-winner-list">
        ${topPrimes.map((p, i) => {
          const linkedInUrl = JobLinks.getLinkedInUrl(p.name);
          const linkedInPeopleUrl = JobLinks.getLinkedInPeopleUrl(p.name);
          const linkedInNewsUrl = JobLinks.getLinkedInNewsUrl(p.name);
          
          return `
          <div class="compact-winner-item">
            <div class="compact-winner-rank" >${i + 1}</div>
            <div class="compact-winner-info">
              <div class="compact-winner-name">${Utils.trunc(p.name, 28)}</div>
              <div class="compact-winner-count">${p.count} subawards</div>
              <div class="job-links" style="margin-top:4px;">
                <a href="${linkedInPeopleUrl}" target="_blank" class="job-link" title="Find contacts at this company"><i class="fab fa-linkedin"></i> People</a>
                <a href="${linkedInUrl}" target="_blank" class="job-link" title="Search jobs on LinkedIn"><i class="fab fa-linkedin"></i> Jobs</a>
                <a href="${linkedInNewsUrl}" target="_blank" class="job-link" title="LinkedIn posts about this company"><i class="fas fa-newspaper"></i> News</a>
              </div>
            </div>
            <div class="compact-winner-amount">${Utils.money(p.spend)}</div>
          </div>`;
        }).join('')}
      </div>
      ${sorted.length > 5 ? `<div class="text-xs muted" style="text-align:center; margin-top:0.5rem;">+${sorted.length - 5} more primes in results</div>` : ''}
    `;
  },

  // --- Search View: Top Subs with LinkedIn Links ---
  renderSearchTopSubs(subawards) {
    const body = document.getElementById('searchTopSubsBody');
    if (!body) return;
    
    if (!subawards || subawards.length === 0) {
      body.innerHTML = `<div class="muted text-xs" style="text-align:center;">No subcontract data available</div>`;
      return;
    }
    
    // Apply drill filter if active
    let filteredSubawards = subawards;
    const drill = App.subawardDrillState;
    
    if (drill.level > 0 && drill.path && drill.path.length > 0) {
      drill.path.forEach(step => {
        if (step.type === 'agency') filteredSubawards = filteredSubawards.filter(sub => (sub['Awarding Agency'] || 'Unknown Agency') === step.name);
        else if (step.type === 'subagency') filteredSubawards = filteredSubawards.filter(sub => (sub['Awarding Sub Agency'] || 'Unknown Sub Agency') === step.name);
        else if (step.type === 'prime') filteredSubawards = filteredSubawards.filter(sub => (sub['Prime Recipient Name'] || 'Unknown Prime') === step.name);
        else if (step.type === 'sub') filteredSubawards = filteredSubawards.filter(sub => (sub['Sub-Awardee Name'] || 'Unknown Sub') === step.name);
      });
    }
    
    const subMap = {};
    filteredSubawards.forEach(sub => {
      const subName = sub['Sub-Awardee Name'] || 'Unknown';
      if (!subMap[subName]) {
        subMap[subName] = { name: subName, spend: 0, count: 0 };
      }
      subMap[subName].spend += parseFloat(sub['Sub-Award Amount']) || 0;
      subMap[subName].count++;
    });
    
    const sorted = Object.values(subMap).sort((a, b) => b.spend - a.spend);
    const topSubs = sorted.slice(0, 5);
    
    body.innerHTML = `
      <div class="compact-winner-list">
        ${topSubs.map((s, i) => {
          const linkedInUrl = JobLinks.getLinkedInUrl(s.name);
          const linkedInPeopleUrl = JobLinks.getLinkedInPeopleUrl(s.name);
          const linkedInNewsUrl = JobLinks.getLinkedInNewsUrl(s.name);
          
          return `
          <div class="compact-winner-item">
            <div class="compact-winner-rank">${i + 1}</div>
            <div class="compact-winner-info">
              <div class="compact-winner-name">${Utils.trunc(s.name, 28)}</div>
              <div class="compact-winner-count">${s.count} subawards</div>
              <div class="job-links" style="margin-top:4px;">
                <a href="${linkedInPeopleUrl}" target="_blank" class="job-link" title="Find contacts at this company"><i class="fab fa-linkedin"></i> People</a>
                <a href="${linkedInUrl}" target="_blank" class="job-link" title="Search jobs on LinkedIn"><i class="fab fa-linkedin"></i> Jobs</a>
                <a href="${linkedInNewsUrl}" target="_blank" class="job-link" title="LinkedIn posts about this company"><i class="fas fa-newspaper"></i> News</a>
              </div>
            </div>
            <div class="compact-winner-amount">${Utils.money(s.spend)}</div>
          </div>`;
        }).join('')}
      </div>
      ${sorted.length > 5 ? `<div class="text-xs muted" style="text-align:center; margin-top:0.5rem;">+${sorted.length - 5} more subcontractors in results</div>` : ''}
    `;
  },

  // --- Search View: Skills in Demand ---
  renderSearchSkills(data) {
    const body = document.getElementById('searchSkillsBody');
    if (!body) return;
    
    if (!data || data.length === 0) {
      body.innerHTML = `<div class="muted text-xs" style="text-align:center;">No description data available</div>`;
      return;
    }
    
    const skills = SkillsExtractor.extract(data);
    
    if (skills.length === 0) {
      body.innerHTML = `<div class="muted text-xs" style="text-align:center;">No recurring terms detected in award descriptions</div>`;
      return;
    }
    
    const maxPct = skills[0]?.percentage || 100;
    
    body.innerHTML = `
      ${skills.slice(0, 5).map(s => `
        <div class="skill-bar-container">
          <div class="skill-bar-label">
            <span class="skill-bar-name">${s.skill}</span>
            <span class="skill-bar-pct">${s.percentage}%</span>
          </div>
          <div class="skill-bar">
            <div class="skill-bar-fill" style="width: ${(s.percentage / maxPct) * 100}%"></div>
          </div>
        </div>
      `).join('')}
      <div class="text-xs" style="margin-top: 0.75rem; color: var(--text-muted); font-style: italic;">
        <i class="fas fa-lightbulb" style="color: var(--accent);"></i> 
        Top terms extracted from Award Descriptions
      </div>
    `;
  },

  // --- Search View: Job Locations ---
  renderSearchLocations() {
    const body = document.getElementById('searchLocationsBody');
    if (!body) return;
    
    // Use cached geo data if available
    const geoData = App.searchGeoData;
    
    if (!geoData || geoData.length === 0) {
      body.innerHTML = `<div class="muted text-xs" style="text-align:center;">Loading location data...</div>`;
      return;
    }
    
    const sorted = geoData.sort((a, b) => b.aggregated_amount - a.aggregated_amount).slice(0, 5);
    const total = geoData.reduce((s, d) => s + d.aggregated_amount, 0);
    
    body.innerHTML = `
      <div class="compact-location-list">
        ${sorted.map((d, i) => {
          const stateCode = d.state_code || d.shape_code || 'XX';
          const stateName = US_STATES[stateCode] || stateCode;
          const pct = total > 0 ? Math.round((d.aggregated_amount / total) * 100) : 0;
          
          return `
          <div class="compact-location-item">
            <div class="compact-location-rank">${i + 1}</div>
            <div class="compact-location-info">
              <div class="compact-location-name">${stateName}</div>
              <div class="compact-location-count">${pct}%</div>
            </div>
            <div class="compact-location-amount">${Utils.money(d.aggregated_amount)}</div>
          </div>`;
        }).join('')}
      </div>
      ${geoData.length > 5 ? `<div class="text-xs muted" style="text-align:center; margin-top:0.5rem;">+${geoData.length - 5} more states</div>` : ''}
    `;
  },

// --- Forecast Mode ---
  async runForecast(val) {
    // Forecast tab removed — redirect to search which loads forecast data in background
    return App.runSearch(val);
  },

renderForecastDashboard() {
    // Legacy — now handled by renderStrategyTools in the unified search view
    if (App.forecastData && App.forecastData.loaded) {
      App.renderStrategyTools();
    }
  },

  async loadSubcontractingData(query) {
    const body = document.getElementById('subcontractingBody');
    const statsEl = document.getElementById('subcontractingStats');
    if (!body) return;
    
    body.innerHTML = `<div style="text-align:center; padding:2rem; color:var(--text-muted);"><i class="fas fa-spinner fa-spin"></i> Loading subaward flow...</div>`;
    
    // Timeout wrapper — show fallback if API takes longer than 15 seconds
    const timeout = setTimeout(() => {
      if (body.querySelector('.fa-spinner')) {
        body.innerHTML = `<div style="text-align:center; padding:1rem; color:var(--text-muted); font-size:0.85rem;">
          <i class="fas fa-exclamation-circle" style="color:var(--danger);"></i> Subaward data is taking too long to load.
          <br><a href="#" onclick="App.loadSubcontractingData('${query.replace(/'/g, "\\'")}'); return false;" style="color:var(--accent); text-decoration:underline; font-size:0.8rem;">Retry</a>
        </div>`;
      }
    }, 15000);
    
    try {
      const subawards = await API.getSubawards(query);
      clearTimeout(timeout);
      App.forecastData.subawards = subawards; // Store for later use
      this.renderSubawardSankey(subawards);
      
      // Render Top Primes and Subs cards
      this.renderSearchTopPrimes(subawards);
      this.renderSearchTopSubs(subawards);
      
      // Render the separate subaward feed
      this.renderSubawardFeed();
    } catch (e) {
      clearTimeout(timeout);
      console.error(e);
      body.innerHTML = `<div style="text-align:center; padding:1rem; color:var(--text-muted); font-size:0.85rem;">
        <i class="fas fa-exclamation-circle" style="color:var(--danger);"></i> Unable to load subaward data.
        <br><a href="#" onclick="App.loadSubcontractingData('${query.replace(/'/g, "\\'")}'); return false;" style="color:var(--accent); text-decoration:underline; font-size:0.8rem;">Retry</a>
      </div>`;
    }
  },

  renderSubawardSankey(subawards) {
    const wrapper = document.getElementById('subawardWrapper');
    const body = document.getElementById('subcontractingBody');
    const statsEl = document.getElementById('subcontractingStats');
    const legendEl = document.getElementById('subcontractingLegend');
    const subConvoPanel = document.getElementById('subConvoStartersPanel');
    
    if (!wrapper || !body) return;
    
    // 1. Hide the old legend (we use dynamic vintage colors now)
    if (legendEl) legendEl.style.display = 'none';

    // 2. CHECK DATA EXISTENCE
    if (!subawards || subawards.length === 0) {
      wrapper.style.display = 'none';
      if (subConvoPanel) subConvoPanel.style.display = 'none';
      if (statsEl) {
        const volEl = document.getElementById('sub-stat-vol');
        if (volEl) volEl.innerText = '-';
      }
      return;
    }

    // Data exists: Reveal the wrapper and sub convo panel
    wrapper.style.display = 'block';
    if (subConvoPanel) subConvoPanel.style.display = 'flex';
    
    // --- Apply Drill Filter ---
    let filteredSubawards = subawards;
    const drill = App.subawardDrillState;
    
    if (drill.level > 0 && drill.path.length > 0) {
      drill.path.forEach(step => {
        if (step.type === 'agency') {
          filteredSubawards = filteredSubawards.filter(sub => 
            (sub['Awarding Agency'] || 'Unknown Agency') === step.name
          );
        } else if (step.type === 'subagency') {
          filteredSubawards = filteredSubawards.filter(sub => 
            (sub['Awarding Sub Agency'] || 'Unknown Sub Agency') === step.name
          );
        } else if (step.type === 'prime') {
          filteredSubawards = filteredSubawards.filter(sub => 
            (sub['Prime Recipient Name'] || 'Unknown Prime') === step.name
          );
        } else if (step.type === 'sub') {
          filteredSubawards = filteredSubawards.filter(sub => 
            (sub['Sub-Awardee Name'] || 'Unknown Sub') === step.name
          );
        }
      });
      // Keep filter/filterType for backward compat with feed/topPrimes/topSubs
      drill.filter = drill.path[drill.path.length - 1].name;
      drill.filterType = drill.path[drill.path.length - 1].type;
    }
    
    // --- Data Processing ---
    // Determine the left-side source based on drill level
    const flowMap = {};
    let totalValue = 0;
    
    // Determine what the 3 columns should be based on drill depth
    const drillHasAgency = drill.path.some(p => p.type === 'agency');
    const drillHasSubAgency = drill.path.some(p => p.type === 'subagency');
    
    filteredSubawards.forEach(sub => {
      const agency = sub['Awarding Agency'] || 'Unknown Agency';
      const subAgency = sub['Awarding Sub Agency'] || agency;
      const prime = sub['Prime Recipient Name'] || 'Unknown Prime';
      const subName = sub['Sub-Awardee Name'] || 'Unknown Sub';
      const amount = parseFloat(sub['Sub-Award Amount']) || 0;
      
      if (amount > 0) {
        // Determine left column based on drill state
        let leftCol;
        if (!drillHasAgency) {
          // Level 0: Agency → Prime → Sub
          leftCol = agency;
        } else if (!drillHasSubAgency) {
          // Level 1 (agency drilled): SubAgency → Prime → Sub
          leftCol = subAgency;
        } else {
          // Level 2+ (subagency drilled): Prime → Sub (2-column)
          leftCol = prime;
        }
        
        if (drillHasAgency && !drillHasSubAgency) {
          // SubAgency → Prime → Sub (3-column)
          const key1 = `${leftCol}|||${prime}`;
          flowMap[key1] = (flowMap[key1] || 0) + amount;
          const key2 = `${prime}|||${subName}`;
          flowMap[key2] = (flowMap[key2] || 0) + amount;
        } else if (drillHasSubAgency) {
          // Prime → Sub (2-column, subagency already filtered)
          const key = `${prime}|||${subName}`;
          flowMap[key] = (flowMap[key] || 0) + amount;
        } else {
          // Agency → Prime → Sub (default 3-column)
          const key1 = `${agency}|||${prime}`;
          flowMap[key1] = (flowMap[key1] || 0) + amount;
          const key2 = `${prime}|||${subName}`;
          flowMap[key2] = (flowMap[key2] || 0) + amount;
        }
        
        totalValue += amount;
      }
    });
    
    // Update hero stats
    if (statsEl) {
      const volEl = document.getElementById('sub-stat-vol');
      const primesEl = document.getElementById('sub-stat-primes');
      const subsEl = document.getElementById('sub-stat-subs');
      const countEl = document.getElementById('sub-stat-count');
      const uniquePrimes = new Set(filteredSubawards.map(s => s['Prime Recipient Name'] || 'Unknown')).size;
      const uniqueSubs = new Set(filteredSubawards.map(s => s['Sub-Awardee Name'] || 'Unknown')).size;
      if (volEl) volEl.innerText = Utils.money(totalValue);
      if (primesEl) primesEl.innerText = uniquePrimes;
      if (subsEl) subsEl.innerText = uniqueSubs;
      if (countEl) countEl.innerText = filteredSubawards.length;
    }
    
    const allFlows = Object.entries(flowMap).sort((a, b) => b[1] - a[1]);
    const topFlows = allFlows.slice(0, 40);
    
    const nodesSet = new Set();
    const links = [];
    
    topFlows.forEach(([key, value]) => {
      const [source, target] = key.split('|||');
      nodesSet.add(source);
      nodesSet.add(target);
      links.push({ source, target, value });
    });
    
    if (links.length === 0) {
      wrapper.style.display = 'none';
      return;
    }

    const nodes = Array.from(nodesSet).map(name => ({ name }));
    const nodeMap = new Map(nodes.map((n, i) => [n.name, i]));
    const d3Links = links.map(l => ({
      source: nodeMap.get(l.source),
      target: nodeMap.get(l.target),
      value: l.value
    }));
    
    // --- Rendering ---
    // Build breadcrumb HTML for multi-level drill state
    let breadcrumbHtml = '';
    if (drill.level > 0 && drill.path.length > 0) {
      const typeIcons = { agency: 'fa-landmark', subagency: 'fa-sitemap', prime: 'fa-building', sub: 'fa-handshake' };
      const typeLabels = { agency: 'Agency', subagency: 'Sub-Agency', prime: 'Prime', sub: 'Sub' };
      
      let crumbs = `<div class="breadcrumb-item" onclick="App.resetSubawardDrill()" style="cursor:pointer;">
        <i class="fas fa-stream breadcrumb-icon"></i>
        <span>All Subawards</span>
      </div>`;
      
      drill.path.forEach((step, idx) => {
        const isLast = idx === drill.path.length - 1;
        const icon = typeIcons[step.type] || 'fa-circle';
        crumbs += `<span class="breadcrumb-separator"><i class="fas fa-chevron-right"></i></span>`;
        if (isLast) {
          crumbs += `<div class="breadcrumb-item active">
            <i class="fas ${icon} breadcrumb-icon"></i>
            <span>${Utils.trunc(step.name, 30)}</span>
            <span style="font-size:0.65rem; color:var(--text-muted); margin-left:6px;">(${typeLabels[step.type] || step.type})</span>
          </div>`;
        } else {
          crumbs += `<div class="breadcrumb-item" onclick="App.drillSubawardToLevel(${idx})" style="cursor:pointer;">
            <i class="fas ${icon} breadcrumb-icon"></i>
            <span>${Utils.trunc(step.name, 25)}</span>
          </div>`;
        }
      });
      
      breadcrumbHtml = `<div class="drill-breadcrumb" style="display: flex; margin-bottom: 0.75rem;">${crumbs}</div>`;
    }
    
    body.innerHTML = `
      ${breadcrumbHtml}
      <div id="subawardDrillHint" class="drill-hint" style="margin-bottom: 0.5rem; ${drill.level > 0 ? 'display:none;' : ''}">
        <i class="fas fa-mouse-pointer"></i>
        <span>Click any bar to drill down · click the active bar to drill back up</span>
      </div>
      <svg id="subawardSankeySvg"></svg>
    `;
    
    // Match prime Sankey exactly: measure from parent (chart-wrapper) 
    const w = ((body.parentElement ? body.parentElement.offsetWidth : body.offsetWidth) || 800) - 2;
    const h = Math.max(350, nodes.length * 20);
    
    const svg = d3.select('#subawardSankeySvg')
      .attr('viewBox', `0 0 ${w} ${h}`)
      .attr('preserveAspectRatio', 'xMidYMid meet')
      .style('width', '100%')
      .style('height', 'auto')
      .style('display', 'block');
    
    const sankey = d3.sankey()
      .nodeId(d => d.index)
      .nodeWidth(20)
      .nodePadding(20)
      .extent([[1, 1], [w - 1, h - 6]]);
    
    const { nodes: sankeyNodes, links: sankeyLinks } = sankey({
      nodes: nodes.map(d => Object.assign({}, d)),
      links: d3Links.map(d => Object.assign({}, d))
    });
    
    // Determine node types for drill behavior
    const primeNames = new Set(filteredSubawards.map(s => s['Prime Recipient Name'] || 'Unknown Prime'));
    const subNames = new Set(filteredSubawards.map(s => s['Sub-Awardee Name'] || 'Unknown Sub'));
    const agencyNames = new Set(filteredSubawards.map(s => s['Awarding Agency'] || 'Unknown Agency'));
    const subAgencyNames = new Set(filteredSubawards.map(s => s['Awarding Sub Agency'] || s['Awarding Agency'] || 'Unknown Agency'));
    
    sankeyNodes.forEach(node => {
      // Determine type based on what column the node appears in within the current view
      if (drillHasAgency && !drillHasSubAgency && subAgencyNames.has(node.name) && !primeNames.has(node.name)) {
        node.nodeType = 'subagency';
      } else if (!drillHasAgency && agencyNames.has(node.name) && !primeNames.has(node.name)) {
        node.nodeType = 'agency';
      } else if (primeNames.has(node.name) && !subNames.has(node.name)) {
        node.nodeType = 'prime';
      } else if (subNames.has(node.name)) {
        node.nodeType = 'sub';
      } else if (primeNames.has(node.name)) {
        node.nodeType = 'prime';
      } else {
        node.nodeType = 'sub';
      }
    });
    
    // 3. GRADIENTS
    Utils.getColor.reset();
    const defs = svg.append('defs');
    sankeyLinks.forEach((l, i) => {
      const colorSource = Utils.getColor(l.source.name);
      const colorTarget = Utils.getColor(l.target.name);
      
      const gradient = defs.append('linearGradient')
        .attr('id', `sub-gradient-${i}`)
        .attr('gradientUnits', 'userSpaceOnUse')
        .attr('x1', l.source.x1)
        .attr('x2', l.target.x0);
      
      gradient.append('stop').attr('offset', '0%').attr('stop-color', colorSource);
      gradient.append('stop').attr('offset', '100%').attr('stop-color', colorTarget);
    });
    
    // 4. LINKS
    svg.append('g')
      .attr('fill', 'none')
      .selectAll('path')
      .data(sankeyLinks)
      .join('path')
      .attr('d', d3.sankeyLinkHorizontal())
      .attr('stroke', (d, i) => `url(#sub-gradient-${i})`)
      .attr('stroke-width', d => Math.max(1, d.width))
      .attr('stroke-opacity', 0.4)
      .on('mouseover', function() { d3.select(this).attr('stroke-opacity', 0.8); })
      .on('mouseout', function() { d3.select(this).attr('stroke-opacity', 0.4); })
      .append('title')
      .text(d => `${d.source.name} → ${d.target.name}\n${Utils.money(d.value)}`);
    
    // 5. NODES (with click handler for drill-down / drill-out)
    const isCurrentFilter = (name) => {
      return drill.path.length > 0 && drill.path[drill.path.length - 1].name === name;
    };
    
    svg.append('g')
      .selectAll('rect')
      .data(sankeyNodes)
      .join('rect')
      .attr('x', d => d.x0)
      .attr('y', d => d.y0)
      .attr('height', d => Math.max(1, d.y1 - d.y0))
      .attr('width', d => d.x1 - d.x0)
      .attr('fill', d => Utils.getColor(d.name))
      .attr('opacity', d => isCurrentFilter(d.name) ? 1 : 0.8)
      .attr('stroke', d => isCurrentFilter(d.name) ? '#F1EEE9' : 'none')
      .attr('stroke-width', d => isCurrentFilter(d.name) ? 0 : 0)
      .style('cursor', d => d.name.startsWith('Other') ? 'default' : 'pointer')
      .on('click', function(event, d) {
        if (d.name.startsWith('Other') || d.name.includes('Unknown')) return;
        
        // If clicking the current active filter → drill OUT (go up one level)
        if (isCurrentFilter(d.name)) {
          if (drill.path.length <= 1) {
            App.resetSubawardDrill();
          } else {
            App.drillSubawardToLevel(drill.path.length - 2);
          }
        } else {
          // Drill IN
          App.drillSubaward(d.name, d.nodeType);
        }
      })
      .on('mouseover', function(event, d) { 
        d3.select(this).attr('opacity', 1);
        if (isCurrentFilter(d.name)) {
          d3.select(this).attr('stroke', 'var(--danger)').attr('stroke-width', 0);
        }
      })
      .on('mouseout', function(event, d) { 
        d3.select(this).attr('opacity', isCurrentFilter(d.name) ? 1 : 0.8);
        d3.select(this).attr('stroke', isCurrentFilter(d.name) ? '#F1EEE9' : 'none')
          .attr('stroke-width', isCurrentFilter(d.name) ? 0 : 0);
      })
      .append('title')
      .text(d => {
        const action = isCurrentFilter(d.name) ? '← Click to drill out' : 'Click to drill down →';
        return `${d.name}\n${Utils.money(d.value)}\n${d.name.startsWith('Other') ? '' : action}`;
      });
    
    // 6. LABELS - match prime Sankey
    svg.append('g')
      .selectAll('text')
      .data(sankeyNodes)
      .join('text')
      .attr('x', d => d.x0 < w / 2 ? d.x1 + 6 : d.x0 - 6)
      .attr('y', d => (d.y1 + d.y0) / 2)
      .attr('dy', '0.35em')
      .attr('text-anchor', d => d.x0 < w / 2 ? 'start' : 'end')
      .text(d => Utils.trunc(d.name, 40))
      .style('font-size', '11px') 
      .style('fill', '#F1EEE9')
      .style('pointer-events', 'none');
  },

  // Subaward drill-down handler - multi-level path support
  drillSubaward(name, nodeType) {
    const drill = App.subawardDrillState;
    
    // Push onto path
    drill.path.push({ type: nodeType, name: name });
    drill.level = drill.path.length;
    drill.filter = name;
    drill.filterType = nodeType;
    
    App.activeFeedSource = 'sub';
    
    // Re-render with filter applied — preserve scroll position to avoid jarring jump
    if (App.forecastData.subawards) {
      const scrollY = window.scrollY;
      App.renderSubawardSankey(App.forecastData.subawards);
      App.renderSearchTopPrimes(App.forecastData.subawards);
      App.renderSearchTopSubs(App.forecastData.subawards);
      App.renderSubawardFeed();
      requestAnimationFrame(() => window.scrollTo(0, scrollY));
    }
  },
  
  // Navigate to a specific level in subaward drill path
  drillSubawardToLevel(idx) {
    const drill = App.subawardDrillState;
    if (idx < 0) {
      App.resetSubawardDrill();
      return;
    }
    drill.path = drill.path.slice(0, idx + 1);
    drill.level = drill.path.length;
    if (drill.path.length > 0) {
      drill.filter = drill.path[drill.path.length - 1].name;
      drill.filterType = drill.path[drill.path.length - 1].type;
    } else {
      drill.filter = null;
      drill.filterType = null;
    }
    
    App.activeFeedSource = 'sub';
    
    if (App.forecastData.subawards) {
      const scrollY = window.scrollY;
      App.renderSubawardSankey(App.forecastData.subawards);
      App.renderSearchTopPrimes(App.forecastData.subawards);
      App.renderSearchTopSubs(App.forecastData.subawards);
      App.renderSubawardFeed();
      requestAnimationFrame(() => window.scrollTo(0, scrollY));
    }
  },

  // Reset subaward drill
  resetSubawardDrill() {
    App.subawardDrillState = { level: 0, path: [], filter: null, filterType: null };
    App.activeFeedSource = 'sub'; // Stay on subaward view but unfiltered
    
    if (App.forecastData.subawards) {
      const scrollY = window.scrollY;
      App.renderSubawardSankey(App.forecastData.subawards);
      App.renderSearchTopPrimes(App.forecastData.subawards);
      App.renderSearchTopSubs(App.forecastData.subawards);
      App.renderSubawardFeed();
      requestAnimationFrame(() => window.scrollTo(0, scrollY));
    }
  },

  renderTopBuyers(awards) {
    const body = document.getElementById('topBuyersBody');
    if (!body) return;
    
    // Group by agency
    const agencyMap = {};
    awards.forEach(a => {
      const agency = a['Awarding Agency'] || 'Unknown';
      if (!agencyMap[agency]) {
        agencyMap[agency] = { name: agency, spend: 0, count: 0 };
      }
      agencyMap[agency].spend += parseFloat(a['Award Amount']) || 0;
      agencyMap[agency].count++;
    });
    
    const sorted = Object.values(agencyMap).sort((a, b) => b.spend - a.spend);
    const total = sorted.reduce((s, a) => s + a.spend, 0);
    
    if (sorted.length === 0) {
      body.innerHTML = `<div style="text-align:center; color:var(--text-muted); padding:1rem;">No agency data available</div>`;
      return;
    }
    
    const topAgencies = sorted.slice(0, 8);
    
    body.innerHTML = `
      <div class="buyer-list">
        ${topAgencies.map((a, i) => {
          const share = total > 0 ? (a.spend / total * 100) : 0;
          return `
          <div class="buyer-item">
            <div class="buyer-rank">${i + 1}</div>
            <div class="buyer-info">
              <div class="buyer-name">${Utils.trunc(a.name, 30)}</div>
              <div class="buyer-stats">${a.count} awards · ${share.toFixed(0)}%</div>
            </div>
            <div class="buyer-amount">
              <div class="buyer-spend">${Utils.money(a.spend)}</div>
            </div>
          </div>`;
        }).join('')}
      </div>
      ${sorted.length > 8 ? `<div style="text-align:center; color:var(--text-muted); font-size:0.75rem; margin-top:0.75rem;">+${sorted.length - 8} more agencies</div>` : ''}
    `;
  },

  renderTopWinners(awards) {
    const body = document.getElementById('topWinnersBody');
    if (!body) return;
    
    // Group by vendor
    const vendorMap = {};
    awards.forEach(a => {
      const vendor = a['Recipient Name'] || 'Unknown';
      if (!vendorMap[vendor]) {
        vendorMap[vendor] = { name: vendor, spend: 0, count: 0, agencies: new Set() };
      }
      vendorMap[vendor].spend += parseFloat(a['Award Amount']) || 0;
      vendorMap[vendor].count++;
      vendorMap[vendor].agencies.add(a['Awarding Agency'] || 'Unknown');
    });
    
    const sorted = Object.values(vendorMap)
      .map(v => ({ ...v, agencies: v.agencies.size }))
      .sort((a, b) => b.spend - a.spend);
    const total = sorted.reduce((s, v) => s + v.spend, 0);
    
    if (sorted.length === 0) {
      body.innerHTML = `<div style="text-align:center; color:var(--text-muted); padding:1rem;">No vendor data available</div>`;
      return;
    }
    
    const topVendors = sorted.slice(0, 8);
    
    body.innerHTML = `
      <div class="buyer-list">
        ${topVendors.map((v, i) => {
          const share = total > 0 ? (v.spend / total * 100) : 0;
          
          return `
          <div class="buyer-item">
            <div class="buyer-rank">${i + 1}</div>
            <div class="buyer-info">
              <div class="buyer-name">${Utils.trunc(v.name, 26)}</div>
              <div class="buyer-stats">${v.count} awards · ${v.agencies} ${v.agencies === 1 ? 'agency' : 'agencies'}</div>
            </div>
            <div class="buyer-amount">
              <div class="buyer-spend">${Utils.money(v.spend)}</div>
            </div>
          </div>`;
        }).join('')}
      </div>
      ${sorted.length > 8 ? `<div style="text-align:center; color:var(--text-muted); font-size:0.75rem; margin-top:0.75rem;">+${sorted.length - 8} more vendors</div>` : ''}
    `;
  },

renderRecompetes(recompetes, showAll = false) {
  const container = document.getElementById('recompetesList');
  if (!container) return;
  
  if (!recompetes || recompetes.length === 0) {
    container.innerHTML = '';
    return;
  }
  
  // 1. Mission Gap Risk Calculation
  const withRisk = recompetes.map(r => ({
    ...r,
    risk: Utils.missionGapRisk(r)
  }));
  
  // 2. Metrics Calculation
  const totalRecompeteValue = withRisk.reduce((sum, r) => sum + (parseFloat(r['Award Amount']) || 0), 0);
  const highRiskContracts = withRisk.filter(r => r.risk.level === 'high');
  const highRiskValue = highRiskContracts.reduce((sum, r) => sum + (parseFloat(r['Award Amount']) || 0), 0);
  
  // 3. User-Defined Filtering
  const filtered = App.onlyHighMissionGap 
    ? withRisk.filter(r => r.risk.level === 'high')
    : withRisk;

  // 4. LOAD MORE LOGIC: Limit to 5 unless 'showAll' is true
  const INITIAL_COUNT = 3;
  const displayData = showAll ? filtered : filtered.slice(0, INITIAL_COUNT);
  const hasMore = !showAll && filtered.length > INITIAL_COUNT;
  
  // 5. Subtitle Logic
  let subtitleText = `${Utils.money(totalRecompeteValue)} in ${recompetes.length} contracts expiring within 24 months`;
  if (highRiskContracts.length > 0) {
    subtitleText += ` · <span style="color:var(--danger); font-weight:600;">${highRiskContracts.length} high-risk (${Utils.money(highRiskValue)})</span>`;
  }
  
  // 6. Header
  let html = `
    <div class="section-header">
      <div class="section-title-group">
        <span class="section-title">Expiring Contracts</span>
      </div>
      <div class="mission-gap-filter">
        <span class="section-subtitle">${subtitleText}</span>
        ${highRiskContracts.length > 0 ? `
          <button class="mission-gap-toggle ${App.onlyHighMissionGap ? 'active' : ''}"
        onclick="App.toggleMissionGapFilter()"
        title="Show only contracts with high mission continuity risk">
  <i class="fa-solid fa-sort"></i>
</button>
        ` : ''}
      </div>
    </div>`;
    
  if (filtered.length === 0) {
    html += `<div style="text-align:center; padding:2rem; color:var(--text-muted);">No contracts match the current filter. <a href="#" onclick="App.toggleMissionGapFilter(); return false;" style="color:var(--accent); margin-left:0.5rem;">Show all</a></div>`;
  } else {
    // 7. Map only the displayData (the limited set)
    html += displayData.map(r => {
      if (!r['End Date']) return '';
      
      const internalId = r['generated_internal_id'];
      const awardUrl = internalId 
        ? `https://www.usaspending.gov/award/${internalId}`
        : (r['Award ID'] ? `https://www.usaspending.gov/search/?hash=&filters=${encodeURIComponent(JSON.stringify({keyword: r['Award ID']}))}` : null);
      
      const endDate = new Date(r['End Date']);
      const m = endDate.getMonth();
      const y = endDate.getFullYear();
      const fy = m >= 9 ? y + 1 : y;
      let q = 1;
      if (m >= 0 && m <= 2) q = 2;
      else if (m >= 3 && m <= 5) q = 3;
      else if (m >= 6 && m <= 8) q = 4;
      const fiscalPeriod = `FY${String(fy).slice(-2)} Q${q}`;

      const today = new Date();
      const daysUntil = Math.ceil((endDate - today) / (1000 * 60 * 60 * 24));
      const urgency = daysUntil < 180 ? 'urgent' : daysUntil < 365 ? 'soon' : 'later';
      
      const risk = r.risk;
      const riskLabel = risk.level === 'high' ? 'Mission Gap: High' : risk.level === 'medium' ? 'Mission Gap: Medium' : 'Mission Gap: Low';
      const esc = str => Autocomplete.escapeHtml(str);
      
      return `
      <div class="deal-card" style="margin-bottom:1rem; ${risk.level === 'high' ? 'border-left: 3px solid var(--danger);' : risk.level === 'medium' ? 'border-left: 3px solid #FDD835;' : ''}">
        <div class="deal-header">
          <span class="deal-agency">${esc(Utils.trunc(r['Awarding Agency'], 40))}</span>
          <span class="deal-amount">${Utils.money(r['Award Amount'])}</span>
        </div>
        <div class="deal-desc">${esc(Utils.trunc(r['Description'], 100))}</div>
        <div class="deal-meta">
          <span class="meta-tag" style="color:var(--accent); border-color:var(--accent);">${fiscalPeriod}</span>
          <span class="meta-tag mission-gap ${risk.level}">${riskLabel}</span>
          ${r['PSC Code'] ? `<span class="meta-tag psc">PSC: ${esc(r['PSC Code'])}</span>` : ''}
        </div>
        ${risk.reasons.length > 0 && risk.level !== 'low' ? `<div class="mission-gap-signals">Signals: ${esc(risk.reasons.join(', '))}</div>` : ''}
        <div class="deal-footer">
          <div>
            <div style="font-size:0.8rem; color:${urgency === 'urgent' ? 'var(--danger)' : urgency === 'soon' ? '#FDD835' : 'var(--text-muted)'}">
              Expires: ${Utils.date(r['End Date'])} (${daysUntil} days)
            </div>
            <div style="font-size:0.75rem; color:var(--text-subtle)">Incumbent: ${esc(Utils.trunc(r['Recipient Name'], 35))}</div>
          </div>
          <div style="display:flex;gap:0.5rem;align-items:center;">
            <button onclick="Utils.copyRecompeteToClipboard(this, '${esc(r['Awarding Agency'] || '')}', '${esc(r['Awarding Sub Agency'] || '')}', '${esc(r['Recipient Name'] || '')}', '${Utils.money(r['Award Amount'])}', '${esc(Utils.trunc(r['Description'] || '', 200))}', '${r['Start Date'] || ''}', '${r['End Date'] || ''}', '${esc(r['Award ID'] || '')}', '${esc(r['PSC Code'] || '')}', '${esc(r['PSC Description'] || '')}', '${esc(r['NAICS Code'] || '')}', '${esc(r['NAICS Description'] || '')}', '${r['Type of Set Aside'] || ''}', '${awardUrl || ''}')" class="action-btn"><i class="fas fa-copy"></i></button>
            ${awardUrl ? `<a href="${awardUrl}" target="_blank" class="action-btn">OPEN AWARD</a>` : ''}
          </div>
        </div>
      </div>`;
    }).join('');
    
    // 8. Add the "Show All" button if there are more items
    if (hasMore) {
      html += `
        <button onclick="App.renderRecompetes(App.forecastData.analysis.recompetes, true)" style="width: 100%; padding: 0.875rem; background: var(--bg-card); border: 1px dashed var(--border); border-radius: 4px; color: var(--accent); font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; cursor: pointer; transition: all 0.2s; text-transform: uppercase; letter-spacing: 1px;" onmouseover="this.style.borderColor='var(--accent)';this.style.background='var(--accent-dim)'" onmouseout="this.style.borderColor='var(--border)';this.style.background='var(--bg-card)'">
          <i class="fas fa-chevron-down" style="margin-right: 0.5rem;"></i>Show All ${filtered.length} Expiring Contracts
        </button>`;
    }
  }
  
  container.innerHTML = html;
},
  toggleMissionGapFilter() {
    App.onlyHighMissionGap = !App.onlyHighMissionGap;
    // Re-render with current recompetes data
    if (App.forecastData.analysis && App.forecastData.analysis.recompetes) {
      this.renderRecompetes(App.forecastData.analysis.recompetes);
    }
  },

calculateRollingForecast(byFY, curFY, curQ, overallYoyTrend) {
    const forecasts = [];
    let fy = curFY;
    let q = curQ;
    
    for (let i = 0; i < 4; i++) {
      const historicalValues = [];
      const years = Object.keys(byFY).map(Number).sort().reverse(); 
      
      years.forEach(year => {
        if (year < curFY && byFY[year] && byFY[year][q] > 0 && historicalValues.length < 3) {
          historicalValues.push({ fy: year, amount: byFY[year][q] });
        }
      });
      
      let weightedAvg = 0;
      if (historicalValues.length > 0) {
        const weights = [0.5, 0.3, 0.2];
        let totalWeight = 0;
        historicalValues.forEach((h, idx) => {
          const w = weights[idx] || 0.1;
          weightedAvg += h.amount * w;
          totalWeight += w;
        });
        weightedAvg = weightedAvg / totalWeight;
      }
      
      const lastYearVal = byFY[curFY - 1] && byFY[curFY - 1][q] ? byFY[curFY - 1][q] : 0;
      const priorYearVal = byFY[curFY - 2] && byFY[curFY - 2][q] ? byFY[curFY - 2][q] : 0;
      
      let quarterGrowthRate = 0;
      if (priorYearVal > 0 && lastYearVal > 0) {
        quarterGrowthRate = (lastYearVal - priorYearVal) / priorYearVal;
      } else if (overallYoyTrend) {
        quarterGrowthRate = overallYoyTrend / 100;
      }
      
      quarterGrowthRate = Math.max(-0.5, Math.min(0.5, quarterGrowthRate));
      const trendMultiplier = 1 + quarterGrowthRate;
      
      let projection = 0;
      if (lastYearVal > 0) projection = lastYearVal * trendMultiplier;
      else if (weightedAvg > 0) projection = weightedAvg * trendMultiplier;
      
      forecasts.push({
        // Updated to Standard Format: FY26 Q1
        period: `FY${String(fy).slice(-2)} Q${q}`,
        quarter: q,
        fiscalYear: fy,
        historicalAvg: weightedAvg,
        lastYear: lastYearVal,
        priorYear: priorYearVal,
        quarterGrowth: quarterGrowthRate * 100,
        projection: projection,
        dataPoints: historicalValues.length
      });
      
      q++;
      if (q > 4) { q = 1; fy++; }
    }
    return forecasts;
  },
  
  renderForecastTable(forecasts, lastFYTotal, yoyChange, projectionTotal, analysis, awards) {
  const tbody = document.getElementById('forecastTableBody');
  if (!tbody) return;

  const curFY = Utils.getCurrentFY();
  const curQ = Utils.getCurrentQuarter();
  
  // 1. Get Actual Data for Current FY
  const historicalData = (analysis.byFY && analysis.byFY[curFY]) ? analysis.byFY[curFY] : {};
  const ytdActuals = Object.values(historicalData).reduce((sum, val) => sum + (val || 0), 0);

  // 2. Calculate True FY Projection (Blended Actuals + Forecast)
  let trueFYProjection = 0;
  
  // Loop through all 4 quarters to build the landing number
  for (let q = 1; q <= 4; q++) {
    const actual = historicalData[q] || 0;
    
    // Find the model's projection for this quarter
    const match = forecasts.find(f => f.fiscalYear === curFY && f.quarter === q);
    const projected = match ? match.projection : 0;

    if (q < curQ) {
      // PAST: Use Actuals Only (Banked)
      trueFYProjection += actual;
    } else if (q === curQ) {
      // CURRENT: Use the higher of Actuals or Projection
      // This prevents the forecast from dipping below what we've already booked
      trueFYProjection += Math.max(actual, projected);
    } else {
      // FUTURE: Use Projection Only
      trueFYProjection += projected;
    }
  }

  // 3. Render the Table
  tbody.innerHTML = forecasts.map(f => {
    const hasData = f.dataPoints > 0;
    const qGrowth = f.quarterGrowth || 0;
    const trendClass = qGrowth >= 0 ? 'trend-up' : 'trend-down';
    const trendIcon = qGrowth >= 0 ? '▲' : '▼';
    
    // Check if this row is a past or current quarter with actual data
    const actualAmount = historicalData[f.quarter] || 0;
    const isPast = f.fiscalYear === curFY && f.quarter < curQ;
    const isCurrent = f.fiscalYear === curFY && f.quarter === curQ;
    
    let amountDisplay = '';
    
    if (isPast) {
      // Past: Show Actual (Locked)
      amountDisplay = `<span style="color:var(--text-primary); font-weight:700; border-bottom:1px dotted var(--text-muted); cursor:help;" title="Actual Obligation (Final)">${Utils.money(actualAmount)}</span>`;
    } else if (isCurrent) {
      // Current: Show Projection but indicate Actuals progress
      amountDisplay = `<span style="color:var(--accent); font-weight:600;" title="Proj: ${Utils.money(f.projection)} / Actual: ${Utils.money(actualAmount)}">${Utils.money(Math.max(actualAmount, f.projection))}</span>`;
    } else {
      // Future: Show Projection
      amountDisplay = `<span style="color:var(--accent); font-weight:600;">${f.projection > 0 ? Utils.money(f.projection) : '-'}</span>`;
    }

    return `
      <tr>
        <td>
          <strong>${f.period}</strong> 
          ${isPast ? '<i class="fas fa-lock" style="font-size:0.6rem; color:var(--text-muted); margin-left:4px;" title="Closed Quarter"></i>' : ''}
          ${isCurrent ? '<i class="fas fa-clock" style="font-size:0.6rem; color:var(--accent); margin-left:4px;" title="Active Quarter"></i>' : ''}
        </td>
        <td style="color:var(--text-muted);">
          ${hasData ? Utils.money(f.historicalAvg) : '<span style="opacity:0.5">No data</span>'}
        </td>
        <td style="color:var(--text-muted);">${f.lastYear > 0 ? Utils.money(f.lastYear) : '-'}</td>
        <td style="white-space: nowrap;">
          <div style="display: inline-flex; align-items: center; gap: 0.5rem;">
            ${amountDisplay}
            ${!isPast && f.lastYear > 0 ? 
              `<span class="trend-pill ${trendClass}" style="font-size:0.65rem;">${trendIcon} ${Math.abs(qGrowth).toFixed(0)}%</span>` 
              : ''}
          </div>
        </td>
      </tr>
    `;
  }).join('');
  
  const summaryEl = document.getElementById('projectionSummary');
  if (summaryEl && trueFYProjection > 0) {
    const projectedGrowth = lastFYTotal > 0 ? ((trueFYProjection - lastFYTotal) / lastFYTotal) * 100 : 0;
    const growthColor = projectedGrowth >= 0 ? 'var(--success)' : 'var(--danger)';
    const fyShorthand = `FY${String(curFY).slice(-2)}`;
    
    // Calculate Percent Complete (YTD / Projected Landing)
    const percentComplete = trueFYProjection > 0 ? (ytdActuals / trueFYProjection) * 100 : 0;
    const toGoAmount = Math.max(0, trueFYProjection - ytdActuals);

    // Tactical Advice Logic
    const topAgency = (awards && awards[0] && awards[0]['Awarding Agency']) ? awards[0]['Awarding Agency'] : 'the primary agency';
    let tacticalAdvice = '';
    if (analysis.hhi > 2500) {
        tacticalAdvice = `teaming with established primes to bypass high barriers to entry.`;
    } else if (analysis.hhi > 1500) {
        tacticalAdvice = `a targeted account-entry strategy focusing on under-served sub-agencies.`;
    } else {
        tacticalAdvice = `an aggressive displacement strategy targeting the ${topAgency} incumbent base.`;
    }
    const recompeteValue = analysis.recompetes.reduce((s, r) => s + (parseFloat(r['Award Amount']) || 0), 0);
    const avgDataPoints = forecasts.length > 0 
      ? Number(forecasts.reduce((sum, f) => sum + (f.dataPoints || 0), 0) / forecasts.length) || 0 
      : 0;
    const volatilityScore = Number(analysis.volatility?.score) || 0.5;
    let confidenceScore = ((avgDataPoints / 3) * 70) + ((1 - volatilityScore) * 30);
    confidenceScore = Math.max(0, Math.min(100, Number(confidenceScore) || 0));
    let confidenceLevel = confidenceScore >= 75 ? 'HIGH' : (confidenceScore >= 45 ? 'MEDIUM' : 'LOW');
    let confidenceClass = confidenceLevel.toLowerCase();

    // 4. Update Summary HTML with YTD Logic
    summaryEl.innerHTML = `
      <div class="hero-growth-label">Projected ${fyShorthand} Forecast</div>
      <div style="display: flex; align-items: baseline; gap: 1.5rem; flex-wrap: wrap; margin-bottom: 0.5rem;">
        <div class="hero-growth-value">${Utils.money(trueFYProjection)}</div>
        <div style="color:${growthColor}; font-size: 1.5rem; font-weight: 700; font-family: 'JetBrains Mono';">
          ${projectedGrowth >= 0 ? '▲' : '▼'} ${Math.abs(projectedGrowth).toFixed(0)}% <span style="font-size:0.8rem; opacity:0.7">YoY Growth</span>
        </div>
      </div>
      
      <div style="margin-bottom: 1.5rem; font-size: 0.7rem; color: var(--text-muted);">
        <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
          <span>Obligations YTD: <strong style="color:var(--text-primary)">${Utils.money(ytdActuals)}</strong></span>
          <span>Forecast (To-Go): ${Utils.money(toGoAmount)}</span>
        </div>
        <div style="height:6px; width:100%; background:rgba(255,255,255,0.1); border-radius:3px; overflow:hidden;">
          <div style="height:100%; width:${percentComplete}%; background:var(--text-primary); opacity:0.8;"></div>
        </div>
      </div>
      
      <div class="strategic-narrative-card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
          <div style="color:var(--accent); font-weight:700; font-size:0.7rem; text-transform:uppercase; letter-spacing:1px;">
            <i class="fas fa-robot"></i> Data Insights
          </div>
          <div style="font-size:0.6rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px;">
            Model Confidence: <span class="analysis-panel-badge ${confidenceClass}">${confidenceLevel} (${confidenceScore.toFixed(0)}%)</span>
          </div>
        </div>

        <strong>Market Dynamics:</strong> This is a <strong>${analysis.marketStatus}</strong> market (HHI: ${analysis.hhi}). 
        With a ${projectedGrowth >= 0 ? 'bullish' : 'softening'} <strong>${projectedGrowth.toFixed(0)}% ${fyShorthand} growth forecast</strong>, 
        the model recommends ${tacticalAdvice}
        ${analysis.recompetes.length > 5 ? ` High recompete volume (${Utils.money(recompeteValue)}) in the next 24 months signals a prime capture window.` : ''}
        
        <div style="margin-top: 15px; padding: 10px; background: rgba(0,0,0,0.2); border: 1px solid var(--border); border-radius: 4px;">
          <div style="font-size: 0.6rem; color: var(--accent); text-transform: uppercase; margin-bottom: 5px; font-weight: 700;">Confidence Logic</div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.65rem; color: var(--text-muted);">
            <div>
              <strong>Density:</strong> ${avgDataPoints.toFixed(1)}/3.0 Years 
              <div style="height:3px; width:100%; background:#333; margin-top:3px;">
                <div style="height:100%; width:${(avgDataPoints/3)*100}%; background:var(--accent);"></div>
              </div>
            </div>
            <div>
              <strong>Stability:</strong> ${(100 - (volatilityScore * 100)).toFixed(0)}% Stable
              <div style="height:3px; width:100%; background:#333; margin-top:3px;">
                <div style="height:100%; width:${(1-volatilityScore)*100}%; background:var(--accent);"></div>
              </div>
            </div>
          </div>
          <div style="font-size: 0.6rem; margin-top: 8px; font-style: italic; opacity: 0.8;">
            Note: High volatility or <1 year of data reduces projection reliability.
          </div>
        </div>
      </div>
      
      <div class="disclaimer-text" style="margin-top: 1.5rem; padding: 1rem; border-top: 1px solid var(--border); font-size: 0.7rem; color: var(--text-muted); line-height: 1.5;">
  
  <strong style="color: var(--accent); text-transform: uppercase; letter-spacing: 0.5px; display: block; margin-bottom: 0.5rem;">
    <i class="fas fa-info-circle"></i> Notes
  </strong>

  <ul style="padding-left: 1rem; margin-bottom: 1rem; list-style-type: disc;">
    <li style="margin-bottom: 0.25rem;">
      <strong>Obligations vs. Ceiling:</strong> We track <em>Obligated Funds</em> (cash spent), not Ceiling (potential value). This ensures you chase actual funded opportunities, not empty contract vehicles.
    </li>
    <li style="margin-bottom: 0.25rem;">
      <strong>Seasonality Model:</strong> Our forecasts account for the "Q4 Spending Spree" (July-Sept). If the "To-Go" number looks high, it's because the agency historically dumps budget at year-end.
    </li>
    <li style="margin-bottom: 0.25rem;">
      <strong>Market Lock (HHI):</strong> We calculate incumbency strength. <span style="color:#ddd;">Low scores (&lt;1,500)</span> mean the door is open; <span style="color:#ddd;">High scores (&gt;2,500)</span> mean you should look to partner.
    </li>
    <li style="margin-bottom: 0.25rem;">
      <strong>Reporting Lag:</strong> Defense agencies (DoD) often delay reporting by 90 days for security. Recent awards may not appear immediately.
    </li>
  </ul>

  <div style="font-style: italic; opacity: 0.8; border-top: 1px dashed var(--border); padding-top: 0.5rem;">
    <strong>Disclaimer:</strong> Govhoo is a free intelligence tool built to help you plan. Projections are estimates based solely on USASpending.gov data. Always verify specific opportunities on SAM.gov.
  </div>

</div>
    `;
  } else if (summaryEl) {
    summaryEl.innerHTML = '';
  }
},
// --- Helpers ---
  exportCSV(btn) {
    const data = App.mode === 'search' ? App.searchData.active : (App.forecastData.awards || []);
    
    // IF NO DATA: Flash Red (Error)
    if (!data.length) {
      if (btn) {
        const originalHtml = btn.innerHTML;
        btn.style.color = 'var(--danger)';
        btn.style.borderColor = 'var(--danger)';
        btn.innerHTML = '<i class="fas fa-times"></i>'; 
        setTimeout(() => {
          btn.style.color = '';
          btn.style.borderColor = '';
          btn.innerHTML = originalHtml;
        }, 2000);
      }
      return;
    }
    
    // Updated Headers with Fiscal Period
    const headers = ['Fiscal Period', 'Recipient', 'Agency', 'Sub-Agency', 'Amount', 'Description', 'Start Date', 'End Date', 'Award ID', 'Award Link'];
    
    const rows = data.map(c => {
      // Logic for FY26 Q1 shorthand
      let fiscalPeriod = 'N/A';
      if (c['Start Date']) {
        const d = new Date(c['Start Date']);
        const m = d.getMonth(); 
        const y = d.getFullYear();
        const fy = m >= 9 ? y + 1 : y;
        let q;
        if (m >= 9) q = 1;        // Oct-Nov-Dec = Q1
        else if (m <= 2) q = 2;   // Jan-Feb-Mar = Q2
        else if (m <= 5) q = 3;   // Apr-May-Jun = Q3
        else q = 4;               // Jul-Aug-Sep = Q4
        fiscalPeriod = `FY${String(fy).slice(-2)} Q${q}`;
      }

      const internalId = c['generated_internal_id']; 
      let awardUrl = '';
      if (internalId) awardUrl = `https://www.usaspending.gov/award/${internalId}`;
      else if (c['Award ID']) awardUrl = `https://www.usaspending.gov/search/?hash=&filters=${encodeURIComponent(JSON.stringify({keyword: c['Award ID']}))}`;
      
      return [
        `"${fiscalPeriod}"`,
        `"${(c['Recipient Name'] || '').replace(/"/g, '""')}"`, 
        `"${(c['Awarding Agency'] || '').replace(/"/g, '""')}"`, 
        `"${(c['Awarding Sub Agency'] || '').replace(/"/g, '""')}"`, 
        c['Award Amount'] || 0, 
        `"${(c['Description'] || '').replace(/"/g, '""')}"`, 
        c['Start Date'] || '', 
        c['End Date'] || '', 
        c['Award ID'] || '', 
        awardUrl
      ];
    });
    
    const csvContent = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a"); 
    link.setAttribute("href", url); 
    link.setAttribute("download", `govhoo_${App.mode}_${App.currentQuery}.csv`);
    document.body.appendChild(link); link.click(); document.body.removeChild(link);

    // SUCCESS: Flash Green
    if (btn) {
      const originalHtml = btn.innerHTML;
      btn.style.color = 'var(--success)';
      btn.style.borderColor = 'var(--success)';
      btn.innerHTML = '<i class="fas fa-check"></i>'; 
      setTimeout(() => {
        btn.style.color = '';
        btn.style.borderColor = '';
        btn.innerHTML = originalHtml;
      }, 2000);
    }
  },
  
  showLoader(text, subtext) { document.getElementById('loaderText').innerText = text; document.getElementById('loaderSubtext').innerText = subtext || ''; document.getElementById('loader').style.display = 'flex'; },
  hideLoader() { document.getElementById('loader').style.display = 'none'; },
  transitionToApp() {
    const hero = document.getElementById('heroView'); 
    hero.classList.add('slide-up');
    document.getElementById('appView').style.display = 'block'; 
    document.getElementById('miniSearch').value = App.currentQuery;
    document.getElementById('dashboardContainer').classList.add('active'); 
    const dashContainer = document.getElementById('dashboardContainer');
    if (!dashContainer.querySelector('.hero-footer')) {
      const heroFooter = hero.querySelector('.hero-footer');
      if (heroFooter) {
        const footerClone = heroFooter.cloneNode(true);
        // Remove the ID to prevent duplicates (if you add IDs later)
        footerClone.removeAttribute('id'); 
        dashContainer.appendChild(footerClone);
      }
    }

    setTimeout(() => { 
      hero.style.display = 'none'; 
      hero.classList.add('hidden'); 
    }, 500);
  },
  
  shareLink(btn) {
    const url = new URL(window.location); url.searchParams.set('q', App.currentQuery); url.searchParams.set('mode', App.mode);
    navigator.clipboard.writeText(url.toString()).then(() => {
      if (btn) {
        const originalHtml = btn.innerHTML;
        btn.style.color = 'var(--success)';
        btn.style.borderColor = 'var(--success)';
        btn.innerHTML = '<i class="fas fa-check"></i>';
        setTimeout(() => {
          btn.style.color = '';
          btn.style.borderColor = '';
          btn.innerHTML = originalHtml;
        }, 2000);
      }
    });
  },

  shareBrief(btn) {
    const data = App.searchData.active;
    const query = App.currentQuery || 'Unknown';
    const totalValue = data.reduce((sum, c) => sum + (parseFloat(c['Award Amount']) || 0), 0);
    const agencies = new Set(data.map(c => c['Awarding Agency']).filter(Boolean));
    const vendors = new Set(data.map(c => c['Recipient Name']).filter(Boolean));
    
    // Count expiring contracts (within 90 days)
    const now = new Date();
    const d90 = new Date(now.getTime() + 90 * 24 * 60 * 60 * 1000);
    let expiringCount = 0, expiringValue = 0;
    data.forEach(c => {
      if (c['End Date']) {
        const end = new Date(c['End Date']);
        if (end >= now && end <= d90) { expiringCount++; expiringValue += parseFloat(c['Award Amount']) || 0; }
      }
    });
    
    // Count set-asides
    const setAsides = data.filter(c => c['Type of Set Aside']).length;
    
    // Build the brief
    const url = new URL(window.location);
    url.searchParams.set('q', query);
    url.searchParams.set('mode', App.mode);
    
    let brief = `🔍️ Govhoo Search: "${query}"\n`;
    brief += `💰 ${Utils.money(totalValue)} across ${agencies.size} agencies, ${vendors.size} vendors\n`;
    if (expiringCount > 0) brief += `🔥 ${expiringCount} contracts expiring in 90 days (${Utils.money(expiringValue)})\n`;
    if (setAsides > 0) brief += `🏷️ ${setAsides} set-aside awards in results\n`;
    
    // Subaward intel if available
    if (App.forecastData?.subawards?.length) {
      const subTotal = App.forecastData.subawards.reduce((s, r) => s + (parseFloat(r['Sub-Award Amount']) || 0), 0);
      brief += `💸 ${App.forecastData.subawards.length} subcontracts tracked (${Utils.money(subTotal)})\n`;
    }
    
    brief += `👉 ${url.toString()}`;
    
    navigator.clipboard.writeText(brief).then(() => {
      if (btn) {
        const originalHtml = btn.innerHTML;
        btn.style.color = 'var(--success)';
        btn.style.borderColor = 'var(--success)';
        btn.innerHTML = '<i class="fas fa-check"></i>';
        setTimeout(() => {
          btn.style.color = '';
          btn.style.borderColor = '';
          btn.innerHTML = originalHtml;
        }, 2000);
      }
    });
  }
};

const PromptPackageGenerator = {
  calculateMetrics(data, analysis) {
    const totalValue = data.reduce((sum, r) => sum + (parseFloat(r['Award Amount']) || 0), 0);
    const contractCount = data.length;
    const avgDealSize = contractCount > 0 ? totalValue / contractCount : 0;
    const amounts = data.map(r => parseFloat(r['Award Amount']) || 0).filter(a => a > 0).sort((a, b) => a - b);
    // Proper median calculation: average middle two values for even-length arrays
    let medianDealSize = 0;
    if (amounts.length > 0) {
      const mid = Math.floor(amounts.length / 2);
      medianDealSize = amounts.length % 2 !== 0 
        ? amounts[mid] 
        : (amounts[mid - 1] + amounts[mid]) / 2;
    }
    const largeDeals = amounts.filter(a => a >= 1000000).length;
    const midDeals = amounts.filter(a => a >= 100000 && a < 1000000).length;
    const smallDeals = amounts.filter(a => a < 100000).length;
    
    const now = new Date();
    const expiringContracts = data.filter(c => {
      const endDate = new Date(c['End Date']);
      const monthsOut = (endDate - now) / (1000 * 60 * 60 * 24 * 30);
      return monthsOut > 0 && monthsOut <= 18;
    });
    const expiringValue = expiringContracts.reduce((s, c) => s + (parseFloat(c['Award Amount']) || 0), 0);
    
    return {
      totalValue, contractCount, avgDealSize, medianDealSize,
      largeDeals, midDeals, smallDeals,
      expiringValue, expiringCount: expiringContracts.length
    };
  },

  buildVendorIntel(data) {
    const vendorMap = {};
    const now = new Date();
    
    data.forEach(r => {
      const v = r['Recipient Name'] || 'Unknown';
      if (!vendorMap[v]) vendorMap[v] = { 
        spend: 0, count: 0, agencies: new Set(), contracts: [], expiring: 0
      };
      const amt = parseFloat(r['Award Amount']) || 0;
      vendorMap[v].spend += amt;
      vendorMap[v].count++;
      vendorMap[v].agencies.add(r['Awarding Agency']);
      vendorMap[v].contracts.push(r);
      
      const endDate = new Date(r['End Date']);
      const monthsOut = (endDate - now) / (1000 * 60 * 60 * 24 * 30);
      if (monthsOut > 0 && monthsOut <= 18) {
        vendorMap[v].expiring += amt;
      }
    });
    
    const totalSpend = Object.values(vendorMap).reduce((s, v) => s + v.spend, 0);
    
    return Object.entries(vendorMap)
      .map(([name, d]) => ({
        name, spend: d.spend,
        share: totalSpend > 0 ? ((d.spend / totalSpend) * 100) : 0,
        contracts: d.count, agencies: d.agencies.size,
        expiring: d.expiring, avgDeal: d.count > 0 ? d.spend / d.count : 0,
        isChannel: SalesPlanManager.isChannel(name)
      }))
      .sort((a, b) => b.spend - a.spend);
  },

  buildAgencyIntel(data) {
    const agencyMap = {};
    const now = new Date();
    data.forEach(r => {
      const ag = r['Awarding Agency'] || 'Unknown';
      const sub = r['Awarding Sub Agency'] || 'Unknown';
      if (!agencyMap[ag]) agencyMap[ag] = { spend: 0, count: 0, subs: {}, vendors: {}, vehicles: new Set(), setAsides: new Set(), expiring: 0, expiringCount: 0 };
      
      const amt = parseFloat(r['Award Amount']) || 0;
      agencyMap[ag].spend += amt;
      agencyMap[ag].count++;
      
      if (!agencyMap[ag].subs[sub]) agencyMap[ag].subs[sub] = { spend: 0, count: 0, vendors: {} };
      agencyMap[ag].subs[sub].spend += amt;
      agencyMap[ag].subs[sub].count++;
      
      const v = r['Recipient Name'] || 'Unknown';
      if (!agencyMap[ag].vendors[v]) agencyMap[ag].vendors[v] = 0;
      agencyMap[ag].vendors[v] += amt;
      if (!agencyMap[ag].subs[sub].vendors[v]) agencyMap[ag].subs[sub].vendors[v] = 0;
      agencyMap[ag].subs[sub].vendors[v] += amt;
      
      // Vehicle & set-aside tracking
      const vehicle = VehicleDetector.detect(r['Award ID']);
      if (vehicle) agencyMap[ag].vehicles.add(vehicle.short);
      const sa = VehicleDetector.getSetAsideLabel(r['Type of Set Aside']);
      if (sa) agencyMap[ag].setAsides.add(sa);
      
      // Expiring
      const endDate = new Date(r['End Date']);
      const monthsOut = (endDate - now) / (1000 * 60 * 60 * 24 * 30);
      if (monthsOut > 0 && monthsOut <= 18) {
        agencyMap[ag].expiring += amt;
        agencyMap[ag].expiringCount++;
      }
    });
    
    const totalSpend = Object.values(agencyMap).reduce((s, a) => s + a.spend, 0);
    
    return Object.entries(agencyMap)
      .map(([name, d]) => {
        const topVendors = Object.entries(d.vendors).sort((a, b) => b[1] - a[1]).slice(0, 5).map(([v, s]) => ({ name: v, spend: s, share: d.spend > 0 ? ((s / d.spend) * 100) : 0 }));
        const topSubs = Object.entries(d.subs).sort((a, b) => b[1].spend - a[1].spend).slice(0, 5).map(([s, info]) => {
          const subTopVendor = Object.entries(info.vendors).sort((a, b) => b[1] - a[1])[0];
          return { name: s, spend: info.spend, count: info.count, topVendor: subTopVendor ? subTopVendor[0] : 'Unknown' };
        });
          
        return {
          name, spend: d.spend,
          share: totalSpend > 0 ? ((d.spend / totalSpend) * 100) : 0,
          contracts: d.count, topVendors, topSubs,
          incumbent: topVendors[0]?.name || 'Unknown',
          vehicles: [...d.vehicles],
          setAsides: [...d.setAsides],
          expiring: d.expiring,
          expiringCount: d.expiringCount
        };
      })
      .sort((a, b) => b.spend - a.spend);
  },

  generatePrompt(extracted, config) {
    const mf = v => Utils.money(v);
    const pct = v => (v && !isNaN(v)) ? v.toFixed(1) + '%' : '0.0%';
    const query = extracted.query.toUpperCase();
    const fyShorthand = `FY${String(Utils.getCurrentFY()).slice(-2)}`;
    const fyFull = Utils.getCurrentFY();

    const competitors = extracted.vendors.filter(v => !v.isChannel);
    const channels = extracted.vendors.filter(v => v.isChannel);
    const agencies = extracted.agencies.slice(0, 6);
    const metrics = extracted.metrics;
    
    // Vendor relationship tags from user
    const tagged = VendorRelationships.getTagged();
    const hasRelTags = tagged.mine.length || tagged.partner.length || tagged.competitor.length;
    
    const analysis = extracted.analysis || {};
    const recompeteVal = metrics.expiringValue;
    
    // Collect all vehicles and set-asides across agencies
    const allVehicles = [...new Set(agencies.flatMap(a => a.vehicles || []))];
    const allSetAsides = [...new Set(agencies.flatMap(a => a.setAsides || []))];
    
    // Build sub-agency detail table
    const subAgencyRows = agencies.flatMap(a => 
      (a.topSubs || []).map(s => `| ${a.name} | ${s.name} | ${mf(s.spend)} | ${s.count} | ${s.topVendor} |`)
    ).slice(0, 15);
    
    // Build expiring contract summary from recompetes if available
    const recompetes = analysis.recompetes || [];
    const recompeteRows = recompetes.slice(0, 10).map(r => {
      const endDate = r['End Date'] ? new Date(r['End Date']) : null;
      const daysOut = endDate ? Math.ceil((endDate - new Date()) / (1000*60*60*24)) : 0;
      const risk = Utils.missionGapRisk ? Utils.missionGapRisk(r) : { level: 'unknown' };
      return `| ${(r['Awarding Sub Agency'] || r['Awarding Agency'] || 'Unknown').substring(0, 30)} | ${(r['Recipient Name'] || 'Unknown').substring(0, 25)} | ${mf(r['Award Amount'])} | ${Utils.date(r['End Date'])} | ${daysOut}d | ${risk.level || '—'} |`;
    });

    return `
<SYSTEM_INSTRUCTIONS_INTERNAL>
- ROLE: Senior Federal Sales Director at a Tier-1 CSP/Defense Prime.
- DATA INTEGRITY: Use ONLY the provided data below. Every table, vendor, and dollar figure comes from live USASpending.gov awards.
- CLOSED UNIVERSE: Do not hallucinate outside companies, placeholder vendors, or market stats.
- ACTIONABILITY: Every recommendation must tie to a specific agency, vendor, vehicle, or contract from the data.
- START RESPONSE IMMEDIATELY with the # Title. Do not include meta-commentary.
</SYSTEM_INSTRUCTIONS_INTERNAL>

# Federal Go-To-Market Plan: ${query}

**Scope**: Fiscal Year ${fyFull} (${fyShorthand}). Total addressable: ${mf(metrics.totalValue)} across ${metrics.contractCount} contracts.
**Median Deal**: ${mf(metrics.medianDealSize)} · **Recompete Signal**: ${mf(recompeteVal)} across ${metrics.expiringCount} expiring contracts.
${allVehicles.length > 0 ? `**Active Vehicles**: ${allVehicles.join(', ')}` : ''}
${allSetAsides.length > 0 ? `**Set-Aside Types**: ${allSetAsides.join(', ')}` : ''}
${hasRelTags ? `
**User's Vendor Relationships** (use these to personalize ALL recommendations):
${tagged.mine.length ? `- MY COMPANY: ${tagged.mine.join(', ')}` : ''}
${tagged.partner.length ? `- PARTNERS: ${tagged.partner.join(', ')}` : ''}
${tagged.competitor.length ? `- COMPETITORS: ${tagged.competitor.join(', ')}` : ''}
` : ''}

---

## EXECUTIVE SUMMARY
One high-density paragraph stating the ${fyShorthand} target revenue range (calculated as a percentage of the ${mf(recompeteVal)} recompete signal), primary competitive risk, top 3 accounts by priority, and the recommended go-to-market motion (direct, partner-led, or hybrid). ${hasRelTags ? 'Frame the summary around displacing COMPETITORS and leveraging PARTNERS.' : ''}

## MARKET DYNAMICS
Four sentences explaining how revenue flows in the ${query} market. Specifically address: incumbency lock-in, contract vehicle gatekeeping, and the role of set-aside requirements (${allSetAsides.length > 0 ? allSetAsides.join(', ') : 'none identified'}) in shaping capture strategy.

## SUB-AGENCY ACCOUNT MAP
This is the granular view. These are the buying offices — the people your users met at conferences like AFCEA West.

| Parent Agency | Sub-Agency / Command | Spend | Contracts | Top Incumbent |
|---|---|---:|---:|---|
${subAgencyRows.length > 0 ? subAgencyRows.join('\n') : '> No sub-agency data available.'}

For each sub-agency above:
- Identify the specific incumbent vulnerability (single-vendor dependency, expiring contracts, set-aside mismatch)
- Recommend whether to pursue direct or through a partner, and name the specific partner from the data
- Assign priority (Tier 1 = pursue now, Tier 2 = develop, Tier 3 = monitor)

## COMPETITIVE LANDSCAPE
| Vendor | Spend | Market Share | Contracts | Agencies | Expiring | Dominance Risk |
|---|---:|---:|---:|---:|---:|---|
${competitors.slice(0,8).map(c => {
  const dominance = c.share > 40 ? 'HIGH — single-vendor lock' : c.share > 20 ? 'MEDIUM — strong position' : 'LOW — fragmented';
  const rel = VendorRelationships.get(c.name);
  const tag = rel === 'mine' ? ' MY CO' : rel === 'partner' ? ' PARTNER' : rel === 'competitor' ? ' TARGET' : '';
  return `| ${c.name}${tag} | ${mf(c.spend)} | ${pct(c.share)} | ${c.contracts} | ${c.agencies} | ${mf(c.expiring)} | ${dominance} |`;
}).join('\n')}

Analysis requirements:
* For each vendor with >20% share: identify their specific lock-in mechanism and the conditions under which they can be displaced
* For vendors with high expiring values: these are the immediate pipeline opportunities — recommend specific displacement actions
* ${hasRelTags && tagged.competitor.length ? `Specifically detail how to displace ${tagged.competitor.join(' and ')} using data above` : 'Identify the top 2 displacement targets'}

## CHANNEL & PARTNER LANDSCAPE
${channels.length === 0 ? '> No channel partners identified. Mark resellers in the Sales Plan modal to populate this section.' : `
| Partner | Spend | Share | Contracts | Agencies | Expiring |
|---|---:|---:|---:|---:|---:|
${channels.slice(0,6).map(c =>
`| ${c.name} | ${mf(c.spend)} | ${pct(c.share)} | ${c.contracts} | ${c.agencies} | ${mf(c.expiring)} |`
).join('\n')}

For each partner above: where do they provide "speed to contract" via established vehicles? Which sub-agencies above should be pursued through each partner vs. direct?`}

## CONTRACT VEHICLE STRATEGY
${allVehicles.length > 0 ? `The following vehicles are active in this market: **${allVehicles.join(', ')}**.

For each vehicle:
- Which agencies/sub-agencies are buying through it?
- Who holds positions on it that could serve as teaming partners?
- What is the competitive dynamic on each vehicle?` : `No specific contract vehicles detected in award IDs. Analyze the agencies above and recommend the most likely vehicles needed for market entry (e.g., GSA Schedule, OASIS+, SeaPort-NxG, CIO-SP4).`}

${allSetAsides.length > 0 ? `### Set-Aside Strategy
Active set-asides in this market: **${allSetAsides.join(', ')}**. 
- Which opportunities require small business teaming vs. can be pursued full-and-open?
- Recommend specific set-aside teaming arrangements based on the partner data above.` : ''}

## EXPIRING CONTRACTS — IMMEDIATE PIPELINE
${recompeteRows.length > 0 ? `These contracts are expiring within 24 months. Each represents a real, funded recompete opportunity.

| Sub-Agency | Incumbent | Value | End Date | Days Out | Mission Risk |
|---|---|---:|---|---:|---|
${recompeteRows.join('\n')}

For the top 5 expiring contracts:
- Is the incumbent likely to be sole-sourced or will this be competed?
- What is the recommended capture action (bid direct, team, or monitor)?
- What is the 30/60/90 day action plan for each?` : `> No expiring contracts detected in current data window. Consider expanding search timeframe.`}

## PARTNER-TO-INCUMBENT ATTACK MAP
Map the most logical displacement paths using the agency, vehicle, and partner data above.

| Target Incumbent | Sub-Agency | Vehicle | Vulnerability | Recommended Path | Why Now |
|---|---|---|---|---|---|
${competitors.slice(0,4).map((comp, i) => {
  const partner = channels.length > 0 ? channels[i % channels.length].name : 'DIRECT';
  const vehicle = allVehicles.length > 0 ? allVehicles[i % allVehicles.length] : 'TBD';
  return `| ${comp.name} | ${agencies[i % agencies.length]?.topSubs?.[0]?.name || 'Primary'} | ${vehicle} | ${mf(comp.expiring)} expiring | ${partner} | Recompete window |`;
}).join('\n')}

## PIPELINE TARGETS
Based on the data:
- **Addressable recompete pipeline**: ${mf(recompeteVal)} (${metrics.expiringCount} contracts)
- **Median deal size**: ${mf(metrics.medianDealSize)}
- **Deal mix**: ${metrics.largeDeals} large ($1M+), ${metrics.midDeals} mid ($100K-$1M), ${metrics.smallDeals} small (<$100K)

Calculate a realistic ${fyShorthand} revenue target as a range (conservative/moderate/aggressive) based on win rates of 15%/25%/35% against the recompete pipeline. State the required number of active pursuits to hit each target.

## GO-TO-MARKET MOTION
State clearly whether execution is Partner-Led, Direct-Led, or Hybrid. Base this on:
- Vehicle access (do you hold the vehicles above or need a partner?)
- Set-aside requirements (do contracts require SB teaming?)
- Incumbent concentration (are there openings or is the market locked?)

## NEXT 30 DAYS: EXECUTION SPRINT
| Day | Action | Owner | Deliverable | Kill/Go Gate |
|---|---|---|---|---|
| 1-5 | | BD Lead | | |
| 6-15 | | Capture Mgr | | |
| 16-25 | | BD + Technical | | |
| 26-30 | | BD Lead | Pipeline Review | Kill/No-Go |

Fill this table with specific actions tied to the sub-agencies, incumbents, and vehicles from the data above. Every action must reference a real entity from this plan.

## RISKS AND MITIGATION
| Risk | Likelihood | Impact | Mitigation |
|---|---|---|---|
| Vehicle lock-out | | | |
| Incumbent protest | | | |
| Set-aside mismatch | | | |
| Funding uncertainty | | | |
| Partner dependency | | | |

## APPENDIX: DATA SOURCES
All data sourced from USASpending.gov via Govhoo.com. Search query: "${query}". ${metrics.contractCount} contracts analyzed across ${agencies.length} agencies. Generated ${new Date().toISOString().split('T')[0]}.`;
  },
  
  buildPackage(data, analysis, config = {}) {
    const metrics = this.calculateMetrics(data, analysis);
    const vendors = this.buildVendorIntel(data);
    const agencies = this.buildAgencyIntel(data);
    
    return this.generatePrompt({
      query: App.currentQuery,
      metrics,
      vendors,
      agencies,
      analysis // Pass this through even if null
    }, config);
  },

  downloadPackage(promptText) {
    const blob = new Blob([promptText], { type: 'text/plain;charset=utf-8' });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    const fy = Utils.getCurrentFY();
    link.download = `Territory_Plan_FY${fy}_${App.currentQuery.replace(/\s+/g, '_')}.txt`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }
};

// ==================== PIPELINE BUILDER ====================
const PipelineBuilder = {
  generatedPipeline: [],
  historicalData: null,
  
  init() {
    const fySelect = document.getElementById('pipelineTargetFY');
    if (fySelect) {
      const currentFY = Utils.getCurrentFY();
      fySelect.innerHTML = `
        <option value="${currentFY}" selected>FY${currentFY} (Current)</option>
        <option value="${currentFY + 1}">FY${currentFY + 1} (Next)</option>
      `;
    }
  },
  
  open() {
    const modal = document.getElementById('pipelineBuilderModal');
    if (!modal) return;
    this.init();
    this.populateAgencyDropdown();
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';
    document.getElementById('pipelineResultsArea').style.display = 'none';
    document.getElementById('pipelineLoading').style.display = 'none';
    document.getElementById('btnDownloadPipeline').disabled = true;
    document.getElementById('pipelineDataStatus').textContent = 'Configure options and click Generate to build your pipeline.';
  },
  
  close() {
    const modal = document.getElementById('pipelineBuilderModal');
    if (modal) { modal.classList.remove('active'); document.body.style.overflow = ''; }
  },
  
  populateAgencyDropdown() {
    const select = document.getElementById('pipelineFocusAgency');
    if (!select) return;
    const awards = App.forecastData.awards || App.searchData.raw || [];
    const agencies = [...new Set(awards.map(a => a['Awarding Agency']).filter(Boolean))].sort();
    select.innerHTML = '<option value="">All Agencies in Results</option>' +
      agencies.map(a => `<option value="${a}">${Utils.trunc(a, 50)}</option>`).join('');
  },
  
  async generate() {
    const targetFY = parseInt(document.getElementById('pipelineTargetFY').value);
    const historyYears = parseInt(document.getElementById('pipelineHistoryYears').value);
    const probMultiplier = parseFloat(document.getElementById('pipelineProbMultiplier').value);
    const minDeal = parseFloat(document.getElementById('pipelineMinDeal').value);
    const focusAgency = document.getElementById('pipelineFocusAgency').value;
    
    document.getElementById('pipelineLoading').style.display = 'flex';
    document.getElementById('pipelineResultsArea').style.display = 'none';
    document.getElementById('pipelineDataStatus').textContent = 'Fetching historical spending data...';
    
    try {
      const historicalData = await this.fetchHistoricalData(historyYears);
      if (!historicalData || historicalData.length === 0) throw new Error('No historical data found for this search.');
      this.historicalData = historicalData;
      
      document.getElementById('pipelineDataStatus').textContent = 'Analyzing spending patterns and qualifying opportunities...';
      
      const pipeline = this.buildPipelineFromHistory(historicalData, { targetFY, historyYears, probMultiplier, minDeal, focusAgency });
      this.generatedPipeline = pipeline;
      this.renderResults(pipeline, targetFY);
      
      document.getElementById('pipelineLoading').style.display = 'none';
      document.getElementById('pipelineResultsArea').style.display = 'block';
      document.getElementById('btnDownloadPipeline').disabled = pipeline.length === 0;
      document.getElementById('pipelineDataStatus').textContent = 
        `Generated ${pipeline.length} qualified opportunities totaling ${Utils.money(pipeline.reduce((s,o) => s + o.Amount, 0))}`;
    } catch (error) {
      console.error('Pipeline generation error:', error);
      document.getElementById('pipelineLoading').style.display = 'none';
      document.getElementById('pipelineDataStatus').textContent = `Error: ${error.message}`;
    }
  },
  
  async fetchHistoricalData(yearsBack) {
    const query = App.currentQuery;
    if (!query) throw new Error('No search query found. Please run a search first.');
    const currentFY = Utils.getCurrentFY();
    const allAwards = [];
    
    for (let i = 0; i < yearsBack; i++) {
      const fy = currentFY - i;
      const startDate = `${fy - 1}-10-01`;
      const endDate = `${fy}-09-30`;
      const filters = Utils.buildFilters(query, [{start_date: startDate, end_date: endDate}]);
      
      try {
        const res = await fetch(`${API.baseUrl}/search/spending_by_award/`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            filters,
            fields: [
              'Award ID', 'Recipient Name', 'Description', 'Start Date', 'End Date',
              'Award Amount', 'Awarding Agency', 'Awarding Sub Agency',
              'NAICS Code', 'NAICS Description', 'PSC Code', 'PSC Description',
              'generated_internal_id', 'Type of Set Aside'
            ],
            limit: 100, sort: 'Award Amount', order: 'desc'
          })
        });
        const data = await res.json();
        if (data.results && data.results.length > 0) {
          data.results.forEach(award => {
            award._fiscalYear = fy;
            award._quarter = this.getQuarterFromDate(award['Start Date']);
          });
          allAwards.push(...data.results);
        }
      } catch (e) { console.warn(`Failed to fetch FY${fy} data:`, e); }
    }
    return allAwards;
  },
  
  getQuarterFromDate(dateStr) {
    if (!dateStr) return 1;
    const month = new Date(dateStr).getMonth();
    if (month >= 9) return 1;
    if (month <= 2) return 2;
    if (month <= 5) return 3;
    return 4;
  },
  
  getFYQuarterDates(fy, quarter) {
    return {
      1: { start: `${fy-1}-10-01`, end: `${fy-1}-12-31` },
      2: { start: `${fy}-01-01`, end: `${fy}-03-31` },
      3: { start: `${fy}-04-01`, end: `${fy}-06-30` },
      4: { start: `${fy}-07-01`, end: `${fy}-09-30` }
    }[quarter];
  },

  // BANT-style qualification scoring
  scoreOpportunity(pattern, historyYears, recompeteMatch) {
    let score = 0;
    const signals = [];
    
    // BUDGET: Historical spending proves budget exists
    const avgAmount = pattern.historicalAmounts.reduce((a, b) => a + b, 0) / pattern.historicalAmounts.length;
    if (avgAmount >= 1000000) { score += 25; signals.push('$1M+ historical budget'); }
    else if (avgAmount >= 250000) { score += 20; signals.push('$250K+ historical budget'); }
    else if (avgAmount >= 50000) { score += 15; signals.push('$50K+ historical budget'); }
    else { score += 5; }
    
    // AUTHORITY: Sub-agency specificity = higher confidence
    if (pattern.subAgency && pattern.subAgency !== pattern.agency) {
      score += 10; signals.push('Sub-agency identified');
    }
    
    // NEED: Recurrence proves ongoing need
    const uniqueYears = [...new Set(pattern.historicalYears)];
    const recurrence = uniqueYears.length / historyYears;
    if (recurrence >= 0.8) { score += 25; signals.push(`Recurring ${uniqueYears.length}/${historyYears} years`); }
    else if (recurrence >= 0.5) { score += 15; signals.push(`Observed ${uniqueYears.length}/${historyYears} years`); }
    else { score += 5; signals.push(`Seen ${uniqueYears.length}/${historyYears} years`); }
    
    // NEED: Multiple awards = strong demand signal
    if (pattern.historicalAmounts.length >= 5) { score += 10; signals.push(`${pattern.historicalAmounts.length} historical awards`); }
    else if (pattern.historicalAmounts.length >= 3) { score += 5; signals.push(`${pattern.historicalAmounts.length} historical awards`); }
    
    // TIMELINE: Expiring contract = actionable now
    if (recompeteMatch) {
      score += 25; signals.push(`Expiring contract: ${Utils.money(recompeteMatch.amount)} ends ${recompeteMatch.endDate}`);
    }
    
    // Set-aside presence = defined acquisition path
    if (pattern.setAsides.size > 0) {
      score += 5; signals.push(`Set-aside: ${[...pattern.setAsides].join(', ')}`);
    }
    
    // Vehicle detection = known procurement path
    if (pattern.vehicles.size > 0) {
      score += 5; signals.push(`Vehicle: ${[...pattern.vehicles].join(', ')}`);
    }
    
    return { score: Math.min(score, 100), signals, recurrence };
  },
  
  buildPipelineFromHistory(historicalData, options) {
    const { targetFY, historyYears, probMultiplier, minDeal, focusAgency } = options;
    const pipeline = [];
    
    let filteredData = historicalData;
    if (focusAgency) filteredData = historicalData.filter(a => a['Awarding Agency'] === focusAgency);
    if (minDeal > 0) filteredData = filteredData.filter(a => (a['Award Amount'] || 0) >= minDeal);
    
    // Get expiring contracts for cross-reference
    const recompetes = (App.forecastData?.analysis?.recompetes || []).filter(r => r['End Date']);
    
    // PHASE 1: Group by sub-agency + category (NOT per-quarter — that creates fake duplicates)
    // Same sub-agency buying the same category = one pipeline opportunity, regardless of which quarter
    const patterns = {};
    
    filteredData.forEach(award => {
      const agency = award['Awarding Agency'] || 'Unknown';
      const subAgency = award['Awarding Sub Agency'] || agency;
      const naicsCode = award['NAICS Code'] || '';
      const pscCode = award['PSC Code'] || '';
      const categoryKey = pscCode || naicsCode || '_general';
      const quarter = award._quarter || 1;
      
      // Group by sub-agency + category (collapse quarters)
      const patternKey = `${subAgency}|${categoryKey}`;
      
      if (!patterns[patternKey]) {
        patterns[patternKey] = {
          agency, subAgency,
          naicsCode, pscCode,
          naicsDesc: award['NAICS Description'] || '',
          pscDesc: award['PSC Description'] || '',
          historicalAmounts: [],
          historicalYears: [],
          quarterCounts: { 1: 0, 2: 0, 3: 0, 4: 0 },
          descriptions: [],
          vendors: [],
          sourceAwardMap: new Map(), // Dedup by generated_internal_id
          setAsides: new Set(),
          vehicles: new Set()
        };
      }
      
      const p = patterns[patternKey];
      p.historicalAmounts.push(award['Award Amount'] || 0);
      p.historicalYears.push(award._fiscalYear);
      p.quarterCounts[quarter] = (p.quarterCounts[quarter] || 0) + 1;
      if (award['Description']) p.descriptions.push(award['Description']);
      if (award['Recipient Name']) p.vendors.push(award['Recipient Name']);
      
      // Propagate PSC/NAICS from any award that has them (fill gaps)
      if (!p.naicsCode && naicsCode) { p.naicsCode = naicsCode; p.naicsDesc = award['NAICS Description'] || ''; }
      if (!p.pscCode && pscCode) { p.pscCode = pscCode; p.pscDesc = award['PSC Description'] || ''; }
      
      // Dedup source awards by generated_internal_id (multiple obligations on same award = 1 entry)
      const srcId = award['generated_internal_id'] || award['Award ID'] || `${award['Recipient Name']}_${award['Award Amount']}`;
      if (!p.sourceAwardMap.has(srcId)) {
        p.sourceAwardMap.set(srcId, {
          id: award['generated_internal_id'] || null,
          awardId: award['Award ID'] || '',
          amount: award['Award Amount'] || 0,
          vendor: award['Recipient Name'] || '',
          fy: award._fiscalYear,
          endDate: award['End Date'] || ''
        });
      }
      
      const sa = VehicleDetector.getSetAsideLabel(award['Type of Set Aside']);
      if (sa) p.setAsides.add(sa);
      const v = VehicleDetector.detect(award['Award ID']);
      if (v) p.vehicles.add(v.short);
    });
    
    // PHASE 2: Generate qualified opps
    Object.values(patterns).forEach(pattern => {
      const sourceAwards = [...pattern.sourceAwardMap.values()];
      if (sourceAwards.length < 1) return;
      
      // Use MEDIAN instead of mean to avoid outlier distortion (single $5B mod)
      const sortedAmounts = [...pattern.historicalAmounts].sort((a, b) => a - b);
      const medianAmount = sortedAmounts.length % 2 === 0
        ? (sortedAmounts[sortedAmounts.length / 2 - 1] + sortedAmounts[sortedAmounts.length / 2]) / 2
        : sortedAmounts[Math.floor(sortedAmounts.length / 2)];
      const avgAmount = pattern.historicalAmounts.reduce((a, b) => a + b, 0) / pattern.historicalAmounts.length;
      
      // Use median for projection (resistant to outliers like DCMA $5B mods)
      const projectedAmount = medianAmount * probMultiplier;
      if (projectedAmount < minDeal) return;
      
      // Peak quarter determines close date
      const peakQ = Object.entries(pattern.quarterCounts).sort((a, b) => b[1] - a[1])[0];
      const quarter = parseInt(peakQ[0]);
      
      // Cross-reference with expiring contracts — relax matching (sub-agency OR description overlap)
      const recompeteMatch = recompetes.find(r => {
        const rSubAgency = r['Awarding Sub Agency'] || r['Awarding Agency'] || '';
        const rAgency = r['Awarding Agency'] || '';
        const subMatch = rSubAgency === pattern.subAgency || rAgency === pattern.agency;
        if (!subMatch) return false;
        // Match on PSC/NAICS if available, otherwise match on sub-agency alone
        if (pattern.pscCode && r['PSC Code'] === pattern.pscCode) return true;
        if (pattern.naicsCode && r['NAICS Code'] === pattern.naicsCode) return true;
        // Fuzzy: if no codes, match sub-agency + similar description
        if (!pattern.pscCode && !pattern.naicsCode) {
          const rDesc = (r['Description'] || '').toLowerCase();
          const pDescs = pattern.descriptions.map(d => d.toLowerCase());
          return pDescs.some(d => {
            const words = d.split(/\s+/).filter(w => w.length > 4);
            return words.filter(w => rDesc.includes(w)).length >= 2;
          });
        }
        return false;
      });
      
      const recompeteData = recompeteMatch ? {
        amount: recompeteMatch['Award Amount'] || 0,
        endDate: Utils.date(recompeteMatch['End Date']),
        vendor: recompeteMatch['Recipient Name'] || '',
        awardId: recompeteMatch['Award ID'] || ''
      } : null;
      
      // BANT qualification score
      const qual = this.scoreOpportunity(pattern, historyYears, recompeteData);
      if (qual.score < 20) return;
      
      const uniqueYears = [...new Set(pattern.historicalYears)];
      const quarterDates = this.getFYQuarterDates(targetFY, quarter);
      
      // Best description — extract meaningful keywords, not generic text
      const descCounts = {};
      pattern.descriptions.forEach(d => { const k = d.substring(0, 120); descCounts[k] = (descCounts[k] || 0) + 1; });
      const topDesc = Object.entries(descCounts).sort((a, b) => b[1] - a[1])[0];
      
      // Incumbent analysis
      const vendorCounts = {};
      pattern.vendors.forEach(v => { vendorCounts[v] = (vendorCounts[v] || 0) + 1; });
      const sortedVendors = Object.entries(vendorCounts).sort((a, b) => b[1] - a[1]);
      const incumbent = sortedVendors[0];
      const incumbentDominance = incumbent ? Math.round((incumbent[1] / pattern.vendors.length) * 100) : 0;
      
      // Stage
      const currentQuarter = Utils.getCurrentQuarter();
      const currentFY = Utils.getCurrentFY();
      let stage = 'Prospecting';
      if (recompeteData) {
        stage = 'Qualification';
      } else if (targetFY === currentFY && quarter <= currentQuarter + 1) {
        stage = 'Qualification';
      }
      
      // Smart opp name with description excerpt when no PSC
      const subAgencyShort = Utils.trunc(pattern.subAgency, 25);
      let descKeywords = pattern.pscDesc || pattern.naicsDesc || '';
      if (!descKeywords && topDesc) {
        // Extract first meaningful phrase from description
        descKeywords = topDesc[0].split(/[,;.]/)[0].substring(0, 40);
      }
      if (!descKeywords) descKeywords = App.currentQuery;
      const oppName = `${subAgencyShort} — ${Utils.trunc(descKeywords, 35)} — FY${targetFY}`;
      
      // Build DEDUPED source award links (top 3 unique awards by amount)
      const topSources = sourceAwards
        .sort((a, b) => b.amount - a.amount)
        .slice(0, 3)
        .map(s => ({
          url: s.id ? `https://www.usaspending.gov/award/${s.id}` : '',
          label: `FY${s.fy} ${Utils.money(s.amount)} (${Utils.trunc(s.vendor, 20)})`,
          awardId: s.awardId
        }));
      
      const vendorRel = incumbent ? VendorRelationships.get(incumbent[0]) : null;
      
      pipeline.push({
        OpportunityName: oppName,
        AccountName: pattern.agency,
        SubAgency: pattern.subAgency,
        Amount: Math.round(projectedAmount),
        CloseDate: quarterDates.end,
        StageName: stage,
        Probability: Math.round(qual.score * probMultiplier),
        Type: recompeteData ? 'Existing Business - Recompete' : 'New Business',
        LeadSource: 'USAspending Historical Analysis',
        Description: topDesc ? topDesc[0] : `Projected from ${uniqueYears.length}yr history`,
        NextStep: this.getNextStep(stage, recompeteData, vendorRel),
        
        QualScore: qual.score,
        QualSignals: qual.signals,
        
        FiscalYear: `FY${targetFY}`,
        FiscalQuarter: `Q${quarter}`,
        NAICSCode: pattern.naicsCode,
        NAICSDescription: pattern.naicsDesc,
        PSCCode: pattern.pscCode,
        PSCDescription: pattern.pscDesc,
        
        Incumbent: incumbent ? incumbent[0] : '',
        IncumbentWins: incumbent ? incumbent[1] : 0,
        IncumbentDominance: incumbentDominance,
        VendorRelationship: vendorRel || '',
        
        HistoricalAverage: Math.round(avgAmount),
        HistoricalMedian: Math.round(medianAmount),
        HistoricalYearsObserved: uniqueYears.join(', '),
        RecurrenceRate: `${Math.round(qual.recurrence * 100)}%`,
        SourceAwards: topSources,
        SourceAwardCount: sourceAwards.length,
        
        ContractVehicle: [...pattern.vehicles].join(', '),
        SetAside: [...pattern.setAsides].join(', '),
        
        RecompeteFlag: !!recompeteData,
        RecompeteEndDate: recompeteData ? recompeteData.endDate : '',
        RecompeteIncumbent: recompeteData ? recompeteData.vendor : '',
        
        DataSource: 'USAspending.gov',
        GeneratedDate: new Date().toISOString().split('T')[0],
        SearchKeyword: App.currentQuery
      });
    });
    
    // Sort: recompetes first, then by qual score, then by amount
    pipeline.sort((a, b) => {
      if (a.RecompeteFlag !== b.RecompeteFlag) return b.RecompeteFlag ? 1 : -1;
      if (a.QualScore !== b.QualScore) return b.QualScore - a.QualScore;
      return b.Amount - a.Amount;
    });
    
    
    return pipeline;
  },
  
  getNextStep(stage, recompeteData, vendorRel) {
    if (recompeteData) {
      if (vendorRel === 'mine') return `Defend: Incumbent contract expires ${recompeteData.endDate}. Engage CO and confirm recompete timeline.`;
      if (vendorRel === 'partner') return `Support partner: Contract expires ${recompeteData.endDate}. Align on recompete teaming strategy.`;
      return `Pursue recompete: Current incumbent contract expires ${recompeteData.endDate}. Research RFP timeline and engage agency.`;
    }
    if (stage === 'Qualification') return 'Validate requirement with agency contacts. Confirm funding and acquisition timeline.';
    return 'Research agency contacts and identify program office. Determine if requirement is funded.';
  },
  
  renderResults(pipeline, targetFY) {
    const totalValue = pipeline.reduce((s, o) => s + o.Amount, 0);
    const avgDeal = pipeline.length > 0 ? totalValue / pipeline.length : 0;
    const recompeteCount = pipeline.filter(o => o.RecompeteFlag).length;
    const recompeteValue = pipeline.filter(o => o.RecompeteFlag).reduce((s, o) => s + o.Amount, 0);
    const avgScore = pipeline.length > 0 ? Math.round(pipeline.reduce((s, o) => s + o.QualScore, 0) / pipeline.length) : 0;
    
    document.getElementById('pipelineStatsGrid').innerHTML = `
      <div class="pipeline-stat">
        <div class="pipeline-stat-label">Total Pipeline</div>
        <div class="pipeline-stat-value">${Utils.money(totalValue)}</div>
        <div class="pipeline-stat-sub">${pipeline.length} qualified opps</div>
      </div>
      <div class="pipeline-stat">
        <div class="pipeline-stat-label">Recompete Opps</div>
        <div class="pipeline-stat-value" style="color:var(--danger);">${recompeteCount}</div>
        <div class="pipeline-stat-sub">${Utils.money(recompeteValue)} linked to expiring</div>
      </div>
      <div class="pipeline-stat">
        <div class="pipeline-stat-label">Avg Deal Size</div>
        <div class="pipeline-stat-value">${Utils.money(avgDeal)}</div>
        <div class="pipeline-stat-sub">Weighted by history</div>
      </div>
      <div class="pipeline-stat">
        <div class="pipeline-stat-label">Avg Qual Score</div>
        <div class="pipeline-stat-value">${avgScore}/100</div>
        <div class="pipeline-stat-sub">BANT-based scoring</div>
      </div>
    `;
    
    document.getElementById('pipelineResultCount').textContent = pipeline.length;
    
    if (pipeline.length === 0) {
      document.getElementById('pipelineTableContainer').innerHTML = `
        <div style="text-align:center; padding:2rem; color:var(--text-muted);">
          <i class="fas fa-search" style="font-size:2rem; margin-bottom:1rem; opacity:0.5;"></i>
          <p>No qualified opportunities generated. Try adjusting the minimum deal size or historical years.</p>
        </div>`;
      return;
    }
    
    document.getElementById('pipelineTableContainer').innerHTML = `
      <table class="pipeline-table">
        <thead>
          <tr>
            <th style="min-width:45px;">Score</th>
            <th>Opportunity</th>
            <th>Sub-Agency</th>
            <th>Amount</th>
            <th>Qtr</th>
            <th>Stage</th>
            <th>Incumbent</th>
            <th>Vehicle</th>
            <th>Evidence</th>
          </tr>
        </thead>
        <tbody>
          ${pipeline.map(opp => {
            const scoreColor = opp.QualScore >= 70 ? 'var(--success)' : opp.QualScore >= 40 ? 'var(--accent)' : 'var(--text-muted)';
            const scoreLabel = opp.QualScore >= 70 ? 'Strong' : opp.QualScore >= 40 ? 'Medium' : 'Early';
            const sourceLinks = opp.SourceAwards.filter(s => s.url).map(s =>
              `<a href="${s.url}" target="_blank" style="font-size:0.65rem; color:var(--link); text-decoration:none; display:block; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:180px;" title="${s.label}">${s.label}</a>`
            ).join('');
            const vendorRelIcon = opp.VendorRelationship === 'mine' ? '<span title="My Company" style="color:var(--accent); font-size:0.6rem; font-weight:700; border:1px solid var(--accent); padding:1px 4px; border-radius:2px; margin-right:3px;">MINE</span>' :
              opp.VendorRelationship === 'partner' ? '<span title="Partner" style="color:var(--info); font-size:0.6rem; font-weight:700; border:1px solid var(--info); padding:1px 4px; border-radius:2px; margin-right:3px;">PTR</span>' :
              opp.VendorRelationship === 'competitor' ? '<span title="Competitor" style="color:var(--danger); font-size:0.6rem; font-weight:700; border:1px solid var(--danger); padding:1px 4px; border-radius:2px; margin-right:3px;">COMP</span>' : '';
            
            return `
            <tr style="${opp.RecompeteFlag ? 'border-left:3px solid var(--danger);' : ''}">
              <td style="text-align:center;">
                <div style="font-family:'JetBrains Mono',monospace; font-size:0.85rem; font-weight:700; color:${scoreColor};">${opp.QualScore}</div>
                <div style="font-size:0.55rem; color:${scoreColor}; text-transform:uppercase;">${scoreLabel}</div>
              </td>
              <td>
                <div title="${opp.OpportunityName}" style="font-weight:600; font-size:0.8rem;">${Utils.trunc(opp.OpportunityName, 40)}</div>
                ${opp.RecompeteFlag ? `<span style="font-size:0.6rem; color:var(--danger); background:rgba(166,68,56,0.15); padding:1px 5px; border-radius:2px;">RECOMPETE — ends ${opp.RecompeteEndDate}</span>` : ''}
                ${opp.SetAside ? `<span style="font-size:0.6rem; color:var(--accent); background:rgba(229,192,123,0.15); padding:1px 5px; border-radius:2px; margin-left:4px;">${opp.SetAside}</span>` : ''}
              </td>
              <td style="font-size:0.8rem;" title="${opp.SubAgency}">${Utils.trunc(opp.SubAgency, 22)}</td>
              <td class="amount">${Utils.money(opp.Amount)}</td>
              <td><span class="pipeline-quarter-badge">${opp.FiscalQuarter}</span></td>
              <td><span class="stage ${opp.StageName.toLowerCase()}">${opp.StageName}</span></td>
              <td style="font-size:0.75rem;">
                ${vendorRelIcon}${Utils.trunc(opp.Incumbent || '—', 18)}
                ${opp.IncumbentWins > 1 ? `<div style="font-size:0.6rem; color:var(--text-muted);">${opp.IncumbentWins} awards · ${opp.IncumbentDominance}% share</div>` : ''}
              </td>
              <td style="font-size:0.75rem;">${opp.ContractVehicle || '—'}</td>
              <td style="font-size:0.7rem;">
                <div style="font-size:0.6rem; color:var(--text-muted); margin-bottom:2px;">${opp.SourceAwardCount} source awards</div>
                ${sourceLinks || '<span style="color:var(--text-muted); font-size:0.6rem;">No direct links</span>'}
              </td>
            </tr>`;
          }).join('')}
        </tbody>
      </table>
      <div style="padding:0.75rem 1rem; border-top:1px solid var(--border); font-size:0.7rem; color:var(--text-muted); display:flex; justify-content:space-between; align-items:center;">
        <span>Score = BANT qualification (Budget + Authority + Need + Timeline)</span>
        <span style="color:var(--danger); font-weight:600;">Red border = linked to expiring contract</span>
      </div>
    `;
  },
  
  downloadCSV() {
    if (this.generatedPipeline.length === 0) {
      alert('No pipeline data to download. Please generate a pipeline first.');
      return;
    }
    
    const headers = [
      'Opportunity Name', 'Account Name', 'Sub-Agency', 'Amount', 'Close Date',
      'Stage', 'Probability (%)', 'Qualification Score', 'Type', 'Lead Source',
      'Description', 'Next Step',
      'Fiscal Year', 'Fiscal Quarter',
      'NAICS Code', 'NAICS Description', 'PSC Code', 'PSC Description',
      'Contract Vehicle', 'Set-Aside',
      'Incumbent', 'Incumbent Wins', 'Incumbent Dominance (%)',
      'Recompete Flag', 'Recompete End Date', 'Recompete Incumbent',
      'Historical Average', 'Historical Median', 'Historical Years Observed', 'Recurrence Rate',
      'Source Award Count', 'Source Award 1', 'Source Award 2', 'Source Award 3',
      'Qualification Signals',
      'Data Source', 'Generated Date', 'Search Keyword'
    ];
    
    const rows = this.generatedPipeline.map(opp => [
      opp.OpportunityName, opp.AccountName, opp.SubAgency, opp.Amount, opp.CloseDate,
      opp.StageName, opp.Probability, opp.QualScore, opp.Type, opp.LeadSource,
      opp.Description, opp.NextStep,
      opp.FiscalYear, opp.FiscalQuarter,
      opp.NAICSCode, opp.NAICSDescription, opp.PSCCode, opp.PSCDescription,
      opp.ContractVehicle, opp.SetAside,
      opp.Incumbent, opp.IncumbentWins, opp.IncumbentDominance,
      opp.RecompeteFlag ? 'Yes' : '', opp.RecompeteEndDate, opp.RecompeteIncumbent,
      opp.HistoricalAverage, opp.HistoricalMedian, opp.HistoricalYearsObserved, opp.RecurrenceRate,
      opp.SourceAwardCount,
      opp.SourceAwards[0] ? opp.SourceAwards[0].url : '',
      opp.SourceAwards[1] ? opp.SourceAwards[1].url : '',
      opp.SourceAwards[2] ? opp.SourceAwards[2].url : '',
      opp.QualSignals.join('; '),
      opp.DataSource, opp.GeneratedDate, opp.SearchKeyword
    ]);
    
    const escapeCSV = (val) => {
      if (val === null || val === undefined) return '';
      const str = String(val);
      if (str.includes(',') || str.includes('"') || str.includes('\n')) return `"${str.replace(/"/g, '""')}"`;
      return str;
    };
    
    const csvContent = [
      headers.map(escapeCSV).join(','),
      ...rows.map(row => row.map(escapeCSV).join(','))
    ].join('\n');
    
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    const targetFY = document.getElementById('pipelineTargetFY').value;
    link.download = `Pipeline_FY${targetFY}_${App.currentQuery.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    document.getElementById('pipelineDataStatus').textContent = 'CSV downloaded! Includes source award links, qualification scores, and recompete flags.';
  }
};

// ==================== CONVERSATION STARTERS ====================
const ConvoStarters = {
  currentFocus: 'agencies',
  currentMode: 'prime', // 'prime' or 'sub'
  generatedStarters: [],
  
  open(mode = 'prime') {
    const modal = document.getElementById('convoStartersModal');
    if (!modal) return;
    
    this.currentMode = mode;
    
    if (mode === 'sub') {
      // Check for subaward data
      const subawards = App.forecastData.subawards || [];
      if (subawards.length === 0) {
        alert('No subcontract data available. Please run a search first.');
        return;
      }
    } else {
      // Check for prime award data
      const awards = App.searchData.active || [];
      if (awards.length === 0) {
        alert('Please run a search first to generate conversation starters.');
        return;
      }
    }
    
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';
    
    // Update modal title based on mode
    const titleEl = modal.querySelector('.channel-modal-title');
    if (titleEl) {
      if (mode === 'sub') {
        titleEl.innerHTML = '<span class="sub-bullet"><i class="fas fa-handshake"></i></span> TEAMING CONVERSATION STARTERS';
      } else {
        titleEl.innerHTML = '<i class="fas fa-comments" style="color: var(--info);"></i> CONVERSATION STARTERS';
      }
    }
    
    // Update toggle buttons for mode
    const toggleContainer = modal.querySelector('.convo-focus-toggle');
    if (toggleContainer) {
      if (mode === 'sub') {
        toggleContainer.innerHTML = `
          <button class="convo-focus-btn active" data-convo-focus="primes" onclick="ConvoStarters.setFocus('primes')" style="border-color: var(--accent);">
            <span class="sub-bullet sm blue"><i class="fas fa-building"></i></span> Primes
          </button>
          <button class="convo-focus-btn" data-convo-focus="subs" onclick="ConvoStarters.setFocus('subs')" style="border-color: var(--accent);">
            <span class="sub-bullet sm"><i class="fas fa-user-friends"></i></span> Subs
          </button>
          <button class="convo-focus-btn" data-convo-focus="both" onclick="ConvoStarters.setFocus('both')" style="border-color: var(--accent);">
            <span class="sub-bullet sm gray"><i class="fas fa-users"></i></span> Both
          </button>
        `;
        this.setFocus('primes');
      } else {
        toggleContainer.innerHTML = `
          <button class="convo-focus-btn active" data-convo-focus="agencies" onclick="ConvoStarters.setFocus('agencies')">
            <span class="sub-bullet sm blue"><i class="fas fa-landmark"></i></span> Agencies
          </button>
          <button class="convo-focus-btn" data-convo-focus="vendors" onclick="ConvoStarters.setFocus('vendors')">
            <span class="sub-bullet sm"><i class="fas fa-building"></i></span> Vendors
          </button>
          <button class="convo-focus-btn" data-convo-focus="both" onclick="ConvoStarters.setFocus('both')">
            <span class="sub-bullet sm gray"><i class="fas fa-users"></i></span> Both
          </button>
        `;
        this.setFocus('agencies');
      }
    }
    
    // Show context
    this.updateContext();
  },
  
  updateContext() {
    const statusEl = document.getElementById('convoDataStatus');
    
    if (this.currentMode === 'sub') {
      let subawards = App.forecastData.subawards || [];
      const drill = App.subawardDrillState || {};
      
      // Apply drill filter
      if (drill.level > 0 && drill.filter) {
        if (drill.filterType === 'prime') {
          subawards = subawards.filter(s => (s['Prime Recipient Name'] || 'Unknown Prime') === drill.filter);
        } else if (drill.filterType === 'sub') {
          subawards = subawards.filter(s => (s['Sub-Awardee Name'] || 'Unknown Sub') === drill.filter);
        }
      }
      
      let contextParts = [];
      if (drill.level > 0 && drill.filter) {
        contextParts.push(`Filtered to: ${drill.filter}`);
      }
      if (App.currentQuery) {
        contextParts.push(`Search: "${App.currentQuery}"`);
      }
      
      if (statusEl) {
        if (contextParts.length > 0) {
          statusEl.innerHTML = `Based on <span id="convoAwardCount">${subawards.length}</span> subcontracts. ${contextParts.join(' · ')}`;
        } else {
          statusEl.innerHTML = `Based on <span id="convoAwardCount">${subawards.length}</span> subcontracts from your search.`;
        }
      }
    } else {
      const awards = App.searchData.active || [];
      const drill = App.drillState || {};
      const filter = App.searchData.filter;
      
      let contextParts = [];
      
      if (drill.path && drill.path.length > 0) {
        const pathNames = drill.path.map(p => typeof p === 'object' ? p.name : p).filter(Boolean);
        if (pathNames.length > 0) {
          contextParts.push(`Filtered to: ${pathNames.join(' → ')}`);
        }
      } else if (filter) {
        contextParts.push(`Filtered to: ${filter}`);
      }
      
      if (App.currentQuery) {
        contextParts.push(`Search: "${App.currentQuery}"`);
      }
      
      if (statusEl) {
        if (contextParts.length > 0) {
          statusEl.innerHTML = `Based on <span id="convoAwardCount">${awards.length}</span> awards. ${contextParts.join(' · ')}`;
        } else {
          statusEl.innerHTML = `Based on <span id="convoAwardCount">${awards.length}</span> awards from your search.`;
        }
      }
    }
  },
  
  close() {
    const modal = document.getElementById('convoStartersModal');
    if (modal) {
      modal.classList.remove('active');
      document.body.style.overflow = '';
    }
  },
  
  setFocus(focus) {
    this.currentFocus = focus;
    
    // Update toggle buttons
    document.querySelectorAll('.convo-focus-btn').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.convoFocus === focus);
    });
    
    // Generate and render
    this.generate();
  },
  
  generate() {
    // Show brief loading state
    const resultsArea = document.getElementById('convoResultsArea');
    if (resultsArea) {
      resultsArea.innerHTML = '<div class="convo-empty"><i class="fas fa-spinner fa-spin"></i><p>Generating talking points...</p></div>';
    }
    
    const starters = [];
    const query = App.currentQuery || 'this market';
    
    if (this.currentMode === 'sub') {
      // SUBAWARD MODE
      let subawards = App.forecastData.subawards || [];
      if (subawards.length === 0) return;
      
      // Apply drill filter
      const drill = App.subawardDrillState || {};
      if (drill.level > 0 && drill.filter) {
        if (drill.filterType === 'prime') {
          subawards = subawards.filter(s => (s['Prime Recipient Name'] || 'Unknown Prime') === drill.filter);
        } else if (drill.filterType === 'sub') {
          subawards = subawards.filter(s => (s['Sub-Awardee Name'] || 'Unknown Sub') === drill.filter);
        }
      }
      
      const drillContext = {
        prime: drill.filterType === 'prime' ? drill.filter : null,
        sub: drill.filterType === 'sub' ? drill.filter : null
      };
      
      // Analyze subaward data
      const primeData = this.analyzePrimes(subawards);
      const subData = this.analyzeSubs(subawards);
      
      if (this.currentFocus === 'primes' || this.currentFocus === 'both') {
        starters.push(...this.generatePrimeStarters(primeData, subData, query, drillContext));
      }
      
      if (this.currentFocus === 'subs' || this.currentFocus === 'both') {
        starters.push(...this.generateSubStarters(subData, primeData, query, drillContext));
      }
      
    } else {
      // PRIME AWARD MODE (original behavior)
      const awards = App.searchData.active || [];
      if (awards.length === 0) return;
      
      const drill = App.drillState || {};
      const lastPathItem = drill.path && drill.path.length > 0 ? drill.path[drill.path.length - 1] : null;
      const drillContext = {
        agency: drill.currentAgency || null,
        subAgency: drill.currentSubAgency || null,
        vendor: drill.level === 3 && lastPathItem ? (typeof lastPathItem === 'object' ? lastPathItem.name : lastPathItem) : null,
        level: drill.level || 0
      };
      
      const agencyData = this.analyzeAgencies(awards);
      const vendorData = this.analyzeVendors(awards);
      const recompetes = this.findRecompetes(awards);
      
      if (this.currentFocus === 'agencies' || this.currentFocus === 'both') {
        starters.push(...this.generateAgencyStarters(agencyData, vendorData, recompetes, query, drillContext));
      }
      
      if (this.currentFocus === 'vendors' || this.currentFocus === 'both') {
        starters.push(...this.generateVendorStarters(vendorData, agencyData, query, drillContext));
      }
    }
    
    this.generatedStarters = starters;
    this.render(starters);
  },
  
  // Analyze primes from subaward data
  analyzePrimes(subawards) {
    const map = {};
    subawards.forEach(s => {
      const prime = s['Prime Recipient Name'] || 'Unknown Prime';
      const sub = s['Sub-Awardee Name'] || 'Unknown Sub';
      const amount = parseFloat(s['Sub-Award Amount']) || 0;
      const agency = s['Awarding Agency'] || s['Awarding Sub Agency'] || '';
      
      if (!map[prime]) {
        map[prime] = { name: prime, totalSubbed: 0, subCount: 0, subs: {}, agencies: {} };
      }
      
      map[prime].totalSubbed += amount;
      map[prime].subCount++;
      map[prime].subs[sub] = (map[prime].subs[sub] || 0) + amount;
      if (agency) map[prime].agencies[agency] = (map[prime].agencies[agency] || 0) + amount;
    });
    
    return Object.values(map)
      .map(p => {
        const subsSorted = Object.entries(p.subs).sort((a, b) => b[1] - a[1]);
        p.topSub = subsSorted[0] ? { name: subsSorted[0][0], amount: subsSorted[0][1] } : null;
        p.subVendorCount = subsSorted.length;
        const agenciesSorted = Object.entries(p.agencies).sort((a, b) => b[1] - a[1]);
        p.topAgency = agenciesSorted[0] ? { name: agenciesSorted[0][0], amount: agenciesSorted[0][1] } : null;
        return p;
      })
      .sort((a, b) => b.totalSubbed - a.totalSubbed);
  },
  
  // Analyze subs from subaward data
  analyzeSubs(subawards) {
    const map = {};
    subawards.forEach(s => {
      const prime = s['Prime Recipient Name'] || 'Unknown Prime';
      const sub = s['Sub-Awardee Name'] || 'Unknown Sub';
      const amount = parseFloat(s['Sub-Award Amount']) || 0;
      const agency = s['Awarding Agency'] || s['Awarding Sub Agency'] || '';
      
      if (!map[sub]) {
        map[sub] = { name: sub, totalReceived: 0, awardCount: 0, primes: {}, agencies: {} };
      }
      
      map[sub].totalReceived += amount;
      map[sub].awardCount++;
      map[sub].primes[prime] = (map[sub].primes[prime] || 0) + amount;
      if (agency) map[sub].agencies[agency] = (map[sub].agencies[agency] || 0) + amount;
    });
    
    return Object.values(map)
      .map(s => {
        const primesSorted = Object.entries(s.primes).sort((a, b) => b[1] - a[1]);
        s.topPrime = primesSorted[0] ? { name: primesSorted[0][0], amount: primesSorted[0][1] } : null;
        s.primeCount = primesSorted.length;
        return s;
      })
      .sort((a, b) => b.totalReceived - a.totalReceived);
  },
  
  // Generate conversation starters for approaching prime contractors
  generatePrimeStarters(primes, subs, query, drillContext = {}) {
    const starters = [];
    const topPrimes = primes.slice(0, 5);
    
    // Varied templates for approaching primes about teaming
    const teamingTemplates = [
      (shortName, query) => `I noticed ${shortName} subs out a lot of ${query} work. Is that by design, or do you just have more opportunities than bandwidth?`,
      (shortName, query) => `How does ${shortName} usually find teaming partners for ${query} work—do you use capability briefs, or is it mostly through relationships?`,
      (shortName, query) => `I'm a small shop with ${query} expertise. What would make someone like me actually useful to ${shortName} on a proposal?`,
      (shortName, subCount) => `${shortName} works with ${subCount} different subs—that's impressive. How do you manage that many teaming relationships?`,
      (shortName, query) => `Is ${shortName} actively looking to expand your ${query} bench, or are you pretty locked in with your current teammates?`
    ];
    
    const relationshipTemplates = [
      (shortName, topSub) => `I see you work a lot with ${topSub}. How'd that teaming relationship get started?`,
      (shortName, topSub) => `${topSub} seems to be your go-to sub. What makes that partnership work so well?`,
      (shortName, query) => `What's the best way to get on ${shortName}'s radar for future ${query} opportunities?`,
      (shortName) => `Does ${shortName} prefer working with the same subs repeatedly, or do you mix it up based on the opportunity?`,
      (shortName, query) => `I heard ${shortName} has some ${query} bids coming up. Are you already teamed, or still building your roster?`
    ];
    
    topPrimes.forEach((prime, idx) => {
      const shortName = prime.name.split(' ').slice(0, 2).join(' ');
      
      // Teaming inquiry
      const teamingTemplate = teamingTemplates[idx % teamingTemplates.length];
      if (idx < 3 || prime.subVendorCount > 2) {
        starters.push({
          type: 'prime',
          target: prime.name,
          icon: 'fa-handshake',
          text: teamingTemplate(shortName, query, prime.subVendorCount)
        });
      }
      
      // Relationship-based
      if (prime.topSub && prime.topSub.name !== drillContext.sub) {
        const topSubShort = prime.topSub.name.split(' ').slice(0, 2).join(' ');
        const relTemplate = relationshipTemplates[idx % relationshipTemplates.length];
        starters.push({
          type: 'prime',
          target: prime.name,
          icon: 'fa-user-friends',
          text: relTemplate(shortName, topSubShort, query)
        });
      }
      
      // Volume-based
      if (prime.totalSubbed > 1000000) {
        starters.push({
          type: 'prime',
          target: prime.name,
          icon: 'fa-chart-bar',
          text: `${shortName} subs out about ${Utils.money(prime.totalSubbed)} in ${query} work. Is that a growing part of your business, or pretty stable?`
        });
      }
    });
    
    // Universal teaming icebreakers
    starters.push({
      type: 'prime',
      target: 'General',
      icon: 'fa-coffee',
      text: `I'm looking for primes who need ${query} support. Any advice on how to approach these conversations without sounding desperate?`
    });
    
    starters.push({
      type: 'prime',
      target: 'General', 
      icon: 'fa-lightbulb',
      text: `What makes a capability brief actually get read? I've sent a bunch out but never hear back.`
    });
    
    return starters;
  },
  
  // Generate conversation starters for talking to potential sub teammates or competitors
  generateSubStarters(subs, primes, query, drillContext = {}) {
    const starters = [];
    const topSubs = subs.slice(0, 5);
    
    const subTemplates = [
      (shortName, topPrime) => `I see you do a lot of ${query} work for ${topPrime}. How'd you get on their team?`,
      (shortName, primeCount) => `You're teaming with ${primeCount} different primes—do you have a favorite, or is it all the same?`,
      (shortName, query) => `Are you looking to expand your prime relationships for ${query} work, or are you pretty maxed out?`,
      (shortName, topPrime) => `Is ${topPrime} good to work with as a prime? I'm thinking about approaching them.`,
      (shortName, query) => `What's your sweet spot in ${query}? I'm trying to figure out where there might be teaming synergies.`
    ];
    
    const competitorTemplates = [
      (shortName, query) => `We might be going after similar ${query} work. Any interest in teaming instead of competing?`,
      (shortName) => `I've seen ${shortName} on a few proposal teams. Do you mostly sub, or do you prime stuff too?`,
      (shortName, query) => `How's the ${query} market treating you? Feels like there's more competition than ever.`,
      (shortName) => `Do you prefer being a sub or going after prime contracts directly? I'm still figuring out my strategy.`
    ];
    
    topSubs.forEach((sub, idx) => {
      const shortName = sub.name.split(' ').slice(0, 2).join(' ');
      
      // Prime relationship question
      if (sub.topPrime && sub.topPrime.name !== drillContext.prime) {
        const topPrimeShort = sub.topPrime.name.split(' ').slice(0, 2).join(' ');
        const template = subTemplates[idx % subTemplates.length];
        starters.push({
          type: 'sub',
          target: sub.name,
          icon: 'fa-link',
          text: template(shortName, topPrimeShort, sub.primeCount, query)
        });
      }
      
      // Multi-prime relationship
      if (sub.primeCount > 1) {
        starters.push({
          type: 'sub',
          target: sub.name,
          icon: 'fa-network-wired',
          text: `${shortName} teams with ${sub.primeCount} different primes. How do you balance those relationships without stepping on toes?`
        });
      }
      
      // Competitor/peer conversation
      const compTemplate = competitorTemplates[idx % competitorTemplates.length];
      starters.push({
        type: 'sub',
        target: sub.name,
        icon: 'fa-users',
        text: compTemplate(shortName, query)
      });
    });
    
    // Universal sub icebreakers
    starters.push({
      type: 'sub',
      target: 'General',
      icon: 'fa-question-circle',
      text: `How do you find out about teaming opportunities before the RFP drops? I feel like I'm always late to the party.`
    });
    
    starters.push({
      type: 'sub',
      target: 'General',
      icon: 'fa-handshake',
      text: `Anyone here looking for ${query} teammates? I've got capacity and I'm tired of chasing primes who ghost me.`
    });
    
    return starters;
  },
  
  analyzeAgencies(awards) {
    const map = {};
    const drill = App.drillState || {};
    // When drilled to sub-agency level, group by sub-agency instead of top-level agency
    const useSubAgency = drill.level >= 2 && drill.currentSubAgency;
    
    awards.forEach(a => {
      // Use sub-agency when drilled to that level, otherwise use top-level agency
      const agency = useSubAgency 
        ? (a['Awarding Sub Agency'] || a['Awarding Agency'] || 'Unknown')
        : (a['Awarding Agency'] || 'Unknown');
      const subAgency = a['Awarding Sub Agency'] || '';
      const amount = parseFloat(a['Award Amount']) || 0;
      const vendor = a['Recipient Name'] || '';
      const desc = a['Description'] || '';
      const pscDesc = a['PSC Description'] || '';
      const endDate = a['End Date'];
      
      if (!map[agency]) {
        map[agency] = { 
          name: agency, 
          totalSpend: 0, 
          count: 0, 
          vendors: {}, 
          subAgencies: {},
          descriptions: [],
          pscDescs: [],
          expiringSoon: []
        };
      }
      
      map[agency].totalSpend += amount;
      map[agency].count++;
      map[agency].vendors[vendor] = (map[agency].vendors[vendor] || 0) + amount;
      if (subAgency) map[agency].subAgencies[subAgency] = (map[agency].subAgencies[subAgency] || 0) + amount;
      if (desc) map[agency].descriptions.push(desc);
      if (pscDesc && !map[agency].pscDescs.includes(pscDesc)) map[agency].pscDescs.push(pscDesc);
      
      // Check if expiring within 18 months
      if (endDate) {
        const end = new Date(endDate);
        const monthsOut = (end - new Date()) / (1000 * 60 * 60 * 24 * 30);
        if (monthsOut > 0 && monthsOut < 18 && amount > 50000) {
          map[agency].expiringSoon.push({ vendor, amount, endDate: end, desc });
        }
      }
    });
    
    return Object.values(map)
      .map(a => {
        const vendorsSorted = Object.entries(a.vendors).sort((x, y) => y[1] - x[1]);
        a.topVendor = vendorsSorted[0] ? { name: vendorsSorted[0][0], spend: vendorsSorted[0][1] } : null;
        a.vendorCount = vendorsSorted.length;
        return a;
      })
      .sort((a, b) => b.totalSpend - a.totalSpend);
  },
  
  analyzeVendors(awards) {
    const map = {};
    const drill = App.drillState || {};
    // When drilled to sub-agency level, track sub-agency instead of top-level agency
    const useSubAgency = drill.level >= 2 && drill.currentSubAgency;
    
    awards.forEach(a => {
      const vendor = a['Recipient Name'] || 'Unknown';
      const agency = useSubAgency 
        ? (a['Awarding Sub Agency'] || a['Awarding Agency'] || '')
        : (a['Awarding Agency'] || '');
      const amount = parseFloat(a['Award Amount']) || 0;
      const desc = a['Description'] || '';
      
      if (!map[vendor]) {
        map[vendor] = { name: vendor, totalSpend: 0, count: 0, agencies: {}, descriptions: [] };
      }
      
      map[vendor].totalSpend += amount;
      map[vendor].count++;
      if (agency) map[vendor].agencies[agency] = (map[vendor].agencies[agency] || 0) + amount;
      if (desc) map[vendor].descriptions.push(desc);
    });
    
    return Object.values(map)
      .map(v => {
        const agenciesSorted = Object.entries(v.agencies).sort((x, y) => y[1] - x[1]);
        v.topAgency = agenciesSorted[0] ? { name: agenciesSorted[0][0], spend: agenciesSorted[0][1] } : null;
        v.agencyCount = agenciesSorted.length;
        return v;
      })
      .sort((a, b) => b.totalSpend - a.totalSpend);
  },
  
  findRecompetes(awards) {
    const now = new Date();
    const eighteenMonths = new Date();
    eighteenMonths.setMonth(now.getMonth() + 18);
    
    return awards
      .filter(a => {
        const end = new Date(a['End Date']);
        return end > now && end < eighteenMonths && (parseFloat(a['Award Amount']) || 0) > 100000;
      })
      .sort((a, b) => new Date(a['End Date']) - new Date(b['End Date']))
      .slice(0, 10);
  },
  
  generateAgencyStarters(agencies, vendors, recompetes, query, drillContext = {}) {
    const starters = [];
    const topAgencies = agencies.slice(0, 5);
    const totalSpend = agencies.reduce((s, a) => s + a.totalSpend, 0);
    
    // Casual openers that reference data without being aggressive
    const casualOpeners = [
      "I've been trying to learn more about",
      "I'm curious about",
      "I was reading up on",
      "Someone mentioned that",
      "I've heard that"
    ];
    
    // If drilled to specific vendor, add vendor-specific agency starters
    if (drillContext.vendor) {
      const vendorName = drillContext.vendor;
      const vendorShort = vendorName.split(' ').slice(0, 2).join(' ');
      topAgencies.forEach(agency => {
        const shortName = agency.name.replace('Department of ', '').replace('Department of the ', '');
        const vendorSpend = agency.vendors[vendorName] || 0;
        
        if (vendorSpend > 0) {
          starters.push({
            type: 'agency',
            target: agency.name,
            icon: 'fa-coffee',
            text: `How's the ${query} world treating ${shortName} these days? I know ${vendorShort} has been pretty active there.`
          });
        }
      });
    }
    
    topAgencies.forEach((agency, idx) => {
      const share = ((agency.totalSpend / totalSpend) * 100).toFixed(0);
      const shortName = agency.name.replace('Department of ', '').replace('Department of the ', '');
      const opener = casualOpeners[idx % casualOpeners.length];
      
      // Genuine curiosity about their work
      if (agency.pscDescs.length > 0) {
        const topPsc = agency.pscDescs[0].toLowerCase();
        starters.push({
          type: 'agency',
          target: agency.name,
          icon: 'fa-comments',
          text: `${opener} ${shortName}'s ${topPsc} initiatives. What's been the most interesting project you've seen come through lately?`
        });
      }
      
      // Relationship-based, not transactional
      if (agency.topVendor && agency.topVendor.spend > 1000000 && agency.topVendor.name !== drillContext.vendor) {
        const topVendorShort = agency.topVendor.name.split(' ').slice(0, 2).join(' ');
        starters.push({
          type: 'agency',
          target: agency.name,
          icon: 'fa-user-friends',
          text: `Do you ever work with the ${topVendorShort} folks? I've seen them around ${shortName} a lot—curious what that world is like from the inside.`
        });
      }
      
      // Future-focused, collaborative tone
      const agencyRecompetes = agency.expiringSoon.slice(0, 1);
      if (agencyRecompetes.length > 0) {
        starters.push({
          type: 'agency',
          target: agency.name,
          icon: 'fa-calendar',
          text: `Sounds like ${shortName} has some ${query} work coming up for bid. Is that something people are already talking about, or still too early?`
        });
      }
      
      // Show genuine interest in their challenges
      if (share > 15) {
        starters.push({
          type: 'agency',
          target: agency.name,
          icon: 'fa-lightbulb',
          text: `${shortName} seems to be doing a lot in the ${query} space. What's driving that—new mission requirements, or modernization stuff?`
        });
      }
    });
    
    // Add some universal icebreakers that use the data context
    if (topAgencies.length > 0) {
      const topAgency = topAgencies[0];
      const shortName = topAgency.name.replace('Department of ', '').replace('Department of the ', '');
      
      starters.push({
        type: 'agency',
        target: 'General',
        icon: 'fa-question-circle',
        text: `I'm still learning the ${query} landscape. Any advice on how smaller companies can actually get in front of ${shortName}?`
      });
      
      starters.push({
        type: 'agency',
        target: 'General',
        icon: 'fa-users',
        text: `Is this your first time at this conference, or are you a regular? I'm trying to figure out which sessions are actually worth attending.`
      });
    }
    
    return starters;
  },
  
  generateVendorStarters(vendors, agencies, query, drillContext = {}) {
    const starters = [];
    const topVendors = vendors.slice(0, 5);
    
    // Varied templates for agency-specific starters
    const agencyTemplates = [
      (shortName, shortAgency, query) => `How's the ${shortAgency} account treating ${shortName} these days? Seems like a busy shop.`,
      (shortName, shortAgency, query) => `${shortName} and ${shortAgency}—that's a solid pairing. How'd you all originally get your foot in the door there?`,
      (shortName, shortAgency, query) => `I've heard ${shortAgency} can be tough to work with. Has that been your experience at ${shortName}, or is it overblown?`,
      (shortName, shortAgency, query) => `What's ${shortAgency} like as a customer? I'm trying to figure out if they're worth pursuing for ${query} work.`,
      (shortName, shortAgency, query) => `Is ${shortAgency} one of those "good revenue, painful delivery" accounts, or do they actually make it easy to do good work?`
    ];
    
    // If drilled to specific agency, add agency-specific vendor starters with variety
    if (drillContext.agency || drillContext.subAgency) {
      const agencyName = drillContext.subAgency || drillContext.agency;
      const shortAgency = agencyName.replace('Department of ', '').replace('Department of the ', '');
      
      topVendors.forEach((vendor, idx) => {
        const shortName = vendor.name.split(' ').slice(0, 2).join(' ');
        const agencySpend = vendor.agencies[agencyName] || 0;
        
        if (agencySpend > 0) {
          const template = agencyTemplates[idx % agencyTemplates.length];
          starters.push({
            type: 'vendor',
            target: vendor.name,
            icon: 'fa-building',
            text: template(shortName, shortAgency, query)
          });
        }
      });
    }
    
    // General vendor starters with more variety
    topVendors.forEach((vendor, idx) => {
      const shortName = vendor.name.split(' ').slice(0, 2).join(' ');
      
      // Genuinely curious, not pushy - vary by vendor position
      if (vendor.agencyCount > 1 && !drillContext.agency) {
        const topAgencyShort = vendor.topAgency?.name?.replace('Department of ', '').replace('Department of the ', '') || 'different agencies';
        
        if (idx === 0) {
          starters.push({
            type: 'vendor',
            target: vendor.name,
            icon: 'fa-map',
            text: `${shortName} seems to be the big dog in ${query} right now. Is ${topAgencyShort} where most of that work is, or is it spread out?`
          });
        } else if (idx === 1) {
          starters.push({
            type: 'vendor',
            target: vendor.name,
            icon: 'fa-compass',
            text: `How does ${shortName} decide which agencies to go after? Is it opportunistic, or do you have a real strategy around ${query}?`
          });
        } else {
          starters.push({
            type: 'vendor',
            target: vendor.name,
            icon: 'fa-map',
            text: `You all work across ${vendor.agencyCount} agencies—that's impressive. How do you keep up with that many different customers?`
          });
        }
      }
      
      // Teaming - different angles based on vendor size/position
      if (vendor.totalSpend > 5000000) {
        if (idx === 0) {
          starters.push({
            type: 'vendor',
            target: vendor.name,
            icon: 'fa-handshake',
            text: `For a company like ${shortName}, do small businesses ever actually add value as subs, or is it mostly a compliance thing?`
          });
        } else if (idx < 3) {
          starters.push({
            type: 'vendor',
            target: vendor.name,
            icon: 'fa-graduation-cap',
            text: `I'm trying to break into ${query}. What would make someone like me actually useful to ${shortName} on a proposal?`
          });
        } else {
          starters.push({
            type: 'vendor',
            target: vendor.name,
            icon: 'fa-door-open',
            text: `What's the best way to get on ${shortName}'s radar for teaming? Cold emails, conferences like this, or something else?`
          });
        }
      }
      
      // Show you did homework without being creepy - vary the angle
      if (vendor.topAgency && vendor.topAgency.name !== drillContext.agency) {
        const agencyShort = vendor.topAgency.name.replace('Department of ', '').replace('Department of the ', '');
        
        if (idx % 3 === 0) {
          starters.push({
            type: 'vendor',
            target: vendor.name,
            icon: 'fa-coffee',
            text: `${agencyShort} seems to love you guys. What's the secret—great past performance, or do you just know the right people?`
          });
        } else if (idx % 3 === 1) {
          starters.push({
            type: 'vendor',
            target: vendor.name,
            icon: 'fa-lightbulb',
            text: `How'd ${shortName} originally land the ${agencyShort} work? Was it a big competitive win, or did it grow from something smaller?`
          });
        } else {
          starters.push({
            type: 'vendor',
            target: vendor.name,
            icon: 'fa-star',
            text: `Is ${agencyShort} a good customer to have? I'm trying to figure out where to focus my energy in the ${query} space.`
          });
        }
      }
      
      // Growth - frame as admiration with variety
      if (vendor.count >= 3) {
        if (idx % 2 === 0) {
          starters.push({
            type: 'vendor',
            target: vendor.name,
            icon: 'fa-chart-line',
            text: `${shortName} has been winning a lot lately. Is it the same BD team, or did you guys hire some secret weapon?`
          });
        } else {
          starters.push({
            type: 'vendor',
            target: vendor.name,
            icon: 'fa-trophy',
            text: `What's driving the ${query} wins for ${shortName}? Better pricing, better tech, or just better relationships?`
          });
        }
      }
    });
    
    // Universal vendor icebreakers - always include a few
    starters.push({
      type: 'vendor',
      target: 'General',
      icon: 'fa-beer',
      text: `Long day on the floor? I'm about ready for whatever's open. Know if there's a good happy hour spot nearby?`
    });
    
    starters.push({
      type: 'vendor',
      target: 'General',
      icon: 'fa-route',
      text: `Been to any good sessions? I feel like I've just been wandering the expo hall all day.`
    });
    
    starters.push({
      type: 'vendor',
      target: 'General',
      icon: 'fa-id-badge',
      text: `First time here—any tips? Like which booths have the best swag, or which panels are actually worth sitting through?`
    });
    
    return starters;
  },
  
  render(starters) {
    const container = document.getElementById('convoResultsArea');
    if (!container) return;
    
    if (starters.length === 0) {
      container.innerHTML = `
        <div class="convo-empty">
          <i class="fas fa-comments"></i>
          <p>No conversation starters could be generated. Try a different search or focus.</p>
        </div>
      `;
      return;
    }
    
    container.innerHTML = starters.map((s, i) => `
      <div class="convo-card" data-index="${i}">
        <div class="convo-card-label">
          <i class="fas ${s.icon}"></i>
          <span>${s.type === 'agency' ? 'Agency' : 'Vendor'}: ${Utils.trunc(s.target, 35)}</span>
        </div>
        <div class="convo-card-text">${s.text}</div>
        <button class="convo-card-copy" onclick="ConvoStarters.copyOne(${i})" title="Copy this talking point">
          <i class="fas fa-copy"></i>
        </button>
      </div>
    `).join('');
  },
  
  copyOne(index) {
    const starter = this.generatedStarters[index];
    if (!starter) return;
    
    navigator.clipboard.writeText(starter.text).then(() => {
      const btn = document.querySelector(`.convo-card[data-index="${index}"] .convo-card-copy`);
      if (btn) {
        btn.classList.add('copied');
        btn.innerHTML = '<i class="fas fa-check"></i>';
        setTimeout(() => {
          btn.classList.remove('copied');
          btn.innerHTML = '<i class="fas fa-copy"></i>';
        }, 1500);
      }
    });
  },
  
  copyAll() {
    if (this.generatedStarters.length === 0) return;
    
    const text = this.generatedStarters.map((s, i) => 
      `[${s.type.toUpperCase()}: ${s.target}]\n${s.text}`
    ).join('\n\n---\n\n');
    
    const header = `CONVERSATION STARTERS: ${App.currentQuery.toUpperCase()}\nGenerated ${new Date().toLocaleDateString()} via Govhoo.com\n${'='.repeat(50)}\n\n`;
    
    navigator.clipboard.writeText(header + text).then(() => {
      const statusEl = document.getElementById('convoDataStatus');
      if (statusEl) {
        statusEl.textContent = 'All talking points copied to clipboard!';
        setTimeout(() => this.updateContext(), 2000);
      }
    });
  },
  
  downloadForPhone() {
    if (this.generatedStarters.length === 0) return;
    
    const text = this.generatedStarters.map((s, i) => 
      `[${s.type.toUpperCase()}: ${s.target}]\n${s.text}`
    ).join('\n\n---\n\n');
    
    const header = `CONVERSATION STARTERS\n${App.currentQuery.toUpperCase()}\n${new Date().toLocaleDateString()}\nvia Govhoo.com\n${'='.repeat(30)}\n\n`;
    
    const blob = new Blob([header + text], { type: 'text/plain;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `TalkingPoints_${App.currentQuery.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().split('T')[0]}.txt`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    const statusEl = document.getElementById('convoDataStatus');
    if (statusEl) {
      statusEl.textContent = 'Downloaded! Send to your phone or print for the event.';
    }
  }
};

App.init();
</script>
</body>
</html>