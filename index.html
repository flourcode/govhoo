<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#000000">
  <title>Govhoo - An easy way to visualize USASpending data</title>
  
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-sankey/0.12.3/d3-sankey.min.js"></script>
  
<style>
:root {
  --bg-app: #000000;
  --bg-card: #121212; 
  --bg-input: #1a1a1a;
  --border: #333333;
  --text-primary: #e6e6e6;
  --text-muted: #888888;
  
  /* Vintage/Elegant Terminal Theme */
  --accent: #D4C4A8; /* Muted Parchment Gold */
  --accent-dim: rgba(212, 196, 168, 0.1);
  --link: #8DA0CB;   /* Soft Blue for links */
  --success: #66C2A5; /* Muted Teal */
  
  --safe-top: env(safe-area-inset-top, 20px);
  --safe-bottom: env(safe-area-inset-bottom, 20px);
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

body {
  margin: 0;
  padding: 0;
  font-family: 'Inter', sans-serif;
  background: var(--bg-app);
  color: var(--text-primary);
  min-height: 100vh;
  overflow-x: hidden;
}

/* --- Hero Section (Search) --- */
.hero-view {
  position: fixed;
  inset: 0;
  z-index: 200; 
  background: radial-gradient(circle at 50% 30%, #1a1a1a 0%, #000 70%);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 2rem;
  transition: transform 0.5s cubic-bezier(0.16, 1, 0.3, 1);
  
  /* FIX: Ensure content doesn't bleed out if taller than screen */
  overflow-y: auto; 
}

.hero-view.slide-up {
  transform: translateY(-100%);
}

.terminal-logo {
  font-family: 'JetBrains Mono', monospace;
  font-size: 2.5rem;
  font-weight: 700;
  margin-bottom: 0.5rem;
  color: var(--text-primary);
  letter-spacing: -1px;
  text-align: center;
}
.terminal-logo span { color: var(--accent); }

.search-box-container {
  position: relative;
  z-index: 210; 
  width: 100%;
  max-width: 500px;
  margin-top: 2rem;
}

.main-input {
  width: 100%;
  background: var(--bg-input);
  border: 1px solid var(--border);
  padding: 1.25rem 1rem;
  font-size: 1.1rem;
  color: white;
  border-radius: 4px;
  font-family: 'Inter', sans-serif;
  transition: border-color 0.2s;
  -webkit-appearance: none;
}

.main-input:focus {
  outline: none;
  border-color: var(--accent);
  background: #222;
}

.btn-primary {
  width: 100%;
  margin-top: 1rem;
  padding: 1rem;
  background: var(--accent);
  color: #000;
  font-weight: 700;
  border: none;
  border-radius: 4px;
  font-size: 1rem;
  cursor: pointer;
  text-transform: uppercase;
  letter-spacing: 1px;
}
.btn-primary:hover { opacity: 0.9; }

/* --- Search Tips --- */
.search-tips {
  margin-top: 1.5rem;
  width: 100%;
  max-width: 500px;
  background: rgba(255, 255, 255, 0.03);
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 1rem;
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.75rem;
  color: var(--text-muted);
  text-align: left;
  
  /* FIX: Ensure it doesn't get cut off on small screens */
  margin-bottom: 2rem; 
}

.tip-header {
  color: var(--accent);
  font-weight: 700;
  margin-bottom: 0.75rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.tip-row {
  display: flex;
  align-items: flex-start;
  gap: 0.75rem;
  margin-bottom: 0.6rem;
  line-height: 1.4;
}

.cmd-hl {
  color: var(--text-primary);
  background: rgba(255, 255, 255, 0.1);
  padding: 2px 6px;
  border-radius: 2px;
  white-space: nowrap;
}

/* --- App Layout --- */
.app-header {
  position: sticky;
  top: 0;
  z-index: 100;
  background: rgba(0,0,0,0.95); /* Slightly darker for better contrast */
  backdrop-filter: blur(10px);
  
  padding: 0.75rem 1rem;
  /* FIX: Add safe area padding for iPhone notch */
  padding-top: max(0.75rem, var(--safe-top));
  
  border-bottom: 1px solid var(--border);
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 1rem;
}

.header-left {
  display: flex;
  align-items: center;
  gap: 1rem;
  flex: 1; /* Allow left side to take available space */
  min-width: 0; /* Crucial for nested flex truncation */
}

.logo-btn {
  font-family: 'JetBrains Mono';
  font-weight: 700;
  color: white;
  cursor: pointer;
  transition: opacity 0.2s;
  
  /* FIX: Prevent Logo from shrinking/disappearing on mobile */
  flex-shrink: 0;
  white-space: nowrap;
}
.logo-btn:hover { color: var(--accent); }

.mini-search {
  background: var(--bg-input);
  border: 1px solid var(--border);
  color: white;
  padding: 0.5rem 1rem;
  border-radius: 4px;
  font-size: 0.9rem;
  
  /* FIX: Don't force 100% width. Use flex to fill REMAINING space */
  width: auto;
  flex: 1;
  min-width: 0; /* Allows shrinking if needed */
}
.mini-search:focus { outline: none; border-color: var(--accent); }

.header-actions { display: flex; gap: 0.5rem; flex-shrink: 0; }

.icon-btn {
  background: var(--bg-input);
  border: 1px solid var(--border);
  color: var(--text-muted);
  width: 36px;
  height: 36px;
  border-radius: 4px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s;
}
.icon-btn:hover {
  border-color: var(--accent);
  color: var(--accent);
}

/* --- Dashboard Content --- */
.dashboard-container {
  padding: 1rem;
  padding-bottom: calc(2rem + var(--safe-bottom));
  max-width: 1400px; 
  margin: 0 auto;
  opacity: 0;
  animation: fadeIn 0.8s forwards;
}

@keyframes fadeIn { to { opacity: 1; } }

/* Section Headers */
.section-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 0.5rem;
  margin: 2rem 0 1rem 0;
  border-bottom: 1px solid var(--border);
  padding-bottom: 0.5rem;
  flex-wrap: wrap;
}
.section-title-group {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}
.section-title {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.9rem;
  font-weight: 700;
  color: var(--accent);
  text-transform: uppercase;
  letter-spacing: 1px;
}

.header-controls {
  display: flex;
  gap: 0.75rem;
  align-items: center;
}

.time-badge {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.7rem;
  color: var(--text-muted);
  border: 1px solid var(--border);
  padding: 4px 8px;
  border-radius: 4px;
}

.filter-badge {
  display: none;
  background: var(--accent-dim);
  color: var(--accent);
  border: 1px solid var(--accent);
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 0.7rem;
  font-family: 'JetBrains Mono', monospace;
  cursor: pointer;
  align-items: center;
  gap: 6px;
}
.filter-badge:hover { background: rgba(212, 196, 168, 0.2); }

/* Stats Bar */
.stats-row {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 1rem;
  margin-bottom: 2rem;
}
.stat-item {
  background: var(--bg-card);
  padding: 1rem;
  border-radius: 4px;
  border: 1px solid var(--border);
  text-align: center;
}
.stat-label { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.5rem; }
.stat-val { font-size: 1.25rem; font-weight: 700; font-family: 'JetBrains Mono', monospace; color: white; }

/* Sankey Container */
.chart-wrapper {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 1rem;
  width: 100%;
  overflow: hidden;
}
.chart-container {
  width: 100%; 
  height: 500px;
  display: flex;
  justify-content: center;
}

/* Contract Feed (List) */
.feed-grid {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.deal-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 1.25rem;
  transition: transform 0.1s;
}
.deal-card:active { transform: scale(0.99); }

.deal-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 0.75rem;
}
.deal-agency { 
  font-size: 0.75rem; 
  color: var(--text-muted); 
  font-weight: 600; 
  text-transform: uppercase;
  background: rgba(255,255,255,0.05);
  padding: 2px 6px;
  border-radius: 4px;
}
.deal-amount { font-family: 'JetBrains Mono', monospace; color: var(--accent); font-weight: 700; font-size: 1rem; }

.deal-desc { font-size: 1rem; font-weight: 600; margin-bottom: 0.5rem; line-height: 1.4; color: white; }
.deal-vendor { font-size: 0.85rem; color: #8DA0CB; margin-bottom: 0.75rem; font-family: 'JetBrains Mono', monospace; }

/* NEW: Meta tags row */
.deal-meta {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  margin-bottom: 1rem;
}

.meta-tag {
  font-size: 0.65rem;
  font-family: 'JetBrains Mono', monospace;
  padding: 3px 8px;
  border-radius: 3px;
  background: rgba(255,255,255,0.05);
  color: var(--text-muted);
  border: 1px solid var(--border);
}

.meta-tag.naics {
  background: rgba(102, 194, 165, 0.15);
  border-color: rgba(102, 194, 165, 0.3);
  color: #66C2A5;
}

.meta-tag.psc {
  background: rgba(141, 160, 203, 0.15);
  border-color: rgba(141, 160, 203, 0.3);
  color: #8DA0CB;
}

.deal-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding-top: 1rem;
  border-top: 1px solid #222;
}

.deal-date { font-size: 0.75rem; color: var(--text-muted); }

.action-btn {
  background: var(--bg-input);
  color: var(--accent);
  text-decoration: none;
  padding: 0.5rem 1rem;
  border-radius: 4px;
  font-size: 0.8rem;
  font-weight: 600;
  border: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 6px;
  transition: all 0.2s;
}
.action-btn:hover { border-color: var(--accent); background: var(--accent-dim); }

/* Loading Overlay */
.loader {
  position: fixed; inset: 0; z-index: 300;
  background: rgba(0,0,0,0.9);
  display: none; flex-direction: column; align-items: center; justify-content: center;
}
.spinner {
  width: 40px; height: 40px; border: 2px solid #333; border-top-color: var(--accent);
  border-radius: 50%; animation: spin 0.8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* Mobile Adjustments */
@media (max-width: 600px) {
  .stats-row { grid-template-columns: 1fr; gap: 0.5rem; }
  .stat-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 1rem; }
  .stat-label { margin-bottom: 0; }
  .chart-container { height: 400px; }
  .chart-wrapper { overflow-x: auto; }
  .chart-container { min-width: 600px; }
  .header-actions { gap: 0.25rem; }
  .search-tips { font-size: 0.7rem; }
  .deal-meta { gap: 0.35rem; }
  .meta-tag { font-size: 0.6rem; padding: 2px 6px; }
}
</style>
</head>
<body>

<div id="heroView" class="hero-view">
  <div class="terminal-logo"><span>>_</span> Govhoo</div>
  <p style="color:var(--text-muted); margin-bottom: 2rem; text-align:center;">An easy way to visualize USASpending data.</p>
  
  <div class="search-box-container">
    <input type="text" id="mainSearchInput" class="main-input" placeholder="Search Keywords, Company, or Agency" autocomplete="off">
    <button id="searchBtn" class="btn-primary">SEARCH</button>
  </div>

  <div class="search-tips">
    <div class="tip-header"><i class="fas fa-terminal"></i> SEARCH_TIPS</div>
    
    <div class="tip-row">
      <span class="cmd-hl">cloud computing</span>
      <span>Searches award descriptions, vendors, and agencies.</span>
    </div>
    
    <div class="tip-row">
      <span class="cmd-hl">Amazon</span>
      <span>Find awards by company name and associated VARs.</span>
    </div>
    
    <div class="tip-row">
      <span class="cmd-hl">DA10</span>
      <span>PSC code (searches descriptions, not PSC field).</span>
    </div>

	<div class="tip-row">
      <span class="cmd-hl">API Limits</span>
      <span>Max 100 results sorted by top dollar value (last 12 mo).</span>
    </div>
    <div class="tip-row">
      <span class="cmd-hl">Fuzzy Search</span>
      <span>Quotes are ignored. "Pizza" returns pizza contracts AND Pizzaro's Construction. ¯\_(ツ)_/¯</span>
    </div>
 
	<div class="tip-row">
      <span class="cmd-hl">Questions?</span>
      <span>DM me on <a href="https://www.linkedin.com/in/markflournoy/" target="_blank" style="color: var(--accent); text-decoration: underline;">LinkedIn</a></span>
    </div>
	<div class="tip-row">
      <span class="cmd-hl" style="opacity:0.7">Source</span>
      <span style="opacity:0.7">Data sourced from USASpending.gov</span>
    </div>
</div>

</div>

<div id="appView" style="display:none;">
  <header class="app-header">
    <div class="header-left">
      <div class="logo-btn" onclick="App.showHero()">Govhoo</div>
      <input type="text" id="miniSearch" class="mini-search" placeholder="New Search...">
    </div>
    
    <div class="header-actions">
      <button class="icon-btn" onclick="App.exportCSV()" title="Export CSV">
        <i class="fas fa-download"></i>
      </button>
      <button class="icon-btn" onclick="App.shareLink()" title="Copy Share Link">
        <i class="fas fa-share-alt"></i>
      </button>
    </div>
  </header>

  <div class="dashboard-container">
    
    <div class="stats-row">
      <div class="stat-item">
        <div class="stat-label">Total $ Awards (Past 12 Months)</div>
        <div class="stat-val" id="stat-vol">-</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">Contract Count (Past 12 Months)</div>
        <div class="stat-val" id="stat-count">-</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">Prime Vendors</div>
        <div class="stat-val" id="stat-vendors">-</div>
      </div>
    </div>

    <div class="section-header">
      <div class="section-title-group">
        <i class="fas fa-project-diagram" style="color:var(--accent)"></i>
        <span class="section-title">Capital Flow Analysis</span>
      </div>
      
      <div class="header-controls">
        <div id="filterBadge" class="filter-badge" onclick="App.clearFilter()">
          <span id="filterName">FILTER</span> <i class="fas fa-times"></i>
        </div>
        
        <div class="time-badge">PAST 12 MONTHS</div>
      </div>
    </div>
    
    <div class="chart-wrapper">
      <div id="chartContainer" class="chart-container"></div>
    </div>
    <p style="text-align:center; font-size:0.75rem; color:#666; margin-top:0.5rem;">
      <i class="fas fa-mouse-pointer"></i> Click bars to drill down | <i class="fas fa-arrows-alt-h"></i> Chart auto-sizes to window
    </p>

    <div class="section-header">
      <div class="section-title-group">
        <i class="fas fa-list-ul" style="color:var(--accent)"></i>
        <span class="section-title">Contract Opportunity Feed</span>
      </div>
    </div>
    
    <div id="feedGrid" class="feed-grid"></div>

  </div>
</div>

<div id="loader" class="loader">
  <div class="spinner"></div>
  <p style="margin-top:1rem; font-family:'JetBrains Mono'; color:var(--accent);">RETRIEVING DATA...</p>
</div>

<script>
const API_BASE = 'https://api.usaspending.gov/api/v2';

// --- VINTAGE PALETTE ---
const vintagePalette = [
  '#958BB6', // Muted Lavender
  '#6F8A74', // Sage Green
  '#C27E5C', // Terracotta/Rust
  '#8FB6D0', // Dusty Blue
  '#B0C4DE', // Pale Slate
  '#D9B48F'  // Sand/Beige
];

// --- UTILS ---
const Utils = {
  money: n => {
    if(n >= 1e9) return '$' + (n/1e9).toFixed(1) + 'B';
    if(n >= 1e6) return '$' + (n/1e6).toFixed(1) + 'M';
    if(n >= 1e3) return '$' + (n/1e3).toFixed(0) + 'K';
    return '$' + Math.round(n).toLocaleString();
  },
  trunc: (s, l) => (s && s.length > l) ? s.substring(0,l)+'...' : (s || 'No Description'),
  date: (s) => s ? new Date(s).toLocaleDateString() : '—',
  formatDateISO: (date) => {
    return date.toISOString().split('T')[0];
  },
  getColor: (name) => {
    let hash = 0;
    for (let i = 0; i < name.length; i++) {
      hash = name.charCodeAt(i) + ((hash << 5) - hash);
    }
    return vintagePalette[Math.abs(hash) % vintagePalette.length];
  }
};

// --- APP LOGIC ---
const App = {
  rawData: [],   
  activeData: [], 
  activeFilter: null,
  currentQuery: '',

  init: () => {
    document.getElementById('searchBtn').onclick = () => App.search();
    
    document.getElementById('mainSearchInput').addEventListener('keypress', (e) => {
      if(e.key === 'Enter') App.search();
    });
    
    document.getElementById('miniSearch').addEventListener('keypress', (e) => {
      if(e.key === 'Enter') App.search(e.target.value);
    });

    let resizeTimer;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(() => {
        if(App.activeData.length > 0) App.renderSankey();
      }, 200);
    });

    const params = new URLSearchParams(window.location.search);
    const q = params.get('q');
    if (q) {
      document.getElementById('mainSearchInput').value = q;
      App.search(q);
    }
  },

  showHero: () => {
    const hero = document.getElementById('heroView');
    document.getElementById('appView').style.display = 'none';
    
    // Reset hero display property so it can be seen again
    hero.style.display = 'flex';
    // Small timeout to allow the display change to register before removing the slide class
    setTimeout(() => {
      hero.classList.remove('slide-up');
    }, 10);
    
    const url = new URL(window.location);
    url.searchParams.delete('q');
    window.history.replaceState({}, '', url);
  },

  search: async (val) => {
    const query = val || document.getElementById('mainSearchInput').value;
    if(!query) return;

    App.currentQuery = query;
    document.getElementById('loader').style.display = 'flex';
    
    try {
      const today = new Date();
      const oneYearAgo = new Date();
      oneYearAgo.setFullYear(today.getFullYear() - 1);

      const period = {
        start_date: Utils.formatDateISO(oneYearAgo),
        end_date: Utils.formatDateISO(today)
      };

      const res = await fetch(`${API_BASE}/search/spending_by_award/`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          filters: { 
            keywords: [query], 
            time_period: [period],
            award_type_codes: ['A','B','C','D']
          },
          fields: [
            'Award ID', 
            'Recipient Name', 
            'Awarding Agency',
            'Awarding Sub Agency',
            'Award Amount', 
            'Description', 
            'generated_internal_id',
            'Start Date',
            'End Date',
            'NAICS Code',
            'NAICS Description',
            'PSC Code',
            'PSC Description'
          ],
          limit: 100,
          page: 1,
          sort: 'Award Amount',
          order: 'desc'
        })
      });

      const json = await res.json();
      App.rawData = json.results || [];
      
      App.activeFilter = null;
      App.activeData = App.rawData;

      const url = new URL(window.location);
      url.searchParams.set('q', query);
      window.history.replaceState({}, '', url);

      App.updateDashboard();

      // UI Transition
      const hero = document.getElementById('heroView');
      hero.classList.add('slide-up');
      
      document.getElementById('appView').style.display = 'block';
      document.getElementById('miniSearch').value = query;

      // FIX: Wait for animation (500ms) then hide Hero completely so no ghost text remains
      setTimeout(() => {
        hero.style.display = 'none';
      }, 500);

      // Re-render Sankey after layout settles
      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          App.renderSankey();
        });
      });

    } catch(e) {
      alert("System Error: Could not retrieve federal data.");
      console.error(e);
    } finally {
      document.getElementById('loader').style.display = 'none';
    }
  },

  drillDown: (name) => {
    if (App.activeFilter === name) {
      App.clearFilter();
      return;
    }

    App.activeFilter = name;
    App.activeData = App.rawData.filter(d => 
      d['Awarding Agency'] === name || d['Recipient Name'] === name
    );
    App.updateDashboard();
  },

  clearFilter: () => {
    App.activeFilter = null;
    App.activeData = App.rawData;
    App.updateDashboard();
  },

  exportCSV: () => {
    if (!App.activeData.length) return alert("No data to export");
    
    const headers = ['Recipient', 'Agency', 'Sub Agency', 'Amount', 'Description', 'NAICS Code', 'NAICS Description', 'PSC Code', 'PSC Description', 'Start Date', 'End Date', 'Award ID'];
    const rows = App.activeData.map(c => [
      `"${(c['Recipient Name'] || '').replace(/"/g, '""')}"`,
      `"${(c['Awarding Agency'] || '').replace(/"/g, '""')}"`,
      `"${(c['Awarding Sub Agency'] || '').replace(/"/g, '""')}"`,
      c['Award Amount'] || 0,
      `"${(c['Description'] || '').replace(/"/g, '""')}"`,
      c['NAICS Code'] || '',
      `"${(c['NAICS Description'] || '').replace(/"/g, '""')}"`,
      c['PSC Code'] || '',
      `"${(c['PSC Description'] || '').replace(/"/g, '""')}"`,
      c['Start Date'] || '',
      c['End Date'] || '',
      c['Award ID'] || ''
    ]);
    
    const csvContent = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.setAttribute("href", url);
    link.setAttribute("download", `govhoo_export_${App.currentQuery}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  },

  shareLink: () => {
    const url = window.location.href;
    navigator.clipboard.writeText(url).then(() => {
      const btn = document.querySelector('.icon-btn[title="Copy Share Link"]');
      const originalHTML = btn.innerHTML;
      btn.innerHTML = '<i class="fas fa-check" style="color:var(--accent)"></i>';
      setTimeout(() => btn.innerHTML = originalHTML, 2000);
    });
  },

  updateDashboard: () => {
    const badge = document.getElementById('filterBadge');
    if (App.activeFilter) {
      badge.style.display = 'inline-flex';
      document.getElementById('filterName').innerText = App.activeFilter;
    } else {
      badge.style.display = 'none';
    }

    App.renderStats();
    App.renderSankey();
    App.renderFeed();
  },

  renderStats: () => {
    const total = App.activeData.reduce((acc, c) => acc + (c['Award Amount']||0), 0);
    const vendors = new Set(App.activeData.map(c => c['Recipient Name'])).size;
    
    document.getElementById('stat-vol').innerText = Utils.money(total);
    document.getElementById('stat-count').innerText = App.activeData.length;
    document.getElementById('stat-vendors').innerText = vendors;
  },

  renderSankey: () => {
    const container = document.getElementById('chartContainer');
    container.innerHTML = '<svg id="sankeySvg"></svg>';
    
    if(App.activeData.length === 0) return;

    const flowMap = {};
    App.activeData.forEach(d => {
      if(d['Award Amount'] > 0) {
        const src = d['Awarding Agency'] || 'Unknown Agency';
        const tgt = d['Recipient Name'] || 'Unknown Vendor';
        const k = src + "|||" + tgt;
        flowMap[k] = (flowMap[k] || 0) + d['Award Amount'];
      }
    });

    let nodesSet = new Set();
    let links = [];
    const limit = App.activeFilter ? 100 : 25; 
    const sortedFlows = Object.entries(flowMap).sort((a,b) => b[1] - a[1]).slice(0, limit);

    sortedFlows.forEach(([k, val]) => {
      const [src, tgt] = k.split("|||");
      nodesSet.add(src);
      nodesSet.add(tgt);
      links.push({source: src, target: tgt, value: val});
    });

    const nodes = Array.from(nodesSet).map(n => ({name: n}));
    const nodeMap = new Map(nodes.map((n, i) => [n.name, i]));
    
    const d3Links = links.map(l => ({
      source: nodeMap.get(l.source),
      target: nodeMap.get(l.target),
      value: l.value
    }));

    const width = container.offsetWidth || 800; 
    const height = 500;

    const svg = d3.select("#sankeySvg")
      .attr("width", width)
      .attr("height", height);

    const sankey = d3.sankey()
      .nodeId(d => d.index)
      .nodeWidth(20)
      .nodePadding(15)
      .extent([[1, 1], [width - 1, height - 6]]);

    const {nodes: graphNodes, links: graphLinks} = sankey({
      nodes: nodes.map(d => Object.assign({}, d)),
      links: d3Links.map(d => Object.assign({}, d))
    });

    svg.append("g")
      .selectAll("rect")
      .data(graphNodes)
      .join("rect")
      .attr("x", d => d.x0)
      .attr("y", d => d.y0)
      .attr("height", d => d.y1 - d.y0)
      .attr("width", d => d.x1 - d.x0)
      .attr("fill", d => Utils.getColor(d.name))
      .attr("opacity", d => (App.activeFilter && d.name !== App.activeFilter) ? 0.3 : 0.9)
      .attr("rx", 2)
      .style("cursor", "pointer")
      .on("click", (e, d) => App.drillDown(d.name))
      .append("title")
      .text(d => `${d.name}\n${Utils.money(d.value)}`);

    svg.append("g")
      .selectAll("text")
      .data(graphNodes)
      .join("text")
      .attr("x", d => d.x0 < width / 2 ? d.x1 + 6 : d.x0 - 6)
      .attr("y", d => (d.y1 + d.y0) / 2)
      .attr("dy", "0.35em")
      .attr("text-anchor", d => d.x0 < width / 2 ? "start" : "end")
      .text(d => Utils.trunc(d.name, width > 600 ? 30 : 15))
      .attr("fill", "#fff")
      .style("font-size", "11px")
      .style("font-family", "Inter")
      .style("font-weight", "500")
      .style("cursor", "pointer")
      .style("text-shadow", "0 1px 2px black")
      .on("click", (e, d) => App.drillDown(d.name));

    const defs = svg.append("defs");
    graphLinks.forEach((l, i) => {
      const gradient = defs.append("linearGradient")
        .attr("id", "grad" + i)
        .attr("gradientUnits", "userSpaceOnUse")
        .attr("x1", l.source.x1).attr("x2", l.target.x0);
      gradient.append("stop").attr("offset", "0%").attr("stop-color", Utils.getColor(l.source.name));
      gradient.append("stop").attr("offset", "100%").attr("stop-color", Utils.getColor(l.target.name));
    });

    svg.append("g")
      .attr("fill", "none")
      .selectAll("path")
      .data(graphLinks)
      .join("path")
      .attr("d", d3.sankeyLinkHorizontal())
      .attr("stroke", (d, i) => "url(#grad" + i + ")")
      .attr("stroke-width", d => Math.max(1, d.width))
      .attr("stroke-opacity", 0.5)
      .style("mix-blend-mode", "screen")
      .style("transition", "stroke-opacity 0.2s")
      .on("mouseover", function() { d3.select(this).attr("stroke-opacity", 0.8); })
      .on("mouseout", function() { d3.select(this).attr("stroke-opacity", 0.5); });
  },

  renderFeed: () => {
    const div = document.getElementById('feedGrid');
    
    if(App.activeData.length === 0) {
      div.innerHTML = '<div style="text-align:center; padding:2rem; color:#666">No contracts found for current filter.</div>';
      return;
    }

    div.innerHTML = App.activeData.map(c => {
      const internalId = c['generated_internal_id'];
      let url = '#';
      
      if (internalId) {
        url = `https://www.usaspending.gov/award/${internalId}`;
      } else if (c['Award ID']) {
        url = `https://www.usaspending.gov/search/?hash=&filters=${encodeURIComponent(JSON.stringify({keyword: c['Award ID']}))}`;
      }

      // Build meta tags
      let metaTags = '';
      
      if (c['NAICS Code']) {
        metaTags += `<span class="meta-tag naics" title="${c['NAICS Description'] || ''}">NAICS: ${c['NAICS Code']}</span>`;
      }
      
      if (c['PSC Code']) {
        metaTags += `<span class="meta-tag psc" title="${c['PSC Description'] || ''}">PSC: ${c['PSC Code']}</span>`;
      }
      
      if (c['Awarding Sub Agency'] && c['Awarding Sub Agency'] !== c['Awarding Agency']) {
        metaTags += `<span class="meta-tag">${Utils.trunc(c['Awarding Sub Agency'], 25)}</span>`;
      }

      return `
        <div class="deal-card">
          <div class="deal-header">
            <span class="deal-agency">${Utils.trunc(c['Awarding Agency'], 35)}</span>
            <span class="deal-amount">${Utils.money(c['Award Amount'])}</span>
          </div>
          
          <div class="deal-desc">${Utils.trunc(c['Description'], 100)}</div>
          <div class="deal-vendor">${c['Recipient Name']}</div>
          
          ${metaTags ? `<div class="deal-meta">${metaTags}</div>` : ''}
          
          <div class="deal-footer">
            <span class="deal-date">Start: ${Utils.date(c['Start Date'])}${c['End Date'] ? ' → ' + Utils.date(c['End Date']) : ''}</span>
            <a href="${url}" target="_blank" class="action-btn">
              OPEN AWARD <i class="fas fa-external-link-alt"></i>
            </a>
          </div>
        </div>
      `;
    }).join('');
  }
};

App.init();
</script>
</body>
</html>