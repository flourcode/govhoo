<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#000000">
  
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 rx=%2220%22 fill=%22%23000000%22/><text y=%2250%%22 x=%2250%%22 font-size=%2285%22 font-family=%22'JetBrains Mono', monospace%22 font-weight=%22700%22 fill=%22%23D4C4A8%22 text-anchor=%22middle%22 dominant-baseline=%22central%22>G</text></svg>">

  <title>Govhoo - Federal Contract Intelligence & Sales Planning</title>
  <meta name="title" content="Govhoo - Federal Contract Intelligence & Sales Planning">
  <meta name="description" content="Free Federal Sales Intelligence & FY2026 Strategic Planning. Follow the money with live USASpending data analysis.">

  <meta property="og:type" content="website">
  <meta property="og:url" content="https://govhoo.com/">
  <meta property="og:title" content="Govhoo | Follow the Money">
  <meta property="og:description" content="Analyze federal agency award flow and generate AI-ready sales plans.">
  <meta property="og:image" content="https://govhoo.com/social.png"> <meta property="twitter:card" content="summary_large_image">
  <meta property="twitter:title" content="Govhoo | Federal Contract Intelligence">
  <meta property="twitter:description" content="Build your federal sales plan with live obligation data and trend forecasting.">

  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-sankey/0.12.3/d3-sankey.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-T343V4RFHV"></script>
  <script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-T343V4RFHV');
</script>
<style>
:root {
  --bg-app: #000000;
  --bg-card: #121212; 
  --bg-input: #1a1a1a;
  --border: #333333;
  --text-primary: #e6e6e6;
  --text-muted: #888888;
  --accent: #999999;
  --accent-dim: rgba(153, 153, 153, 0.1);
  --link: #8DA0CB;
  --success: #5fa052;
  --danger: #FB8072;
  --q1-color: #958BB6; --q2-color: #6F8A74; --q3-color: #8FB6D0; --q4-color: #C27E5C;
  --safe-top: env(safe-area-inset-top, 20px);
  --safe-bottom: env(safe-area-inset-bottom, 20px);
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

body {
  margin: 0; padding: 0;
  font-family: 'Inter', sans-serif;
  background: var(--bg-app);
  color: var(--text-primary);
  min-height: 100vh;
  overflow-x: hidden;
  width: 100%;
}

.hero-view {
  position: fixed; inset: 0; z-index: 200; 
  display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
  padding: 2rem; padding-top: max(8vh, var(--safe-top)); 
  transition: transform 0.5s cubic-bezier(0.16, 1, 0.3, 1);
  overflow-y: auto; 
}
.hero-view.slide-up { transform: translateY(-100%); }
.hero-view.hidden { display: none; }

.terminal-logo {
  font-family: 'JetBrains Mono', monospace; font-size: 2.5rem; font-weight: 700;
  margin-bottom: 0.5rem; color: var(--text-primary); letter-spacing: -1px; text-align: center;
}
.terminal-logo span { color: var(--accent); }

.hero-subtitle {
  margin-bottom: 2rem; text-align: center;
  font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; color: var(--text-muted);
}

.search-box-container { 
  position: relative; z-index: 210; 
  width: 100%; max-width: 500px; margin-top: 1.5rem; 
}

.main-input {
  width: 100%; background: var(--bg-input); border: 1px solid var(--border);
  padding: 1.25rem 1rem; font-size: 1.1rem; color: white; border-radius: 4px;
  font-family: 'Inter', sans-serif; transition: border-color 0.2s; -webkit-appearance: none;
}
.main-input:focus { outline: none; border-color: var(--accent); background: #222; }

.btn-row { display: flex; gap: 0.75rem; margin-top: 1rem; }
.btn-primary, .btn-secondary {
  flex: 1; padding: 1rem;
  font-weight: 700; border: none; border-radius: 4px;
  font-size: 0.9rem; cursor: pointer; text-transform: uppercase; letter-spacing: 1px;
  display: flex; align-items: center; justify-content: center; gap: 0.5rem;
}
.btn-primary { background: var(--accent); color: #000; }
.btn-secondary { background: transparent; color: var(--accent); border: 1px solid var(--accent); }
.btn-primary:hover, .btn-secondary:hover { opacity: 0.9; }

.autocomplete-wrapper { position: relative; }
.autocomplete-dropdown {
  position: absolute; top: 100%; left: 0; right: 0; z-index: 220;
  background: var(--bg-card); border: 1px solid var(--border); border-top: none;
  border-radius: 0 0 4px 4px; max-height: 320px; overflow-y: auto;
  display: none;
}
.autocomplete-dropdown.active { display: block; }
.autocomplete-section { padding: 0.5rem 0; border-bottom: 1px solid var(--border); }
.autocomplete-section:last-child { border-bottom: none; }
.autocomplete-section-label {
  padding: 0.25rem 1rem; font-size: 0.65rem; color: var(--text-muted);
  text-transform: uppercase; letter-spacing: 1px; font-family: 'JetBrains Mono', monospace;
}
.autocomplete-item {
  padding: 0.6rem 1rem; cursor: pointer; display: flex; align-items: center; gap: 0.75rem;
  font-size: 0.9rem; color: var(--text-primary); transition: background 0.1s;
}
.autocomplete-item:hover, .autocomplete-item.selected { background: rgba(255,255,255,0.05); }
.autocomplete-item i { color: var(--text-muted); width: 16px; text-align: center; font-size: 0.8rem; }
.autocomplete-item-text { flex: 1; min-width: 0; }
.autocomplete-item-main { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.autocomplete-item-sub { font-size: 0.7rem; color: var(--text-muted); margin-top: 2px; }
.autocomplete-empty { padding: 1rem; text-align: center; color: var(--text-muted); font-size: 0.85rem; }

.app-header {
  position: sticky; top: 0; z-index: 100;
  background: rgba(0,0,0,0.95); backdrop-filter: blur(10px);
  padding: 0.75rem 1rem; padding-top: max(0.75rem, var(--safe-top));
  border-bottom: 1px solid var(--border);
  display: flex; justify-content: space-between; align-items: center; gap: 1rem;
}
.header-left { display: flex; align-items: center; gap: 1rem; flex: 1; min-width: 0; }
.logo-btn { font-family: 'JetBrains Mono'; font-weight: 700; color: white; cursor: pointer; flex-shrink: 0; }
.logo-btn:hover { color: var(--accent); }

.mini-search {
  background: var(--bg-input); border: 1px solid var(--border);
  color: white; padding: 0.5rem 1rem; border-radius: 4px;
  font-size: 0.9rem; flex: 1; min-width: 0;
}
.mini-search:focus { outline: none; border-color: var(--accent); }

.header-actions { display: flex; gap: 0.5rem; flex-shrink: 0; }
.icon-btn {
  background: var(--bg-input); border: 1px solid var(--border); color: var(--text-muted);
  width: 36px; height: 36px; border-radius: 4px;
  display: flex; align-items: center; justify-content: center; cursor: pointer;
}
.icon-btn:hover { border-color: var(--accent); color: var(--accent); }
.icon-btn.active { background: var(--accent-dim); color: var(--accent); border-color: var(--accent); }

.dashboard-container {
  padding: 1rem; padding-bottom: calc(2rem + var(--safe-bottom));
  max-width: 1400px; margin: 0 auto;
  display: none;
  width: 100%;
}
.dashboard-container.active { display: block; animation: fadeIn 0.8s forwards; }
@keyframes fadeIn { to { opacity: 1; } }

.mode-toggle {
  display: flex; gap: 0.5rem; margin-bottom: 1.5rem;
  background: var(--bg-card); padding: 0.5rem; border-radius: 4px; border: 1px solid var(--border);
}
.mode-btn {
  flex: 1; padding: 0.75rem; background: transparent; border: none;
  color: var(--text-muted); font-family: 'JetBrains Mono'; font-size: 0.85rem;
  cursor: pointer; border-radius: 4px; transition: all 0.2s;
  display: flex; align-items: center; justify-content: center; gap: 0.5rem;
}
.mode-btn.active { 
  background: var(--accent); 
  color: #000; 
  font-weight: 700; 
}
.mode-btn:hover:not(.active) { 
  color: var(--text-primary); 
}

.stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem; }
.stat-item {
  background: var(--bg-card); padding: 1rem; border-radius: 4px;
  border: 1px solid var(--border); text-align: center;
}
.stat-label { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.5rem; }
.stat-val { font-size: 1.25rem; font-weight: 700; font-family: 'JetBrains Mono'; color: white; }
.stat-sub { font-size: 0.7rem; color: var(--success); margin-top: 4px; }
.stat-sub.neutral { color: var(--text-muted); }
.stat-item-action:hover { background: var(--accent-dim); border-color: var(--accent) !important; }

.data-explainer { background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; overflow: hidden; }
.explainer-toggle { display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1rem; cursor: pointer; font-size: 0.8rem; color: var(--text-muted); transition: all 0.2s; }
.explainer-toggle:hover { color: var(--accent); background: rgba(255,255,255,0.02); }
.explainer-arrow { margin-left: auto; transition: transform 0.2s; font-size: 0.7rem; }
.data-explainer.expanded .explainer-arrow { transform: rotate(180deg); }
.explainer-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; padding: 0 1rem; }
.data-explainer.expanded .explainer-content { max-height: 300px; padding: 0 1rem 1rem 1rem; }
.explainer-item { font-size: 0.8rem; color: var(--text-muted); padding: 0.5rem 0; border-bottom: 1px solid rgba(255,255,255,0.05); line-height: 1.5; }
.explainer-item:last-child { border-bottom: none; }
.explainer-item strong { color: var(--text-primary); }

.projection-summary { margin-top: 1rem; padding: 1rem; background: rgba(212, 196, 168, 0.05); border: 1px solid var(--accent); border-radius: 4px; font-size: 0.85rem; color: var(--text-primary); line-height: 1.5; }

.section-header { display: flex; align-items: center; justify-content: space-between; gap: 0.5rem; margin: 2rem 0 1rem 0; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem; flex-wrap: wrap; }
.section-title-group { display: flex; align-items: center; gap: 0.5rem; }
.section-title { font-family: 'JetBrains Mono', monospace; font-size: 0.9rem; font-weight: 700; color: var(--accent); text-transform: uppercase; letter-spacing: 1px; }
.section-subtitle { font-size: 0.75rem; color: var(--text-muted); font-style: italic; }

.buyer-list { display: flex; flex-direction: column; gap: 0; width: 100%; }
.buyer-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 0; border-bottom: 1px solid rgba(255,255,255,0.05); width: 100%; }
.buyer-item:last-child { border-bottom: none; }
.buyer-rank { width: 24px; height: 24px; background: var(--accent-dim); color: var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; font-weight: 700; flex-shrink: 0; }
.buyer-info { flex: 1; min-width: 0; }
.buyer-name { font-size: 0.85rem; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.buyer-stats { font-size: 0.7rem; color: var(--text-muted); margin-top: 2px; }
.buyer-amount { text-align: right; flex-shrink: 0; }
.buyer-spend { font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; font-weight: 600; color: var(--accent); }
.buyer-share { font-size: 0.7rem; color: var(--text-muted); }

.header-controls { display: flex; gap: 0.75rem; align-items: center; }
.time-badge { font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; color: var(--text-muted); border: 1px solid var(--border); padding: 4px 8px; border-radius: 4px; }
.filter-badge { display: none; background: var(--accent-dim); color: var(--accent); border: 1px solid var(--accent); padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; font-family: 'JetBrains Mono', monospace; cursor: pointer; align-items: center; gap: 6px; }
.filter-badge:hover { background: rgba(212, 196, 168, 0.2); }

.chart-wrapper { background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; padding: 1rem; width: 100%; overflow-x: auto; overflow-y: visible; }
.chart-container { width: 100%; min-height: 500px; height: auto; display: block; }

.feed-grid { display: flex; flex-direction: column; gap: 1rem; }
.deal-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; padding: 1.25rem; transition: transform 0.1s; }
.deal-card:active { transform: scale(0.99); }
.deal-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem; }
.deal-agency { font-size: 0.75rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase; background: rgba(255,255,255,0.05); padding: 2px 6px; border-radius: 4px; }
.deal-amount { font-family: 'JetBrains Mono', monospace; color: var(--accent); font-weight: 700; font-size: 1rem; }
.deal-desc { font-size: 1rem; font-weight: 600; margin-bottom: 0.5rem; line-height: 1.4; color: white; }
.deal-vendor { font-size: 0.85rem; color: #8DA0CB; margin-bottom: 0.75rem; font-family: 'JetBrains Mono', monospace; }
.deal-meta { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem; }
.meta-tag { font-size: 0.65rem; font-family: 'JetBrains Mono', monospace; padding: 3px 8px; border-radius: 3px; background: rgba(255,255,255,0.05); color: var(--text-muted); border: 1px solid var(--border); }
.meta-tag.psc { background: rgba(143, 182, 208, 0.15); border-color: rgba(143, 182, 208, 0.3); color: #8FB6D0; }
.meta-tag.mission-gap { font-weight: 600; }
.meta-tag.mission-gap.high { background: rgba(251, 128, 114, 0.15); border-color: rgba(251, 128, 114, 0.4); color: var(--danger); }
.meta-tag.mission-gap.medium { background: rgba(253, 216, 53, 0.15); border-color: rgba(253, 216, 53, 0.4); color: #FDD835; }
.meta-tag.mission-gap.low { background: rgba(255, 255, 255, 0.05); border-color: var(--border); color: var(--text-muted); }
.mission-gap-signals { font-size: 0.7rem; color: var(--text-muted); margin-top: 6px; font-style: italic; }
.mission-gap-filter { display: flex; align-items: center; gap: 0.5rem; }
.mission-gap-toggle { display: flex; align-items: center; gap: 0.4rem; padding: 4px 10px; background: transparent; border: 1px solid var(--border); border-radius: 4px; font-size: 0.7rem; font-family: 'JetBrains Mono', monospace; color: var(--text-muted); cursor: pointer; transition: all 0.2s; }
.mission-gap-toggle:hover { border-color: var(--accent); color: var(--accent); }
.mission-gap-toggle.active { background: rgba(251, 128, 114, 0.15); border-color: var(--danger); color: var(--danger); }
.mission-gap-toggle i { font-size: 0.65rem; }
.deal-footer { display: flex; justify-content: space-between; align-items: center; padding-top: 1rem; border-top: 1px solid #222; }
.deal-date { font-size: 0.75rem; color: var(--text-muted); }
.action-btn { background: var(--bg-input); color: var(--accent); text-decoration: none; padding: 0.5rem 1rem; border-radius: 4px; font-size: 0.8rem; font-weight: 600; border: 1px solid var(--border); display: flex; align-items: center; gap: 6px; }
.action-btn:hover { border-color: var(--accent); background: var(--accent-dim); }

.forecast-table-wrapper { background: var(--bg-card); border: 1px solid var(--border); overflow-x: auto; border-radius: 4px; width: 100%; }
.forecast-table { width: 100%; border-collapse: collapse; font-family: 'JetBrains Mono'; font-size: 0.8rem; }
.forecast-table th { text-align: left; padding: 1rem; color: var(--text-muted); border-bottom: 1px solid var(--border); }
.forecast-table td { padding: 1rem; border-bottom: 1px solid var(--border); color: var(--text-primary); }
.trend-pill { 
  padding: 2px 6px; 
  border-radius: 2px; 
  font-size: 0.7rem; 
  font-weight: 700;
  white-space: nowrap; /* Prevents text inside the pill from wrapping */
  display: inline-flex; /* Keeps icon and text together */
  align-items: center;
  gap: 2px;
}
.trend-up { color: var(--success); background: rgba(102, 194, 165, 0.1); }
.trend-down { color: var(--danger); background: rgba(251, 128, 114, 0.1); }

.insight-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 2rem; }
.insight-card { background: var(--bg-card); border: 1px solid var(--border); padding: 1rem; border-radius: 4px; }
.insight-val { font-size: 1.1rem; color: var(--text-primary); font-weight: 700; font-family: 'JetBrains Mono'; }
.insight-label { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.5rem; }

.view-section { display: none; }
.view-section.active { display: block; }

.loader { position: fixed; inset: 0; z-index: 300; background: rgba(0,0,0,0.9); display: none; flex-direction: column; align-items: center; justify-content: center; }
.spinner { width: 40px; height: 40px; border: 2px solid #333; border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }

.methodology-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; padding: 1.5rem; display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem; }
.method-item { padding-bottom: 1rem; border-bottom: 1px solid var(--border); }
.method-item:nth-last-child(-n+2) { border-bottom: none; padding-bottom: 0; }
.method-title { font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; font-weight: 700; color: var(--accent); margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem; }
.method-title i { font-size: 0.75rem; opacity: 0.7; }
.method-desc { font-size: 0.8rem; color: var(--text-muted); line-height: 1.5; }
.method-desc code { background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 3px; font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; color: var(--text-primary); }
.method-desc strong { color: var(--text-primary); }

.geo-map-container { background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; padding: 1rem; margin-bottom: 1.5rem; width: 100%; }
.geo-map-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
.geo-map-title { font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }
.geo-map-total { font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; color: var(--accent); font-weight: 600; }
.geo-states-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 0.5rem; max-height: 300px; overflow-y: auto; width: 100%; }
.geo-state-item { display: flex; align-items: center; justify-content: space-between; gap: 0.5rem; padding: 0.5rem 0.75rem; background: rgba(255,255,255,0.02); border-radius: 4px; font-size: 0.8rem; }
.geo-state-name { color: var(--text-primary); font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1; min-width: 0; }
.geo-state-amount { color: var(--accent); font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; flex-shrink: 0; }

.market-structure-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
.analysis-panel { background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; overflow: hidden; width: 100%; }
.analysis-panel-header { padding: 0.75rem 1rem; background: rgba(255,255,255,0.02); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
.analysis-panel-title { font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; gap: 0.5rem; }
.analysis-panel-badge { font-size: 0.65rem; padding: 2px 8px; border-radius: 10px; font-weight: 600; }
.analysis-panel-badge.high { background: rgba(102, 194, 165, 0.2); color: var(--success); }
.analysis-panel-badge.medium { background: rgba(253, 216, 53, 0.2); color: #FDD835; }
.analysis-panel-badge.low { background: rgba(239, 83, 80, 0.2); color: var(--danger); }
.analysis-panel-badge.neutral { background: rgba(255,255,255,0.1); color: var(--text-muted); }
.analysis-panel-body { padding: 1rem; width: 100%; }
.analysis-metric { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
.analysis-metric:last-child { border-bottom: none; }
.analysis-metric-label { font-size: 0.8rem; color: var(--text-muted); }
.analysis-metric-value { font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; font-weight: 600; color: var(--text-primary); }
.analysis-insight { margin-top: 0.75rem; padding: 0.75rem; background: rgba(212, 196, 168, 0.05); border-left: 2px solid var(--accent); font-size: 0.8rem; color: var(--text-muted); line-height: 1.5; }

.scenario-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; margin-bottom: 1rem; }
.scenario-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; padding: 1rem; text-align: center; transition: all 0.2s; }
.scenario-card.base { border-color: var(--accent); background: rgba(212, 196, 168, 0.05); }
.scenario-card-label { font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 0.5rem; }
.scenario-card-value { font-family: 'JetBrains Mono', monospace; font-size: 1.1rem; font-weight: 700; color: var(--text-primary); }
.scenario-card.base .scenario-card-value { color: var(--accent); }
.scenario-card-prob { font-size: 0.7rem; color: var(--text-muted); margin-top: 0.25rem; }

.forecast-range { display: flex; align-items: center; gap: 0.5rem; font-size: 0.7rem; color: var(--text-muted); margin-top: 4px; }
.forecast-range-bar { flex: 1; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; position: relative; overflow: hidden; }
.forecast-range-fill { position: absolute; height: 100%; background: linear-gradient(90deg, rgba(102, 194, 165, 0.5), var(--accent), rgba(239, 83, 80, 0.5)); border-radius: 2px; }

.bcg-badge { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: rgba(212, 196, 168, 0.1); border: 1px solid var(--accent); border-radius: 4px; font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; color: var(--accent); margin-bottom: 1rem; }

.vendor-tier { margin-bottom: 1rem; }
.vendor-tier-header { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem; }
.vendor-tier-header span { background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 3px; font-size: 0.65rem; }
.vendor-item { display: flex; justify-content: space-between; align-items: center; padding: 0.4rem 0; font-size: 0.8rem; }
.vendor-item-name { color: var(--text-primary); flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-right: 1rem; }
.vendor-item-share { font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; color: var(--accent); }

.drill-breadcrumb { display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1rem; background: linear-gradient(90deg, rgba(212, 196, 168, 0.1), transparent); border: 1px solid var(--border); border-radius: 4px; margin-bottom: 1rem; font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; overflow-x: auto; white-space: nowrap; }
.breadcrumb-item { display: flex; align-items: center; gap: 0.5rem; color: var(--text-muted); cursor: pointer; padding: 4px 8px; border-radius: 4px; transition: all 0.2s; }
.breadcrumb-item:hover { background: rgba(255,255,255,0.05); color: var(--accent); }
.breadcrumb-item.active { background: var(--accent-dim); color: var(--accent); cursor: default; }
.breadcrumb-separator { color: var(--border); font-size: 0.7rem; }
.breadcrumb-icon { font-size: 0.75rem; }

.drill-hint { display: flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.5rem; background: rgba(212, 196, 168, 0.05); border: 1px dashed var(--border); border-radius: 4px; margin-top: 0.5rem; font-size: 0.75rem; color: var(--text-muted); }
.drill-hint i { color: var(--accent); }

.subagency-panel { background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px; margin-top: 1.5rem; overflow: hidden; }
.subagency-header { display: flex; align-items: center; justify-content: space-between; padding: 1rem; background: linear-gradient(90deg, rgba(212, 196, 168, 0.08), transparent); border-bottom: 1px solid var(--border); }
.subagency-header-left { display: flex; align-items: center; gap: 0.75rem; }
.subagency-header-icon { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; background: var(--accent-dim); border: 1px solid var(--accent); border-radius: 4px; color: var(--accent); }
.subagency-header-text h3 { margin: 0; font-family: 'JetBrains Mono', monospace; font-size: 0.9rem; color: var(--text-primary); font-weight: 600; }
.subagency-header-text span { font-size: 0.75rem; color: var(--text-muted); }
.subagency-stats { display: flex; gap: 1.5rem; font-family: 'JetBrains Mono', monospace; }
.subagency-stat { text-align: right; }
.subagency-stat-val { font-size: 1rem; font-weight: 700; color: var(--accent); }
.subagency-stat-label { font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase; }

.subagency-list { max-height: 400px; overflow-y: auto; }
.subagency-item { display: flex; align-items: center; justify-content: space-between; padding: 1rem; border-bottom: 1px solid var(--border); cursor: pointer; transition: all 0.15s; }
.subagency-item:hover { background: rgba(255,255,255,0.02); }
.subagency-item:last-child { border-bottom: none; }
.subagency-item-left { display: flex; align-items: center; gap: 1rem; flex: 1; min-width: 0; }
.subagency-rank { width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.05); border-radius: 4px; font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; color: var(--text-muted); flex-shrink: 0; }
.subagency-rank.top-3 { background: var(--accent-dim); color: var(--accent); border: 1px solid rgba(212, 196, 168, 0.3); }
.subagency-info { flex: 1; min-width: 0; }
.subagency-name { font-size: 0.9rem; color: var(--text-primary); font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.subagency-contracts { font-size: 0.75rem; color: var(--text-muted); margin-top: 2px; }
.subagency-item-right { display: flex; align-items: center; gap: 1rem; flex-shrink: 0; }
.subagency-bar-container { width: 120px; height: 8px; background: rgba(255,255,255,0.05); border-radius: 4px; overflow: hidden; }
.subagency-bar { height: 100%; background: linear-gradient(90deg, var(--accent), rgba(212, 196, 168, 0.5)); border-radius: 4px; transition: width 0.3s ease; }
.subagency-amount { font-family: 'JetBrains Mono', monospace; font-size: 0.9rem; font-weight: 700; color: var(--accent); min-width: 80px; text-align: right; }
.subagency-drill-icon { color: var(--text-muted); font-size: 0.8rem; opacity: 0; transition: all 0.15s; }
.subagency-item:hover .subagency-drill-icon { opacity: 1; color: var(--accent); transform: translateX(2px); }
.drill-level-indicator { display: inline-flex; align-items: center; gap: 0.25rem; padding: 2px 6px; background: rgba(102, 194, 165, 0.1); border: 1px solid rgba(102, 194, 165, 0.3); border-radius: 4px; font-size: 0.65rem; color: var(--success); margin-left: 0.5rem; }
.node-drillable { cursor: pointer; }
.node-drillable:hover { filter: brightness(1.2); }
.empty-drill-state { text-align: center; padding: 3rem 2rem; color: var(--text-muted); }
.empty-drill-state i { font-size: 2rem; color: var(--border); margin-bottom: 1rem; }
.empty-drill-state p { margin: 0.5rem 0; }

.sales-plan-card { background: linear-gradient(135deg, rgba(212, 196, 168, 0.15) 0%, rgba(212, 196, 168, 0.05) 100%); border: 1px solid var(--accent); border-radius: 4px; padding: 1rem; cursor: pointer; transition: all 0.3s ease; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
.sales-plan-card:hover { transform: translateY(-4px); box-shadow: 0 8px 30px rgba(212, 196, 168, 0.4); border-color: var(--accent); background: linear-gradient(135deg, rgba(212, 196, 168, 0.25) 0%, rgba(212, 196, 168, 0.1) 100%); }
.sales-plan-card-icon { font-size: 1.5rem; color: var(--accent); margin-bottom: 0.5rem; }
.sales-plan-card-title { font-size: 0.85rem; font-weight: 700; color: var(--accent); margin-bottom: 0.25rem; text-transform: uppercase; letter-spacing: 1px; }
.sales-plan-card-subtitle { font-size: 0.85rem; color: var(--text-primary); line-height: 1.4; margin-bottom: 0.75rem; }
.sales-plan-card-action { display: inline-flex; align-items: center; gap: 0.5rem; font-size: 0.75rem; color: var(--accent); text-transform: uppercase; letter-spacing: 1px; font-weight: 600; }

.channel-marking-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0); z-index: 500; padding: 2rem; overflow-y: auto; display: flex; align-items: flex-start; justify-content: center; opacity: 0; visibility: hidden; transition: opacity 0.25s ease, background 0.25s ease, visibility 0.25s; }
.channel-marking-modal.active { opacity: 1; visibility: visible; background: rgba(0, 0, 0, 0.9); }
.channel-modal-content { background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; max-width: 800px; width: 100%; margin: 2rem auto; transform: translateY(-20px) scale(0.98); transition: transform 0.25s ease-out; display: flex; flex-direction: column; max-height: 85vh; }
.channel-marking-modal.active .channel-modal-content { transform: translateY(0) scale(1); }
.channel-modal-header { padding: 1.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
.channel-modal-title { font-size: 1.3rem; font-weight: 700; color: var(--accent); font-family: 'JetBrains Mono', monospace; }
.channel-modal-close { background: transparent; border: none; color: var(--text-muted); font-size: 1.5rem; cursor: pointer; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 4px; }
.channel-modal-close:hover { background: rgba(255, 255, 255, 0.05); color: var(--accent); }
.channel-modal-body { padding: 1.5rem; flex: 1; overflow-y: auto; min-height: 0; }
.channel-explanation { background: rgba(212, 196, 168, 0.1); border-left: 3px solid var(--accent); padding: 1rem; margin-bottom: 1.5rem; font-size: 0.9rem; color: var(--text-primary); line-height: 1.6; }
.vendor-list-item { display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 1rem; border: 1px solid var(--border); border-radius: 4px; margin-bottom: 0.5rem; transition: all 0.2s; }
.vendor-list-item:hover { background: rgba(255, 255, 255, 0.02); border-color: var(--accent); }
.vendor-info { flex: 1; min-width: 0; }
.vendor-name { font-weight: 600; color: var(--text-primary); margin-bottom: 0.25rem; }
.vendor-stats { font-size: 0.75rem; color: var(--text-muted); }
.vendor-toggle { display: flex; align-items: center; gap: 0.5rem; }
.toggle-switch { position: relative; width: 50px; height: 26px; background: #333; border-radius: 13px; cursor: pointer; transition: background 0.3s; }
.toggle-switch.active { background: var(--accent); }
.toggle-slider { position: absolute; top: 3px; left: 3px; width: 20px; height: 20px; background: white; border-radius: 50%; transition: transform 0.3s; }
.toggle-switch.active .toggle-slider { transform: translateX(24px); }
.toggle-label { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; min-width: 80px; }
.toggle-switch.active + .toggle-label { color: var(--accent); font-weight: 600; }
.channel-modal-footer { padding: 1rem 1.5rem; border-top: 1px solid var(--border); display: flex; gap: 1rem; justify-content: space-between; align-items: center; flex-shrink: 0; background: var(--bg-card); }
.modal-footer-buttons { display: flex; gap: 0.75rem; align-items: center; }
.modal-footer-secondary { display: flex; gap: 0.5rem; }
.modal-status-line { font-size: 0.75rem; color: var(--text-muted); }
.modal-btn { padding: 0.75rem 1.5rem; border-radius: 4px; font-weight: 600; cursor: pointer; transition: all 0.2s; text-transform: uppercase; letter-spacing: 1px; font-size: 0.85rem; }
.modal-btn-cancel { background: transparent; border: 1px solid var(--border); color: var(--text-muted); }
.modal-btn-cancel:hover { border-color: var(--accent); color: var(--accent); }
.modal-btn-primary { background: var(--accent); border: none; color: #000; }
.modal-btn-primary:hover { opacity: 0.9; transform: translateY(-1px); }
.channel-link { display: inline-flex; align-items: center; gap: 0.25rem; font-size: 0.75rem; color: var(--text-muted); margin-top: 0.5rem; cursor: pointer; text-decoration: underline; }
.channel-link:hover { color: var(--accent); }

#spIntentBanner { display: none; background: rgba(255, 255, 255, 0.02); border-bottom: 1px solid var(--border); padding: 1rem 1.5rem; }
.intent-banner-content { display: flex; align-items: flex-start; gap: 0.75rem; }
.intent-banner-icon { font-size: 1.25rem; color: var(--accent); opacity: 0.9; width: 24px; text-align: center; flex-shrink: 0; }
.intent-banner-text { flex: 1; }
.intent-banner-title { font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 0.25rem; }
.intent-banner-desc { font-size: 0.95rem; color: var(--text-primary); margin-bottom: 0.5rem; font-weight: 500; }
.intent-banner-focus { display: flex; flex-wrap: wrap; align-items: center; gap: 0.4rem; }
.focus-label { font-family: 'JetBrains Mono', monospace; font-size: 0.6rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
.focus-tag { font-size: 0.65rem; background: transparent; border: none; color: var(--text-muted); padding: 0; }
.focus-tag::before { content: 'â€¢'; margin-right: 0.35rem; color: var(--accent); }

.ai-link-btn { display: flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.75rem 1rem; border-radius: 4px; color: white; text-decoration: none; font-family: 'Inter', sans-serif; font-size: 0.8rem; font-weight: 600; border: none; transition: transform 0.1s, opacity 0.2s; }
.ai-link-btn:hover { transform: translateY(-1px); opacity: 0.9; }
.ai-link-btn.claude { background: #C15F3C; }
.ai-link-btn.chatgpt { background: #4796E3; }
.ai-link-btn.gemini { background: #9177C7; }

#copySuccessModal .channel-modal-content { 
  border: 1px solid var(--border); /* Matches the rest of your app's borders */
  box-shadow: 0 0 30px rgba(0,0,0,0.5); 
}
#copySuccessModal kbd { background: var(--bg-app); border: 1px solid var(--border); color: var(--accent); font-family: 'JetBrains Mono', monospace; padding: 2px 4px; border-radius: 3px; }

@media (max-width: 900px) { 
  .insight-grid { grid-template-columns: 1fr; }
  .market-structure-grid { grid-template-columns: 1fr; }
  .scenario-grid { grid-template-columns: 1fr; gap: 0.5rem; }
}

@media (max-width: 768px) {
  .methodology-card { grid-template-columns: 1fr; }
  .subagency-bar-container { display: none; }
  .subagency-stats { flex-direction: column; gap: 0.5rem; }
  .subagency-stat { text-align: left; }
  .stats-row { grid-template-columns: 1fr !important; gap: 0.75rem !important; }
  .stat-item { display: flex !important; justify-content: space-between !important; align-items: center !important; padding: 1rem !important; text-align: left !important; }
  .stat-label { margin-bottom: 0 !important; }
  .stat-item-action { grid-column: span 1 !important; }
  
  #forecastModeView div[style*="display: grid"] {
    grid-template-columns: 1fr !important;
    gap: 1rem !important;
    width: 100% !important;
    overflow: hidden !important;
  }
  
  .dashboard-container {
    width: 100% !important;
    max-width: 100% !important;
    padding-left: 1rem !important;
    padding-right: 1rem !important;
    overflow-x: hidden !important;
  }

  .analysis-panel, .analysis-panel-body, .buyer-list {
    width: 100% !important;
    max-width: 100% !important;
  }

  .geo-states-grid { grid-template-columns: 1fr !important; }
  .btn-row { flex-direction: column; }
  .chart-container { min-width: 600px; }
  .chart-wrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; }
}

@media (max-width: 600px) {
  .mode-toggle { flex-direction: column; }
  .app-header { gap: 0.5rem; padding: 0.5rem 0.75rem; }
  .header-left { gap: 0.5rem; }
  .mini-search { 
    max-width: 140px; 
    padding: 0.5rem 0.6rem; 
    font-size: 0.8rem; 
  }
  .logo-btn { font-size: 0.9rem; }
  .icon-btn { width: 32px; height: 32px; }
  .header-actions { gap: 0.35rem; }
  .channel-marking-modal { padding: 0; }
  .channel-modal-content { 
    margin: 0; 
    border-radius: 0; 
    height: 100vh; 
    height: 100dvh;
    max-height: 100vh; 
    max-width: 100%; 
    display: flex; 
    flex-direction: column;
  }
  .channel-modal-header { flex-shrink: 0; padding: 1rem; }
  .channel-modal-title { font-size: 1.1rem; }
  .channel-modal-body { flex: 1; overflow-y: auto; min-height: 0; }
  .channel-modal-footer { 
    flex-direction: column;
    gap: 0.75rem; 
    padding: 1rem;
    padding-bottom: max(1rem, env(safe-area-inset-bottom));
  }
  .modal-footer-buttons {
    flex-direction: column;
    width: 100%;
    gap: 0.5rem;
  }
  .modal-footer-buttons .modal-btn-primary {
    width: 100%;
    padding: 0.875rem;
  }
  .modal-footer-secondary {
    width: 100%;
    gap: 0.5rem;
  }
  .modal-footer-secondary .modal-btn {
    flex: 1;
    padding: 0.75rem;
  }
  .modal-status-line {
    text-align: center;
    font-size: 0.7rem;
    opacity: 0.7;
    padding-top: 0.5rem;
    border-top: 1px solid var(--border);
  }
  .step-grid { grid-template-columns: 1fr !important; }
}

.buyer-name, .vendor-name, .geo-state-name {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 180px;
}

::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: var(--bg-app); }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--accent); }
/* --- Projection & Narrative Enhancements --- */
.projection-summary {
  margin-top: 1rem;
  padding: 1.5rem;
  background: linear-gradient(135deg, rgba(212, 196, 168, 0.1) 0%, rgba(18, 18, 18, 1) 100%);
  border: 1px solid var(--accent);
  border-radius: 4px;
  position: relative;
  overflow: hidden;
}

.hero-growth-label {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.7rem;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 2px;
  margin-bottom: 0.5rem;
}

.hero-growth-value {
  font-size: 2.5rem;
  font-weight: 800;
  font-family: 'JetBrains Mono', monospace;
  line-height: 1;
}

.strategic-narrative-card {
  background: var(--bg-card);
  border-left: 4px solid var(--accent);
  padding: 1.25rem;
  margin: 1.5rem 0;
  font-size: 0.9rem;
  line-height: 1.6;
}

/* Confidence Badge Styling */
.analysis-panel-badge {
  font-size: 0.65rem;
  padding: 2px 8px;
  border-radius: 10px;
  font-weight: 600;
  font-family: 'JetBrains Mono', monospace;
}
.analysis-panel-badge.high { background: rgba(102, 194, 165, 0.2); color: var(--success); }
.analysis-panel-badge.medium { background: rgba(253, 216, 53, 0.2); color: #FDD835; }
.analysis-panel-badge.low { background: rgba(239, 83, 80, 0.2); color: var(--danger); }

/* Disclaimer & Footer */
.disclaimer-text {
  margin-top: 1.5rem;
  padding: 1rem;
  font-size: 0.7rem;
  color: var(--text-muted);
  border-top: 1px solid var(--border);
  line-height: 1.4;
  font-style: italic;
}

/* Responsive Grid for Confidence Logic */
@media (max-width: 600px) {
  .hero-growth-value { font-size: 2rem; }
  
  /* Stack the Confidence Logic bars on small mobile screens */
  div[style*="grid-template-columns: 1fr 1fr"] {
    grid-template-columns: 1fr !important;
  }
}

.tip-bio-img {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  filter: grayscale(1) contrast(1.1);
  flex-shrink: 0;
  float: left;
  margin-right: 12px;
  margin-bottom: 4px;
}

/* ===== HERO FOOTER ===== */
.hero-footer {
  width: 100%;
  max-width: 900px;
  margin-top: 3rem;
  padding-top: 2rem;
}

.footer-grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 2rem;
}

.footer-section {
  padding-bottom: 1.5rem;
  border-bottom: 1px solid var(--border);
}

.footer-section:last-child {
  border-bottom: none;
  padding-bottom: 0;
}

.footer-label {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.65rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 1px;
  color: var(--accent);
  margin-bottom: 0.75rem;
}

.footer-heading {
  font-size: 1rem;
  font-weight: 600;
  color: var(--text-primary);
  margin-bottom: 0.75rem;
  letter-spacing: -0.01em;
}

.footer-text {
  overflow: hidden; /* This keeps the text in a clean block next to the image */
  font-size: 0.8rem;
  line-height: 1.6;
  color: var(--text-muted);
  margin-bottom: 0.75rem;
}
.footer-text:last-child {
  margin-bottom: 0;
}

/* Use Cases */
.use-cases {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

/* Feature List (integrated search tips) */
.feature-list {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}

.feature-item {
  display: flex;
  align-items: flex-start;
  gap: 0.75rem;
  font-size: 0.75rem;
  line-height: 1.5;
}

.feature-tag {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.65rem;
  font-weight: 700;
  color: var(--text-primary);
  background: rgba(255, 255, 255, 0.1);
  padding: 0.2rem 0.5rem;
  border-radius: 2px;
  white-space: nowrap;
  flex-shrink: 0;
}

.feature-desc {
  color: var(--text-muted);
}

.use-case {
  padding: 0.875rem;
  background: rgba(255, 255, 255, 0.02);
  border-left: 2px solid var(--accent);
}

.use-case-title {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.7rem;
  font-weight: 700;
  color: var(--text-primary);
  margin-bottom: 0.375rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.use-case-desc {
  font-size: 0.75rem;
  color: var(--text-muted);
  line-height: 1.5;
}

/* Steps List */
.steps-list {
  counter-reset: step;
  list-style: none;
  padding: 0;
  margin: 0;
}

.steps-list li {
  position: relative;
  padding-left: 1.75rem;
  margin-bottom: 0.625rem;
  font-size: 0.75rem;
  color: var(--text-muted);
  line-height: 1.5;
}

.steps-list li::before {
  counter-increment: step;
  content: counter(step);
  position: absolute;
  left: 0;
  top: 0;
  width: 1.125rem;
  height: 1.125rem;
  background: var(--accent);
  color: #000;
  font-size: 0.6rem;
  font-weight: 700;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 2px;
}

/* Footer Links */
.footer-links {
  display: flex;
  gap: 1rem;
  flex-wrap: wrap;
  margin-top: 1rem;
}

.footer-link {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.7rem;
  color: var(--accent);
  text-decoration: none;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  font-weight: 700;
  padding-bottom: 2px;
  border-bottom: 1px solid var(--accent);
  transition: opacity 0.2s ease;
}

.footer-link:hover {
  opacity: 0.7;
}

/* Data Source */
.data-source {
  display: flex;
  align-items: flex-start;
  gap: 0.75rem;
  padding: 0.75rem;
  background: rgba(255, 255, 255, 0.02);
  border: 1px solid var(--border);
  border-radius: 4px;
  margin-top: 1rem;
}

.data-source-icon {
  font-size: 1rem;
  color: var(--text-muted);
  margin-top: 2px;
}

.data-source-text {
  font-size: 0.7rem;
  color: var(--text-muted);
  line-height: 1.5;
}

.data-source-text a {
  color: var(--accent);
  text-decoration: none;
}

.data-source-text a:hover {
  text-decoration: underline;
}

/* Pro Tip Box */
.pro-tip-box {
  font-family: 'JetBrains Mono', monospace;
  background: rgba(212, 196, 168, 0.08);
  border: 1px solid var(--accent);
  border-radius: 4px;
  padding: 0.75rem;
  margin-top: 1rem;
}

.pro-tip-label {
  font-size: 0.6rem;
  font-weight: 700;
  color: var(--accent);
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 0.5rem;
}

.pro-tip-code {
  font-size: 0.75rem;
  color: var(--text-primary);
  background: rgba(0, 0, 0, 0.3);
  padding: 0.375rem 0.5rem;
  border-radius: 2px;
  display: inline-block;
  margin-top: 0.25rem;
}

/* Footer Bottom */
.footer-bottom {
  margin-top: 2rem;
  padding-top: 1.5rem;
  border-top: 1px solid var(--border);
  text-align: center;
}

.footer-copyright {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.65rem;
  color: var(--text-muted);
  letter-spacing: 0.5px;
}

/* Desktop Footer Grid */
@media (min-width: 768px) {
  .footer-grid {
    grid-template-columns: 1.3fr 1fr 1fr 1fr;
    gap: 2rem;
  }
  
  .footer-section {
    border-bottom: none;
    padding-bottom: 0;
  }
}
.breadcrumb-item:hover { 
  background: var(--accent); 
  color: #000; 
}
.breadcrumb-item.active { 
  background: var(--accent-dim); 
  color: var(--accent); 
  border: 1px solid var(--accent); 
}

.subagency-bar { 
  background: linear-gradient(90deg, var(--accent), rgba(153, 153, 153, 0.3)); 
}
</style>

</head>
<body>

<div id="heroView" class="hero-view">
  <div class="terminal-logo"><span>>_</span>Govhoo</div>
  <p class="hero-subtitle">Follow the Money. For Free.</p>
  
  <div class="search-box-container">
    <input type="text" id="mainSearchInput" class="main-input" placeholder="Search keywords, company, or agency..." autocomplete="off">
    <div class="btn-row">
      <button id="searchBtn" class="btn-primary">
        <i class="fas fa-search"></i> SEARCH
      </button>
      <button id="forecastBtn" class="btn-secondary">
        <i class="fas fa-chart-line"></i> FORECAST
      </button>
    </div>
  </div>

<!-- Hero Footer -->
<footer class="hero-footer">
  <div class="footer-grid">
    <!-- Features (merged from search tips) -->
    <div class="footer-section">
      <div class="footer-label mono text-xs accent upper">Features</div>
      <div class="feature-list">
        <div class="feature-item">
          <span class="feature-tag mono">Search</span>
          <span class="feature-desc muted">Query award descriptions, vendors, and agencies. Use full names for better results (Amazon instead of AWS). You can search multiple companies or kewyords with commas (Company A, Company B, etc.)</span>
        </div>
        <div class="feature-item">
          <span class="feature-tag mono">Awards</span>
          <span class="feature-desc muted">Visualize dollar flow from Agencies to Winners. Click to drill into sub-agency spending.</span>
        </div>
        <div class="feature-item">
          <span class="feature-tag mono">Forecast</span>
          <span class="feature-desc muted">FY2026 projections based on historical obligations. Filters outliers, calculates YoY trends.</span>
        </div>
        <div class="feature-item">
          <span class="feature-tag mono">Plan</span>
          <span class="feature-desc muted">Generate AI-ready prompt packages for territory plans and competitor displacement strategies.</span>
        </div>
      </div>
    </div>
    
    <!-- Use Cases -->
    <div class="footer-section">
      <div class="footer-label mono text-xs accent upper">Use Cases</div>
      <div class="use-cases">
        <div class="use-case">
          <div class="use-case-title">Defend</div>
          <div class="use-case-desc">Track your contracts and agency relationships. Get ahead of recompetes.</div>
        </div>
        <div class="use-case">
          <div class="use-case-title">Attack</div>
          <div class="use-case-desc">Find competitor award flow. Position early while incumbents get complacent.</div>
        </div>
        <div class="use-case">
          <div class="use-case-title">Expand</div>
          <div class="use-case-desc">Discover agencies buying what you sell. Identify white space in your territory.</div>
        </div>
      </div>
    </div>
    
    <!-- Data -->
    <div class="footer-section">
      <div class="footer-label mono text-xs accent upper">Data</div>
      <p class="footer-text">
        Live data from <a href="https://usaspending.gov" target="_blank" style="color: var(--accent);">USASpending.gov</a>. DoD data has ~90 day reporting lag; civilian is typically current within 30 days.
      </p>
      <p class="footer-text" style="margin-top: 1rem;">
        For sales teams, BD professionals, and capture managers selling to the federal government.
      </p>
      <div class="pro-tip-box">
        <div class="pro-tip-label">Pro Tip</div>
        <p class="footer-text" style="margin-bottom: 0.5rem;">Refresh your browser if stuck. Use full names for better matching:</p>
        <code class="pro-tip-code">Amazon instead of AWS</code>
      </div>
    </div>
     <!-- About -->
    <div class="footer-section">
      <div class="footer-label mono text-xs accent upper">About</div>
      <h3 class="footer-heading">Built by a Sales Guy</h3>
      <p class="footer-text">
<img src="https://govhoo.com/images/oldmark.jpg" alt="Mark Flournoy" class="tip-bio-img">Hi, Iâ€™m Mark. After serving as a Marine and a DISA COTR, I worked in sales at AWS, F5, and Red Hat. I built Govhoo to surface mission gaps in expiring contracts so you can reach customers when they need you most. Itâ€™s free to use and I hope it helps you win. Good luck out there.
      </p>
      
       <p class="footer-text">Questions or feature requests? DM me on <a href="https://www.linkedin.com/in/markflournoy/" target="_blank" style="color: var(--accent); text-decoration: underline;">LinkedIn</a>.</p>
	   <p class="footer-text">Check out my other sites <a href="https://askarti.com" target="_blank" style="color: var(--accent); text-decoration: underline;">AskArti</a> and <a href="https://subhoo.com" target="_blank" style="color: var(--accent); text-decoration: underline;">Subhoo</a>.</p>
    </div>
  </div>
  <div class="footer-bottom">
    <div class="footer-copyright">Â© 2025 GOVHOO â€” DATA VIA USASPENDING.GOV</div>
  </div>
</footer>
</div>

<div id="appView" style="display:none;">
  <header class="app-header">
    <div class="header-left">
      <span class="logo-btn" onclick="App.showHero()">>_Govhoo</span>
      <input type="text" id="miniSearch" class="mini-search" placeholder="New search...">
    </div>
    <div class="header-actions">
      <button class="icon-btn" id="toggleModeBtn" onclick="App.toggleMode()" title="Toggle Mode">
        <i class="fas fa-exchange-alt"></i>
      </button>
      <button class="icon-btn" onclick="App.shareLink(this)" title="Copy Share Link">
  <i class="fas fa-link"></i>
</button>

<button class="icon-btn" title="Export CSV" onclick="App.exportCSV(this)">
  <i class="fas fa-download"></i>
</button>
    </div>
  </header>

  <div id="dashboardContainer" class="dashboard-container">
    
    <div class="mode-toggle">
      <button class="mode-btn active" id="modeSearchBtn" onclick="App.setMode('search')">
        <i class="fas fa-project-diagram"></i> Agency Award Flow
      </button>
      <button class="mode-btn" id="modeForecastBtn" onclick="App.setMode('forecast')">
        <i class="fas fa-eye"></i> Annual Forecast
      </button>
    </div>

    <div id="searchModeView" class="view-section active">
      <div class="stats-row" id="searchStats">
        <div class="stat-item">
          <div class="stat-label">Contract Awards</div>
          <div class="stat-val" id="stat-vol">-</div>
          <div class="stat-sub neutral">Past 12 Mo (Ceiling)</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Contract Count</div>
          <div class="stat-val" id="stat-count">-</div>
          <div class="stat-sub neutral">Past 12 Months</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Prime Vendors</div>
          <div class="stat-val" id="stat-vendors">-</div>
          <div class="stat-sub neutral">Unique Recipients</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Agencies</div>
          <div class="stat-val" id="stat-agencies">-</div>
          <div class="stat-sub neutral">Awarding Agencies</div>
        </div>
      </div>

      <div id="drillBreadcrumb" class="drill-breadcrumb" style="display: none;">
        <div class="breadcrumb-item" onclick="App.resetDrill()">
          <i class="fas fa-globe breadcrumb-icon"></i>
          <span>All Agencies</span>
        </div>
      </div>

      <div class="section-header">
        <div class="section-title-group">
          <i class="fas fa-project-diagram accent"></i>
          <span class="section-title mono bold accent upper">Award Flow</span>
          <span id="drillLevelBadge" class="drill-level-indicator" style="display:none;">
            <i class="fas fa-layer-group"></i>
            <span id="drillLevelText">Level 1</span>
          </span>
        </div>
        <div class="header-controls">
          <div id="filterBadge" class="filter-badge" onclick="App.clearFilter()">
            <span id="filterName">FILTER</span> <i class="fas fa-times"></i>
          </div>
          <div class="time-badge mono text-xs muted">PAST 12 MONTHS</div>
        </div>
      </div>
      <div class="chart-wrapper">
        <div id="chartContainer" class="chart-container"></div>
      </div>
      <div id="drillHint" class="drill-hint">
        <i class="fas fa-mouse-pointer"></i>
        <span>Click an <strong>agency bar</strong> to drill into sub-agencies</span>
      </div>

      <div id="subagencyPanel" class="subagency-panel" style="display: none;">
        <div class="subagency-header">
          <div class="subagency-header-left">
            <div class="subagency-header-icon">
              <i class="fas fa-building"></i>
            </div>
            <div class="subagency-header-text">
              <h3 id="subagencyParentName">Department of Defense</h3>
              <span id="subagencyParentType">Parent Agency</span>
            </div>
          </div>
          <div class="subagency-stats">
            <div class="subagency-stat">
              <div class="subagency-stat-val" id="subagencyTotalAmount">$0</div>
              <div class="subagency-stat-label">Total Value</div>
            </div>
            <div class="subagency-stat">
              <div class="subagency-stat-val" id="subagencyCount">0</div>
              <div class="subagency-stat-label">Sub-Agencies</div>
            </div>
          </div>
        </div>
        <div class="subagency-list" id="subagencyList">
          </div>
      </div>

      <div class="section-header">
        <div class="section-title-group">
          <i class="fas fa-list-ul accent"></i>
          <span class="section-title mono bold accent upper">Contract Award Feed</span>
        </div>
      </div>
      <div id="feedGrid" class="feed-grid"></div>
    </div>

<div id="forecastModeView" class="view-section">
  <div class="stats-row" id="forecastStats" style="grid-template-columns: repeat(5, 1fr);">
    <div class="stat-item">
      <div class="stat-label">Contract Awards (TCV)</div>
      <div class="stat-val" id="stat-total-awards">-</div>
      <div class="stat-sub neutral">Last 12 Mo (Ceiling)</div>
    </div>
    <div class="stat-item">
      <div class="stat-label">Actual $ Obligated</div>
      <div class="stat-val" id="stat-total-obligations">-</div>
      <div class="stat-sub neutral">Last Complete FY</div>
    </div>
    <div class="stat-item">
      <div class="stat-label">YoY Trend</div>
      <div class="stat-val" id="stat-yoy-change">-</div>
      <div class="stat-sub" id="stat-yoy-direction">-</div>
    </div>
    <div class="stat-item">
      <div class="stat-label">Expiring Soon</div>
      <div class="stat-val" id="stat-recompetes">-</div>
      <div class="stat-sub" style="color:var(--danger)">Next 24 Months</div>
    </div>
    <div class="stat-item stat-item-action" onclick="SalesPlanManager.open()" style="cursor:pointer; border-color:var(--accent);">
      <div class="stat-label accent">Sales Plan</div>
      <div class="stat-val" style="font-size:1.5rem;"><i class="fas fa-file-export accent"></i></div>
      <div class="stat-sub accent">Export to AI</div>
    </div>
  </div>
<div id="projectionSummary" class="projection-summary"></div>
  <div class="section-header" style="margin-top:1.5rem;">
    <div class="section-title-group">
      <i class="fas fa-calculator accent"></i>
      <span class="section-title mono bold accent upper">Quarterly Projection</span>
    </div>
    <span class="section-subtitle text-sm muted">Based on obligation history (not contract ceilings)</span>
  </div>
    
  <div id="forecastTableContainer" class="forecast-table-wrapper">
    <table class="forecast-table">
      <thead>
        <tr>
          <th>Quarter</th>
          <th>3-Year Avg</th>
          <th>Last Year</th>
          <th>Projection</th>
        </tr>
      </thead>
      <tbody id="forecastTableBody"></tbody>
    </table>
  </div>

<div class="data-explainer" style="margin-top:2rem; opacity: 0.8;">
  <div class="explainer-toggle" onclick="this.parentElement.classList.toggle('expanded')">
    <i class="fas fa-info-circle" style="color:var(--accent);"></i>
    <span>Strategic Context & Methodology</span>
    <i class="fas fa-chevron-down explainer-arrow"></i>
  </div>
  <div class="explainer-content">
    <div class="explainer-item">
      <strong>Ceiling vs. Floor (Gap Analysis)</strong> â€” <em>Contract Awards</em> represent the maximum potential capacity (Ceiling). <em>Obligations</em> represent actual cash flow (Floor). Large deltas indicate significant unspent budget capacity available for task-order pursuits.
    </div>
    <div class="explainer-item">
      <strong>Quarterly Seasonality</strong> â€” Projections for FY Q4 (July-Sept) historically reflect "Use-it-or-Lose-it" surges. High Q4 projections suggest capture efforts should peak in Q2/Q3 to be "on-vehicle" before the drop.
    </div>
    <div class="explainer-item">
      <strong>Continuing Resolution (CR) Risk</strong> â€” Q1/Q2 projections assume normal historical funding. However, under current CR conditions (through Jan 30, 2026), expect "Must-Fund" operational renewals to take precedence over new program starts.
    </div>
    <div class="explainer-item">
      <strong>Efficiency Mandate (DOGE)</strong> â€” FY26 projections are subject to Department of Government Efficiency (DOGE) audits. Value propositions emphasizing workforce automation and "Waste Reduction" are more resilient against projected spending cuts.
    </div>
  </div>
</div>
  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-top: 1.5rem;">
    <div>
      <div class="section-header" style="margin: 0 0 1rem 0;">
        <div class="section-title-group">
          <i class="fas fa-landmark accent"></i>
          <span class="section-title mono bold accent upper">Top Buyers</span>
        </div>
      </div>
      <div id="topBuyersPanel" class="analysis-panel">
        <div class="analysis-panel-body" id="topBuyersBody">
          <div class="muted" style="text-align:center; padding:1rem;">Loading...</div>
        </div>
      </div>
    </div>

    <div>
      <div class="section-header" style="margin: 0 0 1rem 0;">
        <div class="section-title-group">
          <i class="fas fa-trophy accent"></i>
          <span class="section-title mono bold accent upper">Top Winners</span>
        </div>
      </div>
      <div id="topWinnersPanel" class="analysis-panel">
        <div class="analysis-panel-body" id="topWinnersBody">
          <div class="muted" style="text-align:center; padding:1rem;">Loading...</div>
        </div>
      </div>
    </div>
  </div>

  <div style="display: grid; grid-template-columns: 1.5fr 1fr; gap: 1.5rem; margin-top: 1.5rem;">
    <div class="chart-wrapper">
      <div class="section-title mono bold accent upper text-xs" style="margin-bottom:1rem;">Spending History</div>
      <canvas id="spendingChart" style="max-height: 300px;"></canvas>
    </div>
    <div class="geo-map-container" id="geoMapContainer" style="display:none;"></div>
  </div>

  <div id="recompetesList" style="margin-top:2rem;"></div>
</div>
  </div>
</div>
<div id="loader" class="loader">
  <div class="spinner"></div>
  <p id="loaderText" style="margin-top:1rem; font-family:'JetBrains Mono'; color:var(--accent);">RETRIEVING DATA...</p>
  <p id="loaderSubtext" style="color:#666; font-size:0.8rem; margin-top:0.5rem;"></p>
</div>

<div id="salesPlanModal" class="channel-marking-modal">
  <div class="channel-modal-content" style="max-width: 900px;">
    <div class="channel-modal-header">
      <div class="channel-modal-title"><i class="fas fa-rocket"></i> GENERATE SALES PLAN</div>
      <button class="channel-modal-close" onclick="SalesPlanManager.close()"><i class="fas fa-times"></i></button>
    </div>
    
    <div class="channel-modal-body" style="flex:1; overflow-y:auto; padding:0;">
      
      <!-- NEW: Intent Detection Banner -->
      <div id="spIntentBanner"></div>
      
      <!-- Step 1: Scope -->
      <div style="padding:1.5rem; border-bottom:1px solid var(--border); background:rgba(255,255,255,0.02);">
        <div style="font-size:0.85rem; color:var(--accent); font-weight:700; margin-bottom:1rem; text-transform:uppercase; letter-spacing:1px;">
          <i class="fas fa-bullseye"></i> Step 1: Define Plan Scope
        </div>
        <div class="step-grid" style="display:grid; grid-template-columns: 1fr 1fr; gap:1.5rem;">
          <div>
            <label style="display:block; font-size:0.75rem; color:var(--text-muted); margin-bottom:0.5rem; font-weight:600;">
              PLAN SCOPE / SECTOR
            </label>
            <select id="spScope" class="main-input" style="padding:0.6rem; font-size:0.9rem; background:var(--bg-app);">
              <option value="all">Entire Market (All Results)</option>
              <option value="defense">Defense (DoD & Branches)</option>
              <option value="civilian">Federal Civilian (Non-DoD)</option>
              <optgroup label="Specific Agencies" id="spSpecificAgencies"></optgroup>
            </select>
          </div>
          <div>
            <label style="display:block; font-size:0.75rem; color:var(--text-muted); margin-bottom:0.5rem; font-weight:600;">
              STRATEGIC GOAL
              <span style="cursor:help; margin-left:4px;" title="Growth = New business pursuit&#10;Retention = Defend existing contracts&#10;Partnership = Channel/partner optimization">â“˜</span>
            </label>
            <select id="spFocus" class="main-input" style="padding:0.6rem; font-size:0.9rem; background:var(--bg-app);">
              <option value="Growth">Aggressive Growth (New Business)</option>
              <option value="Retention">Retention (Defend Incumbency)</option>
              <option value="Partnership">Partner/Channel Strategy</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Step 2: Vendor Classification -->
      <div style="padding:1.5rem;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
          <div style="font-size:0.85rem; color:var(--accent); font-weight:700; text-transform:uppercase; letter-spacing:1px;">
            <i class="fas fa-sitemap"></i> Step 2: Classify Vendors
          </div>
          <div id="spBulkActionContainer"></div>
        </div>
        
        <div style="background:rgba(212, 196, 168, 0.05); padding:0.75rem; border-radius:4px; margin-bottom:1.5rem; font-size:0.8rem; color:var(--text-muted); border-left:2px solid var(--accent);">
          <i class="fas fa-magic" style="color:var(--accent);"></i>
          <strong>Smart Detection:</strong> We've pre-identified likely resellers based on known patterns. Accept our suggestions or customize below.
        </div>

        <div id="spVendorList"></div>
      </div>
    </div>

    <!-- Footer -->
    <div class="channel-modal-footer">
      <div class="modal-footer-buttons">
        <button id="btnCopyPrompt" class="modal-btn modal-btn-primary" onclick="SalesPlanManager.copyPrompt()">
          <i class="fas fa-copy"></i> Copy Prompt
        </button>
        <div class="modal-footer-secondary">
          <button class="modal-btn modal-btn-cancel" onclick="SalesPlanManager.close()">Cancel</button>
          <button class="modal-btn modal-btn-cancel" onclick="SalesPlanManager.generate()" title="Download as .txt file">
            <i class="fas fa-download"></i> .TXT
          </button>
        </div>
      </div>
      <div id="spDataStatus" class="modal-status-line"></div>
    </div>
  </div>
</div>
<script>
// ==================== UTILITIES ====================
const Utils = {
  money: n => {
    if (!n && n !== 0) return '-';
    if(n >= 1e9) return '$' + (n/1e9).toFixed(1) + 'B';
    if(n >= 1e6) return '$' + (n/1e6).toFixed(1) + 'M';
    if(n >= 1e3) return '$' + (n/1e3).toFixed(0) + 'K';
    return '$' + Math.round(n).toLocaleString();
  },
  trunc: (s, l) => (s && s.length > l) ? s.substring(0,l)+'...' : (s || 'No Description'),
  date: s => s ? new Date(s).toLocaleDateString() : 'â€”',
  formatDateISO: date => date.toISOString().split('T')[0],
  
  getCurrentFY: () => {
    const now = new Date();
    // Federal FY starts Oct 1 (Month 9)
    return now.getMonth() >= 9 ? now.getFullYear() + 1 : now.getFullYear();
  },

  getCurrentQuarter: () => {
    const m = new Date().getMonth(); // 0-11
    if (m >= 9) return 1;
    if (m <= 2) return 2;
    if (m <= 5) return 3;
    return 4;
  },
  
  getColor: name => {
    const palette = ['#958BB6', '#6F8A74', '#C27E5C', '#8FB6D0', '#B0C4DE', '#D9B48F'];
    let hash = 0;
    for (let i = 0; i < name.length; i++) {
      hash = name.charCodeAt(i) + ((hash << 5) - hash);
    }
    return palette[Math.abs(hash) % palette.length];
  },

  // Mission Gap Risk Assessment
  // Flags expiring contracts likely tied to ongoing operational support
  missionGapRisk(award) {
    const endDate = new Date(award['End Date']);
    const daysUntil = Math.ceil((endDate - new Date()) / (1000 * 60 * 60 * 24));

    const amt = parseFloat(award['Award Amount']) || 0;

    const desc = (award['Description'] || '').toLowerCase();
    const pscDesc = (award['PSC Description'] || '').toLowerCase();
    const naicsDesc = (award['NAICS Description'] || '').toLowerCase();
    const psc = (award['PSC Code'] || '').toUpperCase();

    // Ongoing support signals - tune this list over time
    const supportTerms = [
      'operations', 'o&m', 'maintenance', 'sustainment', 'help desk', 'service desk',
      'support services', 'managed services', 'hosting', 'cloud', 'network',
      'cyber', 'security', 'monitoring', 'soc', 'continuity', 'backup', 'dr', 'patch',
      'infrastructure', 'enterprise', 'mission', 'critical', '24/7', 'production'
    ];

    const text = `${desc} ${pscDesc} ${naicsDesc}`;
    const supportHits = supportTerms.filter(t => text.includes(t));
    const looksOperational = supportHits.length >= 2;

    // PSC shortcuts - common federal service families
    // D = IT/Data Processing, R = Professional Services, J = Maintenance/Repair
    const servicePscPrefixes = ['D', 'R', 'J'];
    const isServicePsc = servicePscPrefixes.includes(psc.slice(0, 1));

    // Risk logic
    if (daysUntil <= 180 && (looksOperational || isServicePsc) && amt >= 250000) {
      return { level: 'high', daysUntil, reasons: supportHits.slice(0, 4) };
    }
    if (daysUntil <= 365 && (looksOperational || isServicePsc) && amt >= 100000) {
      return { level: 'medium', daysUntil, reasons: supportHits.slice(0, 3) };
    }
    return { level: 'low', daysUntil, reasons: supportHits.slice(0, 2) };
  }
};

// ==================== MODAL UTILITIES ====================
const ModalUtils = {
  activeModal: null,
  previousFocus: null,
  
  open(modalId) {
    const modal = document.getElementById(modalId);
    if (!modal) return;
    
    // Store previous focus for restoration
    this.previousFocus = document.activeElement;
    
    // Lock body scroll
    document.body.style.overflow = 'hidden';
    
    // Show modal
    modal.classList.add('active');
    this.activeModal = modal;
    
    // Focus first focusable element
    const focusable = modal.querySelector('button, input, select, textarea');
    if (focusable) setTimeout(() => focusable.focus(), 50);
    
    // Add event listeners
    this._boundKeydown = this.handleKeydown.bind(this);
    this._boundBackdrop = this.handleBackdropClick.bind(this);
    document.addEventListener('keydown', this._boundKeydown);
    modal.addEventListener('click', this._boundBackdrop);
  },
  
  close() {
    if (!this.activeModal) return;
    
    const modal = this.activeModal;
    
    // Hide modal
    modal.classList.remove('active');
    
    // Restore body scroll
    document.body.style.overflow = '';
    
    // Restore previous focus
    if (this.previousFocus && this.previousFocus.focus) {
      this.previousFocus.focus();
    }
    
    // Remove event listeners
    document.removeEventListener('keydown', this._boundKeydown);
    modal.removeEventListener('click', this._boundBackdrop);
    
    this.activeModal = null;
  },
  
  handleKeydown(e) {
    if (e.key === 'Escape') {
      this.close();
      return;
    }
    
    // Focus trap - keep Tab within modal
    if (e.key === 'Tab' && this.activeModal) {
      const focusables = this.activeModal.querySelectorAll(
        'button:not([disabled]), input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"])'
      );
      if (focusables.length === 0) return;
      
      const first = focusables[0];
      const last = focusables[focusables.length - 1];
      
      if (e.shiftKey && document.activeElement === first) {
        e.preventDefault();
        last.focus();
      } else if (!e.shiftKey && document.activeElement === last) {
        e.preventDefault();
        first.focus();
      }
    }
  },
  
  handleBackdropClick(e) {
    // Close only if clicking the backdrop itself, not the content
    if (e.target === this.activeModal) {
      this.close();
    }
  }
};

// ==================== AUTOCOMPLETE ====================
const Autocomplete = {
  activeInput: null,
  dropdown: null,
  debounceTimer: null,
  selectedIndex: -1,
  results: { agencies: [], recipients: [] },
  
  init(inputId) {
    const input = document.getElementById(inputId);
    if (!input) return;
    
    // Wrap input if not already wrapped
    if (!input.parentElement.classList.contains('autocomplete-wrapper')) {
      const wrapper = document.createElement('div');
      wrapper.className = 'autocomplete-wrapper';
      input.parentNode.insertBefore(wrapper, input);
      wrapper.appendChild(input);
    }
    
    // Create dropdown
    const dropdown = document.createElement('div');
    dropdown.className = 'autocomplete-dropdown';
    dropdown.id = `${inputId}-dropdown`;
    input.parentElement.appendChild(dropdown);
    
    // Event listeners
    input.addEventListener('input', (e) => this.handleInput(e, inputId));
    input.addEventListener('keydown', (e) => this.handleKeydown(e, inputId));
    input.addEventListener('focus', (e) => this.handleFocus(e, inputId));
    input.addEventListener('blur', () => setTimeout(() => this.hide(inputId), 200));
  },
  
  handleInput(e, inputId) {
    const query = e.target.value.trim();
    clearTimeout(this.debounceTimer);
    
    if (query.length < 2) {
      this.hide(inputId);
      return;
    }
    
    this.debounceTimer = setTimeout(() => this.search(query, inputId), 250);
  },
  
  handleFocus(e, inputId) {
    const query = e.target.value.trim();
    if (query.length >= 2 && this.hasResults()) {
      this.show(inputId);
    }
  },
  
  handleKeydown(e, inputId) {
    const dropdown = document.getElementById(`${inputId}-dropdown`);
    if (!dropdown || !dropdown.classList.contains('active')) {
      if (e.key === 'ArrowDown' && e.target.value.length >= 2) {
        this.search(e.target.value.trim(), inputId);
      }
      return;
    }
    
    const items = dropdown.querySelectorAll('.autocomplete-item');
    
    if (e.key === 'ArrowDown') {
      e.preventDefault();
      this.selectedIndex = Math.min(this.selectedIndex + 1, items.length - 1);
      this.updateSelection(items);
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      this.selectedIndex = Math.max(this.selectedIndex - 1, 0);
      this.updateSelection(items);
    } else if (e.key === 'Enter' && this.selectedIndex >= 0) {
      e.preventDefault();
      items[this.selectedIndex]?.click();
    } else if (e.key === 'Escape') {
      this.hide(inputId);
    }
  },
  
  updateSelection(items) {
    items.forEach((item, i) => {
      item.classList.toggle('selected', i === this.selectedIndex);
    });
    items[this.selectedIndex]?.scrollIntoView({ block: 'nearest' });
  },
  
  async search(query, inputId) {
    try {
      const [agencies, recipients] = await Promise.all([
        API.autocompleteAgency(query),
        API.autocompleteRecipient(query)
      ]);
      
      this.results = { agencies, recipients };
      this.selectedIndex = -1;
      this.render(inputId);
    } catch (e) {
      console.error('Autocomplete error:', e);
    }
  },
  
  hasResults() {
    return this.results.agencies.length > 0 || 
           this.results.recipients.length > 0;
  },
  
  render(inputId) {
    const dropdown = document.getElementById(`${inputId}-dropdown`);
    if (!dropdown) return;
    
    const { agencies, recipients } = this.results;
    
    if (!this.hasResults()) {
      dropdown.innerHTML = '<div class="autocomplete-empty">No matches found</div>';
      this.show(inputId);
      return;
    }
    
    let html = '';
    
    if (agencies.length > 0) {
      html += `<div class="autocomplete-section">
        <div class="autocomplete-section-label mono muted upper"><i class="fas fa-landmark"></i> Agencies</div>
        ${agencies.slice(0, 5).map(a => `
          <div class="autocomplete-item" data-type="agency" data-value="${this.escapeHtml(a.subtier_agency?.name || a.toptier_agency?.name || '')}">
            <i class="fas fa-building muted"></i>
            <div class="autocomplete-item-text">
              <div class="autocomplete-item-main truncate">${this.escapeHtml(a.subtier_agency?.name || a.toptier_agency?.name || 'Unknown')}</div>
              ${a.toptier_agency?.name && a.subtier_agency?.name ? `<div class="autocomplete-item-sub muted">${this.escapeHtml(a.toptier_agency.name)}</div>` : ''}
            </div>
          </div>
        `).join('')}
      </div>`;
    }
    
    if (recipients.length > 0) {
      html += `<div class="autocomplete-section">
        <div class="autocomplete-section-label mono muted upper"><i class="fas fa-briefcase"></i> Vendors & Keywords</div>
        ${recipients.slice(0, 5).map(r => `
          <div class="autocomplete-item" data-type="recipient" data-value="${this.escapeHtml(r.recipient_name || '')}">
            <i class="fas fa-briefcase muted"></i>
            <div class="autocomplete-item-text">
              <div class="autocomplete-item-main truncate">${this.escapeHtml(r.recipient_name || 'Unknown')}</div>
              ${r.uei ? `<div class="autocomplete-item-sub muted">UEI: ${r.uei}</div>` : ''}
            </div>
          </div>
        `).join('')}
      </div>`;
    }
    
    dropdown.innerHTML = html;
    
    // Add click handlers
    dropdown.querySelectorAll('.autocomplete-item').forEach(item => {
      item.addEventListener('click', () => {
        const input = document.getElementById(inputId);
        if (input) {
          input.value = item.dataset.value;
          input.focus();
        }
        this.hide(inputId);
      });
    });
    
    this.show(inputId);
  },
  
  show(inputId) {
    const dropdown = document.getElementById(`${inputId}-dropdown`);
    if (dropdown) dropdown.classList.add('active');
  },
  
  hide(inputId) {
    const dropdown = document.getElementById(`${inputId}-dropdown`);
    if (dropdown) dropdown.classList.remove('active');
    this.selectedIndex = -1;
  },
  
  escapeHtml(str) {
    if (!str) return '';
    return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
  }
};

// ==================== API ====================
const API = {
  baseUrl: 'https://api.usaspending.gov/api/v2',
  
  // Search Mode API
  async searchAwards(keywords) {
    const today = new Date();
    const oneYearAgo = new Date();
    oneYearAgo.setFullYear(today.getFullYear() - 1);
    
    const period = {
      start_date: Utils.formatDateISO(oneYearAgo),
      end_date: Utils.formatDateISO(today)
    };
    
    const terms = keywords.split(',').map(s => s.trim()).filter(s => s.length > 0);
    
    const fetchPromises = terms.map(term => {
      return fetch(`${this.baseUrl}/search/spending_by_award/`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          filters: { 
            keywords: [term], 
            time_period: [period],
            award_type_codes: ['A','B','C','D']
          },
          fields: [
            'Award ID', 'Recipient Name', 'Awarding Agency', 'Awarding Sub Agency',
            'Award Amount', 'Description', 'generated_internal_id',
            'Start Date', 'End Date', 'NAICS Code', 'NAICS Description', 'PSC Code', 'PSC Description'
          ],
          limit: 100,
          sort: 'Award Amount',
          order: 'desc'
        })
      }).then(res => res.json());
    });
    
    const results = await Promise.all(fetchPromises);
    let combined = [];
    results.forEach(json => {
      if(json.results) combined = combined.concat(json.results);
    });
    
    // Deduplicate
    const unique = new Map();
    combined.forEach(item => {
      if(!unique.has(item['Award ID'])) unique.set(item['Award ID'], item);
    });
    
    return Array.from(unique.values()).sort((a,b) => b['Award Amount'] - a['Award Amount']);
  },
  
  // Forecast Mode APIs
  async getSpendingOverTime(keywords, yearsBack=4) {
    const curFY = Utils.getCurrentFY();
    const periods = [];
    // Get extra history to establish trends
    for(let y=curFY-yearsBack; y<=curFY; y++) {
      periods.push({start_date:`${y-1}-10-01`, end_date:`${y}-09-30`});
    }
    
    const res = await fetch(`${this.baseUrl}/search/spending_over_time/`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        group: 'quarter',
        filters: { keywords:[keywords], time_period:periods, award_type_codes:['A','B','C','D'] }
      })
    });
    return (await res.json()).results || [];
  },
  
  async getAgencyData(keywords, yearsBack=3) {
    const curFY = Utils.getCurrentFY();
    const periods = [{start_date:`${curFY-yearsBack-1}-10-01`, end_date:`${curFY}-09-30`}];
    
    const res = await fetch(`${this.baseUrl}/search/spending_by_category/awarding_agency`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        category: 'awarding_agency',
        filters: { keywords:[keywords], time_period:periods, award_type_codes:['A','B','C','D'] },
        limit: 100
      })
    });
    return (await res.json()).results || [];
  },
  
  async getAwardsForForecast(keywords) {
    // Use same 12-month period as searchAwards for consistency
    const today = new Date();
    const oneYearAgo = new Date();
    oneYearAgo.setFullYear(today.getFullYear() - 1);
    
    const period = {
      start_date: Utils.formatDateISO(oneYearAgo),
      end_date: Utils.formatDateISO(today)
    };
    
    const res = await fetch(`${this.baseUrl}/search/spending_by_award/`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        filters: { keywords:[keywords], time_period:[period], award_type_codes:['A','B','C','D'] },
        fields: [
          'Award ID', 'Recipient Name', 'Description', 'Start Date', 'End Date', 
          'Award Amount', 'Awarding Agency', 'Awarding Sub Agency', 'generated_internal_id',
          'NAICS Code', 'NAICS Description', 'PSC Code', 'PSC Description'
        ],
        limit: 100, 
        sort: 'Award Amount',
        order: 'desc'
      })
    });
    return (await res.json()).results || [];
  },

  // ==================== NEW: AUTOCOMPLETE ====================
  async autocompleteAgency(searchText) {
    if (!searchText || searchText.length < 2) return [];
    const res = await fetch(`${this.baseUrl}/autocomplete/awarding_agency/`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ search_text: searchText, limit: 8 })
    });
    return (await res.json()).results || [];
  },

  async autocompleteRecipient(searchText) {
    if (!searchText || searchText.length < 2) return [];
    const res = await fetch(`${this.baseUrl}/autocomplete/recipient/`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ search_text: searchText, limit: 8 })
    });
    return (await res.json()).results || [];
  },

  // ==================== SPENDING BY GEOGRAPHY ====================
  async getSpendingByGeography(keywords, geoLayer = 'state') {
    const curFY = Utils.getCurrentFY();
    const res = await fetch(`${this.baseUrl}/search/spending_by_geography/`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        scope: 'place_of_performance',
        geo_layer: geoLayer,
        filters: { 
          keywords: [keywords], 
          time_period: [{start_date: `${curFY-1}-10-01`, end_date: `${curFY}-09-30`}],
          award_type_codes: ['A','B','C','D'] 
        }
      })
    });
    return (await res.json()).results || [];
  }
};

// ==================== GEOGRAPHY MAP ====================
const GeoMap = {
  stateNames: {
    'AL':'Alabama','AK':'Alaska','AZ':'Arizona','AR':'Arkansas','CA':'California',
    'CO':'Colorado','CT':'Connecticut','DE':'Delaware','FL':'Florida','GA':'Georgia',
    'HI':'Hawaii','ID':'Idaho','IL':'Illinois','IN':'Indiana','IA':'Iowa',
    'KS':'Kansas','KY':'Kentucky','LA':'Louisiana','ME':'Maine','MD':'Maryland',
    'MA':'Massachusetts','MI':'Michigan','MN':'Minnesota','MS':'Mississippi','MO':'Missouri',
    'MT':'Montana','NE':'Nebraska','NV':'Nevada','NH':'New Hampshire','NJ':'New Jersey',
    'NM':'New Mexico','NY':'New York','NC':'North Carolina','ND':'North Dakota','OH':'Ohio',
    'OK':'Oklahoma','OR':'Oregon','PA':'Pennsylvania','RI':'Rhode Island','SC':'South Carolina',
    'SD':'South Dakota','TN':'Tennessee','TX':'Texas','UT':'Utah','VT':'Vermont',
    'VA':'Virginia','WA':'Washington','WV':'West Virginia','WI':'Wisconsin','WY':'Wyoming',
    'DC':'Washington DC','PR':'Puerto Rico','GU':'Guam','VI':'Virgin Islands'
  },
  
  async loadAndRender(containerId, keywords) {
    const container = document.getElementById(containerId);
    if (!container) return;
    
    container.innerHTML = `
      <div class="geo-map-header">
        <div class="geo-map-title"><i class="fas fa-map-marker-alt"></i> Performance Location</div>
        <div class="geo-map-total">Loading...</div>
      </div>
      <div class="geo-states-grid">
        <div style="grid-column: 1/-1; text-align:center; padding:2rem; color:var(--text-muted);">
          <i class="fas fa-spinner fa-spin"></i> Loading geography data...
        </div>
      </div>
    `;
    
    try {
      const data = await API.getSpendingByGeography(keywords, 'state');
      this.render(container, data);
    } catch (e) {
      container.innerHTML = `
        <div class="geo-map-header">
          <div class="geo-map-title"><i class="fas fa-map-marker-alt"></i> Performance Location</div>
        </div>
        <div style="text-align:center; padding:1rem; color:var(--text-muted); font-size:0.85rem;">
          Unable to load geography data
        </div>
      `;
    }
  },
  
  render(container, data) {
    if (!data || data.length === 0) {
      container.innerHTML = `
        <div class="geo-map-header">
          <div class="geo-map-title"><i class="fas fa-map-marker-alt"></i> Performance Location</div>
        </div>
        <div style="text-align:center; padding:1rem; color:var(--text-muted); font-size:0.85rem;">
          No geographic data available
        </div>
      `;
      return;
    }
    
    // Sort by amount descending
    const sorted = data
      .filter(d => d.aggregated_amount > 0)
      .sort((a, b) => b.aggregated_amount - a.aggregated_amount);
    
    const total = sorted.reduce((sum, d) => sum + d.aggregated_amount, 0);
    const maxAmount = sorted[0]?.aggregated_amount || 1;
    
    const statesHtml = sorted.slice(0, 20).map(d => {
      const stateCode = d.shape_code || d.display_name;
      const stateName = this.stateNames[stateCode] || d.display_name || stateCode;
      
      return `
        <div class="geo-state-item">
          <span class="geo-state-name truncate">${stateName}</span>
          <span class="geo-state-amount mono accent">${Utils.money(d.aggregated_amount)}</span>
        </div>
      `;
    }).join('');
    
    container.innerHTML = `
      <div class="geo-map-header">
        <div class="geo-map-title mono text-sm muted upper"><i class="fas fa-map-marker-alt"></i> Top Performance Locations</div>
        <div class="geo-map-total mono accent">${Utils.money(total)} across ${sorted.length} states</div>
      </div>
      <div class="geo-states-grid">${statesHtml}</div>
    `;
  }
};

// ==================== FORECAST ENGINE (ENHANCED WITH MCKINSEY-STYLE RIGOR) ====================
const ForecastEngine = {
  analyze(spendingData, awardsData, agencyData) {
    const organized = this.organizeByQuarter(spendingData);
    const filtered = this.filterOutliers(organized);
    const seasonalProfile = this.calculateSeasonalProfile(filtered);
    const annualForecast = this.calculateAnnualForecast(filtered);
    const recompetes = this.detectRecompetes(awardsData);
    const market = this.analyzeMarketConcentration(agencyData);
    const volatility = this.calculateVolatilityMetrics(filtered);
    const scenarios = this.generateScenarios(annualForecast, volatility, filtered);
    const forecasts = this.generateForecasts(annualForecast, seasonalProfile, filtered, volatility);
    const vendorAnalysis = this.analyzeVendorLandscape(awardsData);
    // Generate strategy (used internally for text generation)
    this.generateStrategy(forecasts, market.hhi, recompetes, scenarios, vendorAnalysis);
    
    return { 
      recompetes, 
      marketStatus: market.level, 
      hhi: market.hhi, 
      byFY: organized.byFY, 
      volatility
    };
  },

  organizeByQuarter(spendingData) {
    const organized = { byFY: {}, byQuarter: {}, totalByFY: {}, allAmounts: [] };
    spendingData.forEach(d => {
      const q = parseInt(d.time_period?.quarter); 
      const fy = parseInt(d.time_period?.fiscal_year); 
      const amt = d.aggregated_amount || 0;
      if(q && fy) {
        if(!organized.byFY[fy]) organized.byFY[fy] = {1:0, 2:0, 3:0, 4:0};
        organized.byFY[fy][q] = amt; 
        if(!organized.byQuarter[q]) organized.byQuarter[q] = [];
        organized.byQuarter[q].push({fy, amt}); 
        organized.totalByFY[fy] = (organized.totalByFY[fy] || 0) + amt;
        organized.allAmounts.push({fy, q, amt});
      }
    });
    return organized;
  },

  filterOutliers(organized) {
    const filtered = { byFY: {}, byQuarter: {}, totalByFY: {}, allAmounts: [] };
    Object.keys(organized.byFY).forEach(fy => filtered.byFY[fy] = {});
    for(let q=1; q<=4; q++) {
      const qData = organized.byQuarter[q] || []; 
      const amounts = qData.map(d => d.amt);
      if(amounts.length < 3) {
        qData.forEach(d => { 
           filtered.byQuarter[q] = filtered.byQuarter[q] || []; 
           filtered.byQuarter[q].push(d); 
           filtered.byFY[d.fy][q] = d.amt; 
           filtered.totalByFY[d.fy] = (filtered.totalByFY[d.fy]||0) + d.amt; 
        });
        continue;
      }
      const mean = amounts.reduce((a,b)=>a+b,0) / amounts.length;
      const variance = amounts.reduce((s,v)=>s+Math.pow(v-mean,2),0) / amounts.length;
      const stdDev = Math.sqrt(variance);
      const limit = mean + (2 * stdDev);
      qData.forEach(item => {
        if(item.amt <= limit) {
           filtered.byQuarter[q] = filtered.byQuarter[q] || []; 
           filtered.byQuarter[q].push(item); 
           filtered.byFY[item.fy][q] = item.amt; 
           filtered.totalByFY[item.fy] = (filtered.totalByFY[item.fy]||0) + item.amt;
        }
      });
    }
    return filtered;
  },

  calculateSeasonalProfile(filtered) {
    const quarters = {1:0, 2:0, 3:0, 4:0}; 
    const counts = {1:0, 2:0, 3:0, 4:0};
    Object.keys(filtered.totalByFY).forEach(fy => {
        const total = filtered.totalByFY[fy]; 
        if(total <= 0) return;
        const qWithData = Object.values(filtered.byFY[fy]).filter(v => v > 0).length;
        if(qWithData < 3) return;
        for(let q=1; q<=4; q++) { 
            const amt = filtered.byFY[fy][q] || 0;
            quarters[q] += (amt / total); 
            counts[q]++; 
        }
    });
    const profile = {}; 
    let sum = 0;
    for(let q=1; q<=4; q++) { 
        profile[q] = counts[q] ? quarters[q] / counts[q] : 0.25; 
        sum += profile[q]; 
    }
    for(let q=1; q<=4; q++) profile[q] = profile[q] / sum;
    return profile;
  },

  calculateAnnualForecast(filtered) {
    const curFY = Utils.getCurrentFY();
    const years = Object.keys(filtered.totalByFY).map(Number).sort((a,b)=>a-b);
    const cleanYears = years.filter(y => y < curFY && filtered.totalByFY[y] > 0);
    if(cleanYears.length === 0) return 0;
    
    let weightedSum = 0; 
    let weightTotal = 0;
    cleanYears.forEach((fy, index) => { 
        const weight = index + 1; 
        weightedSum += filtered.totalByFY[fy] * weight; 
        weightTotal += weight; 
    });
    
    let baseline = weightedSum / weightTotal;
    if(cleanYears.length >= 2) {
        const recentYear = filtered.totalByFY[cleanYears[cleanYears.length-1]];
        baseline = (baseline * 0.7) + (recentYear * 0.3);
    }
    return baseline;
  },

  // Calculate volatility metrics
  calculateVolatilityMetrics(filtered) {
    const curFY = Utils.getCurrentFY();
    const years = Object.keys(filtered.totalByFY).map(Number).filter(y => y < curFY).sort();
    
    if (years.length < 2) {
      return { stdDev: 0, coeffVar: 0, score: 0.5 };
    }
    
    const amounts = years.map(y => filtered.totalByFY[y]);
    const mean = amounts.reduce((a, b) => a + b, 0) / amounts.length;
    const variance = amounts.reduce((s, v) => s + Math.pow(v - mean, 2), 0) / (amounts.length - 1);
    const stdDev = Math.sqrt(variance);
    const coeffVar = mean > 0 ? (stdDev / mean) : 0;
    
    return {
      stdDev,
      coeffVar,
      // Scale coeffVar (typically 0.1-0.5) to 0-1 range where 1 = very volatile
      score: Math.min(coeffVar * 2.5, 1)
    };
  },

  // Generate scenarios
  generateScenarios(baseline, volatility, filtered) {
    const coeffVar = volatility.coeffVar || 0.2;
    const scaleFactor = Math.min(coeffVar, 0.4);
    
    return {
      conservative: { value: baseline * (1 - scaleFactor) },
      base: { value: baseline },
      aggressive: { value: baseline * (1 + scaleFactor) }
    };
  },

  // Analyze vendor landscape for competitive rivalry assessment
  analyzeVendorLandscape(awards) {
    const vendorMap = {};
    let totalSpend = 0;
    
    awards.forEach(a => {
      const vendor = a['Recipient Name'] || 'Unknown';
      const amt = parseFloat(a['Award Amount']) || 0;
      if (amt > 0) {
        vendorMap[vendor] = (vendorMap[vendor] || 0) + amt;
        totalSpend += amt;
      }
    });
    
    // Calculate CR4 (4-firm concentration ratio)
    const shares = Object.values(vendorMap)
      .map(spend => totalSpend > 0 ? (spend / totalSpend) * 100 : 0)
      .sort((a, b) => b - a);
    const cr4 = shares.slice(0, 4).reduce((s, v) => s + v, 0);
    
    // Determine rivalry level
    let rivalryLevel = 'Moderate';
    if (cr4 > 80) rivalryLevel = 'Low (Oligopoly)';
    else if (cr4 > 60) rivalryLevel = 'Moderate';
    else if (cr4 > 40) rivalryLevel = 'High';
    else rivalryLevel = 'Very High';
    
    return { rivalryLevel };
  },

  analyzeMarketConcentration(agencyData) {
    const total = agencyData.reduce((s,a)=>s+a.amount,0); 
    let hhi = 0;
    agencyData.forEach(a => { 
      const share = (a.amount / total) * 100; 
      hhi += share * share; 
    });
    
    // CR4 for agencies (buyer concentration)
    const sorted = [...agencyData].sort((a, b) => b.amount - a.amount);
    const cr4 = sorted.slice(0, 4).reduce((s, a) => s + (a.amount / total) * 100, 0);
    
    let level = "Competitive";
    let buyerPower = "Low";
    
    if(hhi > 2500) { level = "Concentrated"; buyerPower = "High"; }
    else if(hhi > 1500) { level = "Moderate"; buyerPower = "Medium"; }
    
    return { 
      hhi: Math.round(hhi), 
      level, 
      cr4: Math.round(cr4),
      buyerPower,
      agencyCount: agencyData.length 
    };
  },

  detectRecompetes(awards) {
  const now = new Date(); 
  const sixMonths = new Date(); sixMonths.setMonth(now.getMonth() + 6); 
  const twoYears = new Date(); twoYears.setFullYear(now.getFullYear()+2);
  
  return awards
    .filter(a => { 
      const end = new Date(a['End Date']); 
      return end > now && end < twoYears && a['Award Amount'] > 50000; 
    })
    .sort((a, b) => new Date(a['End Date']) - new Date(b['End Date']))
    .slice(0, 15);
},

  generateForecasts(annualForecast, seasonalProfile, filtered, volatility) {
    const forecasts = []; 
    const curFY = Utils.getCurrentFY(); 
    const curQ = Utils.getCurrentQuarter();
    
    let fy = curFY; 
    let q = curQ;
    
    // Calculate quarterly standard deviation for confidence bands
    const quarterlyStdDev = (volatility.stdDev || annualForecast * 0.2) / 2;
    
    for(let i=0; i<4; i++) {
      const predicted = annualForecast * seasonalProfile[q];
      const qHistory = filtered.byQuarter[q] || [];
      const activeYears = qHistory.filter(d => d.amt > 0).sort((a,b) => a.fy - b.fy);
      const trueAvg = qHistory.length ? qHistory.reduce((s, d) => s + d.amt, 0) / qHistory.length : 0;
      
      // Calculate quarterly volatility
      let qVolatility = 0;
      if(activeYears.length > 1) {
          const activeAvg = activeYears.reduce((s, d) => s + d.amt, 0) / activeYears.length;
          const variance = activeYears.reduce((s, d) => s + Math.pow(d.amt - activeAvg, 2), 0) / (activeYears.length - 1);
          qVolatility = Math.sqrt(variance) / activeAvg;
      }

      // Check for consistent growth pattern
      let isStrictGrowth = false;
      if (activeYears.length >= 3) {
          isStrictGrowth = true;
          for(let k=1; k<activeYears.length; k++) {
              if (activeYears[k].amt <= activeYears[k-1].amt) {
                  isStrictGrowth = false;
                  break;
              }
          }
      }

      let displayTrend = 0;
      if(trueAvg > 0) displayTrend = ((predicted - trueAvg) / trueAvg) * 100;
      else if (predicted > 0) displayTrend = 100;

      // Confidence logic
      let confLabel = "Low";
      let confReason = "Insufficient Data";

      if (qHistory.length === 0) {
          confLabel = "Low"; confReason = "No History";
      } else if (activeYears.length === 0) {
          confLabel = "Low"; confReason = "Inactive";
      } else {
          const isFrequent = activeYears.length >= 3;
          const hasGaps = activeYears.length < qHistory.length; 
          
          if (isFrequent && !hasGaps) {
              if (isStrictGrowth) {
                  confLabel = "High";
                  confReason = "Consistent Growth";
              } else if (qVolatility < 0.5) {
                  confLabel = "High";
                  confReason = "Stable Trend";
              } else if (qVolatility < 1.0) {
                  confLabel = "Med";
                  confReason = "Moderate Variance";
              } else {
                  confLabel = "Low";
                  confReason = "High Volatility";
              }
          } 
          else if (isFrequent && hasGaps) {
              confLabel = "Med"; confReason = "Intermittent";
          } 
          else {
              if (qVolatility < 0.2) { confLabel = "Med"; confReason = "Limited but Stable"; }
              else { confLabel = "Low"; confReason = "Limited History"; }
          }
      }

      // Calculate confidence interval for this quarter
      const qStdDev = qVolatility > 0 ? trueAvg * qVolatility : quarterlyStdDev * seasonalProfile[q];
      
      forecasts.push({
        // Updated to Standard Format: FY26 Q1
        period: `FY${String(fy).slice(-2)} Q${q}`,
        predicted: predicted,
        histAvg: trueAvg,
        trend: displayTrend > 0 ? `+${displayTrend.toFixed(1)}` : displayTrend.toFixed(1),
        confidence: { label: confLabel, reason: confReason },
        range: {
          low: Math.max(0, predicted - (1.645 * qStdDev)),
          high: predicted + (1.645 * qStdDev)
        }
      });
      
      q++;
      if(q > 4) { q = 1; fy++; }
    }
    return forecasts;
  },
  
  generateStrategy(forecasts, hhi, recompetes, scenarios, vendorAnalysis) {
    if(!forecasts || forecasts.length < 2) return null;

    const nearTerm = forecasts.slice(0, 2);
    const avgGrowth = nearTerm.reduce((sum, f) => sum + parseFloat(f.trend), 0) / nearTerm.length;
    
    let growthSignal = "Moderate";
    if (avgGrowth > 30) growthSignal = "High Growth"; 
    else if (avgGrowth < -20) growthSignal = "Decline";

    let marketType = "Moderate";
    if (hhi > 2500) marketType = "Concentrated";
    else if (hhi < 1500) marketType = "Competitive";

    // Strategic framework text
    let outlook = "";
    let action = "";
    
    if (growthSignal === "High Growth") {
        outlook = `Growth trajectory indicates expanding TAM (+${avgGrowth.toFixed(1)}% projected vs. historical). `;
        if (scenarios) {
          outlook += `Scenario analysis suggests range of ${Utils.money(scenarios.conservative.value)} to ${Utils.money(scenarios.aggressive.value)}. `;
        }
        outlook += `Market conditions favor aggressive pursuit, but validate pipeline depth before resource commitment.`;
        action = "Prioritize market share capture. Assess delivery capacity constraints. Consider strategic teaming to scale.";
    } else if (growthSignal === "Decline") {
        outlook = `Contraction signals evident (${avgGrowth.toFixed(1)}% below historical baseline). `;
        outlook += `This may indicate budget reallocation, program completion, or increased competitive pressure. `;
        outlook += `Defensive positioning recommended.`;
        action = "Focus on incumbent retention. Pursue high-probability recompetes only. Avoid speculative captures.";
    } else {
        outlook = `Stable market conditions with spending tracking historical norms. `;
        if (scenarios) {
          outlook += `Base case projects ${Utils.money(scenarios.base.value)} annual TAM. `;
        }
        outlook += `Predictable environment favors methodical capture execution over volume bidding.`;
        action = "Maintain steady BD cadence. Emphasize win probability over pipeline volume. Invest in differentiators.";
    }

    if (marketType === "Concentrated") {
        outlook += ` High vendor concentration (HHI ${hhi}) indicates incumbent dominanceâ€”relationship-based strategies outperform price competition.`;
        action += " Partner with established primes. Focus on subcontracting opportunities.";
    } else if (marketType === "Competitive") {
        outlook += ` Fragmented vendor landscape (HHI ${hhi}) creates opportunities for differentiated offerings and aggressive pricing.`;
        action += " Emphasize unique value proposition. Consider aggressive pricing on strategic wins.";
    }

    // Add vendor rivalry insight
    if (vendorAnalysis && vendorAnalysis.rivalryLevel) {
      outlook += ` Competitive rivalry: ${vendorAnalysis.rivalryLevel}.`;
    }

    const matrix = {
        bd: growthSignal === "High Growth" ? "Expand Investment" : (growthSignal === "Decline" ? "Selective Focus" : "Maintain Steady"),
        strat: marketType === "Concentrated" ? "Relationship-Led" : (marketType === "Competitive" ? "Value-Led" : "Balanced"),
        pipe: recompetes.length > 5 ? "Recompete Heavy" : "New Opportunity Focus"
    };

    return {
        title: growthSignal === "High Growth" ? "Growth Market" : (growthSignal === "Decline" ? "Contracting Market" : "Stable Market"),
        text: outlook,
        action: action,
        matrix: matrix,
        growthSignal,
        marketType
    };
  }
};
// ==================== KNOWN VENDORS DATABASE ====================
const KnownVendors = {
  // Known VARs/Resellers
  vars: new Set([
    'CARAHSOFT TECHNOLOGY CORP', 'CARAHSOFT TECHNOLOGY CORPORATION',
    'CDW GOVERNMENT LLC', 'CDW-G',
    'SHI INTERNATIONAL CORP', 'SHI GOVERNMENT SOLUTIONS',
    'INSIGHT PUBLIC SECTOR INC', 'INSIGHT DIRECT USA INC',
    'GOVPLACE, LLC', 'GOVPLACE LLC',
    'IMMIX GROUP INC', 'IMMIXGROUP INC',
    'DLT SOLUTIONS LLC', 'DLT SOLUTIONS',
    'THUNDERCAT TECHNOLOGY, LLC', 'THUNDERCAT TECHNOLOGY LLC',
    'WORLD WIDE TECHNOLOGY LLC', 'WWT GOVERNMENT SERVICES',
    'PRESIDIO NETWORKED SOLUTIONS', 'PRESIDIO GOVERNMENT SOLUTIONS',
    'CONNECTION', 'PC CONNECTION', 'PCMG INC',
    'EN POINTE TECHNOLOGIES',
    'STERLING COMPUTERS CORPORATION', 'STERLING COMPUTERS',
    'MERLIN INTERNATIONAL', 'RED RIVER TECHNOLOGY',
    'MYTHICS INC', 'MYTHICS LLC',
    'FOUR POINTS TECHNOLOGY', 'FOUR POINTS TECHNOLOGY LLC',
    'SILOTECH GROUP INC', 'DECISIVE COMMUNICATIONS INC',
    'FCN INC', 'FCN, INC.',
    'SOFTCHOICE CORPORATION', 'SOFTCHOICE',
    'TRACE3', 'OPTIV SECURITY INC', 'OPTIV SECURITY',
    'FEDSTORE CORPORATION', 'FEDSTORE',
    'GOVSMART INC', 'GOVSMART, INC.',
    'NEW TECH SOLUTIONS', 'NEW TECH SOLUTIONS, INC.',
    'PANAMERICA COMPUTERS', 'PANAMERICA COMPUTERS, INC.',
    'SOFTWARE INFORMATION RESOURCE CORP',
    'ACCESSAGILITY LLC', 'BLUE TECH INC', 'BLUE TECH INC.',
    'DH TECHNOLOGIES', 'DH TECHNOLOGIES, INC.',
    'IT1 SOURCE LLC',
    'ENTERPRISE TECHNOLOGY SOLUTIONS', 'ENTERPRISE TECHNOLOGY SOLUTIONS, INC.',
    'DISTRIBUTED TECHNOLOGY GROUP LLC', 'ARCHITECHTURE SOLUTIONS LLC',
    'ADVANCED COMPUTER CONCEPTS', 'ADVANCED COMPUTER CONCEPTS, INC.',
    '4 STAR TECHNOLOGIES', '4 STAR TECHNOLOGIES, INC.',
    'THREE WIRE SYSTEMS', 'THREE WIRE SYSTEMS, LLC',
    'C & C INTERNATIONAL COMPUTERS'
  ]),

  // Known Large Primes/System Integrators
  primes: new Set([
    'BOOZ ALLEN HAMILTON', 'BOOZ ALLEN HAMILTON INC',
    'GENERAL DYNAMICS INFORMATION TECHNOLOGY', 'GENERAL DYNAMICS IT', 'GDIT',
    'LEIDOS INC', 'LEIDOS HOLDINGS', 'LEIDOS',
    'SAIC', 'SCIENCE APPLICATIONS INTERNATIONAL',
    'NORTHROP GRUMMAN', 'RAYTHEON',
    'LOCKHEED MARTIN', 'LOCKHEED MARTIN CORPORATION',
    'BAE SYSTEMS', 'L3HARRIS TECHNOLOGIES',
    'CACI INTERNATIONAL', 'CACI INC',
    'MANTECH INTERNATIONAL', 'MANTECH',
    'PERATON INC', 'PERATON',
    'ACCENTURE FEDERAL SERVICES', 'ACCENTURE',
    'DELOITTE CONSULTING', 'DELOITTE',
    'IBM CORPORATION', 'IBM', 'KPMG',
    'CGI FEDERAL', 'CGI TECHNOLOGIES',
    'MAXIMUS INC', 'MAXIMUS FEDERAL',
    'ICF INTERNATIONAL', 'ICF INC',
    'SERCO INC', 'SERCO',
    'PAE INCORPORATED', 'AMENTUM',
    'JACOBS TECHNOLOGY', 'KBR INC'
  ]),

  // Classify a vendor name
  classify(vendorName) {
    const upper = vendorName.toUpperCase().trim();
    
    // Check exact matches first
    if (this.vars.has(upper)) return 'var';
    if (this.primes.has(upper)) return 'prime';
    
    // Check partial matches
    for (const known of this.vars) {
      if (upper.includes(known) || known.includes(upper)) return 'var';
    }
    for (const known of this.primes) {
      if (upper.includes(known) || known.includes(upper)) return 'prime';
    }
    
    // Pattern-based detection for likely VARs
    const varPatterns = [
      /\b(TECHNOLOGY|TECHNOLOGIES)\s*(CORP|LLC|INC)/i,
      /\b(COMPUTERS?|COMPUTING)\s*(CORP|LLC|INC)/i,
      /\bSOLUTIONS?\s*(CORP|LLC|INC)/i,
      /\bGOV(PLACE|SMART|STORE)/i,
      /\bFEDERAL\s*(SOLUTIONS|TECHNOLOGY)/i
    ];
    
    for (const pattern of varPatterns) {
      if (pattern.test(upper)) return 'likely_var';
    }
    
    return 'unknown';
  }
};
// ==================== ENHANCED SALES PLAN MANAGER ====================
const SalesPlanManager = {
  channels: new Set(),
  currentVendors: [],
  detectedIntent: null,
  
  init() {
    const saved = localStorage.getItem('govhoo_channels');
    if (saved) this.channels = new Set(JSON.parse(saved));
  },

  isChannel(vendorName) { 
    return this.channels.has(vendorName); 
  },

  // ==================== INTENT DETECTION ====================
  detectIntent(awards) {
    const query = App.currentQuery || '';
    const vendorSpend = {};
    let totalSpend = 0;
    
    awards.forEach(r => {
      const v = r['Recipient Name'] || 'Unknown';
      const a = parseFloat(r['Award Amount']) || 0;
      vendorSpend[v] = (vendorSpend[v] || 0) + a;
      totalSpend += a;
    });
    
    const vendors = Object.entries(vendorSpend)
      .map(([name, spend]) => ({ name, spend, share: spend / totalSpend }))
      .sort((a, b) => b.spend - a.spend);
    
    // Calculate channel metrics
    let channelSpend = 0;
    let channelCount = 0;
    vendors.forEach(v => {
      if (this.isChannel(v.name)) {
        channelSpend += v.spend;
        channelCount++;
      }
    });
    const channelShare = totalSpend > 0 ? channelSpend / totalSpend : 0;
    
    // Detect Product/OEM (high channel share)
    if (channelShare > 0.7 && channelCount >= 3) {
      return {
        type: 'product_oem',
        icon: 'fa-box',
        title: 'PRODUCT / OEM CHANNEL',
        description: `${(channelShare * 100).toFixed(1)}% of revenue flows through ${channelCount} channel partners`,
        focusAreas: [
          'Channel performance & rankings',
          'Partner enablement priorities', 
          'Recompete defense by partner',
          'Agency coverage gaps'
        ],
        suggestedGoal: 'Partnership'
      };
    }
    
    // Detect own company search
    const topVendor = vendors[0];
    if (topVendor && query.toLowerCase().includes(topVendor.name.toLowerCase().split(' ')[0])) {
      return {
        type: 'own_company',
        icon: 'fa-building',
        title: 'YOUR COMPANY ANALYSIS',
        description: `Analyzing your market position: ${Utils.money(topVendor.spend)} (${(topVendor.share * 100).toFixed(1)}% share)`,
        focusAreas: [
          'Defend existing contracts',
          'Identify growth opportunities',
          'Competitive threats to your position',
          'Recompete calendar & defense'
        ],
        suggestedGoal: 'Retention'
      };
    }
    
    // Detect agency search
    const agencyKeywords = ['department', 'agency', 'administration', 'commission', 'bureau'];
    if (agencyKeywords.some(kw => query.toLowerCase().includes(kw))) {
      return {
        type: 'agency',
        icon: 'fa-landmark',
        title: 'AGENCY PENETRATION',
        description: `Analyzing how to enter or expand within this customer`,
        focusAreas: [
          'Agency mission & budget priorities',
          'Current vendor landscape',
          'Entry points & opportunities',
          'Key contracting vehicles'
        ],
        suggestedGoal: 'Growth'
      };
    }
    
    // Default: Market/keyword search
    return {
      type: 'market_keyword',
      icon: 'fa-chart-line',
      title: 'MARKET ANALYSIS',
      description: `Analyzing the "${query}" market landscape`,
      focusAreas: [
        'Market size & growth trends',
        'Competitive landscape',
        'Top agencies & opportunities',
        'Entry strategy recommendations'
      ],
      suggestedGoal: 'Growth'
    };
  },

  // ==================== UI ACTIONS ====================
  open() {
    const awards = App.forecastData.awards || App.searchData.raw || [];
    if (!awards.length) {
      alert("No award data loaded. Please run a search or forecast first.");
      return;
    }

    // Detect intent
    this.detectedIntent = this.detectIntent(awards);
    
    // Populate Agency Dropdown
    const agencyCounts = {};
    awards.forEach(r => {
      const ag = r['Awarding Agency'];
      if(ag) agencyCounts[ag] = (agencyCounts[ag] || 0) + 1;
    });
    
    const sortedAgencies = Object.entries(agencyCounts)
      .sort((a,b) => b[1] - a[1])
      .map(([name, count]) => `<option value="${name}">${name} (${count} awards)</option>`)
      .join('');
      
    document.getElementById('spSpecificAgencies').innerHTML = sortedAgencies;
    document.getElementById('spScope').value = 'all';
    
    // Set suggested goal based on intent
    document.getElementById('spFocus').value = this.detectedIntent.suggestedGoal;

    // Prepare and render
    this.prepareVendorList(awards);
    this.renderIntentBanner();
    this.updateStatus(awards.length, "Entire Market");
    this.renderSmartVendorList();
    
    ModalUtils.open('salesPlanModal');
  },

  close() {
    ModalUtils.close();
    // Also close success modal if open
    const successModal = document.getElementById('copySuccessModal');
    if (successModal) successModal.classList.remove('active');
  },

  // ==================== INTENT BANNER ====================
  renderIntentBanner() {
    const banner = document.getElementById('spIntentBanner');
    if (!banner || !this.detectedIntent) return;
    
    const intent = this.detectedIntent;
    banner.innerHTML = `
      <div class="intent-banner-content">
        <div class="intent-banner-icon"><i class="fas ${intent.icon}"></i></div>
        <div class="intent-banner-text">
          <div class="intent-banner-title">${intent.title}</div>
          <div class="intent-banner-desc">${intent.description}</div>
          <div class="intent-banner-focus">
            ${intent.focusAreas.map(f => `<span class="focus-tag">${f}</span>`).join('')}
          </div>
        </div>
      </div>
    `;
    banner.style.display = 'block';
  },

  // ==================== DATA PROCESSING ====================
  getFilteredData() {
    const scope = document.getElementById('spScope').value;
    const focus = document.getElementById('spFocus').value;
    const rawAwards = App.forecastData.awards || App.searchData.raw || [];
    
    let filteredAwards = [];
    let scopeName = "Entire Market";

    if (scope === 'all') {
      filteredAwards = rawAwards;
    } else if (scope === 'defense') {
      filteredAwards = rawAwards.filter(r => /defense|army|navy|air force|marine|space force/i.test(r['Awarding Agency']));
      scopeName = "Defense Sector";
    } else if (scope === 'civilian') {
      filteredAwards = rawAwards.filter(r => !/defense|army|navy|air force|marine|space force/i.test(r['Awarding Agency']));
      scopeName = "Federal Civilian Sector";
    } else {
      filteredAwards = rawAwards.filter(r => r['Awarding Agency'] === scope);
      scopeName = scope;
    }

    if (filteredAwards.length === 0) throw new Error("No awards found for the selected scope.");

    return { filteredAwards, scopeName, focus };
  },

  // ==================== OUTPUT ACTIONS ====================
  generate() {
    App.showLoader('GENERATING PLAN...', 'Filtering data & packaging prompt...');
    setTimeout(() => {
      try {
        const { filteredAwards, scopeName, focus } = this.getFilteredData();
        const pkg = PromptPackageGenerator.buildPackage(filteredAwards, null, { scope: scopeName, focus });
        PromptPackageGenerator.downloadPackage(pkg);
        this.close();
      } catch(e) { 
        console.error(e); 
        alert(e.message || "Error generating plan");
      } finally { 
        App.hideLoader(); 
      }
    }, 500);
  },

  async copyPrompt() {
    const btn = document.getElementById('btnCopyPrompt');
    if (!btn) return;

    const originalHTML = btn.innerHTML;
    
    // Loading State
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
    btn.style.opacity = '0.7';
    btn.style.pointerEvents = 'none';
    
    try {
      const { filteredAwards, scopeName, focus } = this.getFilteredData();
      const pkg = PromptPackageGenerator.buildPackage(filteredAwards, null, { scope: scopeName, focus });
      
      // Copy to clipboard
      await navigator.clipboard.writeText(pkg);
      
      // Show success modal instead of just changing button
      this.showCopySuccessModal(pkg.length);
      
      // Reset button
      btn.innerHTML = originalHTML;
      btn.style.opacity = '1';
      btn.style.pointerEvents = 'auto';
      
    } catch(e) {
      console.error(e);
      alert(e.message || "Error copying prompt");
      btn.innerHTML = originalHTML;
      btn.style.opacity = '1';
      btn.style.pointerEvents = 'auto';
    }
  },

  // ==================== SUCCESS MODAL ====================
  showCopySuccessModal(charCount) {
    let modal = document.getElementById('copySuccessModal');
    
    if (!modal) {
      // Create modal if it doesn't exist
      modal = document.createElement('div');
      modal.id = 'copySuccessModal';
      modal.className = 'channel-marking-modal';
      document.body.appendChild(modal);
    }
    
    const estimatedTokens = Math.round(charCount / 4);
    
    modal.innerHTML = `
      <div class="channel-modal-content" style="max-width: 420px; height: auto;">
        <div class="channel-modal-header" style="border-bottom-color: var(--accent);">
          <div class="channel-modal-title" style="color: var(--accent);">
            <i class="fas fa-check-circle"></i> Copied to Clipboard
          </div>
          <button class="channel-modal-close" onclick="SalesPlanManager.closeSuccessModal()">
            <i class="fas fa-times"></i>
          </button>
        </div>
        
        <div class="channel-modal-body" style="padding: 1.5rem;">
          <div style="margin-bottom: 1.25rem;">
            <div style="font-size: 0.95rem; color: #fff; font-weight: 500; margin-bottom: 0.25rem;">Your prompt is ready</div>
            <div style="font-size: 0.8rem; color: var(--text-muted);">
              ${charCount.toLocaleString()} chars Â· ~${estimatedTokens.toLocaleString()} tokens
            </div>
          </div>
          
          <div style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.5rem;">
            Open in
          </div>
          <div style="display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 1.25rem;">
            <a href="https://claude.ai/new" target="_blank" class="ai-link-btn claude">
              Claude
            </a>
            <a href="https://chat.openai.com" target="_blank" class="ai-link-btn chatgpt">
              ChatGPT
            </a>
            <a href="https://gemini.google.com" target="_blank" class="ai-link-btn gemini">
              Gemini
            </a>
          </div>
          
          <div style="font-size: 0.75rem; color: var(--text-muted); line-height: 1.5;">
            Paste with <kbd>Ctrl+V</kbd> (or <kbd>âŒ˜V</kbd>) to generate your sales plan.
          </div>
        </div>
        
        <div class="channel-modal-footer" style="justify-content: flex-end;">
          <button class="modal-btn modal-btn-cancel" onclick="SalesPlanManager.closeSuccessModal()">
            Done
          </button>
        </div>
      </div>
    `;
    
    ModalUtils.open('copySuccessModal');
  },

  closeSuccessModal() {
    ModalUtils.close();
    // Also ensure main modal is closed
    document.getElementById('salesPlanModal').classList.remove('active');
    document.body.style.overflow = '';
  },

  // ==================== VENDOR LIST HELPERS ====================
  prepareVendorList(dataSlice) {
    const vendorSpend = {}; 
    let total = 0;
    
    dataSlice.forEach(r => { 
      const v = r['Recipient Name'] || 'Unknown'; 
      const a = parseFloat(r['Award Amount']) || 0; 
      vendorSpend[v] = (vendorSpend[v] || 0) + a; 
      total += a; 
    });
    
    this.currentVendors = Object.entries(vendorSpend)
      .map(([v, s]) => ({ 
        vendor: v, 
        spend: s, 
        marketShare: total > 0 ? ((s / total) * 100).toFixed(2) : "0.00", 
        contractCount: dataSlice.filter(r => r['Recipient Name'] === v).length,
        classification: KnownVendors.classify(v)
      }))
      .sort((a, b) => b.spend - a.spend)
      .slice(0, 30); // Increased to 30 for better coverage
  },

  updateStatus(count, scopeName) {
    const statusEl = document.getElementById('spDataStatus');
    if(!statusEl) return;
    
    const channelCount = this.currentVendors.filter(v => this.isChannel(v.vendor)).length;
    const totalVendors = this.currentVendors.length;
    
    statusEl.innerHTML = `
      <span style="color:var(--success);"><i class="fas fa-check-circle"></i></span>
      Ready Â· ${count} awards Â· ${channelCount}/${totalVendors} channels
    `;
  },

  // ==================== TOGGLE LOGIC ====================
  toggleChannel(vendorName) {
    if (this.channels.has(vendorName)) this.channels.delete(vendorName);
    else this.channels.add(vendorName);
    this.save();
    this.updateStatus(App.forecastData.awards?.length || App.searchData.raw?.length || 0, 
      document.getElementById('spScope')?.value === 'all' ? 'Entire Market' : document.getElementById('spScope')?.value);
  },

  toggleAll() {
    const allMarked = this.currentVendors.every(v => this.isChannel(v.vendor));
    if (allMarked) this.currentVendors.forEach(v => this.channels.delete(v.vendor));
    else this.currentVendors.forEach(v => this.channels.add(v.vendor));
    
    this.save();
    this.renderSmartVendorList();
    this.updateStatus(App.forecastData.awards?.length || App.searchData.raw?.length || 0, 
      document.getElementById('spScope')?.value === 'all' ? 'Entire Market' : document.getElementById('spScope')?.value);
  },

  acceptSuggested() {
    // Mark all suggested VARs as channels
    this.currentVendors.forEach(v => {
      if (v.classification === 'var' || v.classification === 'likely_var') {
        this.channels.add(v.vendor);
      }
    });
    this.save();
    this.renderSmartVendorList();
    this.updateStatus(App.forecastData.awards?.length || App.searchData.raw?.length || 0, 
      document.getElementById('spScope')?.value === 'all' ? 'Entire Market' : document.getElementById('spScope')?.value);
  },

  save() { 
    localStorage.setItem('govhoo_channels', JSON.stringify([...this.channels])); 
  },

  // ==================== SMART VENDOR LIST RENDERING ====================
  renderSmartVendorList() {
    const list = document.getElementById('spVendorList');
    const container = document.getElementById('spBulkActionContainer');
    if(!list || !container) return;

    // Group vendors by classification
    const suggestedVars = this.currentVendors.filter(v => 
      (v.classification === 'var' || v.classification === 'likely_var') && !this.isChannel(v.vendor)
    );
    const primes = this.currentVendors.filter(v => v.classification === 'prime');
    const unknown = this.currentVendors.filter(v => 
      v.classification === 'unknown' && !this.isChannel(v.vendor)
    );
    const alreadyMarked = this.currentVendors.filter(v => this.isChannel(v.vendor));

    const allMarked = this.currentVendors.length > 0 && this.currentVendors.every(v => this.isChannel(v.vendor));
    
    // Bulk action buttons
    container.innerHTML = `
      <div style="display: flex; gap: 0.5rem;">
        ${suggestedVars.length > 0 ? `
          <button onclick="SalesPlanManager.acceptSuggested()" style="background: rgba(76, 175, 80, 0.1); border: 1px solid var(--success); color: var(--success); padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.7rem; font-family: 'JetBrains Mono'; display: flex; align-items: center; gap: 6px;">
            <i class="fas fa-magic"></i> ACCEPT SUGGESTIONS (${suggestedVars.length})
          </button>
        ` : ''}
        <button onclick="SalesPlanManager.toggleAll()" style="background: transparent; border: 1px solid var(--border); color: var(--accent); padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.7rem; font-family: 'JetBrains Mono'; display: flex; align-items: center; gap: 6px;">
          <i class="far ${allMarked ? 'fa-square' : 'fa-check-square'}"></i> ${allMarked ? 'UNMARK ALL' : 'MARK ALL'}
        </button>
      </div>
    `;

    if (this.currentVendors.length === 0) {
      list.innerHTML = `<div style="text-align:center; padding:1rem; color:#666;">No vendors found in this scope.</div>`;
      return;
    }

    let html = '';

    // Already Marked Section
    if (alreadyMarked.length > 0) {
      html += this.renderVendorSection(
        'âœ… MARKED AS CHANNELS',
        'These vendors are already marked as your channel partners',
        alreadyMarked,
        'success'
      );
    }

    // Suggested VARs Section  
    if (suggestedVars.length > 0) {
      html += this.renderVendorSection(
        'ðŸŽ¯ SUGGESTED CHANNELS',
        'We detected these as likely resellers/VARs based on known patterns',
        suggestedVars,
        'accent'
      );
    }

    // Unknown/Review Section
    if (unknown.length > 0) {
      html += this.renderVendorSection(
        'â“ NEEDS REVIEW', 
        'We couldn\'t automatically classify these vendors',
        unknown,
        'muted'
      );
    }

    // Primes Section (usually not marked as channels)
    if (primes.length > 0) {
      html += this.renderVendorSection(
        'ðŸ¢ LIKELY PRIMES/SIs',
        'These appear to be system integrators or large primes',
        primes,
        'muted'
      );
    }

    list.innerHTML = html;
  },

  renderVendorSection(title, description, vendors, colorClass) {
    const colorMap = {
      'success': 'var(--success)',
      'accent': 'var(--accent)',
      'muted': '#666'
    };
    const borderColor = colorMap[colorClass] || '#666';
    
    return `
      <div style="margin-bottom: 1.5rem;">
        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
          <span style="font-size: 0.8rem; font-weight: 700; color: ${borderColor}; text-transform: uppercase; letter-spacing: 0.5px;">
            ${title}
          </span>
          <span style="font-size: 0.7rem; color: #666;">(${vendors.length})</span>
        </div>
        <div style="font-size: 0.75rem; color: #888; margin-bottom: 0.75rem;">${description}</div>
        <div style="border: 1px solid var(--border); border-radius: 6px; overflow: hidden; border-left: 3px solid ${borderColor};">
          ${vendors.map(v => this.renderVendorRow(v)).join('')}
        </div>
      </div>
    `;
  },

  renderVendorRow(v) {
    const isMarked = this.isChannel(v.vendor);
    return `
      <div class="vendor-list-item" style="border-bottom: 1px solid var(--border); padding: 0.6rem 0.75rem;">
        <div class="vendor-info" style="flex: 1;">
          <div class="vendor-name" style="font-size: 0.85rem; font-weight: 600; color: #fff;">${v.vendor}</div>
          <div class="vendor-stats" style="font-size: 0.7rem; color: #888;">
            ${v.contractCount} contracts â€¢ ${Utils.money(v.spend)} â€¢ ${v.marketShare}% share
          </div>
        </div>
        <div class="vendor-toggle" style="display: flex; align-items: center; gap: 0.5rem;">
          <div class="toggle-switch ${isMarked ? 'active' : ''}" onclick="SalesPlanManager.toggleItem('${v.vendor.replace(/'/g, "\\'")}', this)">
            <div class="toggle-slider"></div>
          </div>
          <div class="toggle-label" style="font-size: 0.7rem; width: 70px; color: ${isMarked ? 'var(--success)' : '#888'};">
            ${isMarked ? 'Channel' : 'Competitor'}
          </div>
        </div>
      </div>
    `;
  },

  toggleItem(vendorName, element) {
    this.toggleChannel(vendorName);
    const toggle = element;
    const label = element.nextElementSibling;
    const isNowChannel = this.isChannel(vendorName);
    
    if (isNowChannel) {
      toggle.classList.add('active');
      label.textContent = 'Channel';
      label.style.color = 'var(--success)';
    } else {
      toggle.classList.remove('active');
      label.textContent = 'Competitor';
      label.style.color = '#888';
    }
    
    // Re-render to move items between sections
    setTimeout(() => this.renderSmartVendorList(), 300);
  }
};
// ==================== APP CORE ====================
const App = {
  mode: 'search', 
  currentQuery: '',
  searchData: { raw: [], active: [], filter: null, loaded: false },
  forecastData: { spending: null, agencies: null, awards: null, analysis: null, loaded: false },
  drillState: { level: 0, path: [], currentAgency: null, currentSubAgency: null },
  onlyHighMissionGap: false,

  init() {
    SalesPlanManager.init();
    
    // Event Listeners
    document.getElementById('searchBtn').onclick = () => App.runSearch();
    document.getElementById('forecastBtn').onclick = () => App.runForecast();
    document.getElementById('mainSearchInput').addEventListener('keypress', e => { if(e.key === 'Enter') App.runSearch(); });
    document.getElementById('miniSearch').addEventListener('keypress', e => { if(e.key === 'Enter') { document.getElementById('mainSearchInput').value = e.target.value; App.mode === 'forecast' ? App.runForecast(e.target.value) : App.runSearch(e.target.value); } });
    window.addEventListener('resize', () => { setTimeout(() => { if(App.searchData.active.length > 0 && App.mode === 'search') App.renderSankey(); }, 200); });

    const params = new URLSearchParams(window.location.search);
    const q = params.get('q');
    const mode = params.get('mode');

    if (q) {
      document.getElementById('mainSearchInput').value = q;
      
      if (mode === 'forecast') {
        App.runForecast(q);
      } else {
        App.runSearch(q);
      }
    }
  },

  showHero() {
    document.getElementById('appView').style.display = 'none';
    const hero = document.getElementById('heroView'); hero.style.display = 'flex'; hero.classList.remove('hidden');
    setTimeout(() => hero.classList.remove('slide-up'), 10);
  },

  setMode(mode) {
    App.mode = mode;
    document.getElementById('modeSearchBtn').classList.toggle('active', mode === 'search');
    document.getElementById('modeForecastBtn').classList.toggle('active', mode === 'forecast');
    document.getElementById('searchModeView').classList.toggle('active', mode === 'search');
    document.getElementById('forecastModeView').classList.toggle('active', mode === 'forecast');
    if(App.currentQuery) {
      if(mode === 'search' && !App.searchData.loaded) App.runSearch(App.currentQuery);
      else if(mode === 'forecast' && !App.forecastData.loaded) App.runForecast(App.currentQuery);
    }
  },

  toggleMode() { App.setMode(App.mode === 'search' ? 'forecast' : 'search'); },

  // --- Search Mode ---
  async runSearch(val) {
    const query = val || document.getElementById('mainSearchInput').value; if(!query) return;
    if(query !== App.currentQuery) { App.searchData = { raw: [], active: [], filter: null, loaded: false }; App.forecastData = { loaded: false }; App.resetDrill(); }
    App.currentQuery = query; App.mode = 'search'; App.showLoader('RETRIEVING DATA...', 'Searching USASpending API');
    try {
      App.searchData.raw = await API.searchAwards(query); App.searchData.active = App.searchData.raw; App.searchData.loaded = true;
      App.transitionToApp(); App.setMode('search'); App.updateSearchDashboard(); requestAnimationFrame(() => App.renderSankey());
    } catch(e) { console.error(e); alert("Error retrieving data."); } finally { App.hideLoader(); }
  },

  updateSearchDashboard() {
    const data = App.searchData.active;
    document.getElementById('stat-vol').innerText = Utils.money(data.reduce((acc, c) => acc + (c['Award Amount']||0), 0));
    document.getElementById('stat-count').innerText = data.length;
    document.getElementById('stat-vendors').innerText = new Set(data.map(c => c['Recipient Name'])).size;
    document.getElementById('stat-agencies').innerText = new Set(data.map(c => c['Awarding Agency'])).size;
    const badge = document.getElementById('filterBadge');
    if (App.searchData.filter) { badge.style.display = 'inline-flex'; document.getElementById('filterName').innerText = App.searchData.filter; } else badge.style.display = 'none';
    App.renderFeed(); App.updateDrillUI();
  },

  // --- Drill Down Logic ---
  resetDrill() { App.drillState = { level: 0, path: [], currentAgency: null, currentSubAgency: null }; App.searchData.filter = null; App.searchData.active = App.searchData.raw; App.updateSearchDashboard(); App.renderSankey(); },
  
  updateDrillUI() {
  const bc = document.getElementById('drillBreadcrumb'); 
  const hint = document.getElementById('drillHint'); 
  const lvl = document.getElementById('drillLevelBadge');
  const levelText = document.getElementById('drillLevelText');

  if (App.drillState.level === 0) {
    bc.style.display = 'none'; 
    hint.style.display = 'flex'; 
    lvl.style.display = 'none'; 
    document.getElementById('subagencyPanel').style.display = 'none';
    hint.innerHTML = `<i class="fas fa-mouse-pointer"></i><span>Click an <strong>agency</strong> or <strong>vendor</strong> bar to drill down</span>`;
  } else {
    bc.style.display = 'flex'; 
    lvl.style.display = 'inline-flex';
    
    // Set appropriate badge text
    if (App.drillState.level === 1) levelText.innerText = 'Agency View';
    else if (App.drillState.level === 2) levelText.innerText = 'Sub-Agency View';
    else if (App.drillState.level === 3) levelText.innerText = 'Vendor Perspective';

    let html = `<div class="breadcrumb-item" onclick="App.resetDrill()"><i class="fas fa-globe breadcrumb-icon"></i><span>All Agencies</span></div>`;
    
    App.drillState.path.forEach((p, i) => {
      const isLast = i === App.drillState.path.length - 1;
      const action = isLast ? '' : `App.drillToLevel(${i + 1})`;
      html += `
        <span class="breadcrumb-separator"><i class="fas fa-chevron-right"></i></span>
        <div class="breadcrumb-item ${isLast ? 'active' : ''}" onclick="${action}">
          <span>${Utils.trunc(p.name, 25)}</span>
        </div>`;
    });
    bc.innerHTML = html; 

    if (App.drillState.level === 1) { 
      hint.innerHTML = `<i class="fas fa-layer-group"></i><span>Click a <strong>sub-agency</strong> or <strong>vendor</strong> to refine</span>`; 
      App.renderSubAgencyPanel(); 
    } else { 
      document.getElementById('subagencyPanel').style.display = 'none'; 
      hint.innerHTML = `<i class="fas fa-check-circle" style="color:var(--success)"></i><span>Viewing filtered breakdown</span>`; 
    }
  }
},

  renderSubAgencyPanel() {
    const list = document.getElementById('subagencyList');
    const contracts = App.searchData.raw.filter(d => d['Awarding Agency'] === App.drillState.currentAgency);
    const map = {}; contracts.forEach(c => { const sa = c['Awarding Sub Agency'] || 'Unknown'; map[sa] = map[sa] || {amount:0, count:0}; map[sa].amount += c['Award Amount']||0; map[sa].count++; });
    const subs = Object.entries(map).map(([k,v]) => ({name:k, ...v})).sort((a,b) => b.amount - a.amount);
    document.getElementById('subagencyParentName').innerText = Utils.trunc(App.drillState.currentAgency, 40);
    document.getElementById('subagencyTotalAmount').innerText = Utils.money(subs.reduce((s,x)=>s+x.amount,0));
    document.getElementById('subagencyCount').innerText = subs.length;
    list.innerHTML = subs.map((s,i) => `<div class="subagency-item" onclick="App.drillToSubAgency('${s.name.replace(/'/g, "\\'")}')"><div class="subagency-item-left"><div class="subagency-rank ${i<3?'top-3':''}">${i+1}</div><div class="subagency-info"><div class="subagency-name">${s.name}</div><div class="subagency-contracts">${s.count} contracts</div></div></div><div class="subagency-item-right"><div class="subagency-bar-container"><div class="subagency-bar" style="width:${(s.amount/subs[0].amount)*100}%"></div></div><div class="subagency-amount">${Utils.money(s.amount)}</div><i class="fas fa-chevron-right subagency-drill-icon"></i></div></div>`).join('');
    document.getElementById('subagencyPanel').style.display = 'block';
  },

  drillToAgency(name) {
  App.drillState = { 
    level: 1, 
    currentAgency: name, 
    currentSubAgency: null, 
    path: [{type: 'agency', name: name}] 
  };
  // ALWAYS filter from raw to prevent "No Data" screen
  App.searchData.active = App.searchData.raw.filter(d => d['Awarding Agency'] === name);
  App.searchData.filter = name;
  App.updateSearchDashboard();
  App.renderSankey();
},

drillToSubAgency(name) {
  App.drillState.level = 2;
  App.drillState.currentSubAgency = name;
  // Re-build path from the current agency and new sub-agency
  App.drillState.path = [
    {type: 'agency', name: App.drillState.currentAgency}, 
    {type: 'sub', name: name}
  ];
  // Filter from raw
  App.searchData.active = App.searchData.raw.filter(d => 
    d['Awarding Agency'] === App.drillState.currentAgency && 
    d['Awarding Sub Agency'] === name
  );
  App.searchData.filter = name;
  App.updateSearchDashboard();
  App.renderSankey();
},
  drillToLevel(lvl) { 
  // Always restore full data before re-applying a level-specific filter
  App.searchData.active = App.searchData.raw;

  if (lvl === 0) {
    App.resetDrill();
  } else if (lvl === 1) {
    App.drillToAgency(App.drillState.path[0].name); 
  } else if (lvl === 2) {
    App.drillToSubAgency(App.drillState.path[1].name);
  }
},
  drillDown(name) {
  const data = App.searchData.raw;
  
  // 1. Identify the entity type from the master dataset
  const agencyMatch = data.find(d => d['Awarding Agency'] === name);
  const subAgencyMatch = data.find(d => d['Awarding Sub Agency'] === name);
  const vendorMatch = data.find(d => d['Recipient Name'] === name);

  // 2. Clear previous specific filters to avoid "No Data" conflicts
  App.searchData.active = data;

  if (agencyMatch && !subAgencyMatch) {
    // It's a top-tier agency: Clean drill to Level 1
    App.drillToAgency(name);
  } 
  else if (subAgencyMatch) {
    // If it's a sub-agency (or both), we must ensure the parent context is set
    // to prevent "No Description" breadcrumbs.
    const parentName = subAgencyMatch['Awarding Agency'];
    App.drillState.currentAgency = parentName; 
    App.drillToSubAgency(name);
  } 
  else if (vendorMatch) {
    // Vendor Perspective (Level 3)
    if (App.drillState.level === 3) {
      App.drillState.path.pop(); // Replace vendor if already in vendor view
    }
    
    App.drillState.level = 3; 
    App.drillState.path.push({ type: 'vendor', name: name });
    App.searchData.filter = `Vendor: ${name}`;
    
    // Filter specifically for this vendor across all agencies
    App.searchData.active = data.filter(d => d['Recipient Name'] === name);
    
    App.updateSearchDashboard();
    App.renderSankey();
  }
},
  clearFilter() { App.drillState.level > 0 ? App.resetDrill() : (App.searchData.filter = null, App.searchData.active = App.searchData.raw, App.updateSearchDashboard(), App.renderSankey()); },

  renderSankey() {
  const container = document.getElementById('chartContainer'); 
  container.innerHTML = '';
  
  const data = App.searchData.active; 
  if(!data || data.length === 0) { 
    container.innerHTML = '<div style="text-align:center; padding:4rem; color:#666">No data available for this view.</div>'; 
    return; 
  }
  
  container.innerHTML = '<svg id="sankeySvg"></svg>';
  
  // Identify the source level for the left side of the Sankey
  const isLvl0 = App.drillState.level === 0;
  const flowMap = {}; 

  data.forEach(d => { 
    if(d['Award Amount'] > 0) {
      // Fallback logic to prevent "No Description" nodes
      const source = (isLvl0 ? d['Awarding Agency'] : d['Awarding Sub Agency']) || d['Awarding Agency'] || 'Unknown Agency';
      const target = d['Recipient Name'] || 'Unknown Vendor';
      const key = source + "|||" + target;
      
      flowMap[key] = (flowMap[key] || 0) + d['Award Amount']; 
    }
  });

  const allFlows = Object.entries(flowMap).sort((a,b) => b[1] - a[1]); 
  const limit = App.drillState.level > 0 ? 50 : 25;
  const topFlows = allFlows.slice(0, limit); 
  const tailFlows = allFlows.slice(limit);
  
  const nodesSet = new Set(); 
  const links = [];
  
  topFlows.forEach(([k,v]) => { 
    const [s,t] = k.split("|||"); 
    nodesSet.add(s); 
    nodesSet.add(t); 
    links.push({source:s, target:t, value:v}); 
  });

  // Aggregate smaller flows into an "Other" category to keep the chart clean
  if(tailFlows.length > 0) { 
    const aggs = {}; 
    tailFlows.forEach(([k,v]) => { 
      const [s] = k.split("|||"); 
      if(nodesSet.has(s)) aggs[s] = (aggs[s] || 0) + v; 
    }); 
    Object.entries(aggs).forEach(([s,v]) => { 
      const n = `Other (${tailFlows.length} Vendors)`; 
      nodesSet.add(n); 
      links.push({source:s, target:n, value:v}); 
    }); 
  }
  
  const nodes = Array.from(nodesSet).map(n => ({name:n})); 
  const nodeMap = new Map(nodes.map((n,i) => [n.name, i]));
  const d3Links = links.map(l => ({source:nodeMap.get(l.source), target:nodeMap.get(l.target), value:l.value}));
  
  const w = container.offsetWidth || 800; 
  const h = Math.max(500, nodes.length * 28);
  const svg = d3.select("#sankeySvg").attr("width", w).attr("height", h);
  const sankey = d3.sankey().nodeId(d => d.index).nodeWidth(20).nodePadding(20).extent([[1,1],[w-1,h-6]]);
  const {nodes:gn, links:gl} = sankey({nodes:nodes.map(d=>Object.assign({},d)), links:d3Links.map(d=>Object.assign({},d))});
  
  // Logic to determine if a node should show the "drill-down" highlight
  const isDrillable = n => {
    if (!n || n.startsWith('Other') || n.includes('Unknown') || n === 'No Description') return false;
    
    // Check if the node is a known Agency, Sub-Agency, or Vendor
    return App.searchData.raw.some(d => 
      d['Awarding Agency'] === n || 
      d['Awarding Sub Agency'] === n || 
      d['Recipient Name'] === n
    );
  };

  // Render Nodes
  svg.append("g").selectAll("rect").data(gn).join("rect")
     .attr("x", d => d.x0).attr("y", d => d.y0).attr("height", d => d.y1 - d.y0).attr("width", d => d.x1 - d.x0)
     .attr("fill", d => Utils.getColor(d.name)).attr("opacity", 0.8)
     .attr("stroke", d => isDrillable(d.name) ? 'var(--accent)' : 'none').attr("stroke-width", d => isDrillable(d.name) ? 2 : 0)
     .style("cursor", d => isDrillable(d.name) ? "pointer" : "default")
     .on("click", (e, d) => { if(isDrillable(d.name)) App.drillDown(d.name); })
     .append("title").text(d => `${d.name}\n${Utils.money(d.value)}`);

  // Render Gradients for links
  const defs = svg.append("defs");
  gl.forEach((l,i) => { 
    const g = defs.append("linearGradient").attr("id","g"+i).attr("gradientUnits","userSpaceOnUse").attr("x1",l.source.x1).attr("x2",l.target.x0); 
    g.append("stop").attr("offset","0%").attr("stop-color",Utils.getColor(l.source.name)); 
    g.append("stop").attr("offset","100%").attr("stop-color",Utils.getColor(l.target.name)); 
  });
  
  // Render Links
  svg.append("g").attr("fill","none").selectAll("path").data(gl).join("path")
     .attr("d", d3.sankeyLinkHorizontal()).attr("stroke",(d,i) => "url(#g"+i+")").attr("stroke-width", d => Math.max(1, d.width)).attr("stroke-opacity", 0.4);
  
  // Render Labels
  svg.append("g").selectAll("text").data(gn).join("text")
     .attr("x", d => d.x0 < w/2 ? d.x1 + 6 : d.x0 - 6).attr("y", d => (d.y1 + d.y0) / 2).attr("dy", "0.35em")
     .attr("text-anchor", d => d.x0 < w/2 ? "start" : "end").text(d => Utils.trunc(d.name, 40))
     .style("font-size", "11px").style("fill", "#fff").style("pointer-events", "none");
},

  renderFeed() {
    const div = document.getElementById('feedGrid');
    const data = App.searchData.active;
    if(data.length === 0) { div.innerHTML = '<div style="text-align:center; padding:2rem; color:#666">No contracts found.</div>'; return; }
    
    div.innerHTML = data.map(c => {
      const internalId = c['generated_internal_id'];
      let url = '#';
      if (internalId) url = `https://www.usaspending.gov/award/${internalId}`;
      else if (c['Award ID']) url = `https://www.usaspending.gov/search/?hash=&filters=${encodeURIComponent(JSON.stringify({keyword: c['Award ID']}))}`;
      
      let metaTags = '';
      if (c['NAICS Code']) metaTags += `<span class="meta-tag naics" title="${c['NAICS Description'] || ''}">NAICS: ${c['NAICS Code']}</span>`;
      if (c['PSC Code']) metaTags += `<span class="meta-tag psc" title="${c['PSC Description'] || ''}">PSC: ${c['PSC Code']}</span>`;
      
      const subAgency = c['Awarding Sub Agency'];
      const agencyDisplay = subAgency && subAgency !== c['Awarding Agency'] 
        ? `${Utils.trunc(c['Awarding Agency'], 20)} â†’ ${Utils.trunc(subAgency, 20)}` 
        : Utils.trunc(c['Awarding Agency'], 35);

      return `<div class="deal-card">
        <div class="deal-header"><span class="deal-agency">${agencyDisplay}</span><span class="deal-amount">${Utils.money(c['Award Amount'])}</span></div>
        <div class="deal-desc">${Utils.trunc(c['Description'], 100)}</div>
        <div class="deal-vendor">${c['Recipient Name']}</div>
        ${metaTags ? `<div class="deal-meta">${metaTags}</div>` : ''}
        <div class="deal-footer"><span class="deal-date">Start: ${Utils.date(c['Start Date'])}${c['End Date'] ? ' â†’ ' + Utils.date(c['End Date']) : ''}</span><a href="${url}" target="_blank" class="action-btn">OPEN AWARD <i class="fas fa-external-link-alt"></i></a></div>
      </div>`;
    }).join('');
  },

// --- Forecast Mode ---
  async runForecast(val) {
    const query = val || document.getElementById('mainSearchInput').value; if(!query) return;
    
    // Reset data if query changed
    if(query !== App.currentQuery) { 
      App.searchData = { loaded:false }; 
      App.forecastData = { spending:null, agencies:null, awards:null, analysis:null, loaded:false }; 
    }
    
    const cs = Chart.getChart("spendingChart"); if(cs) cs.destroy();
    App.currentQuery = query; 
    App.mode = 'forecast'; 
    App.showLoader('CRUNCHING NUMBERS...', 'Applying Recency-Weighted Seasonality');
    
    try {
      const [spending, agencies, awards] = await Promise.all([
        API.getSpendingOverTime(query), 
        API.getAgencyData(query), 
        API.getAwardsForForecast(query)
      ]);
      
      App.forecastData = { 
        spending, 
        agencies, 
        awards, 
        analysis: ForecastEngine.analyze(spending, awards, agencies), 
        loaded: true 
      };
      
      App.transitionToApp(); 
      App.setMode('forecast'); 
      App.renderForecastDashboard();
      
    } catch(e) { 
      console.error(e); 
      App.showToast("Error fetching forecast data.", "error"); 
    } finally { 
      App.hideLoader(); 
    }
  },

renderForecastDashboard() {
    const analysis = App.forecastData.analysis; 
    const awards = App.forecastData.awards || [];
    if(!analysis) return;

    // Calculate metrics from actual data
    const totalAwards = awards.reduce((sum, a) => sum + (parseFloat(a['Award Amount']) || 0), 0);
    
    // Get obligation data from spending over time (actual spending)
    const curFY = Utils.getCurrentFY();
    const curQ = Utils.getCurrentQuarter();
    const fyTotals = analysis.byFY || {};
    const years = Object.keys(fyTotals).map(Number).sort();
    
    // Last complete FY obligations
    const lastCompleteFY = curFY - 1;
    const lastFYTotal = fyTotals[lastCompleteFY] ? Object.values(fyTotals[lastCompleteFY]).reduce((a,b) => a + b, 0) : 0;
    const priorFYTotal = fyTotals[lastCompleteFY - 1] ? Object.values(fyTotals[lastCompleteFY - 1]).reduce((a,b) => a + b, 0) : 0;
    
    // Calculate YoY change from obligations
    let yoyChange = 0;
    let yoyDirection = 'No prior data';
    if (priorFYTotal > 0 && lastFYTotal > 0) {
      yoyChange = ((lastFYTotal - priorFYTotal) / priorFYTotal) * 100;
      yoyDirection = yoyChange >= 0 ? 'Obligations growing' : 'Obligations declining';
    }

    // Calculate rolling 4-quarter projection
    const quarterlyForecasts = this.calculateRollingForecast(analysis.byFY, curFY, curQ, yoyChange);
    const projectionTotal = quarterlyForecasts.reduce((sum, q) => sum + q.projection, 0);

    // Update Stats Row
    document.getElementById('stat-total-awards').innerText = Utils.money(totalAwards);
    document.getElementById('stat-total-obligations').innerText = Utils.money(lastFYTotal);
    
    const yoyEl = document.getElementById('stat-yoy-change');
    const yoyDirEl = document.getElementById('stat-yoy-direction');
    if (priorFYTotal > 0 && lastFYTotal > 0) {
      yoyEl.innerText = `${yoyChange >= 0 ? '+' : ''}${yoyChange.toFixed(0)}%`;
      yoyEl.style.color = yoyChange >= 0 ? 'var(--success)' : 'var(--danger)';
      yoyDirEl.innerText = yoyDirection;
      yoyDirEl.style.color = yoyChange >= 0 ? 'var(--success)' : 'var(--danger)';
    } else {
      yoyEl.innerText = 'N/A';
      yoyEl.style.color = 'var(--text-muted)';
      yoyDirEl.innerText = 'Insufficient history';
      yoyDirEl.className = 'stat-sub neutral';
    }
    
    document.getElementById('stat-recompetes').innerText = analysis.recompetes.length;

    // Render Rolling Forecast Table
    this.renderForecastTable(quarterlyForecasts, lastFYTotal, yoyChange, projectionTotal, analysis, awards);

    // Render Top Buyers (Agencies)
    this.renderTopBuyers(awards);
    
    // Render Top Winners (Vendors)
    this.renderTopWinners(awards);

    // Load Geography Data (async, non-blocking)
    const geoContainer = document.getElementById('geoMapContainer');
    if (geoContainer) {
      geoContainer.style.display = 'block';
      GeoMap.loadAndRender('geoMapContainer', App.currentQuery);
    }
    
    // Render Spending History Chart
    const ctx = document.getElementById('spendingChart').getContext('2d');
    const chartYears = Object.keys(analysis.byFY).sort();
    
    // Grab the accent color from your CSS
    const accentColor = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim();

    new Chart(ctx, {
      type: 'bar',
      data: { 
        // Sliced year labels: FY22, FY23, etc.
        labels: chartYears.map(y => `FY${String(y).slice(-2)}`), 
        datasets: [
          { label: 'Q1', data: chartYears.map(y => analysis.byFY[y][1] || 0), backgroundColor: accentColor }, 
          { label: 'Q2', data: chartYears.map(y => analysis.byFY[y][2] || 0), backgroundColor: accentColor }, 
          { label: 'Q3', data: chartYears.map(y => analysis.byFY[y][3] || 0), backgroundColor: accentColor }, 
          { label: 'Q4', data: chartYears.map(y => analysis.byFY[y][4] || 0), backgroundColor: accentColor }
        ] 
      },
      options: { 
        responsive: true, 
        maintainAspectRatio: false, 
        scales: { 
          x: { 
            stacked: false, // Keeps bars side-by-side
            grid: { display: false }, 
            ticks: { color: '#888' } 
          }, 
          y: { 
            stacked: false, 
            grid: { color: '#333' }, 
            ticks: { color: '#888', callback: v => Utils.money(v) } 
          } 
        }, 
        plugins: { 
          legend: { display: false }, // Hides legend
          tooltip: {
            callbacks: {
              label: ctx => `${ctx.dataset.label}: ${Utils.money(ctx.raw)}`
            }
          }
        } 
      }
    });
    
    // Render Recompetes List
    this.renderRecompetes(analysis.recompetes);
  },

  renderTopBuyers(awards) {
    const body = document.getElementById('topBuyersBody');
    if (!body) return;
    
    // Group by agency
    const agencyMap = {};
    awards.forEach(a => {
      const agency = a['Awarding Agency'] || 'Unknown';
      if (!agencyMap[agency]) {
        agencyMap[agency] = { name: agency, spend: 0, count: 0 };
      }
      agencyMap[agency].spend += parseFloat(a['Award Amount']) || 0;
      agencyMap[agency].count++;
    });
    
    const sorted = Object.values(agencyMap).sort((a, b) => b.spend - a.spend);
    const total = sorted.reduce((s, a) => s + a.spend, 0);
    
    if (sorted.length === 0) {
      body.innerHTML = `<div style="text-align:center; color:var(--text-muted); padding:1rem;">No agency data available</div>`;
      return;
    }
    
    const topAgencies = sorted.slice(0, 8);
    
    body.innerHTML = `
      <div class="buyer-list">
        ${topAgencies.map((a, i) => {
          const share = total > 0 ? (a.spend / total * 100) : 0;
          return `
          <div class="buyer-item">
            <div class="buyer-rank mono text-xs bold accent">${i + 1}</div>
            <div class="buyer-info">
              <div class="buyer-name truncate">${Utils.trunc(a.name, 40)}</div>
              <div class="buyer-stats text-xs muted">${a.count} contracts</div>
            </div>
            <div class="buyer-amount">
              <div class="buyer-spend mono accent">${Utils.money(a.spend)}</div>
              <div class="buyer-share text-xs muted">${share.toFixed(1)}%</div>
            </div>
          </div>`;
        }).join('')}
      </div>
      ${sorted.length > 8 ? `<div style="text-align:center; color:var(--text-muted); font-size:0.75rem; margin-top:0.75rem;">+${sorted.length - 8} more agencies</div>` : ''}
    `;
  },

  renderTopWinners(awards) {
    const body = document.getElementById('topWinnersBody');
    if (!body) return;
    
    // Group by vendor
    const vendorMap = {};
    awards.forEach(a => {
      const vendor = a['Recipient Name'] || 'Unknown';
      if (!vendorMap[vendor]) {
        vendorMap[vendor] = { name: vendor, spend: 0, count: 0, agencies: new Set() };
      }
      vendorMap[vendor].spend += parseFloat(a['Award Amount']) || 0;
      vendorMap[vendor].count++;
      vendorMap[vendor].agencies.add(a['Awarding Agency'] || 'Unknown');
    });
    
    const sorted = Object.values(vendorMap)
      .map(v => ({ ...v, agencies: v.agencies.size }))
      .sort((a, b) => b.spend - a.spend);
    const total = sorted.reduce((s, v) => s + v.spend, 0);
    
    if (sorted.length === 0) {
      body.innerHTML = `<div style="text-align:center; color:var(--text-muted); padding:1rem;">No vendor data available</div>`;
      return;
    }
    
    const topVendors = sorted.slice(0, 8);
    
    body.innerHTML = `
      <div class="buyer-list">
        ${topVendors.map((v, i) => {
          const share = total > 0 ? (v.spend / total * 100) : 0;
          return `
          <div class="buyer-item">
            <div class="buyer-rank mono text-xs bold accent">${i + 1}</div>
            <div class="buyer-info">
              <div class="buyer-name truncate">${Utils.trunc(v.name, 35)}</div>
              <div class="buyer-stats text-xs muted">${v.count} contracts Â· ${v.agencies} ${v.agencies === 1 ? 'agency' : 'agencies'}</div>
            </div>
            <div class="buyer-amount">
              <div class="buyer-spend mono accent">${Utils.money(v.spend)}</div>
              <div class="buyer-share text-xs muted">${share.toFixed(1)}%</div>
            </div>
          </div>`;
        }).join('')}
      </div>
      ${sorted.length > 8 ? `<div style="text-align:center; color:var(--text-muted); font-size:0.75rem; margin-top:0.75rem;">+${sorted.length - 8} more vendors</div>` : ''}
    `;
  },

  renderRecompetes(recompetes) {
    const container = document.getElementById('recompetesList');
    if (!container) return;
    
    if (!recompetes || recompetes.length === 0) {
      container.innerHTML = '';
      return;
    }
    
    // 1. Preserve Mission Gap Risk Calculation
    const withRisk = recompetes.map(r => ({
      ...r,
      risk: Utils.missionGapRisk(r)
    }));
    
    // 2. Preserve Detailed Metrics Calculation
    const totalRecompeteValue = withRisk.reduce((sum, r) => sum + (parseFloat(r['Award Amount']) || 0), 0);
    const highRiskContracts = withRisk.filter(r => r.risk.level === 'high');
    const highRiskValue = highRiskContracts.reduce((sum, r) => sum + (parseFloat(r['Award Amount']) || 0), 0);
    
    // 3. Preserve User-Defined Filtering
    const filtered = App.onlyHighMissionGap 
      ? withRisk.filter(r => r.risk.level === 'high')
      : withRisk;
    
    // 4. Preserve Complex Subtitle Logic
    let subtitleText = `${Utils.money(totalRecompeteValue)} in ${recompetes.length} contracts expiring within 24 months`;
    if (highRiskContracts.length > 0) {
      subtitleText += ` Â· <span style="color:var(--danger); font-weight:600;">${highRiskContracts.length} high-risk (${Utils.money(highRiskValue)})</span>`;
    }
    
    // 5. Render Header with the "High Risk Only" Toggle
    container.innerHTML = `
      <div class="section-header">
        <div class="section-title-group">
          <i class="fas fa-clock" style="color:var(--danger)"></i>
          <span class="section-title">Expiring Contracts</span>
        </div>
        <div class="mission-gap-filter">
          <span class="section-subtitle">${subtitleText}</span>
          ${highRiskContracts.length > 0 ? `
            <button class="mission-gap-toggle ${App.onlyHighMissionGap ? 'active' : ''}" onclick="App.toggleMissionGapFilter()" title="Show only contracts with high mission continuity risk">
              <i class="fas fa-exclamation-triangle"></i>
              High Risk Only
            </button>
          ` : ''}
        </div>
      </div>
      
      ${filtered.length === 0 ? `
        <div style="text-align:center; padding:2rem; color:var(--text-muted);">
          No contracts match the current filter.
          <a href="#" onclick="App.toggleMissionGapFilter(); return false;" style="color:var(--accent); margin-left:0.5rem;">Show all</a>
        </div>
      ` : filtered.map(r => {
        const internalId = r['generated_internal_id'];
        const awardUrl = internalId 
          ? `https://www.usaspending.gov/award/${internalId}`
          : (r['Award ID'] ? `https://www.usaspending.gov/search/?hash=&filters=${encodeURIComponent(JSON.stringify({keyword: r['Award ID']}))}` : null);
        
        // 6. Updated: Standardized Fiscal Period Calculation (FY26 Q1)
        const endDate = new Date(r['End Date']);
        const m = endDate.getMonth();
        const y = endDate.getFullYear();
        const fy = m >= 9 ? y + 1 : y;
        let q = 1;
        if (m >= 0 && m <= 2) q = 2;
        else if (m >= 3 && m <= 5) q = 3;
        else if (m >= 6 && m <= 8) q = 4;
        const fiscalPeriod = `FY${String(fy).slice(-2)} Q${q}`;

        // 7. Preserve Urgency Calculation
        const today = new Date();
        const daysUntil = Math.ceil((endDate - today) / (1000 * 60 * 60 * 24));
        const urgency = daysUntil < 180 ? 'urgent' : daysUntil < 365 ? 'soon' : 'later';
        
        // 8. Preserve Mission Gap Labeling
        const risk = r.risk;
        const riskLabel = risk.level === 'high' ? 'Mission Gap: High'
          : risk.level === 'medium' ? 'Mission Gap: Medium'
          : 'Mission Gap: Low';
        
        return `
        <div class="deal-card" style="margin-bottom:1rem; ${risk.level === 'high' ? 'border-left: 3px solid var(--danger);' : risk.level === 'medium' ? 'border-left: 3px solid #FDD835;' : ''}">
          <div class="deal-header">
            <span class="deal-agency">${Utils.trunc(r['Awarding Agency'], 40)}</span>
            <span class="deal-amount">${Utils.money(r['Award Amount'])}</span>
          </div>
          <div class="deal-desc">${Utils.trunc(r['Description'], 100)}</div>
          <div class="deal-meta">
            <span class="meta-tag" style="color:var(--accent); border-color:var(--accent);">${fiscalPeriod}</span>
            <span class="meta-tag mission-gap ${risk.level}" title="Flags contracts likely tied to ongoing operational support">${riskLabel}</span>
            ${r['PSC Code'] ? `<span class="meta-tag psc" title="${r['PSC Description'] || ''}">PSC: ${r['PSC Code']}</span>` : ''}
          </div>
          
          ${risk.reasons.length > 0 && risk.level !== 'low' ? `<div class="mission-gap-signals">Signals: ${risk.reasons.join(', ')}</div>` : ''}
          
          <div class="deal-footer">
            <div>
              <div style="font-size:0.8rem; color:${urgency === 'urgent' ? 'var(--danger)' : urgency === 'soon' ? '#FDD835' : 'var(--text-muted)'}">
                Expires: ${Utils.date(r['End Date'])} (${daysUntil} days)
              </div>
              <div style="font-size:0.75rem; color:#666">Incumbent: ${Utils.trunc(r['Recipient Name'], 35)}</div>
            </div>
            ${awardUrl ? `<a href="${awardUrl}" target="_blank" rel="noopener" class="action-btn">OPEN AWARD <i class="fas fa-external-link-alt"></i></a>` : ''}
          </div>
        </div>`;
      }).join('')}
    `;
  },
  toggleMissionGapFilter() {
    App.onlyHighMissionGap = !App.onlyHighMissionGap;
    // Re-render with current recompetes data
    if (App.forecastData.analysis && App.forecastData.analysis.recompetes) {
      this.renderRecompetes(App.forecastData.analysis.recompetes);
    }
  },

calculateRollingForecast(byFY, curFY, curQ, overallYoyTrend) {
    const forecasts = [];
    let fy = curFY;
    let q = curQ;
    
    for (let i = 0; i < 4; i++) {
      const historicalValues = [];
      const years = Object.keys(byFY).map(Number).sort().reverse(); 
      
      years.forEach(year => {
        if (year < curFY && byFY[year] && byFY[year][q] > 0 && historicalValues.length < 3) {
          historicalValues.push({ fy: year, amount: byFY[year][q] });
        }
      });
      
      let weightedAvg = 0;
      if (historicalValues.length > 0) {
        const weights = [0.5, 0.3, 0.2];
        let totalWeight = 0;
        historicalValues.forEach((h, idx) => {
          const w = weights[idx] || 0.1;
          weightedAvg += h.amount * w;
          totalWeight += w;
        });
        weightedAvg = weightedAvg / totalWeight;
      }
      
      const lastYearVal = byFY[curFY - 1] && byFY[curFY - 1][q] ? byFY[curFY - 1][q] : 0;
      const priorYearVal = byFY[curFY - 2] && byFY[curFY - 2][q] ? byFY[curFY - 2][q] : 0;
      
      let quarterGrowthRate = 0;
      if (priorYearVal > 0 && lastYearVal > 0) {
        quarterGrowthRate = (lastYearVal - priorYearVal) / priorYearVal;
      } else if (overallYoyTrend) {
        quarterGrowthRate = overallYoyTrend / 100;
      }
      
      quarterGrowthRate = Math.max(-0.5, Math.min(0.5, quarterGrowthRate));
      const trendMultiplier = 1 + quarterGrowthRate;
      
      let projection = 0;
      if (lastYearVal > 0) projection = lastYearVal * trendMultiplier;
      else if (weightedAvg > 0) projection = weightedAvg * trendMultiplier;
      
      forecasts.push({
        // Updated to Standard Format: FY26 Q1
        period: `FY${String(fy).slice(-2)} Q${q}`,
        quarter: q,
        fiscalYear: fy,
        historicalAvg: weightedAvg,
        lastYear: lastYearVal,
        priorYear: priorYearVal,
        quarterGrowth: quarterGrowthRate * 100,
        projection: projection,
        dataPoints: historicalValues.length
      });
      
      q++;
      if (q > 4) { q = 1; fy++; }
    }
    return forecasts;
  },
  
  renderForecastTable(forecasts, lastFYTotal, yoyChange, projectionTotal, analysis, awards) {
    const tbody = document.getElementById('forecastTableBody');
    if (!tbody) return;
    
    tbody.innerHTML = forecasts.map(f => {
      const hasData = f.dataPoints > 0;
      const qGrowth = f.quarterGrowth || 0;
      const trendClass = qGrowth >= 0 ? 'trend-up' : 'trend-down';
      const trendIcon = qGrowth >= 0 ? 'â–²' : 'â–¼';
      
      return `
        <tr>
          <td><strong>${f.period}</strong></td>
          <td style="color:var(--text-muted);">
            ${hasData ? Utils.money(f.historicalAvg) : '<span style="opacity:0.5">No data</span>'}
          </td>
          <td style="color:var(--text-muted);">${f.lastYear > 0 ? Utils.money(f.lastYear) : '-'}</td>
          <td style="white-space: nowrap;">
            <div style="display: inline-flex; align-items: center; gap: 0.5rem;">
              <span style="color:var(--accent); font-weight:600;">${f.projection > 0 ? Utils.money(f.projection) : '-'}</span>
              ${f.lastYear > 0 && f.priorYear > 0 ? 
                `<span class="trend-pill ${trendClass}" style="font-size:0.65rem;">${trendIcon} ${Math.abs(qGrowth).toFixed(0)}%</span>` 
                : ''}
            </div>
          </td>
        </tr>
      `;
    }).join('');
    
    const summaryEl = document.getElementById('projectionSummary');
    if (summaryEl && projectionTotal > 0) {
      const quarterGrowths = forecasts.filter(f => f.lastYear > 0 && f.priorYear > 0).map(f => f.quarterGrowth);
      const avgGrowth = quarterGrowths.length > 0 ? (quarterGrowths.reduce((a,b) => a + b, 0) / quarterGrowths.length) : yoyChange;
      const growthColor = avgGrowth >= 0 ? 'var(--success)' : 'var(--danger)';

      // 2. Identify the shorthand FY for the summary header (e.g., "FY26")
      const fyShorthand = forecasts[0].period.split(' ')[0];

      // Safely identify the top agency
      const topAgency = (awards && awards[0] && awards[0]['Awarding Agency']) ? awards[0]['Awarding Agency'] : 'the primary agency';

      // Define real-world tactical advice tiers
      let tacticalAdvice = '';
      if (analysis.hhi > 2500) {
          tacticalAdvice = `teaming with established primes to bypass high barriers to entry.`;
      } else if (analysis.hhi > 1500) {
          tacticalAdvice = `a targeted account-entry strategy focusing on under-served sub-agencies.`;
      } else {
          tacticalAdvice = `an aggressive displacement strategy targeting the ${topAgency} incumbent base.`;
      }

      const recompeteValue = analysis.recompetes.reduce((s, r) => s + (parseFloat(r['Award Amount']) || 0), 0);
      
      // Confidence Score Calculations
      const avgDataPoints = Number(forecasts.reduce((sum, f) => sum + (f.dataPoints || 0), 0) / 4) || 0;
      const volatilityScore = Number(analysis.volatility?.score) || 0.5;

      let confidenceScore = ((avgDataPoints / 3) * 70) + ((1 - volatilityScore) * 30);
      confidenceScore = Math.max(0, Math.min(100, Number(confidenceScore) || 0));

      let confidenceLevel = 'LOW';
      let confidenceClass = 'low';
      if (confidenceScore >= 75) { confidenceLevel = 'HIGH'; confidenceClass = 'high'; }
      else if (confidenceScore >= 45) { confidenceLevel = 'MEDIUM'; confidenceClass = 'medium'; }

      // 3. Render the Updated Summary Narrative
      summaryEl.innerHTML = `
        <div class="hero-growth-label">Projected ${fyShorthand} Volume</div>
        <div style="display: flex; align-items: baseline; gap: 1.5rem; flex-wrap: wrap; margin-bottom: 1.5rem;">
          <div class="hero-growth-value">${Utils.money(projectionTotal)}</div>
          <div style="color:${growthColor}; font-size: 1.5rem; font-weight: 700; font-family: 'JetBrains Mono';">
            ${avgGrowth >= 0 ? 'â–²' : 'â–¼'} ${Math.abs(avgGrowth).toFixed(0)}% <span style="font-size:0.8rem; opacity:0.7">Avg Q-Growth</span>
          </div>
        </div>
        
        <div class="strategic-narrative-card">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <div style="color:var(--accent); font-weight:700; font-size:0.7rem; text-transform:uppercase; letter-spacing:1px;">
              <i class="fas fa-robot"></i> Strategic Recommendation
            </div>
            <div style="font-size:0.6rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px;">
              Model Confidence: <span class="analysis-panel-badge ${confidenceClass}">${confidenceLevel} (${confidenceScore.toFixed(0)}%)</span>
            </div>
          </div>

          <strong>Market Dynamics:</strong> This is a <strong>${analysis.marketStatus}</strong> market (HHI: ${analysis.hhi}). 
          With a ${avgGrowth >= 0 ? 'bullish' : 'softening'} <strong>${avgGrowth.toFixed(0)}% ${fyShorthand} growth trend</strong>, 
          the model recommends ${tacticalAdvice}
          ${analysis.recompetes.length > 5 ? ` High recompete volume (${Utils.money(recompeteValue)}) in the next 24 months signals a prime capture window.` : ''}
          
          <div style="margin-top: 15px; padding: 10px; background: rgba(0,0,0,0.2); border: 1px solid var(--border); border-radius: 4px;">
            <div style="font-size: 0.6rem; color: var(--accent); text-transform: uppercase; margin-bottom: 5px; font-weight: 700;">Confidence Logic</div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.65rem; color: var(--text-muted);">
              <div>
                <strong>Density:</strong> ${avgDataPoints.toFixed(1)}/3.0 Years 
                <div style="height:3px; width:100%; background:#333; margin-top:3px;">
                  <div style="height:100%; width:${(avgDataPoints/3)*100}%; background:var(--accent);"></div>
                </div>
              </div>
              <div>
                <strong>Stability:</strong> ${(100 - (volatilityScore * 100)).toFixed(0)}% Stable
                <div style="height:3px; width:100%; background:#333; margin-top:3px;">
                  <div style="height:100%; width:${(1-volatilityScore)*100}%; background:var(--accent);"></div>
                </div>
              </div>
            </div>
            <div style="font-size: 0.6rem; margin-top: 8px; font-style: italic; opacity: 0.8;">
              Note: High volatility or <1 year of data reduces projection reliability.
            </div>
          </div>
        </div>

        <div class="disclaimer-text" style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border); font-size: 0.7rem; color: var(--text-muted); line-height: 1.4; font-style: italic;">
          <strong>Strategic Disclaimer:</strong> This recommendation is based on a statistical analysis of historical USASpending data and does not account for real-time geopolitical shifts, undisclosed budget reprogramming, or pending litigation. 
        </div>
      `;
    } else if (summaryEl) {
      summaryEl.innerHTML = '';
    }
  },
// --- Helpers ---
  exportCSV(btn) {
    const data = App.mode === 'search' ? App.searchData.active : (App.forecastData.awards || []);
    
    // IF NO DATA: Flash Red (Error)
    if (!data.length) {
      if (btn) {
        const originalHtml = btn.innerHTML;
        btn.style.color = 'var(--danger)';
        btn.style.borderColor = 'var(--danger)';
        btn.innerHTML = '<i class="fas fa-times"></i>'; 
        setTimeout(() => {
          btn.style.color = '';
          btn.style.borderColor = '';
          btn.innerHTML = originalHtml;
        }, 2000);
      }
      return;
    }
    
    // Updated Headers with Fiscal Period
    const headers = ['Fiscal Period', 'Recipient', 'Agency', 'Sub-Agency', 'Amount', 'Description', 'Start Date', 'End Date', 'Award ID', 'Award Link'];
    
    const rows = data.map(c => {
      // Logic for FY26 Q1 shorthand
      let fiscalPeriod = 'N/A';
      if (c['Start Date']) {
        const d = new Date(c['Start Date']);
        const m = d.getMonth(); 
        const y = d.getFullYear();
        const fy = m >= 9 ? y + 1 : y;
        let q = 1; 
        if (m >= 0 && m <= 2) q = 2;
        else if (m >= 3 && m <= 5) q = 3;
        else if (m >= 6 && m <= 8) q = 4;
        fiscalPeriod = `FY${String(fy).slice(-2)} Q${q}`;
      }

      const internalId = c['generated_internal_id']; 
      let awardUrl = '';
      if (internalId) awardUrl = `https://www.usaspending.gov/award/${internalId}`;
      else if (c['Award ID']) awardUrl = `https://www.usaspending.gov/search/?hash=&filters=${encodeURIComponent(JSON.stringify({keyword: c['Award ID']}))}`;
      
      return [
        `"${fiscalPeriod}"`,
        `"${(c['Recipient Name'] || '').replace(/"/g, '""')}"`, 
        `"${(c['Awarding Agency'] || '').replace(/"/g, '""')}"`, 
        `"${(c['Awarding Sub Agency'] || '').replace(/"/g, '""')}"`, 
        c['Award Amount'] || 0, 
        `"${(c['Description'] || '').replace(/"/g, '""')}"`, 
        c['Start Date'] || '', 
        c['End Date'] || '', 
        c['Award ID'] || '', 
        awardUrl
      ];
    });
    
    const csvContent = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a"); 
    link.setAttribute("href", url); 
    link.setAttribute("download", `govhoo_${App.mode}_${App.currentQuery}.csv`);
    document.body.appendChild(link); link.click(); document.body.removeChild(link);

    // SUCCESS: Flash Green
    if (btn) {
      const originalHtml = btn.innerHTML;
      btn.style.color = 'var(--success)';
      btn.style.borderColor = 'var(--success)';
      btn.innerHTML = '<i class="fas fa-check"></i>'; 
      setTimeout(() => {
        btn.style.color = '';
        btn.style.borderColor = '';
        btn.innerHTML = originalHtml;
      }, 2000);
    }
  },
  
  showLoader(text, subtext) { document.getElementById('loaderText').innerText = text; document.getElementById('loaderSubtext').innerText = subtext || ''; document.getElementById('loader').style.display = 'flex'; },
  hideLoader() { document.getElementById('loader').style.display = 'none'; },
  transitionToApp() {
    const hero = document.getElementById('heroView'); hero.classList.add('slide-up');
    document.getElementById('appView').style.display = 'block'; document.getElementById('miniSearch').value = App.currentQuery;
    document.getElementById('dashboardContainer').classList.add('active'); setTimeout(() => { hero.style.display = 'none'; hero.classList.add('hidden'); }, 500);
  },
  
  shareLink(btn) {
    const url = new URL(window.location); url.searchParams.set('q', App.currentQuery); url.searchParams.set('mode', App.mode);
    navigator.clipboard.writeText(url.toString()).then(() => {
      // SUCCESS: Flash Green
      if (btn) {
        const originalHtml = btn.innerHTML;
        btn.style.color = 'var(--success)';
        btn.style.borderColor = 'var(--success)';
        btn.innerHTML = '<i class="fas fa-check"></i>'; // Switch to Checkmark
        setTimeout(() => {
          btn.style.color = '';
          btn.style.borderColor = '';
          btn.innerHTML = originalHtml;
        }, 2000);
      }
    });
  }
};

const PromptPackageGenerator = {

  // Calculate derived metrics for the territory
  calculateMetrics(data, analysis) {
    const totalValue = data.reduce((sum, r) => sum + (parseFloat(r['Award Amount']) || 0), 0);
    const contractCount = data.length;
    const avgDealSize = contractCount > 0 ? totalValue / contractCount : 0;
    
    // Contract size distribution
    const amounts = data.map(r => parseFloat(r['Award Amount']) || 0).filter(a => a > 0).sort((a, b) => a - b);
    const medianDealSize = amounts.length > 0 ? amounts[Math.floor(amounts.length / 2)] : 0;
    const largeDeals = amounts.filter(a => a >= 1000000).length;
    const midDeals = amounts.filter(a => a >= 100000 && a < 1000000).length;
    const smallDeals = amounts.filter(a => a < 100000).length;
    
    // Time-based analysis
    const now = new Date();
    const expiringContracts = data.filter(c => {
      const endDate = new Date(c['End Date']);
      const monthsOut = (endDate - now) / (1000 * 60 * 60 * 24 * 30);
      return monthsOut > 0 && monthsOut <= 18;
    });
    const expiringValue = expiringContracts.reduce((s, c) => s + (parseFloat(c['Award Amount']) || 0), 0);
    
    return {
      totalValue,
      contractCount,
      avgDealSize,
      medianDealSize,
      largeDeals,
      midDeals,
      smallDeals,
      expiringValue,
      expiringCount: expiringContracts.length
    };
  },

  // Build vendor intelligence
  buildVendorIntel(data) {
    const vendorMap = {};
    const now = new Date();
    
    data.forEach(r => {
      const v = r['Recipient Name'] || 'Unknown';
      if (!vendorMap[v]) vendorMap[v] = { 
        spend: 0, 
        count: 0, 
        agencies: new Set(),
        contracts: [],
        expiring: 0
      };
      const amt = parseFloat(r['Award Amount']) || 0;
      vendorMap[v].spend += amt;
      vendorMap[v].count++;
      vendorMap[v].agencies.add(r['Awarding Agency']);
      vendorMap[v].contracts.push(r);
      
      const endDate = new Date(r['End Date']);
      const monthsOut = (endDate - now) / (1000 * 60 * 60 * 24 * 30);
      if (monthsOut > 0 && monthsOut <= 18) {
        vendorMap[v].expiring += amt;
      }
    });
    
    const totalSpend = Object.values(vendorMap).reduce((s, v) => s + v.spend, 0);
    
    return Object.entries(vendorMap)
      .map(([name, d]) => ({
        name,
        spend: d.spend,
        share: totalSpend > 0 ? ((d.spend / totalSpend) * 100) : 0,
        contracts: d.count,
        agencies: d.agencies.size,
        expiring: d.expiring,
        avgDeal: d.count > 0 ? d.spend / d.count : 0,
        isChannel: SalesPlanManager.isChannel(name)
      }))
      .sort((a, b) => b.spend - a.spend);
  },

  // Build agency intelligence  
  buildAgencyIntel(data) {
    const agencyMap = {};
    
    data.forEach(r => {
      const ag = r['Awarding Agency'] || 'Unknown';
      const sub = r['Awarding Sub Agency'] || 'Unknown';
      
      if (!agencyMap[ag]) agencyMap[ag] = { 
        spend: 0, 
        count: 0, 
        subs: {},
        vendors: {}
      };
      
      const amt = parseFloat(r['Award Amount']) || 0;
      agencyMap[ag].spend += amt;
      agencyMap[ag].count++;
      
      if (!agencyMap[ag].subs[sub]) agencyMap[ag].subs[sub] = 0;
      agencyMap[ag].subs[sub] += amt;
      
      const v = r['Recipient Name'] || 'Unknown';
      if (!agencyMap[ag].vendors[v]) agencyMap[ag].vendors[v] = 0;
      agencyMap[ag].vendors[v] += amt;
    });
    
    const totalSpend = Object.values(agencyMap).reduce((s, a) => s + a.spend, 0);
    
    return Object.entries(agencyMap)
      .map(([name, d]) => {
        const topVendors = Object.entries(d.vendors)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 3)
          .map(([v, s]) => ({ name: v, spend: s }));
        
        const topSubs = Object.entries(d.subs)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 3)
          .map(([s, amt]) => ({ name: s, spend: amt }));
          
        return {
          name,
          spend: d.spend,
          share: totalSpend > 0 ? ((d.spend / totalSpend) * 100) : 0,
          contracts: d.count,
          topVendors,
          topSubs,
          incumbent: topVendors[0]?.name || 'Unknown'
        };
      })
      .sort((a, b) => b.spend - a.spend);
  },
generatePrompt(extracted, config) {
    const mf = v => Utils.money(v);
    const pct = v => (v && !isNaN(v)) ? v.toFixed(1) + '%' : '0.0%';
    const query = extracted.query.toUpperCase();
    
    // Standard shorthand for AI instructions
    const fyShorthand = `FY${String(Utils.getCurrentFY()).slice(-2)}`;
    const fyFull = Utils.getCurrentFY();

    // Separate vendors based on UI classification
    const competitors = extracted.vendors.filter(v => !v.isChannel);
    const channels = extracted.vendors.filter(v => v.isChannel);
    
    const agencies = extracted.agencies.slice(0, 6);
    const metrics = extracted.metrics;

    // Build the Scope string dynamically based on identified agencies
    const agencyList = agencies.map(a => a.name).join(', ');

    return `# Federal Go-To-Market Plan: ${query}

**Scope**: Fiscal Year ${fyFull} (${fyShorthand}). Target agencies include ${agencyList}. This plan outlines the GTM strategy to drive ${query}-related business within the Federal market, leveraging both direct sales and strategic partnerships.

---

# ROLE
Act as a Senior Federal Sales Director at a Tier-1 Defense Prime or Cloud Service Provider (CSP).
You are producing an ${fyShorthand} Federal Go-To-Market (GTM) Plan for ${query}. 

---

## OUTPUT STYLE AND RULES
- Execution-oriented GTM plan. Direct, factual, concise.
- No marketing language or meta-commentary.
- Make explicit choices: what we will do and what we will not do.
- Treat USASpending data as awarded-spend signals, not a full market view.

---

## DATA INPUTS
- Market: ${query}  
- Total Awarded Value (12mo): ${mf(metrics.totalValue)}  
- Contract Count: ${metrics.contractCount}  
- Median Deal Size: ${mf(metrics.medianDealSize)}  
- Recompete Signal (18mo): ${mf(metrics.expiringValue)}

---

## EXECUTIVE SUMMARY
One high-density paragraph stating the ${fyShorthand} target revenue range, primary risk, and focus.

## MARKET DYNAMICS & FRICTION
Four sentences explaining how revenue is won and the role of incumbency.

## COMPETITIVE LANDSCAPE (NON-CHANNEL VENDORS)
Output the following table for identified competitors ONLY.

| Vendor | Spend | Share | Contracts | Agencies | Recompete Exposure |
|---|---:|---:|---:|---:|---:|
${competitors.slice(0,6).map(c =>
`| ${c.name} | ${mf(c.spend)} | ${pct(c.share)} | ${c.contracts} | ${c.agencies} | ${mf(c.expiring)} |`
).join('\n')}

Include 3â€“6 bullets on vulnerability and gatekeepers.

## CHANNEL PARTNER LANDSCAPE (IDENTIFIED PARTNERS)
Output the following table for our identified friendly channel partners ONLY. 
${channels.length === 0 ? "\n(No channel partners marked in Govhoo yet. Identify resellers in the Sales Plan modal to populate this section.)\n" : ""}
| Partner Vendor | Partner Spend | Share | Contracts | Agencies | Current Exposure |
|---|---:|---:|---:|---:|---:|
${channels.slice(0,6).map(c =>
`| ${c.name} | ${mf(c.spend)} | ${pct(c.share)} | ${c.contracts} | ${c.agencies} | ${mf(c.expiring)} |`
).join('\n')}

Include 2â€“3 bullets on where these partners provide the most "speed to contract".

## PARTNER-TO-INCUMBENT ATTACK MAP
Output a markdown table mapping identified incumbents to identified Channel Partners.

| Target Incumbent | Vulnerability | Recommended Partner Path | Strategic Rationale |
|---|---|---|---|
${competitors.slice(0,3).map(comp => 
`| ${comp.name} | ${mf(comp.expiring)} Recompete | ${channels[0]?.name || 'TBD Channel'} | Leverage existing contract vehicle |`
).join('\n')}

## ACCOUNT PRIORITIZATION
| Account / Component | Priority | Decision |
|---|---|---|
${agencies.map(a =>
`| ${a.name} - ${a.topSubs[0]?.name || 'Primary Component'} | TBD | TBD |`
).join('\n')}

## STRATEGIC DECISIONS (PRIMARY ACCOUNTS ONLY)
Focus on target outcome, deal shape, and specific partner access path.

## PIPELINE AND TARGETS
Revenue range and required deal count logic.

## GO-TO-MARKET MOTION
State clearly if execution is Partner-Led or Direct-Led. Use the names identified above.

## RESOURCE PLAN
List requirements for Sponsorship, Sales, Technical coverage, and Legal.

## RISKS AND MITIGATION
Markdown table covering lock, dependency, vehicles, and timing.

## NEXT 30 DAYS: EXECUTION SPRINT
Markdown table with verifiable milestones and a Kill/No-Go decision point.

## APPENDIX: EXECUTION PRECONDITIONS
Succinctly state required leadership support and the alternative if withheld.`;
  },
  buildPackage(data, analysis, config = {}) {
    const metrics = this.calculateMetrics(data, analysis);
    const vendors = this.buildVendorIntel(data);
    const agencies = this.buildAgencyIntel(data);
    
    const extracted = {
      query: App.currentQuery,
      metrics,
      vendors,
      agencies,
      analysis
    };
    
    return this.generatePrompt(extracted, config);
  },

  downloadPackage(promptText) {
    const blob = new Blob([promptText], { type: 'text/plain;charset=utf-8' });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    const fy = Utils.getCurrentFY();
    link.download = `Territory_Plan_FY${fy}_${App.currentQuery.replace(/\s+/g, '_')}.txt`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }
};

App.init();

// Initialize Autocomplete on search inputs
Autocomplete.init('mainSearchInput');
Autocomplete.init('miniSearch');
</script>

</body>
</html>