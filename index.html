<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#000000">
  <title>Govhoo - Federal Contract Intelligence & Sales Planning</title>
  
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-sankey/0.12.3/d3-sankey.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
 <script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-T343V4RFHV');
</script>
<style>
:root {
  --bg-app: #000000;
  --bg-card: #121212; 
  --bg-input: #1a1a1a;
  --border: #333333;
  --text-primary: #e6e6e6;
  --text-muted: #888888;
  
  /* Vintage/Elegant Terminal Theme */
  --accent: #D4C4A8;
  --accent-dim: rgba(212, 196, 168, 0.1);
  --link: #8DA0CB;
  --success: #66C2A5;
  --danger: #FB8072;
  
  /* Vintage Chart Palette */
  --q1-color: #958BB6; --q2-color: #6F8A74; --q3-color: #8FB6D0; --q4-color: #C27E5C;

  --safe-top: env(safe-area-inset-top, 20px);
  --safe-bottom: env(safe-area-inset-bottom, 20px);
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

body {
  margin: 0; padding: 0;
  font-family: 'Inter', sans-serif;
  background: var(--bg-app);
  color: var(--text-primary);
  min-height: 100vh;
  overflow-x: hidden;
}

/* --- Hero Section --- */
.hero-view {
  position: fixed; inset: 0; z-index: 200; 

  display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
  padding: 2rem; padding-top: max(8vh, var(--safe-top)); 
  transition: transform 0.5s cubic-bezier(0.16, 1, 0.3, 1);
  overflow-y: auto; 
}
.hero-view.slide-up { transform: translateY(-100%); }
.hero-view.hidden { display: none; }

.terminal-logo {
  font-family: 'JetBrains Mono', monospace; font-size: 2.5rem; font-weight: 700;
  margin-bottom: 0.5rem; color: var(--text-primary); letter-spacing: -1px; text-align: center;
}
.terminal-logo span { color: var(--accent); }

.hero-subtitle {
  color: var(--text-muted); margin-bottom: 2rem; text-align: center;
}

.search-box-container { 
  position: relative; z-index: 210; 
  width: 100%; max-width: 500px; margin-top: 1.5rem; 
}

.main-input {
  width: 100%; background: var(--bg-input); border: 1px solid var(--border);
  padding: 1.25rem 1rem; font-size: 1.1rem; color: white; border-radius: 4px;
  font-family: 'Inter', sans-serif; transition: border-color 0.2s; -webkit-appearance: none;
}
.main-input:focus { outline: none; border-color: var(--accent); background: #222; }

.btn-row { display: flex; gap: 0.75rem; margin-top: 1rem; }
.btn-primary, .btn-secondary {
  flex: 1; padding: 1rem;
  font-weight: 700; border: none; border-radius: 4px;
  font-size: 0.9rem; cursor: pointer; text-transform: uppercase; letter-spacing: 1px;
  display: flex; align-items: center; justify-content: center; gap: 0.5rem;
}
.btn-primary { background: var(--accent); color: #000; }
.btn-secondary { background: transparent; color: var(--accent); border: 1px solid var(--accent); }
.btn-primary:hover, .btn-secondary:hover { opacity: 0.9; }

.search-tips {
  margin-top: 1.5rem; width: 100%; max-width: 500px;
  background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border);
  border-radius: 4px; padding: 1rem;
  font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; color: var(--text-muted);
}
.tip-header {
  color: var(--accent); font-weight: 700; margin-bottom: 0.75rem;
  display: flex; align-items: center; gap: 0.5rem;
  text-transform: uppercase; letter-spacing: 1px;
}
.tip-row { display: flex; align-items: flex-start; gap: 0.75rem; margin-bottom: 0.6rem; line-height: 1.4; }
.cmd-hl { color: var(--text-primary); background: rgba(255, 255, 255, 0.1); padding: 2px 6px; border-radius: 2px; white-space: nowrap; }

/* --- App View --- */
.app-header {
  position: sticky; top: 0; z-index: 100;
  background: rgba(0,0,0,0.95); backdrop-filter: blur(10px);
  padding: 0.75rem 1rem; padding-top: max(0.75rem, var(--safe-top));
  border-bottom: 1px solid var(--border);
  display: flex; justify-content: space-between; align-items: center; gap: 1rem;
}
.header-left { display: flex; align-items: center; gap: 1rem; flex: 1; min-width: 0; }
.logo-btn { font-family: 'JetBrains Mono'; font-weight: 700; color: white; cursor: pointer; flex-shrink: 0; }
.logo-btn:hover { color: var(--accent); }

.mini-search {
  background: var(--bg-input); border: 1px solid var(--border);
  color: white; padding: 0.5rem 1rem; border-radius: 4px;
  font-size: 0.9rem; flex: 1; min-width: 0;
}
.mini-search:focus { outline: none; border-color: var(--accent); }

.header-actions { display: flex; gap: 0.5rem; flex-shrink: 0; }
.icon-btn {
  background: var(--bg-input); border: 1px solid var(--border); color: var(--text-muted);
  width: 36px; height: 36px; border-radius: 4px;
  display: flex; align-items: center; justify-content: center; cursor: pointer;
}
.icon-btn:hover { border-color: var(--accent); color: var(--accent); }
.icon-btn.active { background: var(--accent-dim); color: var(--accent); border-color: var(--accent); }

/* --- Dashboard --- */
.dashboard-container {
  padding: 1rem; padding-bottom: calc(2rem + var(--safe-bottom));
  max-width: 1400px; margin: 0 auto;
  display: none;
}
.dashboard-container.active { display: block; animation: fadeIn 0.8s forwards; }
@keyframes fadeIn { to { opacity: 1; } }

/* Mode Toggle */
.mode-toggle {
  display: flex; gap: 0.5rem; margin-bottom: 1.5rem;
  background: var(--bg-card); padding: 0.5rem; border-radius: 4px; border: 1px solid var(--border);
}
.mode-btn {
  flex: 1; padding: 0.75rem; background: transparent; border: none;
  color: var(--text-muted); font-family: 'JetBrains Mono'; font-size: 0.85rem;
  cursor: pointer; border-radius: 4px; transition: all 0.2s;
  display: flex; align-items: center; justify-content: center; gap: 0.5rem;
}
.mode-btn.active { background: var(--accent-dim); color: var(--accent); }
.mode-btn:hover:not(.active) { color: var(--text-primary); }

/* Stats Row */
.stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem; }
.stat-item {
  background: var(--bg-card); padding: 1rem; border-radius: 4px;
  border: 1px solid var(--border); text-align: center;
}
.stat-label { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.5rem; }
.stat-val { font-size: 1.25rem; font-weight: 700; font-family: 'JetBrains Mono'; color: white; }
.stat-sub { font-size: 0.7rem; color: var(--success); margin-top: 4px; }
.stat-sub.neutral { color: var(--text-muted); }

/* Section Headers */
.section-header {
  display: flex; align-items: center; justify-content: space-between;
  gap: 0.5rem; margin: 2rem 0 1rem 0;
  border-bottom: 1px solid var(--border); padding-bottom: 0.5rem; flex-wrap: wrap;
}
.section-title-group { display: flex; align-items: center; gap: 0.5rem; }
.section-title {
  font-family: 'JetBrains Mono', monospace; font-size: 0.9rem; font-weight: 700;
  color: var(--accent); text-transform: uppercase; letter-spacing: 1px;
}

.header-controls { display: flex; gap: 0.75rem; align-items: center; }
.time-badge {
  font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; color: var(--text-muted);
  border: 1px solid var(--border); padding: 4px 8px; border-radius: 4px;
}

.filter-badge {
  display: none; background: var(--accent-dim); color: var(--accent);
  border: 1px solid var(--accent); padding: 4px 8px; border-radius: 4px;
  font-size: 0.7rem; font-family: 'JetBrains Mono', monospace;
  cursor: pointer; align-items: center; gap: 6px;
}
.filter-badge:hover { background: rgba(212, 196, 168, 0.2); }

/* Chart Containers */
.chart-wrapper {
  background: var(--bg-card); border: 1px solid var(--border);
  border-radius: 4px; padding: 1rem; width: 100%; 
  overflow-x: auto; 
  overflow-y: visible; 
}
.chart-container { 
  width: 100%; 
  min-height: 500px; 
  height: auto;      
  display: block;    
}

/* Feed Grid */
.feed-grid { display: flex; flex-direction: column; gap: 1rem; }
.deal-card {
  background: var(--bg-card); border: 1px solid var(--border);
  border-radius: 4px; padding: 1.25rem; transition: transform 0.1s;
}
.deal-card:active { transform: scale(0.99); }
.deal-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem; }
.deal-agency { 
  font-size: 0.75rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase;
  background: rgba(255,255,255,0.05); padding: 2px 6px; border-radius: 4px;
}
.deal-amount { font-family: 'JetBrains Mono', monospace; color: var(--accent); font-weight: 700; font-size: 1rem; }
.deal-desc { font-size: 1rem; font-weight: 600; margin-bottom: 0.5rem; line-height: 1.4; color: white; }
.deal-vendor { font-size: 0.85rem; color: #8DA0CB; margin-bottom: 0.75rem; font-family: 'JetBrains Mono', monospace; }

.deal-meta { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem; }
.meta-tag {
  font-size: 0.65rem; font-family: 'JetBrains Mono', monospace;
  padding: 3px 8px; border-radius: 3px;
  background: rgba(255,255,255,0.05); color: var(--text-muted); border: 1px solid var(--border);
}
.meta-tag.naics { background: rgba(102, 194, 165, 0.15); border-color: rgba(102, 194, 165, 0.3); color: #66C2A5; }
.meta-tag.psc { background: rgba(141, 160, 203, 0.15); border-color: rgba(141, 160, 203, 0.3); color: #8DA0CB; }

.deal-footer {
  display: flex; justify-content: space-between; align-items: center;
  padding-top: 1rem; border-top: 1px solid #222;
}
.deal-date { font-size: 0.75rem; color: var(--text-muted); }
.action-btn {
  background: var(--bg-input); color: var(--accent); text-decoration: none;
  padding: 0.5rem 1rem; border-radius: 4px; font-size: 0.8rem; font-weight: 600;
  border: 1px solid var(--border); display: flex; align-items: center; gap: 6px;
}
.action-btn:hover { border-color: var(--accent); background: var(--accent-dim); }

/* Forecast Tables */
.forecast-table-wrapper { background: var(--bg-card); border: 1px solid var(--border); overflow-x: auto; border-radius: 4px; }
.forecast-table { width: 100%; border-collapse: collapse; font-family: 'JetBrains Mono'; font-size: 0.8rem; }
.forecast-table th { text-align: left; padding: 1rem; color: var(--text-muted); border-bottom: 1px solid var(--border); }
.forecast-table td { padding: 1rem; border-bottom: 1px solid var(--border); color: var(--text-primary); }
.trend-pill { padding: 2px 6px; border-radius: 2px; font-size: 0.7rem; font-weight: 700; }
.trend-up { color: var(--success); background: rgba(102, 194, 165, 0.1); }
.trend-down { color: var(--danger); background: rgba(251, 128, 114, 0.1); }

/* Insight Grid */
.insight-grid { 
  display: grid; 
  grid-template-columns: repeat(3, 1fr);
  gap: 1rem; 
  margin-bottom: 2rem; 
}
.insight-card { background: var(--bg-card); border: 1px solid var(--border); padding: 1rem; border-radius: 4px; }
.insight-val { font-size: 1.1rem; color: var(--text-primary); font-weight: 700; font-family: 'JetBrains Mono'; }
.insight-label { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.5rem; }

/* View Sections */
.view-section { display: none; }
.view-section.active { display: block; }

/* Loader */
.loader {
  position: fixed; inset: 0; z-index: 300;
  background: rgba(0,0,0,0.9);
  display: none; flex-direction: column; align-items: center; justify-content: center;
}
.spinner { width: 40px; height: 40px; border: 2px solid #333; border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }

/* Methodology Explainer */
.methodology-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 1.5rem;
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 1.5rem;
}
.method-item {
  padding-bottom: 1rem;
  border-bottom: 1px solid var(--border);
}
.method-item:nth-last-child(-n+2) {
  border-bottom: none;
  padding-bottom: 0;
}
.method-title {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.85rem;
  font-weight: 700;
  color: var(--accent);
  margin-bottom: 0.5rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}
.method-title i {
  font-size: 0.75rem;
  opacity: 0.7;
}
.method-desc {
  font-size: 0.8rem;
  color: var(--text-muted);
  line-height: 1.5;
}
.method-desc code {
  background: rgba(255,255,255,0.1);
  padding: 2px 6px;
  border-radius: 3px;
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.75rem;
  color: var(--text-primary);
}
.method-desc strong {
  color: var(--text-primary);
}

/* ========================================
   Drill-Down & Sub-Agency Styles
   ======================================== */

.drill-breadcrumb {
  display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1rem;
  background: linear-gradient(90deg, rgba(212, 196, 168, 0.1), transparent);
  border: 1px solid var(--border); border-radius: 4px; margin-bottom: 1rem;
  font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; overflow-x: auto; white-space: nowrap;
}
.breadcrumb-item {
  display: flex; align-items: center; gap: 0.5rem; color: var(--text-muted); cursor: pointer;
  padding: 4px 8px; border-radius: 4px; transition: all 0.2s;
}
.breadcrumb-item:hover { background: rgba(255,255,255,0.05); color: var(--accent); }
.breadcrumb-item.active { background: var(--accent-dim); color: var(--accent); cursor: default; }
.breadcrumb-separator { color: var(--border); font-size: 0.7rem; }
.breadcrumb-icon { font-size: 0.75rem; }

.drill-hint {
  display: flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.5rem;
  background: rgba(212, 196, 168, 0.05); border: 1px dashed var(--border);
  border-radius: 4px; margin-top: 0.5rem; font-size: 0.75rem; color: var(--text-muted);
}
.drill-hint i { color: var(--accent); }

.subagency-panel {
  background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px;
  margin-top: 1.5rem; overflow: hidden;
}
.subagency-header {
  display: flex; align-items: center; justify-content: space-between; padding: 1rem;
  background: linear-gradient(90deg, rgba(212, 196, 168, 0.08), transparent); border-bottom: 1px solid var(--border);
}
.subagency-header-left { display: flex; align-items: center; gap: 0.75rem; }
.subagency-header-icon {
  width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;
  background: var(--accent-dim); border: 1px solid var(--accent); border-radius: 4px; color: var(--accent);
}
.subagency-header-text h3 {
  margin: 0; font-family: 'JetBrains Mono', monospace; font-size: 0.9rem;
  color: var(--text-primary); font-weight: 600;
}
.subagency-header-text span { font-size: 0.75rem; color: var(--text-muted); }
.subagency-stats { display: flex; gap: 1.5rem; font-family: 'JetBrains Mono', monospace; }
.subagency-stat { text-align: right; }
.subagency-stat-val { font-size: 1rem; font-weight: 700; color: var(--accent); }
.subagency-stat-label { font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase; }

.subagency-list { max-height: 400px; overflow-y: auto; }
.subagency-item {
  display: flex; align-items: center; justify-content: space-between; padding: 1rem;
  border-bottom: 1px solid var(--border); cursor: pointer; transition: all 0.15s;
}
.subagency-item:hover { background: rgba(255,255,255,0.02); }
.subagency-item:last-child { border-bottom: none; }
.subagency-item-left { display: flex; align-items: center; gap: 1rem; flex: 1; min-width: 0; }
.subagency-rank {
  width: 28px; height: 28px; display: flex; align-items: center; justify-content: center;
  background: rgba(255,255,255,0.05); border-radius: 4px; font-family: 'JetBrains Mono', monospace;
  font-size: 0.75rem; color: var(--text-muted); flex-shrink: 0;
}
.subagency-rank.top-3 { background: var(--accent-dim); color: var(--accent); border: 1px solid rgba(212, 196, 168, 0.3); }
.subagency-info { flex: 1; min-width: 0; }
.subagency-name { font-size: 0.9rem; color: var(--text-primary); font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.subagency-contracts { font-size: 0.75rem; color: var(--text-muted); margin-top: 2px; }
.subagency-item-right { display: flex; align-items: center; gap: 1rem; flex-shrink: 0; }
.subagency-bar-container {
  width: 120px; height: 8px; background: rgba(255,255,255,0.05); border-radius: 4px; overflow: hidden;
}
.subagency-bar {
  height: 100%; background: linear-gradient(90deg, var(--accent), rgba(212, 196, 168, 0.5));
  border-radius: 4px; transition: width 0.3s ease;
}
.subagency-amount {
  font-family: 'JetBrains Mono', monospace; font-size: 0.9rem; font-weight: 700;
  color: var(--accent); min-width: 80px; text-align: right;
}
.subagency-drill-icon {
  color: var(--text-muted); font-size: 0.8rem; opacity: 0; transition: all 0.15s;
}
.subagency-item:hover .subagency-drill-icon { opacity: 1; color: var(--accent); transform: translateX(2px); }
.drill-level-indicator {
  display: inline-flex; align-items: center; gap: 0.25rem; padding: 2px 6px;
  background: rgba(102, 194, 165, 0.1); border: 1px solid rgba(102, 194, 165, 0.3);
  border-radius: 4px; font-size: 0.65rem; color: var(--success); margin-left: 0.5rem;
}
.node-drillable { cursor: pointer; }
.node-drillable:hover { filter: brightness(1.2); }
.empty-drill-state { text-align: center; padding: 3rem 2rem; color: var(--text-muted); }
.empty-drill-state i { font-size: 2rem; color: var(--border); margin-bottom: 1rem; }
.empty-drill-state p { margin: 0.5rem 0; }

/* ========================================
   Sales Plan & Channel Styles
   ======================================== */
.sales-plan-card {
  background: linear-gradient(135deg, rgba(212, 196, 168, 0.15) 0%, rgba(212, 196, 168, 0.05) 100%);
  border: 1px solid var(--accent);
  border-radius: 4px;
  padding: 1rem;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
}
.sales-plan-card:hover {
  transform: translateY(-4px); box-shadow: 0 8px 30px rgba(212, 196, 168, 0.4);
  border-color: var(--accent); background: linear-gradient(135deg, rgba(212, 196, 168, 0.25) 0%, rgba(212, 196, 168, 0.1) 100%);
}
.sales-plan-card-icon { font-size: 1.5rem; color: var(--accent); margin-bottom: 0.5rem; }
.sales-plan-card-title { font-size: 0.85rem; font-weight: 700; color: var(--accent); margin-bottom: 0.25rem; text-transform: uppercase; letter-spacing: 1px; }
.sales-plan-card-subtitle { font-size: 0.85rem; color: var(--text-primary); line-height: 1.4; margin-bottom: 0.75rem; }
.sales-plan-card-action { display: inline-flex; align-items: center; gap: 0.5rem; font-size: 0.75rem; color: var(--accent); text-transform: uppercase; letter-spacing: 1px; font-weight: 600; }

.channel-marking-modal {
  display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.9);
  z-index: 500; padding: 2rem; overflow-y: auto;
}
.channel-marking-modal.active { display: flex; align-items: flex-start; justify-content: center; }
.channel-modal-content { background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; max-width: 800px; width: 100%; margin: 2rem auto; }
.channel-modal-header { padding: 1.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
.channel-modal-title { font-size: 1.3rem; font-weight: 700; color: var(--accent); font-family: 'JetBrains Mono', monospace; }
.channel-modal-close {
  background: transparent; border: none; color: var(--text-muted); font-size: 1.5rem; cursor: pointer;
  width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 4px;
}
.channel-modal-close:hover { background: rgba(255, 255, 255, 0.05); color: var(--accent); }
.channel-modal-body { padding: 1.5rem; max-height: 60vh; overflow-y: auto; }
.channel-explanation {
  background: rgba(212, 196, 168, 0.1); border-left: 3px solid var(--accent); padding: 1rem;
  margin-bottom: 1.5rem; font-size: 0.9rem; color: var(--text-primary); line-height: 1.6;
}
.vendor-list-item {
  display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 1rem;
  border: 1px solid var(--border); border-radius: 4px; margin-bottom: 0.5rem; transition: all 0.2s;
}
.vendor-list-item:hover { background: rgba(255, 255, 255, 0.02); border-color: var(--accent); }
.vendor-info { flex: 1; min-width: 0; }
.vendor-name { font-weight: 600; color: var(--text-primary); margin-bottom: 0.25rem; }
.vendor-stats { font-size: 0.75rem; color: var(--text-muted); }
.vendor-toggle { display: flex; align-items: center; gap: 0.5rem; }
.toggle-switch { position: relative; width: 50px; height: 26px; background: #333; border-radius: 13px; cursor: pointer; transition: background 0.3s; }
.toggle-switch.active { background: var(--accent); }
.toggle-slider {
  position: absolute; top: 3px; left: 3px; width: 20px; height: 20px;
  background: white; border-radius: 50%; transition: transform 0.3s;
}
.toggle-switch.active .toggle-slider { transform: translateX(24px); }
.toggle-label { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; min-width: 80px; }
.toggle-switch.active + .toggle-label { color: var(--accent); font-weight: 600; }
.channel-modal-footer { padding: 1.5rem; border-top: 1px solid var(--border); display: flex; gap: 1rem; justify-content: flex-end; }
.modal-btn {
  padding: 0.75rem 1.5rem; border-radius: 4px; font-weight: 600; cursor: pointer;
  transition: all 0.2s; text-transform: uppercase; letter-spacing: 1px; font-size: 0.85rem;
}
.modal-btn-cancel { background: transparent; border: 1px solid var(--border); color: var(--text-muted); }
.modal-btn-cancel:hover { border-color: var(--accent); color: var(--accent); }
.modal-btn-primary { background: var(--accent); border: none; color: #000; }
.modal-btn-primary:hover { opacity: 0.9; transform: translateY(-1px); }
.channel-link {
  display: inline-flex; align-items: center; gap: 0.25rem; font-size: 0.75rem; color: var(--text-muted);
  margin-top: 0.5rem; cursor: pointer; text-decoration: underline;
}
.channel-link:hover { color: var(--accent); }

@media (max-width: 900px) { .insight-grid { grid-template-columns: 1fr; } }
@media (max-width: 768px) {
  .methodology-card { grid-template-columns: 1fr; }
  .method-item { border-bottom: 1px solid var(--border); padding-bottom: 1rem; }
  .method-item:last-child { border-bottom: none; padding-bottom: 0; }
  .subagency-bar-container { display: none; }
  .subagency-stats { flex-direction: column; gap: 0.5rem; }
  .subagency-stat { text-align: left; }
  .stats-row { grid-template-columns: 1fr 1fr; }
  .btn-row { flex-direction: column; }
}
@media (max-width: 600px) {
  .stats-row { grid-template-columns: 1fr; gap: 0.5rem; }
  .stat-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 1rem; }
  .stat-label { margin-bottom: 0; }
  .chart-container { height: 400px; min-width: 600px; }
  .chart-wrapper { overflow-x: auto; }
  .mode-toggle { flex-direction: column; }
}
.chart-wrapper::-webkit-scrollbar { height: 8px; width: 8px; }
.chart-wrapper::-webkit-scrollbar-track { background: var(--bg-card); border-radius: 4px; }
.chart-wrapper::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; border: 1px solid var(--bg-card); }
.chart-wrapper::-webkit-scrollbar-thumb:hover { background: var(--accent); }
</style>
</head>
<body>

<div id="heroView" class="hero-view">
  <div class="terminal-logo"><span>>_</span>Govhoo</div>
  <p class="hero-subtitle">Historical-based Sales Forecasting</p>
  
  <div class="search-box-container">
    <input type="text" id="mainSearchInput" class="main-input" placeholder="Search keywords, company, or agency..." autocomplete="off">
    <div class="btn-row">
      <button id="searchBtn" class="btn-primary">
        <i class="fas fa-search"></i> SEARCH
      </button>
      <button id="forecastBtn" class="btn-secondary">
        <i class="fas fa-chart-line"></i> FORECAST
      </button>
    </div>
  </div>

  <div class="search-tips">
    <div class="tip-header"><i class="fas fa-terminal"></i> SEARCH_TIPS</div>
    <div class="tip-row"><span class="cmd-hl">cloud computing</span> <span>Search award descriptions, vendors, and agencies.</span></div>
    <div class="tip-row"><span class="cmd-hl">Company A, Company B</span> <span>Compare multiple competitors side-by-side.</span></div>
    <div class="tip-row">
      <span class="cmd-hl">Fuzzy Search</span>
      <span>Quotes are ignored. "Pizza" returns pizza contracts AND Pizzaro's Construction. ¯\_(ツ)_/¯</span>
    </div>
	<div class="tip-row"><span class="cmd-hl">Search Mode</span> <span>Drill down by Agency to see Award flow for past 12 months.</span></div>
 <div class="tip-row">
  <span class="cmd-hl">Forecast Mode</span> 
  <span>Estimates TAM using historical data. Features per-quarter outlier detection and volatility risk scoring.</span>
</div>
<div class="tip-row">
  <span class="cmd-hl">Sales Plan Prompt</span> 
  <span>Generates a downloadable prompt you can paste into your LLM of choice to produce a sales plan based on your search.</span>
</div>
	<div class="tip-row">
      <span class="cmd-hl">Questions or Requests?</span>
      <span>DM me on <a href="https://www.linkedin.com/in/markflournoy/" target="_blank" style="color: var(--accent); text-decoration: underline;">LinkedIn</a></span>
    </div>
	<div class="tip-row">
      <span class="cmd-hl">Data sourced live from USASpending.gov</span>
    </div>
  </div>
</div>

<div id="appView" style="display:none;">
  <header class="app-header">
    <div class="header-left">
      <span class="logo-btn" onclick="App.showHero()">>_Govhoo</span>
      <input type="text" id="miniSearch" class="mini-search" placeholder="New search...">
    </div>
    <div class="header-actions">
      <button class="icon-btn" id="toggleModeBtn" onclick="App.toggleMode()" title="Toggle Mode">
        <i class="fas fa-exchange-alt"></i>
      </button>
      <button class="icon-btn" onclick="App.shareLink(this)" title="Copy Share Link">
  <i class="fas fa-link"></i>
</button>

<button class="icon-btn" title="Export CSV" onclick="App.exportCSV(this)">
  <i class="fas fa-download"></i>
</button>
    </div>
  </header>

  <div id="dashboardContainer" class="dashboard-container">
    
    <div class="mode-toggle">
      <button class="mode-btn active" id="modeSearchBtn" onclick="App.setMode('search')">
        <i class="fas fa-project-diagram"></i> Agency Award Flow
      </button>
      <button class="mode-btn" id="modeForecastBtn" onclick="App.setMode('forecast')">
        <i class="fas fa-brain"></i> Annual Forecast (BETA)
      </button>
    </div>

    <div id="searchModeView" class="view-section active">
      <div class="stats-row" id="searchStats">
        <div class="stat-item">
          <div class="stat-label">TCV Awarded</div>
          <div class="stat-val" id="stat-vol">-</div>
          <div class="stat-sub neutral">Past 12 Months</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Contract Count</div>
          <div class="stat-val" id="stat-count">-</div>
          <div class="stat-sub neutral">Past 12 Months</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Prime Vendors</div>
          <div class="stat-val" id="stat-vendors">-</div>
          <div class="stat-sub neutral">Unique Recipients</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Agencies</div>
          <div class="stat-val" id="stat-agencies">-</div>
          <div class="stat-sub neutral">Awarding Agencies</div>
        </div>
      </div>

      <div id="drillBreadcrumb" class="drill-breadcrumb" style="display: none;">
        <div class="breadcrumb-item" onclick="App.resetDrill()">
          <i class="fas fa-globe breadcrumb-icon"></i>
          <span>All Agencies</span>
        </div>
      </div>

      <div class="section-header">
        <div class="section-title-group">
          <i class="fas fa-project-diagram" style="color:var(--accent)"></i>
          <span class="section-title">Award Flow</span>
          <span id="drillLevelBadge" class="drill-level-indicator" style="display:none;">
            <i class="fas fa-layer-group"></i>
            <span id="drillLevelText">Level 1</span>
          </span>
        </div>
        <div class="header-controls">
          <div id="filterBadge" class="filter-badge" onclick="App.clearFilter()">
            <span id="filterName">FILTER</span> <i class="fas fa-times"></i>
          </div>
          <div class="time-badge">PAST 12 MONTHS</div>
        </div>
      </div>
      <div class="chart-wrapper">
        <div id="chartContainer" class="chart-container"></div>
      </div>
      <div id="drillHint" class="drill-hint">
        <i class="fas fa-mouse-pointer"></i>
        <span>Click an <strong>agency bar</strong> to drill into sub-agencies</span>
      </div>

      <div id="subagencyPanel" class="subagency-panel" style="display: none;">
        <div class="subagency-header">
          <div class="subagency-header-left">
            <div class="subagency-header-icon">
              <i class="fas fa-building"></i>
            </div>
            <div class="subagency-header-text">
              <h3 id="subagencyParentName">Department of Defense</h3>
              <span id="subagencyParentType">Parent Agency</span>
            </div>
          </div>
          <div class="subagency-stats">
            <div class="subagency-stat">
              <div class="subagency-stat-val" id="subagencyTotalAmount">$0</div>
              <div class="subagency-stat-label">Total Value</div>
            </div>
            <div class="subagency-stat">
              <div class="subagency-stat-val" id="subagencyCount">0</div>
              <div class="subagency-stat-label">Sub-Agencies</div>
            </div>
          </div>
        </div>
        <div class="subagency-list" id="subagencyList">
          </div>
      </div>

      <div class="section-header">
        <div class="section-title-group">
          <i class="fas fa-list-ul" style="color:var(--accent)"></i>
          <span class="section-title">Contract Award Feed</span>
        </div>
      </div>
      <div id="feedGrid" class="feed-grid"></div>
    </div>

    <div id="forecastModeView" class="view-section">
      <div class="stats-row" id="forecastStats">
        <div class="stat-item">
          <div class="stat-label" style="color:var(--accent); font-weight:700;">Estimated TAM</div>
          <div class="stat-val" id="stat-baseline">-</div>
          <div class="stat-sub neutral">FY Projected Volume</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Market</div>
          <div class="stat-val" id="stat-market">-</div>
          <div class="stat-sub" id="stat-hhi">-</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Peak Season</div>
          <div class="stat-val" id="stat-peak">-</div>
          <div class="stat-sub neutral">Seasonal Index</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Recompetes</div>
          <div class="stat-val" id="stat-recompetes">-</div>
          <div class="stat-sub" style="color:var(--danger)">Expiring < 2Y</div>
        </div>
      </div>

      <div class="section-header">
        <div class="section-title-group">
          <i class="fas fa-brain" style="color:var(--accent)"></i>
          <span class="section-title">Intelligent Forecast</span>
        </div>
      </div>
      <div id="marketInsights" class="insight-grid"></div>

      <div class="forecast-table-wrapper">
        <table class="forecast-table">
          <thead>
            <tr>
              <th>Period</th>
              <th>Predicted</th>
              <th>Hist. Avg</th>
              <th>Trend</th>
              <th>Confidence</th>
            </tr>
          </thead>
          <tbody id="forecastTableBody"></tbody>
        </table>
      </div>
<div class="section-header" style="margin-top:2rem;">
        <div class="section-title-group">
          <i class="fas fa-chart-bar" style="color:var(--accent)"></i>
          <span class="section-title">Historical Performance</span>
        </div>
      </div>
      <div class="chart-wrapper chart-wrapper-sm">
        <canvas id="spendingChart"></canvas>
      </div>
      
<div id="strategySection" style="margin-top: 2rem; display:none;">
  <div class="section-header">
    <div class="section-title-group">
      <i class="fas fa-chess-knight" style="color:var(--accent)"></i>
      <span class="section-title">Strategic Analysis</span>
    </div>
  </div>

  <div class="deal-card" style="border-left: 4px solid var(--accent); margin-bottom: 1.5rem; background: linear-gradient(to right, rgba(212, 196, 168, 0.05), transparent);">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.75rem;">
      <span style="font-size:0.75rem; color:var(--accent); font-weight:700; letter-spacing:1px;">OUTLOOK</span>
      <span id="strat-outlook" style="font-size:1rem; font-weight:700; color:#fff;">--</span>
    </div>
    <div id="strat-text" style="font-size: 0.9rem; color: #ccc; margin-bottom: 1.25rem; line-height: 1.5;"></div>
    <div style="padding-top:1rem; border-top:1px solid rgba(255,255,255,0.1);">
      <div style="font-size:0.7rem; color:#888; text-transform:uppercase; margin-bottom:4px;">Recommended Action</div>
      <div id="strat-action" style="font-size:0.95rem; color:white; font-weight:500;"></div>
    </div>
  </div>

  <div class="insight-grid" style="grid-template-columns: repeat(3, 1fr); gap:0.75rem; margin-bottom: 1.5rem;">
    <div class="insight-card" style="padding: 0.75rem;">
      <div class="insight-label">BD Investment</div>
      <div id="matrix-bd" style="font-size:0.9rem; font-weight:600; color:white; margin:4px 0;">--</div>
      <div class="stat-sub neutral" style="font-size:0.65rem;">vs. Growth Trend</div>
    </div>
    <div class="insight-card" style="padding: 0.75rem;">
      <div class="insight-label">Capture Strategy</div>
      <div id="matrix-strat" style="font-size:0.9rem; font-weight:600; color:white; margin:4px 0;">--</div>
      <div class="stat-sub neutral" style="font-size:0.65rem;">vs. Competition</div>
    </div>
    <div class="insight-card" style="padding: 0.75rem;">
      <div class="insight-label">Pipeline Focus</div>
      <div id="matrix-pipe" style="font-size:0.9rem; font-weight:600; color:white; margin:4px 0;">--</div>
      <div class="stat-sub neutral" style="font-size:0.65rem;">vs. Opportunity</div>
    </div>
  </div>

  <div style="background:rgba(255,255,255,0.02); padding:1rem; border:1px solid #333; border-radius:4px; margin-bottom: 2rem;">
    <div style="display:flex; align-items:center; gap:8px; margin-bottom:0.75rem; color:var(--text-muted); font-size:0.75rem; font-weight:700; letter-spacing:0.5px;">
      <i class="fas fa-info-circle"></i> MODEL LIMITATIONS & LOGIC
    </div>
    <ul style="margin:0; padding-left:1.2rem; color:#888; font-size:0.8rem; line-height:1.6;">
      <li style="margin-bottom:4px;">
        <strong>TAM (Total Addressable Market):</strong> 
        Projected annual volume based on <em>aggregate historical obligations</em> from USASpending. Uses a recency-weighted average of completed Fiscal Years.
      </li>
      <li style="margin-bottom:4px;">
        <strong>Awards vs. Forecast Gap:</strong> 
        "Total Awards" reflects <em>Total Contract Value (Ceiling)</em>. "Forecast" projects <em>Actual Obligated Spending</em> (cash flow). Large deltas represent unfunded ceiling capacity.
      </li>
      <li style="margin-bottom:4px;">
        <strong>Historical Basis:</strong> Forecasts rely entirely on seasonal trends. The model cannot predict budget cuts, policy shifts, or CRs.
      </li>
      <li>
        <strong>Confidence Score:</strong> Based solely on data availability and volatility. "High" requires 3+ years of consistent growth or stable trends.
      </li>
    </ul>
  </div>
</div>

<div class="section-header">
  <div class="section-title-group">
    <i class="fas fa-code-branch" style="color:var(--accent)"></i>
    <span class="section-title">Forecast Methodology</span>
  </div>
</div>

<div class="methodology-card" style="grid-template-columns: repeat(2, 1fr); gap:1rem;">
  <div class="method-item" style="border:none;">
    <div class="method-title"><i class="fas fa-layer-group"></i> Top-Down Volume</div>
    <div class="method-desc">
      Forecasts <strong>Total Annual Spending</strong> using a weighted average of the last 3 fiscal years to create a stable baseline.
    </div>
  </div>
  <div class="method-item" style="border:none;">
    <div class="method-title"><i class="fas fa-chart-area"></i> Seasonality</div>
    <div class="method-desc">
      Analyzes historical spending patterns to determine the unique "shape" of the fiscal year and distributes annual forecast accordingly.
    </div>
  </div>
  <div class="method-item" style="border:none;">
    <div class="method-title"><i class="fas fa-filter"></i> Outlier Removal</div>
    <div class="method-desc">
      Anomalies are filtered on a <strong>per-quarter basis</strong> to distinguish between seasonal spikes and one-off events.
    </div>
  </div>
  <div class="method-item" style="border:none;">
    <div class="method-title"><i class="fas fa-balance-scale"></i> Market Context</div>
    <div class="method-desc">
      Calculates <strong>Herfindahl-Hirschman Index (HHI)</strong> to measure market concentration and competitive density.
    </div>
  </div>
</div>
	  
      <div id="recompetesList" style="margin-top:2rem;"></div>
    </div>
  </div>
</div>
<div id="loader" class="loader">
  <div class="spinner"></div>
  <p id="loaderText" style="margin-top:1rem; font-family:'JetBrains Mono'; color:var(--accent);">RETRIEVING DATA...</p>
  <p id="loaderSubtext" style="color:#666; font-size:0.8rem; margin-top:0.5rem;"></p>
</div>

<div id="salesPlanModal" class="channel-marking-modal">
  <div class="channel-modal-content" style="max-width: 900px; height: 85vh; display:flex; flex-direction:column;">
    <div class="channel-modal-header">
      <div class="channel-modal-title"><i class="fas fa-sliders-h"></i> CONFIGURE SALES PLAN</div>
      <button class="channel-modal-close" onclick="SalesPlanManager.close()"><i class="fas fa-times"></i></button>
    </div>
    
    <div class="channel-modal-body" style="flex:1; overflow-y:auto; padding:0;">
       
       <div style="padding:1.5rem; border-bottom:1px solid var(--border); background:rgba(255,255,255,0.02);">
          <div style="font-size:0.85rem; color:var(--accent); font-weight:700; margin-bottom:1rem; text-transform:uppercase; letter-spacing:1px;">
            <i class="fas fa-bullseye"></i> Step 1: Define Plan Scope
          </div>
          <div style="display:grid; grid-template-columns: 1fr 1fr; gap:1.5rem;">
            <div>
              <label style="display:block; font-size:0.75rem; color:var(--text-muted); margin-bottom:0.5rem; font-weight:600;">PLAN SCOPE / SECTOR</label>
              <select id="spScope" class="main-input" style="padding:0.6rem; font-size:0.9rem; background:var(--bg-app);">
                 <option value="all">Entire Market (All Results)</option>
                 <option value="defense">Defense (DoD & Branches)</option>
                 <option value="civilian">Federal Civilian (Non-DoD)</option>
                 <optgroup label="Specific Agencies" id="spSpecificAgencies">
                   </optgroup>
              </select>
            </div>
            <div>
               <label style="display:block; font-size:0.75rem; color:var(--text-muted); margin-bottom:0.5rem; font-weight:600;">STRATEGIC GOAL</label>
               <select id="spFocus" class="main-input" style="padding:0.6rem; font-size:0.9rem; background:var(--bg-app);">
                 <option value="Growth">Aggressive Growth (New Business)</option>
                 <option value="Retention">Retention (Defend Incumbency)</option>
                 <option value="Partnership">Partner/Channel Strategy</option>
              </select>
            </div>
          </div>
          <p style="margin-top:10px; font-size:0.8rem; color:#666;">
            <i class="fas fa-info-circle"></i> Selecting a specific sector will <strong>recalculate</strong> all market stats (TAM, Competitors, HHI) for that specific slice of data.
          </p>
       </div>

       <div style="padding:1.5rem;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
             <div style="font-size:0.85rem; color:var(--accent); font-weight:700; text-transform:uppercase; letter-spacing:1px;">
               <i class="fas fa-sitemap"></i> Step 2: Classify Market Actors
             </div>
             <div id="spBulkActionContainer"></div>
          </div>
          
          <div style="background:rgba(212, 196, 168, 0.05); padding:0.75rem; border-radius:4px; margin-bottom:1.5rem; font-size:0.8rem; color:var(--text-muted); border-left:2px solid var(--accent);">
            <i class="fas fa-info-circle"></i> <strong>How this works:</strong> Companies marked as "Channels/VARs" are treated as allies in the plan. Unmarked companies are treated as hostile competitors for Battle Card generation.
          </div>

          <div id="spVendorList"></div>
       </div>
    </div>

    <div class="channel-modal-footer" style="background:var(--bg-card); border-top:1px solid var(--border);">
  <div style="flex:1; font-size:0.75rem; color:var(--text-muted); display:flex; align-items:center; gap:1rem;">
      <div id="spDataStatus"></div>
  </div>
  
  <button class="modal-btn modal-btn-cancel" onclick="SalesPlanManager.close()">Cancel</button>
  
  <button class="modal-btn modal-btn-cancel" onclick="SalesPlanManager.generate()" title="Download as .txt file">
    <i class="fas fa-download"></i> File
  </button>
  
  <button id="btnCopyPrompt" class="modal-btn modal-btn-primary" onclick="SalesPlanManager.copyPrompt()">
    <i class="fas fa-copy"></i> COPY PROMPT
  </button>
</div>
  </div>
</div>

<script>
// ==================== UTILITIES ====================
const Utils = {
  money: n => {
    if (!n && n !== 0) return '-';
    if(n >= 1e9) return '$' + (n/1e9).toFixed(1) + 'B';
    if(n >= 1e6) return '$' + (n/1e6).toFixed(1) + 'M';
    if(n >= 1e3) return '$' + (n/1e3).toFixed(0) + 'K';
    return '$' + Math.round(n).toLocaleString();
  },
  trunc: (s, l) => (s && s.length > l) ? s.substring(0,l)+'...' : (s || 'No Description'),
  date: s => s ? new Date(s).toLocaleDateString() : '—',
  formatDateISO: date => date.toISOString().split('T')[0],
  
  getCurrentFY: () => {
    const now = new Date();
    // Federal FY starts Oct 1 (Month 9)
    return now.getMonth() >= 9 ? now.getFullYear() + 1 : now.getFullYear();
  },

  getCurrentQuarter: () => {
    const m = new Date().getMonth(); // 0-11
    if (m >= 9) return 1;
    if (m <= 2) return 2;
    if (m <= 5) return 3;
    return 4;
  },
  
  getColor: name => {
    const palette = ['#958BB6', '#6F8A74', '#C27E5C', '#8FB6D0', '#B0C4DE', '#D9B48F'];
    let hash = 0;
    for (let i = 0; i < name.length; i++) {
      hash = name.charCodeAt(i) + ((hash << 5) - hash);
    }
    return palette[Math.abs(hash) % palette.length];
  }
};

// ==================== API ====================
const API = {
  baseUrl: 'https://api.usaspending.gov/api/v2',
  
  // Search Mode API
  async searchAwards(keywords) {
    const today = new Date();
    const oneYearAgo = new Date();
    oneYearAgo.setFullYear(today.getFullYear() - 1);
    
    const period = {
      start_date: Utils.formatDateISO(oneYearAgo),
      end_date: Utils.formatDateISO(today)
    };
    
    const terms = keywords.split(',').map(s => s.trim()).filter(s => s.length > 0);
    
    const fetchPromises = terms.map(term => {
      return fetch(`${this.baseUrl}/search/spending_by_award/`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          filters: { 
            keywords: [term], 
            time_period: [period],
            award_type_codes: ['A','B','C','D']
          },
          fields: [
            'Award ID', 'Recipient Name', 'Awarding Agency', 'Awarding Sub Agency',
            'Award Amount', 'Description', 'generated_internal_id',
            'Start Date', 'End Date', 'NAICS Code', 'NAICS Description', 'PSC Code', 'PSC Description'
          ],
          limit: 100,
          sort: 'Award Amount',
          order: 'desc'
        })
      }).then(res => res.json());
    });
    
    const results = await Promise.all(fetchPromises);
    let combined = [];
    results.forEach(json => {
      if(json.results) combined = combined.concat(json.results);
    });
    
    // Deduplicate
    const unique = new Map();
    combined.forEach(item => {
      if(!unique.has(item['Award ID'])) unique.set(item['Award ID'], item);
    });
    
    return Array.from(unique.values()).sort((a,b) => b['Award Amount'] - a['Award Amount']);
  },
  
  // Forecast Mode APIs
  async getSpendingOverTime(keywords, yearsBack=4) {
    const curFY = Utils.getCurrentFY();
    const periods = [];
    // Get extra history to establish trends
    for(let y=curFY-yearsBack; y<=curFY; y++) {
      periods.push({start_date:`${y-1}-10-01`, end_date:`${y}-09-30`});
    }
    
    const res = await fetch(`${this.baseUrl}/search/spending_over_time/`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        group: 'quarter',
        filters: { keywords:[keywords], time_period:periods, award_type_codes:['A','B','C','D'] }
      })
    });
    return (await res.json()).results || [];
  },
  
  async getAgencyData(keywords, yearsBack=3) {
    const curFY = Utils.getCurrentFY();
    const periods = [{start_date:`${curFY-yearsBack-1}-10-01`, end_date:`${curFY}-09-30`}];
    
    const res = await fetch(`${this.baseUrl}/search/spending_by_category/awarding_agency`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        category: 'awarding_agency',
        filters: { keywords:[keywords], time_period:periods, award_type_codes:['A','B','C','D'] },
        limit: 100
      })
    });
    return (await res.json()).results || [];
  },
  
  async getAwardsForForecast(keywords, yearsBack=3) {
    const curFY = Utils.getCurrentFY();
    // We want current active contracts primarily
    const periods = [{start_date:`${curFY-yearsBack-1}-10-01`, end_date:`${curFY+5}-09-30`}];
    
    const res = await fetch(`${this.baseUrl}/search/spending_by_award/`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        filters: { keywords:[keywords], time_period:periods, award_type_codes:['A','B','C','D'] },
        fields: [
          'Award ID', 'Recipient Name', 'Description', 'Start Date', 'End Date', 
          'Award Amount', 'Awarding Agency', 'Awarding Sub Agency', 'generated_internal_id',
          'NAICS Code', 'NAICS Description', 'PSC Code', 'PSC Description'
        ],
        // FIX: Sort by Amount DESC to get big contracts, not "End Date DESC" which gives contracts ending in 2030
        limit: 100, 
        sort: 'Award Amount',
        order: 'desc'
      })
    });
    return (await res.json()).results || [];
  }
};

// ==================== FORECAST ENGINE (RESTORED STRICT LOGIC) ====================
const ForecastEngine = {
  analyze(spendingData, awardsData, agencyData) {
    const organized = this.organizeByQuarter(spendingData);
    const filtered = this.filterOutliers(organized);
    const seasonalProfile = this.calculateSeasonalProfile(filtered);
    const annualForecast = this.calculateAnnualForecast(filtered);
    const recompetes = this.detectRecompetes(awardsData);
    const market = this.analyzeMarketConcentration(agencyData);
    const forecasts = this.generateForecasts(annualForecast, seasonalProfile, filtered);
    const strategy = this.generateStrategy(forecasts, market.hhi, recompetes);
    
    return { 
      forecasts, 
      recompetes, 
      baseline: annualForecast, 
      marketStatus: market.level, 
      hhi: market.hhi, 
      indices: seasonalProfile, 
      byFY: organized.byFY, 
      strategy 
    };
  },

  organizeByQuarter(spendingData) {
    const organized = { byFY: {}, byQuarter: {}, totalByFY: {}, allAmounts: [] };
    spendingData.forEach(d => {
      const q = parseInt(d.time_period?.quarter); 
      const fy = parseInt(d.time_period?.fiscal_year); 
      const amt = d.aggregated_amount || 0;
      if(q && fy) {
        if(!organized.byFY[fy]) organized.byFY[fy] = {1:0, 2:0, 3:0, 4:0};
        organized.byFY[fy][q] = amt; 
        if(!organized.byQuarter[q]) organized.byQuarter[q] = [];
        organized.byQuarter[q].push({fy, amt}); 
        organized.totalByFY[fy] = (organized.totalByFY[fy] || 0) + amt;
        organized.allAmounts.push({fy, q, amt});
      }
    });
    return organized;
  },

  filterOutliers(organized) {
    const filtered = { byFY: {}, byQuarter: {}, totalByFY: {}, allAmounts: [] };
    Object.keys(organized.byFY).forEach(fy => filtered.byFY[fy] = {});
    for(let q=1; q<=4; q++) {
      const qData = organized.byQuarter[q] || []; 
      const amounts = qData.map(d => d.amt);
      if(amounts.length < 3) {
        qData.forEach(d => { 
           filtered.byQuarter[q] = filtered.byQuarter[q] || []; 
           filtered.byQuarter[q].push(d); 
           filtered.byFY[d.fy][q] = d.amt; 
           filtered.totalByFY[d.fy] = (filtered.totalByFY[d.fy]||0) + d.amt; 
        });
        continue;
      }
      const mean = amounts.reduce((a,b)=>a+b,0) / amounts.length;
      const variance = amounts.reduce((s,v)=>s+Math.pow(v-mean,2),0) / amounts.length;
      const stdDev = Math.sqrt(variance);
      const limit = mean + (2 * stdDev);
      qData.forEach(item => {
        if(item.amt <= limit) {
           filtered.byQuarter[q] = filtered.byQuarter[q] || []; 
           filtered.byQuarter[q].push(item); 
           filtered.byFY[item.fy][q] = item.amt; 
           filtered.totalByFY[item.fy] = (filtered.totalByFY[item.fy]||0) + item.amt;
        }
      });
    }
    return filtered;
  },

  calculateSeasonalProfile(filtered) {
    const quarters = {1:0, 2:0, 3:0, 4:0}; 
    const counts = {1:0, 2:0, 3:0, 4:0};
    Object.keys(filtered.totalByFY).forEach(fy => {
        const total = filtered.totalByFY[fy]; 
        if(total <= 0) return;
        const qWithData = Object.values(filtered.byFY[fy]).filter(v => v > 0).length;
        if(qWithData < 3) return;
        for(let q=1; q<=4; q++) { 
            const amt = filtered.byFY[fy][q] || 0;
            quarters[q] += (amt / total); 
            counts[q]++; 
        }
    });
    const profile = {}; 
    let sum = 0;
    for(let q=1; q<=4; q++) { 
        profile[q] = counts[q] ? quarters[q] / counts[q] : 0.25; 
        sum += profile[q]; 
    }
    for(let q=1; q<=4; q++) profile[q] = profile[q] / sum;
    return profile;
  },

  calculateAnnualForecast(filtered) {
    const curFY = Utils.getCurrentFY();
    const years = Object.keys(filtered.totalByFY).map(Number).sort((a,b)=>a-b);
    const cleanYears = years.filter(y => y < curFY && filtered.totalByFY[y] > 0);
    if(cleanYears.length === 0) return 0;
    
    let weightedSum = 0; 
    let weightTotal = 0;
    cleanYears.forEach((fy, index) => { 
        const weight = index + 1; 
        weightedSum += filtered.totalByFY[fy] * weight; 
        weightTotal += weight; 
    });
    
    let baseline = weightedSum / weightTotal;
    if(cleanYears.length >= 2) {
        const recentYear = filtered.totalByFY[cleanYears[cleanYears.length-1]];
        baseline = (baseline * 0.7) + (recentYear * 0.3);
    }
    return baseline;
  },

  analyzeMarketConcentration(agencyData) {
    const total = agencyData.reduce((s,a)=>s+a.amount,0); 
    let hhi = 0;
    agencyData.forEach(a => { 
      const share = (a.amount / total) * 100; 
      hhi += share * share; 
    });
    let level = "Competitive";
    if(hhi > 2500) level = "Concentrated";
    else if(hhi > 1500) level = "Moderate";
    return { hhi: Math.round(hhi), level };
  },

  detectRecompetes(awards) {
    const now = new Date(); 
    const sixMonths = new Date(); sixMonths.setMonth(now.getMonth() + 6); 
    const twoYears = new Date(); twoYears.setFullYear(now.getFullYear()+2);
    return awards.filter(a => { 
      const end = new Date(a['End Date']); 
      return end > sixMonths && end < twoYears && a['Award Amount'] > 50000; 
    }).slice(0, 15);
  },

  generateForecasts(annualForecast, seasonalProfile, filtered) {
    const forecasts = []; 
    const curFY = Utils.getCurrentFY(); 
    const curQ = Utils.getCurrentQuarter();
    
    let fy = curFY; 
    let q = curQ;
    
    for(let i=0; i<4; i++) {
      const predicted = annualForecast * seasonalProfile[q];
      const qHistory = filtered.byQuarter[q] || [];
      const activeYears = qHistory.filter(d => d.amt > 0).sort((a,b) => a.fy - b.fy);
      const trueAvg = qHistory.length ? qHistory.reduce((s, d) => s + d.amt, 0) / qHistory.length : 0;
      
      let volatility = 0;
      if(activeYears.length > 1) {
          const activeAvg = activeYears.reduce((s, d) => s + d.amt, 0) / activeYears.length;
          const variance = activeYears.reduce((s, d) => s + Math.pow(d.amt - activeAvg, 2), 0) / (activeYears.length - 1);
          volatility = Math.sqrt(variance) / activeAvg;
      }

      let isStrictGrowth = false;
      if (activeYears.length >= 3) {
          isStrictGrowth = true;
          for(let k=1; k<activeYears.length; k++) {
              if (activeYears[k].amt <= activeYears[k-1].amt) {
                  isStrictGrowth = false;
                  break;
              }
          }
      }

      let displayTrend = 0;
      if(trueAvg > 0) displayTrend = ((predicted - trueAvg) / trueAvg) * 100;
      else if (predicted > 0) displayTrend = 100;

      // --- STRICTER CONFIDENCE LOGIC FROM INDEX.HTML ---
      let confLabel = "Low";
      let confReason = "Insufficient Data";

      if (qHistory.length === 0) {
          confLabel = "Low"; confReason = "No History";
      } else if (activeYears.length === 0) {
          confLabel = "Low"; confReason = "Inactive";
      } else {
          const isFrequent = activeYears.length >= 3;
          const hasGaps = activeYears.length < qHistory.length; 
          
          if (isFrequent && !hasGaps) {
              if (isStrictGrowth) {
                  confLabel = "High";
                  confReason = "Consistent Growth";
              } else if (volatility < 0.5) { // Stricter volatility check
                  confLabel = "High";
                  confReason = "Stable Trend";
              } else if (volatility < 1.0) {
                  confLabel = "Med";
                  confReason = "Moderate Variance";
              } else {
                  confLabel = "Low";
                  confReason = "High Volatility";
              }
          } 
          else if (isFrequent && hasGaps) {
              confLabel = "Med"; confReason = "Intermittent";
          } 
          else {
              if (volatility < 0.2) { confLabel = "Med"; confReason = "Limited but Stable"; }
              else { confLabel = "Low"; confReason = "Limited History"; }
          }
      }

      forecasts.push({
        period: `FY${fy} Q${q}`,
        predicted: predicted,
        histAvg: trueAvg,
        trend: displayTrend > 0 ? `+${displayTrend.toFixed(1)}` : displayTrend.toFixed(1),
        confidence: { label: confLabel, reason: confReason }
      });
      
      q++;
      if(q > 4) { q = 1; fy++; }
    }
    return forecasts;
  },

  generateStrategy(forecasts, hhi, recompetes) {
    if(!forecasts || forecasts.length < 2) return null;

    const nearTerm = forecasts.slice(0, 2);
    const avgGrowth = nearTerm.reduce((sum, f) => sum + parseFloat(f.trend), 0) / nearTerm.length;
    
    let growthSignal = "Moderate";
    if (avgGrowth > 30) growthSignal = "High Growth"; 
    else if (avgGrowth < -20) growthSignal = "Decline";

    let marketType = "Moderate";
    if (hhi > 2500) marketType = "Concentrated";
    else if (hhi < 1500) marketType = "Competitive";

    // --- RICHER STRATEGIC TEXT FROM INDEX.HTML ---
    let outlook = "";
    let action = "";
    
    if (growthSignal === "High Growth") {
        outlook = `The model projects positive variance (+${avgGrowth.toFixed(1)}% avg) compared to historical baselines. While data suggests upward momentum, users should verify if this is due to new funding or statistical anomalies in prior years.`;
        action = "Validate pipeline depth. Assess capacity before committing additional resources.";
    } else if (growthSignal === "Decline") {
        outlook = `The model projects a softening trend (${avgGrowth.toFixed(1)}% avg). Volume may be lower than historical norms for this period.`;
        action = "Focus business development efforts strictly on high-probability recompetes and existing relationships.";
    } else {
        outlook = `The model suggests stability, with projected volume tracking close to historical averages.`;
        action = "Maintain consistent business development cadence. Focus on capture quality over volume.";
    }

    if (marketType === "Concentrated") {
        outlook += ` High concentration (HHI > 2500) suggests incumbent dominance.`;
        action += " Teaming with incumbents is recommended.";
    } else if (marketType === "Competitive") {
        outlook += ` Low concentration (HHI < 1500) implies a fragmented landscape.`;
        action += " A broader prospecting approach may yield results.";
    }

    const matrix = {
        bd: growthSignal === "High Growth" ? "Validate & Assess" : (growthSignal === "Decline" ? "Selective Focus" : "Maintain Steady"),
        strat: marketType === "Concentrated" ? "Relationship Focus" : (marketType === "Competitive" ? "Volume Bidding" : "Balanced Approach"),
        pipe: recompetes.length > 5 ? "Incumbent Displacement" : "New Requirements"
    };

    return {
        title: growthSignal === "High Growth" ? "Growth Projected" : (growthSignal === "Decline" ? "Softening Projected" : "Stable Outlook"),
        text: outlook,
        action: action,
        matrix: matrix
    };
  }
};
// ==================== SALES PLAN MANAGER (FIXED) ====================
const SalesPlanManager = {
  channels: new Set(),
  currentVendors: [], 

  init() {
    const saved = localStorage.getItem('govhoo_channels');
    if (saved) this.channels = new Set(JSON.parse(saved));
  },

  isChannel(vendorName) { return this.channels.has(vendorName); },

  // --- UI Actions ---
  open() {
    // 1. Data Availability Check
    const awards = App.forecastData.awards || App.searchData.raw || [];
    if (!awards.length) {
      alert("No award data loaded. Please run a search or forecast first."); // Fixed: Used alert
      return;
    }

    // 2. Populate Agency Dropdown
    const agencyCounts = {};
    awards.forEach(r => {
      const ag = r['Awarding Agency'];
      if(ag) agencyCounts[ag] = (agencyCounts[ag] || 0) + 1;
    });
    
    const sortedAgencies = Object.entries(agencyCounts)
      .sort((a,b) => b[1] - a[1])
      .map(([name, count]) => `<option value="${name}">${name} (${count} awards)</option>`)
      .join('');
      
    document.getElementById('spSpecificAgencies').innerHTML = sortedAgencies;
    document.getElementById('spScope').value = 'all'; 

    // 3. Prepare Vendor List
    this.prepareVendorList(awards);
    this.updateStatus(awards.length, "Entire Market");
    this.renderList();
    document.getElementById('salesPlanModal').classList.add('active');
  },

  close() {
    document.getElementById('salesPlanModal').classList.remove('active');
  },

  // --- Data Processing Helper ---
  getFilteredData() {
    const scope = document.getElementById('spScope').value;
    const focus = document.getElementById('spFocus').value;
    const rawAwards = App.forecastData.awards || App.searchData.raw || [];
    
    let filteredAwards = [];
    let scopeName = "Entire Market";

    if (scope === 'all') {
        filteredAwards = rawAwards;
    } else if (scope === 'defense') {
        filteredAwards = rawAwards.filter(r => /defense|army|navy|air force|marine|space force/i.test(r['Awarding Agency']));
        scopeName = "Defense Sector";
    } else if (scope === 'civilian') {
        filteredAwards = rawAwards.filter(r => !/defense|army|navy|air force|marine|space force/i.test(r['Awarding Agency']));
        scopeName = "Federal Civilian Sector";
    } else {
        filteredAwards = rawAwards.filter(r => r['Awarding Agency'] === scope);
        scopeName = scope;
    }

    if (filteredAwards.length === 0) throw new Error("No awards found for the selected scope.");

    return { filteredAwards, scopeName, focus };
  },

  // --- Output Actions ---
  generate() {
    App.showLoader('GENERATING PLAN...', 'Filtering data & packaging prompt...');
    setTimeout(() => {
      try {
        const { filteredAwards, scopeName, focus } = this.getFilteredData();
        
        // Build and Download - pass forecast analysis if available
        const analysis = App.mode === 'forecast' ? App.forecastData.analysis : null;
        const pkg = PromptPackageGenerator.buildPackage(filteredAwards, analysis, { scope: scopeName, focus });
        PromptPackageGenerator.downloadPackage(pkg);
        
        this.close();
        // Success is indicated by the file download starting
      } catch(e) { 
        console.error(e); 
        alert(e.message || "Error generating plan"); // Fixed: Used alert
      } finally { 
        App.hideLoader(); 
      }
    }, 500);
  },

  async copyPrompt() {
    const btn = document.getElementById('btnCopyPrompt');
    if (!btn) return;

    const originalText = btn.innerHTML;
    const originalBg = btn.style.background;
    const originalColor = btn.style.color;
    
    // Loading State
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> GENERATING...';
    btn.style.opacity = '0.8';
    btn.style.pointerEvents = 'none';
    
    try {
      const { filteredAwards, scopeName, focus } = this.getFilteredData();
      const analysis = App.mode === 'forecast' ? App.forecastData.analysis : null;
      const pkg = PromptPackageGenerator.buildPackage(filteredAwards, analysis, { scope: scopeName, focus });
      
      // Copy to clipboard
      await navigator.clipboard.writeText(pkg);
      
      // Success State (Green Button)
      btn.style.opacity = '1';
      btn.style.background = 'var(--success)';
      btn.style.color = '#000';
      btn.style.borderColor = 'var(--success)';
      btn.innerHTML = '<i class="fas fa-check"></i> COPIED';
      
      // Close after 2 seconds
      setTimeout(() => {
        this.close();
        // Reset button
        btn.style.background = originalBg;
        btn.style.color = originalColor;
        btn.style.borderColor = '';
        btn.innerHTML = originalText;
        btn.style.pointerEvents = 'auto';
      }, 2000);

    } catch(e) {
      console.error(e);
      alert(e.message || "Error copying prompt"); // Fixed: Used alert
      
      // Reset button immediately on error
      btn.style.opacity = '1';
      btn.style.background = originalBg;
      btn.style.color = originalColor;
      btn.innerHTML = originalText;
      btn.style.pointerEvents = 'auto';
    }
  },

  // --- Vendor List Helpers ---
  prepareVendorList(dataSlice) {
    const vendorSpend = {}; 
    let total = 0;
    
    dataSlice.forEach(r => { 
      const v = r['Recipient Name'] || 'Unknown'; 
      const a = parseFloat(r['Award Amount']) || 0; 
      vendorSpend[v] = (vendorSpend[v] || 0) + a; 
      total += a; 
    });
    
    this.currentVendors = Object.entries(vendorSpend)
      .map(([v, s]) => ({ 
        vendor: v, 
        spend: s, 
        marketShare: total > 0 ? ((s / total) * 100).toFixed(2) : "0.00", 
        contractCount: dataSlice.filter(r => r['Recipient Name'] === v).length 
      }))
      .sort((a, b) => b.spend - a.spend)
      .slice(0, 25);
  },

  updateStatus(count, scopeName) {
    const statusEl = document.getElementById('spDataStatus');
    if(!statusEl) return;
    statusEl.innerHTML = `
      <span style="color:var(--success); display:flex; align-items:center; gap:6px;">
        <i class="fas fa-check-circle"></i> Data Ready
      </span>
      <span style="margin-left:8px; opacity:0.5;">|</span>
      <span style="margin-left:8px;">Scope: <strong>${scopeName}</strong> (${count} awards)</span>
    `;
  },

  // --- Toggle Logic ---
  toggleChannel(vendorName) {
    if (this.channels.has(vendorName)) this.channels.delete(vendorName);
    else this.channels.add(vendorName);
    this.save();
  },

  toggleAll() {
    const allMarked = this.currentVendors.every(v => this.isChannel(v.vendor));
    if (allMarked) this.currentVendors.forEach(v => this.channels.delete(v.vendor));
    else this.currentVendors.forEach(v => this.channels.add(v.vendor));
    
    this.save();
    this.renderList(); 
  },

  save() { 
    localStorage.setItem('govhoo_channels', JSON.stringify([...this.channels])); 
  },

  // --- Rendering ---
  renderList() {
    const list = document.getElementById('spVendorList');
    const container = document.getElementById('spBulkActionContainer');
    if(!list || !container) return;

    const allMarked = this.currentVendors.length > 0 && this.currentVendors.every(v => this.isChannel(v.vendor));
    
    container.innerHTML = `
      <button onclick="SalesPlanManager.toggleAll()" style="background:transparent; border:1px solid var(--border); color:var(--accent); padding:6px 12px; border-radius:4px; cursor:pointer; font-size:0.7rem; font-family:'JetBrains Mono'; display:flex; align-items:center; gap:6px;">
        <i class="far ${allMarked ? 'fa-square' : 'fa-check-square'}"></i> ${allMarked ? 'UNMARK ALL' : 'MARK ALL CHANNELS'}
      </button>
    `;

    if (this.currentVendors.length === 0) {
        list.innerHTML = `<div style="text-align:center; padding:1rem; color:#666;">No vendors found in this scope.</div>`;
        return;
    }

    list.innerHTML = this.currentVendors.map(v => `
      <div class="vendor-list-item">
        <div class="vendor-info">
          <div class="vendor-name">${v.vendor}</div>
          <div class="vendor-stats">${v.contractCount} contracts • ${Utils.money(v.spend)} • ${v.marketShare}% share</div>
        </div>
        <div class="vendor-toggle">
          <div class="toggle-switch ${this.isChannel(v.vendor) ? 'active' : ''}" onclick="SalesPlanManager.toggleItem('${v.vendor.replace(/'/g, "\\'")}', this)">
            <div class="toggle-slider"></div>
          </div>
          <div class="toggle-label">${this.isChannel(v.vendor) ? 'Channel/VAR' : 'Competitor'}</div>
        </div>
      </div>
    `).join('');
  },

  toggleItem(vendorName, element) {
    this.toggleChannel(vendorName);
    const toggle = element; 
    const label = element.nextElementSibling;
    if (this.isChannel(vendorName)) { toggle.classList.add('active'); label.textContent = 'Channel/VAR'; }
    else { toggle.classList.remove('active'); label.textContent = 'Competitor'; }
    
    // Quick update bulk button
    const allMarked = this.currentVendors.every(v => this.isChannel(v.vendor));
    const btn = document.querySelector('#spBulkActionContainer button');
    if(btn) btn.innerHTML = `<i class="far ${allMarked ? 'fa-square' : 'fa-check-square'}"></i> ${allMarked ? 'UNMARK ALL' : 'MARK ALL CHANNELS'}`;
  }
};
// ==================== APP CORE ====================
const App = {
  mode: 'search', 
  currentQuery: '',
  searchData: { raw: [], active: [], filter: null, loaded: false },
  forecastData: { spending: null, agencies: null, awards: null, analysis: null, loaded: false },
  drillState: { level: 0, path: [], currentAgency: null, currentSubAgency: null },

  init() {
    SalesPlanManager.init();
    
    // Event Listeners
    document.getElementById('searchBtn').onclick = () => App.runSearch();
    document.getElementById('forecastBtn').onclick = () => App.runForecast();
    document.getElementById('mainSearchInput').addEventListener('keypress', e => { if(e.key === 'Enter') App.runSearch(); });
    document.getElementById('miniSearch').addEventListener('keypress', e => { if(e.key === 'Enter') { document.getElementById('mainSearchInput').value = e.target.value; App.mode === 'forecast' ? App.runForecast(e.target.value) : App.runSearch(e.target.value); } });
    window.addEventListener('resize', () => { setTimeout(() => { if(App.searchData.active.length > 0 && App.mode === 'search') App.renderSankey(); }, 200); });

    const params = new URLSearchParams(window.location.search);
    const q = params.get('q');
    const mode = params.get('mode');

    if (q) {
      document.getElementById('mainSearchInput').value = q;
      
      if (mode === 'forecast') {
        App.runForecast(q);
      } else {
        App.runSearch(q);
      }
    }
  },

  showHero() {
    document.getElementById('appView').style.display = 'none';
    const hero = document.getElementById('heroView'); hero.style.display = 'flex'; hero.classList.remove('hidden');
    setTimeout(() => hero.classList.remove('slide-up'), 10);
  },

  setMode(mode) {
    App.mode = mode;
    document.getElementById('modeSearchBtn').classList.toggle('active', mode === 'search');
    document.getElementById('modeForecastBtn').classList.toggle('active', mode === 'forecast');
    document.getElementById('searchModeView').classList.toggle('active', mode === 'search');
    document.getElementById('forecastModeView').classList.toggle('active', mode === 'forecast');
    if(App.currentQuery) {
      if(mode === 'search' && !App.searchData.loaded) App.runSearch(App.currentQuery);
      else if(mode === 'forecast' && !App.forecastData.loaded) App.runForecast(App.currentQuery);
    }
  },

  toggleMode() { App.setMode(App.mode === 'search' ? 'forecast' : 'search'); },

  // --- Search Mode ---
  async runSearch(val) {
    const query = val || document.getElementById('mainSearchInput').value; if(!query) return;
    if(query !== App.currentQuery) { App.searchData = { raw: [], active: [], filter: null, loaded: false }; App.forecastData = { loaded: false }; App.resetDrill(); }
    App.currentQuery = query; App.mode = 'search'; App.showLoader('RETRIEVING DATA...', 'Searching USASpending API');
    try {
      App.searchData.raw = await API.searchAwards(query); App.searchData.active = App.searchData.raw; App.searchData.loaded = true;
      App.transitionToApp(); App.setMode('search'); App.updateSearchDashboard(); requestAnimationFrame(() => App.renderSankey());
    } catch(e) { console.error(e); alert("Error retrieving data."); } finally { App.hideLoader(); }
  },

  updateSearchDashboard() {
    const data = App.searchData.active;
    document.getElementById('stat-vol').innerText = Utils.money(data.reduce((acc, c) => acc + (c['Award Amount']||0), 0));
    document.getElementById('stat-count').innerText = data.length;
    document.getElementById('stat-vendors').innerText = new Set(data.map(c => c['Recipient Name'])).size;
    document.getElementById('stat-agencies').innerText = new Set(data.map(c => c['Awarding Agency'])).size;
    const badge = document.getElementById('filterBadge');
    if (App.searchData.filter) { badge.style.display = 'inline-flex'; document.getElementById('filterName').innerText = App.searchData.filter; } else badge.style.display = 'none';
    App.renderFeed(); App.updateDrillUI();
  },

  // --- Drill Down Logic ---
  resetDrill() { App.drillState = { level: 0, path: [], currentAgency: null, currentSubAgency: null }; App.searchData.filter = null; App.searchData.active = App.searchData.raw; App.updateSearchDashboard(); App.renderSankey(); },
  
  updateDrillUI() {
    const bc = document.getElementById('drillBreadcrumb'); const hint = document.getElementById('drillHint'); const lvl = document.getElementById('drillLevelBadge');
    if (App.drillState.level === 0) {
      bc.style.display = 'none'; hint.style.display = 'flex'; lvl.style.display = 'none'; document.getElementById('subagencyPanel').style.display = 'none';
      hint.innerHTML = `<i class="fas fa-mouse-pointer"></i><span>Click an <strong>agency bar</strong> to drill into sub-agencies</span>`;
    } else {
      bc.style.display = 'flex'; lvl.style.display = 'inline-flex';
      let html = `<div class="breadcrumb-item" onclick="App.resetDrill()"><i class="fas fa-globe breadcrumb-icon"></i><span>All Agencies</span></div>`;
      App.drillState.path.forEach((p, i) => html += `<span class="breadcrumb-separator"><i class="fas fa-chevron-right"></i></span><div class="breadcrumb-item ${i===App.drillState.path.length-1?'active':''}" onclick="${i===App.drillState.path.length-1?'':`App.drillToLevel(${i+1})`}"><span>${Utils.trunc(p.name, 25)}</span></div>`);
      bc.innerHTML = html; document.getElementById('drillLevelText').innerText = App.drillState.level === 1 ? 'Agency View' : 'Sub-Agency View';
      if (App.drillState.level === 1) { hint.innerHTML = `<i class="fas fa-layer-group"></i><span>Click a <strong>sub-agency</strong> to see vendor breakdown</span>`; App.renderSubAgencyPanel(); }
      else { document.getElementById('subagencyPanel').style.display = 'none'; hint.innerHTML = `<i class="fas fa-check-circle" style="color:var(--success)"></i><span>Viewing vendor breakdown</span>`; }
    }
  },

  renderSubAgencyPanel() {
    const list = document.getElementById('subagencyList');
    const contracts = App.searchData.raw.filter(d => d['Awarding Agency'] === App.drillState.currentAgency);
    const map = {}; contracts.forEach(c => { const sa = c['Awarding Sub Agency'] || 'Unknown'; map[sa] = map[sa] || {amount:0, count:0}; map[sa].amount += c['Award Amount']||0; map[sa].count++; });
    const subs = Object.entries(map).map(([k,v]) => ({name:k, ...v})).sort((a,b) => b.amount - a.amount);
    document.getElementById('subagencyParentName').innerText = Utils.trunc(App.drillState.currentAgency, 40);
    document.getElementById('subagencyTotalAmount').innerText = Utils.money(subs.reduce((s,x)=>s+x.amount,0));
    document.getElementById('subagencyCount').innerText = subs.length;
    list.innerHTML = subs.map((s,i) => `<div class="subagency-item" onclick="App.drillToSubAgency('${s.name.replace(/'/g, "\\'")}')"><div class="subagency-item-left"><div class="subagency-rank ${i<3?'top-3':''}">${i+1}</div><div class="subagency-info"><div class="subagency-name">${s.name}</div><div class="subagency-contracts">${s.count} contracts</div></div></div><div class="subagency-item-right"><div class="subagency-bar-container"><div class="subagency-bar" style="width:${(s.amount/subs[0].amount)*100}%"></div></div><div class="subagency-amount">${Utils.money(s.amount)}</div><i class="fas fa-chevron-right subagency-drill-icon"></i></div></div>`).join('');
    document.getElementById('subagencyPanel').style.display = 'block';
  },

  drillToAgency(name) { App.drillState = { level: 1, currentAgency: name, currentSubAgency: null, path: [{type:'agency', name}] }; App.searchData.active = App.searchData.raw.filter(d => d['Awarding Agency'] === name); App.searchData.filter = name; App.updateSearchDashboard(); App.renderSankey(); },
  drillToSubAgency(name) { App.drillState.level = 2; App.drillState.currentSubAgency = name; App.drillState.path = [{type:'agency', name:App.drillState.currentAgency}, {type:'sub', name}]; App.searchData.active = App.searchData.raw.filter(d => d['Awarding Agency']===App.drillState.currentAgency && d['Awarding Sub Agency']===name); App.searchData.filter = name; App.updateSearchDashboard(); App.renderSankey(); },
  drillToLevel(lvl) { if(lvl===1) App.drillToAgency(App.drillState.path[0].name); else App.resetDrill(); },
  drillDown(name) {
    if (App.searchData.raw.some(d => d['Awarding Agency'] === name) && App.drillState.level === 0) App.drillToAgency(name);
    else if (App.searchData.raw.some(d => d['Awarding Sub Agency'] === name) && App.drillState.level === 1) App.drillToSubAgency(name);
    else { App.searchData.filter = name; App.searchData.active = App.searchData.active.filter(d => d['Recipient Name'] === name); App.updateSearchDashboard(); App.renderSankey(); }
  },
  clearFilter() { App.drillState.level > 0 ? App.resetDrill() : (App.searchData.filter = null, App.searchData.active = App.searchData.raw, App.updateSearchDashboard(), App.renderSankey()); },

  renderSankey() {
    const container = document.getElementById('chartContainer'); container.innerHTML = '';
    const data = App.searchData.active; if(!data.length) { container.innerHTML = '<div style="text-align:center; padding:4rem; color:#666">No data</div>'; return; }
    container.innerHTML = '<svg id="sankeySvg"></svg>';
    const isLvl0 = App.drillState.level === 0;
    const flowMap = {}; data.forEach(d => { if(d['Award Amount']>0) flowMap[(isLvl0 ? d['Awarding Agency'] : d['Awarding Sub Agency'] || 'Unknown') + "|||" + (d['Recipient Name'] || 'Unknown')] = (flowMap[(isLvl0 ? d['Awarding Agency'] : d['Awarding Sub Agency'] || 'Unknown') + "|||" + (d['Recipient Name'] || 'Unknown')] || 0) + d['Award Amount']; });
    const allFlows = Object.entries(flowMap).sort((a,b)=>b[1]-a[1]); const limit = App.drillState.level > 0 ? 50 : 25;
    const topFlows = allFlows.slice(0, limit); const tailFlows = allFlows.slice(limit);
    const nodesSet = new Set(); const links = [];
    topFlows.forEach(([k,v]) => { const [s,t] = k.split("|||"); nodesSet.add(s); nodesSet.add(t); links.push({source:s, target:t, value:v}); });
    if(tailFlows.length) { const aggs={}; tailFlows.forEach(([k,v]) => { const [s] = k.split("|||"); if(nodesSet.has(s)) aggs[s] = (aggs[s]||0)+v; }); Object.entries(aggs).forEach(([s,v]) => { const n = `Other (${tailFlows.length})`; nodesSet.add(n); links.push({source:s, target:n, value:v}); }); }
    
    const nodes = Array.from(nodesSet).map(n=>({name:n})); const nodeMap = new Map(nodes.map((n,i)=>[n.name,i]));
    const d3Links = links.map(l=>({source:nodeMap.get(l.source), target:nodeMap.get(l.target), value:l.value}));
    const w = container.offsetWidth || 800; const h = Math.max(500, nodes.length * 30);
    const svg = d3.select("#sankeySvg").attr("width", w).attr("height", h);
    const sankey = d3.sankey().nodeId(d=>d.index).nodeWidth(20).nodePadding(20).extent([[1,1],[w-1,h-6]]);
    const {nodes:gn, links:gl} = sankey({nodes:nodes.map(d=>Object.assign({},d)), links:d3Links.map(d=>Object.assign({},d))});
    
    const isDrillable = n => !n.startsWith('Other') && (App.drillState.level===0 ? App.searchData.raw.some(d=>d['Awarding Agency']===n) : App.drillState.level===1 && App.searchData.raw.some(d=>d['Awarding Sub Agency']===n));

    svg.append("g").selectAll("rect").data(gn).join("rect")
       .attr("x",d=>d.x0).attr("y",d=>d.y0).attr("height",d=>d.y1-d.y0).attr("width",d=>d.x1-d.x0)
       .attr("fill",d=>Utils.getColor(d.name)).attr("opacity",0.8)
       .attr("stroke",d=>isDrillable(d.name)?'var(--accent)':'none').attr("stroke-width",d=>isDrillable(d.name)?2:0)
       .style("cursor",d=>isDrillable(d.name)?"pointer":"default")
       .on("click",(e,d)=>{if(isDrillable(d.name))App.drillDown(d.name)})
       .append("title").text(d=>`${d.name}\n${Utils.money(d.value)}`);

    const defs = svg.append("defs");
    gl.forEach((l,i) => { const g = defs.append("linearGradient").attr("id","g"+i).attr("gradientUnits","userSpaceOnUse").attr("x1",l.source.x1).attr("x2",l.target.x0); g.append("stop").attr("offset","0%").attr("stop-color",Utils.getColor(l.source.name)); g.append("stop").attr("offset","100%").attr("stop-color",Utils.getColor(l.target.name)); });
    
    svg.append("g").attr("fill","none").selectAll("path").data(gl).join("path")
       .attr("d",d3.sankeyLinkHorizontal()).attr("stroke",(d,i)=>"url(#g"+i+")").attr("stroke-width",d=>Math.max(1,d.width)).attr("stroke-opacity",0.4);
    
    svg.append("g").selectAll("text").data(gn).join("text")
       .attr("x",d=>d.x0<w/2?d.x1+6:d.x0-6).attr("y",d=>(d.y1+d.y0)/2).attr("dy","0.35em")
       .attr("text-anchor",d=>d.x0<w/2?"start":"end").text(d=>Utils.trunc(d.name,40))
       .style("font-size","11px").style("fill","#fff").style("pointer-events","none");
  },

  renderFeed() {
    const div = document.getElementById('feedGrid');
    const data = App.searchData.active;
    if(data.length === 0) { div.innerHTML = '<div style="text-align:center; padding:2rem; color:#666">No contracts found.</div>'; return; }
    
    div.innerHTML = data.map(c => {
      const internalId = c['generated_internal_id'];
      let url = '#';
      if (internalId) url = `https://www.usaspending.gov/award/${internalId}`;
      else if (c['Award ID']) url = `https://www.usaspending.gov/search/?hash=&filters=${encodeURIComponent(JSON.stringify({keyword: c['Award ID']}))}`;
      
      let metaTags = '';
      if (c['NAICS Code']) metaTags += `<span class="meta-tag naics" title="${c['NAICS Description'] || ''}">NAICS: ${c['NAICS Code']}</span>`;
      if (c['PSC Code']) metaTags += `<span class="meta-tag psc" title="${c['PSC Description'] || ''}">PSC: ${c['PSC Code']}</span>`;
      
      const subAgency = c['Awarding Sub Agency'];
      const agencyDisplay = subAgency && subAgency !== c['Awarding Agency'] 
        ? `${Utils.trunc(c['Awarding Agency'], 20)} → ${Utils.trunc(subAgency, 20)}` 
        : Utils.trunc(c['Awarding Agency'], 35);

      return `<div class="deal-card">
        <div class="deal-header"><span class="deal-agency">${agencyDisplay}</span><span class="deal-amount">${Utils.money(c['Award Amount'])}</span></div>
        <div class="deal-desc">${Utils.trunc(c['Description'], 100)}</div>
        <div class="deal-vendor">${c['Recipient Name']}</div>
        ${metaTags ? `<div class="deal-meta">${metaTags}</div>` : ''}
        <div class="deal-footer"><span class="deal-date">Start: ${Utils.date(c['Start Date'])}${c['End Date'] ? ' → ' + Utils.date(c['End Date']) : ''}</span><a href="${url}" target="_blank" class="action-btn">OPEN AWARD <i class="fas fa-external-link-alt"></i></a></div>
      </div>`;
    }).join('');
  },

// --- Forecast Mode ---
  async runForecast(val) {
    const query = val || document.getElementById('mainSearchInput').value; if(!query) return;
    
    // Reset data if query changed
    if(query !== App.currentQuery) { 
      App.searchData = { loaded:false }; 
      App.forecastData = { spending:null, agencies:null, awards:null, analysis:null, loaded:false }; 
    }
    
    const cs = Chart.getChart("spendingChart"); if(cs) cs.destroy();
    App.currentQuery = query; 
    App.mode = 'forecast'; 
    App.showLoader('CRUNCHING NUMBERS...', 'Applying Recency-Weighted Seasonality');
    
    try {
      const [spending, agencies, awards] = await Promise.all([
        API.getSpendingOverTime(query), 
        API.getAgencyData(query), 
        API.getAwardsForForecast(query)
      ]);
      
      App.forecastData = { 
        spending, 
        agencies, 
        awards, 
        analysis: ForecastEngine.analyze(spending, awards, agencies), 
        loaded: true 
      };
      
      App.transitionToApp(); 
      App.setMode('forecast'); 
      App.renderForecastDashboard();
      
    } catch(e) { 
      console.error(e); 
      App.showToast("Error fetching forecast data.", "error"); 
    } finally { 
      App.hideLoader(); 
    }
  },

renderForecastDashboard() {
    const analysis = App.forecastData.analysis; 
    const awards = App.forecastData.awards; 
    if(!analysis) return;
    
    // Update Stat Blocks
    document.getElementById('stat-baseline').innerText = Utils.money(analysis.baseline);
    document.getElementById('stat-market').innerText = analysis.marketStatus;
    document.getElementById('stat-hhi').innerText = `HHI: ${analysis.hhi}`;
    
    let peakQ=1, peakV=0; 
    for(let q=1; q<=4; q++) if(analysis.indices[q]>peakV) { peakV=analysis.indices[q]; peakQ=q; }
    document.getElementById('stat-peak').innerText = `Q${peakQ}`;
    document.getElementById('stat-recompetes').innerText = analysis.recompetes.length;
    
    // Insights Grid
    const insightsDiv = document.getElementById('marketInsights');
    insightsDiv.innerHTML = `
      <div class="insight-card">
        <div class="insight-label">Market Concentration</div>
        <div class="insight-val" style="color:${analysis.hhi>2500?'var(--danger)':'var(--success)'}">${analysis.marketStatus}</div>
        <div style="font-size:0.8rem; color:#666; margin-top:5px">HHI Score: ${analysis.hhi}</div>
      </div>
      
      <div class="insight-card">
        <div class="insight-label">Top Incumbent</div>
        <div class="insight-val" style="font-size:0.9rem">${Utils.trunc(awards[0]?awards[0]['Recipient Name']:'Unknown', 30)}</div>
      </div>

      <div class="insight-card sales-plan-card" onclick="SalesPlanManager.open()">
        <div class="sales-plan-card-icon"><i class="fas fa-file-export"></i></div>
        <div class="sales-plan-card-title">Generate AI Strategy Prompt</div>
        <div class="sales-plan-card-subtitle">
          Configure scope, classify partners, and export a prompt package for your AI model.
          <br><em style="font-size: 0.8em; opacity: 0.7;">Note: Click "Agency Award Flow" first to include full awards data.</em>
        </div>
      </div>
    `;

    // Forecast Table
    const tb = document.getElementById('forecastTableBody'); 
    tb.innerHTML = '';
    analysis.forecasts.forEach(f => {
      const isUp = f.trend.includes('+'); 
      const color = f.confidence.label === 'High' ? 'var(--success)' : (f.confidence.label === 'Med' ? '#FDD835' : '#888');
      
      tb.innerHTML += `
        <tr>
          <td><b>${f.period}</b></td>
          <td style="color:var(--accent); font-weight:700">${Utils.money(f.predicted)}</td>
          <td style="color:#666">${Utils.money(f.histAvg)}</td>
          <td><span class="trend-pill ${isUp?'trend-up':'trend-down'}">${isUp?'▲':'▼'} ${f.trend}%</span></td>
          <td>
            <div style="color:${color}; font-weight:700;">${f.confidence.label}</div>
            <div style="font-size:0.65rem; color:#666;">${f.confidence.reason}</div>
          </td>
        </tr>`;
    });
    
    // Render Chart
    const ctx = document.getElementById('spendingChart').getContext('2d');
    const years = Object.keys(analysis.byFY).sort();
    
    new Chart(ctx, {
      type: 'bar',
      data: { 
        labels: years.map(y=>`FY${y}`), 
        datasets: [
          { label:'Q1', data:years.map(y=>analysis.byFY[y][1]||0), backgroundColor:'#958BB6' }, 
          { label:'Q2', data:years.map(y=>analysis.byFY[y][2]||0), backgroundColor:'#6F8A74' }, 
          { label:'Q3', data:years.map(y=>analysis.byFY[y][3]||0), backgroundColor:'#8FB6D0' }, 
          { label:'Q4', data:years.map(y=>analysis.byFY[y][4]||0), backgroundColor:'#C27E5C' }
        ] 
      },
      options: { 
        responsive:true, 
        maintainAspectRatio:false, 
        scales:{ x:{grid:{display:false}}, y:{grid:{color:'#333'}} }, 
        plugins:{ legend:{labels:{color:'#888'}} } 
      }
    });

    // Render Strategy Section
    const strat = analysis.strategy;
    if(strat) {
      document.getElementById('strategySection').style.display = 'block';
      document.getElementById('strat-outlook').innerText = strat.title;
      document.getElementById('strat-text').innerText = strat.text;
      document.getElementById('strat-action').innerText = strat.action;
      document.getElementById('matrix-bd').innerText = strat.matrix.bd;
      document.getElementById('matrix-strat').innerText = strat.matrix.strat;
      document.getElementById('matrix-pipe').innerText = strat.matrix.pipe;
    }
    
    // Render Recompetes List
    document.getElementById('recompetesList').innerHTML = analysis.recompetes.length ? 
      `<div class="section-header"><div class="section-title-group"><i class="fas fa-exclamation-triangle" style="color:var(--danger)"></i><span class="section-title" style="color:var(--danger)">Recompete Opportunities</span></div></div>` + 
      analysis.recompetes.map(r => `
        <div class="deal-card" style="margin-bottom:1rem">
          <div class="deal-header">
            <span class="deal-agency">${Utils.trunc(r['Awarding Agency'],40)}</span>
            <span class="deal-amount">${Utils.money(r['Award Amount'])}</span>
          </div>
          <div class="deal-desc">${Utils.trunc(r['Description'],80)}</div>
          <div style="font-size:0.8rem; color:var(--danger)">Expires: ${Utils.date(r['End Date'])}</div>
          <div style="font-size:0.8rem; color:#666">${r['Recipient Name']}</div>
        </div>`).join('') 
      : '';
  },
// --- Helpers ---
  exportCSV(btn) {
    const data = App.mode === 'search' ? App.searchData.active : (App.forecastData.awards || []);
    
    // IF NO DATA: Flash Red (Error)
    if (!data.length) {
      if (btn) {
        const originalHtml = btn.innerHTML;
        btn.style.color = 'var(--danger)';
        btn.style.borderColor = 'var(--danger)';
        btn.innerHTML = '<i class="fas fa-times"></i>'; // Switch to X icon
        setTimeout(() => {
          btn.style.color = '';
          btn.style.borderColor = '';
          btn.innerHTML = originalHtml;
        }, 2000);
      }
      return;
    }
    
    // Detailed Headers
    const headers = ['Recipient', 'Agency', 'Sub-Agency', 'Amount', 'Description', 'Start Date', 'End Date', 'Award ID', 'Award Link'];
    
    const rows = data.map(c => {
      const internalId = c['generated_internal_id']; 
      let awardUrl = '';
      if (internalId) awardUrl = `https://www.usaspending.gov/award/${internalId}`;
      else if (c['Award ID']) awardUrl = `https://www.usaspending.gov/search/?hash=&filters=${encodeURIComponent(JSON.stringify({keyword: c['Award ID']}))}`;
      
      return [
        `"${(c['Recipient Name'] || '').replace(/"/g, '""')}"`, 
        `"${(c['Awarding Agency'] || '').replace(/"/g, '""')}"`, 
        `"${(c['Awarding Sub Agency'] || '').replace(/"/g, '""')}"`, 
        c['Award Amount'] || 0, 
        `"${(c['Description'] || '').replace(/"/g, '""')}"`, 
        c['Start Date'] || '', 
        c['End Date'] || '', 
        c['Award ID'] || '', 
        awardUrl
      ];
    });
    
    const csvContent = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a"); 
    link.setAttribute("href", url); 
    link.setAttribute("download", `govhoo_${App.mode}_${App.currentQuery}.csv`);
    document.body.appendChild(link); link.click(); document.body.removeChild(link);

    // SUCCESS: Flash Green
    if (btn) {
      const originalHtml = btn.innerHTML;
      btn.style.color = 'var(--success)';
      btn.style.borderColor = 'var(--success)';
      btn.innerHTML = '<i class="fas fa-check"></i>'; // Switch to Checkmark
      setTimeout(() => {
        btn.style.color = '';
        btn.style.borderColor = '';
        btn.innerHTML = originalHtml;
      }, 2000);
    }
  },

  showLoader(text, subtext) { document.getElementById('loaderText').innerText = text; document.getElementById('loaderSubtext').innerText = subtext || ''; document.getElementById('loader').style.display = 'flex'; },
  hideLoader() { document.getElementById('loader').style.display = 'none'; },
  transitionToApp() {
    const hero = document.getElementById('heroView'); hero.classList.add('slide-up');
    document.getElementById('appView').style.display = 'block'; document.getElementById('miniSearch').value = App.currentQuery;
    document.getElementById('dashboardContainer').classList.add('active'); setTimeout(() => { hero.style.display = 'none'; hero.classList.add('hidden'); }, 500);
  },
  
  shareLink(btn) {
    const url = new URL(window.location); url.searchParams.set('q', App.currentQuery); url.searchParams.set('mode', App.mode);
    navigator.clipboard.writeText(url.toString()).then(() => {
      // SUCCESS: Flash Green
      if (btn) {
        const originalHtml = btn.innerHTML;
        btn.style.color = 'var(--success)';
        btn.style.borderColor = 'var(--success)';
        btn.innerHTML = '<i class="fas fa-check"></i>'; // Switch to Checkmark
        setTimeout(() => {
          btn.style.color = '';
          btn.style.borderColor = '';
          btn.innerHTML = originalHtml;
        }, 2000);
      }
    });
  }
};

// ==================== ENHANCED EXPORT WITH CHANNEL AWARENESS ====================
// --- NEW FUNCTION: Open the Plan Config Modal ---
App.openPlanConfig = function() {
  if (App.mode !== 'forecast') {
    return alert("Please switch to Forecast mode first. The sales plan requires forecast analysis.");
  }
  
  const searchData = App.searchData.raw || [];
  const forecastData = App.forecastData.awards || [];
  const combinedData = searchData.length > 0 ? searchData : forecastData;
  
  if (!combinedData.length) {
    return alert("Please run both a search and forecast to generate a complete sales plan.");
  }

  // Populate Agency List
  const agencySet = new Set(combinedData.map(d => d['Awarding Agency']));
  const agencies = Array.from(agencySet).sort();
  
  const selectGroup = document.getElementById('planSpecificAgencies');
  selectGroup.innerHTML = '';
  agencies.forEach(ag => {
    const opt = document.createElement('option');
    opt.value = ag;
    opt.textContent = ag;
    selectGroup.appendChild(opt);
  });

  // Open Modal
  document.getElementById('planConfigModal').classList.add('active');
};

// --- NEW FUNCTION: Generate from Config ---
App.generatePlanFromConfig = function() {
  const target = document.getElementById('planSectorSelector').value;
  const searchData = App.searchData.raw || [];
  const forecastData = App.forecastData.awards || [];
  const analysis = App.forecastData.analysis;
  
  let combinedData = searchData.length > 0 ? searchData : forecastData;
  
  // FILTER DATA BASED ON SELECTION
  let filteredData = combinedData;
  let sectorName = "ENTIRE MARKET";

  if (target === 'defense') {
    filteredData = combinedData.filter(d => 
      (d['Awarding Agency'] || '').includes('Department of Defense') || 
      (d['Awarding Agency'] || '').includes('Dept of Defense')
    );
    sectorName = "DEFENSE SECTOR";
  } else if (target === 'civilian') {
    filteredData = combinedData.filter(d => 
      !(d['Awarding Agency'] || '').includes('Department of Defense') &&
      !(d['Awarding Agency'] || '').includes('Dept of Defense')
    );
    sectorName = "FEDERAL CIVILIAN SECTOR";
  } else if (target !== 'all') {
    // Specific Agency
    filteredData = combinedData.filter(d => d['Awarding Agency'] === target);
    sectorName = target.toUpperCase();
  }

  if (filteredData.length === 0) {
    alert("No contracts found for the selected sector/agency in the current dataset.");
    return;
  }

  // Close modal and start generation
  document.getElementById('planConfigModal').classList.remove('active');
  App.showLoader(`GENERATING ${sectorName} PLAN...`, 'Analyzing competitive landscape');

  setTimeout(() => {
    try {
      const packageData = PromptPackageGenerator.buildPackage(filteredData, analysis, sectorName);
      PromptPackageGenerator.downloadPackage(packageData, sectorName);
      App.hideLoader();
    } catch (error) {
      console.error('Package Generation Error:', error);
      App.hideLoader();
      alert('Error generating package: ' + error.message);
    }
  }, 500);
};

App.showChannelModal = function() {
  const data = App.searchData.raw.length > 0 ? App.searchData.raw : App.forecastData.awards || [];
  if (!data.length) {
    return alert("Please run a search or forecast first.");
  }
  
  const vendorSpend = {};
  let totalMarketValue = 0;
  data.forEach(r => {
    const vendor = r['Recipient Name'] || 'Unknown';
    const amt = parseFloat(r['Award Amount']) || 0;
    vendorSpend[vendor] = (vendorSpend[vendor] || 0) + amt;
    totalMarketValue += amt;
  });
  
  const vendors = Object.entries(vendorSpend)
    .map(([vendor, spend]) => ({
      vendor,
      spend,
      marketShare: ((spend / totalMarketValue) * 100).toFixed(2),
      contractCount: data.filter(r => r['Recipient Name'] === vendor).length
    }))
    .sort((a, b) => b.spend - a.spend)
    .slice(0, 20);
  
  ChannelManager.showModal(vendors);
};

const PromptPackageGenerator = {
  
  // ==================== SEARCH INTENT CLASSIFICATION ====================
  classifySearchIntent(query, data, userMarkedChannels) {
    /*
     * Determines what the user searched for and their likely strategic intent.
     * Returns: { type, confidence, details }
     * 
     * Types:
     * - 'own_company': User searched for their own company
     * - 'competitor': User searched for a competitor to analyze
     * - 'partner': User searched for a channel/partner relationship
     * - 'agency': User searched for a specific agency/customer
     * - 'market_keyword': User searched for a market/technology area
     */
    
    const queryLower = query.toLowerCase().trim();
    
    // Extract top entities from data
    const vendorSpend = {};
    const agencySpend = {};
    let totalValue = 0;
    
    data.forEach(r => {
      const vendor = r['Recipient Name'] || 'Unknown';
      const agency = r['Awarding Agency'] || 'Unknown';
      const amt = parseFloat(r['Award Amount']) || 0;
      vendorSpend[vendor] = (vendorSpend[vendor] || 0) + amt;
      agencySpend[agency] = (agencySpend[agency] || 0) + amt;
      totalValue += amt;
    });
    
    const topVendors = Object.entries(vendorSpend)
      .map(([name, spend]) => ({ name, spend, share: (spend / totalValue * 100) }))
      .sort((a, b) => b.spend - a.spend);
    
    const topAgencies = Object.entries(agencySpend)
      .map(([name, spend]) => ({ name, spend, share: (spend / totalValue * 100) }))
      .sort((a, b) => b.spend - a.spend);
    
    // Check if query matches a specific vendor name (exact or fuzzy)
    const matchingVendor = topVendors.find(v => 
      v.name.toLowerCase().includes(queryLower) || 
      queryLower.includes(v.name.toLowerCase().split(' ')[0])
    );
    
    // Check if query matches a specific agency
    const matchingAgency = topAgencies.find(a => 
      a.name.toLowerCase().includes(queryLower) || 
      queryLower.includes(a.name.toLowerCase().replace('department of ', ''))
    );
    
    // Check if query is a known market keyword
    const marketKeywords = [
      'cyber', 'cloud', 'ai', 'artificial intelligence', 'machine learning', 'ml',
      'data', 'analytics', 'software', 'it services', 'infrastructure',
      'network', 'security', 'zero trust', 'devops', 'devsecops',
      'modernization', 'digital', 'transformation', 'agile', 'sap', 'oracle',
      'healthcare', 'logistics', 'training', 'simulation', 'c4isr',
      'satellite', 'space', 'communications', 'mobility', 'wireless'
    ];
    
    const isMarketKeyword = marketKeywords.some(kw => queryLower.includes(kw));
    
    // Determine intent
    if (matchingVendor && matchingVendor.share > 30) {
      // Dominant single vendor - likely searching for own company or major competitor
      const isChannel = userMarkedChannels.has(matchingVendor.name);
      if (isChannel) {
        return {
          type: 'partner',
          confidence: 'high',
          details: {
            entityName: matchingVendor.name,
            entityShare: matchingVendor.share.toFixed(1),
            entityValue: matchingVendor.spend,
            relationship: 'Marked as channel/partner'
          }
        };
      }
      // If they searched their own company name, they want competitive intel
      return {
        type: 'own_company',
        confidence: 'medium',
        details: {
          entityName: matchingVendor.name,
          entityShare: matchingVendor.share.toFixed(1),
          entityValue: matchingVendor.spend,
          suggestion: 'If this is YOUR company, the plan will focus on defending position. If a COMPETITOR, mark as such in settings.'
        }
      };
    }
    
    if (matchingVendor && matchingVendor.share > 5) {
      // Specific vendor but not dominant - likely competitor research
      return {
        type: 'competitor',
        confidence: 'medium',
        details: {
          entityName: matchingVendor.name,
          entityShare: matchingVendor.share.toFixed(1),
          entityValue: matchingVendor.spend,
          competitorCount: topVendors.filter(v => v.share > 1).length
        }
      };
    }
    
    if (matchingAgency) {
      // Agency-focused search
      return {
        type: 'agency',
        confidence: 'high',
        details: {
          entityName: matchingAgency.name,
          entityShare: matchingAgency.share.toFixed(1),
          entityValue: matchingAgency.spend,
          vendorCount: new Set(data.filter(r => r['Awarding Agency'] === matchingAgency.name).map(r => r['Recipient Name'])).size
        }
      };
    }
    
    if (isMarketKeyword || topVendors.length > 5) {
      // Market/technology keyword search
      return {
        type: 'market_keyword',
        confidence: 'high',
        details: {
          keyword: query,
          totalMarketValue: totalValue,
          vendorCount: topVendors.length,
          agencyCount: topAgencies.length,
          topVendor: topVendors[0]?.name,
          topAgency: topAgencies[0]?.name
        }
      };
    }
    
    // Default - treat as market exploration
    return {
      type: 'market_keyword',
      confidence: 'low',
      details: {
        keyword: query,
        totalMarketValue: totalValue,
        note: 'Search intent unclear - defaulting to market analysis'
      }
    };
  },

  // ==================== FULL DATA EXTRACTION ====================
  extractAllData(data, analysis, config = {}) {
    const curFY = Utils.getCurrentFY();
    const curQ = Utils.getCurrentQuarter();
    
    // === VENDOR ANALYSIS ===
    const vendorSpend = {};
    let totalMarketValue = 0;
    
    data.forEach(r => {
      const vendor = r['Recipient Name'] || 'Unknown';
      const amt = parseFloat(r['Award Amount']) || 0;
      if (!vendorSpend[vendor]) {
        vendorSpend[vendor] = { 
          spend: 0, 
          contracts: [], 
          agencies: new Set(),
          subAgencies: new Set(),
          naicsCodes: new Set(),
          pscCodes: new Set()
        };
      }
      vendorSpend[vendor].spend += amt;
      vendorSpend[vendor].contracts.push(r);
      if (r['Awarding Agency']) vendorSpend[vendor].agencies.add(r['Awarding Agency']);
      if (r['Awarding Sub Agency']) vendorSpend[vendor].subAgencies.add(r['Awarding Sub Agency']);
      if (r['NAICS Code']) vendorSpend[vendor].naicsCodes.add(r['NAICS Code']);
      if (r['PSC Code']) vendorSpend[vendor].pscCodes.add(r['PSC Code']);
      totalMarketValue += amt;
    });
    
    const allVendors = Object.entries(vendorSpend).map(([vendor, data]) => ({
      vendor,
      spend: data.spend,
      marketShare: ((data.spend / totalMarketValue) * 100).toFixed(2),
      contractCount: data.contracts.length,
      avgContractSize: data.spend / data.contracts.length,
      agencyDiversity: data.agencies.size,
      subAgencyReach: data.subAgencies.size,
      naicsCodes: Array.from(data.naicsCodes),
      pscCodes: Array.from(data.pscCodes),
      isChannel: SalesPlanManager.isChannel(vendor),
      // Calculate expiring contracts
      expiringContracts: data.contracts.filter(c => {
        if (!c['End Date']) return false;
        const monthsUntilEnd = (new Date(c['End Date']) - new Date()) / (1000 * 60 * 60 * 24 * 30);
        return monthsUntilEnd > 0 && monthsUntilEnd <= 18;
      }),
      // Calculate contract value at risk
      expiringValue: data.contracts.filter(c => {
        if (!c['End Date']) return false;
        const monthsUntilEnd = (new Date(c['End Date']) - new Date()) / (1000 * 60 * 60 * 24 * 30);
        return monthsUntilEnd > 0 && monthsUntilEnd <= 18;
      }).reduce((sum, c) => sum + (parseFloat(c['Award Amount']) || 0), 0)
    })).sort((a, b) => b.spend - a.spend);
    
    const competitors = allVendors.filter(v => !v.isChannel);
    const channels = allVendors.filter(v => v.isChannel);
    
    // === AGENCY ANALYSIS ===
    const agencyData = {};
    data.forEach(r => {
      const agency = r['Awarding Agency'] || 'Unknown';
      const subAgency = r['Awarding Sub Agency'] || 'General';
      const amt = parseFloat(r['Award Amount']) || 0;
      
      if (!agencyData[agency]) {
        agencyData[agency] = { 
          spend: 0, 
          contracts: [],
          subAgencies: {},
          topVendors: {}
        };
      }
      agencyData[agency].spend += amt;
      agencyData[agency].contracts.push(r);
      
      // Sub-agency breakdown
      if (!agencyData[agency].subAgencies[subAgency]) {
        agencyData[agency].subAgencies[subAgency] = { spend: 0, count: 0 };
      }
      agencyData[agency].subAgencies[subAgency].spend += amt;
      agencyData[agency].subAgencies[subAgency].count++;
      
      // Track vendors per agency
      const vendor = r['Recipient Name'] || 'Unknown';
      agencyData[agency].topVendors[vendor] = (agencyData[agency].topVendors[vendor] || 0) + amt;
    });
    
    const topAgencies = Object.entries(agencyData).map(([agency, d]) => ({
      agency,
      spend: d.spend,
      percentage: ((d.spend / totalMarketValue) * 100).toFixed(1),
      contractCount: d.contracts.length,
      subAgencyCount: Object.keys(d.subAgencies).length,
      subAgencies: Object.entries(d.subAgencies)
        .map(([name, data]) => ({ name, ...data }))
        .sort((a, b) => b.spend - a.spend)
        .slice(0, 5),
      topVendors: Object.entries(d.topVendors)
        .map(([name, spend]) => ({ name, spend }))
        .sort((a, b) => b.spend - a.spend)
        .slice(0, 3),
      incumbentVendor: Object.entries(d.topVendors).sort((a, b) => b[1] - a[1])[0]?.[0]
    })).sort((a, b) => b.spend - a.spend);
    
    // === RECOMPETE ANALYSIS ===
    const now = new Date();
    const recompetes = {
      immediate: [], // 0-6 months
      nearTerm: [],  // 6-12 months
      pipeline: []   // 12-18 months
    };
    
    data.forEach(r => {
      if (!r['End Date']) return;
      const endDate = new Date(r['End Date']);
      const monthsUntilEnd = (endDate - now) / (1000 * 60 * 60 * 24 * 30);
      
      if (monthsUntilEnd > 0 && monthsUntilEnd <= 6) {
        recompetes.immediate.push(r);
      } else if (monthsUntilEnd > 6 && monthsUntilEnd <= 12) {
        recompetes.nearTerm.push(r);
      } else if (monthsUntilEnd > 12 && monthsUntilEnd <= 18) {
        recompetes.pipeline.push(r);
      }
    });
    
    // Sort each by value
    Object.keys(recompetes).forEach(key => {
      recompetes[key].sort((a, b) => (b['Award Amount'] || 0) - (a['Award Amount'] || 0));
    });
    
    // === NAICS/PSC ANALYSIS ===
    const naicsBreakdown = {};
    const pscBreakdown = {};
    
    data.forEach(r => {
      const naics = r['NAICS Code'];
      const psc = r['PSC Code'];
      const amt = parseFloat(r['Award Amount']) || 0;
      
      if (naics) {
        if (!naicsBreakdown[naics]) {
          naicsBreakdown[naics] = { code: naics, description: r['NAICS Description'] || '', spend: 0, count: 0 };
        }
        naicsBreakdown[naics].spend += amt;
        naicsBreakdown[naics].count++;
      }
      
      if (psc) {
        if (!pscBreakdown[psc]) {
          pscBreakdown[psc] = { code: psc, description: r['PSC Description'] || '', spend: 0, count: 0 };
        }
        pscBreakdown[psc].spend += amt;
        pscBreakdown[psc].count++;
      }
    });
    
    // === MARKET CONCENTRATION (HHI) ===
    let hhi = 0;
    if (analysis && analysis.hhi) {
      hhi = analysis.hhi;
    } else {
      allVendors.forEach(v => {
        const share = (v.spend / totalMarketValue) * 100;
        hhi += share * share;
      });
      hhi = Math.round(hhi);
    }
    
    const marketConcentration = {
      hhi,
      status: hhi > 2500 ? 'Highly Concentrated' : hhi > 1500 ? 'Moderately Concentrated' : 'Competitive',
      top3Share: competitors.slice(0, 3).reduce((s, v) => s + parseFloat(v.marketShare), 0).toFixed(1),
      top5Share: competitors.slice(0, 5).reduce((s, v) => s + parseFloat(v.marketShare), 0).toFixed(1),
      vendorCount: allVendors.length,
      interpretation: hhi > 2500 
        ? 'Market dominated by few incumbents. Teaming or niche strategies required.'
        : hhi > 1500 
          ? 'Moderate competition. Both displacement and new opportunity strategies viable.'
          : 'Fragmented market. Volume bidding and broad prospecting may succeed.'
    };
    
    // === FORECAST DATA (if available) ===
    let forecastInsights = null;
    if (analysis) {
      forecastInsights = {
        baseline: analysis.baseline,
        quarterlyForecasts: analysis.forecasts || [],
        seasonalIndices: analysis.indices || {},
        peakQuarter: this.getPeakQuarter(analysis),
        growthRate: this.calculateGrowthRate(analysis),
        historicalByFY: analysis.byFY || {},
        strategy: analysis.strategy || null,
        marketStatus: analysis.marketStatus || 'Unknown'
      };
      
      // Calculate YoY trends
      if (analysis.byFY) {
        const years = Object.keys(analysis.byFY).sort();
        if (years.length >= 2) {
          const currentFY = years[years.length - 1];
          const previousFY = years[years.length - 2];
          const currentTotal = Object.values(analysis.byFY[currentFY]).reduce((a, b) => a + b, 0);
          const previousTotal = Object.values(analysis.byFY[previousFY]).reduce((a, b) => a + b, 0);
          forecastInsights.yoyChange = previousTotal > 0 
            ? (((currentTotal - previousTotal) / previousTotal) * 100).toFixed(1)
            : null;
        }
      }
    }
    
    return {
      metadata: {
        generatedDate: new Date().toISOString(),
        fiscalYear: curFY,
        currentQuarter: curQ,
        marketQuery: App.currentQuery,
        totalContracts: data.length,
        totalMarketValue,
        channelsIdentified: channels.length,
        competitorsIdentified: competitors.length,
        dataSource: analysis ? 'Forecast Mode' : 'Search Mode'
      },
      marketConcentration,
      competitors: {
        all: competitors,
        top5: competitors.slice(0, 5),
        top10: competitors.slice(0, 10)
      },
      channels: {
        all: channels,
        totalValue: channels.reduce((s, c) => s + c.spend, 0)
      },
      agencies: {
        all: topAgencies,
        top5: topAgencies.slice(0, 5),
        top10: topAgencies.slice(0, 10)
      },
      recompetes,
      naicsBreakdown: Object.values(naicsBreakdown).sort((a, b) => b.spend - a.spend).slice(0, 10),
      pscBreakdown: Object.values(pscBreakdown).sort((a, b) => b.spend - a.spend).slice(0, 10),
      forecastInsights
    };
  },

  calculateGrowthRate(analysis) {
    if (!analysis || !analysis.byFY) return null;
    const years = Object.keys(analysis.byFY).map(Number).sort((a, b) => a - b);
    if (years.length < 2) return null;
    
    const curFY = Utils.getCurrentFY();
    const curQ = Utils.getCurrentQuarter();
    
    // Find the two most recent COMPLETE fiscal years (exclude current partial year)
    const completeYears = years.filter(y => y < curFY);
    
    if (completeYears.length >= 2) {
      // Compare two complete years
      const recentYear = completeYears[completeYears.length - 1];
      const priorYear = completeYears[completeYears.length - 2];
      const recentTotal = Object.values(analysis.byFY[recentYear]).reduce((a, b) => a + b, 0);
      const priorTotal = Object.values(analysis.byFY[priorYear]).reduce((a, b) => a + b, 0);
      
      if (priorTotal > 0) {
        return {
          value: (((recentTotal - priorTotal) / priorTotal) * 100).toFixed(1),
          comparison: `FY${recentYear} vs FY${priorYear}`,
          type: 'full_year'
        };
      }
    }
    
    // Fallback: Compare same quarters year-over-year if we have current year data
    if (years.includes(curFY) && years.includes(curFY - 1)) {
      // Sum only quarters that exist in BOTH years for fair comparison
      const currentYearData = analysis.byFY[curFY];
      const priorYearData = analysis.byFY[curFY - 1];
      
      let currentSum = 0;
      let priorSum = 0;
      let quartersCompared = [];
      
      for (let q = 1; q <= curQ; q++) {
        if (currentYearData[q] > 0 && priorYearData[q] > 0) {
          currentSum += currentYearData[q];
          priorSum += priorYearData[q];
          quartersCompared.push(`Q${q}`);
        }
      }
      
      if (priorSum > 0 && quartersCompared.length > 0) {
        return {
          value: (((currentSum - priorSum) / priorSum) * 100).toFixed(1),
          comparison: `FY${curFY} ${quartersCompared.join('+')} vs FY${curFY - 1} ${quartersCompared.join('+')}`,
          type: 'quarter_comparison'
        };
      }
    }
    
    return null;
  },

  getPeakQuarter(analysis) {
    if (!analysis || !analysis.indices) return null;
    let peakQ = 1, peakV = 0;
    for (let q = 1; q <= 4; q++) {
      if (analysis.indices[q] > peakV) {
        peakV = analysis.indices[q];
        peakQ = q;
      }
    }
    return { quarter: peakQ, index: (peakV * 100).toFixed(1) };
  },

  // ==================== INTENT-AWARE PROMPT GENERATION ====================
  generatePrompt(searchIntent, extractedData, config = {}) {
    const mf = v => Utils.money(v);
    const scope = config.scope || 'Entire Market';
    const focus = config.focus || 'Growth';
    const query = extractedData.metadata.marketQuery;
    
    // Build intent-specific context
    let intentContext = '';
    let strategicFramework = '';
    let specificInstructions = '';
    
    switch (searchIntent.type) {
      case 'own_company':
        intentContext = `
**SEARCH CONTEXT: OWN COMPANY ANALYSIS**
The user searched for "${query}" which appears to be their own company or primary entity.
- Entity: ${searchIntent.details.entityName}
- Current Market Share: ${searchIntent.details.entityShare}%
- Current Contract Value: ${mf(searchIntent.details.entityValue)}

**STRATEGIC INTENT:** The user wants to understand their competitive position and defend/grow their market share.`;
        
        strategicFramework = `
**FRAMEWORK: INCUMBENT DEFENSE & GROWTH**
1. **Protect Base**: Identify expiring contracts and recompete risks
2. **Expand Footprint**: Find adjacent agencies/sub-agencies to penetrate
3. **Competitive Intelligence**: Understand who is threatening your position
4. **Channel Leverage**: Identify partners who can extend your reach`;
        
        specificInstructions = `
**SPECIFIC DELIVERABLES:**
1. **Position Assessment**: Your current standing vs. competitors
2. **Risk Register**: Contracts expiring in next 18 months with displacement probability
3. **Expansion Opportunities**: Agencies where you're underrepresented vs. competitors
4. **Competitive Threats**: Who is growing in your space and how to counter
5. **Defense Playbook**: Actions to protect recompetes`;
        break;
        
      case 'competitor':
        intentContext = `
**SEARCH CONTEXT: COMPETITOR ANALYSIS**
The user searched for "${query}" which identifies a specific competitor.
- Competitor: ${searchIntent.details.entityName}
- Their Market Share: ${searchIntent.details.entityShare}%
- Their Contract Value: ${mf(searchIntent.details.entityValue)}

**STRATEGIC INTENT:** The user wants to understand this competitor's position to displace them or compete effectively.`;
        
        strategicFramework = `
**FRAMEWORK: COMPETITIVE DISPLACEMENT**
1. **Know the Enemy**: Deep dive on competitor's strengths and weaknesses
2. **Find Vulnerabilities**: Expiring contracts, unhappy customers, delivery issues
3. **Counter-Position**: Develop messaging that highlights your advantages
4. **Team or Compete**: Identify where to team vs. go head-to-head`;
        
        specificInstructions = `
**SPECIFIC DELIVERABLES:**
1. **Competitor Profile**: Full analysis of ${searchIntent.details.entityName}
2. **Vulnerability Assessment**: Their expiring contracts (your opportunities)
3. **Agency Overlap**: Where you both compete for the same customers
4. **Displacement Strategy**: How to win their contracts at recompete
5. **Battle Cards**: Win themes and competitive differentiators`;
        break;
        
      case 'partner':
        intentContext = `
**SEARCH CONTEXT: PARTNER/CHANNEL ANALYSIS**
The user searched for "${query}" which is marked as a channel partner.
- Partner: ${searchIntent.details.entityName}
- Their Federal Revenue: ${mf(searchIntent.details.entityValue)}
- Relationship: ${searchIntent.details.relationship}

**STRATEGIC INTENT:** The user wants to understand how to leverage this partner relationship for growth.`;
        
        strategicFramework = `
**FRAMEWORK: CHANNEL OPTIMIZATION**
1. **Partner Value**: Understand their reach and capabilities
2. **Joint Opportunities**: Identify deals where teaming makes sense
3. **Enablement**: How to help them sell your solutions
4. **Expansion**: Where else they can take you`;
        
        specificInstructions = `
**SPECIFIC DELIVERABLES:**
1. **Partner Profile**: Their federal presence and agency relationships
2. **Joint Pipeline**: Recompetes and new opportunities for teaming
3. **Agency Introduction Map**: Where they have relationships you don't
4. **Enablement Plan**: How to arm them to represent you
5. **Revenue Targets**: Realistic joint revenue goals by quarter`;
        break;
        
      case 'agency':
        intentContext = `
**SEARCH CONTEXT: AGENCY/CUSTOMER ANALYSIS**
The user searched for "${query}" which is a federal agency.
- Agency: ${searchIntent.details.entityName}
- Total Spend: ${mf(searchIntent.details.entityValue)}
- Active Vendors: ${searchIntent.details.vendorCount}

**STRATEGIC INTENT:** The user wants to penetrate or expand within this specific agency.`;
        
        strategicFramework = `
**FRAMEWORK: AGENCY PENETRATION**
1. **Know the Customer**: Understand their mission and priorities
2. **Map the Landscape**: Who's the incumbent? Who's winning?
3. **Find Entry Points**: Recompetes, new requirements, set-asides
4. **Build Relationships**: Key contracting offices and program managers`;
        
        specificInstructions = `
**SPECIFIC DELIVERABLES:**
1. **Agency Profile**: Mission, budget trends, IT priorities
2. **Competitive Map**: Who holds the contracts you want
3. **Entry Strategy**: Specific opportunities to pursue
4. **Sub-Agency Breakdown**: Where are the best opportunities
5. **Timeline**: Key dates and procurement cycles`;
        break;
        
      case 'market_keyword':
      default:
        intentContext = `
**SEARCH CONTEXT: MARKET/TECHNOLOGY ANALYSIS**
The user searched for "${query}" which represents a market segment or technology area.
- Total Addressable Market: ${mf(searchIntent.details.totalMarketValue)}
- Active Vendors: ${searchIntent.details.vendorCount || extractedData.metadata.competitorsIdentified}
- Active Agencies: ${searchIntent.details.agencyCount || extractedData.agencies.all.length}
- Top Vendor: ${searchIntent.details.topVendor || extractedData.competitors.top5[0]?.vendor}
- Top Agency: ${searchIntent.details.topAgency || extractedData.agencies.top5[0]?.agency}

**STRATEGIC INTENT:** The user wants to understand this market to enter or expand their presence.`;
        
        strategicFramework = `
**FRAMEWORK: MARKET ENTRY/EXPANSION**
1. **Size the Prize**: Understand TAM and growth trajectory
2. **Know the Players**: Who dominates? Who's growing?
3. **Find Your Lane**: Where do you have competitive advantage?
4. **Build the Pipeline**: Specific opportunities to pursue`;
        
        specificInstructions = `
**SPECIFIC DELIVERABLES:**
1. **Market Overview**: Size, growth, concentration analysis
2. **Competitive Landscape**: Top players and their positioning
3. **Agency Priorities**: Who's buying and why
4. **Opportunity Pipeline**: Specific recompetes and new requirements
5. **Go-to-Market Strategy**: How to win in this market`;
        break;
    }
    
    // Build the comprehensive prompt
    return `# FEDERAL SALES INTELLIGENCE REPORT
## Query: "${query.toUpperCase()}" | Scope: ${scope} | Focus: ${focus}
## Generated: ${new Date().toLocaleDateString()} | FY${extractedData.metadata.fiscalYear} Q${extractedData.metadata.currentQuarter}

---

${intentContext}

${strategicFramework}

---

## INSTRUCTIONS FOR AI ASSISTANT

Create a comprehensive, actionable federal sales plan (4-6 pages) based on the data and context below. The plan should be executive-ready with specific actions, timelines, and measurable targets.

${specificInstructions}

---

## MARKET DATA

### MARKET OVERVIEW
- **Total Addressable Market (TAM):** ${mf(extractedData.metadata.totalMarketValue)}
- **Total Active Contracts:** ${extractedData.metadata.totalContracts}
- **Average Contract Size:** ${mf(extractedData.metadata.totalMarketValue / extractedData.metadata.totalContracts)}
- **Active Competitors:** ${extractedData.metadata.competitorsIdentified}
- **Active Agencies:** ${extractedData.agencies.all.length}

### MARKET CONCENTRATION ANALYSIS
- **HHI Score:** ${extractedData.marketConcentration.hhi} (${extractedData.marketConcentration.status})
- **Top 3 Vendor Share:** ${extractedData.marketConcentration.top3Share}%
- **Top 5 Vendor Share:** ${extractedData.marketConcentration.top5Share}%
- **Strategic Implication:** ${extractedData.marketConcentration.interpretation}

### TOP COMPETITORS (by Contract Value)
${extractedData.competitors.top5.map((c, i) => `${i + 1}. **${c.vendor}**
   - Market Share: ${c.marketShare}% | Value: ${mf(c.spend)}
   - Contracts: ${c.contractCount} | Avg Size: ${mf(c.avgContractSize)}
   - Agency Reach: ${c.agencyDiversity} agencies | ${c.subAgencyReach} sub-agencies
   - Expiring (18mo): ${c.expiringContracts.length} contracts worth ${mf(c.expiringValue)}
   - NAICS: ${c.naicsCodes.slice(0, 3).join(', ') || 'N/A'}`).join('\n')}

${extractedData.channels.all.length > 0 ? `### CHANNEL PARTNERS (User-Identified)
${extractedData.channels.all.map(c => `- **${c.vendor}**: ${mf(c.spend)} (${c.contractCount} contracts, ${c.marketShare}% share)`).join('\n')}
- **Total Channel Value:** ${mf(extractedData.channels.totalValue)}` : `### NO CHANNEL PARTNERS IDENTIFIED
Consider marking VARs, resellers, or teaming partners in the channel modal.`}

### TOP AGENCIES (by Spend)
${extractedData.agencies.top5.map((a, i) => `${i + 1}. **${a.agency}**
   - Spend: ${mf(a.spend)} (${a.percentage}% of market)
   - Contracts: ${a.contractCount} | Sub-Agencies: ${a.subAgencyCount}
   - Incumbent: ${a.incumbentVendor || 'Various'}
   - Top Sub-Agencies: ${a.subAgencies.slice(0, 3).map(s => s.name).join(', ')}`).join('\n')}

### RECOMPETE INTELLIGENCE (18-Month Pipeline)

**IMMEDIATE (0-6 Months) - ${extractedData.recompetes.immediate.length} Opportunities - ${mf(extractedData.recompetes.immediate.reduce((s, r) => s + (r['Award Amount'] || 0), 0))} at Risk**
${extractedData.recompetes.immediate.slice(0, 5).map(r => `- ${r['Awarding Agency']}: ${mf(r['Award Amount'])} | Incumbent: ${r['Recipient Name']} | Ends: ${Utils.date(r['End Date'])}`).join('\n') || 'None identified'}

**NEAR-TERM (6-12 Months) - ${extractedData.recompetes.nearTerm.length} Opportunities - ${mf(extractedData.recompetes.nearTerm.reduce((s, r) => s + (r['Award Amount'] || 0), 0))} at Risk**
${extractedData.recompetes.nearTerm.slice(0, 5).map(r => `- ${r['Awarding Agency']}: ${mf(r['Award Amount'])} | Incumbent: ${r['Recipient Name']} | Ends: ${Utils.date(r['End Date'])}`).join('\n') || 'None identified'}

**PIPELINE (12-18 Months) - ${extractedData.recompetes.pipeline.length} Opportunities - ${mf(extractedData.recompetes.pipeline.reduce((s, r) => s + (r['Award Amount'] || 0), 0))} at Risk**
${extractedData.recompetes.pipeline.slice(0, 5).map(r => `- ${r['Awarding Agency']}: ${mf(r['Award Amount'])} | Incumbent: ${r['Recipient Name']} | Ends: ${Utils.date(r['End Date'])}`).join('\n') || 'None identified'}

${extractedData.naicsBreakdown.length > 0 ? `### NAICS CODE BREAKDOWN
${extractedData.naicsBreakdown.slice(0, 5).map(n => `- **${n.code}** (${n.description || 'No description'}): ${mf(n.spend)} | ${n.count} contracts`).join('\n')}` : ''}

${extractedData.pscBreakdown.length > 0 ? `### PSC CODE BREAKDOWN
${extractedData.pscBreakdown.slice(0, 5).map(p => `- **${p.code}** (${p.description || 'No description'}): ${mf(p.spend)} | ${p.count} contracts`).join('\n')}` : ''}

${extractedData.forecastInsights ? `### FORECAST & TREND ANALYSIS
- **Baseline Annual Forecast:** ${mf(extractedData.forecastInsights.baseline)}
- **YoY Growth Rate:** ${extractedData.forecastInsights.growthRate ? `${extractedData.forecastInsights.growthRate.value}% (${extractedData.forecastInsights.growthRate.comparison})` : 'Insufficient complete year data'}
- **Peak Spending Quarter:** Q${extractedData.forecastInsights.peakQuarter?.quarter || 'N/A'} (${extractedData.forecastInsights.peakQuarter?.index || 'N/A'}% of annual)
- **Market Status:** ${extractedData.forecastInsights.marketStatus}

**Quarterly Forecasts:**
${extractedData.forecastInsights.quarterlyForecasts.map(f => `- **${f.period}:** ${mf(f.predicted)} (${f.trend}% vs historical avg) | Confidence: ${f.confidence?.label || 'N/A'} - ${f.confidence?.reason || ''}`).join('\n')}

**Seasonal Indices:**
${Object.entries(extractedData.forecastInsights.seasonalIndices).map(([q, idx]) => `- Q${q}: ${(idx * 100).toFixed(1)}% of annual spend`).join('\n')}

${extractedData.forecastInsights.strategy ? `**AI Strategy Recommendation:**
- **Outlook:** ${extractedData.forecastInsights.strategy.title}
- **Analysis:** ${extractedData.forecastInsights.strategy.text}
- **Recommended Action:** ${extractedData.forecastInsights.strategy.action}
- **BD Focus:** ${extractedData.forecastInsights.strategy.matrix?.bd || 'N/A'}
- **Strategic Approach:** ${extractedData.forecastInsights.strategy.matrix?.strat || 'N/A'}
- **Pipeline Focus:** ${extractedData.forecastInsights.strategy.matrix?.pipe || 'N/A'}` : ''}

**Historical Spending by Fiscal Year:**
${Object.entries(extractedData.forecastInsights.historicalByFY || {}).map(([fy, quarters]) => 
  `- FY${fy}: ${mf(Object.values(quarters).reduce((a, b) => a + b, 0))} (Q1: ${mf(quarters[1] || 0)}, Q2: ${mf(quarters[2] || 0)}, Q3: ${mf(quarters[3] || 0)}, Q4: ${mf(quarters[4] || 0)})`
).join('\n')}` : '### NO FORECAST DATA AVAILABLE\nRun in Forecast Mode to get predictive analytics and trend analysis.'}

---

## OUTPUT REQUIREMENTS

1. **Executive Summary** (1/2 page): Key findings, primary opportunities, and recommended strategy
2. **Market Analysis** (1 page): Deep dive on the data above with strategic implications
3. **Competitive Intelligence** (1 page): Battle cards for top 3 competitors with win strategies
4. **Opportunity Pipeline** (1 page): Prioritized list of specific pursuits with timelines
5. **Quarterly Action Plan** (1-2 pages): SMART goals and activities by quarter

**VALIDATION CRITERIA:**
- Plan must be specific to the search intent (${searchIntent.type})
- Include at least 5 specific, actionable recommendations
- Reference actual data from the report (use real vendor/agency names)
- Provide measurable targets with timelines
- Address federal procurement considerations (FAR, DFAR, small business, etc.)`;
  },

  // ==================== MAIN BUILD FUNCTION ====================
  buildPackage(data, analysis, config = {}) {
    // Step 1: Classify search intent
    const searchIntent = this.classifySearchIntent(
      App.currentQuery, 
      data, 
      SalesPlanManager.channels
    );
    
    // Step 2: Extract all available data
    const extractedData = this.extractAllData(data, analysis, config);
    
    // Step 3: Generate intent-aware prompt
    return this.generatePrompt(searchIntent, extractedData, config);
  },

  downloadPackage(promptText) {
    const blob = new Blob([promptText], { type: 'text/plain;charset=utf-8' });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `Sales_Plan_FY${Utils.getCurrentFY()}_${App.currentQuery.replace(/\s+/g, '_')}.txt`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }
};

App.init();
</script>

</body>
</html>