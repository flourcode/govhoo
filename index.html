<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#000000">
  <title>Govhoo - Federal Contract Intelligence</title>
  
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-sankey/0.12.3/d3-sankey.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
 <script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-T343V4RFHV');
</script>
<style>
:root {
  --bg-app: #000000;
  --bg-card: #121212; 
  --bg-input: #1a1a1a;
  --border: #333333;
  --text-primary: #e6e6e6;
  --text-muted: #888888;
  
  /* Vintage/Elegant Terminal Theme */
  --accent: #D4C4A8;
  --accent-dim: rgba(212, 196, 168, 0.1);
  --link: #8DA0CB;
  --success: #66C2A5;
  --danger: #FB8072;
  
  /* Vintage Chart Palette */
  --q1-color: #958BB6; --q2-color: #6F8A74; --q3-color: #8FB6D0; --q4-color: #C27E5C;

  --safe-top: env(safe-area-inset-top, 20px);
  --safe-bottom: env(safe-area-inset-bottom, 20px);
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

body {
  margin: 0; padding: 0;
  font-family: 'Inter', sans-serif;
  background: var(--bg-app);
  color: var(--text-primary);
  min-height: 100vh;
  overflow-x: hidden;
}

/* --- Hero Section --- */
.hero-view {
  position: fixed; inset: 0; z-index: 200; 

  display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
  padding: 2rem; padding-top: max(8vh, var(--safe-top)); 
  transition: transform 0.5s cubic-bezier(0.16, 1, 0.3, 1);
  overflow-y: auto; 
}
.hero-view.slide-up { transform: translateY(-100%); }
.hero-view.hidden { display: none; }

.terminal-logo {
  font-family: 'JetBrains Mono', monospace; font-size: 2.5rem; font-weight: 700;
  margin-bottom: 0.5rem; color: var(--text-primary); letter-spacing: -1px; text-align: center;
}
.terminal-logo span { color: var(--accent); }

.hero-subtitle {
  color: var(--text-muted); margin-bottom: 2rem; text-align: center;
}

.search-box-container { 
  position: relative; z-index: 210; 
  width: 100%; max-width: 500px; margin-top: 1.5rem; 
}

.main-input {
  width: 100%; background: var(--bg-input); border: 1px solid var(--border);
  padding: 1.25rem 1rem; font-size: 1.1rem; color: white; border-radius: 4px;
  font-family: 'Inter', sans-serif; transition: border-color 0.2s; -webkit-appearance: none;
}
.main-input:focus { outline: none; border-color: var(--accent); background: #222; }

.btn-row { display: flex; gap: 0.75rem; margin-top: 1rem; }
.btn-primary, .btn-secondary {
  flex: 1; padding: 1rem;
  font-weight: 700; border: none; border-radius: 4px;
  font-size: 0.9rem; cursor: pointer; text-transform: uppercase; letter-spacing: 1px;
  display: flex; align-items: center; justify-content: center; gap: 0.5rem;
}
.btn-primary { background: var(--accent); color: #000; }
.btn-secondary { background: transparent; color: var(--accent); border: 1px solid var(--accent); }
.btn-primary:hover, .btn-secondary:hover { opacity: 0.9; }

.search-tips {
  margin-top: 1.5rem; width: 100%; max-width: 500px;
  background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border);
  border-radius: 4px; padding: 1rem;
  font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; color: var(--text-muted);
}
.tip-header {
  color: var(--accent); font-weight: 700; margin-bottom: 0.75rem;
  display: flex; align-items: center; gap: 0.5rem;
  text-transform: uppercase; letter-spacing: 1px;
}
.tip-row { display: flex; align-items: flex-start; gap: 0.75rem; margin-bottom: 0.6rem; line-height: 1.4; }
.cmd-hl { color: var(--text-primary); background: rgba(255, 255, 255, 0.1); padding: 2px 6px; border-radius: 2px; white-space: nowrap; }

/* --- App View --- */
.app-header {
  position: sticky; top: 0; z-index: 100;
  background: rgba(0,0,0,0.95); backdrop-filter: blur(10px);
  padding: 0.75rem 1rem; padding-top: max(0.75rem, var(--safe-top));
  border-bottom: 1px solid var(--border);
  display: flex; justify-content: space-between; align-items: center; gap: 1rem;
}
.header-left { display: flex; align-items: center; gap: 1rem; flex: 1; min-width: 0; }
.logo-btn { font-family: 'JetBrains Mono'; font-weight: 700; color: white; cursor: pointer; flex-shrink: 0; }
.logo-btn:hover { color: var(--accent); }

.mini-search {
  background: var(--bg-input); border: 1px solid var(--border);
  color: white; padding: 0.5rem 1rem; border-radius: 4px;
  font-size: 0.9rem; flex: 1; min-width: 0;
}
.mini-search:focus { outline: none; border-color: var(--accent); }

.header-actions { display: flex; gap: 0.5rem; flex-shrink: 0; }
.icon-btn {
  background: var(--bg-input); border: 1px solid var(--border); color: var(--text-muted);
  width: 36px; height: 36px; border-radius: 4px;
  display: flex; align-items: center; justify-content: center; cursor: pointer;
}
.icon-btn:hover { border-color: var(--accent); color: var(--accent); }
.icon-btn.active { background: var(--accent-dim); color: var(--accent); border-color: var(--accent); }

/* --- Dashboard --- */
.dashboard-container {
  padding: 1rem; padding-bottom: calc(2rem + var(--safe-bottom));
  max-width: 1400px; margin: 0 auto;
  display: none;
}
.dashboard-container.active { display: block; animation: fadeIn 0.8s forwards; }
@keyframes fadeIn { to { opacity: 1; } }

/* Mode Toggle */
.mode-toggle {
  display: flex; gap: 0.5rem; margin-bottom: 1.5rem;
  background: var(--bg-card); padding: 0.5rem; border-radius: 4px; border: 1px solid var(--border);
}
.mode-btn {
  flex: 1; padding: 0.75rem; background: transparent; border: none;
  color: var(--text-muted); font-family: 'JetBrains Mono'; font-size: 0.85rem;
  cursor: pointer; border-radius: 4px; transition: all 0.2s;
  display: flex; align-items: center; justify-content: center; gap: 0.5rem;
}
.mode-btn.active { background: var(--accent-dim); color: var(--accent); }
.mode-btn:hover:not(.active) { color: var(--text-primary); }

/* Stats Row */
.stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem; }
.stat-item {
  background: var(--bg-card); padding: 1rem; border-radius: 4px;
  border: 1px solid var(--border); text-align: center;
}
.stat-label { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.5rem; }
.stat-val { font-size: 1.25rem; font-weight: 700; font-family: 'JetBrains Mono'; color: white; }
.stat-sub { font-size: 0.7rem; color: var(--success); margin-top: 4px; }
.stat-sub.neutral { color: var(--text-muted); }

/* Section Headers */
.section-header {
  display: flex; align-items: center; justify-content: space-between;
  gap: 0.5rem; margin: 2rem 0 1rem 0;
  border-bottom: 1px solid var(--border); padding-bottom: 0.5rem; flex-wrap: wrap;
}
.section-title-group { display: flex; align-items: center; gap: 0.5rem; }
.section-title {
  font-family: 'JetBrains Mono', monospace; font-size: 0.9rem; font-weight: 700;
  color: var(--accent); text-transform: uppercase; letter-spacing: 1px;
}

.header-controls { display: flex; gap: 0.75rem; align-items: center; }
.time-badge {
  font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; color: var(--text-muted);
  border: 1px solid var(--border); padding: 4px 8px; border-radius: 4px;
}

.filter-badge {
  display: none; background: var(--accent-dim); color: var(--accent);
  border: 1px solid var(--accent); padding: 4px 8px; border-radius: 4px;
  font-size: 0.7rem; font-family: 'JetBrains Mono', monospace;
  cursor: pointer; align-items: center; gap: 6px;
}
.filter-badge:hover { background: rgba(212, 196, 168, 0.2); }

/* Chart Containers */
.chart-wrapper {
  background: var(--bg-card); border: 1px solid var(--border);
  border-radius: 4px; padding: 1rem; width: 100%; 
  overflow-x: auto; /* Allow horizontal scroll if needed */
  overflow-y: visible; /* Allow chart to grow vertically */
}
.chart-container { 
  width: 100%; 
  min-height: 500px; /* Use min-height instead of fixed height */
  height: auto;      /* Allow it to stretch */
  display: block;    /* Changed from flex to block to handle height better */
}

/* Feed Grid */
.feed-grid { display: flex; flex-direction: column; gap: 1rem; }
.deal-card {
  background: var(--bg-card); border: 1px solid var(--border);
  border-radius: 4px; padding: 1.25rem; transition: transform 0.1s;
}
.deal-card:active { transform: scale(0.99); }
.deal-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem; }
.deal-agency { 
  font-size: 0.75rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase;
  background: rgba(255,255,255,0.05); padding: 2px 6px; border-radius: 4px;
}
.deal-amount { font-family: 'JetBrains Mono', monospace; color: var(--accent); font-weight: 700; font-size: 1rem; }
.deal-desc { font-size: 1rem; font-weight: 600; margin-bottom: 0.5rem; line-height: 1.4; color: white; }
.deal-vendor { font-size: 0.85rem; color: #8DA0CB; margin-bottom: 0.75rem; font-family: 'JetBrains Mono', monospace; }

.deal-meta { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem; }
.meta-tag {
  font-size: 0.65rem; font-family: 'JetBrains Mono', monospace;
  padding: 3px 8px; border-radius: 3px;
  background: rgba(255,255,255,0.05); color: var(--text-muted); border: 1px solid var(--border);
}
.meta-tag.naics { background: rgba(102, 194, 165, 0.15); border-color: rgba(102, 194, 165, 0.3); color: #66C2A5; }
.meta-tag.psc { background: rgba(141, 160, 203, 0.15); border-color: rgba(141, 160, 203, 0.3); color: #8DA0CB; }

.deal-footer {
  display: flex; justify-content: space-between; align-items: center;
  padding-top: 1rem; border-top: 1px solid #222;
}
.deal-date { font-size: 0.75rem; color: var(--text-muted); }
.action-btn {
  background: var(--bg-input); color: var(--accent); text-decoration: none;
  padding: 0.5rem 1rem; border-radius: 4px; font-size: 0.8rem; font-weight: 600;
  border: 1px solid var(--border); display: flex; align-items: center; gap: 6px;
}
.action-btn:hover { border-color: var(--accent); background: var(--accent-dim); }

/* Forecast Tables */
.forecast-table-wrapper { background: var(--bg-card); border: 1px solid var(--border); overflow-x: auto; border-radius: 4px; }
.forecast-table { width: 100%; border-collapse: collapse; font-family: 'JetBrains Mono'; font-size: 0.8rem; }
.forecast-table th { text-align: left; padding: 1rem; color: var(--text-muted); border-bottom: 1px solid var(--border); }
.forecast-table td { padding: 1rem; border-bottom: 1px solid var(--border); color: var(--text-primary); }
.trend-pill { padding: 2px 6px; border-radius: 2px; font-size: 0.7rem; font-weight: 700; }
.trend-up { color: var(--success); background: rgba(102, 194, 165, 0.1); }
.trend-down { color: var(--danger); background: rgba(251, 128, 114, 0.1); }

/* Insight Grid */
.insight-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 2rem; }
.insight-card { background: var(--bg-card); border: 1px solid var(--border); padding: 1rem; border-radius: 4px; }
.insight-val { font-size: 1.1rem; color: var(--text-primary); font-weight: 700; font-family: 'JetBrains Mono'; }
.insight-label { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.5rem; }

/* View Sections */
.view-section { display: none; }
.view-section.active { display: block; }

/* Loader */
.loader {
  position: fixed; inset: 0; z-index: 300;
  background: rgba(0,0,0,0.9);
  display: none; flex-direction: column; align-items: center; justify-content: center;
}
.spinner { width: 40px; height: 40px; border: 2px solid #333; border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }

/* Methodology Explainer */
.methodology-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 1.5rem;
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 1.5rem;
}
.method-item {
  padding-bottom: 1rem;
  border-bottom: 1px solid var(--border);
}
.method-item:nth-last-child(-n+2) {
  border-bottom: none;
  padding-bottom: 0;
}
.method-title {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.85rem;
  font-weight: 700;
  color: var(--accent);
  margin-bottom: 0.5rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}
.method-title i {
  font-size: 0.75rem;
  opacity: 0.7;
}
.method-desc {
  font-size: 0.8rem;
  color: var(--text-muted);
  line-height: 1.5;
}
.method-desc code {
  background: rgba(255,255,255,0.1);
  padding: 2px 6px;
  border-radius: 3px;
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.75rem;
  color: var(--text-primary);
}
.method-desc strong {
  color: var(--text-primary);
}

/* ========================================
   NEW: Sub-Agency Drill-Down Styles
   ======================================== */

/* Breadcrumb Navigation */
.drill-breadcrumb {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.75rem 1rem;
  background: linear-gradient(90deg, rgba(212, 196, 168, 0.1), transparent);
  border: 1px solid var(--border);
  border-radius: 4px;
  margin-bottom: 1rem;
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.8rem;
  overflow-x: auto;
  white-space: nowrap;
}

.breadcrumb-item {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  color: var(--text-muted);
  cursor: pointer;
  padding: 4px 8px;
  border-radius: 4px;
  transition: all 0.2s;
}

.breadcrumb-item:hover {
  background: rgba(255,255,255,0.05);
  color: var(--accent);
}

.breadcrumb-item.active {
  background: var(--accent-dim);
  color: var(--accent);
  cursor: default;
}

.breadcrumb-separator {
  color: var(--border);
  font-size: 0.7rem;
}

.breadcrumb-icon {
  font-size: 0.75rem;
}

/* Drill-Down Hint */
.drill-hint {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  padding: 0.5rem;
  background: rgba(212, 196, 168, 0.05);
  border: 1px dashed var(--border);
  border-radius: 4px;
  margin-top: 0.5rem;
  font-size: 0.75rem;
  color: var(--text-muted);
}

.drill-hint i {
  color: var(--accent);
}

/* Sub-Agency Breakdown Panel */
.subagency-panel {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 4px;
  margin-top: 1.5rem;
  overflow: hidden;
}

.subagency-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 1rem;
  background: linear-gradient(90deg, rgba(212, 196, 168, 0.08), transparent);
  border-bottom: 1px solid var(--border);
}

.subagency-header-left {
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

.subagency-header-icon {
  width: 36px;
  height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--accent-dim);
  border: 1px solid var(--accent);
  border-radius: 4px;
  color: var(--accent);
}

.subagency-header-text h3 {
  margin: 0;
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.9rem;
  color: var(--text-primary);
  font-weight: 600;
}

.subagency-header-text span {
  font-size: 0.75rem;
  color: var(--text-muted);
}

.subagency-stats {
  display: flex;
  gap: 1.5rem;
  font-family: 'JetBrains Mono', monospace;
}

.subagency-stat {
  text-align: right;
}

.subagency-stat-val {
  font-size: 1rem;
  font-weight: 700;
  color: var(--accent);
}

.subagency-stat-label {
  font-size: 0.65rem;
  color: var(--text-muted);
  text-transform: uppercase;
}

/* Sub-Agency List */
.subagency-list {
  max-height: 400px;
  overflow-y: auto;
}

.subagency-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 1rem;
  border-bottom: 1px solid var(--border);
  cursor: pointer;
  transition: all 0.15s;
}

.subagency-item:hover {
  background: rgba(255,255,255,0.02);
}

.subagency-item:last-child {
  border-bottom: none;
}

.subagency-item-left {
  display: flex;
  align-items: center;
  gap: 1rem;
  flex: 1;
  min-width: 0;
}

.subagency-rank {
  width: 28px;
  height: 28px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(255,255,255,0.05);
  border-radius: 4px;
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.75rem;
  color: var(--text-muted);
  flex-shrink: 0;
}

.subagency-rank.top-3 {
  background: var(--accent-dim);
  color: var(--accent);
  border: 1px solid rgba(212, 196, 168, 0.3);
}

.subagency-info {
  flex: 1;
  min-width: 0;
}

.subagency-name {
  font-size: 0.9rem;
  color: var(--text-primary);
  font-weight: 500;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.subagency-contracts {
  font-size: 0.75rem;
  color: var(--text-muted);
  margin-top: 2px;
}

.subagency-item-right {
  display: flex;
  align-items: center;
  gap: 1rem;
  flex-shrink: 0;
}

.subagency-bar-container {
  width: 120px;
  height: 8px;
  background: rgba(255,255,255,0.05);
  border-radius: 4px;
  overflow: hidden;
}

.subagency-bar {
  height: 100%;
  background: linear-gradient(90deg, var(--accent), rgba(212, 196, 168, 0.5));
  border-radius: 4px;
  transition: width 0.3s ease;
}

.subagency-amount {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.9rem;
  font-weight: 700;
  color: var(--accent);
  min-width: 80px;
  text-align: right;
}

.subagency-drill-icon {
  color: var(--text-muted);
  font-size: 0.8rem;
  opacity: 0;
  transition: all 0.15s;
}

.subagency-item:hover .subagency-drill-icon {
  opacity: 1;
  color: var(--accent);
  transform: translateX(2px);
}

/* Drill Level Indicator */
.drill-level-indicator {
  display: inline-flex;
  align-items: center;
  gap: 0.25rem;
  padding: 2px 6px;
  background: rgba(102, 194, 165, 0.1);
  border: 1px solid rgba(102, 194, 165, 0.3);
  border-radius: 4px;
  font-size: 0.65rem;
  color: var(--success);
  margin-left: 0.5rem;
}

/* Sankey Node Enhancement for Drillable */
.node-drillable {
  cursor: pointer;
}

.node-drillable:hover {
  filter: brightness(1.2);
}

/* Empty State */
.empty-drill-state {
  text-align: center;
  padding: 3rem 2rem;
  color: var(--text-muted);
}

.empty-drill-state i {
  font-size: 2rem;
  color: var(--border);
  margin-bottom: 1rem;
}

.empty-drill-state p {
  margin: 0.5rem 0;
}

@media (max-width: 768px) {
  .methodology-card {
    grid-template-columns: 1fr;
  }
  .method-item {
    border-bottom: 1px solid var(--border);
    padding-bottom: 1rem;
  }
  .method-item:last-child {
    border-bottom: none;
    padding-bottom: 0;
  }
  .subagency-bar-container {
    display: none;
  }
  .subagency-stats {
    flex-direction: column;
    gap: 0.5rem;
  }
  .subagency-stat {
    text-align: left;
  }
}

/* Mobile */
@media (max-width: 768px) {
  .stats-row { grid-template-columns: 1fr 1fr; }
  .insight-grid { grid-template-columns: 1fr; }
  .btn-row { flex-direction: column; }
}
@media (max-width: 600px) {
  .stats-row { grid-template-columns: 1fr; gap: 0.5rem; }
  .stat-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 1rem; }
  .stat-label { margin-bottom: 0; }
  .chart-container { height: 400px; }
  .chart-wrapper { overflow-x: auto; }
  .chart-container { min-width: 600px; }
  .mode-toggle { flex-direction: column; }
}
</style>
</head>
<body>

<div id="heroView" class="hero-view">
  <div class="terminal-logo"><span>>_</span>Govhoo</div>
  <p class="hero-subtitle">Historical-based Sales Forecasting</p>
  
  <div class="search-box-container">
    <input type="text" id="mainSearchInput" class="main-input" placeholder="Search keywords, company, or agency..." autocomplete="off">
    <div class="btn-row">
      <button id="searchBtn" class="btn-primary">
        <i class="fas fa-search"></i> SEARCH
      </button>
      <button id="forecastBtn" class="btn-secondary">
        <i class="fas fa-chart-line"></i> FORECAST
      </button>
    </div>
  </div>

  <div class="search-tips">
    <div class="tip-header"><i class="fas fa-terminal"></i> SEARCH_TIPS</div>
    <div class="tip-row"><span class="cmd-hl">cloud computing</span> <span>Search award descriptions, vendors, and agencies.</span></div>
    <div class="tip-row"><span class="cmd-hl">Company A, Company B</span> <span>Compare multiple competitors side-by-side.</span></div>
	 <div class="tip-row">
      <span class="cmd-hl">DA10</span>
      <span>PSC code (searches descriptions, not PSC field).</span>
    </div>

	<div class="tip-row">
      <span class="cmd-hl">API Limits</span>
      <span>Search returns a max of 100 awards sorted by dollar value for the past 12 months.</span>
    </div>
    <div class="tip-row">
      <span class="cmd-hl">Fuzzy Search</span>
      <span>Quotes are ignored. "Pizza" returns pizza contracts AND Pizzaro's Construction. ¯\_(ツ)_/¯</span>
    </div>
	<div class="tip-row"><span class="cmd-hl">Search Mode</span> <span>Drill down by Agency to see Award flow for past 12 months.</span></div>
 <div class="tip-row">
  <span class="cmd-hl">Forecast Mode</span> 
  <span>Estimates TAM (Total Addressable Market) using historical data. Features per-quarter outlier detection and volatility risk scoring.</span>
</div>
	<div class="tip-row">
      <span class="cmd-hl">Questions or Requests?</span>
      <span>DM me on <a href="https://www.linkedin.com/in/markflournoy/" target="_blank" style="color: var(--accent); text-decoration: underline;">LinkedIn</a></span>
    </div>
	<div class="tip-row">
      <span class="cmd-hl">Data sourced live from USASpending.gov</span>
    </div>
  </div>
</div>

<div id="appView" style="display:none;">
  <header class="app-header">
    <div class="header-left">
      <span class="logo-btn" onclick="App.showHero()">>_Govhoo</span>
      <input type="text" id="miniSearch" class="mini-search" placeholder="New search...">
    </div>
    <div class="header-actions">
      <button class="icon-btn" id="toggleModeBtn" onclick="App.toggleMode()" title="Toggle Mode">
        <i class="fas fa-exchange-alt"></i>
      </button>
      <button class="icon-btn" onclick="App.shareLink()" title="Copy Share Link">
        <i class="fas fa-link"></i>
      </button>
      <button class="icon-btn" title="Export CSV" onclick="App.exportCSV()">
        <i class="fas fa-download"></i>
      </button>
    </div>
  </header>

  <div id="dashboardContainer" class="dashboard-container">
    
    <div class="mode-toggle">
      <button class="mode-btn active" id="modeSearchBtn" onclick="App.setMode('search')">
        <i class="fas fa-project-diagram"></i> Agency Award Flow
      </button>
      <button class="mode-btn" id="modeForecastBtn" onclick="App.setMode('forecast')">
        <i class="fas fa-brain"></i> FY Forecast (Experimental)
      </button>
    </div>

    <div id="searchModeView" class="view-section active">
      <div class="stats-row" id="searchStats">
        <div class="stat-item">
          <div class="stat-label">TCV Awarded</div>
          <div class="stat-val" id="stat-vol">-</div>
          <div class="stat-sub neutral">Past 12 Months</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Contract Count</div>
          <div class="stat-val" id="stat-count">-</div>
          <div class="stat-sub neutral">Past 12 Months</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Prime Vendors</div>
          <div class="stat-val" id="stat-vendors">-</div>
          <div class="stat-sub neutral">Unique Recipients</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Agencies</div>
          <div class="stat-val" id="stat-agencies">-</div>
          <div class="stat-sub neutral">Awarding Agencies</div>
        </div>
      </div>

      <!-- NEW: Breadcrumb Navigation -->
      <div id="drillBreadcrumb" class="drill-breadcrumb" style="display: none;">
        <div class="breadcrumb-item" onclick="App.resetDrill()">
          <i class="fas fa-globe breadcrumb-icon"></i>
          <span>All Agencies</span>
        </div>
      </div>

      <div class="section-header">
        <div class="section-title-group">
          <i class="fas fa-project-diagram" style="color:var(--accent)"></i>
          <span class="section-title">Award Flow</span>
          <span id="drillLevelBadge" class="drill-level-indicator" style="display:none;">
            <i class="fas fa-layer-group"></i>
            <span id="drillLevelText">Level 1</span>
          </span>
        </div>
        <div class="header-controls">
          <div id="filterBadge" class="filter-badge" onclick="App.clearFilter()">
            <span id="filterName">FILTER</span> <i class="fas fa-times"></i>
          </div>
          <div class="time-badge">PAST 12 MONTHS</div>
        </div>
      </div>
      <div class="chart-wrapper">
        <div id="chartContainer" class="chart-container"></div>
      </div>
      <div id="drillHint" class="drill-hint">
        <i class="fas fa-mouse-pointer"></i>
        <span>Click an <strong>agency bar</strong> to drill into sub-agencies</span>
      </div>

      <!-- NEW: Sub-Agency Breakdown Panel -->
      <div id="subagencyPanel" class="subagency-panel" style="display: none;">
        <div class="subagency-header">
          <div class="subagency-header-left">
            <div class="subagency-header-icon">
              <i class="fas fa-building"></i>
            </div>
            <div class="subagency-header-text">
              <h3 id="subagencyParentName">Department of Defense</h3>
              <span id="subagencyParentType">Parent Agency</span>
            </div>
          </div>
          <div class="subagency-stats">
            <div class="subagency-stat">
              <div class="subagency-stat-val" id="subagencyTotalAmount">$0</div>
              <div class="subagency-stat-label">Total Value</div>
            </div>
            <div class="subagency-stat">
              <div class="subagency-stat-val" id="subagencyCount">0</div>
              <div class="subagency-stat-label">Sub-Agencies</div>
            </div>
          </div>
        </div>
        <div class="subagency-list" id="subagencyList">
          <!-- Populated dynamically -->
        </div>
      </div>

      <div class="section-header">
        <div class="section-title-group">
          <i class="fas fa-list-ul" style="color:var(--accent)"></i>
          <span class="section-title">Contract Award Feed</span>
        </div>
      </div>
      <div id="feedGrid" class="feed-grid"></div>
    </div>

    <div id="forecastModeView" class="view-section">
      <div class="stats-row" id="forecastStats">
        <div class="stat-item">
          <div class="stat-label" style="color:var(--accent); font-weight:700;">Estimated TAM</div>
          <div class="stat-val" id="stat-baseline">-</div>
          <div class="stat-sub neutral">FY Projected Volume</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Market</div>
          <div class="stat-val" id="stat-market">-</div>
          <div class="stat-sub" id="stat-hhi">-</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Peak Season</div>
          <div class="stat-val" id="stat-peak">-</div>
          <div class="stat-sub neutral">Seasonal Index</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Recompetes</div>
          <div class="stat-val" id="stat-recompetes">-</div>
          <div class="stat-sub" style="color:var(--danger)">Expiring < 2Y</div>
        </div>
      </div>

      <div class="section-header">
        <div class="section-title-group">
          <i class="fas fa-brain" style="color:var(--accent)"></i>
          <span class="section-title">Intelligent Forecast</span>
        </div>
      </div>
      <div id="marketInsights" class="insight-grid"></div>

      <div class="forecast-table-wrapper">
        <table class="forecast-table">
          <thead>
            <tr>
              <th>Period</th>
              <th>Predicted</th>
              <th>Hist. Avg</th>
              <th>Trend</th>
              <th>Confidence</th>
            </tr>
          </thead>
          <tbody id="forecastTableBody"></tbody>
        </table>
      </div>
<div class="section-header" style="margin-top:2rem;">
        <div class="section-title-group">
          <i class="fas fa-chart-bar" style="color:var(--accent)"></i>
          <span class="section-title">Historical Performance</span>
        </div>
      </div>
      <div class="chart-wrapper chart-wrapper-sm">
        <canvas id="spendingChart"></canvas>
      </div>
      <div id="strategySection" style="margin-top: 2rem; display:none;">
  <div class="section-header">
    <div class="section-title-group">
      <i class="fas fa-chess-knight" style="color:var(--accent)"></i>
      <span class="section-title">Strategic Analysis</span>
    </div>
  </div>

  <div class="deal-card" style="border-left: 4px solid var(--accent); margin-bottom: 1.5rem; background: linear-gradient(to right, rgba(212, 196, 168, 0.05), transparent);">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.75rem;">
      <span style="font-size:0.75rem; color:var(--accent); font-weight:700; letter-spacing:1px;">OUTLOOK</span>
      <span id="strat-outlook" style="font-size:1rem; font-weight:700; color:#fff;">--</span>
    </div>
    
    <div id="strat-text" style="font-size: 0.9rem; color: #ccc; margin-bottom: 1.25rem; line-height: 1.5;"></div>

    <div style="padding-top:1rem; border-top:1px solid rgba(255,255,255,0.1);">
      <div style="font-size:0.7rem; color:#888; text-transform:uppercase; margin-bottom:4px;">Recommended Action</div>
      <div id="strat-action" style="font-size:0.95rem; color:white; font-weight:500;"></div>
    </div>
  </div>

  <div class="insight-grid" style="grid-template-columns: repeat(3, 1fr); gap:0.75rem; margin-bottom: 1.5rem;">
    <div class="insight-card" style="padding: 0.75rem;">
      <div class="insight-label">BD Investment</div>
      <div id="matrix-bd" style="font-size:0.9rem; font-weight:600; color:white; margin:4px 0;">--</div>
      <div class="stat-sub neutral" style="font-size:0.65rem;">vs. Growth Trend</div>
    </div>
    <div class="insight-card" style="padding: 0.75rem;">
      <div class="insight-label">Capture Strategy</div>
      <div id="matrix-strat" style="font-size:0.9rem; font-weight:600; color:white; margin:4px 0;">--</div>
      <div class="stat-sub neutral" style="font-size:0.65rem;">vs. Competition</div>
    </div>
    <div class="insight-card" style="padding: 0.75rem;">
      <div class="insight-label">Pipeline Focus</div>
      <div id="matrix-pipe" style="font-size:0.9rem; font-weight:600; color:white; margin:4px 0;">--</div>
      <div class="stat-sub neutral" style="font-size:0.65rem;">vs. Opportunity</div>
    </div>
  </div>

  <div style="background:rgba(255,255,255,0.02); padding:1rem; border:1px solid #333; border-radius:4px;">
  <div style="display:flex; align-items:center; gap:8px; margin-bottom:0.75rem; color:var(--text-muted); font-size:0.75rem; font-weight:700; letter-spacing:0.5px;">
    <i class="fas fa-info-circle"></i> MODEL LIMITATIONS & LOGIC
  </div>
  <ul style="margin:0; padding-left:1.2rem; color:#888; font-size:0.8rem; line-height:1.6;">
    <li style="margin-bottom:4px;">
      <strong>TAM (Total Addressable Market):</strong> 
      Projected annual volume based on <em>aggregate historical obligations</em> from USASpending (not just the top 100 sample). Uses a recency-weighted average of completed Fiscal Years, prioritizing the most recent year's spend velocity.
    </li>
    <li style="margin-bottom:4px;">
      <strong>Awards vs. Forecast Gap:</strong> 
      "Total Awards" reflects <em>Total Contract Value (Ceiling)</em>, the maximum possible spend including all option years. "Forecast" projects <em>Actual Obligated Spending</em>, real cash flow. Large deltas represent unfunded ceiling capacity on vehicles like IDIQs.
    </li>
    <li style="margin-bottom:4px;">
      <strong>Historical Basis:</strong> Forecasts rely entirely on seasonal trends from USASpending data. The model cannot predict budget cuts, policy shifts, or continuing resolutions (CRs).
    </li>
    <li style="margin-bottom:4px;">
      <strong>Data Scope:</strong> TAM covers the full market. "Market Concentration" (HHI) and "Top Incumbents" are calculated from a sample of the top 100 agencies/contracts by value.
    </li>
    <li style="margin-bottom:4px;">
      <strong>Reporting Lag:</strong> Recent quarters may appear artificially low due to the standard 90-day federal reporting delay.
    </li>
    <li>
      <strong>Confidence Score:</strong> Based solely on data availability. "High" = 3+ years of historical data for that quarter. "Medium" = 2 years. "Low" = limited historical data.
    </li>
  </ul>
</div>
</div>

<div class="section-header" style="margin-top:2rem;">
  <div class="section-title-group">
    <i class="fas fa-code-branch" style="color:var(--accent)"></i>
    <span class="section-title">Forecast Methodology</span>
  </div>
</div>

<div class="methodology-card" style="grid-template-columns: repeat(2, 1fr); gap:1rem;">
  <div class="method-item" style="border:none;">
    <div class="method-title"><i class="fas fa-layer-group"></i> Top-Down Volume</div>
    <div class="method-desc">
      Instead of guessing quarterly jumps, we forecast <strong>Total Annual Spending</strong> using a weighted average of the last 3 fiscal years. This creates a stable baseline that prioritizes recent trends over older data.
    </div>
  </div>

  <div class="method-item" style="border:none;">
    <div class="method-title"><i class="fas fa-chart-area"></i> Seasonality</div>
    <div class="method-desc">
      We analyze historical spending patterns to determine the unique "shape" of the fiscal year (e.g., how much budget is spent in Q4). The annual forecast is then distributed across quarters to match this proven seasonal rhythm.
    </div>
  </div>

  <div class="method-item" style="border:none;">
    <div class="method-title"><i class="fas fa-filter"></i> Outlier Removal</div>
    <div class="method-desc">
      Anomalies are filtered on a <strong>per-quarter basis</strong> to distinguish between recurring seasonal spikes and one-off events. This ensures that random, non-repeating "mega-contracts" do not artificially inflate future predictions.
    </div>
  </div>

  <div class="method-item" style="border:none;">
    <div class="method-title"><i class="fas fa-balance-scale"></i> Market Context</div>
    <div class="method-desc">
      We calculate the <strong>Herfindahl-Hirschman Index (HHI)</strong>, a standard economic measure of market concentration. Low scores (<1,500) indicate a competitive field, while high scores (>2,500) signal a market dominated by incumbents.
    </div>
  </div>
</div>
	  
      <div id="recompetesList" style="margin-top:2rem;"></div>
    </div>
  </div>
</div>

<div id="loader" class="loader">
  <div class="spinner"></div>
  <p id="loaderText" style="margin-top:1rem; font-family:'JetBrains Mono'; color:var(--accent);">RETRIEVING DATA...</p>
  <p id="loaderSubtext" style="color:#666; font-size:0.8rem; margin-top:0.5rem;"></p>
</div>

<script>
// ==================== UTILITIES ====================
const Utils = {
  money: n => {
    if (!n && n !== 0) return '-';
    if(n >= 1e9) return '$' + (n/1e9).toFixed(1) + 'B';
    if(n >= 1e6) return '$' + (n/1e6).toFixed(1) + 'M';
    if(n >= 1e3) return '$' + (n/1e3).toFixed(0) + 'K';
    return '$' + Math.round(n).toLocaleString();
  },
  trunc: (s, l) => (s && s.length > l) ? s.substring(0,l)+'...' : (s || 'No Description'),
  date: s => s ? new Date(s).toLocaleDateString() : '—',
  formatDateISO: date => date.toISOString().split('T')[0],
  
  getCurrentFY: () => {
    const now = new Date();
    // Federal FY starts Oct 1 (Month 9)
    return now.getMonth() >= 9 ? now.getFullYear() + 1 : now.getFullYear();
  },

  getCurrentQuarter: () => {
    const m = new Date().getMonth(); // 0-11
    // Oct(9), Nov(10), Dec(11) -> Q1
    // Jan(0), Feb(1), Mar(2)   -> Q2
    // Apr(3), May(4), Jun(5)   -> Q3
    // Jul(6), Aug(7), Sep(8)   -> Q4
    if (m >= 9) return 1;
    if (m <= 2) return 2;
    if (m <= 5) return 3;
    return 4;
  },
  
  generateWeights: count => {
    if (count <= 0) return [];
    if (count === 1) return [1];
    if (count === 2) return [0.3, 0.7];
    if (count === 3) return [0.2, 0.3, 0.5];
    
    // For more years, favor recent heavily
    const weights = [];
    let sum = 0;
    // Exponential-ish weights
    for(let i=0; i<count; i++) {
        let w = Math.pow(1.5, i);
        weights.push(w);
        sum += w;
    }
    return weights.map(w => w / sum);
  },
  
  getColor: name => {
    const palette = ['#958BB6', '#6F8A74', '#C27E5C', '#8FB6D0', '#B0C4DE', '#D9B48F'];
    let hash = 0;
    for (let i = 0; i < name.length; i++) {
      hash = name.charCodeAt(i) + ((hash << 5) - hash);
    }
    return palette[Math.abs(hash) % palette.length];
  }
};

// ==================== API ====================
const API = {
  baseUrl: 'https://api.usaspending.gov/api/v2',
  
  // Search Mode API
  async searchAwards(keywords) {
    const today = new Date();
    const oneYearAgo = new Date();
    oneYearAgo.setFullYear(today.getFullYear() - 1);
    
    const period = {
      start_date: Utils.formatDateISO(oneYearAgo),
      end_date: Utils.formatDateISO(today)
    };
    
    const terms = keywords.split(',').map(s => s.trim()).filter(s => s.length > 0);
    
    const fetchPromises = terms.map(term => {
      return fetch(`${this.baseUrl}/search/spending_by_award/`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          filters: { 
            keywords: [term], 
            time_period: [period],
            award_type_codes: ['A','B','C','D']
          },
          fields: [
            'Award ID', 'Recipient Name', 'Awarding Agency', 'Awarding Sub Agency',
            'Award Amount', 'Description', 'generated_internal_id',
            'Start Date', 'End Date', 'NAICS Code', 'NAICS Description', 'PSC Code', 'PSC Description'
          ],
          limit: 100,
          sort: 'Award Amount',
          order: 'desc'
        })
      }).then(res => res.json());
    });
    
    const results = await Promise.all(fetchPromises);
    let combined = [];
    results.forEach(json => {
      if(json.results) combined = combined.concat(json.results);
    });
    
    // Deduplicate
    const unique = new Map();
    combined.forEach(item => {
      if(!unique.has(item['Award ID'])) unique.set(item['Award ID'], item);
    });
    
    return Array.from(unique.values()).sort((a,b) => b['Award Amount'] - a['Award Amount']);
  },
  
  // Forecast Mode APIs
  async getSpendingOverTime(keywords, yearsBack=4) {
    const curFY = Utils.getCurrentFY();
    const periods = [];
    // Get extra history to establish trends
    for(let y=curFY-yearsBack; y<=curFY; y++) {
      periods.push({start_date:`${y-1}-10-01`, end_date:`${y}-09-30`});
    }
    
    const res = await fetch(`${this.baseUrl}/search/spending_over_time/`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        group: 'quarter',
        filters: { keywords:[keywords], time_period:periods, award_type_codes:['A','B','C','D'] }
      })
    });
    return (await res.json()).results || [];
  },
  
  async getAgencyData(keywords, yearsBack=3) {
    const curFY = Utils.getCurrentFY();
    const periods = [{start_date:`${curFY-yearsBack-1}-10-01`, end_date:`${curFY}-09-30`}];
    
    const res = await fetch(`${this.baseUrl}/search/spending_by_category/awarding_agency`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        category: 'awarding_agency',
        filters: { keywords:[keywords], time_period:periods, award_type_codes:['A','B','C','D'] },
        limit: 100
      })
    });
    return (await res.json()).results || [];
  },
  
  async getAwardsForForecast(keywords, yearsBack=3) {
    const curFY = Utils.getCurrentFY();
    // We want current active contracts primarily
    const periods = [{start_date:`${curFY-yearsBack-1}-10-01`, end_date:`${curFY+5}-09-30`}];
    
    const res = await fetch(`${this.baseUrl}/search/spending_by_award/`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        filters: { keywords:[keywords], time_period:periods, award_type_codes:['A','B','C','D'] },
        fields: ['Award ID','Recipient Name','Description','Start Date','End Date','Award Amount','Awarding Agency','generated_internal_id'],
        // FIX: Sort by Amount DESC to get big contracts, not "End Date DESC" which gives contracts ending in 2030
        limit: 100, 
        sort: 'Award Amount',
        order: 'desc'
      })
    });
    return (await res.json()).results || [];
  }
};

// ==================== FORECAST ENGINE ====================
const ForecastEngine = {
  analyze(spendingData, awardsData, agencyData) {
    // 1. Organize Data
    const organized = this.organizeByQuarter(spendingData);
    
    // 2. Filter Global Outliers (Quarterly specific)
    const filtered = this.filterOutliers(organized);
    
    // 3. Calculate Seasonality (The "Shape" of the year)
    // Returns {1: 0.15, 2: 0.20, 3: 0.25, 4: 0.40} summing to 1.0
    const seasonalProfile = this.calculateSeasonalProfile(filtered);
    
    // 4. Calculate Annual Baseline (The "Volume" of the year)
    // Uses weighted average of last 3 completed fiscal years
    const annualForecast = this.calculateAnnualForecast(filtered);
    
    // 5. Detect Recompetes & Market Health
    const recompetes = this.detectRecompetes(awardsData);
    const market = this.analyzeMarketConcentration(agencyData);
    
    // 6. Generate Quarterly Predictions (Top-Down distribution)
    const forecasts = this.generateForecasts(annualForecast, seasonalProfile, filtered);

    const strategy = this.generateStrategy(forecasts, market.hhi, recompetes);

    return {
      forecasts,
      recompetes,
      baseline: annualForecast,
      marketStatus: market.level,
      hhi: market.hhi,
      indices: seasonalProfile,
      byFY: organized.byFY,
      strategy: strategy // <--- Return this
    };
  },

  organizeByQuarter(spendingData) {
    const organized = { byFY: {}, byQuarter: {}, totalByFY: {}, allAmounts: [] };
    spendingData.forEach(d => {
      const q = parseInt(d.time_period?.quarter);
      const fy = parseInt(d.time_period?.fiscal_year);
      const amt = d.aggregated_amount || 0;
      if(q && fy) {
        if(!organized.byFY[fy]) organized.byFY[fy] = {1:0, 2:0, 3:0, 4:0};
        organized.byFY[fy][q] = amt;
        if(!organized.byQuarter[q]) organized.byQuarter[q] = [];
        organized.byQuarter[q].push({fy, amt});
        organized.totalByFY[fy] = (organized.totalByFY[fy] || 0) + amt;
        organized.allAmounts.push({fy, q, amt});
      }
    });
    return organized;
  },

  filterOutliers(organized) {
    // Standard deviation filter per quarter to remove massive anomalies
    const filtered = { byFY: {}, byQuarter: {}, totalByFY: {}, allAmounts: [] };
    Object.keys(organized.byFY).forEach(fy => filtered.byFY[fy] = {}); // Init structure
    
    for(let q=1; q<=4; q++) {
      const qData = organized.byQuarter[q] || [];
      const amounts = qData.map(d => d.amt);
      
      // If scant data, keep everything
      if(amounts.length < 3) {
        qData.forEach(d => {
           filtered.byQuarter[q] = filtered.byQuarter[q] || [];
           filtered.byQuarter[q].push(d);
           filtered.byFY[d.fy][q] = d.amt;
           filtered.totalByFY[d.fy] = (filtered.totalByFY[d.fy]||0) + d.amt;
        });
        continue;
      }
      
      // Calculate Stats
      const mean = amounts.reduce((a,b)=>a+b,0) / amounts.length;
      const variance = amounts.reduce((s,v)=>s+Math.pow(v-mean,2),0) / amounts.length;
      const stdDev = Math.sqrt(variance);
      const limit = mean + (2 * stdDev); 
      
      qData.forEach(item => {
        // Only filter high-side outliers (spikes), keep lows (zeros are real in gov)
        if(item.amt <= limit) {
           filtered.byQuarter[q] = filtered.byQuarter[q] || [];
           filtered.byQuarter[q].push(item);
           filtered.byFY[item.fy][q] = item.amt;
           filtered.totalByFY[item.fy] = (filtered.totalByFY[item.fy]||0) + item.amt;
        }
      });
    }
    return filtered;
  },

  calculateSeasonalProfile(filtered) {
    // Determine what % of the year usually happens in Q1, Q2, Q3, Q4
    const quarters = {1:0, 2:0, 3:0, 4:0};
    const counts = {1:0, 2:0, 3:0, 4:0};
    
    // Look at every completed year
    const years = Object.keys(filtered.totalByFY);
    years.forEach(fy => {
        const total = filtered.totalByFY[fy];
        if(total <= 0) return;
        
        // Only use years that have data for at least 3 quarters to avoid skewing
        const qWithData = Object.values(filtered.byFY[fy]).filter(v => v > 0).length;
        if(qWithData < 3) return;

        for(let q=1; q<=4; q++) {
            const amt = filtered.byFY[fy][q] || 0;
            quarters[q] += (amt / total); // Add the percentage (e.g. 0.25)
            counts[q]++;
        }
    });

    // Average the percentages
    const profile = {};
    let sum = 0;
    for(let q=1; q<=4; q++) {
        profile[q] = counts[q] ? quarters[q] / counts[q] : 0.25;
        sum += profile[q];
    }
    
    // Normalize to ensure sum is exactly 1.0
    for(let q=1; q<=4; q++) profile[q] = profile[q] / sum;
    
    return profile;
  },

  calculateAnnualForecast(filtered) {
    // Weighted Average of Annual Totals (ignoring incomplete current FY)
    const curFY = Utils.getCurrentFY();
    const years = Object.keys(filtered.totalByFY).map(Number).sort((a,b)=>a-b);
    
    // Filter out the current incomplete year and years with zero spend
    const cleanYears = years.filter(y => y < curFY && filtered.totalByFY[y] > 0);
    
    if(cleanYears.length === 0) return 0;
    
    // Weight recent years more heavily (1, 2, 3...)
    let weightedSum = 0;
    let weightTotal = 0;
    
    cleanYears.forEach((fy, index) => {
        const weight = index + 1; 
        weightedSum += filtered.totalByFY[fy] * weight;
        weightTotal += weight;
    });
    
    let baseline = weightedSum / weightTotal;

    // FIX: Removed the arbitrary +/- 5% logic.
    // New Logic: If we have at least 2 years of data, blend the Baseline with the Most Recent Year.
    // This allows the forecast to react to recent trends without being too volatile.
    if(cleanYears.length >= 2) {
        const recentYear = filtered.totalByFY[cleanYears[cleanYears.length-1]];
        // 70% Weight to the Stable Baseline, 30% Weight to the Recent Year
        baseline = (baseline * 0.7) + (recentYear * 0.3);
    }
    
    return baseline;
  },

  analyzeMarketConcentration(agencyData) {
    const total = agencyData.reduce((s,a)=>s+a.amount,0);
    let hhi = 0;
    agencyData.forEach(a => {
      const share = (a.amount / total) * 100;
      hhi += share * share;
    });
    let level = "Competitive";
    if(hhi > 2500) level = "Concentrated";
    else if(hhi > 1500) level = "Moderate";
    return { hhi: Math.round(hhi), level };
  },

  detectRecompetes(awards) {
    const now = new Date();
    const sixMonths = new Date(); sixMonths.setMonth(now.getMonth() + 6);
    const twoYears = new Date(); twoYears.setFullYear(now.getFullYear()+2);
    return awards.filter(a => {
      const end = new Date(a['End Date']);
      return end > sixMonths && end < twoYears && a['Award Amount'] > 50000;
    }).slice(0, 15);
  },
generateForecasts(annualForecast, seasonalProfile, filtered) {
    const forecasts = [];
    const curFY = Utils.getCurrentFY();
    const curQ = Utils.getCurrentQuarter();
    
    let fy = curFY;
    let q = curQ;
    
    for(let i=0; i<4; i++) {
      const predicted = annualForecast * seasonalProfile[q];
      
      // Get full history
      const qHistory = filtered.byQuarter[q] || [];
      // Get active years to check for dollar stability
      const activeYears = qHistory.filter(d => d.amt > 0).sort((a,b) => a.fy - b.fy);
      
      const trueAvg = qHistory.length ? qHistory.reduce((s, d) => s + d.amt, 0) / qHistory.length : 0;
      
      // 1. Calculate Volatility
      let volatility = 0;
      if(activeYears.length > 1) {
          const activeAvg = activeYears.reduce((s, d) => s + d.amt, 0) / activeYears.length;
          const variance = activeYears.reduce((s, d) => s + Math.pow(d.amt - activeAvg, 2), 0) / (activeYears.length - 1);
          volatility = Math.sqrt(variance) / activeAvg;
      }

      // 2. Check for "Strict Growth" (Is every year higher than the last?)
      // If yes, we forgive high volatility because it's directional.
      let isStrictGrowth = false;
      if (activeYears.length >= 3) {
          isStrictGrowth = true;
          for(let k=1; k<activeYears.length; k++) {
              if (activeYears[k].amt <= activeYears[k-1].amt) {
                  isStrictGrowth = false;
                  break;
              }
          }
      }

      // 3. Trend Calculation
      let displayTrend = 0;
      if(trueAvg > 0) displayTrend = ((predicted - trueAvg) / trueAvg) * 100;
      else if (predicted > 0) displayTrend = 100;

      // 4. CONFIDENCE LOGIC (Adjusted for Growth & Gov Lumpiness)
      let confLabel = "Low";
      let confReason = "Insufficient Data";

      if (qHistory.length === 0) {
          confLabel = "Low"; confReason = "No History";
      } else if (activeYears.length === 0) {
          confLabel = "Low"; confReason = "Inactive";
      } else {
          const isFrequent = activeYears.length >= 3;
          const hasGaps = activeYears.length < qHistory.length; 
          
          // Adjusted Thresholds: 
          // < 0.5 (50%) is now considered "Stable" for Gov (was 0.25)
          // < 1.0 (100%) is "Moderate" (was 0.55)
          
          if (isFrequent && !hasGaps) {
              if (isStrictGrowth) {
                  confLabel = "High";
                  confReason = "Consistent Growth"; // Reward Growth
              } else if (volatility < 0.5) {
                  confLabel = "High";
                  confReason = "Stable Trend";
              } else if (volatility < 1.0) {
                  confLabel = "Med";
                  confReason = "Moderate Variance";
              } else {
                  confLabel = "Low";
                  confReason = "High Volatility";
              }
          } 
          else if (isFrequent && hasGaps) {
              confLabel = "Med"; confReason = "Intermittent";
          } 
          else {
              // Less than 3 data points
              if (volatility < 0.2) { confLabel = "Med"; confReason = "Limited but Stable"; }
              else { confLabel = "Low"; confReason = "Limited History"; }
          }
      }

      forecasts.push({
        period: `FY${fy} Q${q}`,
        predicted: predicted,
        histAvg: trueAvg,
        trend: displayTrend > 0 ? `+${displayTrend.toFixed(1)}` : displayTrend.toFixed(1),
        confidence: { label: confLabel, reason: confReason }
      });
      
      q++;
      if(q > 4) { q = 1; fy++; }
    }
    return forecasts;
  },
generateStrategy(forecasts, hhi, recompetes) {
    // 0. Safety Check
    if(!forecasts || forecasts.length < 2) return null;

    // 1. Analyze Growth (Avg of next 2 quarters)
    const nearTerm = forecasts.slice(0, 2);
    const avgGrowth = nearTerm.reduce((sum, f) => sum + parseFloat(f.trend), 0) / nearTerm.length;
    
    let growthSignal = "Moderate";
    // Raise the bar: Only flag "High Growth" if it's undeniable (>30%)
    if (avgGrowth > 30) growthSignal = "High Growth"; 
    else if (avgGrowth < -20) growthSignal = "Decline";

    // 2. Analyze Market
    let marketType = "Moderate";
    if (hhi > 2500) marketType = "Concentrated";
    else if (hhi < 1500) marketType = "Competitive";

    // 3. Generate Executive Text (MUTED LANGUAGE)
    let outlook = "";
    let action = "";
    
    if (growthSignal === "High Growth") {
        // Changed "Aggressive Expansion" -> "Positive Variance"
        outlook = `The model projects positive variance (+${avgGrowth.toFixed(1)}% avg) compared to historical baselines. While data suggests upward momentum, users should verify if this is due to new funding or statistical anomalies in prior years.`;
        action = "Validate pipeline depth. Assess capacity before committing additional resources.";
    } else if (growthSignal === "Decline") {
        outlook = `The model projects a softening trend (${avgGrowth.toFixed(1)}% avg). Volume may be lower than historical norms for this period.`;
        action = "Focus business development efforts strictly on high-probability recompetes and existing relationships.";
    } else {
        outlook = `The model suggests stability, with projected volume tracking close to historical averages.`;
        action = "Maintain consistent business development cadence. Focus on capture quality over volume.";
    }

    // Add Market Nuance
    if (marketType === "Concentrated") {
        outlook += ` High concentration (HHI > 2500) suggests incumbent dominance.`;
        action += " Teaming with incumbents is recommended.";
    } else if (marketType === "Competitive") {
        outlook += ` Low concentration (HHI < 1500) implies a fragmented landscape.`;
        action += " A broader prospecting approach may yield results.";
    }

    // 4. Matrix Values (MUTED ACTIONS)
    const matrix = {
        bd: growthSignal === "High Growth" ? "Validate & Assess" : (growthSignal === "Decline" ? "Selective Focus" : "Maintain Steady"),
        strat: marketType === "Concentrated" ? "Relationship Focus" : (marketType === "Competitive" ? "Volume Bidding" : "Balanced Approach"),
        pipe: recompetes.length > 5 ? "Incumbent Displacement" : "New Requirements"
    };

    return {
        // Changed "High Activity Expected" -> "Growth Projected" (Less hype)
        title: growthSignal === "High Growth" ? "Growth Projected" : (growthSignal === "Decline" ? "Softening Projected" : "Stable Outlook"),
        text: outlook,
        action: action,
        matrix: matrix
    };
  }
};

// ==================== APP ====================
const App = {
  mode: 'search', // 'search' or 'forecast'
  currentQuery: '',
  
  // Search mode state
  searchData: {
    raw: [],
    active: [],
    filter: null,
    loaded: false
  },
  
  // Forecast mode state
  forecastData: {
    spending: null,
    agencies: null,
    awards: null,
    analysis: null,
    loaded: false
  },

  // ==================== NEW: Drill-Down State ====================
  drillState: {
    level: 0,                  // 0 = All, 1 = Agency, 2 = Sub-Agency
    path: [],                  // Breadcrumb trail: [{type, name, data}]
    currentAgency: null,       // Currently selected agency
    currentSubAgency: null     // Currently selected sub-agency
  },

  init() {
    document.getElementById('searchBtn').onclick = () => App.runSearch();
    document.getElementById('forecastBtn').onclick = () => App.runForecast();
    
    document.getElementById('mainSearchInput').addEventListener('keypress', e => {
      if(e.key === 'Enter') App.runSearch();
    });
    
    document.getElementById('miniSearch').addEventListener('keypress', e => {
      if(e.key === 'Enter') {
        const newQuery = e.target.value.trim();
        if(!newQuery) return;
        
        // Update main input as well
        document.getElementById('mainSearchInput').value = newQuery;
        
        if(App.mode === 'forecast') {
          App.runForecast(newQuery);
        } else {
          App.runSearch(newQuery);
        }
      }
    });

    let resizeTimer;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(() => {
        if(App.searchData.active.length > 0 && App.mode === 'search') App.renderSankey();
      }, 200);
    });

    const params = new URLSearchParams(window.location.search);
    const q = params.get('q');
    const m = params.get('mode');
    if (q) {
      document.getElementById('mainSearchInput').value = q;
      if(m === 'forecast') App.runForecast(q);
      else App.runSearch(q);
    }
  },

  showHero() {
    const hero = document.getElementById('heroView');
    document.getElementById('appView').style.display = 'none';
    hero.style.display = 'flex';
    hero.classList.remove('hidden');
    setTimeout(() => hero.classList.remove('slide-up'), 10);
    
    const url = new URL(window.location);
    url.searchParams.delete('q');
    url.searchParams.delete('mode');
    window.history.replaceState({}, '', url);
  },

  setMode(mode) {
    App.mode = mode;
    document.getElementById('modeSearchBtn').classList.toggle('active', mode === 'search');
    document.getElementById('modeForecastBtn').classList.toggle('active', mode === 'forecast');
    document.getElementById('searchModeView').classList.toggle('active', mode === 'search');
    document.getElementById('forecastModeView').classList.toggle('active', mode === 'forecast');
    
    // Update URL
    const url = new URL(window.location);
    url.searchParams.set('mode', mode);
    window.history.replaceState({}, '', url);
    
    // If switching to a mode that hasn't loaded data yet, fetch it
    if(App.currentQuery) {
      if(mode === 'search' && !App.searchData.loaded) {
        App.runSearch(App.currentQuery);
      } else if(mode === 'forecast' && !App.forecastData.loaded) {
        App.runForecast(App.currentQuery);
      }
    }
  },

  toggleMode() {
    const newMode = App.mode === 'search' ? 'forecast' : 'search';
    App.setMode(newMode);
  },

  // ==================== SEARCH MODE ====================
  async runSearch(val) {
    const query = val || document.getElementById('mainSearchInput').value;
    if(!query) return;

    const isNewQuery = query !== App.currentQuery;
    if(isNewQuery) {
      App.searchData = { raw: [], active: [], filter: null, loaded: false };
      App.forecastData = { spending: null, agencies: null, awards: null, analysis: null, loaded: false };
      App.resetDrill(); // Reset drill state on new query
    }
    
    App.currentQuery = query;
    App.mode = 'search';
    App.showLoader('RETRIEVING DATA...', 'Searching USASpending API');

    try {
      App.searchData.raw = await API.searchAwards(query);
      App.searchData.filter = null;
      App.searchData.active = App.searchData.raw;
      App.searchData.loaded = true;
      
      App.updateURL(query, 'search');
      App.transitionToApp();
      App.setMode('search');
      App.updateSearchDashboard();
      
      requestAnimationFrame(() => {
        requestAnimationFrame(() => App.renderSankey());
      });
      
    } catch(e) {
      console.error(e);
      alert("Error retrieving data.");
    } finally {
      App.hideLoader();
    }
  },

  updateSearchDashboard() {
    const data = App.searchData.active;
    const total = data.reduce((acc, c) => acc + (c['Award Amount']||0), 0);
    const vendors = new Set(data.map(c => c['Recipient Name'])).size;
    const agencies = new Set(data.map(c => c['Awarding Agency'])).size;
    
    document.getElementById('stat-vol').innerText = Utils.money(total);
    document.getElementById('stat-count').innerText = data.length;
    document.getElementById('stat-vendors').innerText = vendors;
    document.getElementById('stat-agencies').innerText = agencies;
    
    // Filter badge (legacy - keeping for compatibility)
    const badge = document.getElementById('filterBadge');
    if (App.searchData.filter) {
      badge.style.display = 'inline-flex';
      document.getElementById('filterName').innerText = App.searchData.filter;
    } else {
      badge.style.display = 'none';
    }
    
    App.renderFeed();
    App.updateDrillUI();
  },

  // ==================== NEW: Drill-Down Methods ====================

  resetDrill() {
    App.drillState = {
      level: 0,
      path: [],
      currentAgency: null,
      currentSubAgency: null
    };
    App.searchData.filter = null;
    App.searchData.active = App.searchData.raw;
    App.updateSearchDashboard();
    App.renderSankey();
  },

  updateDrillUI() {
    const breadcrumb = document.getElementById('drillBreadcrumb');
    const hint = document.getElementById('drillHint');
    const levelBadge = document.getElementById('drillLevelBadge');
    const subagencyPanel = document.getElementById('subagencyPanel');
    
    if (App.drillState.level === 0) {
      // Top level - show hint, hide breadcrumb
      breadcrumb.style.display = 'none';
      hint.style.display = 'flex';
      hint.innerHTML = `
        <i class="fas fa-mouse-pointer"></i>
        <span>Click an <strong>agency bar</strong> to drill into sub-agencies</span>
      `;
      levelBadge.style.display = 'none';
      subagencyPanel.style.display = 'none';
    } else {
      // Drilled in - show breadcrumb
      breadcrumb.style.display = 'flex';
      levelBadge.style.display = 'inline-flex';
      
      // Build breadcrumb HTML
      let breadcrumbHTML = `
        <div class="breadcrumb-item" onclick="App.resetDrill()">
          <i class="fas fa-globe breadcrumb-icon"></i>
          <span>All Agencies</span>
        </div>
      `;
      
      App.drillState.path.forEach((item, idx) => {
        const isLast = idx === App.drillState.path.length - 1;
        breadcrumbHTML += `
          <span class="breadcrumb-separator"><i class="fas fa-chevron-right"></i></span>
          <div class="breadcrumb-item ${isLast ? 'active' : ''}" 
               onclick="${isLast ? '' : `App.drillToLevel(${idx + 1})`}">
            <i class="fas ${item.type === 'agency' ? 'fa-building' : 'fa-sitemap'} breadcrumb-icon"></i>
            <span>${Utils.trunc(item.name, 25)}</span>
          </div>
        `;
      });
      
      breadcrumb.innerHTML = breadcrumbHTML;
      
      // Update level badge
      document.getElementById('drillLevelText').innerText = 
        App.drillState.level === 1 ? 'Agency View' : 'Sub-Agency View';
      
      // Update hint based on level
      if (App.drillState.level === 1) {
        hint.style.display = 'flex';
        hint.innerHTML = `
          <i class="fas fa-layer-group"></i>
          <span>Click a <strong>sub-agency</strong> in the panel below or in the chart to see vendor breakdown</span>
        `;
        // Show sub-agency panel
        App.renderSubAgencyPanel();
      } else if (App.drillState.level === 2) {
        hint.style.display = 'flex';
        hint.innerHTML = `
          <i class="fas fa-check-circle" style="color: var(--success)"></i>
          <span>Viewing vendor breakdown for <strong>${Utils.trunc(App.drillState.currentSubAgency, 30)}</strong></span>
        `;
        subagencyPanel.style.display = 'none';
      }
    }
  },

  renderSubAgencyPanel() {
    const panel = document.getElementById('subagencyPanel');
    const list = document.getElementById('subagencyList');
    
    if (!App.drillState.currentAgency) {
      panel.style.display = 'none';
      return;
    }
    
    // Get all contracts for this agency
    const agencyContracts = App.searchData.raw.filter(
      d => d['Awarding Agency'] === App.drillState.currentAgency
    );
    
    // Group by sub-agency
    const subAgencyMap = {};
    agencyContracts.forEach(c => {
      const subAgency = c['Awarding Sub Agency'] || 'Unknown Sub-Agency';
      if (!subAgencyMap[subAgency]) {
        subAgencyMap[subAgency] = { amount: 0, count: 0 };
      }
      subAgencyMap[subAgency].amount += c['Award Amount'] || 0;
      subAgencyMap[subAgency].count++;
    });
    
    // Convert to sorted array
    const subAgencies = Object.entries(subAgencyMap)
      .map(([name, data]) => ({ name, ...data }))
      .sort((a, b) => b.amount - a.amount);
    
    const totalAmount = subAgencies.reduce((sum, s) => sum + s.amount, 0);
    const maxAmount = subAgencies[0]?.amount || 1;
    
    // Update header
    document.getElementById('subagencyParentName').innerText = Utils.trunc(App.drillState.currentAgency, 40);
    document.getElementById('subagencyParentType').innerText = 'Parent Agency';
    document.getElementById('subagencyTotalAmount').innerText = Utils.money(totalAmount);
    document.getElementById('subagencyCount').innerText = subAgencies.length;
    
    // Render list
    if (subAgencies.length === 0) {
      list.innerHTML = `
        <div class="empty-drill-state">
          <i class="fas fa-inbox"></i>
          <p>No sub-agency data available</p>
          <p style="font-size: 0.8rem;">This agency may not have reported sub-agency information</p>
        </div>
      `;
    } else {
      list.innerHTML = subAgencies.map((sub, idx) => {
        const barWidth = (sub.amount / maxAmount) * 100;
        const isTop3 = idx < 3;
        
        return `
          <div class="subagency-item" onclick="App.drillToSubAgency('${sub.name.replace(/'/g, "\\'")}')">
            <div class="subagency-item-left">
              <div class="subagency-rank ${isTop3 ? 'top-3' : ''}">${idx + 1}</div>
              <div class="subagency-info">
                <div class="subagency-name">${sub.name}</div>
                <div class="subagency-contracts">${sub.count} contract${sub.count !== 1 ? 's' : ''}</div>
              </div>
            </div>
            <div class="subagency-item-right">
              <div class="subagency-bar-container">
                <div class="subagency-bar" style="width: ${barWidth}%"></div>
              </div>
              <div class="subagency-amount">${Utils.money(sub.amount)}</div>
              <i class="fas fa-chevron-right subagency-drill-icon"></i>
            </div>
          </div>
        `;
      }).join('');
    }
    
    panel.style.display = 'block';
  },

  drillToAgency(agencyName) {
    // If clicking the same agency, reset
    if (App.drillState.currentAgency === agencyName && App.drillState.level === 1) {
      App.resetDrill();
      return;
    }
    
    App.drillState.level = 1;
    App.drillState.currentAgency = agencyName;
    App.drillState.currentSubAgency = null;
    App.drillState.path = [{ type: 'agency', name: agencyName }];
    
    // Filter to this agency's contracts
    App.searchData.active = App.searchData.raw.filter(
      d => d['Awarding Agency'] === agencyName
    );
    App.searchData.filter = agencyName;
    
    App.updateSearchDashboard();
    App.renderSankey();
  },

  drillToSubAgency(subAgencyName) {
    // If clicking the same sub-agency, go back to agency level
    if (App.drillState.currentSubAgency === subAgencyName && App.drillState.level === 2) {
      App.drillToAgency(App.drillState.currentAgency);
      return;
    }
    
    App.drillState.level = 2;
    App.drillState.currentSubAgency = subAgencyName;
    App.drillState.path = [
      { type: 'agency', name: App.drillState.currentAgency },
      { type: 'subagency', name: subAgencyName }
    ];
    
    // Filter to this sub-agency's contracts
    App.searchData.active = App.searchData.raw.filter(
      d => d['Awarding Agency'] === App.drillState.currentAgency &&
           d['Awarding Sub Agency'] === subAgencyName
    );
    App.searchData.filter = subAgencyName;
    
    App.updateSearchDashboard();
    App.renderSankey();
  },

  drillToLevel(level) {
    if (level === 1 && App.drillState.path[0]) {
      App.drillToAgency(App.drillState.path[0].name);
    } else {
      App.resetDrill();
    }
  },

  // ==================== Enhanced drillDown (replaces old) ====================
  drillDown(name) {
    const data = App.searchData.raw;
    
    // Check if it's an agency
    const isAgency = data.some(d => d['Awarding Agency'] === name);
    
    // Check if it's a sub-agency
    const isSubAgency = data.some(d => d['Awarding Sub Agency'] === name);
    
    // Check if it's a vendor
    const isVendor = data.some(d => d['Recipient Name'] === name);
    
    if (isAgency && App.drillState.level === 0) {
      // Drill into agency
      App.drillToAgency(name);
    } else if (isSubAgency && App.drillState.level === 1) {
      // Drill into sub-agency
      App.drillToSubAgency(name);
    } else if (isVendor) {
      // Filter to vendor (terminal state)
      if (App.searchData.filter === name) {
        // Clicking same vendor - go back one level
        if (App.drillState.level === 2) {
          App.drillToSubAgency(App.drillState.currentSubAgency);
        } else if (App.drillState.level === 1) {
          App.drillToAgency(App.drillState.currentAgency);
        } else {
          App.resetDrill();
        }
        return;
      }
      App.searchData.active = App.searchData.active.filter(d => d['Recipient Name'] === name);
      App.searchData.filter = name;
      App.updateSearchDashboard();
      App.renderSankey();
    } else if (isAgency && App.drillState.level > 0) {
      App.drillToAgency(name);
    } else {
      if (App.searchData.filter === name) { App.clearFilter(); return; }
      App.searchData.filter = name;
      App.searchData.active = App.searchData.raw.filter(d => d['Awarding Agency'] === name || d['Recipient Name'] === name);
      App.updateSearchDashboard();
      App.renderSankey();
    }
  },

  clearFilter() {
    if (App.drillState.level > 0) {
      App.resetDrill();
    } else {
      App.searchData.filter = null;
      App.searchData.active = App.searchData.raw;
      App.updateSearchDashboard();
      App.renderSankey();
    }
  },

renderSankey() {
  const container = document.getElementById('chartContainer');
  container.innerHTML = '';
  const data = App.searchData.active;
  
  if (data.length === 0) { 
    container.innerHTML = '<div style="text-align:center; padding:4rem; color:#666">No data to display</div>'; 
    return; 
  }
  
  // Initialize SVG container
  container.innerHTML = '<svg id="sankeySvg"></svg>';
  
  const flowMap = {};

  // 1. Data Aggregation logic
  if (App.drillState.level === 0) {
    data.forEach(d => { 
      if (d['Award Amount'] > 0) { 
        const src = d['Awarding Agency'] || 'Unknown Agency'; 
        const tgt = d['Recipient Name'] || 'Unknown Vendor'; 
        const k = src + "|||" + tgt; 
        flowMap[k] = (flowMap[k] || 0) + d['Award Amount']; 
      } 
    });
  } else {
    data.forEach(d => { 
      if (d['Award Amount'] > 0) { 
        const src = d['Awarding Sub Agency'] || 'Unknown Sub-Agency'; 
        const tgt = d['Recipient Name'] || 'Unknown Vendor'; 
        const k = src + "|||" + tgt; 
        flowMap[k] = (flowMap[k] || 0) + d['Award Amount']; 
      } 
    });
  }

  // 2. Node & Link Preparation
  let nodesSet = new Set(); 
  let links = [];
  // Use a higher limit for drill-down views to see more detail
  const limit = App.drillState.level > 0 ? 50 : 25; 
  
  const sortedFlows = Object.entries(flowMap)
    .sort((a,b) => b[1] - a[1])
    .slice(0, limit);
    
  sortedFlows.forEach(([k, val]) => { 
    const [src, tgt] = k.split("|||"); 
    nodesSet.add(src); 
    nodesSet.add(tgt); 
    links.push({source: src, target: tgt, value: val}); 
  });

  const nodes = Array.from(nodesSet).map(n => ({name: n}));
  const nodeMap = new Map(nodes.map((n, i) => [n.name, i]));
  const d3Links = links.map(l => ({ 
    source: nodeMap.get(l.source), 
    target: nodeMap.get(l.target), 
    value: l.value 
  }));

  // 3. Dynamic Height Calculation (The Fix)
  const containerWidth = container.offsetWidth || 800;
  
  // Calculate dynamic height: ~40px per node in the densest column
  // This ensures that if you have 50 sub-agencies, the chart grows to ~2000px tall
  const estimatedNodesPerColumn = Math.ceil(nodes.length / 2);
  const minHeight = 500;
  const dynamicHeight = Math.max(minHeight, estimatedNodesPerColumn * 40);

  const svg = d3.select("#sankeySvg")
    .attr("width", containerWidth)
    .attr("height", dynamicHeight);

  const sankey = d3.sankey()
    .nodeId(d => d.index)
    .nodeWidth(20)
    .nodePadding(20) // Increased padding makes clicking easier
    .extent([[1, 1], [containerWidth - 1, dynamicHeight - 6]]);

  const {nodes: graphNodes, links: graphLinks} = sankey({ 
    nodes: nodes.map(d => Object.assign({}, d)), 
    links: d3Links.map(d => Object.assign({}, d)) 
  });

  // Helper to determine if a node is clickable/drillable
  const isDrillable = (nodeName) => {
    if (App.drillState.level === 0) return App.searchData.raw.some(d => d['Awarding Agency'] === nodeName);
    else if (App.drillState.level === 1) return App.searchData.raw.some(d => d['Awarding Sub Agency'] === nodeName);
    return false;
  };

  // 4. Render Rects (Nodes)
  svg.append("g")
    .selectAll("rect")
    .data(graphNodes)
    .join("rect")
    .attr("x", d => d.x0)
    .attr("y", d => d.y0)
    .attr("height", d => d.y1 - d.y0)
    .attr("width", d => d.x1 - d.x0)
    .attr("fill", d => Utils.getColor(d.name))
    .attr("opacity", d => { 
      if (App.searchData.filter && d.name !== App.searchData.filter) return 0.3; 
      return isDrillable(d.name) ? 1 : 0.8; 
    })
    .attr("rx", 2)
    .attr("stroke", d => isDrillable(d.name) ? 'var(--accent)' : 'none')
    .attr("stroke-width", d => isDrillable(d.name) ? 2 : 0)
    .style("cursor", "pointer")
    .on("click", (e, d) => App.drillDown(d.name))
    .on("mouseover", function(e, d) { 
      if (isDrillable(d.name)) { d3.select(this).attr("opacity", 1).attr("stroke-width", 3); } 
    })
    .on("mouseout", function(e, d) { 
      const baseOpacity = App.searchData.filter && d.name !== App.searchData.filter ? 0.3 : (isDrillable(d.name) ? 1 : 0.8); 
      d3.select(this).attr("opacity", baseOpacity).attr("stroke-width", isDrillable(d.name) ? 2 : 0); 
    })
    .append("title")
    .text(d => `${d.name}\n${Utils.money(d.value)}${isDrillable(d.name) ? '\n\nClick to drill down' : ''}`);

  // 5. Render Labels (Text)
  svg.append("g")
    .selectAll("text")
    .data(graphNodes)
    .join("text")
    .attr("x", d => d.x0 < containerWidth / 2 ? d.x1 + 6 : d.x0 - 6)
    .attr("y", d => (d.y1 + d.y0) / 2)
    .attr("dy", "0.35em")
    .attr("text-anchor", d => d.x0 < containerWidth / 2 ? "start" : "end")
    .text(d => { 
      // Truncate text logic
      const label = Utils.trunc(d.name, containerWidth > 600 ? 30 : 15); 
      return isDrillable(d.name) ? `▶ ${label}` : label; 
    })
    .attr("fill", d => isDrillable(d.name) ? 'var(--accent)' : '#fff')
    .style("font-size", "11px")
    .style("font-family", "Inter")
    .style("font-weight", d => isDrillable(d.name) ? "700" : "500")
    .style("cursor", "pointer")
    .style("text-shadow", "0 1px 2px black")
    .on("click", (e, d) => App.drillDown(d.name));

  // 6. Define Gradients
  const defs = svg.append("defs");
  graphLinks.forEach((l, i) => { 
    const gradient = defs.append("linearGradient")
      .attr("id", "grad" + i)
      .attr("gradientUnits", "userSpaceOnUse")
      .attr("x1", l.source.x1)
      .attr("x2", l.target.x0); 
    gradient.append("stop").attr("offset", "0%").attr("stop-color", Utils.getColor(l.source.name)); 
    gradient.append("stop").attr("offset", "100%").attr("stop-color", Utils.getColor(l.target.name)); 
  });

  // 7. Render Links (Paths)
  svg.append("g")
    .attr("fill", "none")
    .selectAll("path")
    .data(graphLinks)
    .join("path")
    .attr("d", d3.sankeyLinkHorizontal())
    .attr("stroke", (d, i) => "url(#grad" + i + ")")
    .attr("stroke-width", d => Math.max(1, d.width))
    .attr("stroke-opacity", 0.5)
    .style("mix-blend-mode", "screen")
    .on("mouseover", function() { d3.select(this).attr("stroke-opacity", 0.8); })
    .on("mouseout", function() { d3.select(this).attr("stroke-opacity", 0.5); });
},
  renderFeed() {
    const div = document.getElementById('feedGrid');
    const data = App.searchData.active;
    if(data.length === 0) { div.innerHTML = '<div style="text-align:center; padding:2rem; color:#666">No contracts found.</div>'; return; }
    div.innerHTML = data.map(c => {
      const internalId = c['generated_internal_id'];
      let url = '#';
      if (internalId) url = `https://www.usaspending.gov/award/${internalId}`;
      else if (c['Award ID']) url = `https://www.usaspending.gov/search/?hash=&filters=${encodeURIComponent(JSON.stringify({keyword: c['Award ID']}))}`;
      let metaTags = '';
      if (c['NAICS Code']) metaTags += `<span class="meta-tag naics" title="${c['NAICS Description'] || ''}">NAICS: ${c['NAICS Code']}</span>`;
      if (c['PSC Code']) metaTags += `<span class="meta-tag psc" title="${c['PSC Description'] || ''}">PSC: ${c['PSC Code']}</span>`;
      const subAgency = c['Awarding Sub Agency'];
      const agencyDisplay = subAgency && subAgency !== c['Awarding Agency'] ? `${Utils.trunc(c['Awarding Agency'], 20)} → ${Utils.trunc(subAgency, 20)}` : Utils.trunc(c['Awarding Agency'], 35);
      return `<div class="deal-card">
        <div class="deal-header"><span class="deal-agency">${agencyDisplay}</span><span class="deal-amount">${Utils.money(c['Award Amount'])}</span></div>
        <div class="deal-desc">${Utils.trunc(c['Description'], 100)}</div>
        <div class="deal-vendor">${c['Recipient Name']}</div>
        ${metaTags ? `<div class="deal-meta">${metaTags}</div>` : ''}
        <div class="deal-footer"><span class="deal-date">Start: ${Utils.date(c['Start Date'])}${c['End Date'] ? ' → ' + Utils.date(c['End Date']) : ''}</span><a href="${url}" target="_blank" class="action-btn">OPEN AWARD <i class="fas fa-external-link-alt"></i></a></div>
      </div>`;
    }).join('');
  },

  // ==================== FORECAST MODE ====================
  async runForecast(val) {
    const query = val || document.getElementById('mainSearchInput').value;
    if(!query) return;
    const isNewQuery = query !== App.currentQuery;
    if(isNewQuery) { App.searchData = { raw: [], active: [], filter: null, loaded: false }; App.forecastData = { spending: null, agencies: null, awards: null, analysis: null, loaded: false }; }
    const chartStatus = Chart.getChart("spendingChart"); if (chartStatus) chartStatus.destroy();
    App.currentQuery = query; App.mode = 'forecast';
    App.showLoader('CRUNCHING NUMBERS...', 'Applying Recency-Weighted Seasonality');
    try {
      const [spending, agencies, awards] = await Promise.all([API.getSpendingOverTime(query), API.getAgencyData(query), API.getAwardsForForecast(query)]);
      App.forecastData.spending = spending; App.forecastData.agencies = agencies; App.forecastData.awards = awards;
      App.forecastData.analysis = ForecastEngine.analyze(spending, awards, agencies);
      App.forecastData.loaded = true;
      App.updateURL(query, 'forecast'); App.transitionToApp(); App.setMode('forecast'); App.renderForecastDashboard();
    } catch(e) { console.error(e); alert("Error fetching forecast data."); }
    finally { App.hideLoader(); }
  },

  renderForecastDashboard() {
    const analysis = App.forecastData.analysis; const awards = App.forecastData.awards;
    if(!analysis) return;
    const curFY = Utils.getCurrentFY();
    document.getElementById('stat-baseline').innerText = Utils.money(analysis.baseline);
    const lastYearTotal = analysis.byFY[curFY - 1]; const lastYearSum = lastYearTotal ? Object.values(lastYearTotal).reduce((a,b)=>a+b,0) : 0;
    const subText = document.querySelector('#stat-baseline + .stat-sub');
    if(subText) { let growthHtml = ''; if(lastYearSum > 0) { const growth = ((analysis.baseline - lastYearSum) / lastYearSum) * 100; const color = growth >= 0 ? 'var(--success)' : 'var(--danger)'; const icon = growth >= 0 ? '▲' : '▼'; growthHtml = `<span style="color:${color}; margin-left:6px; font-weight:700;">${icon} ${Math.abs(growth).toFixed(1)}%</span>`; } subText.innerHTML = `FY${curFY} ${growthHtml}`; }
    document.getElementById('stat-market').innerText = analysis.marketStatus;
    document.getElementById('stat-hhi').innerText = `HHI: ${analysis.hhi}`;
    let peakQ=1, peakV=0; for(let q=1; q<=4; q++) if(analysis.indices[q]>peakV) { peakV=analysis.indices[q]; peakQ=q; }
    document.getElementById('stat-peak').innerText = `Q${peakQ}`;
    document.getElementById('stat-recompetes').innerText = analysis.recompetes.length;
    const topVendor = awards[0] ? awards[0]['Recipient Name'] : 'Unknown';
    document.getElementById('marketInsights').innerHTML = `<div class="insight-card"><div class="insight-label">Market Concentration</div><div class="insight-val" style="color:${analysis.hhi>2500?'var(--danger)':'var(--success)'}">${analysis.marketStatus}</div><div style="font-size:0.8rem; color:#666; margin-top:5px">HHI Score: ${analysis.hhi}</div></div><div class="insight-card"><div class="insight-label">Top Incumbent</div><div class="insight-val" style="font-size:0.9rem">${Utils.trunc(topVendor, 30)}</div></div>`;
    const tb = document.getElementById('forecastTableBody'); tb.innerHTML = '';
    analysis.forecasts.forEach(f => { const isUp = f.trend.includes('+'); let confColor = '#888'; if(f.confidence.label === 'High') confColor = 'var(--success)'; else if(f.confidence.label === 'Med') confColor = '#FDD835';
      tb.innerHTML += `<tr><td><b>${f.period}</b></td><td style="color:var(--accent); font-weight:700">${Utils.money(f.predicted)}</td><td style="color:#666">${Utils.money(f.histAvg)}</td><td><span class="trend-pill ${isUp?'trend-up':'trend-down'}">${isUp?'▲':'▼'} ${f.trend}%</span></td><td><div style="color:${confColor}; font-weight:700; line-height:1;">${f.confidence.label}</div><div style="font-size:0.65rem; color:#666; margin-top:2px;">${f.confidence.reason}</div></td></tr>`; });
    const strat = analysis.strategy; const stratSection = document.getElementById('strategySection');
    if(strat && stratSection) { stratSection.style.display = 'block'; const outlookElem = document.getElementById('strat-outlook'); outlookElem.innerText = strat.title; if(strat.title.includes("Growth")) outlookElem.style.color = "var(--success)"; else if(strat.title.includes("Softening")) outlookElem.style.color = "var(--danger)"; else outlookElem.style.color = "var(--accent)"; document.getElementById('strat-text').innerText = strat.text; document.getElementById('strat-action').innerText = strat.action; document.getElementById('matrix-bd').innerText = strat.matrix.bd; document.getElementById('matrix-strat').innerText = strat.matrix.strat; document.getElementById('matrix-pipe').innerText = strat.matrix.pipe; } else if (stratSection) { stratSection.style.display = 'none'; }
    const rl = document.getElementById('recompetesList');
    if(analysis.recompetes.length) { rl.innerHTML = `<div class="section-header"><div class="section-title-group"><i class="fas fa-exclamation-triangle" style="color:var(--danger)"></i><span class="section-title" style="color:var(--danger)">Recompete Opportunities</span></div></div>` + analysis.recompetes.map(r => { const internalId = r['generated_internal_id']; let awardUrl = '#'; if (internalId) awardUrl = `https://www.usaspending.gov/award/${internalId}`; else if (r['Award ID']) awardUrl = `https://www.usaspending.gov/search/?hash=&filters=${encodeURIComponent(JSON.stringify({keyword: r['Award ID']}))}`;
      return `<div class="deal-card" style="margin-bottom:1rem"><div class="deal-header"><span class="deal-agency">${Utils.trunc(r['Awarding Agency'], 40)}</span><span class="deal-amount">${Utils.money(r['Award Amount'])}</span></div><div class="deal-desc">${Utils.trunc(r['Description'], 80)}</div><div style="font-size:0.8rem; color:var(--danger); margin-bottom:0.5rem">Expires: ${Utils.date(r['End Date'])}</div><div style="font-size:0.8rem; color:#666; margin-bottom:0.75rem">${r['Recipient Name']}</div><a href="${awardUrl}" target="_blank" class="action-btn" style="display:inline-flex; width:auto;">VIEW AWARD <i class="fas fa-external-link-alt"></i></a></div>`; }).join(''); } else { rl.innerHTML = ''; }
    App.renderHistoricalChart(analysis.byFY);
  },

  renderHistoricalChart(byFY) {
    const ctx = document.getElementById('spendingChart').getContext('2d');
    const years = Object.keys(byFY).sort();
    const chartStatus = Chart.getChart("spendingChart"); if (chartStatus != undefined) chartStatus.destroy();
    new Chart(ctx, {
      type: 'bar',
      data: { labels: years.map(y=>`FY${y}`), datasets: [
        { label:'Q1', data:years.map(y=>byFY[y][1]||0), backgroundColor:'#958BB6' },
        { label:'Q2', data:years.map(y=>byFY[y][2]||0), backgroundColor:'#6F8A74' },
        { label:'Q3', data:years.map(y=>byFY[y][3]||0), backgroundColor:'#8FB6D0' },
        { label:'Q4', data:years.map(y=>byFY[y][4]||0), backgroundColor:'#C27E5C' }
      ]},
      options: { responsive:true, maintainAspectRatio:false, scales:{ x:{grid:{display:false}}, y:{grid:{color:'#333'}} }, plugins:{ legend:{labels:{color:'#888'}} } }
    });
  },

  showLoader(text, subtext) { document.getElementById('loaderText').innerText = text; document.getElementById('loaderSubtext').innerText = subtext || ''; document.getElementById('loader').style.display = 'flex'; },
  hideLoader() { document.getElementById('loader').style.display = 'none'; },

  transitionToApp() {
    const hero = document.getElementById('heroView');
    hero.classList.add('slide-up');
    document.getElementById('appView').style.display = 'block';
    document.getElementById('miniSearch').value = App.currentQuery;
    document.getElementById('dashboardContainer').classList.add('active');
    setTimeout(() => { hero.style.display = 'none'; hero.classList.add('hidden'); }, 500);
  },

  updateURL(query, mode) { const url = new URL(window.location); url.searchParams.set('q', query); url.searchParams.set('mode', mode); window.history.replaceState({}, '', url); },

  shareLink() {
    const url = new URL(window.location);
    url.searchParams.set('q', App.currentQuery);
    url.searchParams.set('mode', App.mode);
    navigator.clipboard.writeText(url.toString()).then(() => {
      const btn = document.querySelector('[onclick="App.shareLink()"]');
      const icon = btn.querySelector('i');
      icon.className = 'fas fa-check';
      btn.style.borderColor = 'var(--success)';
      btn.style.color = 'var(--success)';
      setTimeout(() => {
        icon.className = 'fas fa-link';
        btn.style.borderColor = '';
        btn.style.color = '';
      }, 2000);
    }).catch(() => {
      prompt('Copy this link:', url.toString());
    });
  },

  exportCSV() {
    const data = App.mode === 'search' ? App.searchData.active : (App.forecastData.awards || []);
    if (!data.length) return alert("No data to export");
    const headers = ['Recipient', 'Agency', 'Sub-Agency', 'Amount', 'Description', 'Start Date', 'End Date', 'Award ID', 'Award Link'];
    const rows = data.map(c => {
      const internalId = c['generated_internal_id']; let awardUrl = '';
      if (internalId) awardUrl = `https://www.usaspending.gov/award/${internalId}`;
      else if (c['Award ID']) awardUrl = `https://www.usaspending.gov/search/?hash=&filters=${encodeURIComponent(JSON.stringify({keyword: c['Award ID']}))}`;
      return [`"${(c['Recipient Name'] || '').replace(/"/g, '""')}"`, `"${(c['Awarding Agency'] || '').replace(/"/g, '""')}"`, `"${(c['Awarding Sub Agency'] || '').replace(/"/g, '""')}"`, c['Award Amount'] || 0, `"${(c['Description'] || '').replace(/"/g, '""')}"`, c['Start Date'] || '', c['End Date'] || '', c['Award ID'] || '', awardUrl];
    });
    const csvContent = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a"); link.setAttribute("href", url); link.setAttribute("download", `govhoo_${App.mode}_${App.currentQuery}.csv`);
    document.body.appendChild(link); link.click(); document.body.removeChild(link);
  }
};

App.init();
</script>
</body>
</html>