<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#000000">
  <title>Govhoo - Federal Contract Intelligence & Sales Planning</title>
  
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-sankey/0.12.3/d3-sankey.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-T343V4RFHV"></script>
  <script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-T343V4RFHV');
</script>
<style>
:root {
  --bg-app: #000000;
  --bg-card: #121212; 
  --bg-input: #1a1a1a;
  --border: #333333;
  --text-primary: #e6e6e6;
  --text-muted: #888888;
  
  /* Vintage/Elegant Terminal Theme */
  --accent: #D4C4A8;
  --accent-dim: rgba(212, 196, 168, 0.1);
  --link: #8DA0CB;
  --success: #66C2A5;
  --danger: #FB8072;
  
  /* Vintage Chart Palette */
  --q1-color: #958BB6; --q2-color: #6F8A74; --q3-color: #8FB6D0; --q4-color: #C27E5C;

  --safe-top: env(safe-area-inset-top, 20px);
  --safe-bottom: env(safe-area-inset-bottom, 20px);
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

body {
  margin: 0; padding: 0;
  font-family: 'Inter', sans-serif;
  background: var(--bg-app);
  color: var(--text-primary);
  min-height: 100vh;
  overflow-x: hidden;
}

/* --- Hero Section --- */
.hero-view {
  position: fixed; inset: 0; z-index: 200; 

  display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
  padding: 2rem; padding-top: max(8vh, var(--safe-top)); 
  transition: transform 0.5s cubic-bezier(0.16, 1, 0.3, 1);
  overflow-y: auto; 
}
.hero-view.slide-up { transform: translateY(-100%); }
.hero-view.hidden { display: none; }

.terminal-logo {
  font-family: 'JetBrains Mono', monospace; font-size: 2.5rem; font-weight: 700;
  margin-bottom: 0.5rem; color: var(--text-primary); letter-spacing: -1px; text-align: center;
}
.terminal-logo span { color: var(--accent); }

.hero-subtitle {
  color: var(--text-muted); margin-bottom: 2rem; text-align: center;
}

.search-box-container { 
  position: relative; z-index: 210; 
  width: 100%; max-width: 500px; margin-top: 1.5rem; 
}

.main-input {
  width: 100%; background: var(--bg-input); border: 1px solid var(--border);
  padding: 1.25rem 1rem; font-size: 1.1rem; color: white; border-radius: 4px;
  font-family: 'Inter', sans-serif; transition: border-color 0.2s; -webkit-appearance: none;
}
.main-input:focus { outline: none; border-color: var(--accent); background: #222; }

.btn-row { display: flex; gap: 0.75rem; margin-top: 1rem; }
.btn-primary, .btn-secondary {
  flex: 1; padding: 1rem;
  font-weight: 700; border: none; border-radius: 4px;
  font-size: 0.9rem; cursor: pointer; text-transform: uppercase; letter-spacing: 1px;
  display: flex; align-items: center; justify-content: center; gap: 0.5rem;
}
.btn-primary { background: var(--accent); color: #000; }
.btn-secondary { background: transparent; color: var(--accent); border: 1px solid var(--accent); }
.btn-primary:hover, .btn-secondary:hover { opacity: 0.9; }

.search-tips {
  margin-top: 1.5rem; width: 100%; max-width: 500px;
  background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border);
  border-radius: 4px; padding: 1rem;
  font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; color: var(--text-muted);
}
.tip-header {
  color: var(--accent); font-weight: 700; margin-bottom: 0.75rem;
  display: flex; align-items: center; gap: 0.5rem;
  text-transform: uppercase; letter-spacing: 1px;
}
.tip-row { display: flex; align-items: flex-start; gap: 0.75rem; margin-bottom: 0.6rem; line-height: 1.4; }
.cmd-hl { color: var(--text-primary); background: rgba(255, 255, 255, 0.1); padding: 2px 6px; border-radius: 2px; white-space: nowrap; }

/* --- App View --- */
.app-header {
  position: sticky; top: 0; z-index: 100;
  background: rgba(0,0,0,0.95); backdrop-filter: blur(10px);
  padding: 0.75rem 1rem; padding-top: max(0.75rem, var(--safe-top));
  border-bottom: 1px solid var(--border);
  display: flex; justify-content: space-between; align-items: center; gap: 1rem;
}
.header-left { display: flex; align-items: center; gap: 1rem; flex: 1; min-width: 0; }
.logo-btn { font-family: 'JetBrains Mono'; font-weight: 700; color: white; cursor: pointer; flex-shrink: 0; }
.logo-btn:hover { color: var(--accent); }

.mini-search {
  background: var(--bg-input); border: 1px solid var(--border);
  color: white; padding: 0.5rem 1rem; border-radius: 4px;
  font-size: 0.9rem; flex: 1; min-width: 0;
}
.mini-search:focus { outline: none; border-color: var(--accent); }

.header-actions { display: flex; gap: 0.5rem; flex-shrink: 0; }
.icon-btn {
  background: var(--bg-input); border: 1px solid var(--border); color: var(--text-muted);
  width: 36px; height: 36px; border-radius: 4px;
  display: flex; align-items: center; justify-content: center; cursor: pointer;
}
.icon-btn:hover { border-color: var(--accent); color: var(--accent); }
.icon-btn.active { background: var(--accent-dim); color: var(--accent); border-color: var(--accent); }

/* --- Dashboard --- */
.dashboard-container {
  padding: 1rem; padding-bottom: calc(2rem + var(--safe-bottom));
  max-width: 1400px; margin: 0 auto;
  display: none;
}
.dashboard-container.active { display: block; animation: fadeIn 0.8s forwards; }
@keyframes fadeIn { to { opacity: 1; } }

/* Mode Toggle */
.mode-toggle {
  display: flex; gap: 0.5rem; margin-bottom: 1.5rem;
  background: var(--bg-card); padding: 0.5rem; border-radius: 4px; border: 1px solid var(--border);
}
.mode-btn {
  flex: 1; padding: 0.75rem; background: transparent; border: none;
  color: var(--text-muted); font-family: 'JetBrains Mono'; font-size: 0.85rem;
  cursor: pointer; border-radius: 4px; transition: all 0.2s;
  display: flex; align-items: center; justify-content: center; gap: 0.5rem;
}
.mode-btn.active { background: var(--accent-dim); color: var(--accent); }
.mode-btn:hover:not(.active) { color: var(--text-primary); }

/* Stats Row */
.stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem; }
.stat-item {
  background: var(--bg-card); padding: 1rem; border-radius: 4px;
  border: 1px solid var(--border); text-align: center;
}
.stat-label { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.5rem; }
.stat-val { font-size: 1.25rem; font-weight: 700; font-family: 'JetBrains Mono'; color: white; }
.stat-sub { font-size: 0.7rem; color: var(--success); margin-top: 4px; }
.stat-sub.neutral { color: var(--text-muted); }

/* Section Headers */
.section-header {
  display: flex; align-items: center; justify-content: space-between;
  gap: 0.5rem; margin: 2rem 0 1rem 0;
  border-bottom: 1px solid var(--border); padding-bottom: 0.5rem; flex-wrap: wrap;
}
.section-title-group { display: flex; align-items: center; gap: 0.5rem; }
.section-title {
  font-family: 'JetBrains Mono', monospace; font-size: 0.9rem; font-weight: 700;
  color: var(--accent); text-transform: uppercase; letter-spacing: 1px;
}

.header-controls { display: flex; gap: 0.75rem; align-items: center; }
.time-badge {
  font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; color: var(--text-muted);
  border: 1px solid var(--border); padding: 4px 8px; border-radius: 4px;
}

.filter-badge {
  display: none; background: var(--accent-dim); color: var(--accent);
  border: 1px solid var(--accent); padding: 4px 8px; border-radius: 4px;
  font-size: 0.7rem; font-family: 'JetBrains Mono', monospace;
  cursor: pointer; align-items: center; gap: 6px;
}
.filter-badge:hover { background: rgba(212, 196, 168, 0.2); }

/* Chart Containers */
.chart-wrapper {
  background: var(--bg-card); border: 1px solid var(--border);
  border-radius: 4px; padding: 1rem; width: 100%; 
  overflow-x: auto; 
  overflow-y: visible; 
}
.chart-container { 
  width: 100%; 
  min-height: 500px; 
  height: auto;      
  display: block;    
}

/* Feed Grid */
.feed-grid { display: flex; flex-direction: column; gap: 1rem; }
.deal-card {
  background: var(--bg-card); border: 1px solid var(--border);
  border-radius: 4px; padding: 1.25rem; transition: transform 0.1s;
}
.deal-card:active { transform: scale(0.99); }
.deal-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem; }
.deal-agency { 
  font-size: 0.75rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase;
  background: rgba(255,255,255,0.05); padding: 2px 6px; border-radius: 4px;
}
.deal-amount { font-family: 'JetBrains Mono', monospace; color: var(--accent); font-weight: 700; font-size: 1rem; }
.deal-desc { font-size: 1rem; font-weight: 600; margin-bottom: 0.5rem; line-height: 1.4; color: white; }
.deal-vendor { font-size: 0.85rem; color: #8DA0CB; margin-bottom: 0.75rem; font-family: 'JetBrains Mono', monospace; }

.deal-meta { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem; }
.meta-tag {
  font-size: 0.65rem; font-family: 'JetBrains Mono', monospace;
  padding: 3px 8px; border-radius: 3px;
  background: rgba(255,255,255,0.05); color: var(--text-muted); border: 1px solid var(--border);
}
.meta-tag.naics { background: rgba(102, 194, 165, 0.15); border-color: rgba(102, 194, 165, 0.3); color: #66C2A5; }
.meta-tag.psc { background: rgba(141, 160, 203, 0.15); border-color: rgba(141, 160, 203, 0.3); color: #8DA0CB; }

.deal-footer {
  display: flex; justify-content: space-between; align-items: center;
  padding-top: 1rem; border-top: 1px solid #222;
}
.deal-date { font-size: 0.75rem; color: var(--text-muted); }
.action-btn {
  background: var(--bg-input); color: var(--accent); text-decoration: none;
  padding: 0.5rem 1rem; border-radius: 4px; font-size: 0.8rem; font-weight: 600;
  border: 1px solid var(--border); display: flex; align-items: center; gap: 6px;
}
.action-btn:hover { border-color: var(--accent); background: var(--accent-dim); }

/* Forecast Tables */
.forecast-table-wrapper { background: var(--bg-card); border: 1px solid var(--border); overflow-x: auto; border-radius: 4px; }
.forecast-table { width: 100%; border-collapse: collapse; font-family: 'JetBrains Mono'; font-size: 0.8rem; }
.forecast-table th { text-align: left; padding: 1rem; color: var(--text-muted); border-bottom: 1px solid var(--border); }
.forecast-table td { padding: 1rem; border-bottom: 1px solid var(--border); color: var(--text-primary); }
.trend-pill { padding: 2px 6px; border-radius: 2px; font-size: 0.7rem; font-weight: 700; }
.trend-up { color: var(--success); background: rgba(102, 194, 165, 0.1); }
.trend-down { color: var(--danger); background: rgba(251, 128, 114, 0.1); }

/* Insight Grid */
.insight-grid { 
  display: grid; 
  grid-template-columns: repeat(3, 1fr);
  gap: 1rem; 
  margin-bottom: 2rem; 
}
.insight-card { background: var(--bg-card); border: 1px solid var(--border); padding: 1rem; border-radius: 4px; }
.insight-val { font-size: 1.1rem; color: var(--text-primary); font-weight: 700; font-family: 'JetBrains Mono'; }
.insight-label { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.5rem; }

/* View Sections */
.view-section { display: none; }
.view-section.active { display: block; }

/* Loader */
.loader {
  position: fixed; inset: 0; z-index: 300;
  background: rgba(0,0,0,0.9);
  display: none; flex-direction: column; align-items: center; justify-content: center;
}
.spinner { width: 40px; height: 40px; border: 2px solid #333; border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }

/* Methodology Explainer */
.methodology-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 1.5rem;
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 1.5rem;
}
.method-item {
  padding-bottom: 1rem;
  border-bottom: 1px solid var(--border);
}
.method-item:nth-last-child(-n+2) {
  border-bottom: none;
  padding-bottom: 0;
}
.method-title {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.85rem;
  font-weight: 700;
  color: var(--accent);
  margin-bottom: 0.5rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}
.method-title i {
  font-size: 0.75rem;
  opacity: 0.7;
}
.method-desc {
  font-size: 0.8rem;
  color: var(--text-muted);
  line-height: 1.5;
}
.method-desc code {
  background: rgba(255,255,255,0.1);
  padding: 2px 6px;
  border-radius: 3px;
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.75rem;
  color: var(--text-primary);
}
.method-desc strong {
  color: var(--text-primary);
}

/* ========================================
   Drill-Down & Sub-Agency Styles
   ======================================== */

.drill-breadcrumb {
  display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1rem;
  background: linear-gradient(90deg, rgba(212, 196, 168, 0.1), transparent);
  border: 1px solid var(--border); border-radius: 4px; margin-bottom: 1rem;
  font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; overflow-x: auto; white-space: nowrap;
}
.breadcrumb-item {
  display: flex; align-items: center; gap: 0.5rem; color: var(--text-muted); cursor: pointer;
  padding: 4px 8px; border-radius: 4px; transition: all 0.2s;
}
.breadcrumb-item:hover { background: rgba(255,255,255,0.05); color: var(--accent); }
.breadcrumb-item.active { background: var(--accent-dim); color: var(--accent); cursor: default; }
.breadcrumb-separator { color: var(--border); font-size: 0.7rem; }
.breadcrumb-icon { font-size: 0.75rem; }

.drill-hint {
  display: flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.5rem;
  background: rgba(212, 196, 168, 0.05); border: 1px dashed var(--border);
  border-radius: 4px; margin-top: 0.5rem; font-size: 0.75rem; color: var(--text-muted);
}
.drill-hint i { color: var(--accent); }

.subagency-panel {
  background: var(--bg-card); border: 1px solid var(--border); border-radius: 4px;
  margin-top: 1.5rem; overflow: hidden;
}
.subagency-header {
  display: flex; align-items: center; justify-content: space-between; padding: 1rem;
  background: linear-gradient(90deg, rgba(212, 196, 168, 0.08), transparent); border-bottom: 1px solid var(--border);
}
.subagency-header-left { display: flex; align-items: center; gap: 0.75rem; }
.subagency-header-icon {
  width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;
  background: var(--accent-dim); border: 1px solid var(--accent); border-radius: 4px; color: var(--accent);
}
.subagency-header-text h3 {
  margin: 0; font-family: 'JetBrains Mono', monospace; font-size: 0.9rem;
  color: var(--text-primary); font-weight: 600;
}
.subagency-header-text span { font-size: 0.75rem; color: var(--text-muted); }
.subagency-stats { display: flex; gap: 1.5rem; font-family: 'JetBrains Mono', monospace; }
.subagency-stat { text-align: right; }
.subagency-stat-val { font-size: 1rem; font-weight: 700; color: var(--accent); }
.subagency-stat-label { font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase; }

.subagency-list { max-height: 400px; overflow-y: auto; }
.subagency-item {
  display: flex; align-items: center; justify-content: space-between; padding: 1rem;
  border-bottom: 1px solid var(--border); cursor: pointer; transition: all 0.15s;
}
.subagency-item:hover { background: rgba(255,255,255,0.02); }
.subagency-item:last-child { border-bottom: none; }
.subagency-item-left { display: flex; align-items: center; gap: 1rem; flex: 1; min-width: 0; }
.subagency-rank {
  width: 28px; height: 28px; display: flex; align-items: center; justify-content: center;
  background: rgba(255,255,255,0.05); border-radius: 4px; font-family: 'JetBrains Mono', monospace;
  font-size: 0.75rem; color: var(--text-muted); flex-shrink: 0;
}
.subagency-rank.top-3 { background: var(--accent-dim); color: var(--accent); border: 1px solid rgba(212, 196, 168, 0.3); }
.subagency-info { flex: 1; min-width: 0; }
.subagency-name { font-size: 0.9rem; color: var(--text-primary); font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.subagency-contracts { font-size: 0.75rem; color: var(--text-muted); margin-top: 2px; }
.subagency-item-right { display: flex; align-items: center; gap: 1rem; flex-shrink: 0; }
.subagency-bar-container {
  width: 120px; height: 8px; background: rgba(255,255,255,0.05); border-radius: 4px; overflow: hidden;
}
.subagency-bar {
  height: 100%; background: linear-gradient(90deg, var(--accent), rgba(212, 196, 168, 0.5));
  border-radius: 4px; transition: width 0.3s ease;
}
.subagency-amount {
  font-family: 'JetBrains Mono', monospace; font-size: 0.9rem; font-weight: 700;
  color: var(--accent); min-width: 80px; text-align: right;
}
.subagency-drill-icon {
  color: var(--text-muted); font-size: 0.8rem; opacity: 0; transition: all 0.15s;
}
.subagency-item:hover .subagency-drill-icon { opacity: 1; color: var(--accent); transform: translateX(2px); }
.drill-level-indicator {
  display: inline-flex; align-items: center; gap: 0.25rem; padding: 2px 6px;
  background: rgba(102, 194, 165, 0.1); border: 1px solid rgba(102, 194, 165, 0.3);
  border-radius: 4px; font-size: 0.65rem; color: var(--success); margin-left: 0.5rem;
}
.node-drillable { cursor: pointer; }
.node-drillable:hover { filter: brightness(1.2); }
.empty-drill-state { text-align: center; padding: 3rem 2rem; color: var(--text-muted); }
.empty-drill-state i { font-size: 2rem; color: var(--border); margin-bottom: 1rem; }
.empty-drill-state p { margin: 0.5rem 0; }

/* ========================================
   Sales Plan & Channel Styles
   ======================================== */
.sales-plan-card {
  background: linear-gradient(135deg, rgba(212, 196, 168, 0.15) 0%, rgba(212, 196, 168, 0.05) 100%);
  border: 1px solid var(--accent);
  border-radius: 4px;
  padding: 1rem;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
}
.sales-plan-card:hover {
  transform: translateY(-4px); box-shadow: 0 8px 30px rgba(212, 196, 168, 0.4);
  border-color: var(--accent); background: linear-gradient(135deg, rgba(212, 196, 168, 0.25) 0%, rgba(212, 196, 168, 0.1) 100%);
}
.sales-plan-card-icon { font-size: 1.5rem; color: var(--accent); margin-bottom: 0.5rem; }
.sales-plan-card-title { font-size: 0.85rem; font-weight: 700; color: var(--accent); margin-bottom: 0.25rem; text-transform: uppercase; letter-spacing: 1px; }
.sales-plan-card-subtitle { font-size: 0.85rem; color: var(--text-primary); line-height: 1.4; margin-bottom: 0.75rem; }
.sales-plan-card-action { display: inline-flex; align-items: center; gap: 0.5rem; font-size: 0.75rem; color: var(--accent); text-transform: uppercase; letter-spacing: 1px; font-weight: 600; }

.channel-marking-modal {
  position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
  background: rgba(0, 0, 0, 0);
  z-index: 500; padding: 2rem; overflow-y: auto;
  display: flex; align-items: flex-start; justify-content: center;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.25s ease, background 0.25s ease, visibility 0.25s;
}
.channel-marking-modal.active { 
  opacity: 1;
  visibility: visible;
  background: rgba(0, 0, 0, 0.9);
}
.channel-modal-content { 
  background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; 
  max-width: 800px; width: 100%; margin: 2rem auto;
  transform: translateY(-20px) scale(0.98);
  transition: transform 0.25s ease-out;
}
.channel-marking-modal.active .channel-modal-content {
  transform: translateY(0) scale(1);
}
.channel-modal-header { padding: 1.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
.channel-modal-title { font-size: 1.3rem; font-weight: 700; color: var(--accent); font-family: 'JetBrains Mono', monospace; }
.channel-modal-close {
  background: transparent; border: none; color: var(--text-muted); font-size: 1.5rem; cursor: pointer;
  width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 4px;
}
.channel-modal-close:hover { background: rgba(255, 255, 255, 0.05); color: var(--accent); }
.channel-modal-body { padding: 1.5rem; max-height: 60vh; overflow-y: auto; }
.channel-explanation {
  background: rgba(212, 196, 168, 0.1); border-left: 3px solid var(--accent); padding: 1rem;
  margin-bottom: 1.5rem; font-size: 0.9rem; color: var(--text-primary); line-height: 1.6;
}
.vendor-list-item {
  display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 1rem;
  border: 1px solid var(--border); border-radius: 4px; margin-bottom: 0.5rem; transition: all 0.2s;
}
.vendor-list-item:hover { background: rgba(255, 255, 255, 0.02); border-color: var(--accent); }
.vendor-info { flex: 1; min-width: 0; }
.vendor-name { font-weight: 600; color: var(--text-primary); margin-bottom: 0.25rem; }
.vendor-stats { font-size: 0.75rem; color: var(--text-muted); }
.vendor-toggle { display: flex; align-items: center; gap: 0.5rem; }
.toggle-switch { position: relative; width: 50px; height: 26px; background: #333; border-radius: 13px; cursor: pointer; transition: background 0.3s; }
.toggle-switch.active { background: var(--accent); }
.toggle-slider {
  position: absolute; top: 3px; left: 3px; width: 20px; height: 20px;
  background: white; border-radius: 50%; transition: transform 0.3s;
}
.toggle-switch.active .toggle-slider { transform: translateX(24px); }
.toggle-label { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; min-width: 80px; }
.toggle-switch.active + .toggle-label { color: var(--accent); font-weight: 600; }
.channel-modal-footer { padding: 1.5rem; border-top: 1px solid var(--border); display: flex; gap: 1rem; justify-content: flex-end; }
.modal-btn {
  padding: 0.75rem 1.5rem; border-radius: 4px; font-weight: 600; cursor: pointer;
  transition: all 0.2s; text-transform: uppercase; letter-spacing: 1px; font-size: 0.85rem;
}
.modal-btn-cancel { background: transparent; border: 1px solid var(--border); color: var(--text-muted); }
.modal-btn-cancel:hover { border-color: var(--accent); color: var(--accent); }
.modal-btn-primary { background: var(--accent); border: none; color: #000; }
.modal-btn-primary:hover { opacity: 0.9; transform: translateY(-1px); }
.channel-link {
  display: inline-flex; align-items: center; gap: 0.25rem; font-size: 0.75rem; color: var(--text-muted);
  margin-top: 0.5rem; cursor: pointer; text-decoration: underline;
}
.channel-link:hover { color: var(--accent); }

@media (max-width: 900px) { .insight-grid { grid-template-columns: 1fr; } }
@media (max-width: 768px) {
  .methodology-card { grid-template-columns: 1fr; }
  .method-item { border-bottom: 1px solid var(--border); padding-bottom: 1rem; }
  .method-item:last-child { border-bottom: none; padding-bottom: 0; }
  .subagency-bar-container { display: none; }
  .subagency-stats { flex-direction: column; gap: 0.5rem; }
  .subagency-stat { text-align: left; }
  .stats-row { grid-template-columns: 1fr 1fr; }
  .btn-row { flex-direction: column; }
}
@media (max-width: 600px) {
  .stats-row { grid-template-columns: 1fr; gap: 0.5rem; }
  .stat-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 1rem; }
  .stat-label { margin-bottom: 0; }
  .chart-container { height: 400px; min-width: 600px; }
  .chart-wrapper { overflow-x: auto; }
  .mode-toggle { flex-direction: column; }
  
  /* Modal mobile styles */
  .channel-marking-modal { padding: 0; }
  .channel-modal-content {
    margin: 0;
    border-radius: 0;
    max-height: 100vh;
    height: 100vh;
    max-width: 100%;
  }
  .channel-modal-body { max-height: calc(100vh - 180px); }
  .channel-modal-footer { 
    flex-wrap: wrap; 
    gap: 0.5rem;
    padding: 1rem;
  }
  .channel-modal-footer .modal-btn {
    flex: 1 1 auto;
    min-width: 120px;
    padding: 0.6rem 1rem;
    font-size: 0.75rem;
  }
  /* Stack the step selectors on mobile */
  .step-grid {
    grid-template-columns: 1fr !important;
  }
  .ai-link-btn { padding: 0.75rem 0.25rem; font-size: 0.65rem; }
}
.chart-wrapper::-webkit-scrollbar { height: 8px; width: 8px; }
.chart-wrapper::-webkit-scrollbar-track { background: var(--bg-card); border-radius: 4px; }
.chart-wrapper::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; border: 1px solid var(--bg-card); }
.chart-wrapper::-webkit-scrollbar-thumb:hover { background: var(--accent); }
/* ==================== MODAL UX IMPROVEMENTS ==================== */

/* Intent Banner */
#spIntentBanner {
  display: none;
  background: rgba(255, 255, 255, 0.02);
  border-bottom: 1px solid var(--border);
  padding: 1rem 1.5rem;
}

.intent-banner-content {
  display: flex;
  align-items: flex-start;
  gap: 0.75rem;
}

.intent-banner-icon {
  font-size: 1.25rem;
  color: var(--accent);
  opacity: 0.9;
  width: 24px;
  text-align: center;
  flex-shrink: 0;
}

.intent-banner-text {
  flex: 1;
}

.intent-banner-title {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.7rem;
  font-weight: 700;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 1.5px;
  margin-bottom: 0.25rem;
}

.intent-banner-desc {
  font-size: 0.95rem;
  color: var(--text-primary);
  margin-bottom: 0.5rem;
  font-weight: 500;
}

.intent-banner-focus {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 0.4rem;
}

.focus-label {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.6rem;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.focus-tag {
  font-size: 0.65rem;
  background: transparent;
  border: none;
  color: var(--text-muted);
  padding: 0;
}

.focus-tag::before {
  content: '•';
  margin-right: 0.35rem;
  color: var(--accent);
}

.intent-change-btn {
  background: var(--bg-input);
  border: 1px solid var(--border);
  color: var(--accent);
  padding: 6px 12px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 0.7rem;
  font-family: 'JetBrains Mono', monospace;
  text-transform: uppercase;
  transition: all 0.2s;
}

.intent-change-btn:hover {
  border-color: var(--accent);
  background: var(--accent-dim);
}

/* Success Modal AI Buttons */
.ai-link-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  padding: 0.75rem 1rem;
  border-radius: 4px;
  color: white;
  text-decoration: none;
  font-family: 'Inter', sans-serif;
  font-size: 0.8rem;
  font-weight: 600;
  border: none;
  transition: transform 0.1s, opacity 0.2s;
}

.ai-link-btn:hover {
  transform: translateY(-1px);
  opacity: 0.9;
}

.ai-link-btn svg {
  width: 18px;
  height: 18px;
  flex-shrink: 0;
}

/* Brand colors */
.ai-link-btn.claude { background: #D97706; }
.ai-link-btn.chatgpt { background: #10A37F; }
.ai-link-btn.gemini { background: #4285F4; }

/* Modal Content Updates for scannability */
#copySuccessModal .channel-modal-content {
  border: 1px solid var(--accent);
  box-shadow: 0 0 30px rgba(0,0,0,0.5);
}

#copySuccessModal kbd {
  background: var(--bg-app);
  border: 1px solid var(--border);
  color: var(--accent);
  font-family: 'JetBrains Mono', monospace;
  padding: 2px 4px;
  border-radius: 3px;
}
</style>
</head>
<body>

<div id="heroView" class="hero-view">
  <div class="terminal-logo"><span>>_</span>Govhoo</div>
  <p class="hero-subtitle">Historical-based Sales Forecasting</p>
  
  <div class="search-box-container">
    <input type="text" id="mainSearchInput" class="main-input" placeholder="Search keywords, company, or agency..." autocomplete="off">
    <div class="btn-row">
      <button id="searchBtn" class="btn-primary">
        <i class="fas fa-search"></i> SEARCH
      </button>
      <button id="forecastBtn" class="btn-secondary">
        <i class="fas fa-chart-line"></i> FORECAST
      </button>
    </div>
  </div>

  <div class="search-tips">
    <div class="tip-header"><i class="fas fa-terminal"></i> SEARCH_TIPS</div>
    <div class="tip-row"><span class="cmd-hl">cloud computing</span> <span>Search award descriptions, vendors, and agencies.</span></div>
    <div class="tip-row"><span class="cmd-hl">Company A, Company B</span> <span>Compare multiple competitors side-by-side.</span></div>
    <div class="tip-row">
      <span class="cmd-hl">Fuzzy Search</span>
      <span>Quotes are ignored. "Pizza" returns pizza contracts AND Pizzaro's Construction. ¯\_(ツ)_/¯</span>
    </div>
	<div class="tip-row"><span class="cmd-hl">Search Mode</span> <span>Drill down by Agency to see Award flow for past 12 months.</span></div>
 <div class="tip-row">
  <span class="cmd-hl">Forecast Mode</span> 
  <span>Estimates TAM using historical data. Features per-quarter outlier detection and volatility risk scoring.</span>
</div>
<div class="tip-row">
  <span class="cmd-hl">Sales Plan Prompt</span> 
  <span>Generates a downloadable prompt you can paste into your LLM of choice to produce a sales plan based on your search.</span>
</div>
	<div class="tip-row">
      <span class="cmd-hl">Questions or Requests?</span>
      <span>DM me on <a href="https://www.linkedin.com/in/markflournoy/" target="_blank" style="color: var(--accent); text-decoration: underline;">LinkedIn</a></span>
    </div>
	<div class="tip-row">
      <span class="cmd-hl">Data sourced live from USASpending.gov</span>
    </div>
  </div>
</div>

<div id="appView" style="display:none;">
  <header class="app-header">
    <div class="header-left">
      <span class="logo-btn" onclick="App.showHero()">>_Govhoo</span>
      <input type="text" id="miniSearch" class="mini-search" placeholder="New search...">
    </div>
    <div class="header-actions">
      <button class="icon-btn" id="toggleModeBtn" onclick="App.toggleMode()" title="Toggle Mode">
        <i class="fas fa-exchange-alt"></i>
      </button>
      <button class="icon-btn" onclick="App.shareLink(this)" title="Copy Share Link">
  <i class="fas fa-link"></i>
</button>

<button class="icon-btn" title="Export CSV" onclick="App.exportCSV(this)">
  <i class="fas fa-download"></i>
</button>
    </div>
  </header>

  <div id="dashboardContainer" class="dashboard-container">
    
    <div class="mode-toggle">
      <button class="mode-btn active" id="modeSearchBtn" onclick="App.setMode('search')">
        <i class="fas fa-project-diagram"></i> Agency Award Flow
      </button>
      <button class="mode-btn" id="modeForecastBtn" onclick="App.setMode('forecast')">
        <i class="fas fa-brain"></i> Annual Forecast (BETA)
      </button>
    </div>

    <div id="searchModeView" class="view-section active">
      <div class="stats-row" id="searchStats">
        <div class="stat-item">
          <div class="stat-label">TCV Awarded</div>
          <div class="stat-val" id="stat-vol">-</div>
          <div class="stat-sub neutral">Past 12 Months</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Contract Count</div>
          <div class="stat-val" id="stat-count">-</div>
          <div class="stat-sub neutral">Past 12 Months</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Prime Vendors</div>
          <div class="stat-val" id="stat-vendors">-</div>
          <div class="stat-sub neutral">Unique Recipients</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Agencies</div>
          <div class="stat-val" id="stat-agencies">-</div>
          <div class="stat-sub neutral">Awarding Agencies</div>
        </div>
      </div>

      <div id="drillBreadcrumb" class="drill-breadcrumb" style="display: none;">
        <div class="breadcrumb-item" onclick="App.resetDrill()">
          <i class="fas fa-globe breadcrumb-icon"></i>
          <span>All Agencies</span>
        </div>
      </div>

      <div class="section-header">
        <div class="section-title-group">
          <i class="fas fa-project-diagram" style="color:var(--accent)"></i>
          <span class="section-title">Award Flow</span>
          <span id="drillLevelBadge" class="drill-level-indicator" style="display:none;">
            <i class="fas fa-layer-group"></i>
            <span id="drillLevelText">Level 1</span>
          </span>
        </div>
        <div class="header-controls">
          <div id="filterBadge" class="filter-badge" onclick="App.clearFilter()">
            <span id="filterName">FILTER</span> <i class="fas fa-times"></i>
          </div>
          <div class="time-badge">PAST 12 MONTHS</div>
        </div>
      </div>
      <div class="chart-wrapper">
        <div id="chartContainer" class="chart-container"></div>
      </div>
      <div id="drillHint" class="drill-hint">
        <i class="fas fa-mouse-pointer"></i>
        <span>Click an <strong>agency bar</strong> to drill into sub-agencies</span>
      </div>

      <div id="subagencyPanel" class="subagency-panel" style="display: none;">
        <div class="subagency-header">
          <div class="subagency-header-left">
            <div class="subagency-header-icon">
              <i class="fas fa-building"></i>
            </div>
            <div class="subagency-header-text">
              <h3 id="subagencyParentName">Department of Defense</h3>
              <span id="subagencyParentType">Parent Agency</span>
            </div>
          </div>
          <div class="subagency-stats">
            <div class="subagency-stat">
              <div class="subagency-stat-val" id="subagencyTotalAmount">$0</div>
              <div class="subagency-stat-label">Total Value</div>
            </div>
            <div class="subagency-stat">
              <div class="subagency-stat-val" id="subagencyCount">0</div>
              <div class="subagency-stat-label">Sub-Agencies</div>
            </div>
          </div>
        </div>
        <div class="subagency-list" id="subagencyList">
          </div>
      </div>

      <div class="section-header">
        <div class="section-title-group">
          <i class="fas fa-list-ul" style="color:var(--accent)"></i>
          <span class="section-title">Contract Award Feed</span>
        </div>
      </div>
      <div id="feedGrid" class="feed-grid"></div>
    </div>

    <div id="forecastModeView" class="view-section">
      <div class="stats-row" id="forecastStats">
        <div class="stat-item">
          <div class="stat-label" style="color:var(--accent); font-weight:700;">Estimated TAM</div>
          <div class="stat-val" id="stat-baseline">-</div>
          <div class="stat-sub neutral">FY Projected Volume</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Market</div>
          <div class="stat-val" id="stat-market">-</div>
          <div class="stat-sub" id="stat-hhi">-</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Peak Season</div>
          <div class="stat-val" id="stat-peak">-</div>
          <div class="stat-sub neutral">Seasonal Index</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Recompetes</div>
          <div class="stat-val" id="stat-recompetes">-</div>
          <div class="stat-sub" style="color:var(--danger)">Expiring < 2Y</div>
        </div>
      </div>

      <div class="section-header">
        <div class="section-title-group">
          <i class="fas fa-brain" style="color:var(--accent)"></i>
          <span class="section-title">Intelligent Forecast</span>
        </div>
      </div>
      <div id="marketInsights" class="insight-grid"></div>

      <div class="forecast-table-wrapper">
        <table class="forecast-table">
          <thead>
            <tr>
              <th>Period</th>
              <th>Predicted</th>
              <th>Hist. Avg</th>
              <th>Trend</th>
              <th>Confidence</th>
            </tr>
          </thead>
          <tbody id="forecastTableBody"></tbody>
        </table>
      </div>
<div class="section-header" style="margin-top:2rem;">
        <div class="section-title-group">
          <i class="fas fa-chart-bar" style="color:var(--accent)"></i>
          <span class="section-title">Historical Performance</span>
        </div>
      </div>
      <div class="chart-wrapper chart-wrapper-sm">
        <canvas id="spendingChart"></canvas>
      </div>
      
<div id="strategySection" style="margin-top: 2rem; display:none;">
  <div class="section-header">
    <div class="section-title-group">
      <i class="fas fa-chess-knight" style="color:var(--accent)"></i>
      <span class="section-title">Strategic Analysis</span>
    </div>
  </div>

  <div class="deal-card" style="border-left: 4px solid var(--accent); margin-bottom: 1.5rem; background: linear-gradient(to right, rgba(212, 196, 168, 0.05), transparent);">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:0.75rem;">
      <span style="font-size:0.75rem; color:var(--accent); font-weight:700; letter-spacing:1px;">OUTLOOK</span>
      <span id="strat-outlook" style="font-size:1rem; font-weight:700; color:#fff;">--</span>
    </div>
    <div id="strat-text" style="font-size: 0.9rem; color: #ccc; margin-bottom: 1.25rem; line-height: 1.5;"></div>
    <div style="padding-top:1rem; border-top:1px solid rgba(255,255,255,0.1);">
      <div style="font-size:0.7rem; color:#888; text-transform:uppercase; margin-bottom:4px;">Recommended Action</div>
      <div id="strat-action" style="font-size:0.95rem; color:white; font-weight:500;"></div>
    </div>
  </div>

  <div class="insight-grid" style="grid-template-columns: repeat(3, 1fr); gap:0.75rem; margin-bottom: 1.5rem;">
    <div class="insight-card" style="padding: 0.75rem;">
      <div class="insight-label">BD Investment</div>
      <div id="matrix-bd" style="font-size:0.9rem; font-weight:600; color:white; margin:4px 0;">--</div>
      <div class="stat-sub neutral" style="font-size:0.65rem;">vs. Growth Trend</div>
    </div>
    <div class="insight-card" style="padding: 0.75rem;">
      <div class="insight-label">Capture Strategy</div>
      <div id="matrix-strat" style="font-size:0.9rem; font-weight:600; color:white; margin:4px 0;">--</div>
      <div class="stat-sub neutral" style="font-size:0.65rem;">vs. Competition</div>
    </div>
    <div class="insight-card" style="padding: 0.75rem;">
      <div class="insight-label">Pipeline Focus</div>
      <div id="matrix-pipe" style="font-size:0.9rem; font-weight:600; color:white; margin:4px 0;">--</div>
      <div class="stat-sub neutral" style="font-size:0.65rem;">vs. Opportunity</div>
    </div>
  </div>

  <div style="background:rgba(255,255,255,0.02); padding:1rem; border:1px solid #333; border-radius:4px; margin-bottom: 2rem;">
    <div style="display:flex; align-items:center; gap:8px; margin-bottom:0.75rem; color:var(--text-muted); font-size:0.75rem; font-weight:700; letter-spacing:0.5px;">
      <i class="fas fa-info-circle"></i> MODEL LIMITATIONS & LOGIC
    </div>
    <ul style="margin:0; padding-left:1.2rem; color:#888; font-size:0.8rem; line-height:1.6;">
      <li style="margin-bottom:4px;">
        <strong>TAM (Total Addressable Market):</strong> 
        Projected annual volume based on <em>aggregate historical obligations</em> from USASpending. Uses a recency-weighted average of completed Fiscal Years.
      </li>
      <li style="margin-bottom:4px;">
        <strong>Awards vs. Forecast Gap:</strong> 
        "Total Awards" reflects <em>Total Contract Value (Ceiling)</em>. "Forecast" projects <em>Actual Obligated Spending</em> (cash flow). Large deltas represent unfunded ceiling capacity.
      </li>
      <li style="margin-bottom:4px;">
        <strong>Historical Basis:</strong> Forecasts rely entirely on seasonal trends. The model cannot predict budget cuts, policy shifts, or CRs.
      </li>
      <li>
        <strong>Confidence Score:</strong> Based solely on data availability and volatility. "High" requires 3+ years of consistent growth or stable trends.
      </li>
    </ul>
  </div>
</div>

<div class="section-header">
  <div class="section-title-group">
    <i class="fas fa-code-branch" style="color:var(--accent)"></i>
    <span class="section-title">Forecast Methodology</span>
  </div>
</div>

<div class="methodology-card" style="grid-template-columns: repeat(2, 1fr); gap:1rem;">
  <div class="method-item" style="border:none;">
    <div class="method-title"><i class="fas fa-layer-group"></i> Top-Down Volume</div>
    <div class="method-desc">
      Forecasts <strong>Total Annual Spending</strong> using a weighted average of the last 3 fiscal years to create a stable baseline.
    </div>
  </div>
  <div class="method-item" style="border:none;">
    <div class="method-title"><i class="fas fa-chart-area"></i> Seasonality</div>
    <div class="method-desc">
      Analyzes historical spending patterns to determine the unique "shape" of the fiscal year and distributes annual forecast accordingly.
    </div>
  </div>
  <div class="method-item" style="border:none;">
    <div class="method-title"><i class="fas fa-filter"></i> Outlier Removal</div>
    <div class="method-desc">
      Anomalies are filtered on a <strong>per-quarter basis</strong> to distinguish between seasonal spikes and one-off events.
    </div>
  </div>
  <div class="method-item" style="border:none;">
    <div class="method-title"><i class="fas fa-balance-scale"></i> Market Context</div>
    <div class="method-desc">
      Calculates <strong>Herfindahl-Hirschman Index (HHI)</strong> to measure market concentration and competitive density.
    </div>
  </div>
</div>
	  
      <div id="recompetesList" style="margin-top:2rem;"></div>
    </div>
  </div>
</div>
<div id="loader" class="loader">
  <div class="spinner"></div>
  <p id="loaderText" style="margin-top:1rem; font-family:'JetBrains Mono'; color:var(--accent);">RETRIEVING DATA...</p>
  <p id="loaderSubtext" style="color:#666; font-size:0.8rem; margin-top:0.5rem;"></p>
</div>

<div id="salesPlanModal" class="channel-marking-modal">
  <div class="channel-modal-content" style="max-width: 900px; height: 85vh; display:flex; flex-direction:column;">
    <div class="channel-modal-header">
      <div class="channel-modal-title"><i class="fas fa-rocket"></i> GENERATE SALES PLAN</div>
      <button class="channel-modal-close" onclick="SalesPlanManager.close()"><i class="fas fa-times"></i></button>
    </div>
    
    <div class="channel-modal-body" style="flex:1; overflow-y:auto; padding:0;">
      
      <!-- NEW: Intent Detection Banner -->
      <div id="spIntentBanner"></div>
      
      <!-- Step 1: Scope -->
      <div style="padding:1.5rem; border-bottom:1px solid var(--border); background:rgba(255,255,255,0.02);">
        <div style="font-size:0.85rem; color:var(--accent); font-weight:700; margin-bottom:1rem; text-transform:uppercase; letter-spacing:1px;">
          <i class="fas fa-bullseye"></i> Step 1: Define Plan Scope
        </div>
        <div class="step-grid" style="display:grid; grid-template-columns: 1fr 1fr; gap:1.5rem;">
          <div>
            <label style="display:block; font-size:0.75rem; color:var(--text-muted); margin-bottom:0.5rem; font-weight:600;">
              PLAN SCOPE / SECTOR
            </label>
            <select id="spScope" class="main-input" style="padding:0.6rem; font-size:0.9rem; background:var(--bg-app);">
              <option value="all">Entire Market (All Results)</option>
              <option value="defense">Defense (DoD & Branches)</option>
              <option value="civilian">Federal Civilian (Non-DoD)</option>
              <optgroup label="Specific Agencies" id="spSpecificAgencies"></optgroup>
            </select>
          </div>
          <div>
            <label style="display:block; font-size:0.75rem; color:var(--text-muted); margin-bottom:0.5rem; font-weight:600;">
              STRATEGIC GOAL
              <span style="cursor:help; margin-left:4px;" title="Growth = New business pursuit&#10;Retention = Defend existing contracts&#10;Partnership = Channel/partner optimization">ⓘ</span>
            </label>
            <select id="spFocus" class="main-input" style="padding:0.6rem; font-size:0.9rem; background:var(--bg-app);">
              <option value="Growth">Aggressive Growth (New Business)</option>
              <option value="Retention">Retention (Defend Incumbency)</option>
              <option value="Partnership">Partner/Channel Strategy</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Step 2: Vendor Classification -->
      <div style="padding:1.5rem;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
          <div style="font-size:0.85rem; color:var(--accent); font-weight:700; text-transform:uppercase; letter-spacing:1px;">
            <i class="fas fa-sitemap"></i> Step 2: Classify Vendors
          </div>
          <div id="spBulkActionContainer"></div>
        </div>
        
        <div style="background:rgba(212, 196, 168, 0.05); padding:0.75rem; border-radius:4px; margin-bottom:1.5rem; font-size:0.8rem; color:var(--text-muted); border-left:2px solid var(--accent);">
          <i class="fas fa-magic" style="color:var(--accent);"></i>
          <strong>Smart Detection:</strong> We've pre-identified likely resellers based on known patterns. Accept our suggestions or customize below.
        </div>

        <div id="spVendorList"></div>
      </div>
    </div>

    <!-- Updated Footer with Better Labels -->
    <div class="channel-modal-footer" style="background:var(--bg-card); border-top:1px solid var(--border);">
      <div style="flex:1; font-size:0.75rem; color:var(--text-muted); display:flex; align-items:center; gap:0.5rem;">
        <div id="spDataStatus"></div>
      </div>
      
      <button class="modal-btn modal-btn-cancel" onclick="SalesPlanManager.close()">
        Cancel
      </button>
      
      <button class="modal-btn modal-btn-cancel" onclick="SalesPlanManager.generate()" title="Download as .txt file">
        <i class="fas fa-download"></i> Download .txt
      </button>
      
      <button id="btnCopyPrompt" class="modal-btn modal-btn-primary" onclick="SalesPlanManager.copyPrompt()" style="min-width: 180px;">
        <i class="fas fa-copy"></i> Copy → Paste to AI
      </button>
    </div>
  </div>
</div>
<script>
// ==================== UTILITIES ====================
const Utils = {
  money: n => {
    if (!n && n !== 0) return '-';
    if(n >= 1e9) return '$' + (n/1e9).toFixed(1) + 'B';
    if(n >= 1e6) return '$' + (n/1e6).toFixed(1) + 'M';
    if(n >= 1e3) return '$' + (n/1e3).toFixed(0) + 'K';
    return '$' + Math.round(n).toLocaleString();
  },
  trunc: (s, l) => (s && s.length > l) ? s.substring(0,l)+'...' : (s || 'No Description'),
  date: s => s ? new Date(s).toLocaleDateString() : '—',
  formatDateISO: date => date.toISOString().split('T')[0],
  
  getCurrentFY: () => {
    const now = new Date();
    // Federal FY starts Oct 1 (Month 9)
    return now.getMonth() >= 9 ? now.getFullYear() + 1 : now.getFullYear();
  },

  getCurrentQuarter: () => {
    const m = new Date().getMonth(); // 0-11
    if (m >= 9) return 1;
    if (m <= 2) return 2;
    if (m <= 5) return 3;
    return 4;
  },
  
  getColor: name => {
    const palette = ['#958BB6', '#6F8A74', '#C27E5C', '#8FB6D0', '#B0C4DE', '#D9B48F'];
    let hash = 0;
    for (let i = 0; i < name.length; i++) {
      hash = name.charCodeAt(i) + ((hash << 5) - hash);
    }
    return palette[Math.abs(hash) % palette.length];
  }
};

// ==================== MODAL UTILITIES ====================
const ModalUtils = {
  activeModal: null,
  previousFocus: null,
  
  open(modalId) {
    const modal = document.getElementById(modalId);
    if (!modal) return;
    
    // Store previous focus for restoration
    this.previousFocus = document.activeElement;
    
    // Lock body scroll
    document.body.style.overflow = 'hidden';
    
    // Show modal
    modal.classList.add('active');
    this.activeModal = modal;
    
    // Focus first focusable element
    const focusable = modal.querySelector('button, input, select, textarea');
    if (focusable) setTimeout(() => focusable.focus(), 50);
    
    // Add event listeners
    this._boundKeydown = this.handleKeydown.bind(this);
    this._boundBackdrop = this.handleBackdropClick.bind(this);
    document.addEventListener('keydown', this._boundKeydown);
    modal.addEventListener('click', this._boundBackdrop);
  },
  
  close() {
    if (!this.activeModal) return;
    
    const modal = this.activeModal;
    
    // Hide modal
    modal.classList.remove('active');
    
    // Restore body scroll
    document.body.style.overflow = '';
    
    // Restore previous focus
    if (this.previousFocus && this.previousFocus.focus) {
      this.previousFocus.focus();
    }
    
    // Remove event listeners
    document.removeEventListener('keydown', this._boundKeydown);
    modal.removeEventListener('click', this._boundBackdrop);
    
    this.activeModal = null;
  },
  
  handleKeydown(e) {
    if (e.key === 'Escape') {
      this.close();
      return;
    }
    
    // Focus trap - keep Tab within modal
    if (e.key === 'Tab' && this.activeModal) {
      const focusables = this.activeModal.querySelectorAll(
        'button:not([disabled]), input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"])'
      );
      if (focusables.length === 0) return;
      
      const first = focusables[0];
      const last = focusables[focusables.length - 1];
      
      if (e.shiftKey && document.activeElement === first) {
        e.preventDefault();
        last.focus();
      } else if (!e.shiftKey && document.activeElement === last) {
        e.preventDefault();
        first.focus();
      }
    }
  },
  
  handleBackdropClick(e) {
    // Close only if clicking the backdrop itself, not the content
    if (e.target === this.activeModal) {
      this.close();
    }
  }
};

// ==================== API ====================
const API = {
  baseUrl: 'https://api.usaspending.gov/api/v2',
  
  // Search Mode API
  async searchAwards(keywords) {
    const today = new Date();
    const oneYearAgo = new Date();
    oneYearAgo.setFullYear(today.getFullYear() - 1);
    
    const period = {
      start_date: Utils.formatDateISO(oneYearAgo),
      end_date: Utils.formatDateISO(today)
    };
    
    const terms = keywords.split(',').map(s => s.trim()).filter(s => s.length > 0);
    
    const fetchPromises = terms.map(term => {
      return fetch(`${this.baseUrl}/search/spending_by_award/`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          filters: { 
            keywords: [term], 
            time_period: [period],
            award_type_codes: ['A','B','C','D']
          },
          fields: [
            'Award ID', 'Recipient Name', 'Awarding Agency', 'Awarding Sub Agency',
            'Award Amount', 'Description', 'generated_internal_id',
            'Start Date', 'End Date', 'NAICS Code', 'NAICS Description', 'PSC Code', 'PSC Description'
          ],
          limit: 100,
          sort: 'Award Amount',
          order: 'desc'
        })
      }).then(res => res.json());
    });
    
    const results = await Promise.all(fetchPromises);
    let combined = [];
    results.forEach(json => {
      if(json.results) combined = combined.concat(json.results);
    });
    
    // Deduplicate
    const unique = new Map();
    combined.forEach(item => {
      if(!unique.has(item['Award ID'])) unique.set(item['Award ID'], item);
    });
    
    return Array.from(unique.values()).sort((a,b) => b['Award Amount'] - a['Award Amount']);
  },
  
  // Forecast Mode APIs
  async getSpendingOverTime(keywords, yearsBack=4) {
    const curFY = Utils.getCurrentFY();
    const periods = [];
    // Get extra history to establish trends
    for(let y=curFY-yearsBack; y<=curFY; y++) {
      periods.push({start_date:`${y-1}-10-01`, end_date:`${y}-09-30`});
    }
    
    const res = await fetch(`${this.baseUrl}/search/spending_over_time/`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        group: 'quarter',
        filters: { keywords:[keywords], time_period:periods, award_type_codes:['A','B','C','D'] }
      })
    });
    return (await res.json()).results || [];
  },
  
  async getAgencyData(keywords, yearsBack=3) {
    const curFY = Utils.getCurrentFY();
    const periods = [{start_date:`${curFY-yearsBack-1}-10-01`, end_date:`${curFY}-09-30`}];
    
    const res = await fetch(`${this.baseUrl}/search/spending_by_category/awarding_agency`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        category: 'awarding_agency',
        filters: { keywords:[keywords], time_period:periods, award_type_codes:['A','B','C','D'] },
        limit: 100
      })
    });
    return (await res.json()).results || [];
  },
  
  async getAwardsForForecast(keywords, yearsBack=3) {
    const curFY = Utils.getCurrentFY();
    // We want current active contracts primarily
    const periods = [{start_date:`${curFY-yearsBack-1}-10-01`, end_date:`${curFY+5}-09-30`}];
    
    const res = await fetch(`${this.baseUrl}/search/spending_by_award/`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        filters: { keywords:[keywords], time_period:periods, award_type_codes:['A','B','C','D'] },
        fields: [
          'Award ID', 'Recipient Name', 'Description', 'Start Date', 'End Date', 
          'Award Amount', 'Awarding Agency', 'Awarding Sub Agency', 'generated_internal_id',
          'NAICS Code', 'NAICS Description', 'PSC Code', 'PSC Description'
        ],
        // FIX: Sort by Amount DESC to get big contracts, not "End Date DESC" which gives contracts ending in 2030
        limit: 100, 
        sort: 'Award Amount',
        order: 'desc'
      })
    });
    return (await res.json()).results || [];
  }
};

// ==================== FORECAST ENGINE (RESTORED STRICT LOGIC) ====================
const ForecastEngine = {
  analyze(spendingData, awardsData, agencyData) {
    const organized = this.organizeByQuarter(spendingData);
    const filtered = this.filterOutliers(organized);
    const seasonalProfile = this.calculateSeasonalProfile(filtered);
    const annualForecast = this.calculateAnnualForecast(filtered);
    const recompetes = this.detectRecompetes(awardsData);
    const market = this.analyzeMarketConcentration(agencyData);
    const forecasts = this.generateForecasts(annualForecast, seasonalProfile, filtered);
    const strategy = this.generateStrategy(forecasts, market.hhi, recompetes);
    
    return { 
      forecasts, 
      recompetes, 
      baseline: annualForecast, 
      marketStatus: market.level, 
      hhi: market.hhi, 
      indices: seasonalProfile, 
      byFY: organized.byFY, 
      strategy 
    };
  },

  organizeByQuarter(spendingData) {
    const organized = { byFY: {}, byQuarter: {}, totalByFY: {}, allAmounts: [] };
    spendingData.forEach(d => {
      const q = parseInt(d.time_period?.quarter); 
      const fy = parseInt(d.time_period?.fiscal_year); 
      const amt = d.aggregated_amount || 0;
      if(q && fy) {
        if(!organized.byFY[fy]) organized.byFY[fy] = {1:0, 2:0, 3:0, 4:0};
        organized.byFY[fy][q] = amt; 
        if(!organized.byQuarter[q]) organized.byQuarter[q] = [];
        organized.byQuarter[q].push({fy, amt}); 
        organized.totalByFY[fy] = (organized.totalByFY[fy] || 0) + amt;
        organized.allAmounts.push({fy, q, amt});
      }
    });
    return organized;
  },

  filterOutliers(organized) {
    const filtered = { byFY: {}, byQuarter: {}, totalByFY: {}, allAmounts: [] };
    Object.keys(organized.byFY).forEach(fy => filtered.byFY[fy] = {});
    for(let q=1; q<=4; q++) {
      const qData = organized.byQuarter[q] || []; 
      const amounts = qData.map(d => d.amt);
      if(amounts.length < 3) {
        qData.forEach(d => { 
           filtered.byQuarter[q] = filtered.byQuarter[q] || []; 
           filtered.byQuarter[q].push(d); 
           filtered.byFY[d.fy][q] = d.amt; 
           filtered.totalByFY[d.fy] = (filtered.totalByFY[d.fy]||0) + d.amt; 
        });
        continue;
      }
      const mean = amounts.reduce((a,b)=>a+b,0) / amounts.length;
      const variance = amounts.reduce((s,v)=>s+Math.pow(v-mean,2),0) / amounts.length;
      const stdDev = Math.sqrt(variance);
      const limit = mean + (2 * stdDev);
      qData.forEach(item => {
        if(item.amt <= limit) {
           filtered.byQuarter[q] = filtered.byQuarter[q] || []; 
           filtered.byQuarter[q].push(item); 
           filtered.byFY[item.fy][q] = item.amt; 
           filtered.totalByFY[item.fy] = (filtered.totalByFY[item.fy]||0) + item.amt;
        }
      });
    }
    return filtered;
  },

  calculateSeasonalProfile(filtered) {
    const quarters = {1:0, 2:0, 3:0, 4:0}; 
    const counts = {1:0, 2:0, 3:0, 4:0};
    Object.keys(filtered.totalByFY).forEach(fy => {
        const total = filtered.totalByFY[fy]; 
        if(total <= 0) return;
        const qWithData = Object.values(filtered.byFY[fy]).filter(v => v > 0).length;
        if(qWithData < 3) return;
        for(let q=1; q<=4; q++) { 
            const amt = filtered.byFY[fy][q] || 0;
            quarters[q] += (amt / total); 
            counts[q]++; 
        }
    });
    const profile = {}; 
    let sum = 0;
    for(let q=1; q<=4; q++) { 
        profile[q] = counts[q] ? quarters[q] / counts[q] : 0.25; 
        sum += profile[q]; 
    }
    for(let q=1; q<=4; q++) profile[q] = profile[q] / sum;
    return profile;
  },

  calculateAnnualForecast(filtered) {
    const curFY = Utils.getCurrentFY();
    const years = Object.keys(filtered.totalByFY).map(Number).sort((a,b)=>a-b);
    const cleanYears = years.filter(y => y < curFY && filtered.totalByFY[y] > 0);
    if(cleanYears.length === 0) return 0;
    
    let weightedSum = 0; 
    let weightTotal = 0;
    cleanYears.forEach((fy, index) => { 
        const weight = index + 1; 
        weightedSum += filtered.totalByFY[fy] * weight; 
        weightTotal += weight; 
    });
    
    let baseline = weightedSum / weightTotal;
    if(cleanYears.length >= 2) {
        const recentYear = filtered.totalByFY[cleanYears[cleanYears.length-1]];
        baseline = (baseline * 0.7) + (recentYear * 0.3);
    }
    return baseline;
  },

  analyzeMarketConcentration(agencyData) {
    const total = agencyData.reduce((s,a)=>s+a.amount,0); 
    let hhi = 0;
    agencyData.forEach(a => { 
      const share = (a.amount / total) * 100; 
      hhi += share * share; 
    });
    let level = "Competitive";
    if(hhi > 2500) level = "Concentrated";
    else if(hhi > 1500) level = "Moderate";
    return { hhi: Math.round(hhi), level };
  },

  detectRecompetes(awards) {
    const now = new Date(); 
    const sixMonths = new Date(); sixMonths.setMonth(now.getMonth() + 6); 
    const twoYears = new Date(); twoYears.setFullYear(now.getFullYear()+2);
    return awards.filter(a => { 
      const end = new Date(a['End Date']); 
      return end > sixMonths && end < twoYears && a['Award Amount'] > 50000; 
    }).slice(0, 15);
  },

  generateForecasts(annualForecast, seasonalProfile, filtered) {
    const forecasts = []; 
    const curFY = Utils.getCurrentFY(); 
    const curQ = Utils.getCurrentQuarter();
    
    let fy = curFY; 
    let q = curQ;
    
    for(let i=0; i<4; i++) {
      const predicted = annualForecast * seasonalProfile[q];
      const qHistory = filtered.byQuarter[q] || [];
      const activeYears = qHistory.filter(d => d.amt > 0).sort((a,b) => a.fy - b.fy);
      const trueAvg = qHistory.length ? qHistory.reduce((s, d) => s + d.amt, 0) / qHistory.length : 0;
      
      let volatility = 0;
      if(activeYears.length > 1) {
          const activeAvg = activeYears.reduce((s, d) => s + d.amt, 0) / activeYears.length;
          const variance = activeYears.reduce((s, d) => s + Math.pow(d.amt - activeAvg, 2), 0) / (activeYears.length - 1);
          volatility = Math.sqrt(variance) / activeAvg;
      }

      let isStrictGrowth = false;
      if (activeYears.length >= 3) {
          isStrictGrowth = true;
          for(let k=1; k<activeYears.length; k++) {
              if (activeYears[k].amt <= activeYears[k-1].amt) {
                  isStrictGrowth = false;
                  break;
              }
          }
      }

      let displayTrend = 0;
      if(trueAvg > 0) displayTrend = ((predicted - trueAvg) / trueAvg) * 100;
      else if (predicted > 0) displayTrend = 100;

      // --- STRICTER CONFIDENCE LOGIC FROM INDEX.HTML ---
      let confLabel = "Low";
      let confReason = "Insufficient Data";

      if (qHistory.length === 0) {
          confLabel = "Low"; confReason = "No History";
      } else if (activeYears.length === 0) {
          confLabel = "Low"; confReason = "Inactive";
      } else {
          const isFrequent = activeYears.length >= 3;
          const hasGaps = activeYears.length < qHistory.length; 
          
          if (isFrequent && !hasGaps) {
              if (isStrictGrowth) {
                  confLabel = "High";
                  confReason = "Consistent Growth";
              } else if (volatility < 0.5) { // Stricter volatility check
                  confLabel = "High";
                  confReason = "Stable Trend";
              } else if (volatility < 1.0) {
                  confLabel = "Med";
                  confReason = "Moderate Variance";
              } else {
                  confLabel = "Low";
                  confReason = "High Volatility";
              }
          } 
          else if (isFrequent && hasGaps) {
              confLabel = "Med"; confReason = "Intermittent";
          } 
          else {
              if (volatility < 0.2) { confLabel = "Med"; confReason = "Limited but Stable"; }
              else { confLabel = "Low"; confReason = "Limited History"; }
          }
      }

      forecasts.push({
        period: `FY${fy} Q${q}`,
        predicted: predicted,
        histAvg: trueAvg,
        trend: displayTrend > 0 ? `+${displayTrend.toFixed(1)}` : displayTrend.toFixed(1),
        confidence: { label: confLabel, reason: confReason }
      });
      
      q++;
      if(q > 4) { q = 1; fy++; }
    }
    return forecasts;
  },

  generateStrategy(forecasts, hhi, recompetes) {
    if(!forecasts || forecasts.length < 2) return null;

    const nearTerm = forecasts.slice(0, 2);
    const avgGrowth = nearTerm.reduce((sum, f) => sum + parseFloat(f.trend), 0) / nearTerm.length;
    
    let growthSignal = "Moderate";
    if (avgGrowth > 30) growthSignal = "High Growth"; 
    else if (avgGrowth < -20) growthSignal = "Decline";

    let marketType = "Moderate";
    if (hhi > 2500) marketType = "Concentrated";
    else if (hhi < 1500) marketType = "Competitive";

    // --- RICHER STRATEGIC TEXT FROM INDEX.HTML ---
    let outlook = "";
    let action = "";
    
    if (growthSignal === "High Growth") {
        outlook = `The model projects positive variance (+${avgGrowth.toFixed(1)}% avg) compared to historical baselines. While data suggests upward momentum, users should verify if this is due to new funding or statistical anomalies in prior years.`;
        action = "Validate pipeline depth. Assess capacity before committing additional resources.";
    } else if (growthSignal === "Decline") {
        outlook = `The model projects a softening trend (${avgGrowth.toFixed(1)}% avg). Volume may be lower than historical norms for this period.`;
        action = "Focus business development efforts strictly on high-probability recompetes and existing relationships.";
    } else {
        outlook = `The model suggests stability, with projected volume tracking close to historical averages.`;
        action = "Maintain consistent business development cadence. Focus on capture quality over volume.";
    }

    if (marketType === "Concentrated") {
        outlook += ` High concentration (HHI > 2500) suggests incumbent dominance.`;
        action += " Teaming with incumbents is recommended.";
    } else if (marketType === "Competitive") {
        outlook += ` Low concentration (HHI < 1500) implies a fragmented landscape.`;
        action += " A broader prospecting approach may yield results.";
    }

    const matrix = {
        bd: growthSignal === "High Growth" ? "Validate & Assess" : (growthSignal === "Decline" ? "Selective Focus" : "Maintain Steady"),
        strat: marketType === "Concentrated" ? "Relationship Focus" : (marketType === "Competitive" ? "Volume Bidding" : "Balanced Approach"),
        pipe: recompetes.length > 5 ? "Incumbent Displacement" : "New Requirements"
    };

    return {
        title: growthSignal === "High Growth" ? "Growth Projected" : (growthSignal === "Decline" ? "Softening Projected" : "Stable Outlook"),
        text: outlook,
        action: action,
        matrix: matrix
    };
  }
};
// ==================== KNOWN VENDORS DATABASE ====================
const KnownVendors = {
  // Known VARs/Resellers
  vars: new Set([
    'CARAHSOFT TECHNOLOGY CORP', 'CARAHSOFT TECHNOLOGY CORPORATION',
    'CDW GOVERNMENT LLC', 'CDW-G',
    'SHI INTERNATIONAL CORP', 'SHI GOVERNMENT SOLUTIONS',
    'INSIGHT PUBLIC SECTOR INC', 'INSIGHT DIRECT USA INC',
    'GOVPLACE, LLC', 'GOVPLACE LLC',
    'IMMIX GROUP INC', 'IMMIXGROUP INC',
    'DLT SOLUTIONS LLC', 'DLT SOLUTIONS',
    'THUNDERCAT TECHNOLOGY, LLC', 'THUNDERCAT TECHNOLOGY LLC',
    'WORLD WIDE TECHNOLOGY LLC', 'WWT GOVERNMENT SERVICES',
    'PRESIDIO NETWORKED SOLUTIONS', 'PRESIDIO GOVERNMENT SOLUTIONS',
    'CONNECTION', 'PC CONNECTION', 'PCMG INC',
    'EN POINTE TECHNOLOGIES',
    'STERLING COMPUTERS CORPORATION', 'STERLING COMPUTERS',
    'MERLIN INTERNATIONAL', 'RED RIVER TECHNOLOGY',
    'MYTHICS INC', 'MYTHICS LLC',
    'FOUR POINTS TECHNOLOGY', 'FOUR POINTS TECHNOLOGY LLC',
    'SILOTECH GROUP INC', 'DECISIVE COMMUNICATIONS INC',
    'FCN INC', 'FCN, INC.',
    'SOFTCHOICE CORPORATION', 'SOFTCHOICE',
    'TRACE3', 'OPTIV SECURITY INC', 'OPTIV SECURITY',
    'FEDSTORE CORPORATION', 'FEDSTORE',
    'GOVSMART INC', 'GOVSMART, INC.',
    'NEW TECH SOLUTIONS', 'NEW TECH SOLUTIONS, INC.',
    'PANAMERICA COMPUTERS', 'PANAMERICA COMPUTERS, INC.',
    'SOFTWARE INFORMATION RESOURCE CORP',
    'ACCESSAGILITY LLC', 'BLUE TECH INC', 'BLUE TECH INC.',
    'DH TECHNOLOGIES', 'DH TECHNOLOGIES, INC.',
    'IT1 SOURCE LLC',
    'ENTERPRISE TECHNOLOGY SOLUTIONS', 'ENTERPRISE TECHNOLOGY SOLUTIONS, INC.',
    'DISTRIBUTED TECHNOLOGY GROUP LLC', 'ARCHITECHTURE SOLUTIONS LLC',
    'ADVANCED COMPUTER CONCEPTS', 'ADVANCED COMPUTER CONCEPTS, INC.',
    '4 STAR TECHNOLOGIES', '4 STAR TECHNOLOGIES, INC.',
    'THREE WIRE SYSTEMS', 'THREE WIRE SYSTEMS, LLC',
    'C & C INTERNATIONAL COMPUTERS'
  ]),

  // Known Large Primes/System Integrators
  primes: new Set([
    'BOOZ ALLEN HAMILTON', 'BOOZ ALLEN HAMILTON INC',
    'GENERAL DYNAMICS INFORMATION TECHNOLOGY', 'GENERAL DYNAMICS IT', 'GDIT',
    'LEIDOS INC', 'LEIDOS HOLDINGS', 'LEIDOS',
    'SAIC', 'SCIENCE APPLICATIONS INTERNATIONAL',
    'NORTHROP GRUMMAN', 'RAYTHEON',
    'LOCKHEED MARTIN', 'LOCKHEED MARTIN CORPORATION',
    'BAE SYSTEMS', 'L3HARRIS TECHNOLOGIES',
    'CACI INTERNATIONAL', 'CACI INC',
    'MANTECH INTERNATIONAL', 'MANTECH',
    'PERATON INC', 'PERATON',
    'ACCENTURE FEDERAL SERVICES', 'ACCENTURE',
    'DELOITTE CONSULTING', 'DELOITTE',
    'IBM CORPORATION', 'IBM', 'KPMG',
    'CGI FEDERAL', 'CGI TECHNOLOGIES',
    'MAXIMUS INC', 'MAXIMUS FEDERAL',
    'ICF INTERNATIONAL', 'ICF INC',
    'SERCO INC', 'SERCO',
    'PAE INCORPORATED', 'AMENTUM',
    'JACOBS TECHNOLOGY', 'KBR INC'
  ]),

  // Classify a vendor name
  classify(vendorName) {
    const upper = vendorName.toUpperCase().trim();
    
    // Check exact matches first
    if (this.vars.has(upper)) return 'var';
    if (this.primes.has(upper)) return 'prime';
    
    // Check partial matches
    for (const known of this.vars) {
      if (upper.includes(known) || known.includes(upper)) return 'var';
    }
    for (const known of this.primes) {
      if (upper.includes(known) || known.includes(upper)) return 'prime';
    }
    
    // Pattern-based detection for likely VARs
    const varPatterns = [
      /\b(TECHNOLOGY|TECHNOLOGIES)\s*(CORP|LLC|INC)/i,
      /\b(COMPUTERS?|COMPUTING)\s*(CORP|LLC|INC)/i,
      /\bSOLUTIONS?\s*(CORP|LLC|INC)/i,
      /\bGOV(PLACE|SMART|STORE)/i,
      /\bFEDERAL\s*(SOLUTIONS|TECHNOLOGY)/i
    ];
    
    for (const pattern of varPatterns) {
      if (pattern.test(upper)) return 'likely_var';
    }
    
    return 'unknown';
  }
};
// ==================== ENHANCED SALES PLAN MANAGER ====================
const SalesPlanManager = {
  channels: new Set(),
  currentVendors: [],
  detectedIntent: null,
  
  init() {
    const saved = localStorage.getItem('govhoo_channels');
    if (saved) this.channels = new Set(JSON.parse(saved));
  },

  isChannel(vendorName) { 
    return this.channels.has(vendorName); 
  },

  // ==================== INTENT DETECTION ====================
  detectIntent(awards) {
    const query = App.currentQuery || '';
    const vendorSpend = {};
    let totalSpend = 0;
    
    awards.forEach(r => {
      const v = r['Recipient Name'] || 'Unknown';
      const a = parseFloat(r['Award Amount']) || 0;
      vendorSpend[v] = (vendorSpend[v] || 0) + a;
      totalSpend += a;
    });
    
    const vendors = Object.entries(vendorSpend)
      .map(([name, spend]) => ({ name, spend, share: spend / totalSpend }))
      .sort((a, b) => b.spend - a.spend);
    
    // Calculate channel metrics
    let channelSpend = 0;
    let channelCount = 0;
    vendors.forEach(v => {
      if (this.isChannel(v.name)) {
        channelSpend += v.spend;
        channelCount++;
      }
    });
    const channelShare = totalSpend > 0 ? channelSpend / totalSpend : 0;
    
    // Detect Product/OEM (high channel share)
    if (channelShare > 0.7 && channelCount >= 3) {
      return {
        type: 'product_oem',
        icon: 'fa-box',
        title: 'PRODUCT / OEM CHANNEL',
        description: `${(channelShare * 100).toFixed(1)}% of revenue flows through ${channelCount} channel partners`,
        focusAreas: [
          'Channel performance & rankings',
          'Partner enablement priorities', 
          'Recompete defense by partner',
          'Agency coverage gaps'
        ],
        suggestedGoal: 'Partnership'
      };
    }
    
    // Detect own company search
    const topVendor = vendors[0];
    if (topVendor && query.toLowerCase().includes(topVendor.name.toLowerCase().split(' ')[0])) {
      return {
        type: 'own_company',
        icon: 'fa-building',
        title: 'YOUR COMPANY ANALYSIS',
        description: `Analyzing your market position: ${Utils.money(topVendor.spend)} (${(topVendor.share * 100).toFixed(1)}% share)`,
        focusAreas: [
          'Defend existing contracts',
          'Identify growth opportunities',
          'Competitive threats to your position',
          'Recompete calendar & defense'
        ],
        suggestedGoal: 'Retention'
      };
    }
    
    // Detect agency search
    const agencyKeywords = ['department', 'agency', 'administration', 'commission', 'bureau'];
    if (agencyKeywords.some(kw => query.toLowerCase().includes(kw))) {
      return {
        type: 'agency',
        icon: 'fa-landmark',
        title: 'AGENCY PENETRATION',
        description: `Analyzing how to enter or expand within this customer`,
        focusAreas: [
          'Agency mission & budget priorities',
          'Current vendor landscape',
          'Entry points & opportunities',
          'Key contracting vehicles'
        ],
        suggestedGoal: 'Growth'
      };
    }
    
    // Default: Market/keyword search
    return {
      type: 'market_keyword',
      icon: 'fa-chart-line',
      title: 'MARKET ANALYSIS',
      description: `Analyzing the "${query}" market landscape`,
      focusAreas: [
        'Market size & growth trends',
        'Competitive landscape',
        'Top agencies & opportunities',
        'Entry strategy recommendations'
      ],
      suggestedGoal: 'Growth'
    };
  },

  // ==================== UI ACTIONS ====================
  open() {
    const awards = App.forecastData.awards || App.searchData.raw || [];
    if (!awards.length) {
      alert("No award data loaded. Please run a search or forecast first.");
      return;
    }

    // Detect intent
    this.detectedIntent = this.detectIntent(awards);
    
    // Populate Agency Dropdown
    const agencyCounts = {};
    awards.forEach(r => {
      const ag = r['Awarding Agency'];
      if(ag) agencyCounts[ag] = (agencyCounts[ag] || 0) + 1;
    });
    
    const sortedAgencies = Object.entries(agencyCounts)
      .sort((a,b) => b[1] - a[1])
      .map(([name, count]) => `<option value="${name}">${name} (${count} awards)</option>`)
      .join('');
      
    document.getElementById('spSpecificAgencies').innerHTML = sortedAgencies;
    document.getElementById('spScope').value = 'all';
    
    // Set suggested goal based on intent
    document.getElementById('spFocus').value = this.detectedIntent.suggestedGoal;

    // Prepare and render
    this.prepareVendorList(awards);
    this.renderIntentBanner();
    this.updateStatus(awards.length, "Entire Market");
    this.renderSmartVendorList();
    
    ModalUtils.open('salesPlanModal');
  },

  close() {
    ModalUtils.close();
    // Also close success modal if open
    const successModal = document.getElementById('copySuccessModal');
    if (successModal) successModal.classList.remove('active');
  },

  // ==================== INTENT BANNER ====================
  renderIntentBanner() {
    const banner = document.getElementById('spIntentBanner');
    if (!banner || !this.detectedIntent) return;
    
    const intent = this.detectedIntent;
    banner.innerHTML = `
      <div class="intent-banner-content">
        <div class="intent-banner-icon"><i class="fas ${intent.icon}"></i></div>
        <div class="intent-banner-text">
          <div class="intent-banner-title">${intent.title}</div>
          <div class="intent-banner-desc">${intent.description}</div>
          <div class="intent-banner-focus">
            ${intent.focusAreas.map(f => `<span class="focus-tag">${f}</span>`).join('')}
          </div>
        </div>
      </div>
    `;
    banner.style.display = 'block';
  },

  showIntentOptions() {
    // For now, just focus on the goal dropdown
    const focusSelect = document.getElementById('spFocus');
    focusSelect.focus();
    focusSelect.style.outline = '2px solid var(--accent)';
    setTimeout(() => focusSelect.style.outline = '', 2000);
  },

  // ==================== DATA PROCESSING ====================
  getFilteredData() {
    const scope = document.getElementById('spScope').value;
    const focus = document.getElementById('spFocus').value;
    const rawAwards = App.forecastData.awards || App.searchData.raw || [];
    
    let filteredAwards = [];
    let scopeName = "Entire Market";

    if (scope === 'all') {
      filteredAwards = rawAwards;
    } else if (scope === 'defense') {
      filteredAwards = rawAwards.filter(r => /defense|army|navy|air force|marine|space force/i.test(r['Awarding Agency']));
      scopeName = "Defense Sector";
    } else if (scope === 'civilian') {
      filteredAwards = rawAwards.filter(r => !/defense|army|navy|air force|marine|space force/i.test(r['Awarding Agency']));
      scopeName = "Federal Civilian Sector";
    } else {
      filteredAwards = rawAwards.filter(r => r['Awarding Agency'] === scope);
      scopeName = scope;
    }

    if (filteredAwards.length === 0) throw new Error("No awards found for the selected scope.");

    return { filteredAwards, scopeName, focus };
  },

  // ==================== OUTPUT ACTIONS ====================
  generate() {
    App.showLoader('GENERATING PLAN...', 'Filtering data & packaging prompt...');
    setTimeout(() => {
      try {
        const { filteredAwards, scopeName, focus } = this.getFilteredData();
        const pkg = PromptPackageGenerator.buildPackage(filteredAwards, null, { scope: scopeName, focus });
        PromptPackageGenerator.downloadPackage(pkg);
        this.close();
      } catch(e) { 
        console.error(e); 
        alert(e.message || "Error generating plan");
      } finally { 
        App.hideLoader(); 
      }
    }, 500);
  },

  async copyPrompt() {
    const btn = document.getElementById('btnCopyPrompt');
    if (!btn) return;

    const originalHTML = btn.innerHTML;
    
    // Loading State
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
    btn.style.opacity = '0.7';
    btn.style.pointerEvents = 'none';
    
    try {
      const { filteredAwards, scopeName, focus } = this.getFilteredData();
      const pkg = PromptPackageGenerator.buildPackage(filteredAwards, null, { scope: scopeName, focus });
      
      // Copy to clipboard
      await navigator.clipboard.writeText(pkg);
      
      // Show success modal instead of just changing button
      this.showCopySuccessModal(pkg.length);
      
      // Reset button
      btn.innerHTML = originalHTML;
      btn.style.opacity = '1';
      btn.style.pointerEvents = 'auto';
      
    } catch(e) {
      console.error(e);
      alert(e.message || "Error copying prompt");
      btn.innerHTML = originalHTML;
      btn.style.opacity = '1';
      btn.style.pointerEvents = 'auto';
    }
  },

  // ==================== SUCCESS MODAL ====================
  showCopySuccessModal(charCount) {
    let modal = document.getElementById('copySuccessModal');
    
    if (!modal) {
      // Create modal if it doesn't exist
      modal = document.createElement('div');
      modal.id = 'copySuccessModal';
      modal.className = 'channel-marking-modal';
      document.body.appendChild(modal);
    }
    
    const estimatedTokens = Math.round(charCount / 4);
    
    modal.innerHTML = `
      <div class="channel-modal-content" style="max-width: 420px; height: auto;">
        <div class="channel-modal-header" style="border-bottom-color: var(--success);">
          <div class="channel-modal-title" style="color: var(--success);">
            <i class="fas fa-check-circle"></i> Copied to Clipboard
          </div>
          <button class="channel-modal-close" onclick="SalesPlanManager.closeSuccessModal()">
            <i class="fas fa-times"></i>
          </button>
        </div>
        
        <div class="channel-modal-body" style="padding: 1.5rem;">
          <div style="margin-bottom: 1.25rem;">
            <div style="font-size: 0.95rem; color: #fff; font-weight: 500; margin-bottom: 0.25rem;">Your prompt is ready</div>
            <div style="font-size: 0.8rem; color: var(--text-muted);">
              ${charCount.toLocaleString()} chars · ~${estimatedTokens.toLocaleString()} tokens
            </div>
          </div>
          
          <div style="font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.5rem;">
            Open in
          </div>
          <div style="display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 1.25rem;">
            <a href="https://claude.ai/new" target="_blank" class="ai-link-btn claude">
              <svg viewBox="0 0 24 24" fill="currentColor"><path d="M4.709 15.955l4.72-2.647.08-.08 2.726-1.529-2.646-1.449-.08-.08-4.8-2.647c-.56-.32-.88-.96-.88-1.6V4.404c0-.64.32-1.28.88-1.6l5.04-2.807c.56-.32 1.2-.32 1.76 0l5.04 2.807c.56.32.88.96.88 1.6v11.192c0 .64-.32 1.28-.88 1.6l-5.04 2.807c-.56.32-1.2.32-1.76 0l-5.04-2.807c-.56-.32-.88-.96-.88-1.6v-1.52c0 .56.32 1.12.88 1.44z"/></svg>
              Claude
            </a>
            <a href="https://chat.openai.com" target="_blank" class="ai-link-btn chatgpt">
              <svg viewBox="0 0 24 24" fill="currentColor"><path d="M22.282 9.821a5.985 5.985 0 0 0-.516-4.91 6.046 6.046 0 0 0-6.51-2.9A6.065 6.065 0 0 0 4.981 4.18a5.985 5.985 0 0 0-3.998 2.9 6.046 6.046 0 0 0 .743 7.097 5.98 5.98 0 0 0 .51 4.911 6.051 6.051 0 0 0 6.515 2.9A5.985 5.985 0 0 0 13.26 24a6.056 6.056 0 0 0 5.772-4.206 5.99 5.99 0 0 0 3.997-2.9 6.056 6.056 0 0 0-.747-7.073zM13.26 22.43a4.476 4.476 0 0 1-2.876-1.04l.141-.081 4.779-2.758a.795.795 0 0 0 .392-.681v-6.737l2.02 1.168a.071.071 0 0 1 .038.052v5.583a4.504 4.504 0 0 1-4.494 4.494zM3.6 18.304a4.47 4.47 0 0 1-.535-3.014l.142.085 4.783 2.759a.771.771 0 0 0 .78 0l5.843-3.369v2.332a.08.08 0 0 1-.033.062L9.74 19.95a4.5 4.5 0 0 1-6.14-1.646zM2.34 7.896a4.485 4.485 0 0 1 2.366-1.973V11.6a.766.766 0 0 0 .388.676l5.815 3.355-2.02 1.168a.076.076 0 0 1-.071 0l-4.83-2.786A4.504 4.504 0 0 1 2.34 7.896zm16.597 3.855l-5.833-3.387L15.119 7.2a.076.076 0 0 1 .071 0l4.83 2.791a4.494 4.494 0 0 1-.676 8.105v-5.678a.79.79 0 0 0-.407-.667zm2.01-3.023l-.141-.085-4.774-2.782a.776.776 0 0 0-.785 0L9.409 9.23V6.897a.066.066 0 0 1 .028-.061l4.83-2.787a4.5 4.5 0 0 1 6.68 4.66zm-12.64 4.135l-2.02-1.164a.08.08 0 0 1-.038-.057V6.075a4.5 4.5 0 0 1 7.375-3.453l-.142.08-4.778 2.758a.795.795 0 0 0-.393.681zm1.097-2.365l2.602-1.5 2.607 1.5v2.999l-2.602 1.5-2.607-1.5z"/></svg>
              ChatGPT
            </a>
            <a href="https://gemini.google.com" target="_blank" class="ai-link-btn gemini">
              <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm0 3.6c2.34 0 4.44.96 5.96 2.5l-2.4 2.4c-.92-.88-2.16-1.42-3.56-1.42-2.94 0-5.32 2.42-5.32 5.4 0 2.98 2.38 5.4 5.32 5.4 2.58 0 4.36-1.48 4.72-3.54H12v-3.18h8.26c.1.54.14 1.12.14 1.74 0 5.04-3.38 8.62-8.4 8.62C6.7 21.52 2.48 17.28 2.48 12S6.7 2.48 12 2.48z"/></svg>
              Gemini
            </a>
          </div>
          
          <div style="font-size: 0.75rem; color: var(--text-muted); line-height: 1.5;">
            Paste with <kbd>Ctrl+V</kbd> (or <kbd>⌘V</kbd>) to generate your sales plan.
          </div>
        </div>
        
        <div class="channel-modal-footer" style="justify-content: flex-end;">
          <button class="modal-btn modal-btn-cancel" onclick="SalesPlanManager.closeSuccessModal()">
            Done
          </button>
        </div>
      </div>
    `;
    
    ModalUtils.open('copySuccessModal');
  },

  closeSuccessModal() {
    ModalUtils.close();
    // Also ensure main modal is closed
    document.getElementById('salesPlanModal').classList.remove('active');
    document.body.style.overflow = '';
  },

  async copyAgain() {
    try {
      const { filteredAwards, scopeName, focus } = this.getFilteredData();
      const pkg = PromptPackageGenerator.buildPackage(filteredAwards, null, { scope: scopeName, focus });
      await navigator.clipboard.writeText(pkg);
      
      // Brief visual feedback
      const btn = document.querySelector('#copySuccessModal .modal-btn-primary');
      if (btn) {
        const original = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
        setTimeout(() => btn.innerHTML = original, 1500);
      }
    } catch(e) {
      alert('Failed to copy: ' + e.message);
    }
  },

  // ==================== VENDOR LIST HELPERS ====================
  prepareVendorList(dataSlice) {
    const vendorSpend = {}; 
    let total = 0;
    
    dataSlice.forEach(r => { 
      const v = r['Recipient Name'] || 'Unknown'; 
      const a = parseFloat(r['Award Amount']) || 0; 
      vendorSpend[v] = (vendorSpend[v] || 0) + a; 
      total += a; 
    });
    
    this.currentVendors = Object.entries(vendorSpend)
      .map(([v, s]) => ({ 
        vendor: v, 
        spend: s, 
        marketShare: total > 0 ? ((s / total) * 100).toFixed(2) : "0.00", 
        contractCount: dataSlice.filter(r => r['Recipient Name'] === v).length,
        classification: KnownVendors.classify(v)
      }))
      .sort((a, b) => b.spend - a.spend)
      .slice(0, 30); // Increased to 30 for better coverage
  },

  updateStatus(count, scopeName) {
    const statusEl = document.getElementById('spDataStatus');
    if(!statusEl) return;
    
    const channelCount = this.currentVendors.filter(v => this.isChannel(v.vendor)).length;
    const totalVendors = this.currentVendors.length;
    
    statusEl.innerHTML = `
      <span style="color:var(--success); display:flex; align-items:center; gap:6px;">
        <i class="fas fa-check-circle"></i> Ready
      </span>
      <span style="margin-left:8px; opacity:0.3;">|</span>
      <span style="margin-left:8px;">${scopeName}</span>
      <span style="margin-left:8px; opacity:0.3;">|</span>
      <span style="margin-left:8px;">${count} awards</span>
      <span style="margin-left:8px; opacity:0.3;">|</span>
      <span style="margin-left:8px; color: var(--accent);">${channelCount}/${totalVendors} channels</span>
    `;
  },

  // ==================== TOGGLE LOGIC ====================
  toggleChannel(vendorName) {
    if (this.channels.has(vendorName)) this.channels.delete(vendorName);
    else this.channels.add(vendorName);
    this.save();
    this.updateStatus(App.forecastData.awards?.length || App.searchData.raw?.length || 0, 
      document.getElementById('spScope')?.value === 'all' ? 'Entire Market' : document.getElementById('spScope')?.value);
  },

  toggleAll() {
    const allMarked = this.currentVendors.every(v => this.isChannel(v.vendor));
    if (allMarked) this.currentVendors.forEach(v => this.channels.delete(v.vendor));
    else this.currentVendors.forEach(v => this.channels.add(v.vendor));
    
    this.save();
    this.renderSmartVendorList();
    this.updateStatus(App.forecastData.awards?.length || App.searchData.raw?.length || 0, 
      document.getElementById('spScope')?.value === 'all' ? 'Entire Market' : document.getElementById('spScope')?.value);
  },

  acceptSuggested() {
    // Mark all suggested VARs as channels
    this.currentVendors.forEach(v => {
      if (v.classification === 'var' || v.classification === 'likely_var') {
        this.channels.add(v.vendor);
      }
    });
    this.save();
    this.renderSmartVendorList();
    this.updateStatus(App.forecastData.awards?.length || App.searchData.raw?.length || 0, 
      document.getElementById('spScope')?.value === 'all' ? 'Entire Market' : document.getElementById('spScope')?.value);
  },

  save() { 
    localStorage.setItem('govhoo_channels', JSON.stringify([...this.channels])); 
  },

  // ==================== SMART VENDOR LIST RENDERING ====================
  renderSmartVendorList() {
    const list = document.getElementById('spVendorList');
    const container = document.getElementById('spBulkActionContainer');
    if(!list || !container) return;

    // Group vendors by classification
    const suggestedVars = this.currentVendors.filter(v => 
      (v.classification === 'var' || v.classification === 'likely_var') && !this.isChannel(v.vendor)
    );
    const primes = this.currentVendors.filter(v => v.classification === 'prime');
    const unknown = this.currentVendors.filter(v => 
      v.classification === 'unknown' && !this.isChannel(v.vendor)
    );
    const alreadyMarked = this.currentVendors.filter(v => this.isChannel(v.vendor));

    const allMarked = this.currentVendors.length > 0 && this.currentVendors.every(v => this.isChannel(v.vendor));
    
    // Bulk action buttons
    container.innerHTML = `
      <div style="display: flex; gap: 0.5rem;">
        ${suggestedVars.length > 0 ? `
          <button onclick="SalesPlanManager.acceptSuggested()" style="background: rgba(76, 175, 80, 0.1); border: 1px solid var(--success); color: var(--success); padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.7rem; font-family: 'JetBrains Mono'; display: flex; align-items: center; gap: 6px;">
            <i class="fas fa-magic"></i> ACCEPT SUGGESTIONS (${suggestedVars.length})
          </button>
        ` : ''}
        <button onclick="SalesPlanManager.toggleAll()" style="background: transparent; border: 1px solid var(--border); color: var(--accent); padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.7rem; font-family: 'JetBrains Mono'; display: flex; align-items: center; gap: 6px;">
          <i class="far ${allMarked ? 'fa-square' : 'fa-check-square'}"></i> ${allMarked ? 'UNMARK ALL' : 'MARK ALL'}
        </button>
      </div>
    `;

    if (this.currentVendors.length === 0) {
      list.innerHTML = `<div style="text-align:center; padding:1rem; color:#666;">No vendors found in this scope.</div>`;
      return;
    }

    let html = '';

    // Already Marked Section
    if (alreadyMarked.length > 0) {
      html += this.renderVendorSection(
        '✅ MARKED AS CHANNELS',
        'These vendors are already marked as your channel partners',
        alreadyMarked,
        'success'
      );
    }

    // Suggested VARs Section  
    if (suggestedVars.length > 0) {
      html += this.renderVendorSection(
        '🎯 SUGGESTED CHANNELS',
        'We detected these as likely resellers/VARs based on known patterns',
        suggestedVars,
        'accent'
      );
    }

    // Unknown/Review Section
    if (unknown.length > 0) {
      html += this.renderVendorSection(
        '❓ NEEDS REVIEW', 
        'We couldn\'t automatically classify these vendors',
        unknown,
        'muted'
      );
    }

    // Primes Section (usually not marked as channels)
    if (primes.length > 0) {
      html += this.renderVendorSection(
        '🏢 LIKELY PRIMES/SIs',
        'These appear to be system integrators or large primes',
        primes,
        'muted'
      );
    }

    list.innerHTML = html;
  },

  renderVendorSection(title, description, vendors, colorClass) {
    const colorMap = {
      'success': 'var(--success)',
      'accent': 'var(--accent)',
      'muted': '#666'
    };
    const borderColor = colorMap[colorClass] || '#666';
    
    return `
      <div style="margin-bottom: 1.5rem;">
        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
          <span style="font-size: 0.8rem; font-weight: 700; color: ${borderColor}; text-transform: uppercase; letter-spacing: 0.5px;">
            ${title}
          </span>
          <span style="font-size: 0.7rem; color: #666;">(${vendors.length})</span>
        </div>
        <div style="font-size: 0.75rem; color: #888; margin-bottom: 0.75rem;">${description}</div>
        <div style="border: 1px solid var(--border); border-radius: 6px; overflow: hidden; border-left: 3px solid ${borderColor};">
          ${vendors.map(v => this.renderVendorRow(v)).join('')}
        </div>
      </div>
    `;
  },

  renderVendorRow(v) {
    const isMarked = this.isChannel(v.vendor);
    return `
      <div class="vendor-list-item" style="border-bottom: 1px solid var(--border); padding: 0.6rem 0.75rem;">
        <div class="vendor-info" style="flex: 1;">
          <div class="vendor-name" style="font-size: 0.85rem; font-weight: 600; color: #fff;">${v.vendor}</div>
          <div class="vendor-stats" style="font-size: 0.7rem; color: #888;">
            ${v.contractCount} contracts • ${Utils.money(v.spend)} • ${v.marketShare}% share
          </div>
        </div>
        <div class="vendor-toggle" style="display: flex; align-items: center; gap: 0.5rem;">
          <div class="toggle-switch ${isMarked ? 'active' : ''}" onclick="SalesPlanManager.toggleItem('${v.vendor.replace(/'/g, "\\'")}', this)">
            <div class="toggle-slider"></div>
          </div>
          <div class="toggle-label" style="font-size: 0.7rem; width: 70px; color: ${isMarked ? 'var(--success)' : '#888'};">
            ${isMarked ? 'Channel' : 'Competitor'}
          </div>
        </div>
      </div>
    `;
  },

  toggleItem(vendorName, element) {
    this.toggleChannel(vendorName);
    const toggle = element;
    const label = element.nextElementSibling;
    const isNowChannel = this.isChannel(vendorName);
    
    if (isNowChannel) {
      toggle.classList.add('active');
      label.textContent = 'Channel';
      label.style.color = 'var(--success)';
    } else {
      toggle.classList.remove('active');
      label.textContent = 'Competitor';
      label.style.color = '#888';
    }
    
    // Re-render to move items between sections
    setTimeout(() => this.renderSmartVendorList(), 300);
  },

  // Legacy method for compatibility
  renderList() {
    this.renderSmartVendorList();
  }
};
// ==================== APP CORE ====================
const App = {
  mode: 'search', 
  currentQuery: '',
  searchData: { raw: [], active: [], filter: null, loaded: false },
  forecastData: { spending: null, agencies: null, awards: null, analysis: null, loaded: false },
  drillState: { level: 0, path: [], currentAgency: null, currentSubAgency: null },

  init() {
    SalesPlanManager.init();
    
    // Event Listeners
    document.getElementById('searchBtn').onclick = () => App.runSearch();
    document.getElementById('forecastBtn').onclick = () => App.runForecast();
    document.getElementById('mainSearchInput').addEventListener('keypress', e => { if(e.key === 'Enter') App.runSearch(); });
    document.getElementById('miniSearch').addEventListener('keypress', e => { if(e.key === 'Enter') { document.getElementById('mainSearchInput').value = e.target.value; App.mode === 'forecast' ? App.runForecast(e.target.value) : App.runSearch(e.target.value); } });
    window.addEventListener('resize', () => { setTimeout(() => { if(App.searchData.active.length > 0 && App.mode === 'search') App.renderSankey(); }, 200); });

    const params = new URLSearchParams(window.location.search);
    const q = params.get('q');
    const mode = params.get('mode');

    if (q) {
      document.getElementById('mainSearchInput').value = q;
      
      if (mode === 'forecast') {
        App.runForecast(q);
      } else {
        App.runSearch(q);
      }
    }
  },

  showHero() {
    document.getElementById('appView').style.display = 'none';
    const hero = document.getElementById('heroView'); hero.style.display = 'flex'; hero.classList.remove('hidden');
    setTimeout(() => hero.classList.remove('slide-up'), 10);
  },

  setMode(mode) {
    App.mode = mode;
    document.getElementById('modeSearchBtn').classList.toggle('active', mode === 'search');
    document.getElementById('modeForecastBtn').classList.toggle('active', mode === 'forecast');
    document.getElementById('searchModeView').classList.toggle('active', mode === 'search');
    document.getElementById('forecastModeView').classList.toggle('active', mode === 'forecast');
    if(App.currentQuery) {
      if(mode === 'search' && !App.searchData.loaded) App.runSearch(App.currentQuery);
      else if(mode === 'forecast' && !App.forecastData.loaded) App.runForecast(App.currentQuery);
    }
  },

  toggleMode() { App.setMode(App.mode === 'search' ? 'forecast' : 'search'); },

  // --- Search Mode ---
  async runSearch(val) {
    const query = val || document.getElementById('mainSearchInput').value; if(!query) return;
    if(query !== App.currentQuery) { App.searchData = { raw: [], active: [], filter: null, loaded: false }; App.forecastData = { loaded: false }; App.resetDrill(); }
    App.currentQuery = query; App.mode = 'search'; App.showLoader('RETRIEVING DATA...', 'Searching USASpending API');
    try {
      App.searchData.raw = await API.searchAwards(query); App.searchData.active = App.searchData.raw; App.searchData.loaded = true;
      App.transitionToApp(); App.setMode('search'); App.updateSearchDashboard(); requestAnimationFrame(() => App.renderSankey());
    } catch(e) { console.error(e); alert("Error retrieving data."); } finally { App.hideLoader(); }
  },

  updateSearchDashboard() {
    const data = App.searchData.active;
    document.getElementById('stat-vol').innerText = Utils.money(data.reduce((acc, c) => acc + (c['Award Amount']||0), 0));
    document.getElementById('stat-count').innerText = data.length;
    document.getElementById('stat-vendors').innerText = new Set(data.map(c => c['Recipient Name'])).size;
    document.getElementById('stat-agencies').innerText = new Set(data.map(c => c['Awarding Agency'])).size;
    const badge = document.getElementById('filterBadge');
    if (App.searchData.filter) { badge.style.display = 'inline-flex'; document.getElementById('filterName').innerText = App.searchData.filter; } else badge.style.display = 'none';
    App.renderFeed(); App.updateDrillUI();
  },

  // --- Drill Down Logic ---
  resetDrill() { App.drillState = { level: 0, path: [], currentAgency: null, currentSubAgency: null }; App.searchData.filter = null; App.searchData.active = App.searchData.raw; App.updateSearchDashboard(); App.renderSankey(); },
  
  updateDrillUI() {
    const bc = document.getElementById('drillBreadcrumb'); const hint = document.getElementById('drillHint'); const lvl = document.getElementById('drillLevelBadge');
    if (App.drillState.level === 0) {
      bc.style.display = 'none'; hint.style.display = 'flex'; lvl.style.display = 'none'; document.getElementById('subagencyPanel').style.display = 'none';
      hint.innerHTML = `<i class="fas fa-mouse-pointer"></i><span>Click an <strong>agency bar</strong> to drill into sub-agencies</span>`;
    } else {
      bc.style.display = 'flex'; lvl.style.display = 'inline-flex';
      let html = `<div class="breadcrumb-item" onclick="App.resetDrill()"><i class="fas fa-globe breadcrumb-icon"></i><span>All Agencies</span></div>`;
      App.drillState.path.forEach((p, i) => html += `<span class="breadcrumb-separator"><i class="fas fa-chevron-right"></i></span><div class="breadcrumb-item ${i===App.drillState.path.length-1?'active':''}" onclick="${i===App.drillState.path.length-1?'':`App.drillToLevel(${i+1})`}"><span>${Utils.trunc(p.name, 25)}</span></div>`);
      bc.innerHTML = html; document.getElementById('drillLevelText').innerText = App.drillState.level === 1 ? 'Agency View' : 'Sub-Agency View';
      if (App.drillState.level === 1) { hint.innerHTML = `<i class="fas fa-layer-group"></i><span>Click a <strong>sub-agency</strong> to see vendor breakdown</span>`; App.renderSubAgencyPanel(); }
      else { document.getElementById('subagencyPanel').style.display = 'none'; hint.innerHTML = `<i class="fas fa-check-circle" style="color:var(--success)"></i><span>Viewing vendor breakdown</span>`; }
    }
  },

  renderSubAgencyPanel() {
    const list = document.getElementById('subagencyList');
    const contracts = App.searchData.raw.filter(d => d['Awarding Agency'] === App.drillState.currentAgency);
    const map = {}; contracts.forEach(c => { const sa = c['Awarding Sub Agency'] || 'Unknown'; map[sa] = map[sa] || {amount:0, count:0}; map[sa].amount += c['Award Amount']||0; map[sa].count++; });
    const subs = Object.entries(map).map(([k,v]) => ({name:k, ...v})).sort((a,b) => b.amount - a.amount);
    document.getElementById('subagencyParentName').innerText = Utils.trunc(App.drillState.currentAgency, 40);
    document.getElementById('subagencyTotalAmount').innerText = Utils.money(subs.reduce((s,x)=>s+x.amount,0));
    document.getElementById('subagencyCount').innerText = subs.length;
    list.innerHTML = subs.map((s,i) => `<div class="subagency-item" onclick="App.drillToSubAgency('${s.name.replace(/'/g, "\\'")}')"><div class="subagency-item-left"><div class="subagency-rank ${i<3?'top-3':''}">${i+1}</div><div class="subagency-info"><div class="subagency-name">${s.name}</div><div class="subagency-contracts">${s.count} contracts</div></div></div><div class="subagency-item-right"><div class="subagency-bar-container"><div class="subagency-bar" style="width:${(s.amount/subs[0].amount)*100}%"></div></div><div class="subagency-amount">${Utils.money(s.amount)}</div><i class="fas fa-chevron-right subagency-drill-icon"></i></div></div>`).join('');
    document.getElementById('subagencyPanel').style.display = 'block';
  },

  drillToAgency(name) { App.drillState = { level: 1, currentAgency: name, currentSubAgency: null, path: [{type:'agency', name}] }; App.searchData.active = App.searchData.raw.filter(d => d['Awarding Agency'] === name); App.searchData.filter = name; App.updateSearchDashboard(); App.renderSankey(); },
  drillToSubAgency(name) { App.drillState.level = 2; App.drillState.currentSubAgency = name; App.drillState.path = [{type:'agency', name:App.drillState.currentAgency}, {type:'sub', name}]; App.searchData.active = App.searchData.raw.filter(d => d['Awarding Agency']===App.drillState.currentAgency && d['Awarding Sub Agency']===name); App.searchData.filter = name; App.updateSearchDashboard(); App.renderSankey(); },
  drillToLevel(lvl) { if(lvl===1) App.drillToAgency(App.drillState.path[0].name); else App.resetDrill(); },
  drillDown(name) {
    if (App.searchData.raw.some(d => d['Awarding Agency'] === name) && App.drillState.level === 0) App.drillToAgency(name);
    else if (App.searchData.raw.some(d => d['Awarding Sub Agency'] === name) && App.drillState.level === 1) App.drillToSubAgency(name);
    else { App.searchData.filter = name; App.searchData.active = App.searchData.active.filter(d => d['Recipient Name'] === name); App.updateSearchDashboard(); App.renderSankey(); }
  },
  clearFilter() { App.drillState.level > 0 ? App.resetDrill() : (App.searchData.filter = null, App.searchData.active = App.searchData.raw, App.updateSearchDashboard(), App.renderSankey()); },

  renderSankey() {
    const container = document.getElementById('chartContainer'); container.innerHTML = '';
    const data = App.searchData.active; if(!data.length) { container.innerHTML = '<div style="text-align:center; padding:4rem; color:#666">No data</div>'; return; }
    container.innerHTML = '<svg id="sankeySvg"></svg>';
    const isLvl0 = App.drillState.level === 0;
    const flowMap = {}; data.forEach(d => { if(d['Award Amount']>0) flowMap[(isLvl0 ? d['Awarding Agency'] : d['Awarding Sub Agency'] || 'Unknown') + "|||" + (d['Recipient Name'] || 'Unknown')] = (flowMap[(isLvl0 ? d['Awarding Agency'] : d['Awarding Sub Agency'] || 'Unknown') + "|||" + (d['Recipient Name'] || 'Unknown')] || 0) + d['Award Amount']; });
    const allFlows = Object.entries(flowMap).sort((a,b)=>b[1]-a[1]); const limit = App.drillState.level > 0 ? 50 : 25;
    const topFlows = allFlows.slice(0, limit); const tailFlows = allFlows.slice(limit);
    const nodesSet = new Set(); const links = [];
    topFlows.forEach(([k,v]) => { const [s,t] = k.split("|||"); nodesSet.add(s); nodesSet.add(t); links.push({source:s, target:t, value:v}); });
    if(tailFlows.length) { const aggs={}; tailFlows.forEach(([k,v]) => { const [s] = k.split("|||"); if(nodesSet.has(s)) aggs[s] = (aggs[s]||0)+v; }); Object.entries(aggs).forEach(([s,v]) => { const n = `Other (${tailFlows.length})`; nodesSet.add(n); links.push({source:s, target:n, value:v}); }); }
    
    const nodes = Array.from(nodesSet).map(n=>({name:n})); const nodeMap = new Map(nodes.map((n,i)=>[n.name,i]));
    const d3Links = links.map(l=>({source:nodeMap.get(l.source), target:nodeMap.get(l.target), value:l.value}));
    const w = container.offsetWidth || 800; const h = Math.max(500, nodes.length * 30);
    const svg = d3.select("#sankeySvg").attr("width", w).attr("height", h);
    const sankey = d3.sankey().nodeId(d=>d.index).nodeWidth(20).nodePadding(20).extent([[1,1],[w-1,h-6]]);
    const {nodes:gn, links:gl} = sankey({nodes:nodes.map(d=>Object.assign({},d)), links:d3Links.map(d=>Object.assign({},d))});
    
    const isDrillable = n => !n.startsWith('Other') && (App.drillState.level===0 ? App.searchData.raw.some(d=>d['Awarding Agency']===n) : App.drillState.level===1 && App.searchData.raw.some(d=>d['Awarding Sub Agency']===n));

    svg.append("g").selectAll("rect").data(gn).join("rect")
       .attr("x",d=>d.x0).attr("y",d=>d.y0).attr("height",d=>d.y1-d.y0).attr("width",d=>d.x1-d.x0)
       .attr("fill",d=>Utils.getColor(d.name)).attr("opacity",0.8)
       .attr("stroke",d=>isDrillable(d.name)?'var(--accent)':'none').attr("stroke-width",d=>isDrillable(d.name)?2:0)
       .style("cursor",d=>isDrillable(d.name)?"pointer":"default")
       .on("click",(e,d)=>{if(isDrillable(d.name))App.drillDown(d.name)})
       .append("title").text(d=>`${d.name}\n${Utils.money(d.value)}`);

    const defs = svg.append("defs");
    gl.forEach((l,i) => { const g = defs.append("linearGradient").attr("id","g"+i).attr("gradientUnits","userSpaceOnUse").attr("x1",l.source.x1).attr("x2",l.target.x0); g.append("stop").attr("offset","0%").attr("stop-color",Utils.getColor(l.source.name)); g.append("stop").attr("offset","100%").attr("stop-color",Utils.getColor(l.target.name)); });
    
    svg.append("g").attr("fill","none").selectAll("path").data(gl).join("path")
       .attr("d",d3.sankeyLinkHorizontal()).attr("stroke",(d,i)=>"url(#g"+i+")").attr("stroke-width",d=>Math.max(1,d.width)).attr("stroke-opacity",0.4);
    
    svg.append("g").selectAll("text").data(gn).join("text")
       .attr("x",d=>d.x0<w/2?d.x1+6:d.x0-6).attr("y",d=>(d.y1+d.y0)/2).attr("dy","0.35em")
       .attr("text-anchor",d=>d.x0<w/2?"start":"end").text(d=>Utils.trunc(d.name,40))
       .style("font-size","11px").style("fill","#fff").style("pointer-events","none");
  },

  renderFeed() {
    const div = document.getElementById('feedGrid');
    const data = App.searchData.active;
    if(data.length === 0) { div.innerHTML = '<div style="text-align:center; padding:2rem; color:#666">No contracts found.</div>'; return; }
    
    div.innerHTML = data.map(c => {
      const internalId = c['generated_internal_id'];
      let url = '#';
      if (internalId) url = `https://www.usaspending.gov/award/${internalId}`;
      else if (c['Award ID']) url = `https://www.usaspending.gov/search/?hash=&filters=${encodeURIComponent(JSON.stringify({keyword: c['Award ID']}))}`;
      
      let metaTags = '';
      if (c['NAICS Code']) metaTags += `<span class="meta-tag naics" title="${c['NAICS Description'] || ''}">NAICS: ${c['NAICS Code']}</span>`;
      if (c['PSC Code']) metaTags += `<span class="meta-tag psc" title="${c['PSC Description'] || ''}">PSC: ${c['PSC Code']}</span>`;
      
      const subAgency = c['Awarding Sub Agency'];
      const agencyDisplay = subAgency && subAgency !== c['Awarding Agency'] 
        ? `${Utils.trunc(c['Awarding Agency'], 20)} → ${Utils.trunc(subAgency, 20)}` 
        : Utils.trunc(c['Awarding Agency'], 35);

      return `<div class="deal-card">
        <div class="deal-header"><span class="deal-agency">${agencyDisplay}</span><span class="deal-amount">${Utils.money(c['Award Amount'])}</span></div>
        <div class="deal-desc">${Utils.trunc(c['Description'], 100)}</div>
        <div class="deal-vendor">${c['Recipient Name']}</div>
        ${metaTags ? `<div class="deal-meta">${metaTags}</div>` : ''}
        <div class="deal-footer"><span class="deal-date">Start: ${Utils.date(c['Start Date'])}${c['End Date'] ? ' → ' + Utils.date(c['End Date']) : ''}</span><a href="${url}" target="_blank" class="action-btn">OPEN AWARD <i class="fas fa-external-link-alt"></i></a></div>
      </div>`;
    }).join('');
  },

// --- Forecast Mode ---
  async runForecast(val) {
    const query = val || document.getElementById('mainSearchInput').value; if(!query) return;
    
    // Reset data if query changed
    if(query !== App.currentQuery) { 
      App.searchData = { loaded:false }; 
      App.forecastData = { spending:null, agencies:null, awards:null, analysis:null, loaded:false }; 
    }
    
    const cs = Chart.getChart("spendingChart"); if(cs) cs.destroy();
    App.currentQuery = query; 
    App.mode = 'forecast'; 
    App.showLoader('CRUNCHING NUMBERS...', 'Applying Recency-Weighted Seasonality');
    
    try {
      const [spending, agencies, awards] = await Promise.all([
        API.getSpendingOverTime(query), 
        API.getAgencyData(query), 
        API.getAwardsForForecast(query)
      ]);
      
      App.forecastData = { 
        spending, 
        agencies, 
        awards, 
        analysis: ForecastEngine.analyze(spending, awards, agencies), 
        loaded: true 
      };
      
      App.transitionToApp(); 
      App.setMode('forecast'); 
      App.renderForecastDashboard();
      
    } catch(e) { 
      console.error(e); 
      App.showToast("Error fetching forecast data.", "error"); 
    } finally { 
      App.hideLoader(); 
    }
  },

renderForecastDashboard() {
    const analysis = App.forecastData.analysis; 
    const awards = App.forecastData.awards; 
    if(!analysis) return;
    
    // Update Stat Blocks
    document.getElementById('stat-baseline').innerText = Utils.money(analysis.baseline);
    document.getElementById('stat-market').innerText = analysis.marketStatus;
    document.getElementById('stat-hhi').innerText = `HHI: ${analysis.hhi}`;
    
    let peakQ=1, peakV=0; 
    for(let q=1; q<=4; q++) if(analysis.indices[q]>peakV) { peakV=analysis.indices[q]; peakQ=q; }
    document.getElementById('stat-peak').innerText = `Q${peakQ}`;
    document.getElementById('stat-recompetes').innerText = analysis.recompetes.length;
    
    // Insights Grid
    const insightsDiv = document.getElementById('marketInsights');
    insightsDiv.innerHTML = `
      <div class="insight-card">
        <div class="insight-label">Market Concentration</div>
        <div class="insight-val" style="color:${analysis.hhi>2500?'var(--danger)':'var(--success)'}">${analysis.marketStatus}</div>
        <div style="font-size:0.8rem; color:#666; margin-top:5px">HHI Score: ${analysis.hhi}</div>
      </div>
      
      <div class="insight-card">
        <div class="insight-label">Top Incumbent</div>
        <div class="insight-val" style="font-size:0.9rem">${Utils.trunc(awards[0]?awards[0]['Recipient Name']:'Unknown', 30)}</div>
      </div>

      <div class="insight-card sales-plan-card" onclick="SalesPlanManager.open()">
        <div class="sales-plan-card-icon"><i class="fas fa-file-export"></i></div>
        <div class="sales-plan-card-title">Generate Sales Strategy Prompt</div>
        <div class="sales-plan-card-subtitle">
          Create an AI prompt package from these results you can paste into your preferred AI tool (ChatGPT, Claude, Gemini, etc.) to build an Annual Sales Plan.
        </div>
      </div>
    `;

    // Forecast Table
    const tb = document.getElementById('forecastTableBody'); 
    tb.innerHTML = '';
    analysis.forecasts.forEach(f => {
      const isUp = f.trend.includes('+'); 
      const color = f.confidence.label === 'High' ? 'var(--success)' : (f.confidence.label === 'Med' ? '#FDD835' : '#888');
      
      tb.innerHTML += `
        <tr>
          <td><b>${f.period}</b></td>
          <td style="color:var(--accent); font-weight:700">${Utils.money(f.predicted)}</td>
          <td style="color:#666">${Utils.money(f.histAvg)}</td>
          <td><span class="trend-pill ${isUp?'trend-up':'trend-down'}">${isUp?'▲':'▼'} ${f.trend}%</span></td>
          <td>
            <div style="color:${color}; font-weight:700;">${f.confidence.label}</div>
            <div style="font-size:0.65rem; color:#666;">${f.confidence.reason}</div>
          </td>
        </tr>`;
    });
    
    // Render Chart
    const ctx = document.getElementById('spendingChart').getContext('2d');
    const years = Object.keys(analysis.byFY).sort();
    
    new Chart(ctx, {
      type: 'bar',
      data: { 
        labels: years.map(y=>`FY${y}`), 
        datasets: [
          { label:'Q1', data:years.map(y=>analysis.byFY[y][1]||0), backgroundColor:'#958BB6' }, 
          { label:'Q2', data:years.map(y=>analysis.byFY[y][2]||0), backgroundColor:'#6F8A74' }, 
          { label:'Q3', data:years.map(y=>analysis.byFY[y][3]||0), backgroundColor:'#8FB6D0' }, 
          { label:'Q4', data:years.map(y=>analysis.byFY[y][4]||0), backgroundColor:'#C27E5C' }
        ] 
      },
      options: { 
        responsive:true, 
        maintainAspectRatio:false, 
        scales:{ x:{grid:{display:false}}, y:{grid:{color:'#333'}} }, 
        plugins:{ legend:{labels:{color:'#888'}} } 
      }
    });

    // Render Strategy Section
    const strat = analysis.strategy;
    if(strat) {
      document.getElementById('strategySection').style.display = 'block';
      document.getElementById('strat-outlook').innerText = strat.title;
      document.getElementById('strat-text').innerText = strat.text;
      document.getElementById('strat-action').innerText = strat.action;
      document.getElementById('matrix-bd').innerText = strat.matrix.bd;
      document.getElementById('matrix-strat').innerText = strat.matrix.strat;
      document.getElementById('matrix-pipe').innerText = strat.matrix.pipe;
    }
    
    // Render Recompetes List
    document.getElementById('recompetesList').innerHTML = analysis.recompetes.length ? 
      `<div class="section-header"><div class="section-title-group"><i class="fas fa-exclamation-triangle" style="color:var(--danger)"></i><span class="section-title" style="color:var(--danger)">Recompete Opportunities</span></div></div>` + 
      analysis.recompetes.map(r => `
        <div class="deal-card" style="margin-bottom:1rem">
          <div class="deal-header">
            <span class="deal-agency">${Utils.trunc(r['Awarding Agency'],40)}</span>
            <span class="deal-amount">${Utils.money(r['Award Amount'])}</span>
          </div>
          <div class="deal-desc">${Utils.trunc(r['Description'],80)}</div>
          <div style="font-size:0.8rem; color:var(--danger)">Expires: ${Utils.date(r['End Date'])}</div>
          <div style="font-size:0.8rem; color:#666">${r['Recipient Name']}</div>
        </div>`).join('') 
      : '';
  },
// --- Helpers ---
  exportCSV(btn) {
    const data = App.mode === 'search' ? App.searchData.active : (App.forecastData.awards || []);
    
    // IF NO DATA: Flash Red (Error)
    if (!data.length) {
      if (btn) {
        const originalHtml = btn.innerHTML;
        btn.style.color = 'var(--danger)';
        btn.style.borderColor = 'var(--danger)';
        btn.innerHTML = '<i class="fas fa-times"></i>'; // Switch to X icon
        setTimeout(() => {
          btn.style.color = '';
          btn.style.borderColor = '';
          btn.innerHTML = originalHtml;
        }, 2000);
      }
      return;
    }
    
    // Detailed Headers
    const headers = ['Recipient', 'Agency', 'Sub-Agency', 'Amount', 'Description', 'Start Date', 'End Date', 'Award ID', 'Award Link'];
    
    const rows = data.map(c => {
      const internalId = c['generated_internal_id']; 
      let awardUrl = '';
      if (internalId) awardUrl = `https://www.usaspending.gov/award/${internalId}`;
      else if (c['Award ID']) awardUrl = `https://www.usaspending.gov/search/?hash=&filters=${encodeURIComponent(JSON.stringify({keyword: c['Award ID']}))}`;
      
      return [
        `"${(c['Recipient Name'] || '').replace(/"/g, '""')}"`, 
        `"${(c['Awarding Agency'] || '').replace(/"/g, '""')}"`, 
        `"${(c['Awarding Sub Agency'] || '').replace(/"/g, '""')}"`, 
        c['Award Amount'] || 0, 
        `"${(c['Description'] || '').replace(/"/g, '""')}"`, 
        c['Start Date'] || '', 
        c['End Date'] || '', 
        c['Award ID'] || '', 
        awardUrl
      ];
    });
    
    const csvContent = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a"); 
    link.setAttribute("href", url); 
    link.setAttribute("download", `govhoo_${App.mode}_${App.currentQuery}.csv`);
    document.body.appendChild(link); link.click(); document.body.removeChild(link);

    // SUCCESS: Flash Green
    if (btn) {
      const originalHtml = btn.innerHTML;
      btn.style.color = 'var(--success)';
      btn.style.borderColor = 'var(--success)';
      btn.innerHTML = '<i class="fas fa-check"></i>'; // Switch to Checkmark
      setTimeout(() => {
        btn.style.color = '';
        btn.style.borderColor = '';
        btn.innerHTML = originalHtml;
      }, 2000);
    }
  },

  showLoader(text, subtext) { document.getElementById('loaderText').innerText = text; document.getElementById('loaderSubtext').innerText = subtext || ''; document.getElementById('loader').style.display = 'flex'; },
  hideLoader() { document.getElementById('loader').style.display = 'none'; },
  transitionToApp() {
    const hero = document.getElementById('heroView'); hero.classList.add('slide-up');
    document.getElementById('appView').style.display = 'block'; document.getElementById('miniSearch').value = App.currentQuery;
    document.getElementById('dashboardContainer').classList.add('active'); setTimeout(() => { hero.style.display = 'none'; hero.classList.add('hidden'); }, 500);
  },
  
  shareLink(btn) {
    const url = new URL(window.location); url.searchParams.set('q', App.currentQuery); url.searchParams.set('mode', App.mode);
    navigator.clipboard.writeText(url.toString()).then(() => {
      // SUCCESS: Flash Green
      if (btn) {
        const originalHtml = btn.innerHTML;
        btn.style.color = 'var(--success)';
        btn.style.borderColor = 'var(--success)';
        btn.innerHTML = '<i class="fas fa-check"></i>'; // Switch to Checkmark
        setTimeout(() => {
          btn.style.color = '';
          btn.style.borderColor = '';
          btn.innerHTML = originalHtml;
        }, 2000);
      }
    });
  }
};

// ==================== IMPROVED PROMPT PACKAGE GENERATOR ====================
// This version:
// 1. Classifies search intent (own company, competitor, partner, keyword, agency)
// 2. Utilizes ALL available data from search and forecast modes
// 3. Generates context-aware prompts with clear strategic intention

const PromptPackageGenerator = {
  
  // ==================== SEARCH INTENT CLASSIFICATION ====================
  classifySearchIntent(query, data, userMarkedChannels) {
    /*
     * Determines what the user searched for and their likely strategic intent.
     * Returns: { type, confidence, details }
     * 
     * Types:
     * - 'own_company': User searched for their own company
     * - 'competitor': User searched for a competitor to analyze
     * - 'partner': User searched for a channel/partner relationship
     * - 'agency': User searched for a specific agency/customer
     * - 'product_oem': User searched for a product/software they sell (OEM/ISV perspective)
     * - 'market_keyword': User searched for a market/technology area
     */
    
    const queryLower = query.toLowerCase().trim();
    
    // Extract top entities from data
    const vendorSpend = {};
    const agencySpend = {};
    let totalValue = 0;
    
    data.forEach(r => {
      const vendor = r['Recipient Name'] || 'Unknown';
      const agency = r['Awarding Agency'] || 'Unknown';
      const amt = parseFloat(r['Award Amount']) || 0;
      vendorSpend[vendor] = (vendorSpend[vendor] || 0) + amt;
      agencySpend[agency] = (agencySpend[agency] || 0) + amt;
      totalValue += amt;
    });
    
    const topVendors = Object.entries(vendorSpend)
      .map(([name, spend]) => ({ name, spend, share: (spend / totalValue * 100), isChannel: userMarkedChannels.has(name) }))
      .sort((a, b) => b.spend - a.spend);
    
    const topAgencies = Object.entries(agencySpend)
      .map(([name, spend]) => ({ name, spend, share: (spend / totalValue * 100) }))
      .sort((a, b) => b.spend - a.spend);
    
    // Calculate channel vs non-channel breakdown
    const channelVendors = topVendors.filter(v => v.isChannel);
    const nonChannelVendors = topVendors.filter(v => !v.isChannel);
    const channelShare = channelVendors.reduce((sum, v) => sum + v.share, 0);
    const nonChannelShare = nonChannelVendors.reduce((sum, v) => sum + v.share, 0);
    
    // Check if query matches a specific vendor name (exact or fuzzy)
    const matchingVendor = topVendors.find(v => 
      v.name.toLowerCase().includes(queryLower) || 
      queryLower.includes(v.name.toLowerCase().split(' ')[0])
    );
    
    // Check if query matches a specific agency
    const matchingAgency = topAgencies.find(a => 
      a.name.toLowerCase().includes(queryLower) || 
      queryLower.includes(a.name.toLowerCase().replace('department of ', ''))
    );
    
    // Check if query is a known market keyword
    const marketKeywords = [
      'cyber', 'cloud', 'ai', 'artificial intelligence', 'machine learning', 'ml',
      'data', 'analytics', 'software', 'it services', 'infrastructure',
      'network', 'security', 'zero trust', 'devops', 'devsecops',
      'modernization', 'digital', 'transformation', 'agile', 'sap', 'oracle',
      'healthcare', 'logistics', 'training', 'simulation', 'c4isr',
      'satellite', 'space', 'communications', 'mobility', 'wireless'
    ];
    
    const isMarketKeyword = marketKeywords.some(kw => queryLower.includes(kw));
    
    // === NEW: Detect Product/OEM search ===
    // If most vendors are marked as channels, this is likely a product search
    // (e.g., searching "Sonatype" where all vendors are resellers of Sonatype products)
    if (channelShare > 70 && channelVendors.length >= 3) {
      return {
        type: 'product_oem',
        confidence: 'high',
        details: {
          productName: query,
          totalMarketValue: totalValue,
          channelCount: channelVendors.length,
          channelShare: channelShare.toFixed(1),
          topChannel: channelVendors[0]?.name,
          topChannelShare: channelVendors[0]?.share.toFixed(1),
          agencyCount: topAgencies.length,
          topAgency: topAgencies[0]?.name,
          topAgencyShare: topAgencies[0]?.share.toFixed(1),
          // Non-channel vendors might be direct sales or competitors
          directSalesCount: nonChannelVendors.length,
          directSalesShare: nonChannelShare.toFixed(1)
        }
      };
    }
    
    // Determine intent
    if (matchingVendor && matchingVendor.share > 30) {
      // Dominant single vendor - likely searching for own company or major competitor
      const isChannel = userMarkedChannels.has(matchingVendor.name);
      if (isChannel) {
        return {
          type: 'partner',
          confidence: 'high',
          details: {
            entityName: matchingVendor.name,
            entityShare: matchingVendor.share.toFixed(1),
            entityValue: matchingVendor.spend,
            relationship: 'Marked as channel/partner'
          }
        };
      }
      // If they searched their own company name, they want competitive intel
      return {
        type: 'own_company',
        confidence: 'medium',
        details: {
          entityName: matchingVendor.name,
          entityShare: matchingVendor.share.toFixed(1),
          entityValue: matchingVendor.spend,
          suggestion: 'If this is YOUR company, the plan will focus on defending position. If a COMPETITOR, mark as such in settings.'
        }
      };
    }
    
    if (matchingVendor && matchingVendor.share > 5) {
      // Specific vendor but not dominant - likely competitor research
      return {
        type: 'competitor',
        confidence: 'medium',
        details: {
          entityName: matchingVendor.name,
          entityShare: matchingVendor.share.toFixed(1),
          entityValue: matchingVendor.spend,
          competitorCount: topVendors.filter(v => v.share > 1).length
        }
      };
    }
    
    if (matchingAgency) {
      // Agency-focused search
      return {
        type: 'agency',
        confidence: 'high',
        details: {
          entityName: matchingAgency.name,
          entityShare: matchingAgency.share.toFixed(1),
          entityValue: matchingAgency.spend,
          vendorCount: new Set(data.filter(r => r['Awarding Agency'] === matchingAgency.name).map(r => r['Recipient Name'])).size
        }
      };
    }
    
    if (isMarketKeyword || topVendors.length > 5) {
      // Market/technology keyword search
      return {
        type: 'market_keyword',
        confidence: 'high',
        details: {
          keyword: query,
          totalMarketValue: totalValue,
          vendorCount: topVendors.length,
          agencyCount: topAgencies.length,
          topVendor: topVendors[0]?.name,
          topAgency: topAgencies[0]?.name
        }
      };
    }
    
    // Default - treat as market exploration
    return {
      type: 'market_keyword',
      confidence: 'low',
      details: {
        keyword: query,
        totalMarketValue: totalValue,
        note: 'Search intent unclear - defaulting to market analysis'
      }
    };
  },

  // ==================== FULL DATA EXTRACTION ====================
  extractAllData(data, analysis, config = {}) {
    const curFY = Utils.getCurrentFY();
    const curQ = Utils.getCurrentQuarter();
    
    // === VENDOR ANALYSIS ===
    const vendorSpend = {};
    let totalMarketValue = 0;
    
    data.forEach(r => {
      const vendor = r['Recipient Name'] || 'Unknown';
      const amt = parseFloat(r['Award Amount']) || 0;
      if (!vendorSpend[vendor]) {
        vendorSpend[vendor] = { 
          spend: 0, 
          contracts: [], 
          agencies: new Set(),
          subAgencies: new Set(),
          naicsCodes: new Set(),
          pscCodes: new Set()
        };
      }
      vendorSpend[vendor].spend += amt;
      vendorSpend[vendor].contracts.push(r);
      if (r['Awarding Agency']) vendorSpend[vendor].agencies.add(r['Awarding Agency']);
      if (r['Awarding Sub Agency']) vendorSpend[vendor].subAgencies.add(r['Awarding Sub Agency']);
      
      // Handle NAICS - try multiple possible field names
      const naicsCode = r['NAICS Code'] || r['naics_code'] || r['NAICS'] || r['naics'];
      if (naicsCode) vendorSpend[vendor].naicsCodes.add(naicsCode);
      
      // Handle PSC - try multiple possible field names  
      const pscCode = r['PSC Code'] || r['psc_code'] || r['PSC'] || r['psc'] || r['Product Service Code'];
      if (pscCode) vendorSpend[vendor].pscCodes.add(pscCode);
      totalMarketValue += amt;
    });
    
    const allVendors = Object.entries(vendorSpend).map(([vendor, data]) => ({
      vendor,
      spend: data.spend,
      marketShare: ((data.spend / totalMarketValue) * 100).toFixed(2),
      contractCount: data.contracts.length,
      avgContractSize: data.spend / data.contracts.length,
      agencyDiversity: data.agencies.size,
      subAgencyReach: data.subAgencies.size,
      naicsCodes: Array.from(data.naicsCodes),
      pscCodes: Array.from(data.pscCodes),
      isChannel: SalesPlanManager.isChannel(vendor),
      // Calculate expiring contracts
      expiringContracts: data.contracts.filter(c => {
        if (!c['End Date']) return false;
        const monthsUntilEnd = (new Date(c['End Date']) - new Date()) / (1000 * 60 * 60 * 24 * 30);
        return monthsUntilEnd > 0 && monthsUntilEnd <= 18;
      }),
      // Calculate contract value at risk
      expiringValue: data.contracts.filter(c => {
        if (!c['End Date']) return false;
        const monthsUntilEnd = (new Date(c['End Date']) - new Date()) / (1000 * 60 * 60 * 24 * 30);
        return monthsUntilEnd > 0 && monthsUntilEnd <= 18;
      }).reduce((sum, c) => sum + (parseFloat(c['Award Amount']) || 0), 0)
    })).sort((a, b) => b.spend - a.spend);
    
    const competitors = allVendors.filter(v => !v.isChannel);
    const channels = allVendors.filter(v => v.isChannel);
    
    // === AGENCY ANALYSIS ===
    const agencyData = {};
    data.forEach(r => {
      const agency = r['Awarding Agency'] || 'Unknown';
      const subAgency = r['Awarding Sub Agency'] || 'General';
      const amt = parseFloat(r['Award Amount']) || 0;
      
      if (!agencyData[agency]) {
        agencyData[agency] = { 
          spend: 0, 
          contracts: [],
          subAgencies: {},
          topVendors: {}
        };
      }
      agencyData[agency].spend += amt;
      agencyData[agency].contracts.push(r);
      
      // Sub-agency breakdown
      if (!agencyData[agency].subAgencies[subAgency]) {
        agencyData[agency].subAgencies[subAgency] = { spend: 0, count: 0 };
      }
      agencyData[agency].subAgencies[subAgency].spend += amt;
      agencyData[agency].subAgencies[subAgency].count++;
      
      // Track vendors per agency
      const vendor = r['Recipient Name'] || 'Unknown';
      agencyData[agency].topVendors[vendor] = (agencyData[agency].topVendors[vendor] || 0) + amt;
    });
    
    const topAgencies = Object.entries(agencyData).map(([agency, d]) => ({
      agency,
      spend: d.spend,
      percentage: ((d.spend / totalMarketValue) * 100).toFixed(1),
      contractCount: d.contracts.length,
      subAgencyCount: Object.keys(d.subAgencies).length,
      subAgencies: Object.entries(d.subAgencies)
        .map(([name, data]) => ({ name, ...data }))
        .sort((a, b) => b.spend - a.spend)
        .slice(0, 5),
      topVendors: Object.entries(d.topVendors)
        .map(([name, spend]) => ({ name, spend }))
        .sort((a, b) => b.spend - a.spend)
        .slice(0, 3),
      incumbentVendor: Object.entries(d.topVendors).sort((a, b) => b[1] - a[1])[0]?.[0]
    })).sort((a, b) => b.spend - a.spend);
    
    // === RECOMPETE ANALYSIS ===
    const now = new Date();
    const recompetes = {
      immediate: [], // 0-6 months
      nearTerm: [],  // 6-12 months
      pipeline: []   // 12-18 months
    };
    
    data.forEach(r => {
      if (!r['End Date']) return;
      const endDate = new Date(r['End Date']);
      const monthsUntilEnd = (endDate - now) / (1000 * 60 * 60 * 24 * 30);
      
      if (monthsUntilEnd > 0 && monthsUntilEnd <= 6) {
        recompetes.immediate.push(r);
      } else if (monthsUntilEnd > 6 && monthsUntilEnd <= 12) {
        recompetes.nearTerm.push(r);
      } else if (monthsUntilEnd > 12 && monthsUntilEnd <= 18) {
        recompetes.pipeline.push(r);
      }
    });
    
    // Sort each by value
    Object.keys(recompetes).forEach(key => {
      recompetes[key].sort((a, b) => (b['Award Amount'] || 0) - (a['Award Amount'] || 0));
    });
    
    // === NAICS/PSC ANALYSIS ===
    const naicsBreakdown = {};
    const pscBreakdown = {};
    
    data.forEach(r => {
      // Handle multiple possible field names for NAICS
      const naics = r['NAICS Code'] || r['naics_code'] || r['NAICS'] || r['naics'];
      const naicsDesc = r['NAICS Description'] || r['naics_description'] || r['NAICS Desc'] || '';
      
      // Handle multiple possible field names for PSC
      const psc = r['PSC Code'] || r['psc_code'] || r['PSC'] || r['psc'] || r['Product Service Code'];
      const pscDesc = r['PSC Description'] || r['psc_description'] || r['PSC Desc'] || r['Product Service Description'] || '';
      
      const amt = parseFloat(r['Award Amount']) || 0;
      
      if (naics) {
        if (!naicsBreakdown[naics]) {
          naicsBreakdown[naics] = { code: naics, description: naicsDesc, spend: 0, count: 0 };
        }
        naicsBreakdown[naics].spend += amt;
        naicsBreakdown[naics].count++;
      }
      
      if (psc) {
        if (!pscBreakdown[psc]) {
          pscBreakdown[psc] = { code: psc, description: pscDesc, spend: 0, count: 0 };
        }
        pscBreakdown[psc].spend += amt;
        pscBreakdown[psc].count++;
      }
    });
    
    // === MARKET CONCENTRATION (HHI) ===
    // Calculate VENDOR concentration (who's winning the work)
    let vendorHHI = 0;
    allVendors.forEach(v => {
      const share = (v.spend / totalMarketValue) * 100;
      vendorHHI += share * share;
    });
    vendorHHI = Math.round(vendorHHI);
    
    // Calculate AGENCY concentration (who's buying)
    let agencyHHI = 0;
    topAgencies.forEach(a => {
      const share = parseFloat(a.percentage);
      agencyHHI += share * share;
    });
    agencyHHI = Math.round(agencyHHI);
    
    // Use vendor HHI for market assessment (more relevant for sales strategy)
    // But also note if analysis provided a different HHI (likely agency-based)
    const analysisHHI = analysis?.hhi || null;
    
    const marketConcentration = {
      vendorHHI,
      agencyHHI,
      analysisHHI, // From ForecastEngine (agency-based)
      // Use vendor HHI for status since it's more relevant for competitive strategy
      status: vendorHHI > 2500 ? 'Highly Concentrated' : vendorHHI > 1500 ? 'Moderately Concentrated' : 'Competitive',
      top3Share: competitors.slice(0, 3).reduce((s, v) => s + parseFloat(v.marketShare), 0).toFixed(1),
      top5Share: competitors.slice(0, 5).reduce((s, v) => s + parseFloat(v.marketShare), 0).toFixed(1),
      top10Share: competitors.slice(0, 10).reduce((s, v) => s + parseFloat(v.marketShare), 0).toFixed(1),
      vendorCount: allVendors.length,
      // Interpretation based on VENDOR concentration
      vendorInterpretation: vendorHHI > 2500 
        ? 'Vendor market dominated by few incumbents. Teaming or niche strategies required.'
        : vendorHHI > 1500 
          ? 'Moderate vendor competition. Both displacement and new opportunity strategies viable.'
          : 'Fragmented vendor landscape. Volume bidding and broad prospecting may succeed.',
      // Interpretation based on AGENCY concentration
      agencyInterpretation: agencyHHI > 2500
        ? 'Spending concentrated in few agencies. Deep account focus recommended.'
        : agencyHHI > 1500
          ? 'Moderate agency concentration. Balance depth and breadth.'
          : 'Spending spread across many agencies. Broad coverage strategy viable.'
    };
    
    // === FORECAST DATA (if available) ===
    let forecastInsights = null;
    if (analysis) {
      forecastInsights = {
        baseline: analysis.baseline,
        quarterlyForecasts: analysis.forecasts || [],
        seasonalIndices: analysis.indices || {},
        peakQuarter: this.getPeakQuarter(analysis),
        growthRate: this.calculateGrowthRate(analysis),
        historicalByFY: analysis.byFY || {},
        strategy: analysis.strategy || null,
        marketStatus: analysis.marketStatus || 'Unknown'
      };
      
      // Calculate YoY trends
      if (analysis.byFY) {
        const years = Object.keys(analysis.byFY).sort();
        if (years.length >= 2) {
          const currentFY = years[years.length - 1];
          const previousFY = years[years.length - 2];
          const currentTotal = Object.values(analysis.byFY[currentFY]).reduce((a, b) => a + b, 0);
          const previousTotal = Object.values(analysis.byFY[previousFY]).reduce((a, b) => a + b, 0);
          forecastInsights.yoyChange = previousTotal > 0 
            ? (((currentTotal - previousTotal) / previousTotal) * 100).toFixed(1)
            : null;
        }
      }
    }
    
    return {
      metadata: {
        generatedDate: new Date().toISOString(),
        fiscalYear: curFY,
        currentQuarter: curQ,
        marketQuery: App.currentQuery,
        totalContracts: data.length,
        totalMarketValue,
        channelsIdentified: channels.length,
        competitorsIdentified: competitors.length,
        dataSource: analysis ? 'Forecast Mode' : 'Search Mode',
        // Debug: sample of available fields from first record (helps identify field names)
        sampleFields: data.length > 0 ? Object.keys(data[0]) : []
      },
      marketConcentration,
      competitors: {
        all: competitors,
        top5: competitors.slice(0, 5),
        top10: competitors.slice(0, 10)
      },
      channels: {
        all: channels,
        totalValue: channels.reduce((s, c) => s + c.spend, 0)
      },
      agencies: {
        all: topAgencies,
        top5: topAgencies.slice(0, 5),
        top10: topAgencies.slice(0, 10)
      },
      recompetes,
      naicsBreakdown: Object.values(naicsBreakdown).sort((a, b) => b.spend - a.spend).slice(0, 10),
      pscBreakdown: Object.values(pscBreakdown).sort((a, b) => b.spend - a.spend).slice(0, 10),
      forecastInsights
    };
  },

  calculateGrowthRate(analysis) {
    if (!analysis || !analysis.byFY) return null;
    const years = Object.keys(analysis.byFY).map(Number).sort((a, b) => a - b);
    if (years.length < 2) return null;
    
    const curFY = Utils.getCurrentFY();
    const curQ = Utils.getCurrentQuarter();
    
    // Find the two most recent COMPLETE fiscal years (exclude current partial year)
    const completeYears = years.filter(y => y < curFY);
    
    if (completeYears.length >= 2) {
      // Compare two complete years
      const recentYear = completeYears[completeYears.length - 1];
      const priorYear = completeYears[completeYears.length - 2];
      const recentTotal = Object.values(analysis.byFY[recentYear]).reduce((a, b) => a + b, 0);
      const priorTotal = Object.values(analysis.byFY[priorYear]).reduce((a, b) => a + b, 0);
      
      if (priorTotal > 0) {
        return {
          value: (((recentTotal - priorTotal) / priorTotal) * 100).toFixed(1),
          comparison: `FY${recentYear} vs FY${priorYear}`,
          type: 'full_year'
        };
      }
    }
    
    // Fallback: Compare same quarters year-over-year if we have current year data
    if (years.includes(curFY) && years.includes(curFY - 1)) {
      // Sum only quarters that exist in BOTH years for fair comparison
      const currentYearData = analysis.byFY[curFY];
      const priorYearData = analysis.byFY[curFY - 1];
      
      let currentSum = 0;
      let priorSum = 0;
      let quartersCompared = [];
      
      for (let q = 1; q <= curQ; q++) {
        if (currentYearData[q] > 0 && priorYearData[q] > 0) {
          currentSum += currentYearData[q];
          priorSum += priorYearData[q];
          quartersCompared.push(`Q${q}`);
        }
      }
      
      if (priorSum > 0 && quartersCompared.length > 0) {
        return {
          value: (((currentSum - priorSum) / priorSum) * 100).toFixed(1),
          comparison: `FY${curFY} ${quartersCompared.join('+')} vs FY${curFY - 1} ${quartersCompared.join('+')}`,
          type: 'quarter_comparison'
        };
      }
    }
    
    return null;
  },

  getPeakQuarter(analysis) {
    if (!analysis || !analysis.indices) return null;
    let peakQ = 1, peakV = 0;
    for (let q = 1; q <= 4; q++) {
      if (analysis.indices[q] > peakV) {
        peakV = analysis.indices[q];
        peakQ = q;
      }
    }
    return { quarter: peakQ, index: (peakV * 100).toFixed(1) };
  },

  // ==================== STRATEGY INTERPRETATION BY INTENT ====================
  getStrategyInterpretation(searchIntent, strategy) {
    if (!strategy) return '';
    
    // Map generic strategy terms to intent-specific language
    const interpretations = {
      'product_oem': {
        header: '**How to interpret for OEM/Channel Sales:**',
        mappings: {
          'Incumbent Displacement': 'Protect renewals from competitive products; ensure partners are engaged before recompetes',
          'New Requirements': 'Identify agencies not yet using your product; expand partner coverage to white space',
          'Relationship Focus': 'Strengthen ties with top-performing partners; joint business planning with key accounts',
          'Volume Bidding': 'Enable more partners to quote; simplify pricing and reduce friction',
          'Validate & Assess': 'Verify partner pipeline accuracy; confirm renewals are tracked',
          'Selective Focus': 'Concentrate enablement on top partners; deprioritize low performers',
          'Maintain Steady': 'Continue current partner programs; monitor for competitive threats'
        }
      },
      'own_company': {
        header: '**How to interpret for your business:**',
        mappings: {
          'Incumbent Displacement': 'Competitors are targeting your contracts; strengthen customer relationships before recompetes',
          'New Requirements': 'Look for new opportunities beyond your current base',
          'Relationship Focus': 'Leverage existing customer relationships for sole-source or follow-on work',
          'Volume Bidding': 'Cast a wide net; pursue multiple opportunities to improve win rate odds',
          'Validate & Assess': 'Confirm your pipeline is real; verify funding and timing',
          'Selective Focus': 'Focus on highest-probability wins; don\'t spread resources thin',
          'Maintain Steady': 'Keep doing what\'s working; stay close to customers'
        }
      },
      'competitor': {
        header: '**How to interpret for competitive strategy:**',
        mappings: {
          'Incumbent Displacement': 'This competitor has contracts expiring - opportunity to displace them',
          'New Requirements': 'Market is growing with new opportunities not yet locked up',
          'Relationship Focus': 'Competitor relies on relationships; you need inside access to compete',
          'Volume Bidding': 'Many opportunities available; compete broadly against this player',
          'Validate & Assess': 'Verify this competitor is actually vulnerable before investing pursuit resources',
          'Selective Focus': 'Pick your battles carefully against this competitor',
          'Maintain Steady': 'Competitor is stable; look for specific weaknesses or niche opportunities'
        }
      },
      'agency': {
        header: '**How to interpret for agency penetration:**',
        mappings: {
          'Incumbent Displacement': 'Current vendors have contracts expiring; position for recompetes',
          'New Requirements': 'Agency has new initiatives or budget; pursue new starts',
          'Relationship Focus': 'Build relationships with program offices and contracting officers',
          'Volume Bidding': 'Agency buys frequently; pursue multiple vehicles and opportunities',
          'Validate & Assess': 'Confirm agency budget and priorities before investing in pursuit',
          'Selective Focus': 'Focus on specific programs or sub-agencies with best fit',
          'Maintain Steady': 'Agency spending is stable; focus on getting on contract vehicles'
        }
      },
      'partner': {
        header: '**How to interpret for partner strategy:**',
        mappings: {
          'Incumbent Displacement': 'Partner may face competition on renewals; support their recompetes',
          'New Requirements': 'Help partner pursue new opportunities; joint capture efforts',
          'Relationship Focus': 'Deepen partnership; joint account planning and executive engagement',
          'Volume Bidding': 'Partner can pursue many deals; ensure they have capacity and enablement',
          'Validate & Assess': 'Verify partner pipeline is real; align on priorities',
          'Selective Focus': 'Focus partnership on highest-value opportunities',
          'Maintain Steady': 'Partnership is performing well; continue current engagement model'
        }
      },
      'market_keyword': {
        header: '**How to interpret for market strategy:**',
        mappings: {
          'Incumbent Displacement': 'Market has established players with expiring contracts; target recompetes',
          'New Requirements': 'Market is growing; pursue new opportunities and emerging requirements',
          'Relationship Focus': 'Success requires agency relationships; invest in customer engagement',
          'Volume Bidding': 'Fragmented market with many opportunities; broad pursuit strategy',
          'Validate & Assess': 'Verify market opportunity is real before major investment',
          'Selective Focus': 'Pick specific niches or agencies to focus on',
          'Maintain Steady': 'Stable market; consistent business development approach'
        }
      }
    };
    
    const intentConfig = interpretations[searchIntent.type] || interpretations['market_keyword'];
    
    // Find relevant interpretations based on strategy matrix values
    const relevantMappings = [];
    if (strategy.matrix) {
      ['bd', 'strat', 'pipe'].forEach(key => {
        const value = strategy.matrix[key];
        if (value && intentConfig.mappings[value]) {
          relevantMappings.push(`- *${value}*: ${intentConfig.mappings[value]}`);
        }
      });
    }
    
    if (relevantMappings.length === 0) return '';
    
    return `
${intentConfig.header}
${relevantMappings.join('\n')}`;
  },

  // ==================== INTENT-AWARE PROMPT GENERATION ====================
  generatePrompt(searchIntent, extractedData, config = {}) {
    const mf = v => Utils.money(v);
    const scope = config.scope || 'Entire Market';
    const focus = config.focus || 'Growth';
    const query = extractedData.metadata.marketQuery;
    
    // Build intent-specific context
    let intentContext = '';
    let strategicFramework = '';
    let specificInstructions = '';
    
    switch (searchIntent.type) {
      case 'own_company':
        intentContext = `
**SEARCH CONTEXT: OWN COMPANY ANALYSIS**
The user searched for "${query}" which appears to be their own company or primary entity.
- Entity: ${searchIntent.details.entityName}
- Current Market Share: ${searchIntent.details.entityShare}%
- Current Contract Value: ${mf(searchIntent.details.entityValue)}

**STRATEGIC INTENT:** The user wants to understand their competitive position and defend/grow their market share.`;
        
        strategicFramework = `
**FRAMEWORK: INCUMBENT DEFENSE & GROWTH**
1. **Protect Base**: Identify expiring contracts and recompete risks
2. **Expand Footprint**: Find adjacent agencies/sub-agencies to penetrate
3. **Competitive Intelligence**: Understand who is threatening your position
4. **Channel Leverage**: Identify partners who can extend your reach`;
        
        specificInstructions = `
**SPECIFIC DELIVERABLES:**
1. **Position Assessment**: Your current standing vs. competitors
2. **Risk Register**: Contracts expiring in next 18 months with displacement probability
3. **Expansion Opportunities**: Agencies where you're underrepresented vs. competitors
4. **Competitive Threats**: Who is growing in your space and how to counter
5. **Defense Playbook**: Actions to protect recompetes`;
        break;
        
      case 'competitor':
        intentContext = `
**SEARCH CONTEXT: COMPETITOR ANALYSIS**
The user searched for "${query}" which identifies a specific competitor.
- Competitor: ${searchIntent.details.entityName}
- Their Market Share: ${searchIntent.details.entityShare}%
- Their Contract Value: ${mf(searchIntent.details.entityValue)}

**STRATEGIC INTENT:** The user wants to understand this competitor's position to displace them or compete effectively.`;
        
        strategicFramework = `
**FRAMEWORK: COMPETITIVE DISPLACEMENT**
1. **Know the Enemy**: Deep dive on competitor's strengths and weaknesses
2. **Find Vulnerabilities**: Expiring contracts, unhappy customers, delivery issues
3. **Counter-Position**: Develop messaging that highlights your advantages
4. **Team or Compete**: Identify where to team vs. go head-to-head`;
        
        specificInstructions = `
**SPECIFIC DELIVERABLES:**
1. **Competitor Profile**: Full analysis of ${searchIntent.details.entityName}
2. **Vulnerability Assessment**: Their expiring contracts (your opportunities)
3. **Agency Overlap**: Where you both compete for the same customers
4. **Displacement Strategy**: How to win their contracts at recompete
5. **Battle Cards**: Win themes and competitive differentiators`;
        break;
        
      case 'partner':
        intentContext = `
**SEARCH CONTEXT: PARTNER/CHANNEL ANALYSIS**
The user searched for "${query}" which is marked as a channel partner.
- Partner: ${searchIntent.details.entityName}
- Their Federal Revenue: ${mf(searchIntent.details.entityValue)}
- Relationship: ${searchIntent.details.relationship}

**STRATEGIC INTENT:** The user wants to understand how to leverage this partner relationship for growth.`;
        
        strategicFramework = `
**FRAMEWORK: CHANNEL OPTIMIZATION**
1. **Partner Value**: Understand their reach and capabilities
2. **Joint Opportunities**: Identify deals where teaming makes sense
3. **Enablement**: How to help them sell your solutions
4. **Expansion**: Where else they can take you`;
        
        specificInstructions = `
**SPECIFIC DELIVERABLES:**
1. **Partner Profile**: Their federal presence and agency relationships
2. **Joint Pipeline**: Recompetes and new opportunities for teaming
3. **Agency Introduction Map**: Where they have relationships you don't
4. **Enablement Plan**: How to arm them to represent you
5. **Revenue Targets**: Realistic joint revenue goals by quarter`;
        break;
        
      case 'agency':
        intentContext = `
**SEARCH CONTEXT: AGENCY/CUSTOMER ANALYSIS**
The user searched for "${query}" which is a federal agency.
- Agency: ${searchIntent.details.entityName}
- Total Spend: ${mf(searchIntent.details.entityValue)}
- Active Vendors: ${searchIntent.details.vendorCount}

**STRATEGIC INTENT:** The user wants to penetrate or expand within this specific agency.`;
        
        strategicFramework = `
**FRAMEWORK: AGENCY PENETRATION**
1. **Know the Customer**: Understand their mission and priorities
2. **Map the Landscape**: Who's the incumbent? Who's winning?
3. **Find Entry Points**: Recompetes, new requirements, set-asides
4. **Build Relationships**: Key contracting offices and program managers`;
        
        specificInstructions = `
**SPECIFIC DELIVERABLES:**
1. **Agency Profile**: Mission, budget trends, IT priorities
2. **Competitive Map**: Who holds the contracts you want
3. **Entry Strategy**: Specific opportunities to pursue
4. **Sub-Agency Breakdown**: Where are the best opportunities
5. **Timeline**: Key dates and procurement cycles`;
        break;
      
      case 'product_oem':
        intentContext = `
**SEARCH CONTEXT: PRODUCT/OEM CHANNEL ANALYSIS**
The user searched for "${query}" which appears to be a **product or software** they sell through channel partners.
- Product/Software: ${query.toUpperCase()}
- Total Federal Revenue: ${mf(searchIntent.details.totalMarketValue)}
- Active Channel Partners: ${searchIntent.details.channelCount}
- Channel Share: ${searchIntent.details.channelShare}% of revenue through partners
- Top Channel Partner: ${searchIntent.details.topChannel} (${searchIntent.details.topChannelShare}%)
- Top Buying Agency: ${searchIntent.details.topAgency} (${searchIntent.details.topAgencyShare}%)
${searchIntent.details.directSalesCount > 0 ? `- Direct/Other Sales: ${searchIntent.details.directSalesCount} vendors (${searchIntent.details.directSalesShare}%)` : ''}

**STRATEGIC INTENT:** The user is an OEM/ISV who sells through channel partners and wants to:
1. Understand which partners are performing best
2. Identify agencies with highest adoption
3. Find recompete opportunities to protect/grow
4. Optimize channel coverage and performance`;
        
        strategicFramework = `
**FRAMEWORK: CHANNEL PERFORMANCE & OPTIMIZATION**
1. **Channel Scorecard**: Rank partners by revenue, growth, and agency coverage
2. **Agency Penetration**: Which agencies have adopted? Who's missing?
3. **Recompete Defense**: Protect existing installs through partner coordination
4. **White Space**: Agencies/sub-agencies with no current coverage
5. **Partner Enablement**: Who needs support to close more deals?`;
        
        specificInstructions = `
**SPECIFIC DELIVERABLES:**
1. **Channel Performance Report**: Rank all partners by revenue and growth
2. **Agency Adoption Map**: Which agencies use ${query}? Coverage gaps?
3. **Recompete Calendar**: All renewals in next 18 months with assigned partners
4. **Partner Coverage Matrix**: Which partners cover which agencies?
5. **Enablement Priorities**: Partners who need training, support, or incentives
6. **Competitive Threats**: Are there direct competitors or alternative products?`;
        break;
        
      case 'market_keyword':
      default:
        intentContext = `
**SEARCH CONTEXT: MARKET/TECHNOLOGY ANALYSIS**
The user searched for "${query}" which represents a market segment or technology area.
- Total Addressable Market: ${mf(searchIntent.details.totalMarketValue)}
- Active Vendors: ${searchIntent.details.vendorCount || extractedData.metadata.competitorsIdentified}
- Active Agencies: ${searchIntent.details.agencyCount || extractedData.agencies.all.length}
- Top Vendor: ${searchIntent.details.topVendor || extractedData.competitors.top5[0]?.vendor}
- Top Agency: ${searchIntent.details.topAgency || extractedData.agencies.top5[0]?.agency}

**STRATEGIC INTENT:** The user wants to understand this market to enter or expand their presence.`;
        
        strategicFramework = `
**FRAMEWORK: MARKET ENTRY/EXPANSION**
1. **Size the Prize**: Understand TAM and growth trajectory
2. **Know the Players**: Who dominates? Who's growing?
3. **Find Your Lane**: Where do you have competitive advantage?
4. **Build the Pipeline**: Specific opportunities to pursue`;
        
        specificInstructions = `
**SPECIFIC DELIVERABLES:**
1. **Market Overview**: Size, growth, concentration analysis
2. **Competitive Landscape**: Top players and their positioning
3. **Agency Priorities**: Who's buying and why
4. **Opportunity Pipeline**: Specific recompetes and new requirements
5. **Go-to-Market Strategy**: How to win in this market`;
        break;
    }
    
    // Build the comprehensive prompt
    return `# FEDERAL SALES INTELLIGENCE REPORT
## Query: "${query.toUpperCase()}" | Scope: ${scope} | Focus: ${focus}
## Generated: ${new Date().toLocaleDateString()} | FY${extractedData.metadata.fiscalYear} Q${extractedData.metadata.currentQuarter}

---

${intentContext}

${strategicFramework}

---

## INSTRUCTIONS FOR AI ASSISTANT

Create a comprehensive, actionable federal sales plan (4-6 pages) based on the data and context below. The plan should be executive-ready with specific actions, timelines, and measurable targets.

${specificInstructions}

---

## MARKET DATA

### MARKET OVERVIEW
- **Total ${searchIntent.type === 'product_oem' ? 'Federal Revenue' : 'Addressable Market (TAM)'}:** ${mf(extractedData.metadata.totalMarketValue)}
- **Total Active Contracts:** ${extractedData.metadata.totalContracts}
- **Average Contract Size:** ${mf(extractedData.metadata.totalMarketValue / extractedData.metadata.totalContracts)}
- **${searchIntent.type === 'product_oem' ? 'Channel Partners' : 'Active Competitors'}:** ${searchIntent.type === 'product_oem' ? extractedData.channels.all.length : extractedData.metadata.competitorsIdentified}
- **Active Agencies:** ${extractedData.agencies.all.length}

${searchIntent.type === 'product_oem' ? `### CHANNEL PARTNER PERFORMANCE (Ranked by Revenue)
${extractedData.channels.all.length > 0 ? extractedData.channels.all.map((c, i) => `${i + 1}. **${c.vendor}**
   - Revenue: ${mf(c.spend)} (${c.marketShare}% share)
   - Contracts: ${c.contractCount} | Avg Deal: ${mf(c.avgContractSize)}
   - Agency Reach: ${c.agencyDiversity} agencies | ${c.subAgencyReach} sub-agencies
   - Expiring (18mo): ${c.expiringContracts.length} contracts worth ${mf(c.expiringValue)}`).join('\n') : 'No channel partners identified. Mark resellers/VARs in the channel modal.'}

### CHANNEL CONCENTRATION
- **Total Channel Revenue:** ${mf(extractedData.channels.totalValue)}
- **Top Partner Share:** ${extractedData.channels.all[0] ? extractedData.channels.all[0].marketShare : 0}%
- **Top 3 Partners Share:** ${extractedData.channels.all.slice(0, 3).reduce((s, c) => s + parseFloat(c.marketShare), 0).toFixed(1)}%
- **Top 5 Partners Share:** ${extractedData.channels.all.slice(0, 5).reduce((s, c) => s + parseFloat(c.marketShare), 0).toFixed(1)}%

${extractedData.competitors.all.length > 0 ? `### DIRECT SALES / OTHER VENDORS
These vendors are NOT marked as channel partners - they may be direct sales, competitors, or unidentified resellers:
${extractedData.competitors.top5.map((c, i) => `${i + 1}. **${c.vendor}**: ${mf(c.spend)} (${c.marketShare}% share, ${c.contractCount} contracts)`).join('\n')}` : ''}` : `### MARKET CONCENTRATION ANALYSIS

**Vendor Concentration** (Who's winning the work):
- **Vendor HHI:** ${extractedData.marketConcentration.vendorHHI} (${extractedData.marketConcentration.status})
- **Top 3 Vendor Share:** ${extractedData.marketConcentration.top3Share}%
- **Top 5 Vendor Share:** ${extractedData.marketConcentration.top5Share}%
- **Top 10 Vendor Share:** ${extractedData.marketConcentration.top10Share}%
- **Implication:** ${extractedData.marketConcentration.vendorInterpretation}

**Agency Concentration** (Who's buying):
- **Agency HHI:** ${extractedData.marketConcentration.agencyHHI}
- **Implication:** ${extractedData.marketConcentration.agencyInterpretation}

*Note: HHI < 1500 = Competitive, 1500-2500 = Moderate, > 2500 = Highly Concentrated*

### TOP COMPETITORS (by Contract Value)
${extractedData.competitors.top5.map((c, i) => `${i + 1}. **${c.vendor}**
   - Market Share: ${c.marketShare}% | Value: ${mf(c.spend)}
   - Contracts: ${c.contractCount} | Avg Size: ${mf(c.avgContractSize)}
   - Agency Reach: ${c.agencyDiversity} agencies | ${c.subAgencyReach} sub-agencies
   - Expiring (18mo): ${c.expiringContracts.length} contracts worth ${mf(c.expiringValue)}
   - NAICS: ${c.naicsCodes.slice(0, 3).join(', ') || 'N/A'}`).join('\n')}

${extractedData.channels.all.length > 0 ? `### CHANNEL PARTNERS (User-Identified)
${extractedData.channels.all.map(c => `- **${c.vendor}**: ${mf(c.spend)} (${c.contractCount} contracts, ${c.marketShare}% share)`).join('\n')}
- **Total Channel Value:** ${mf(extractedData.channels.totalValue)}` : `### NO CHANNEL PARTNERS IDENTIFIED
Consider marking VARs, resellers, or teaming partners in the channel modal.`}`}

### TOP AGENCIES (by Spend)
${extractedData.agencies.top5.map((a, i) => `${i + 1}. **${a.agency}**
   - Spend: ${mf(a.spend)} (${a.percentage}% of market)
   - Contracts: ${a.contractCount} | Sub-Agencies: ${a.subAgencyCount}
   - ${searchIntent.type === 'product_oem' ? 'Top Partner' : 'Incumbent'}: ${a.incumbentVendor || 'Various'}
   - Top Sub-Agencies: ${a.subAgencies.slice(0, 3).map(s => s.name).join(', ')}`).join('\n')}

### RECOMPETE INTELLIGENCE (18-Month Pipeline)

**IMMEDIATE (0-6 Months) - ${extractedData.recompetes.immediate.length} Opportunities - ${mf(extractedData.recompetes.immediate.reduce((s, r) => s + (r['Award Amount'] || 0), 0))} at Risk**
${extractedData.recompetes.immediate.slice(0, 5).map(r => `- ${r['Awarding Agency']}: ${mf(r['Award Amount'])} | Incumbent: ${r['Recipient Name']} | Ends: ${Utils.date(r['End Date'])}`).join('\n') || 'None identified'}

**NEAR-TERM (6-12 Months) - ${extractedData.recompetes.nearTerm.length} Opportunities - ${mf(extractedData.recompetes.nearTerm.reduce((s, r) => s + (r['Award Amount'] || 0), 0))} at Risk**
${extractedData.recompetes.nearTerm.slice(0, 5).map(r => `- ${r['Awarding Agency']}: ${mf(r['Award Amount'])} | Incumbent: ${r['Recipient Name']} | Ends: ${Utils.date(r['End Date'])}`).join('\n') || 'None identified'}

**PIPELINE (12-18 Months) - ${extractedData.recompetes.pipeline.length} Opportunities - ${mf(extractedData.recompetes.pipeline.reduce((s, r) => s + (r['Award Amount'] || 0), 0))} at Risk**
${extractedData.recompetes.pipeline.slice(0, 5).map(r => `- ${r['Awarding Agency']}: ${mf(r['Award Amount'])} | Incumbent: ${r['Recipient Name']} | Ends: ${Utils.date(r['End Date'])}`).join('\n') || 'None identified'}

${extractedData.naicsBreakdown.length > 0 ? `### NAICS CODE BREAKDOWN
${extractedData.naicsBreakdown.slice(0, 5).map(n => `- **${n.code}** (${n.description || 'No description'}): ${mf(n.spend)} | ${n.count} contracts`).join('\n')}` : `### NAICS CODE BREAKDOWN
*No NAICS data available. API fields in this dataset: ${extractedData.metadata.sampleFields?.join(', ') || 'Unknown'}*`}

${extractedData.pscBreakdown.length > 0 ? `### PSC CODE BREAKDOWN
${extractedData.pscBreakdown.slice(0, 5).map(p => `- **${p.code}** (${p.description || 'No description'}): ${mf(p.spend)} | ${p.count} contracts`).join('\n')}` : `### PSC CODE BREAKDOWN
*No PSC data available.*`}

${extractedData.forecastInsights ? `### FORECAST & TREND ANALYSIS
- **Baseline Annual Forecast:** ${mf(extractedData.forecastInsights.baseline)}
- **YoY Growth Rate:** ${extractedData.forecastInsights.growthRate ? `${extractedData.forecastInsights.growthRate.value}% (${extractedData.forecastInsights.growthRate.comparison})` : 'Insufficient complete year data'}
- **Peak Spending Quarter:** Q${extractedData.forecastInsights.peakQuarter?.quarter || 'N/A'} (${extractedData.forecastInsights.peakQuarter?.index || 'N/A'}% of annual)
- **Market Status:** ${extractedData.forecastInsights.marketStatus}

**Quarterly Forecasts:**
${extractedData.forecastInsights.quarterlyForecasts.map(f => `- **${f.period}:** ${mf(f.predicted)} (${f.trend}% vs historical avg) | Confidence: ${f.confidence?.label || 'N/A'} - ${f.confidence?.reason || ''}`).join('\n')}

**Seasonal Indices:**
${Object.entries(extractedData.forecastInsights.seasonalIndices).map(([q, idx]) => `- Q${q}: ${(idx * 100).toFixed(1)}% of annual spend`).join('\n')}

${extractedData.forecastInsights.strategy ? `**AI Strategy Recommendation:**
- **Outlook:** ${extractedData.forecastInsights.strategy.title}
- **Analysis:** ${extractedData.forecastInsights.strategy.text}
- **Recommended Action:** ${extractedData.forecastInsights.strategy.action}
- **BD Focus:** ${extractedData.forecastInsights.strategy.matrix?.bd || 'N/A'}
- **Strategic Approach:** ${extractedData.forecastInsights.strategy.matrix?.strat || 'N/A'}
- **Pipeline Focus:** ${extractedData.forecastInsights.strategy.matrix?.pipe || 'N/A'}

${this.getStrategyInterpretation(searchIntent, extractedData.forecastInsights.strategy)}` : ''}

**Historical Spending by Fiscal Year:**
${Object.entries(extractedData.forecastInsights.historicalByFY || {}).map(([fy, quarters]) => 
  `- FY${fy}: ${mf(Object.values(quarters).reduce((a, b) => a + b, 0))} (Q1: ${mf(quarters[1] || 0)}, Q2: ${mf(quarters[2] || 0)}, Q3: ${mf(quarters[3] || 0)}, Q4: ${mf(quarters[4] || 0)})`
).join('\n')}` : '### NO FORECAST DATA AVAILABLE\nRun in Forecast Mode to get predictive analytics and trend analysis.'}

---

## OUTPUT REQUIREMENTS

Generate an **executive-ready GTM playbook** (4-6 pages) using the **OneTeam collaborative approach**. Every section must include concrete actions, owners, and decision gates.

### PART 1: EXECUTIVE SUMMARY (1/2 page)
- Key findings from the data above
- Primary opportunities (ranked by value and probability)
- Recommended strategy in one paragraph
- Critical success factors

### PART 2: ${searchIntent.type === 'product_oem' ? 'CHANNEL' : 'MARKET'} ANALYSIS (1 page)
${searchIntent.type === 'product_oem' ? `- Channel performance scorecard (tier partners by revenue and growth)
- Agency adoption map with coverage gaps
- Partner concentration risk assessment
- White space opportunities` : `- Market size, growth trajectory, and concentration analysis
- Competitive landscape and positioning
- Agency priorities and budget signals
- Entry points and timing considerations`}

### PART 3: STAKEHOLDER PERSPECTIVES (OneTeam Format)
Provide **1-2 actionable paragraphs** from each perspective:

${this.getOneTeamPerspectives(searchIntent, query)}

### PART 4: COMPETITIVE INTELLIGENCE
Create a table with this structure:
| Competitor | Strengths | Weaknesses | Our Counter-Positioning |
|------------|-----------|------------|------------------------|
| [From data above] | [Specific advantage] | [Specific gap] | [How we differentiate] |

${searchIntent.type === 'product_oem' ? `Also address: Are there alternative products agencies might consider? What triggers switching?` : `Also address: DIY/In-House option - perceived control vs. hidden costs and talent risk.`}

### PART 5: 90-DAY CRITICAL PATH

**Phase 1 — Discovery (Days 1–30)**
${searchIntent.type === 'product_oem' ? `- Validate partner pipeline accuracy for all recompetes
- Identify coverage gaps by agency/sub-agency
- Assess partner enablement needs` : `- Validate BANT (Budget, Authority, Need, Timeline) for top opportunities
- Map stakeholders and decision-makers
- Conduct gap analysis vs. incumbents`}
**Gate 1:** ${searchIntent.type === 'product_oem' ? 'Proceed if renewals tracked and partners engaged' : 'Proceed to pursuit if budget and champion confirmed'}

**Phase 2 — ${searchIntent.type === 'product_oem' ? 'Enablement' : 'Engagement'} (Days 31–60)**
${searchIntent.type === 'product_oem' ? `- Execute partner training on new features/pricing
- Joint account planning with top 5 partners
- Develop co-branded collateral for key agencies` : `- Execute targeted outreach to decision-makers
- Conduct technical validation / PoC if applicable
- Draft value proposition and ROI framework`}
**Gate 2:** ${searchIntent.type === 'product_oem' ? 'Advance if partners demonstrate pipeline growth' : 'Advance if success criteria met and business case approved'}

**Phase 3 — ${searchIntent.type === 'product_oem' ? 'Execution' : 'Pursuit'} (Days 61–90)**
${searchIntent.type === 'product_oem' ? `- Support partners on active recompetes
- Track win/loss on renewals
- Build reference stories from wins` : `- Finalize proposal strategy and pricing
- Engage executives for relationship leverage
- Submit response / negotiate terms`}
**Gate 3:** ${searchIntent.type === 'product_oem' ? 'Scale if renewal win rate > 80%' : 'Award or lessons learned capture'}

### PART 6: RISK REGISTER
Create a table with this structure:
| Risk | Impact (H/M/L) | Probability (H/M/L) | Mitigation Plan | Owner |
|------|----------------|---------------------|-----------------|-------|
${searchIntent.type === 'product_oem' ? `| Partner capacity constraints | H | M | Cross-train backup partners | Partner Lead |
| Competitive product displacement | H | M | Accelerate feature parity + exec engagement | Product |
| Renewal slippage | M | H | Early engagement 6mo before expiry | Channel Sales |` : `| Technical non-compliance | H | M | Accelerate FedRAMP/security validation | Solution Architect |
| Competitive displacement | H | M | Partner alignment + exec sponsorship | Sales |
| Budget delay or CR | M | H | Identify bridge funding or carryover | Finance |`}
[Add 2-3 more specific to the data above]

### PART 7: RACI MATRIX
| Workstream | Responsible | Accountable | Consulted | Informed |
|------------|-------------|-------------|-----------|----------|
${searchIntent.type === 'product_oem' ? `| Channel strategy | Partner Lead | Sales VP | Marketing, Product | Leadership |
| Partner enablement | Enablement Mgr | Partner Lead | Product, Sales | Marketing |
| Renewal tracking | Channel Sales | Partner Lead | Finance | Leadership |
| Agency expansion | Sales Lead | Sales VP | Partner, Marketing | Product |` : `| Account strategy | Sales Lead | BD Lead | SA, Marketing | Leadership |
| Technical validation | SA Lead | BD Lead | Sales, Partner | Leadership |
| Marketing campaign | Marketing Lead | BD Lead | Sales, Exec | Partner |
| Pricing & negotiation | Sales Lead | Leadership | Finance | BD Lead |`}

### PART 8: SUCCESS METRICS
**Leading Indicators (Activity):**
${searchIntent.type === 'product_oem' ? `- Partner pipeline reported ($)
- Partners trained (#)
- Joint meetings conducted (#)
- Coverage gaps closed (#)` : `- Qualified meetings held (#)
- PoC/pilots initiated (#)
- Champions identified (#)
- Proposals submitted (#)`}

**Lagging Indicators (Results):**
${searchIntent.type === 'product_oem' ? `- Renewal win rate (%)
- Channel revenue growth ($)
- New agency logos (#)
- Partner satisfaction score` : `- Pipeline generated ($)
- Win rate (%)
- ARR/TCV closed ($)
- References created (#)`}

---

## FY26 FEDERAL CONTEXT

${this.getFY26Context(extractedData.agencies.top5)}

---

## VALIDATION CRITERIA

- **Specificity:** Reference actual ${searchIntent.type === 'product_oem' ? 'partner' : 'vendor'}/agency names from the data
- **Accountability:** Every action has an owner and timeline
- **Federal-Savvy:** Address procurement realities (FAR, vehicles, budget cycles)
- **No Filler:** Every sentence must advance execution
- **Measurable:** Include quantified targets where possible
- Plan must align with search intent: **${searchIntent.type}**`;
  },

  // ==================== FY26 FEDERAL CONTEXT GENERATOR ====================
  getFY26Context(topAgencies) {
    const agencyContexts = {
      'Department of Defense': `**DoD FY26 Priorities:**
- Zero Trust implementation mandate by FY27
- JADC2 (Joint All-Domain Command and Control) expansion
- Software factory and DevSecOps acceleration
- CMMC 2.0 compliance requirements
- **Key Vehicles:** JWCC, Alliant 3, SEWP VI, OTA consortia (NSTXL, AFWERX)
- **Budget:** $14B+ cyber budget across RDT&E and O&M`,

      'Department of Homeland Security': `**DHS FY26 Priorities:**
- Cybersecurity and critical infrastructure protection
- Border technology modernization
- Identity and access management (ICAM)
- Cloud migration and Zero Trust
- **Key Vehicles:** EAGLE II, FirstSource III, SEWP VI, GSA MAS
- **Budget:** Focus on CISA funding and component modernization`,

      'General Services Administration': `**GSA FY26 Priorities:**
- Government-wide shared services expansion
- FedRAMP authorization acceleration
- Acquisition modernization and e-commerce
- Login.gov and identity services
- **Key Vehicles:** GSA MAS, Alliant 3, OASIS+, SEWP VI
- **Budget:** TMF allocations and working capital fund`,

      'Department of Veterans Affairs': `**VA FY26 Priorities:**
- EHR modernization (Oracle Health) stabilization
- Veteran-facing digital services
- Cybersecurity and Zero Trust
- AI for claims processing and scheduling
- **Key Vehicles:** T4NG2, SEWP VI, GSA MAS
- **Budget:** $4B+ IT budget with modernization focus`,

      'Department of Health and Human Services': `**HHS FY26 Priorities:**
- Public health data modernization
- AI governance for medical applications
- Interoperability and data sharing
- Cybersecurity resilience
- **Key Vehicles:** CIO-SP4, NIH LTASC, SEWP VI
- **Budget:** CDC DMI funding, NIH STRIDES program`,

      'Department of the Treasury': `**Treasury FY26 Priorities:**
- IRS modernization (IRA funding)
- Financial crimes and fraud detection
- Cloud migration and Zero Trust
- Customer experience improvement
- **Key Vehicles:** Alliant 3, SEWP VI, GSA MAS
- **Budget:** IRA technology modernization funds`,

      'Department of Commerce': `**Commerce FY26 Priorities:**
- CHIPS Act implementation support
- Weather and climate data systems
- Cybersecurity and export control systems
- Cloud modernization
- **Key Vehicles:** SEWP VI, GSA MAS, Alliant 3
- **Budget:** CHIPS funding and bureau modernization`,

      'Department of Energy': `**DOE FY26 Priorities:**
- Grid modernization and resilience
- AI for scientific computing (exascale)
- Cybersecurity for critical infrastructure
- Climate modeling and clean energy data
- **Key Vehicles:** DOE BPAs, SEWP VI, Lab IDIQs
- **Budget:** IIJA extensions and OCIO modernization`,

      'Department of State': `**State FY26 Priorities:**
- Diplomatic technology modernization
- Cybersecurity and secure communications
- Cloud migration (IL4/IL5 environments)
- Consular systems modernization
- **Key Vehicles:** GSA MAS, Alliant 3, SEWP VI
- **Budget:** Diplomatic technology fund`,

      'Securities and Exchange Commission': `**SEC FY26 Priorities:**
- Market surveillance and analytics modernization
- Cybersecurity for financial data protection
- Cloud migration and data management
- Digital submission and processing systems
- **Key Vehicles:** GSA MAS, SEWP VI, CIO-SP4
- **Budget:** IT modernization and enforcement technology`,

      'Social Security Administration': `**SSA FY26 Priorities:**
- Customer service modernization
- Fraud detection and prevention
- Legacy system modernization
- Cloud and cybersecurity improvements
- **Key Vehicles:** GSA MAS, SEWP VI, CIO-SP4
- **Budget:** IT modernization fund and customer experience`,

      'Department of Justice': `**DOJ FY26 Priorities:**
- Law enforcement technology modernization
- Cybersecurity and data protection
- Case management system upgrades
- Cloud migration and Zero Trust
- **Key Vehicles:** GSA MAS, ITES-3S, SEWP VI
- **Budget:** IT working capital fund`,

      'Department of Agriculture': `**USDA FY26 Priorities:**
- Farm and rural service delivery modernization
- Cybersecurity and data protection
- Cloud migration initiatives
- Customer experience improvements
- **Key Vehicles:** GSA MAS, SEWP VI, Alliant 3
- **Budget:** OCIO modernization and FPAC systems`,

      'Federal Communications Commission': `**FCC FY26 Priorities:**
- Spectrum management system modernization
- Broadband mapping and data systems
- Cybersecurity improvements
- Public-facing digital services
- **Key Vehicles:** GSA MAS, SEWP VI
- **Budget:** IT modernization and enforcement systems`
    };

    // Generate context for top agencies in the data
    let context = `**Relevant FY26 Agency Priorities:**\n\n`;
    
    const addedAgencies = new Set();
    topAgencies.forEach(a => {
      // Find matching context - use more precise matching
      const agencyName = a.agency.toLowerCase();
      
      for (const [key, value] of Object.entries(agencyContexts)) {
        const keyLower = key.toLowerCase();
        
        // Check for exact match or if agency name contains the full key
        // or if key contains specific agency identifier (not just "Department")
        const keyWords = key.split(' ').filter(w => w !== 'Department' && w !== 'of' && w !== 'the');
        const isMatch = agencyName.includes(keyLower) || 
                        keyWords.some(word => word.length > 3 && agencyName.includes(word.toLowerCase()));
        
        if (isMatch && !addedAgencies.has(key)) {
          context += value + '\n\n';
          addedAgencies.add(key);
          break;
        }
      }
    });
    
    // If no specific agencies matched, note that
    if (addedAgencies.size === 0) {
      context += `*No specific agency context available. See Universal Requirements below.*\n\n`;
    }

    // Add general FY26 context
    context += `**Universal FY26 Compliance Requirements:**
- OMB M-24-14: Cybersecurity Priorities
- Zero Trust Architecture implementation
- FedRAMP High / IL4-IL5 for cloud
- CMMC 2.0 for defense contractors
- EO 14110: AI Safety and Governance
- TIC 3.0 network security`;

    return context;
  },

  // ==================== ONETEAM PERSPECTIVES GENERATOR ====================
  getOneTeamPerspectives(searchIntent, query) {
    const perspectives = {
      'product_oem': `
**Sales (Channel Account Manager):** Assess partner pipeline health, identify which partners need support on active opportunities, flag any relationship risks or competitive threats at the account level.

**Marketing (Channel Marketing):** Develop co-branded campaigns and content for top agencies, plan joint events or webinars, create partner-ready battle cards and ROI tools.

**Solution Architect (Technical Enablement):** Identify integration requirements at key accounts, ensure partners are certified on latest features, develop technical win strategies for competitive situations.

**Partner Lead (Channel Strategy):** Evaluate partner tier structure, assess coverage gaps, recommend partner recruitment or pruning, align incentives with strategic priorities.

**Finance (Channel Operations):** Analyze deal registration and margin by partner, recommend pricing or incentive adjustments, forecast channel revenue by quarter.

**Leadership (Executive Sponsor):** Determine strategic importance of this product line, allocate executive engagement for key renewals, set go/no-go criteria for partner investments.`,

      'own_company': `
**Sales (Account Executive):** Provide current relationship status, identify champions and blockers, flag active RFPs or budget signals, assess competitive threats to existing contracts.

**Marketing (Demand Generation):** Develop agency-specific messaging and value propositions, plan ABM campaigns and executive briefings, create case studies from recent wins.

**Solution Architect (Technical Lead):** Validate technical alignment with agency requirements, identify compliance gaps (FedRAMP, CMMC, Zero Trust), scope PoC or pilot approach.

**Partner Lead (Ecosystem Strategy):** Recommend teaming arrangements with SIs or ISVs, identify subcontracting opportunities, assess partner conflicts.

**Finance (Deal Strategy):** Develop pricing strategy aligned with budget cycles, create ROI framework, recommend contract vehicle and structure.

**Leadership (Executive Sponsor):** Confirm account tier and resource allocation, engage for executive-to-executive relationships, set pursuit go/no-go criteria.`,

      'competitor': `
**Sales (Competitive Intelligence):** Document competitor's current positions, relationships, and contract expiration dates. Identify accounts where they are vulnerable.

**Marketing (Competitive Positioning):** Develop "why us vs. them" messaging, create competitor battle cards, plan targeted campaigns against their install base.

**Solution Architect (Technical Differentiation):** Identify technical gaps in competitor's solution, develop proof points for our advantages, create migration/displacement approach.

**Partner Lead (Ecosystem Gaps):** Identify partners currently aligned with competitor, assess potential to flip partnerships, find SI/ISVs who prefer our solution.

**Finance (Competitive Pricing):** Analyze competitor's pricing model, develop competitive pricing strategy, identify TCO advantages.

**Leadership (Strategic Priority):** Determine investment level for competitive displacement, allocate resources for targeted pursuits.`,

      'agency': `
**Sales (Account Development):** Map organizational structure and key stakeholders, identify budget owners and technical evaluators, assess current vendor relationships and satisfaction.

**Marketing (Agency Marketing):** Develop mission-aligned messaging for this agency, plan targeted events and thought leadership, identify relevant case studies from similar agencies.

**Solution Architect (Technical Alignment):** Map solution to agency technical environment, identify integration requirements, assess compliance posture (FedRAMP, IL level, etc.).

**Partner Lead (Agency Relationships):** Identify SIs with strong agency relationships, assess teaming opportunities, recommend partner-led vs. direct approach.

**Finance (Budget Intelligence):** Research agency budget and appropriations, identify funding sources (base budget, TMF, working capital), align pricing to fiscal year timing.

**Leadership (Executive Engagement):** Plan executive-to-executive engagement strategy, identify industry days or speaking opportunities, set account penetration milestones.`,

      'partner': `
**Sales (Joint Selling):** Identify joint opportunities in partner's pipeline, assess deal registration and support needs, plan co-selling activities.

**Marketing (Partner Marketing):** Develop co-branded content and campaigns, plan joint events, create partner success stories.

**Solution Architect (Integration):** Ensure technical integration between solutions, develop joint reference architecture, support partner technical enablement.

**Partner Lead (Relationship Management):** Assess partnership health and alignment, develop joint business plan, identify expansion opportunities.

**Finance (Partner Economics):** Analyze margin and deal structure, recommend incentive adjustments, forecast joint revenue.

**Leadership (Strategic Partnership):** Confirm partnership tier and investment level, engage for executive alignment, set partnership success metrics.`,

      'market_keyword': `
**Sales (Market Development):** Identify highest-potential agencies and accounts in this market, assess current relationships and entry points, prioritize pursuit targets.

**Marketing (Market Strategy):** Develop market-specific messaging and positioning, plan awareness campaigns and thought leadership, create market-relevant content and case studies.

**Solution Architect (Solution Fit):** Validate solution alignment with market requirements, identify compliance or integration gaps, develop market-specific reference architectures.

**Partner Lead (Go-to-Market):** Identify partners with market expertise and relationships, recommend channel strategy, assess build vs. partner decision.

**Finance (Market Sizing):** Validate TAM and growth assumptions, develop pricing strategy for market, create ROI frameworks relevant to this market's buyers.

**Leadership (Market Investment):** Determine strategic priority of this market, allocate resources and headcount, set market share and revenue targets.`
    };

    return perspectives[searchIntent.type] || perspectives['market_keyword'];
  },

  // ==================== MAIN BUILD FUNCTION ====================
  buildPackage(data, analysis, config = {}) {
    // Step 1: Classify search intent
    const searchIntent = this.classifySearchIntent(
      App.currentQuery, 
      data, 
      SalesPlanManager.channels
    );
    
    // Step 2: Extract all available data
    const extractedData = this.extractAllData(data, analysis, config);
    
    // Step 3: Generate intent-aware prompt
    return this.generatePrompt(searchIntent, extractedData, config);
  },

  downloadPackage(promptText) {
    const blob = new Blob([promptText], { type: 'text/plain;charset=utf-8' });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `Sales_Plan_FY${Utils.getCurrentFY()}_${App.currentQuery.replace(/\s+/g, '_')}.txt`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }
};
App.init();
</script>

</body>
</html>