<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#000000">
  <title>Govhoo - Federal Contract Intelligence</title>
  
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-sankey/0.12.3/d3-sankey.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
 <script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-T343V4RFHV');
</script>
<style>
:root {
  --bg-app: #000000;
  --bg-card: #121212; 
  --bg-input: #1a1a1a;
  --border: #333333;
  --text-primary: #e6e6e6;
  --text-muted: #888888;
  
  /* Vintage/Elegant Terminal Theme */
  --accent: #D4C4A8;
  --accent-dim: rgba(212, 196, 168, 0.1);
  --link: #8DA0CB;
  --success: #66C2A5;
  --danger: #FB8072;
  
  /* Vintage Chart Palette */
  --q1-color: #958BB6; --q2-color: #6F8A74; --q3-color: #8FB6D0; --q4-color: #C27E5C;

  --safe-top: env(safe-area-inset-top, 20px);
  --safe-bottom: env(safe-area-inset-bottom, 20px);
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

body {
  margin: 0; padding: 0;
  font-family: 'Inter', sans-serif;
  background: var(--bg-app);
  color: var(--text-primary);
  min-height: 100vh;
  overflow-x: hidden;
}

/* --- Hero Section --- */
.hero-view {
  position: fixed; inset: 0; z-index: 200; 

  display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
  padding: 2rem; padding-top: max(8vh, var(--safe-top)); 
  transition: transform 0.5s cubic-bezier(0.16, 1, 0.3, 1);
  overflow-y: auto; 
}
.hero-view.slide-up { transform: translateY(-100%); }
.hero-view.hidden { display: none; }

.terminal-logo {
  font-family: 'JetBrains Mono', monospace; font-size: 2.5rem; font-weight: 700;
  margin-bottom: 0.5rem; color: var(--text-primary); letter-spacing: -1px; text-align: center;
}
.terminal-logo span { color: var(--accent); }

.hero-subtitle {
  color: var(--text-muted); margin-bottom: 2rem; text-align: center;
}

.search-box-container { 
  position: relative; z-index: 210; 
  width: 100%; max-width: 500px; margin-top: 1.5rem; 
}

.main-input {
  width: 100%; background: var(--bg-input); border: 1px solid var(--border);
  padding: 1.25rem 1rem; font-size: 1.1rem; color: white; border-radius: 4px;
  font-family: 'Inter', sans-serif; transition: border-color 0.2s; -webkit-appearance: none;
}
.main-input:focus { outline: none; border-color: var(--accent); background: #222; }

.btn-row { display: flex; gap: 0.75rem; margin-top: 1rem; }
.btn-primary, .btn-secondary {
  flex: 1; padding: 1rem;
  font-weight: 700; border: none; border-radius: 4px;
  font-size: 0.9rem; cursor: pointer; text-transform: uppercase; letter-spacing: 1px;
  display: flex; align-items: center; justify-content: center; gap: 0.5rem;
}
.btn-primary { background: var(--accent); color: #000; }
.btn-secondary { background: transparent; color: var(--accent); border: 1px solid var(--accent); }
.btn-primary:hover, .btn-secondary:hover { opacity: 0.9; }

.search-tips {
  margin-top: 1.5rem; width: 100%; max-width: 500px;
  background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border);
  border-radius: 4px; padding: 1rem;
  font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; color: var(--text-muted);
}
.tip-header {
  color: var(--accent); font-weight: 700; margin-bottom: 0.75rem;
  display: flex; align-items: center; gap: 0.5rem;
  text-transform: uppercase; letter-spacing: 1px;
}
.tip-row { display: flex; align-items: flex-start; gap: 0.75rem; margin-bottom: 0.6rem; line-height: 1.4; }
.cmd-hl { color: var(--text-primary); background: rgba(255, 255, 255, 0.1); padding: 2px 6px; border-radius: 2px; white-space: nowrap; }

/* --- App View --- */
.app-header {
  position: sticky; top: 0; z-index: 100;
  background: rgba(0,0,0,0.95); backdrop-filter: blur(10px);
  padding: 0.75rem 1rem; padding-top: max(0.75rem, var(--safe-top));
  border-bottom: 1px solid var(--border);
  display: flex; justify-content: space-between; align-items: center; gap: 1rem;
}
.header-left { display: flex; align-items: center; gap: 1rem; flex: 1; min-width: 0; }
.logo-btn { font-family: 'JetBrains Mono'; font-weight: 700; color: white; cursor: pointer; flex-shrink: 0; }
.logo-btn:hover { color: var(--accent); }

.mini-search {
  background: var(--bg-input); border: 1px solid var(--border);
  color: white; padding: 0.5rem 1rem; border-radius: 4px;
  font-size: 0.9rem; flex: 1; min-width: 0;
}
.mini-search:focus { outline: none; border-color: var(--accent); }

.header-actions { display: flex; gap: 0.5rem; flex-shrink: 0; }
.icon-btn {
  background: var(--bg-input); border: 1px solid var(--border); color: var(--text-muted);
  width: 36px; height: 36px; border-radius: 4px;
  display: flex; align-items: center; justify-content: center; cursor: pointer;
}
.icon-btn:hover { border-color: var(--accent); color: var(--accent); }
.icon-btn.active { background: var(--accent-dim); color: var(--accent); border-color: var(--accent); }

/* --- Dashboard --- */
.dashboard-container {
  padding: 1rem; padding-bottom: calc(2rem + var(--safe-bottom));
  max-width: 1400px; margin: 0 auto;
  display: none;
}
.dashboard-container.active { display: block; animation: fadeIn 0.8s forwards; }
@keyframes fadeIn { to { opacity: 1; } }

/* Mode Toggle */
.mode-toggle {
  display: flex; gap: 0.5rem; margin-bottom: 1.5rem;
  background: var(--bg-card); padding: 0.5rem; border-radius: 4px; border: 1px solid var(--border);
}
.mode-btn {
  flex: 1; padding: 0.75rem; background: transparent; border: none;
  color: var(--text-muted); font-family: 'JetBrains Mono'; font-size: 0.85rem;
  cursor: pointer; border-radius: 4px; transition: all 0.2s;
  display: flex; align-items: center; justify-content: center; gap: 0.5rem;
}
.mode-btn.active { background: var(--accent-dim); color: var(--accent); }
.mode-btn:hover:not(.active) { color: var(--text-primary); }

/* Stats Row */
.stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem; }
.stat-item {
  background: var(--bg-card); padding: 1rem; border-radius: 4px;
  border: 1px solid var(--border); text-align: center;
}
.stat-label { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.5rem; }
.stat-val { font-size: 1.25rem; font-weight: 700; font-family: 'JetBrains Mono'; color: white; }
.stat-sub { font-size: 0.7rem; color: var(--success); margin-top: 4px; }
.stat-sub.neutral { color: var(--text-muted); }

/* Section Headers */
.section-header {
  display: flex; align-items: center; justify-content: space-between;
  gap: 0.5rem; margin: 2rem 0 1rem 0;
  border-bottom: 1px solid var(--border); padding-bottom: 0.5rem; flex-wrap: wrap;
}
.section-title-group { display: flex; align-items: center; gap: 0.5rem; }
.section-title {
  font-family: 'JetBrains Mono', monospace; font-size: 0.9rem; font-weight: 700;
  color: var(--accent); text-transform: uppercase; letter-spacing: 1px;
}

.header-controls { display: flex; gap: 0.75rem; align-items: center; }
.time-badge {
  font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; color: var(--text-muted);
  border: 1px solid var(--border); padding: 4px 8px; border-radius: 4px;
}
.filter-badge {
  display: none; background: var(--accent-dim); color: var(--accent);
  border: 1px solid var(--accent); padding: 4px 8px; border-radius: 4px;
  font-size: 0.7rem; font-family: 'JetBrains Mono', monospace;
  cursor: pointer; align-items: center; gap: 6px;
}
.filter-badge:hover { background: rgba(212, 196, 168, 0.2); }

/* Chart Containers */
.chart-wrapper {
  background: var(--bg-card); border: 1px solid var(--border);
  border-radius: 4px; padding: 1rem; width: 100%; overflow: hidden;
}
.chart-container { width: 100%; height: 500px; display: flex; justify-content: center; }
.chart-wrapper-sm { height: 350px; }

/* Feed Grid */
.feed-grid { display: flex; flex-direction: column; gap: 1rem; }
.deal-card {
  background: var(--bg-card); border: 1px solid var(--border);
  border-radius: 4px; padding: 1.25rem; transition: transform 0.1s;
}
.deal-card:active { transform: scale(0.99); }
.deal-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem; }
.deal-agency { 
  font-size: 0.75rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase;
  background: rgba(255,255,255,0.05); padding: 2px 6px; border-radius: 4px;
}
.deal-amount { font-family: 'JetBrains Mono', monospace; color: var(--accent); font-weight: 700; font-size: 1rem; }
.deal-desc { font-size: 1rem; font-weight: 600; margin-bottom: 0.5rem; line-height: 1.4; color: white; }
.deal-vendor { font-size: 0.85rem; color: #8DA0CB; margin-bottom: 0.75rem; font-family: 'JetBrains Mono', monospace; }

.deal-meta { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem; }
.meta-tag {
  font-size: 0.65rem; font-family: 'JetBrains Mono', monospace;
  padding: 3px 8px; border-radius: 3px;
  background: rgba(255,255,255,0.05); color: var(--text-muted); border: 1px solid var(--border);
}
.meta-tag.naics { background: rgba(102, 194, 165, 0.15); border-color: rgba(102, 194, 165, 0.3); color: #66C2A5; }
.meta-tag.psc { background: rgba(141, 160, 203, 0.15); border-color: rgba(141, 160, 203, 0.3); color: #8DA0CB; }

.deal-footer {
  display: flex; justify-content: space-between; align-items: center;
  padding-top: 1rem; border-top: 1px solid #222;
}
.deal-date { font-size: 0.75rem; color: var(--text-muted); }
.action-btn {
  background: var(--bg-input); color: var(--accent); text-decoration: none;
  padding: 0.5rem 1rem; border-radius: 4px; font-size: 0.8rem; font-weight: 600;
  border: 1px solid var(--border); display: flex; align-items: center; gap: 6px;
}
.action-btn:hover { border-color: var(--accent); background: var(--accent-dim); }

/* Forecast Tables */
.forecast-table-wrapper { background: var(--bg-card); border: 1px solid var(--border); overflow-x: auto; border-radius: 4px; }
.forecast-table { width: 100%; border-collapse: collapse; font-family: 'JetBrains Mono'; font-size: 0.8rem; }
.forecast-table th { text-align: left; padding: 1rem; color: var(--text-muted); border-bottom: 1px solid var(--border); }
.forecast-table td { padding: 1rem; border-bottom: 1px solid var(--border); color: var(--text-primary); }
.trend-pill { padding: 2px 6px; border-radius: 2px; font-size: 0.7rem; font-weight: 700; }
.trend-up { color: var(--success); background: rgba(102, 194, 165, 0.1); }
.trend-down { color: var(--danger); background: rgba(251, 128, 114, 0.1); }

/* Insight Grid */
.insight-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 2rem; }
.insight-card { background: var(--bg-card); border: 1px solid var(--border); padding: 1rem; border-radius: 4px; }
.insight-val { font-size: 1.1rem; color: var(--text-primary); font-weight: 700; font-family: 'JetBrains Mono'; }
.insight-label { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.5rem; }

/* View Sections */
.view-section { display: none; }
.view-section.active { display: block; }

/* Loader */
.loader {
  position: fixed; inset: 0; z-index: 300;
  background: rgba(0,0,0,0.9);
  display: none; flex-direction: column; align-items: center; justify-content: center;
}
.spinner { width: 40px; height: 40px; border: 2px solid #333; border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }

/* Methodology Explainer */
.methodology-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 4px;
  padding: 1.5rem;
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 1.5rem;
}
.method-item {
  padding-bottom: 1rem;
  border-bottom: 1px solid var(--border);
}
.method-item:nth-last-child(-n+2) {
  border-bottom: none;
  padding-bottom: 0;
}
.method-title {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.85rem;
  font-weight: 700;
  color: var(--accent);
  margin-bottom: 0.5rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}
.method-title i {
  font-size: 0.75rem;
  opacity: 0.7;
}
.method-desc {
  font-size: 0.8rem;
  color: var(--text-muted);
  line-height: 1.5;
}
.method-desc code {
  background: rgba(255,255,255,0.1);
  padding: 2px 6px;
  border-radius: 3px;
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.75rem;
  color: var(--text-primary);
}
.method-desc strong {
  color: var(--text-primary);
}

@media (max-width: 768px) {
  .methodology-card {
    grid-template-columns: 1fr;
  }
  .method-item {
    border-bottom: 1px solid var(--border);
    padding-bottom: 1rem;
  }
  .method-item:last-child {
    border-bottom: none;
    padding-bottom: 0;
  }
}

/* Mobile */
@media (max-width: 768px) {
  .stats-row { grid-template-columns: 1fr 1fr; }
  .insight-grid { grid-template-columns: 1fr; }
  .btn-row { flex-direction: column; }
}
@media (max-width: 600px) {
  .stats-row { grid-template-columns: 1fr; gap: 0.5rem; }
  .stat-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 1rem; }
  .stat-label { margin-bottom: 0; }
  .chart-container { height: 400px; }
  .chart-wrapper { overflow-x: auto; }
  .chart-container { min-width: 600px; }
  .mode-toggle { flex-direction: column; }
}
</style>
</head>
<body>

<div id="heroView" class="hero-view">
  <div class="terminal-logo"><span>>_</span> Govhoo</div>
  <p class="hero-subtitle">Experimental Historical-based Forecasting</p>
  
  <div class="search-box-container">
    <input type="text" id="mainSearchInput" class="main-input" placeholder="Search keywords, company, or agency..." autocomplete="off">
    <div class="btn-row">
      <button id="searchBtn" class="btn-primary">
        <i class="fas fa-search"></i> SEARCH
      </button>
      <button id="forecastBtn" class="btn-secondary">
        <i class="fas fa-chart-line"></i> FORECAST
      </button>
    </div>
  </div>

  <div class="search-tips">
    <div class="tip-header"><i class="fas fa-terminal"></i> SEARCH_TIPS</div>
    <div class="tip-row"><span class="cmd-hl">cloud computing</span> <span>Search award descriptions, vendors, and agencies.</span></div>
    <div class="tip-row"><span class="cmd-hl">Company A, Company B</span> <span>Compare multiple competitors side-by-side.</span></div>
    <div class="tip-row"><span class="cmd-hl">Search Mode</span> <span>Shows Sankey flow + contract feed (past 12 months).</span></div>
    
	 <div class="tip-row">
      <span class="cmd-hl">DA10</span>
      <span>PSC code (searches descriptions, not PSC field).</span>
    </div>

	<div class="tip-row">
      <span class="cmd-hl">API Limits</span>
      <span>Search returns a max of 100 awards sorted by dollar value for the past 12 months.</span>
    </div>
    <div class="tip-row">
      <span class="cmd-hl">Fuzzy Search</span>
      <span>Quotes are ignored. "Pizza" returns pizza contracts AND Pizzaro's Construction. ¯\_(ツ)_/¯</span>
    </div>
 <div class="tip-row"><span class="cmd-hl">Forecast (experimental)</span> <span>Generates intelligent spending predictions with seasonal indexing. Now includes per-quarter outlier detection and weighted seasonality.</span></div>
	<div class="tip-row">
      <span class="cmd-hl">Questions?</span>
      <span>DM me on <a href="https://www.linkedin.com/in/markflournoy/" target="_blank" style="color: var(--accent); text-decoration: underline;">LinkedIn</a></span>
    </div>
	<div class="tip-row">
      <span class="cmd-hl">Data sourced live from USASpending.gov</span>
    </div>
  </div>
</div>

<div id="appView" style="display:none;">
  <header class="app-header">
    <div class="header-left">
      <div class="logo-btn" onclick="App.showHero()">Govhoo</div>
      <input type="text" id="miniSearch" class="mini-search" placeholder="New Search...">
    </div>
    <div class="header-actions">
      <button class="icon-btn" id="toggleModeBtn" onclick="App.toggleMode()" title="Toggle Mode">
        <i class="fas fa-exchange-alt"></i>
      </button>
      <button class="icon-btn" onclick="App.exportCSV()" title="Export CSV">
        <i class="fas fa-download"></i>
      </button>
    </div>
  </header>

  <div id="dashboardContainer" class="dashboard-container">
    
    <div class="mode-toggle">
      <button class="mode-btn active" id="modeSearchBtn" onclick="App.setMode('search')">
        <i class="fas fa-project-diagram"></i> Award Flow
      </button>
      <button class="mode-btn" id="modeForecastBtn" onclick="App.setMode('forecast')">
        <i class="fas fa-brain"></i> FY Forecast (Experimental)
      </button>
    </div>

    <div id="searchModeView" class="view-section active">
      <div class="stats-row" id="searchStats">
        <div class="stat-item">
          <div class="stat-label">Total $ Awards</div>
          <div class="stat-val" id="stat-vol">-</div>
          <div class="stat-sub neutral">Past 12 Months</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Contract Count</div>
          <div class="stat-val" id="stat-count">-</div>
          <div class="stat-sub neutral">Past 12 Months</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Prime Vendors</div>
          <div class="stat-val" id="stat-vendors">-</div>
          <div class="stat-sub neutral">Unique Recipients</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Agencies</div>
          <div class="stat-val" id="stat-agencies">-</div>
          <div class="stat-sub neutral">Awarding Agencies</div>
        </div>
      </div>

      <div class="section-header">
        <div class="section-title-group">
          <i class="fas fa-project-diagram" style="color:var(--accent)"></i>
          <span class="section-title">Capital Flow Analysis</span>
        </div>
        <div class="header-controls">
          <div id="filterBadge" class="filter-badge" onclick="App.clearFilter()">
            <span id="filterName">FILTER</span> <i class="fas fa-times"></i>
          </div>
          <div class="time-badge">PAST 12 MONTHS</div>
        </div>
      </div>
      <div class="chart-wrapper">
        <div id="chartContainer" class="chart-container"></div>
      </div>
      <p style="text-align:center; font-size:0.75rem; color:#666; margin-top:0.5rem;">
        <i class="fas fa-mouse-pointer"></i> Click bars to drill down
      </p>

      <div class="section-header">
        <div class="section-title-group">
          <i class="fas fa-list-ul" style="color:var(--accent)"></i>
          <span class="section-title">Contract Award Feed</span>
        </div>
      </div>
      <div id="feedGrid" class="feed-grid"></div>
    </div>

    <div id="forecastModeView" class="view-section">
      <div class="stats-row" id="forecastStats">
        <div class="stat-item">
          <div class="stat-label">Baseline Spend</div>
          <div class="stat-val" id="stat-baseline">-</div>
          <div class="stat-sub neutral">Seasonality Adjusted</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Market Status</div>
          <div class="stat-val" id="stat-market">-</div>
          <div class="stat-sub" id="stat-hhi">-</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Peak Season</div>
          <div class="stat-val" id="stat-peak">-</div>
          <div class="stat-sub neutral">Seasonal Index</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">Recompetes</div>
          <div class="stat-val" id="stat-recompetes">-</div>
          <div class="stat-sub" style="color:var(--danger)">Expiring < 2Y</div>
        </div>
      </div>

      <div class="section-header">
        <div class="section-title-group">
          <i class="fas fa-brain" style="color:var(--accent)"></i>
          <span class="section-title">Intelligent Forecast</span>
        </div>
      </div>
      <div id="marketInsights" class="insight-grid"></div>

      <div class="forecast-table-wrapper">
        <table class="forecast-table">
          <thead>
            <tr>
              <th>Period</th>
              <th>Predicted</th>
              <th>Hist. Avg</th>
              <th>Trend</th>
              <th>Confidence</th>
            </tr>
          </thead>
          <tbody id="forecastTableBody"></tbody>
        </table>
      </div>

      <div id="strategySection" style="margin-top: 2rem; display:none;">
        <div class="section-header">
           <div class="section-title-group">
              <i class="fas fa-chess-knight" style="color:var(--accent)"></i>
              <span class="section-title">Strategic Analysis & Actions</span>
           </div>
        </div>
        
        <div class="deal-card" style="border-left: 4px solid var(--accent); margin-bottom: 1.5rem;">
           <div class="deal-header" style="margin-bottom:0.5rem">
              <span class="deal-agency" style="font-size:0.8rem; letter-spacing:1px;">EXECUTIVE SUMMARY</span>
              <span class="deal-amount" id="strat-outlook" style="font-size:1.1rem">--</span>
           </div>
           <div class="deal-desc" id="strat-text" style="font-size: 0.95rem; color: #d0d0d0; line-height: 1.6; font-weight:400;"></div>
           
           <div class="deal-footer" style="margin-top:1rem; padding-top:1rem; border-top:1px solid #333; display:block;">
              <div style="font-size:0.75rem; color:var(--accent); font-weight:700; margin-bottom:4px;">RECOMMENDED ACTION:</div>
              <div id="strat-action" style="font-size:0.9rem; color:white;"></div>
           </div>
        </div>
      
        <div class="insight-grid" style="grid-template-columns: repeat(3, 1fr); gap:1rem; margin-bottom: 1.5rem;">
           <div class="insight-card">
              <div class="insight-label">BD Investment</div>
              <div id="matrix-bd" class="insight-val" style="font-size:0.95rem;">--</div>
              <div class="stat-sub neutral">Based on Growth</div>
           </div>
            <div class="insight-card">
              <div class="insight-label">Capture Strategy</div>
              <div id="matrix-strat" class="insight-val" style="font-size:0.95rem;">--</div>
              <div class="stat-sub neutral">Based on HHI</div>
           </div>
            <div class="insight-card">
              <div class="insight-label">Pipeline Focus</div>
              <div id="matrix-pipe" class="insight-val" style="font-size:0.95rem;">--</div>
              <div class="stat-sub neutral">Based on Recompetes</div>
           </div>
        </div>
        
        <div style="background:rgba(255,255,255,0.03); padding:1rem; border-radius:4px; font-size:0.8rem; color:#888; border:1px solid #333; line-height:1.5;">
          <strong style="color:var(--text-primary); display:block; margin-bottom:0.5rem;"><i class="fas fa-info-circle"></i> INTERPRETING THIS FORECAST</strong>
          This data predicts <strong>Total Addressable Market (TAM)</strong>, not your specific revenue. 
          <ul style="margin:0.5rem 0 0 1rem; padding:0;">
             <li><strong>Growth (+%)</strong> means more total dollars and RFPs entering the market (Higher Opportunity).</li>
             <li><strong>Decline (-%)</strong> means a tightening market; focus resources on "must-win" deals.</li>
          </ul>
        </div>
      </div>
<div class="section-header" style="margin-top:2rem;">
  <div class="section-title-group">
    <i class="fas fa-info-circle" style="color:var(--accent)"></i>
    <span class="section-title">How This Forecast Works</span>
  </div>
</div>

<div class="methodology-card">
  <div class="method-item">
    <div class="method-title"><i class="fas fa-layer-group"></i> Top-Down Volume Modeling</div>
    <div class="method-desc">Instead of guessing quarterly jumps, we first forecast the <strong>Total Annual Spending Volume</strong> using a weighted average of the last 3 fiscal years (giving higher priority to recent years).</div>
  </div>
  
  <div class="method-item">
    <div class="method-title"><i class="fas fa-chart-area"></i> Seasonal Profile Mapping</div>
    <div class="method-desc">We calculate the specific "Shape" of the fiscal year (e.g., how much of the budget typically lands in Q4 vs Q1) and distribute the forecasted annual volume according to this proven historical curve.</div>
  </div>

  <div class="method-item">
    <div class="method-title"><i class="fas fa-filter"></i> Smart Outlier Detection</div>
    <div class="method-desc">Anomalies are filtered <strong>per-quarter</strong>. This ensures that a massive Q4 spike (common in government) is recognized as a legitimate seasonal pattern, while random one-off mega-contracts are excluded.</div>
  </div>

  <div class="method-item">
    <div class="method-title"><i class="fas fa-balance-scale"></i> Market Concentration</div>
    <div class="method-desc">Calculates the <strong>HHI Score</strong> to measure competition. Scores under 1,500 indicate a competitive market, while scores over 2,500 indicate a market dominated by just one or two massive agencies.</div>
  </div>

  <div class="method-item">
    <div class="method-title"><i class="fas fa-redo"></i> Recompete Analysis</div>
    <div class="method-desc">The engine scans active contracts to identify high-value awards ($50k+) that are expiring within the next 6–24 months, flagging them as potential immediate opportunities.</div>
  </div>

  <div class="method-item">
    <div class="method-title"><i class="fas fa-calculator"></i> Prediction Formula</div>
    <div class="method-desc"><code>Predicted = Forecasted Annual Volume × Historical Seasonal %</code><br>The "Trend" percentage shown in the table is a result, representing how much the prediction differs from the raw historical average.</div>
  </div>
</div>
	  <div class="section-header" style="margin-top:2rem;">
        <div class="section-title-group">
          <i class="fas fa-chart-bar" style="color:var(--accent)"></i>
          <span class="section-title">Quarterly History</span>
        </div>
      </div>
      <div class="chart-wrapper chart-wrapper-sm">
        <canvas id="spendingChart"></canvas>
      </div>
      <div id="recompetesList" style="margin-top:2rem;"></div>
    </div>
  </div>
</div>

<div id="loader" class="loader">
  <div class="spinner"></div>
  <p id="loaderText" style="margin-top:1rem; font-family:'JetBrains Mono'; color:var(--accent);">RETRIEVING DATA...</p>
  <p id="loaderSubtext" style="color:#666; font-size:0.8rem; margin-top:0.5rem;"></p>
</div>

<script>
// ==================== UTILITIES ====================
const Utils = {
  money: n => {
    if (!n && n !== 0) return '-';
    if(n >= 1e9) return '$' + (n/1e9).toFixed(1) + 'B';
    if(n >= 1e6) return '$' + (n/1e6).toFixed(1) + 'M';
    if(n >= 1e3) return '$' + (n/1e3).toFixed(0) + 'K';
    return '$' + Math.round(n).toLocaleString();
  },
  trunc: (s, l) => (s && s.length > l) ? s.substring(0,l)+'...' : (s || 'No Description'),
  date: s => s ? new Date(s).toLocaleDateString() : '—',
  formatDateISO: date => date.toISOString().split('T')[0],
  
  getCurrentFY: () => {
    const now = new Date();
    // Federal FY starts Oct 1 (Month 9)
    return now.getMonth() >= 9 ? now.getFullYear() + 1 : now.getFullYear();
  },

  getCurrentQuarter: () => {
    const m = new Date().getMonth(); // 0-11
    // Oct(9), Nov(10), Dec(11) -> Q1
    // Jan(0), Feb(1), Mar(2)   -> Q2
    // Apr(3), May(4), Jun(5)   -> Q3
    // Jul(6), Aug(7), Sep(8)   -> Q4
    if (m >= 9) return 1;
    if (m <= 2) return 2;
    if (m <= 5) return 3;
    return 4;
  },
  
  generateWeights: count => {
    if (count <= 0) return [];
    if (count === 1) return [1];
    if (count === 2) return [0.3, 0.7];
    if (count === 3) return [0.2, 0.3, 0.5];
    
    // For more years, favor recent heavily
    const weights = [];
    let sum = 0;
    // Exponential-ish weights
    for(let i=0; i<count; i++) {
        let w = Math.pow(1.5, i);
        weights.push(w);
        sum += w;
    }
    return weights.map(w => w / sum);
  },
  
  getColor: name => {
    const palette = ['#958BB6', '#6F8A74', '#C27E5C', '#8FB6D0', '#B0C4DE', '#D9B48F'];
    let hash = 0;
    for (let i = 0; i < name.length; i++) {
      hash = name.charCodeAt(i) + ((hash << 5) - hash);
    }
    return palette[Math.abs(hash) % palette.length];
  }
};

// ==================== API ====================
const API = {
  baseUrl: 'https://api.usaspending.gov/api/v2',
  
  // Search Mode API
  async searchAwards(keywords) {
    const today = new Date();
    const oneYearAgo = new Date();
    oneYearAgo.setFullYear(today.getFullYear() - 1);
    
    const period = {
      start_date: Utils.formatDateISO(oneYearAgo),
      end_date: Utils.formatDateISO(today)
    };
    
    const terms = keywords.split(',').map(s => s.trim()).filter(s => s.length > 0);
    
    const fetchPromises = terms.map(term => {
      return fetch(`${this.baseUrl}/search/spending_by_award/`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          filters: { 
            keywords: [term], 
            time_period: [period],
            award_type_codes: ['A','B','C','D']
          },
          fields: [
            'Award ID', 'Recipient Name', 'Awarding Agency', 'Awarding Sub Agency',
            'Award Amount', 'Description', 'generated_internal_id',
            'Start Date', 'End Date', 'NAICS Code', 'NAICS Description', 'PSC Code', 'PSC Description'
          ],
          limit: 100,
          sort: 'Award Amount',
          order: 'desc'
        })
      }).then(res => res.json());
    });
    
    const results = await Promise.all(fetchPromises);
    let combined = [];
    results.forEach(json => {
      if(json.results) combined = combined.concat(json.results);
    });
    
    // Deduplicate
    const unique = new Map();
    combined.forEach(item => {
      if(!unique.has(item['Award ID'])) unique.set(item['Award ID'], item);
    });
    
    return Array.from(unique.values()).sort((a,b) => b['Award Amount'] - a['Award Amount']);
  },
  
  // Forecast Mode APIs
  async getSpendingOverTime(keywords, yearsBack=4) {
    const curFY = Utils.getCurrentFY();
    const periods = [];
    // Get extra history to establish trends
    for(let y=curFY-yearsBack; y<=curFY; y++) {
      periods.push({start_date:`${y-1}-10-01`, end_date:`${y}-09-30`});
    }
    
    const res = await fetch(`${this.baseUrl}/search/spending_over_time/`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        group: 'quarter',
        filters: { keywords:[keywords], time_period:periods, award_type_codes:['A','B','C','D'] }
      })
    });
    return (await res.json()).results || [];
  },
  
  async getAgencyData(keywords, yearsBack=3) {
    const curFY = Utils.getCurrentFY();
    const periods = [{start_date:`${curFY-yearsBack-1}-10-01`, end_date:`${curFY}-09-30`}];
    
    const res = await fetch(`${this.baseUrl}/search/spending_by_category/awarding_agency`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        category: 'awarding_agency',
        filters: { keywords:[keywords], time_period:periods, award_type_codes:['A','B','C','D'] },
        limit: 100
      })
    });
    return (await res.json()).results || [];
  },
  
  async getAwardsForForecast(keywords, yearsBack=3) {
    const curFY = Utils.getCurrentFY();
    // We want current active contracts primarily
    const periods = [{start_date:`${curFY-yearsBack-1}-10-01`, end_date:`${curFY+5}-09-30`}];
    
    const res = await fetch(`${this.baseUrl}/search/spending_by_award/`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        filters: { keywords:[keywords], time_period:periods, award_type_codes:['A','B','C','D'] },
        fields: ['Award ID','Recipient Name','Description','Start Date','End Date','Award Amount','Awarding Agency','generated_internal_id'],
        // FIX: Sort by Amount DESC to get big contracts, not "End Date DESC" which gives contracts ending in 2030
        limit: 100, 
        sort: 'Award Amount',
        order: 'desc'
      })
    });
    return (await res.json()).results || [];
  }
};

// ==================== FORECAST ENGINE ====================
const ForecastEngine = {
  analyze(spendingData, awardsData, agencyData) {
    // 1. Organize Data
    const organized = this.organizeByQuarter(spendingData);
    
    // 2. Filter Global Outliers (Quarterly specific)
    const filtered = this.filterOutliers(organized);
    
    // 3. Calculate Seasonality (The "Shape" of the year)
    // Returns {1: 0.15, 2: 0.20, 3: 0.25, 4: 0.40} summing to 1.0
    const seasonalProfile = this.calculateSeasonalProfile(filtered);
    
    // 4. Calculate Annual Baseline (The "Volume" of the year)
    // Uses weighted average of last 3 completed fiscal years
    const annualForecast = this.calculateAnnualForecast(filtered);
    
    // 5. Detect Recompetes & Market Health
    const recompetes = this.detectRecompetes(awardsData);
    const market = this.analyzeMarketConcentration(agencyData);
    
    // 6. Generate Quarterly Predictions (Top-Down distribution)
    const forecasts = this.generateForecasts(annualForecast, seasonalProfile, filtered);

    const strategy = this.generateStrategy(forecasts, market.hhi, recompetes);

    return {
      forecasts,
      recompetes,
      baseline: annualForecast,
      marketStatus: market.level,
      hhi: market.hhi,
      indices: seasonalProfile,
      byFY: organized.byFY,
      strategy: strategy // <--- Return this
    };
  },

  organizeByQuarter(spendingData) {
    const organized = { byFY: {}, byQuarter: {}, totalByFY: {}, allAmounts: [] };
    spendingData.forEach(d => {
      const q = parseInt(d.time_period?.quarter);
      const fy = parseInt(d.time_period?.fiscal_year);
      const amt = d.aggregated_amount || 0;
      if(q && fy) {
        if(!organized.byFY[fy]) organized.byFY[fy] = {1:0, 2:0, 3:0, 4:0};
        organized.byFY[fy][q] = amt;
        if(!organized.byQuarter[q]) organized.byQuarter[q] = [];
        organized.byQuarter[q].push({fy, amt});
        organized.totalByFY[fy] = (organized.totalByFY[fy] || 0) + amt;
        organized.allAmounts.push({fy, q, amt});
      }
    });
    return organized;
  },

  filterOutliers(organized) {
    // Standard deviation filter per quarter to remove massive anomalies
    const filtered = { byFY: {}, byQuarter: {}, totalByFY: {}, allAmounts: [] };
    Object.keys(organized.byFY).forEach(fy => filtered.byFY[fy] = {}); // Init structure
    
    for(let q=1; q<=4; q++) {
      const qData = organized.byQuarter[q] || [];
      const amounts = qData.map(d => d.amt);
      
      // If scant data, keep everything
      if(amounts.length < 3) {
        qData.forEach(d => {
           filtered.byQuarter[q] = filtered.byQuarter[q] || [];
           filtered.byQuarter[q].push(d);
           filtered.byFY[d.fy][q] = d.amt;
           filtered.totalByFY[d.fy] = (filtered.totalByFY[d.fy]||0) + d.amt;
        });
        continue;
      }
      
      // Calculate Stats
      const mean = amounts.reduce((a,b)=>a+b,0) / amounts.length;
      const variance = amounts.reduce((s,v)=>s+Math.pow(v-mean,2),0) / amounts.length;
      const stdDev = Math.sqrt(variance);
      const limit = mean + (2 * stdDev); 
      
      qData.forEach(item => {
        // Only filter high-side outliers (spikes), keep lows (zeros are real in gov)
        if(item.amt <= limit) {
           filtered.byQuarter[q] = filtered.byQuarter[q] || [];
           filtered.byQuarter[q].push(item);
           filtered.byFY[item.fy][q] = item.amt;
           filtered.totalByFY[item.fy] = (filtered.totalByFY[item.fy]||0) + item.amt;
        }
      });
    }
    return filtered;
  },

  calculateSeasonalProfile(filtered) {
    // Determine what % of the year usually happens in Q1, Q2, Q3, Q4
    const quarters = {1:0, 2:0, 3:0, 4:0};
    const counts = {1:0, 2:0, 3:0, 4:0};
    
    // Look at every completed year
    const years = Object.keys(filtered.totalByFY);
    years.forEach(fy => {
        const total = filtered.totalByFY[fy];
        if(total <= 0) return;
        
        // Only use years that have data for at least 3 quarters to avoid skewing
        const qWithData = Object.values(filtered.byFY[fy]).filter(v => v > 0).length;
        if(qWithData < 3) return;

        for(let q=1; q<=4; q++) {
            const amt = filtered.byFY[fy][q] || 0;
            quarters[q] += (amt / total); // Add the percentage (e.g. 0.25)
            counts[q]++;
        }
    });

    // Average the percentages
    const profile = {};
    let sum = 0;
    for(let q=1; q<=4; q++) {
        profile[q] = counts[q] ? quarters[q] / counts[q] : 0.25;
        sum += profile[q];
    }
    
    // Normalize to ensure sum is exactly 1.0
    for(let q=1; q<=4; q++) profile[q] = profile[q] / sum;
    
    return profile;
  },

  calculateAnnualForecast(filtered) {
    // Weighted Average of Annual Totals (ignoring incomplete current FY)
    const curFY = Utils.getCurrentFY();
    const years = Object.keys(filtered.totalByFY).map(Number).sort((a,b)=>a-b);
    
    // Filter out the current incomplete year and years with zero spend
    const cleanYears = years.filter(y => y < curFY && filtered.totalByFY[y] > 0);
    
    if(cleanYears.length === 0) return 0;
    
    // Weight recent years more heavily (1, 2, 3...)
    let weightedSum = 0;
    let weightTotal = 0;
    
    cleanYears.forEach((fy, index) => {
        const weight = index + 1; 
        weightedSum += filtered.totalByFY[fy] * weight;
        weightTotal += weight;
    });
    
    let baseline = weightedSum / weightTotal;

    // FIX: Removed the arbitrary +/- 5% logic.
    // New Logic: If we have at least 2 years of data, blend the Baseline with the Most Recent Year.
    // This allows the forecast to react to recent trends without being too volatile.
    if(cleanYears.length >= 2) {
        const recentYear = filtered.totalByFY[cleanYears[cleanYears.length-1]];
        // 70% Weight to the Stable Baseline, 30% Weight to the Recent Year
        baseline = (baseline * 0.7) + (recentYear * 0.3);
    }
    
    return baseline;
  },

  analyzeMarketConcentration(agencyData) {
    const total = agencyData.reduce((s,a)=>s+a.amount,0);
    let hhi = 0;
    agencyData.forEach(a => {
      const share = (a.amount / total) * 100;
      hhi += share * share;
    });
    let level = "Competitive";
    if(hhi > 2500) level = "Concentrated";
    else if(hhi > 1500) level = "Moderate";
    return { hhi: Math.round(hhi), level };
  },

  detectRecompetes(awards) {
    const now = new Date();
    const sixMonths = new Date(); sixMonths.setMonth(now.getMonth() + 6);
    const twoYears = new Date(); twoYears.setFullYear(now.getFullYear()+2);
    return awards.filter(a => {
      const end = new Date(a['End Date']);
      return end > sixMonths && end < twoYears && a['Award Amount'] > 50000;
    }).slice(0, 15);
  },

  generateForecasts(annualForecast, seasonalProfile, filtered) {
    const forecasts = [];
    const curFY = Utils.getCurrentFY();
    const curQ = Utils.getCurrentQuarter();
    
    let fy = curFY;
    let q = curQ;
    
    for(let i=0; i<4; i++) {
      // 1. Prediction: Apply the seasonal % to the Annual Forecast Total
      const predicted = annualForecast * seasonalProfile[q];
      
      // 2. Historical Context: Get the weighted average for this specific quarter
      // We recalculate a simple average of past Q's to show as "Hist. Avg" comparison
      const qHistory = filtered.byQuarter[q] || [];
      const validHistory = qHistory.filter(d => d.amt > 0);
      let histAvg = 0;
      if(validHistory.length) {
          histAvg = validHistory.reduce((s, d) => s + d.amt, 0) / validHistory.length;
      }

      // 3. Trend Calculation: Now we derive the trend from the result
      // "How different is our prediction from the historical average?"
      let displayTrend = 0;
      if(histAvg > 0) {
          displayTrend = ((predicted - histAvg) / histAvg) * 100;
      } else if (predicted > 0) {
          displayTrend = 100;
      }

      // 4. Confidence
      let confidence = validHistory.length >= 3 ? "High" : (validHistory.length >= 2 ? "Med" : "Low");
      
      forecasts.push({
        period: `FY${fy} Q${q}`,
        predicted: predicted,
        histAvg: histAvg,
        trend: displayTrend > 0 ? `+${displayTrend.toFixed(1)}` : displayTrend.toFixed(1),
        confidence: confidence
      });
      
      q++;
      if(q > 4) { q = 1; fy++; }
    }
    return forecasts;
  },
  
  generateStrategy(forecasts, hhi, recompetes) {
    // 0. Safety Check
    if(!forecasts || forecasts.length < 2) return null;

    // 1. Analyze Growth (Avg of next 2 quarters)
    const nearTerm = forecasts.slice(0, 2);
    // Parse floats from strings like "+14.1"
    const avgGrowth = nearTerm.reduce((sum, f) => sum + parseFloat(f.trend), 0) / nearTerm.length;
    
    let growthSignal = "Moderate";
    if (avgGrowth > 20) growthSignal = "High Growth";
    else if (avgGrowth < -20) growthSignal = "Decline";

    // 2. Analyze Market
    let marketType = "Moderate";
    if (hhi > 2500) marketType = "Concentrated";
    else if (hhi < 1500) marketType = "Competitive";

    // 3. Generate Executive Text
    let outlook = "";
    let action = "";
    
    // Outlook Text
    if (growthSignal === "High Growth") {
        outlook = `The forecast indicates aggressive market expansion (+${avgGrowth.toFixed(1)}% avg). Expect a surge in RFPs and contracting activity.`;
        action = "Increase capture capacity immediately. Staff up for proposal volume.";
    } else if (growthSignal === "Decline") {
        outlook = `The market is contracting (${avgGrowth.toFixed(1)}% avg). Fewer total dollars will be awarded compared to historical averages.`;
        action = "Consolidate BD resources. Focus strictly on existing relationships and 'must-win' recompetes.";
    } else {
        outlook = `The market is showing stable, moderate activity. Volume is consistent with historical norms.`;
        action = "Maintain steady BD cadence. Focus on quality of capture over volume.";
    }

    // Add Market Nuance
    if (marketType === "Concentrated") {
        outlook += ` Because the market is Concentrated (HHI > 2500), new entry will be difficult without teaming.`;
        action += " Prioritize relationships with the top 3 incumbent agencies.";
    } else if (marketType === "Competitive") {
        outlook += ` The Competitive landscape (HHI < 1500) suggests a fragmented buyer base with many entry points.`;
        action += " Widen your prospecting net; this is a volume play.";
    }

    // 4. Matrix Values
    const matrix = {
        bd: growthSignal === "High Growth" ? "Increase Investment" : (growthSignal === "Decline" ? "Reduce / Reassign" : "Maintain Steady"),
        strat: marketType === "Concentrated" ? "Relationship Focus" : (marketType === "Competitive" ? "Volume Bidding" : "Balanced Approach"),
        pipe: recompetes.length > 5 ? "Incumbent Displacement" : "New Requirements"
    };

    return {
        title: growthSignal === "High Growth" ? "High Activity Expected" : (growthSignal === "Decline" ? "Market Contraction" : "Stable Market Outlook"),
        text: outlook,
        action: action,
        matrix: matrix
    };
  }
};
// ==================== APP ====================
const App = {
  mode: 'search', // 'search' or 'forecast'
  currentQuery: '',
  
  // Search mode state
  searchData: {
    raw: [],
    active: [],
    filter: null,
    loaded: false
  },
  
  // Forecast mode state
  forecastData: {
    spending: null,
    agencies: null,
    awards: null,
    analysis: null,
    loaded: false
  },

  init() {
    document.getElementById('searchBtn').onclick = () => App.runSearch();
    document.getElementById('forecastBtn').onclick = () => App.runForecast();
    
    document.getElementById('mainSearchInput').addEventListener('keypress', e => {
      if(e.key === 'Enter') App.runSearch();
    });
    
    document.getElementById('miniSearch').addEventListener('keypress', e => {
      if(e.key === 'Enter') {
        const newQuery = e.target.value.trim();
        if(!newQuery) return;
        
        // Update main input as well
        document.getElementById('mainSearchInput').value = newQuery;
        
        if(App.mode === 'forecast') {
          App.runForecast(newQuery);
        } else {
          App.runSearch(newQuery);
        }
      }
    });

    let resizeTimer;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(() => {
        if(App.searchData.active.length > 0 && App.mode === 'search') App.renderSankey();
      }, 200);
    });

    const params = new URLSearchParams(window.location.search);
    const q = params.get('q');
    const m = params.get('mode');
    if (q) {
      document.getElementById('mainSearchInput').value = q;
      if(m === 'forecast') App.runForecast(q);
      else App.runSearch(q);
    }
  },

  showHero() {
    const hero = document.getElementById('heroView');
    document.getElementById('appView').style.display = 'none';
    hero.style.display = 'flex';
    hero.classList.remove('hidden');
    setTimeout(() => hero.classList.remove('slide-up'), 10);
    
    const url = new URL(window.location);
    url.searchParams.delete('q');
    url.searchParams.delete('mode');
    window.history.replaceState({}, '', url);
  },

  setMode(mode) {
    App.mode = mode;
    document.getElementById('modeSearchBtn').classList.toggle('active', mode === 'search');
    document.getElementById('modeForecastBtn').classList.toggle('active', mode === 'forecast');
    document.getElementById('searchModeView').classList.toggle('active', mode === 'search');
    document.getElementById('forecastModeView').classList.toggle('active', mode === 'forecast');
    
    // Update URL
    const url = new URL(window.location);
    url.searchParams.set('mode', mode);
    window.history.replaceState({}, '', url);
    
    // If switching to a mode that hasn't loaded data yet, fetch it
    if(App.currentQuery) {
      if(mode === 'search' && !App.searchData.loaded) {
        App.runSearch(App.currentQuery);
      } else if(mode === 'forecast' && !App.forecastData.loaded) {
        App.runForecast(App.currentQuery);
      }
    }
  },

  toggleMode() {
    const newMode = App.mode === 'search' ? 'forecast' : 'search';
    App.setMode(newMode);
  },

  // ==================== SEARCH MODE ====================
  async runSearch(val) {
    const query = val || document.getElementById('mainSearchInput').value;
    if(!query) return;

    const isNewQuery = query !== App.currentQuery;
    if(isNewQuery) {
      App.searchData = { raw: [], active: [], filter: null, loaded: false };
      App.forecastData = { spending: null, agencies: null, awards: null, analysis: null, loaded: false };
    }
    
    App.currentQuery = query;
    App.mode = 'search';
    App.showLoader('RETRIEVING DATA...', 'Searching USASpending API');

    try {
      App.searchData.raw = await API.searchAwards(query);
      App.searchData.filter = null;
      App.searchData.active = App.searchData.raw;
      App.searchData.loaded = true;
      
      App.updateURL(query, 'search');
      App.transitionToApp();
      App.setMode('search');
      App.updateSearchDashboard();
      
      requestAnimationFrame(() => {
        requestAnimationFrame(() => App.renderSankey());
      });
      
    } catch(e) {
      console.error(e);
      alert("Error retrieving data.");
    } finally {
      App.hideLoader();
    }
  },

  updateSearchDashboard() {
    const data = App.searchData.active;
    const total = data.reduce((acc, c) => acc + (c['Award Amount']||0), 0);
    const vendors = new Set(data.map(c => c['Recipient Name'])).size;
    const agencies = new Set(data.map(c => c['Awarding Agency'])).size;
    
    document.getElementById('stat-vol').innerText = Utils.money(total);
    document.getElementById('stat-count').innerText = data.length;
    document.getElementById('stat-vendors').innerText = vendors;
    document.getElementById('stat-agencies').innerText = agencies;
    
    // Filter badge
    const badge = document.getElementById('filterBadge');
    if (App.searchData.filter) {
      badge.style.display = 'inline-flex';
      document.getElementById('filterName').innerText = App.searchData.filter;
    } else {
      badge.style.display = 'none';
    }
    
    App.renderFeed();
  },

  renderSankey() {
    const container = document.getElementById('chartContainer');
    container.innerHTML = '';
    
    const data = App.searchData.active;
    
    if(data.length === 0) {
      container.innerHTML = '<div style="text-align:center; padding:4rem; color:#666">No data to display</div>';
      return;
    }
    
    container.innerHTML = '<svg id="sankeySvg"></svg>';

    const flowMap = {};
    data.forEach(d => {
      if(d['Award Amount'] > 0) {
        const src = d['Awarding Agency'] || 'Unknown Agency';
        const tgt = d['Recipient Name'] || 'Unknown Vendor';
        const k = src + "|||" + tgt;
        flowMap[k] = (flowMap[k] || 0) + d['Award Amount'];
      }
    });

    let nodesSet = new Set();
    let links = [];
    const limit = App.searchData.filter ? 100 : 25; 
    const sortedFlows = Object.entries(flowMap).sort((a,b) => b[1] - a[1]).slice(0, limit);

    sortedFlows.forEach(([k, val]) => {
      const [src, tgt] = k.split("|||");
      nodesSet.add(src);
      nodesSet.add(tgt);
      links.push({source: src, target: tgt, value: val});
    });

    const nodes = Array.from(nodesSet).map(n => ({name: n}));
    const nodeMap = new Map(nodes.map((n, i) => [n.name, i]));
    
    const d3Links = links.map(l => ({
      source: nodeMap.get(l.source),
      target: nodeMap.get(l.target),
      value: l.value
    }));

    const width = container.offsetWidth || 800; 
    const height = 500;

    const svg = d3.select("#sankeySvg").attr("width", width).attr("height", height);

    const sankey = d3.sankey()
      .nodeId(d => d.index)
      .nodeWidth(20)
      .nodePadding(15)
      .extent([[1, 1], [width - 1, height - 6]]);

    const {nodes: graphNodes, links: graphLinks} = sankey({
      nodes: nodes.map(d => Object.assign({}, d)),
      links: d3Links.map(d => Object.assign({}, d))
    });

    svg.append("g")
      .selectAll("rect")
      .data(graphNodes)
      .join("rect")
      .attr("x", d => d.x0)
      .attr("y", d => d.y0)
      .attr("height", d => d.y1 - d.y0)
      .attr("width", d => d.x1 - d.x0)
      .attr("fill", d => Utils.getColor(d.name))
      .attr("opacity", d => (App.searchData.filter && d.name !== App.searchData.filter) ? 0.3 : 0.9)
      .attr("rx", 2)
      .style("cursor", "pointer")
      .on("click", (e, d) => App.drillDown(d.name))
      .append("title")
      .text(d => `${d.name}\n${Utils.money(d.value)}`);

    svg.append("g")
      .selectAll("text")
      .data(graphNodes)
      .join("text")
      .attr("x", d => d.x0 < width / 2 ? d.x1 + 6 : d.x0 - 6)
      .attr("y", d => (d.y1 + d.y0) / 2)
      .attr("dy", "0.35em")
      .attr("text-anchor", d => d.x0 < width / 2 ? "start" : "end")
      .text(d => Utils.trunc(d.name, width > 600 ? 30 : 15))
      .attr("fill", "#fff")
      .style("font-size", "11px")
      .style("font-family", "Inter")
      .style("font-weight", "500")
      .style("cursor", "pointer")
      .style("text-shadow", "0 1px 2px black")
      .on("click", (e, d) => App.drillDown(d.name));

    const defs = svg.append("defs");
    graphLinks.forEach((l, i) => {
      const gradient = defs.append("linearGradient")
        .attr("id", "grad" + i)
        .attr("gradientUnits", "userSpaceOnUse")
        .attr("x1", l.source.x1).attr("x2", l.target.x0);
      gradient.append("stop").attr("offset", "0%").attr("stop-color", Utils.getColor(l.source.name));
      gradient.append("stop").attr("offset", "100%").attr("stop-color", Utils.getColor(l.target.name));
    });

    svg.append("g")
      .attr("fill", "none")
      .selectAll("path")
      .data(graphLinks)
      .join("path")
      .attr("d", d3.sankeyLinkHorizontal())
      .attr("stroke", (d, i) => "url(#grad" + i + ")")
      .attr("stroke-width", d => Math.max(1, d.width))
      .attr("stroke-opacity", 0.5)
      .style("mix-blend-mode", "screen")
      .on("mouseover", function() { d3.select(this).attr("stroke-opacity", 0.8); })
      .on("mouseout", function() { d3.select(this).attr("stroke-opacity", 0.5); });
  },

  renderFeed() {
    const div = document.getElementById('feedGrid');
    const data = App.searchData.active;
    
    if(data.length === 0) {
      div.innerHTML = '<div style="text-align:center; padding:2rem; color:#666">No contracts found.</div>';
      return;
    }

    div.innerHTML = data.map(c => {
      const internalId = c['generated_internal_id'];
      let url = '#';
      if (internalId) url = `https://www.usaspending.gov/award/${internalId}`;
      else if (c['Award ID']) url = `https://www.usaspending.gov/search/?hash=&filters=${encodeURIComponent(JSON.stringify({keyword: c['Award ID']}))}`;

      let metaTags = '';
      if (c['NAICS Code']) metaTags += `<span class="meta-tag naics" title="${c['NAICS Description'] || ''}">NAICS: ${c['NAICS Code']}</span>`;
      if (c['PSC Code']) metaTags += `<span class="meta-tag psc" title="${c['PSC Description'] || ''}">PSC: ${c['PSC Code']}</span>`;

      return `
        <div class="deal-card">
          <div class="deal-header">
            <span class="deal-agency">${Utils.trunc(c['Awarding Agency'], 35)}</span>
            <span class="deal-amount">${Utils.money(c['Award Amount'])}</span>
          </div>
          <div class="deal-desc">${Utils.trunc(c['Description'], 100)}</div>
          <div class="deal-vendor">${c['Recipient Name']}</div>
          ${metaTags ? `<div class="deal-meta">${metaTags}</div>` : ''}
          <div class="deal-footer">
            <span class="deal-date">Start: ${Utils.date(c['Start Date'])}${c['End Date'] ? ' → ' + Utils.date(c['End Date']) : ''}</span>
            <a href="${url}" target="_blank" class="action-btn">OPEN AWARD <i class="fas fa-external-link-alt"></i></a>
          </div>
        </div>
      `;
    }).join('');
  },

  drillDown(name) {
    if (App.searchData.filter === name) {
      App.clearFilter();
      return;
    }
    App.searchData.filter = name;
    App.searchData.active = App.searchData.raw.filter(d => 
      d['Awarding Agency'] === name || d['Recipient Name'] === name
    );
    App.updateSearchDashboard();
    App.renderSankey();
  },

  clearFilter() {
    App.searchData.filter = null;
    App.searchData.active = App.searchData.raw;
    App.updateSearchDashboard();
    App.renderSankey();
  },

  // ==================== FORECAST MODE ====================
  async runForecast(val) {
    const query = val || document.getElementById('mainSearchInput').value;
    if(!query) return;

    const isNewQuery = query !== App.currentQuery;
    if(isNewQuery) {
      App.searchData = { raw: [], active: [], filter: null, loaded: false };
      App.forecastData = { spending: null, agencies: null, awards: null, analysis: null, loaded: false };
    }
    
    const chartStatus = Chart.getChart("spendingChart");
    if (chartStatus) chartStatus.destroy();
    
    App.currentQuery = query;
    App.mode = 'forecast';
    App.showLoader('CRUNCHING NUMBERS...', 'Applying Recency-Weighted Seasonality');

    try {
      const [spending, agencies, awards] = await Promise.all([
        API.getSpendingOverTime(query),
        API.getAgencyData(query),
        API.getAwardsForForecast(query)
      ]);

      App.forecastData.spending = spending;
      App.forecastData.agencies = agencies;
      App.forecastData.awards = awards;
      App.forecastData.analysis = ForecastEngine.analyze(spending, awards, agencies);
      App.forecastData.loaded = true;
      
      App.updateURL(query, 'forecast');
      App.transitionToApp();
      App.setMode('forecast');
      App.renderForecastDashboard();
      
    } catch(e) {
      console.error(e);
      alert("Error fetching forecast data.");
    } finally {
      App.hideLoader();
    }
  },

  renderForecastDashboard() {
    const analysis = App.forecastData.analysis;
    const awards = App.forecastData.awards;
    
    if(!analysis) return;

    // --- 1. Top Stats Row ---
    document.getElementById('stat-baseline').innerText = Utils.money(analysis.baseline);
    document.getElementById('stat-market').innerText = analysis.marketStatus;
    document.getElementById('stat-hhi').innerText = `HHI: ${analysis.hhi}`;
    
    let peakQ=1, peakV=0;
    for(let q=1; q<=4; q++) if(analysis.indices[q]>peakV) { peakV=analysis.indices[q]; peakQ=q; }
    document.getElementById('stat-peak').innerText = `Q${peakQ}`;
    document.getElementById('stat-recompetes').innerText = analysis.recompetes.length;

    // --- 2. Market Insights (Concentration & Top Vendor) ---
    const topVendor = awards[0] ? awards[0]['Recipient Name'] : 'Unknown';
    document.getElementById('marketInsights').innerHTML = `
      <div class="insight-card">
        <div class="insight-label">Market Concentration</div>
        <div class="insight-val" style="color:${analysis.hhi>2500?'var(--danger)':'var(--success)'}">${analysis.marketStatus}</div>
        <div style="font-size:0.8rem; color:#666; margin-top:5px">HHI Score: ${analysis.hhi}</div>
      </div>
      <div class="insight-card">
        <div class="insight-label">Top Incumbent</div>
        <div class="insight-val" style="font-size:0.9rem">${Utils.trunc(topVendor, 30)}</div>
      </div>`;

    // --- 3. Forecast Table ---
    const tb = document.getElementById('forecastTableBody');
    tb.innerHTML = '';
    analysis.forecasts.forEach(f => {
      // Determine if trend is positive for coloring
      const isUp = f.trend.includes('+'); 
      tb.innerHTML += `
        <tr>
          <td><b>${f.period}</b></td>
          <td style="color:var(--accent); font-weight:700">${Utils.money(f.predicted)}</td>
          <td style="color:#666">${Utils.money(f.histAvg)}</td>
          <td><span class="trend-pill ${isUp?'trend-up':'trend-down'}">${isUp?'▲':'▼'} ${f.trend}%</span></td>
          <td style="color:${f.confidence==='High'?'var(--success)':'#888'}">${f.confidence}</td>
        </tr>`;
    });

    // --- 4. Strategic Analysis (Executive Summary & Matrix) ---
    const strat = analysis.strategy;
    const stratSection = document.getElementById('strategySection');
    
    if(strat && stratSection) {
        stratSection.style.display = 'block';
        
        // Executive Card Text
        const outlookElem = document.getElementById('strat-outlook');
        outlookElem.innerText = strat.title;
        // Color code the title based on content
        if(strat.title.includes("High")) outlookElem.style.color = "var(--success)";
        else if(strat.title.includes("Contraction")) outlookElem.style.color = "var(--danger)";
        else outlookElem.style.color = "var(--accent)";

        document.getElementById('strat-text').innerText = strat.text;
        document.getElementById('strat-action').innerText = strat.action;
        
        // Matrix Values
        const bdElem = document.getElementById('matrix-bd');
        bdElem.innerText = strat.matrix.bd;
        bdElem.style.color = strat.matrix.bd.includes("Increase") ? "var(--success)" : "white";
        
        document.getElementById('matrix-strat').innerText = strat.matrix.strat;
        document.getElementById('matrix-pipe').innerText = strat.matrix.pipe;
    } else if (stratSection) {
        stratSection.style.display = 'none';
    }

    // --- 5. Recompetes List ---
    const rl = document.getElementById('recompetesList');
    if(analysis.recompetes.length) {
      rl.innerHTML = `<div class="section-header"><div class="section-title-group"><i class="fas fa-exclamation-triangle" style="color:var(--danger)"></i><span class="section-title" style="color:var(--danger)">Recompete Opportunities</span></div></div>` + 
      analysis.recompetes.map(r => {
        const internalId = r['generated_internal_id'];
        let awardUrl = '#';
        if (internalId) {
          awardUrl = `https://www.usaspending.gov/award/${internalId}`;
        } else if (r['Award ID']) {
          awardUrl = `https://www.usaspending.gov/search/?hash=&filters=${encodeURIComponent(JSON.stringify({keyword: r['Award ID']}))}`;
        }
        
        return `
        <div class="deal-card" style="margin-bottom:1rem">
          <div class="deal-header">
            <span class="deal-agency">${Utils.trunc(r['Awarding Agency'], 40)}</span>
            <span class="deal-amount">${Utils.money(r['Award Amount'])}</span>
          </div>
          <div class="deal-desc">${Utils.trunc(r['Description'], 80)}</div>
          <div style="font-size:0.8rem; color:var(--danger); margin-bottom:0.5rem">Expires: ${Utils.date(r['End Date'])}</div>
          <div style="font-size:0.8rem; color:#666; margin-bottom:0.75rem">${r['Recipient Name']}</div>
          <a href="${awardUrl}" target="_blank" class="action-btn" style="display:inline-flex; width:auto;">
            VIEW AWARD <i class="fas fa-external-link-alt"></i>
          </a>
        </div>
      `}).join('');
    } else {
      rl.innerHTML = '';
    }

    // --- 6. Render Chart ---
    App.renderHistoricalChart(analysis.byFY);
  },

  renderHistoricalChart(byFY) {
    const ctx = document.getElementById('spendingChart').getContext('2d');
    const years = Object.keys(byFY).sort();
    
    const chartStatus = Chart.getChart("spendingChart");
    if (chartStatus != undefined) chartStatus.destroy();

    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: years.map(y=>`FY${y}`),
        datasets: [
          { label:'Q1', data:years.map(y=>byFY[y][1]||0), backgroundColor:'#958BB6' },
          { label:'Q2', data:years.map(y=>byFY[y][2]||0), backgroundColor:'#6F8A74' },
          { label:'Q3', data:years.map(y=>byFY[y][3]||0), backgroundColor:'#8FB6D0' },
          { label:'Q4', data:years.map(y=>byFY[y][4]||0), backgroundColor:'#C27E5C' }
        ]
      },
      options: {
        responsive:true, maintainAspectRatio:false,
        scales:{ x:{grid:{display:false}}, y:{grid:{color:'#333'}} },
        plugins:{ legend:{labels:{color:'#888'}} }
      }
    });
  },

  // ==================== UTILITIES ====================
  showLoader(text, subtext) {
    document.getElementById('loaderText').innerText = text;
    document.getElementById('loaderSubtext').innerText = subtext || '';
    document.getElementById('loader').style.display = 'flex';
  },

  hideLoader() {
    document.getElementById('loader').style.display = 'none';
  },

  transitionToApp() {
    const hero = document.getElementById('heroView');
    hero.classList.add('slide-up');
    document.getElementById('appView').style.display = 'block';
    document.getElementById('miniSearch').value = App.currentQuery;
    document.getElementById('dashboardContainer').classList.add('active');
    
    setTimeout(() => {
      hero.style.display = 'none';
      hero.classList.add('hidden');
    }, 500);
  },

  updateURL(query, mode) {
    const url = new URL(window.location);
    url.searchParams.set('q', query);
    url.searchParams.set('mode', mode);
    window.history.replaceState({}, '', url);
  },

  exportCSV() {
    const data = App.mode === 'search' ? App.searchData.active : (App.forecastData.awards || []);
    if (!data.length) return alert("No data to export");
    
    const headers = ['Recipient', 'Agency', 'Amount', 'Description', 'Start Date', 'End Date', 'Award ID'];
    const rows = data.map(c => [
      `"${(c['Recipient Name'] || '').replace(/"/g, '""')}"`,
      `"${(c['Awarding Agency'] || '').replace(/"/g, '""')}"`,
      c['Award Amount'] || 0,
      `"${(c['Description'] || '').replace(/"/g, '""')}"`,
      c['Start Date'] || '',
      c['End Date'] || '',
      c['Award ID'] || ''
    ]);
    
    const csvContent = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.setAttribute("href", url);
    link.setAttribute("download", `govhoo_${App.mode}_${App.currentQuery}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }
};

// Initialize
App.init();
</script>
</body>
</html>